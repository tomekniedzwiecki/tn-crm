<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TN CRM - Lead</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#050505">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3/dist/purify.min.js"></script>
    <script src="components/shared-sidebar.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    }
                }
            }
        }
    </script>
    <style>
        body { background: #050505; color: #e5e5e5; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::selection { background: white; color: black; }

        /* Mobile sidebar hide */
        @media (max-width: 768px) {
            aside { display: none !important; }
            .mobile-back-btn { display: flex !important; }
        }
        @media (min-width: 769px) {
            .mobile-back-btn { display: none !important; }
        }

        .glass-header {
            background: rgba(5, 5, 5, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-enter { animation: fadeIn 0.4s ease-out forwards; }

        /* Nav icon animations */
        nav a i {
            display: inline-block;
        }

        @keyframes houseBounce {
            0% { transform: translateY(0); }
            30% { transform: translateY(-4px); }
            50% { transform: translateY(0); }
            70% { transform: translateY(-2px); }
            100% { transform: translateY(0); }
        }
        nav a:hover .ph-house {
            animation: houseBounce 0.5s ease-out;
        }

        /* Users - friendly wave/huddle effect */
        @keyframes usersHuddle {
            0% { transform: scale(1) rotate(0deg); }
            20% { transform: scale(1.1) rotate(-5deg); }
            40% { transform: scale(1.15) rotate(3deg); }
            60% { transform: scale(1.1) rotate(-2deg); }
            80% { transform: scale(1.05) rotate(1deg); }
            100% { transform: scale(1) rotate(0deg); }
        }
        nav a:hover .ph-users {
            animation: usersHuddle 0.6s ease-out;
        }

        /* Kanban - cards sliding on board */
        @keyframes kanbanSlide {
            0% { transform: translateX(0); }
            20% { transform: translateX(-3px); }
            40% { transform: translateX(4px); }
            60% { transform: translateX(-2px); }
            80% { transform: translateX(2px); }
            100% { transform: translateX(0); }
        }
        nav a:hover .ph-kanban {
            animation: kanbanSlide 0.6s ease-in-out;
        }

        @keyframes calendarFlip {
            0% { transform: rotateY(0deg); }
            50% { transform: rotateY(-20deg); }
            100% { transform: rotateY(0deg); }
        }
        nav a:hover .ph-calendar {
            animation: calendarFlip 0.5s ease-in-out;
        }

        @keyframes packageBounce {
            0% { transform: translateY(0) scale(1); }
            30% { transform: translateY(-5px) scale(1.1); }
            50% { transform: translateY(-2px) scale(1.05); }
            70% { transform: translateY(-3px) scale(1.08); }
            100% { transform: translateY(0) scale(1); }
        }
        nav a:hover .ph-package {
            animation: packageBounce 0.5s ease-out;
        }

        @keyframes gearSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(180deg); }
        }
        nav a:hover .ph-gear {
            animation: gearSpin 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes shieldPulse {
            0% { transform: scale(1); }
            30% { transform: scale(1.15); }
            60% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        nav a:hover .ph-shield-check {
            animation: shieldPulse 0.5s ease-out;
        }

        .input-field {
            background: #0a0a0a;
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.2s;
        }
        .input-field:focus {
            border-color: rgba(255,255,255,0.25);
            outline: none;
        }
        .input-field:hover:not(:focus) {
            border-color: rgba(255,255,255,0.15);
        }

        .timeline-line {
            position: absolute;
            left: 11px;
            top: 28px;
            bottom: 0;
            width: 1px;
            background: linear-gradient(to bottom, rgba(255,255,255,0.1), transparent);
        }

        /* Pipeline Mini Styles */
        .pipeline-mini {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        .stage-pill {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 8px;
            border: 1px solid transparent;
            background: rgba(39, 39, 42, 0.5);
            cursor: pointer;
            transition: all 0.2s ease;
            opacity: 0.5;
        }
        .stage-pill:hover {
            opacity: 0.85;
            background: rgba(39, 39, 42, 0.8);
            transform: translateY(-1px);
        }
        .stage-pill:hover .stage-icon {
            transform: scale(1.05);
        }
        .stage-pill .stage-icon {
            width: 20px;
            height: 20px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            transition: transform 0.2s ease;
        }
        .stage-pill .stage-name {
            font-size: 12px;
            font-weight: 500;
            color: #a1a1aa;
        }
        .stage-pill .stage-check {
            display: none;
            font-size: 10px;
        }

        /* Completed stages */
        .stage-pill.completed {
            opacity: 0.6;
        }
        .stage-pill.completed .stage-check {
            display: block;
            color: #22c55e;
        }

        /* Current stage - highlighted */
        .stage-pill.current {
            opacity: 1;
            border-color: currentColor;
            box-shadow: 0 0 15px var(--glow-color, rgba(255,255,255,0.2));
            background: rgba(255, 255, 255, 0.05);
        }
        .stage-pill.current .stage-name {
            color: white;
            font-weight: 600;
        }
        .stage-pill.current .stage-icon {
            transform: scale(1.1);
        }

        /* Terminal states */
        .stage-pill.terminal-won {
            opacity: 1;
            background: rgba(34, 197, 94, 0.15);
            border-color: rgba(34, 197, 94, 0.5);
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.25);
        }
        .stage-pill.terminal-won .stage-icon {
            background: rgba(34, 197, 94, 0.3);
            color: #4ade80;
            transform: scale(1.1);
        }
        .stage-pill.terminal-won .stage-name {
            color: #4ade80;
            font-weight: 600;
        }

        .stage-pill.terminal-lost {
            opacity: 1;
            background: rgba(239, 68, 68, 0.15);
            border-color: rgba(239, 68, 68, 0.5);
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.25);
        }
        .stage-pill.terminal-lost .stage-icon {
            background: rgba(239, 68, 68, 0.3);
            color: #f87171;
            transform: scale(1.1);
        }
        .stage-pill.terminal-lost .stage-name {
            color: #f87171;
            font-weight: 600;
        }

        .stage-pill.terminal-abandoned {
            opacity: 1;
            background: rgba(113, 113, 122, 0.15);
            border-color: rgba(113, 113, 122, 0.5);
            box-shadow: 0 0 20px rgba(113, 113, 122, 0.25);
        }
        .stage-pill.terminal-abandoned .stage-icon {
            background: rgba(113, 113, 122, 0.3);
            color: #a1a1aa;
            transform: scale(1.1);
        }
        .stage-pill.terminal-abandoned .stage-name {
            color: #a1a1aa;
            font-weight: 600;
        }

        /* When in terminal state, fade regular stages more */
        #pipeline-stepper.terminal-state .stage-pill:not(.terminal-won):not(.terminal-lost):not(.terminal-abandoned) {
            opacity: 0.3;
        }
        #pipeline-stepper.terminal-state .stage-pill:not(.terminal-won):not(.terminal-lost):not(.terminal-abandoned):hover {
            opacity: 0.6;
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            gap: 4px;
            background: rgba(39, 39, 42, 0.3);
            padding: 4px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .tab-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            color: #71717a;
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .tab-btn:hover {
            color: #a1a1aa;
            background: rgba(255, 255, 255, 0.03);
        }
        .tab-btn.active {
            color: white;
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        .tab-btn i {
            font-size: 16px;
        }
        .tab-btn .tab-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            font-family: 'JetBrains Mono', monospace;
        }
        .tab-btn.active .tab-badge {
            background: rgba(255, 255, 255, 0.15);
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        /* Email filter buttons */
        .email-filter-btn {
            border-color: rgba(255,255,255,0.1);
            color: #71717a;
        }
        .email-filter-btn:hover {
            border-color: rgba(255,255,255,0.2);
            color: #a1a1aa;
        }
        .email-filter-btn.active {
            border-color: rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.05);
            color: white;
        }

        /* Shake animation */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-3px); }
            40%, 80% { transform: translateX(3px); }
        }
        .shake { animation: shake 0.4s ease-in-out; }

        /* Offer type selection */
        .offer-type-option {
            display: block;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
            background: rgba(0,0,0,0.3);
            cursor: pointer;
            transition: all 0.15s;
        }
        .offer-type-option:hover {
            border-color: rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.03);
        }
        .offer-type-option.selected {
            border-color: rgba(16, 185, 129, 0.5);
            background: rgba(16, 185, 129, 0.1);
        }
    </style>
</head>
<body class="h-screen flex overflow-hidden font-sans text-sm tracking-tight antialiased">

    <!-- Sidebar -->
    <aside id="sidebar" class="w-[280px] bg-zinc-950 border-r border-white/5 flex flex-col flex-shrink-0"></aside>

    <!-- Main -->
    <main class="flex-1 flex flex-col bg-black relative min-w-0">
        <!-- Header -->
        <header class="h-16 glass-header flex items-center justify-between px-4 md:px-6 sticky top-0 z-30">
            <div class="flex items-center gap-3">
                <a href="/leads" data-page="leads" class="mobile-back-btn hidden items-center justify-center w-9 h-9 rounded-lg hover:bg-white/5 text-zinc-400 hover:text-white transition-colors">
                    <i class="ph ph-arrow-left text-xl"></i>
                </a>
                <div class="flex items-center gap-2 text-zinc-500">
                    <a href="/leads" data-page="leads" class="text-zinc-400 hover:text-white transition-colors hidden sm:inline">leads</a>
                    <span class="text-zinc-700 hidden sm:inline">/</span>
                    <span id="breadcrumb-email" class="text-white font-medium truncate max-w-[150px] md:max-w-[200px]">...</span>
                </div>
                <!-- Lead Navigation -->
                <div class="flex items-center gap-2 ml-2 border-l border-white/10 pl-3">
                    <button id="prev-lead-btn" disabled class="flex items-center justify-center w-8 h-8 rounded-lg hover:bg-white/5 text-zinc-500 hover:text-white transition-all disabled:opacity-30 disabled:cursor-not-allowed disabled:hover:bg-transparent disabled:hover:text-zinc-500" title="Poprzedni lead w tym statusie">
                        <i class="ph ph-caret-left text-lg"></i>
                    </button>
                    <div id="nav-status-badge" class="hidden flex items-center gap-1.5">
                        <i id="nav-status-icon" class="ph ph-circle text-xs"></i>
                        <span id="nav-status-label" class="text-[11px] font-medium">Status</span>
                        <span class="text-zinc-600 text-[10px] font-mono"><span id="nav-status-position">0</span>/<span id="nav-status-total">0</span></span>
                    </div>
                    <button id="next-lead-btn" disabled class="flex items-center justify-center w-8 h-8 rounded-lg hover:bg-white/5 text-zinc-500 hover:text-white transition-all disabled:opacity-30 disabled:cursor-not-allowed disabled:hover:bg-transparent disabled:hover:text-zinc-500" title="Następny lead w tym statusie">
                        <i class="ph ph-caret-right text-lg"></i>
                    </button>
                </div>
            </div>
            <div class="flex items-center gap-2 md:gap-3">
                <div id="save-status" class="hidden md:flex items-center gap-2 text-xs text-zinc-500 mr-2">
                    <span id="save-status-text"></span>
                </div>
                <button id="delete-btn" class="text-red-400 hover:text-red-300 border border-red-500/20 hover:border-red-500/40 px-3 md:px-4 py-2 rounded-lg text-xs font-medium transition-all flex items-center gap-2">
                    <i class="ph ph-trash"></i>
                    <span class="hidden md:inline">Usuń</span>
                </button>
            </div>
        </header>

        <!-- Content -->
        <div class="flex-1 overflow-y-auto">
            <div class="max-w-6xl mx-auto p-6 lg:p-10 animate-enter">

                <!-- Lead Header -->
                <div class="flex items-start gap-6 mb-8">
                    <div id="lead-avatar" class="w-16 h-16 rounded-xl bg-gradient-to-br from-violet-500 to-purple-600 flex items-center justify-center text-white text-2xl font-bold flex-shrink-0">
                        ?
                    </div>
                    <div class="flex-1 min-w-0">
                        <h1 id="lead-email-display" class="text-3xl font-semibold text-white tracking-tight mb-1 truncate">Ładowanie...</h1>
                        <div class="flex items-center gap-3 text-zinc-500 text-sm flex-wrap">
                            <span id="lead-source-badge" class="inline-flex items-center px-2 py-0.5 rounded border text-[10px] font-medium">-</span>
                            <span class="text-zinc-700">•</span>
                            <span class="font-mono text-xs">Dodany: <span id="lead-created">-</span></span>
                            <span id="lead-survey-wrapper" class="hidden">
                                <span class="text-zinc-700">•</span>
                                <span class="font-mono text-xs">Ankieta: <span id="lead-survey-date">-</span></span>
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Pipeline Mini -->
                <div id="pipeline-stepper" class="mb-6">
                    <div id="pipeline-stages-container" class="pipeline-mini">
                        <!-- Stages will be rendered dynamically -->
                    </div>
                </div>

                <!-- Tab Navigation -->
                <div class="tab-nav mb-6">
                    <button class="tab-btn active" data-tab="info" onclick="switchTab('info')">
                        <i class="ph ph-user-circle"></i>
                        Informacje podstawowe
                    </button>
                    <button class="tab-btn" data-tab="activity" onclick="switchTab('activity')">
                        <i class="ph ph-note-pencil"></i>
                        Notatki
                        <span class="tab-badge" id="activity-tab-count">0</span>
                    </button>
                    <button class="tab-btn" data-tab="email" onclick="switchTab('email')">
                        <i class="ph ph-envelope"></i>
                        E-mail
                        <span class="tab-badge" id="email-tab-count">0</span>
                    </button>
                </div>

                <!-- Tab: Informacje podstawowe -->
                <div id="tab-info" class="tab-content active">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

                    <!-- Left Column - Details -->
                    <div class="lg:col-span-2 space-y-6">

                        <!-- Survey Responses - Collapsible -->
                        <details id="survey-section" class="group hidden">
                            <summary class="bg-gradient-to-br from-cyan-950/30 to-zinc-900/40 rounded-lg border border-cyan-500/20 p-4 cursor-pointer list-none flex items-center justify-between hover:bg-cyan-950/40 transition-colors">
                                <span class="text-sm text-white flex items-center gap-2">
                                    <i class="ph ph-clipboard-text text-cyan-400"></i>
                                    Odpowiedzi z ankiety
                                    <span class="text-[10px] font-mono text-cyan-400 bg-cyan-500/10 px-2 py-0.5 rounded border border-cyan-500/20">zapisy</span>
                                </span>
                                <i class="ph ph-caret-down text-cyan-500 group-open:rotate-180 transition-transform"></i>
                            </summary>
                            <div class="bg-cyan-950/20 rounded-b-lg border border-t-0 border-cyan-500/20 p-4 -mt-1">
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="p-3 bg-zinc-900/60 rounded-lg border border-white/5">
                                        <div class="text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1">Czas tygodniowo</div>
                                        <div id="survey-hours" class="text-white text-sm font-medium">-</div>
                                    </div>
                                    <div class="p-3 bg-zinc-900/60 rounded-lg border border-white/5">
                                        <div class="text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1">Cel dochodu (mies.)</div>
                                        <div id="survey-income" class="text-white text-sm font-medium">-</div>
                                    </div>
                                    <div class="col-span-2 p-3 bg-zinc-900/60 rounded-lg border border-white/5">
                                        <div class="text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1">Doświadczenie</div>
                                        <div id="survey-experience" class="text-white text-sm leading-relaxed">-</div>
                                    </div>
                                    <div id="survey-open-container" class="col-span-2 p-3 bg-zinc-900/60 rounded-lg border border-white/5 hidden">
                                        <div class="text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1">Dodatkowe informacje</div>
                                        <div id="survey-open" class="text-white text-sm leading-relaxed">-</div>
                                    </div>
                                </div>
                            </div>
                        </details>

                        <!-- Contact Info -->
                        <div class="bg-zinc-900/40 rounded-lg border border-white/5 p-5">
                            <h3 class="text-sm font-medium text-white mb-4 flex items-center gap-2">
                                <i class="ph ph-user text-zinc-500"></i>
                                Dane kontaktowe
                            </h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Email</label>
                                    <div class="flex gap-2">
                                        <input type="email" id="field-email" readonly class="input-field flex-1 rounded-lg px-3 py-2.5 text-sm text-zinc-400 cursor-not-allowed">
                                        <button id="btn-mailto" class="px-3 py-2 bg-purple-500/20 hover:bg-purple-500/30 border border-purple-500/30 rounded-lg text-purple-400 transition-colors" title="Wyślij email">
                                            <i class="ph ph-envelope-simple text-lg"></i>
                                        </button>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Telefon</label>
                                    <div class="flex gap-2">
                                        <input type="tel" id="field-phone" placeholder="+48 ..." class="input-field flex-1 rounded-lg px-3 py-2.5 text-sm text-white">
                                        <button id="btn-call" class="px-3 py-2 bg-emerald-500/20 hover:bg-emerald-500/30 border border-emerald-500/30 rounded-lg text-emerald-400 transition-colors disabled:opacity-30 disabled:cursor-not-allowed" title="Zadzwoń" disabled>
                                            <i class="ph ph-phone text-lg"></i>
                                        </button>
                                        <button id="btn-whatsapp" class="px-3 py-2 bg-green-500/20 hover:bg-green-500/30 border border-green-500/30 rounded-lg text-green-400 transition-colors disabled:opacity-30 disabled:cursor-not-allowed" title="WhatsApp" disabled>
                                            <i class="ph ph-whatsapp-logo text-lg"></i>
                                        </button>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Imię i nazwisko</label>
                                    <input type="text" id="field-name" placeholder="Jan Kowalski" class="input-field w-full rounded-lg px-3 py-2.5 text-sm text-white">
                                </div>
                                <div>
                                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Firma</label>
                                    <input type="text" id="field-company" placeholder="Nazwa firmy" class="input-field w-full rounded-lg px-3 py-2.5 text-sm text-white">
                                </div>
                                <div>
                                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">NIP</label>
                                    <div class="flex gap-2">
                                        <input type="text" id="field-nip" placeholder="0000000000" class="input-field flex-1 rounded-lg px-3 py-2.5 text-sm text-white">
                                        <button id="btn-fetch-nip" class="px-3 py-2 bg-blue-500/20 hover:bg-blue-500/30 border border-blue-500/30 rounded-lg text-blue-400 transition-colors disabled:opacity-30 disabled:cursor-not-allowed" title="Pobierz dane firmy">
                                            <i class="ph ph-cloud-arrow-down text-lg"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-span-2">
                                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Adres</label>
                                    <input type="text" id="field-address" placeholder="ul. Przykładowa 1, 00-000 Warszawa" class="input-field w-full rounded-lg px-3 py-2.5 text-sm text-white">
                                </div>
                            </div>
                        </div>

                        <!-- Deal Info -->
                        <div class="bg-zinc-900/40 rounded-lg border border-white/5 p-5">
                            <h3 class="text-sm font-medium text-white mb-4 flex items-center gap-2">
                                <i class="ph ph-currency-circle-dollar text-zinc-500"></i>
                                Informacje o dealu
                            </h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="col-span-2">
                                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Oferta</label>
                                    <select id="field-offer" class="input-field w-full rounded-lg px-3 py-2.5 text-sm text-white cursor-pointer">
                                        <option value="">— Wybierz ofertę —</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Wartość (PLN)</label>
                                    <input type="number" id="field-value" placeholder="0" class="input-field w-full rounded-lg px-3 py-2.5 text-sm text-white">
                                </div>
                                <div>
                                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Przewidywane zamknięcie</label>
                                    <input type="date" id="field-expected-close" class="input-field w-full rounded-lg px-3 py-2.5 text-sm text-white">
                                </div>
                                <div class="col-span-2">
                                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Przypisano do</label>
                                    <select id="field-assigned-to" class="input-field w-full rounded-lg px-3 py-2.5 text-sm text-white cursor-pointer">
                                        <option value="">Nie przypisano</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Email History -->
                        <div class="bg-zinc-900/40 rounded-lg border border-white/5 p-5">
                            <h3 class="text-sm font-medium text-white mb-4 flex items-center gap-2">
                                <i class="ph ph-envelope text-zinc-500"></i>
                                Historia emaili
                                <span id="email-count" class="ml-auto text-[10px] font-mono text-zinc-600 bg-zinc-800 px-2 py-0.5 rounded">0</span>
                            </h3>
                            <div id="email-history" class="space-y-2 max-h-[400px] overflow-y-auto">
                                <div class="text-center text-zinc-600 text-xs py-4">
                                    <i class="ph ph-circle-notch animate-spin"></i> Ładowanie...
                                </div>
                            </div>
                        </div>

                        <!-- Tracking Info - Collapsible -->
                        <details class="group">
                            <summary class="bg-zinc-900/40 rounded-lg border border-white/5 p-4 cursor-pointer list-none flex items-center justify-between hover:bg-zinc-900/60 transition-colors">
                                <span class="text-sm text-zinc-500 flex items-center gap-2">
                                    <i class="ph ph-chart-line-up"></i>
                                    Dane trackingowe
                                </span>
                                <i class="ph ph-caret-down text-zinc-600 group-open:rotate-180 transition-transform"></i>
                            </summary>
                            <div class="bg-zinc-950/50 rounded-b-lg border border-t-0 border-white/5 p-4 -mt-1">
                                <div class="grid grid-cols-2 gap-3 text-xs">
                                    <div class="p-2 bg-zinc-900/50 rounded border border-white/5">
                                        <div class="text-zinc-600 font-mono text-[9px] uppercase mb-0.5">Source</div>
                                        <div id="tracking-source" class="text-zinc-400 font-mono text-[11px]">-</div>
                                    </div>
                                    <div class="p-2 bg-zinc-900/50 rounded border border-white/5">
                                        <div class="text-zinc-600 font-mono text-[9px] uppercase mb-0.5">Medium</div>
                                        <div id="tracking-medium" class="text-zinc-400 font-mono text-[11px]">-</div>
                                    </div>
                                    <div class="p-2 bg-zinc-900/50 rounded border border-white/5">
                                        <div class="text-zinc-600 font-mono text-[9px] uppercase mb-0.5">Campaign</div>
                                        <div id="tracking-campaign" class="text-zinc-400 font-mono text-[11px]">-</div>
                                    </div>
                                    <div class="p-2 bg-zinc-900/50 rounded border border-white/5">
                                        <div class="text-zinc-600 font-mono text-[9px] uppercase mb-0.5">Click ID</div>
                                        <div id="tracking-clickid" class="text-zinc-400 font-mono text-[11px] truncate">-</div>
                                    </div>
                                    <div class="col-span-2 p-2 bg-zinc-900/50 rounded border border-white/5">
                                        <div class="text-zinc-600 font-mono text-[9px] uppercase mb-0.5">Landing Page</div>
                                        <div id="tracking-landing" class="text-zinc-500 font-mono text-[10px] truncate">-</div>
                                    </div>
                                    <div class="col-span-2 p-2 bg-zinc-900/50 rounded border border-white/5">
                                        <div class="text-zinc-600 font-mono text-[9px] uppercase mb-0.5">User Agent</div>
                                        <div id="tracking-useragent" class="text-zinc-600 font-mono text-[9px] truncate">-</div>
                                    </div>
                                </div>
                            </div>
                        </details>

                        <!-- Purchase History -->
                        <details id="purchase-history-section" class="group hidden">
                            <summary class="bg-gradient-to-br from-green-950/30 to-zinc-900/40 rounded-lg border border-green-500/20 p-4 cursor-pointer list-none flex items-center justify-between hover:bg-green-950/40 transition-colors">
                                <span class="text-sm text-white flex items-center gap-2">
                                    <i class="ph ph-shopping-cart text-green-400"></i>
                                    Historia zakupów
                                    <span id="purchase-total-badge" class="text-[10px] font-mono text-green-400 bg-green-500/10 px-2 py-0.5 rounded border border-green-500/20">0 PLN</span>
                                </span>
                                <i class="ph ph-caret-down text-green-500 group-open:rotate-180 transition-transform"></i>
                            </summary>
                            <div class="bg-green-950/20 rounded-b-lg border border-t-0 border-green-500/20 p-4 -mt-1">

                                <!-- Historical LTV (outreach_contacts) -->
                                <div id="historical-ltv-section" class="mb-4 hidden">
                                    <div class="text-zinc-400 text-[10px] font-mono uppercase tracking-wider mb-2 flex items-center gap-2">
                                        <i class="ph ph-database text-green-500"></i>
                                        Historyczne zakupy (baza klientów)
                                    </div>
                                    <div class="grid grid-cols-2 gap-3">
                                        <div class="p-3 bg-zinc-900/60 rounded-lg border border-white/5">
                                            <div class="text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1">LTV</div>
                                            <div id="ltv-value" class="text-green-400 text-lg font-bold">0 PLN</div>
                                        </div>
                                        <div class="p-3 bg-zinc-900/60 rounded-lg border border-white/5">
                                            <div class="text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1">Transakcje</div>
                                            <div id="ltv-transactions" class="text-white text-lg font-bold">0</div>
                                        </div>
                                        <div class="p-3 bg-zinc-900/60 rounded-lg border border-white/5">
                                            <div class="text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1">Pierwszy zakup</div>
                                            <div id="ltv-first" class="text-zinc-300 text-sm">-</div>
                                        </div>
                                        <div class="p-3 bg-zinc-900/60 rounded-lg border border-white/5">
                                            <div class="text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1">Ostatni zakup</div>
                                            <div id="ltv-last" class="text-zinc-300 text-sm">-</div>
                                        </div>
                                        <div class="col-span-2 p-3 bg-zinc-900/60 rounded-lg border border-white/5">
                                            <div class="text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1">Produkty</div>
                                            <div id="ltv-products" class="text-zinc-300 text-sm">-</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- CRM Orders -->
                                <div id="crm-orders-section">
                                    <div class="text-zinc-400 text-[10px] font-mono uppercase tracking-wider mb-2 flex items-center gap-2">
                                        <i class="ph ph-receipt text-green-500"></i>
                                        Zamówienia w systemie
                                        <span id="crm-orders-count" class="text-green-400 bg-green-500/10 px-1.5 py-0.5 rounded text-[9px]">0</span>
                                    </div>
                                    <div id="crm-orders-list" class="space-y-2">
                                        <div class="text-center text-zinc-600 text-xs py-4">Brak zamówień</div>
                                    </div>
                                </div>

                            </div>
                        </details>
                    </div>

                    <!-- Right Column - Meetings & Offers -->
                    <div class="space-y-6">

                        <!-- Quick Note -->
                        <div class="bg-zinc-900/40 rounded-lg border border-white/5 p-4">
                            <h3 class="text-sm font-medium text-white mb-3 flex items-center gap-2">
                                <i class="ph ph-note-pencil text-emerald-400"></i>
                                Szybka notatka
                            </h3>
                            <textarea id="quick-note-input" rows="2" placeholder="Napisz notatkę..." class="input-field w-full rounded-lg px-3 py-2 text-sm text-white resize-none mb-2"></textarea>
                            <button id="quick-note-save-btn" class="w-full bg-emerald-500/20 hover:bg-emerald-500/30 text-emerald-400 px-3 py-2 rounded-lg text-sm font-medium transition-colors flex items-center justify-center gap-2 border border-emerald-500/30">
                                <i class="ph ph-plus"></i>
                                Dodaj
                            </button>
                        </div>

                        <!-- Scheduled Meetings -->
                        <div class="bg-zinc-900/40 rounded-lg border border-white/5 p-5">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-sm font-medium text-white flex items-center gap-2">
                                    <i class="ph ph-calendar text-pink-400"></i>
                                    Spotkania
                                    <span id="meetings-count" class="text-[10px] bg-zinc-800 text-zinc-400 px-1.5 py-0.5 rounded font-mono">0</span>
                                </h3>
                                <button id="add-meeting-btn" class="text-zinc-400 hover:text-white text-xs flex items-center gap-1 transition-colors">
                                    <i class="ph ph-plus"></i>
                                    Dodaj
                                </button>
                            </div>
                            <div id="meetings-list" class="space-y-2">
                                <!-- Meetings will be rendered here -->
                            </div>
                            <div id="meetings-empty" class="hidden text-center py-6">
                                <i class="ph ph-calendar-blank text-2xl text-zinc-700 mb-2"></i>
                                <p class="text-zinc-500 text-xs">Brak zaplanowanych spotkań</p>
                            </div>
                        </div>

                        <!-- Client Offer Link -->
                        <div id="client-offer-section" class="bg-zinc-900/40 rounded-lg border border-white/5 p-5 hidden">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-sm font-medium text-white flex items-center gap-2">
                                    <i class="ph ph-link text-amber-400"></i>
                                    Link do oferty
                                </h3>
                            </div>

                            <!-- No offer - generate form -->
                            <div id="client-offer-empty" class="hidden">
                                <p class="text-zinc-500 text-xs mb-4">Wygeneruj link do oferty dla klienta. Dostęp będzie chroniony adresem e-mail.</p>

                                <!-- Offer type selection -->
                                <div class="mb-4">
                                    <label class="block text-zinc-600 text-[10px] font-mono uppercase tracking-wider mb-2">Typ oferty</label>
                                    <div class="grid grid-cols-2 gap-2">
                                        <label class="offer-type-option selected" data-type="starter">
                                            <input type="radio" name="offer-type" value="starter" checked class="sr-only">
                                            <div class="flex items-center gap-2">
                                                <i class="ph ph-rocket text-lg text-emerald-400"></i>
                                                <div>
                                                    <div class="text-sm font-medium text-white">Startowy</div>
                                                    <div class="text-[10px] text-zinc-500">Bez umowy</div>
                                                </div>
                                            </div>
                                        </label>
                                        <label class="offer-type-option" data-type="full">
                                            <input type="radio" name="offer-type" value="full" class="sr-only">
                                            <div class="flex items-center gap-2">
                                                <i class="ph ph-package text-lg text-amber-400"></i>
                                                <div>
                                                    <div class="text-sm font-medium text-white">Pełen pakiet</div>
                                                    <div class="text-[10px] text-zinc-500">Z umową</div>
                                                </div>
                                            </div>
                                        </label>
                                    </div>
                                </div>

                                <div class="flex items-center gap-3 mb-4">
                                    <div class="flex-1">
                                        <label class="block text-zinc-600 text-[10px] font-mono uppercase tracking-wider mb-1.5">Ważność oferty</label>
                                        <input type="date" id="client-offer-valid-until" class="input-field w-full rounded-lg px-3 py-2 text-sm text-white cursor-pointer" onclick="this.showPicker()">
                                    </div>
                                </div>
                                <div class="mb-4">
                                    <label class="block text-zinc-600 text-[10px] font-mono uppercase tracking-wider mb-1.5">Cena indywidualna (opcjonalne)</label>
                                    <div class="relative">
                                        <input type="number" id="client-offer-custom-price" class="input-field w-full rounded-lg px-3 py-2 text-sm text-white pr-12" placeholder="Domyślna cena z oferty" min="0" step="1">
                                        <span class="absolute right-3 top-1/2 -translate-y-1/2 text-zinc-500 text-xs">PLN</span>
                                    </div>
                                </div>
                                <button id="generate-client-offer-btn" class="w-full bg-amber-500/20 hover:bg-amber-500/30 text-amber-400 px-4 py-2.5 rounded-lg text-sm font-medium transition-colors flex items-center justify-center gap-2 border border-amber-500/30">
                                    <i class="ph ph-magic-wand"></i>
                                    Wygeneruj link
                                </button>
                            </div>

                            <!-- Offer exists -->
                            <div id="client-offer-exists" class="hidden">
                                <!-- URL with copy and open -->
                                <div class="flex items-center gap-2 mb-4">
                                    <input type="text" id="client-offer-url" readonly class="flex-1 bg-zinc-900/80 border border-zinc-700 rounded-lg px-3 py-2 text-xs text-zinc-300 font-mono truncate">
                                    <button onclick="copyOfferUrl()" class="p-2 bg-zinc-800 hover:bg-zinc-700 rounded-lg transition-colors border border-white/10" title="Kopiuj link">
                                        <i class="ph ph-copy text-zinc-400"></i>
                                    </button>
                                    <button onclick="openOfferPreview()" class="p-2 bg-amber-500/20 hover:bg-amber-500/30 rounded-lg transition-colors border border-amber-500/30" title="Otwórz ofertę">
                                        <i class="ph ph-arrow-square-out text-amber-400"></i>
                                    </button>
                                </div>

                                <!-- Stats -->
                                <div class="flex items-center gap-4 mb-4 text-xs">
                                    <div class="flex items-center gap-2 text-zinc-400">
                                        <i class="ph ph-calendar text-amber-400"></i>
                                        <span>Ważna do:</span>
                                        <span id="client-offer-valid-display" class="text-white font-medium">-</span>
                                    </div>
                                    <div class="relative">
                                        <button onclick="toggleViewHistory()" class="flex items-center gap-2 text-zinc-400 hover:text-white transition-colors group">
                                            <i class="ph ph-eye text-cyan-400"></i>
                                            <span>Wyświetlenia:</span>
                                            <span id="client-offer-views" class="text-white font-medium group-hover:text-cyan-400">0</span>
                                            <i class="ph ph-caret-down text-[10px] text-zinc-500 group-hover:text-white"></i>
                                        </button>
                                        <!-- View History Dropdown -->
                                        <div id="view-history-dropdown" class="hidden absolute top-full left-0 mt-2 w-56 bg-zinc-900 border border-white/10 rounded-lg shadow-xl z-20 overflow-hidden">
                                            <div class="px-3 py-2 border-b border-white/5 bg-zinc-950/50">
                                                <span class="text-[10px] font-mono text-zinc-500 uppercase tracking-wider">Historia wyświetleń</span>
                                            </div>
                                            <div id="view-history-list" class="max-h-48 overflow-y-auto">
                                                <!-- History items rendered here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Actions -->
                                <div class="flex gap-2">
                                    <button onclick="openOfferPreview()" class="flex-1 bg-zinc-800 hover:bg-zinc-700 text-white px-3 py-2 rounded-lg text-xs font-medium transition-colors flex items-center justify-center gap-2 border border-white/10">
                                        <i class="ph ph-arrow-square-out"></i>
                                        Podgląd
                                    </button>
                                    <button onclick="downloadProformaFromCRM()" class="flex-1 bg-blue-500/20 hover:bg-blue-500/30 text-blue-400 px-3 py-2 rounded-lg text-xs font-medium transition-colors flex items-center justify-center gap-2 border border-blue-500/30">
                                        <i class="ph ph-file-pdf"></i>
                                        Proforma
                                    </button>
                                    <button onclick="deleteClientOffer()" class="px-3 py-2 bg-red-500/10 hover:bg-red-500/20 text-red-400 rounded-lg text-xs font-medium transition-colors border border-red-500/20 flex items-center justify-center gap-2">
                                        <i class="ph ph-trash"></i>
                                        Usuń
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Custom Payment Link (jednorazowa płatność bez workflow) -->
                        <div class="bg-zinc-900/40 rounded-lg border border-white/5 p-5">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-sm font-medium text-white flex items-center gap-2">
                                    <i class="ph ph-credit-card text-emerald-400"></i>
                                    Link do płatności
                                    <span class="text-[9px] font-mono text-zinc-500 bg-zinc-800 px-1.5 py-0.5 rounded">bez workflow</span>
                                </h3>
                            </div>

                            <!-- Generate payment link form -->
                            <div id="custom-payment-form">
                                <p class="text-zinc-500 text-xs mb-4">Wygeneruj jednorazowy link do płatności. Projekt TN Workflow <strong>nie zostanie</strong> utworzony.</p>

                                <div class="space-y-3 mb-4">
                                    <div>
                                        <label class="block text-zinc-600 text-[10px] font-mono uppercase tracking-wider mb-1.5">Kwota (PLN) <span class="text-red-400">*</span></label>
                                        <input type="number" id="custom-payment-amount" min="1" step="0.01" placeholder="np. 1500" class="input-field w-full rounded-lg px-3 py-2 text-sm text-white">
                                    </div>
                                    <div>
                                        <label class="block text-zinc-600 text-[10px] font-mono uppercase tracking-wider mb-1.5">Opis płatności <span class="text-red-400">*</span></label>
                                        <input type="text" id="custom-payment-description" placeholder="np. Konsultacja AI, Audyt" class="input-field w-full rounded-lg px-3 py-2 text-sm text-white">
                                    </div>
                                </div>

                                <button id="generate-custom-payment-btn" class="w-full bg-emerald-500/20 hover:bg-emerald-500/30 text-emerald-400 px-4 py-2.5 rounded-lg text-sm font-medium transition-colors flex items-center justify-center gap-2 border border-emerald-500/30">
                                    <i class="ph ph-link"></i>
                                    Generuj link do płatności
                                </button>
                            </div>

                            <!-- Generated link display -->
                            <div id="custom-payment-result" class="hidden">
                                <div class="flex items-center gap-2 mb-3">
                                    <input type="text" id="custom-payment-url" readonly class="flex-1 bg-zinc-900/80 border border-zinc-700 rounded-lg px-3 py-2 text-xs text-zinc-300 font-mono truncate">
                                    <button onclick="copyCustomPaymentUrl()" class="p-2 bg-zinc-800 hover:bg-zinc-700 rounded-lg transition-colors border border-white/10" title="Kopiuj link">
                                        <i class="ph ph-copy text-zinc-400"></i>
                                    </button>
                                    <button onclick="openCustomPaymentUrl()" class="p-2 bg-emerald-500/20 hover:bg-emerald-500/30 rounded-lg transition-colors border border-emerald-500/30" title="Otwórz checkout">
                                        <i class="ph ph-arrow-square-out text-emerald-400"></i>
                                    </button>
                                </div>
                                <div class="flex items-center gap-3 text-xs text-zinc-400 mb-3">
                                    <span><i class="ph ph-money text-emerald-400 mr-1"></i><span id="custom-payment-amount-display">0 PLN</span></span>
                                    <span class="text-zinc-700">•</span>
                                    <span class="truncate" id="custom-payment-description-display">-</span>
                                </div>
                                <button onclick="resetCustomPaymentForm()" class="w-full text-zinc-500 hover:text-white text-xs transition-colors flex items-center justify-center gap-1">
                                    <i class="ph ph-arrow-counter-clockwise"></i>
                                    Generuj nowy link
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                </div><!-- /tab-info -->

                <!-- Tab: Notatki -->
                <div id="tab-activity" class="tab-content">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Left Column - Notes -->
                        <div class="lg:col-span-2 space-y-6">
                            <!-- Add Note -->
                            <div class="bg-zinc-900/40 rounded-lg border border-white/5 p-5">
                                <h3 class="text-sm font-medium text-white mb-4 flex items-center gap-2">
                                    <i class="ph ph-note-pencil text-emerald-400"></i>
                                    Notatki
                                </h3>
                                <textarea id="field-notes" rows="4" placeholder="Dodaj nową notatkę..." class="input-field w-full rounded-lg px-3 py-2.5 text-sm text-white resize-none mb-3"></textarea>
                                <button id="save-note-btn" class="w-full bg-white text-black hover:bg-zinc-200 px-4 py-3 rounded-lg text-sm font-medium transition-colors flex items-center justify-center gap-2">
                                    <i class="ph ph-plus"></i>
                                    Zapisz notatkę
                                </button>
                            </div>

                            <!-- Notes History -->
                            <div id="notes-history" class="bg-zinc-900/40 rounded-lg border border-white/5 p-5 hidden">
                                <h3 class="text-sm font-medium text-white mb-4 flex items-center gap-2">
                                    <i class="ph ph-notebook text-zinc-500"></i>
                                    Historia notatek
                                    <span id="notes-count" class="ml-auto text-[10px] bg-zinc-800 text-zinc-400 px-1.5 py-0.5 rounded font-mono">0</span>
                                </h3>
                                <div id="notes-history-list" class="space-y-3 max-h-[500px] overflow-y-auto">
                                    <!-- Notes will be rendered here -->
                                </div>
                            </div>
                        </div>

                        <!-- Right Column - Activity Timeline -->
                        <div class="space-y-6">
                            <div class="bg-zinc-900/40 rounded-lg border border-white/5 p-5">
                                <h3 class="text-sm font-medium text-white mb-4 flex items-center gap-2">
                                    <i class="ph ph-clock-counter-clockwise text-zinc-500"></i>
                                    Historia aktywności
                                    <span id="activity-count" class="ml-auto text-[10px] bg-zinc-800 text-zinc-400 px-1.5 py-0.5 rounded font-mono">0</span>
                                </h3>
                                <div id="activity-timeline" class="space-y-4 relative max-h-[600px] overflow-y-auto pr-2">
                                    <!-- Timeline items will be inserted here -->
                                </div>
                                <div id="activity-empty" class="hidden text-center py-8">
                                    <i class="ph ph-clock text-2xl text-zinc-700 mb-2"></i>
                                    <p class="text-zinc-500 text-xs">Brak aktywności</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div><!-- /tab-activity -->

                <!-- Tab: E-mail -->
                <div id="tab-email" class="tab-content">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Left Column - Email List -->
                        <div class="lg:col-span-2 space-y-4">
                            <!-- Compose Email -->
                            <div class="bg-zinc-900/40 rounded-lg border border-white/5 p-5">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-sm font-medium text-white flex items-center gap-2">
                                        <i class="ph ph-pencil-simple text-purple-400"></i>
                                        Napisz email
                                    </h3>
                                </div>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Temat</label>
                                        <input type="text" id="compose-subject" placeholder="Temat wiadomości..." class="input-field w-full rounded-lg px-3 py-2.5 text-sm text-white">
                                    </div>
                                    <div>
                                        <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Treść</label>
                                        <textarea id="compose-body" rows="6" placeholder="Napisz wiadomość..." class="input-field w-full rounded-lg px-3 py-2.5 text-sm text-white resize-none"></textarea>
                                    </div>
                                    <button id="send-email-btn" onclick="sendEmailToLead()" class="w-full bg-purple-600 hover:bg-purple-500 text-white px-4 py-3 rounded-lg text-sm font-medium transition-colors flex items-center justify-center gap-2">
                                        <i class="ph ph-paper-plane-tilt"></i>
                                        Wyślij email
                                    </button>
                                </div>
                            </div>

                            <!-- Email History -->
                            <div class="bg-zinc-900/40 rounded-lg border border-white/5 p-5">
                                <h3 class="text-sm font-medium text-white mb-4 flex items-center gap-2">
                                    <i class="ph ph-envelope text-zinc-500"></i>
                                    Historia wiadomości
                                    <span id="email-history-count" class="ml-auto text-[10px] font-mono text-zinc-600 bg-zinc-800 px-2 py-0.5 rounded">0</span>
                                </h3>
                                <div id="email-history-full" class="space-y-3">
                                    <div class="text-center text-zinc-600 text-xs py-8">
                                        <i class="ph ph-circle-notch animate-spin text-xl"></i>
                                        <p class="mt-2">Ładowanie...</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column - Stats & Filters -->
                        <div class="space-y-4">
                            <!-- Email Stats -->
                            <div class="bg-zinc-900/40 rounded-lg border border-white/5 p-5">
                                <h3 class="text-sm font-medium text-white mb-4 flex items-center gap-2">
                                    <i class="ph ph-chart-bar text-zinc-500"></i>
                                    Statystyki
                                </h3>
                                <div class="grid grid-cols-2 gap-3">
                                    <div class="bg-emerald-500/10 border border-emerald-500/20 rounded-lg p-3 text-center">
                                        <div id="email-stat-sent" class="text-2xl font-mono text-emerald-400">0</div>
                                        <div class="text-[10px] text-emerald-400/70 uppercase tracking-wider">Wysłane</div>
                                    </div>
                                    <div class="bg-blue-500/10 border border-blue-500/20 rounded-lg p-3 text-center">
                                        <div id="email-stat-received" class="text-2xl font-mono text-blue-400">0</div>
                                        <div class="text-[10px] text-blue-400/70 uppercase tracking-wider">Otrzymane</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Quick Filters -->
                            <div class="bg-zinc-900/40 rounded-lg border border-white/5 p-5">
                                <h3 class="text-sm font-medium text-white mb-4 flex items-center gap-2">
                                    <i class="ph ph-funnel text-zinc-500"></i>
                                    Filtruj
                                </h3>
                                <div class="flex flex-wrap gap-2">
                                    <button onclick="filterEmails('all')" class="email-filter-btn active px-3 py-1.5 text-xs rounded-lg border transition-colors" data-filter="all">
                                        Wszystkie
                                    </button>
                                    <button onclick="filterEmails('inbound')" class="email-filter-btn px-3 py-1.5 text-xs rounded-lg border border-blue-500/30 text-blue-400 hover:bg-blue-500/10 transition-colors" data-filter="inbound">
                                        <i class="ph ph-arrow-down mr-1"></i> Otrzymane
                                    </button>
                                    <button onclick="filterEmails('outbound')" class="email-filter-btn px-3 py-1.5 text-xs rounded-lg border border-emerald-500/30 text-emerald-400 hover:bg-emerald-500/10 transition-colors" data-filter="outbound">
                                        <i class="ph ph-arrow-up mr-1"></i> Wysłane
                                    </button>
                                </div>
                            </div>

                            <!-- Email Templates (future) -->
                            <div class="bg-zinc-900/40 rounded-lg border border-white/5 p-5 opacity-50">
                                <h3 class="text-sm font-medium text-zinc-500 mb-2 flex items-center gap-2">
                                    <i class="ph ph-files text-zinc-600"></i>
                                    Szablony
                                    <span class="text-[10px] bg-zinc-800 px-2 py-0.5 rounded">wkrótce</span>
                                </h3>
                                <p class="text-[11px] text-zinc-600">Szybkie odpowiedzi i szablony emaili będą dostępne wkrótce.</p>
                            </div>
                        </div>
                    </div>
                </div><!-- /tab-email -->

            </div>
        </div>
    </main>

    <!-- Add Meeting Modal -->
    <div id="meeting-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/70 backdrop-blur-sm" id="meeting-modal-backdrop"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div id="meeting-modal-content" class="bg-zinc-900 border border-white/10 rounded-xl shadow-2xl max-w-md w-full transform scale-95 opacity-0 transition-all duration-200">
                <div class="px-5 py-4 border-b border-white/5 flex items-center justify-between">
                    <h3 class="text-sm font-medium text-white flex items-center gap-2">
                        <i class="ph ph-calendar-plus text-pink-400"></i>
                        Nowe spotkanie
                    </h3>
                    <button id="close-meeting-modal" class="text-zinc-500 hover:text-white transition-colors">
                        <i class="ph ph-x text-lg"></i>
                    </button>
                </div>
                <form id="meeting-form" class="p-5 space-y-4" autocomplete="off">
                    <div>
                        <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Tytuł spotkania *</label>
                        <input type="text" id="meeting-title" name="mtg_title_x9k2" required autocomplete="new-password" class="input-field w-full rounded-lg px-3 py-2.5 text-sm text-white" placeholder="np. Prezentacja oferty">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Data *</label>
                            <input type="date" id="meeting-date" required class="input-field w-full rounded-lg px-3 py-2.5 text-sm text-white">
                        </div>
                        <div>
                            <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Godzina *</label>
                            <input type="time" id="meeting-time" required class="input-field w-full rounded-lg px-3 py-2.5 text-sm text-white" value="10:00">
                        </div>
                    </div>
                    <div>
                        <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Czas trwania</label>
                        <select id="meeting-duration" class="input-field w-full rounded-lg px-3 py-2.5 text-sm text-white cursor-pointer">
                            <option value="30">30 minut</option>
                            <option value="60" selected>1 godzina</option>
                            <option value="90">1.5 godziny</option>
                            <option value="120">2 godziny</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Opis (opcjonalnie)</label>
                        <textarea id="meeting-description" name="mtg_desc_z7m4" rows="2" autocomplete="new-password" class="input-field w-full rounded-lg px-3 py-2.5 text-sm text-white resize-none" placeholder="Dodatkowe notatki..."></textarea>
                    </div>
                </form>
                <div class="flex gap-3 px-5 py-4 border-t border-white/5 bg-zinc-950/50">
                    <button type="button" id="cancel-meeting" class="flex-1 px-4 py-2.5 bg-zinc-800 hover:bg-zinc-700 border border-white/10 rounded-lg text-zinc-300 text-sm font-medium transition-colors">
                        Anuluj
                    </button>
                    <button type="submit" form="meeting-form" id="save-meeting" class="flex-1 px-4 py-2.5 bg-pink-600 hover:bg-pink-500 rounded-lg text-white text-sm font-medium transition-colors flex items-center justify-center gap-2">
                        <i class="ph ph-calendar-plus"></i>
                        Dodaj spotkanie
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/70 backdrop-blur-sm" id="confirm-modal-backdrop"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div id="confirm-modal-content" class="bg-zinc-900 border border-white/10 rounded-xl shadow-2xl max-w-md w-full transform scale-95 opacity-0 transition-all duration-200">
                <div class="p-6">
                    <div id="confirm-modal-icon" class="w-14 h-14 rounded-full mx-auto mb-4 flex items-center justify-center">
                        <i id="confirm-modal-icon-inner" class="ph text-2xl"></i>
                    </div>
                    <h3 id="confirm-modal-title" class="text-lg font-semibold text-white text-center mb-2"></h3>
                    <p id="confirm-modal-message" class="text-zinc-400 text-sm text-center mb-6"></p>
                    <div class="flex gap-3">
                        <button id="confirm-modal-cancel" class="flex-1 px-4 py-2.5 bg-zinc-800 hover:bg-zinc-700 border border-white/10 rounded-lg text-zinc-300 text-sm font-medium transition-colors">
                            Anuluj
                        </button>
                        <button id="confirm-modal-confirm" class="flex-1 px-4 py-2.5 rounded-lg text-sm font-medium transition-colors">
                            Potwierdź
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://yxmavwkwnfuphjqbelws.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl4bWF2d2t3bmZ1cGhqcWJlbHdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NjQyNTUsImV4cCI6MjA4NDM0MDI1NX0.XeR0Fc7OFn6YbNJrOKTBEj36JtmLISZTM87y4ai9340';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Initialize sidebar
        Sidebar.render();
        Sidebar.setupLogout(supabaseClient);

        let lead = null;
        let tracking = null;
        let activities = [];
        let offers = [];
        let meetings = [];
        let notesHistory = [];
        let hasChanges = false;
        let teamMembers = [];
        let teamMembersMap = {};
        let currentMember = null;
        let isAdmin = false;
        let confirmModalCallback = null;
        let clientOffer = null;

        // Audit logging helper
        async function logAuditActivity(action_type, entity_type, entity_id, entity_identifier, old_value, new_value, metadata = {}) {
            if (!currentMember) return;

            try {
                await supabaseClient.from('audit_log').insert([{
                    action_type,
                    entity_type,
                    entity_id,
                    entity_identifier,
                    old_value,
                    new_value,
                    performed_by: currentMember.id,
                    performed_by_name: currentMember.name,
                    metadata: { ...metadata, source_page: window.location.pathname }
                }]);
            } catch (err) {
                console.error('Audit log error:', err);
            }
        }

        // Slack notification helper - fire and forget
        async function sendSlackNotification(type, data) {
            try {
                await fetch(`${SUPABASE_URL}/functions/v1/slack-notify`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify({ type, data })
                });
            } catch (err) {
                console.error('Slack notification error:', err);
            }
        }

        // Email notification helper
        async function sendEmail(type, data) {
            try {
                console.log('[sendEmail] Sending:', type, data?.email);
                const response = await fetch(`${SUPABASE_URL}/functions/v1/send-email`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify({ type, data })
                });
                const result = await response.json();
                if (result.success) {
                    console.log('[sendEmail] Success:', type, result.id);
                } else {
                    console.error('[sendEmail] Failed:', type, result.error);
                }
                return result;
            } catch (err) {
                console.error('[sendEmail] Error:', err);
                throw err;
            }
        }

        // Modal functions
        function showConfirmModal(options) {
            const modal = document.getElementById('confirm-modal');
            const content = document.getElementById('confirm-modal-content');
            const iconContainer = document.getElementById('confirm-modal-icon');
            const iconInner = document.getElementById('confirm-modal-icon-inner');
            const title = document.getElementById('confirm-modal-title');
            const message = document.getElementById('confirm-modal-message');
            const confirmBtn = document.getElementById('confirm-modal-confirm');

            // Set content
            title.textContent = options.title || 'Potwierdź';
            message.textContent = options.message || 'Czy na pewno chcesz kontynuować?';

            // Set theme (won = green, lost = red, abandoned = zinc, default = blue)
            if (options.theme === 'won') {
                iconContainer.className = 'w-14 h-14 rounded-full mx-auto mb-4 flex items-center justify-center bg-emerald-500/20';
                iconInner.className = 'ph ph-trophy text-2xl text-emerald-400';
                confirmBtn.className = 'flex-1 px-4 py-2.5 rounded-lg text-sm font-medium transition-colors bg-emerald-600 hover:bg-emerald-500 text-white';
            } else if (options.theme === 'lost') {
                iconContainer.className = 'w-14 h-14 rounded-full mx-auto mb-4 flex items-center justify-center bg-red-500/20';
                iconInner.className = 'ph ph-x-circle text-2xl text-red-400';
                confirmBtn.className = 'flex-1 px-4 py-2.5 rounded-lg text-sm font-medium transition-colors bg-red-600 hover:bg-red-500 text-white';
            } else if (options.theme === 'abandoned') {
                iconContainer.className = 'w-14 h-14 rounded-full mx-auto mb-4 flex items-center justify-center bg-zinc-500/20';
                iconInner.className = 'ph ph-prohibit text-2xl text-zinc-400';
                confirmBtn.className = 'flex-1 px-4 py-2.5 rounded-lg text-sm font-medium transition-colors bg-zinc-600 hover:bg-zinc-500 text-white';
            } else {
                iconContainer.className = 'w-14 h-14 rounded-full mx-auto mb-4 flex items-center justify-center bg-blue-500/20';
                iconInner.className = 'ph ph-arrows-left-right text-2xl text-blue-400';
                confirmBtn.className = 'flex-1 px-4 py-2.5 rounded-lg text-sm font-medium transition-colors bg-blue-600 hover:bg-blue-500 text-white';
            }

            // Store callback
            confirmModalCallback = options.onConfirm || null;

            // Show modal
            modal.classList.remove('hidden');
            requestAnimationFrame(() => {
                content.classList.remove('scale-95', 'opacity-0');
                content.classList.add('scale-100', 'opacity-100');
            });
        }

        function hideConfirmModal() {
            const modal = document.getElementById('confirm-modal');
            const content = document.getElementById('confirm-modal-content');

            content.classList.remove('scale-100', 'opacity-100');
            content.classList.add('scale-95', 'opacity-0');

            setTimeout(() => {
                modal.classList.add('hidden');
                confirmModalCallback = null;
            }, 200);
        }

        // Modal event listeners
        document.getElementById('confirm-modal-backdrop').addEventListener('click', hideConfirmModal);
        document.getElementById('confirm-modal-cancel').addEventListener('click', hideConfirmModal);
        document.getElementById('confirm-modal-confirm').addEventListener('click', () => {
            if (confirmModalCallback) {
                confirmModalCallback();
            }
            hideConfirmModal();
        });

        // Close modal on Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !document.getElementById('confirm-modal').classList.contains('hidden')) {
                hideConfirmModal();
            }
        });

        function getBasePath() {
            if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
                const path = location.pathname;
                const match = path.match(/^(\/[^\/]+)\//);
                return match ? match[1] : '';
            }
            return '';
        }

        function getLoginPath() {
            const base = getBasePath();
            return (location.hostname === 'localhost' || location.hostname === '127.0.0.1') ? `${base}/index.html` : '/';
        }

        function getLeadsPath() {
            const base = getBasePath();
            return (location.hostname === 'localhost' || location.hostname === '127.0.0.1') ? `${base}/leads.html` : '/leads';
        }

        async function checkAuth() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
                window.location.href = getLoginPath();
                return null;
            }
            document.getElementById('user-email').textContent = session.user.email.split('@')[0];
            await loadTeamMembers(session.user.id);
            return session;
        }

        async function loadTeamMembers(userId) {
            const { data, error } = await supabaseClient
                .from('team_members')
                .select('*');

            if (error) {
                console.error('Error loading team members:', error);
                return;
            }

            teamMembers = data || [];
            teamMembersMap = {};
            teamMembers.forEach(member => {
                teamMembersMap[member.id] = member;
            });

            currentMember = teamMembers.find(m => m.user_id === userId);
            isAdmin = currentMember?.role === 'admin';

            // Update sidebar user info
            if (currentMember) {
                Sidebar.setUserName(currentMember.name);
                Sidebar.setUserColor(currentMember.color);
                Sidebar.setupProfileClick();
            }

            // Show admin navigation items for admins
            Sidebar.showAdminNav(isAdmin);

            populateAssignedToSelect();
        }

        function populateAssignedToSelect() {
            const select = document.getElementById('field-assigned-to');
            if (!select) return;

            select.innerHTML = '<option value="">Nie przypisano</option>';
            teamMembers.forEach(member => {
                select.innerHTML += `<option value="${member.id}">${member.name}</option>`;
            });
        }

        function getMemberColor(memberId) {
            const member = teamMembersMap[memberId];
            if (!member) return 'bg-zinc-500';
            const colorMap = {
                'violet': 'bg-violet-500',
                'blue': 'bg-blue-500',
                'emerald': 'bg-emerald-500',
                'amber': 'bg-amber-500',
                'pink': 'bg-pink-500',
                'cyan': 'bg-cyan-500'
            };
            return colorMap[member.color] || 'bg-zinc-500';
        }

        function getLeadId() {
            const params = new URLSearchParams(window.location.search);
            return params.get('id');
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('pl-PL', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function formatPrice(price) {
            return new Intl.NumberFormat('pl-PL', {
                style: 'currency',
                currency: 'PLN',
                minimumFractionDigits: 0,
                maximumFractionDigits: 2
            }).format(price || 0);
        }

        function formatDateRelative(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / (1000 * 60));
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const days = Math.floor(hours / 24);

            if (minutes < 1) return 'przed chwilą';
            if (minutes < 60) return `${minutes} min temu`;
            if (hours < 24) return `${hours}h temu`;
            if (days < 7) return `${days} dni temu`;
            return formatDate(dateString);
        }

        function getSource(trackingData) {
            if (!trackingData) return { name: 'Organic', color: 'text-emerald-400', bg: 'bg-emerald-500/10', border: 'border-emerald-500/20' };
            if (trackingData.gclid || trackingData.gbraid || trackingData.wbraid) return { name: 'Google Ads', color: 'text-yellow-400', bg: 'bg-yellow-500/10', border: 'border-yellow-500/20' };
            if (trackingData.fbclid) return { name: 'Meta Ads', color: 'text-blue-400', bg: 'bg-blue-500/10', border: 'border-blue-500/20' };
            if (trackingData.ttclid) return { name: 'TikTok Ads', color: 'text-pink-400', bg: 'bg-pink-500/10', border: 'border-pink-500/20' };
            if (trackingData.utm_source) {
                const src = trackingData.utm_source.toLowerCase();
                if (src.includes('google')) return { name: 'Google', color: 'text-yellow-400', bg: 'bg-yellow-500/10', border: 'border-yellow-500/20' };
                if (src.includes('facebook') || src.includes('fb') || src.includes('meta')) return { name: 'Meta', color: 'text-blue-400', bg: 'bg-blue-500/10', border: 'border-blue-500/20' };
                if (src.includes('tiktok')) return { name: 'TikTok', color: 'text-pink-400', bg: 'bg-pink-500/10', border: 'border-pink-500/20' };
                if (src.includes('mailerlite') || src.includes('email') || src.includes('newsletter')) return { name: 'Email', color: 'text-purple-400', bg: 'bg-purple-500/10', border: 'border-purple-500/20' };
            }
            if (trackingData.utm_medium === 'email') return { name: 'Email', color: 'text-purple-400', bg: 'bg-purple-500/10', border: 'border-purple-500/20' };
            return { name: 'Organic', color: 'text-emerald-400', bg: 'bg-emerald-500/10', border: 'border-emerald-500/20' };
        }

        function getClickId(trackingData) {
            if (!trackingData) return null;
            if (trackingData.gclid) return trackingData.gclid;
            if (trackingData.gbraid) return trackingData.gbraid;
            if (trackingData.wbraid) return trackingData.wbraid;
            if (trackingData.fbclid) return trackingData.fbclid;
            if (trackingData.ttclid) return trackingData.ttclid;
            return null;
        }

        function getActivityIcon(type) {
            const icons = {
                'created': 'ph-plus-circle',
                'status_change': 'ph-arrows-left-right',
                'note': 'ph-note',
                'call': 'ph-phone',
                'email': 'ph-envelope',
                'email_event': 'ph-envelope',
                'meeting': 'ph-calendar',
                'proforma': 'ph-file-pdf',
                'offer_view': 'ph-eye',
                'other': 'ph-dot'
            };
            return icons[type] || 'ph-dot';
        }

        function getActivityColor(type) {
            const colors = {
                'created': 'bg-emerald-500',
                'status_change': 'bg-blue-500',
                'note': 'bg-zinc-500',
                'call': 'bg-yellow-500',
                'email': 'bg-purple-500',
                'email_event': 'bg-purple-500',
                'meeting': 'bg-pink-500',
                'proforma': 'bg-blue-400',
                'offer_view': 'bg-cyan-500',
                'other': 'bg-zinc-600'
            };
            return colors[type] || 'bg-zinc-600';
        }

        async function loadOffers() {
            const { data, error } = await supabaseClient
                .from('offers')
                .select('*')
                .eq('is_active', true)
                .order('name');

            if (error) {
                console.error('Error loading offers:', error);
                return;
            }

            offers = data || [];
            const select = document.getElementById('field-offer');
            select.innerHTML = '<option value="">— Wybierz ofertę —</option>';
            offers.forEach(offer => {
                const price = new Intl.NumberFormat('pl-PL', { style: 'currency', currency: 'PLN', minimumFractionDigits: 0 }).format(offer.price || 0);
                select.innerHTML += `<option value="${offer.id}" data-price="${offer.price || 0}">${offer.name} (${price})</option>`;
            });
        }

        async function loadLead() {
            const id = getLeadId();
            if (!id) {
                window.location.href = getLeadsPath();
                return;
            }

            // Load offers first
            await loadOffers();

            const { data, error } = await supabaseClient.from('leads').select('*').eq('id', id).single();
            if (error || !data) {
                alert('Lead nie znaleziony');
                window.location.href = getLeadsPath();
                return;
            }

            lead = data;

            // Load tracking data from separate table
            const { data: trackingData } = await supabaseClient
                .from('lead_tracking')
                .select('*')
                .eq('lead_id', id)
                .single();

            tracking = trackingData || null;

            renderLead();
            await loadActivities();
        }

        function renderLead() {
            const src = getSource(tracking);
            const colors = ['from-violet-500 to-purple-600', 'from-blue-500 to-cyan-600', 'from-emerald-500 to-green-600', 'from-orange-500 to-amber-600', 'from-pink-500 to-rose-600'];
            const colorIndex = lead.email.charCodeAt(0) % colors.length;

            // Header
            document.getElementById('breadcrumb-email').textContent = lead.email;
            document.getElementById('lead-avatar').className = `w-16 h-16 rounded-xl bg-gradient-to-br ${colors[colorIndex]} flex items-center justify-center text-white text-2xl font-bold flex-shrink-0`;
            document.getElementById('lead-avatar').textContent = lead.email.charAt(0).toUpperCase();
            document.getElementById('lead-email-display').textContent = lead.email;
            document.getElementById('lead-created').textContent = formatDate(lead.created_at);

            // Show survey_completed_at if available and different from created_at
            if (lead.survey_completed_at) {
                const createdDate = new Date(lead.created_at).toDateString();
                const surveyDate = new Date(lead.survey_completed_at).toDateString();
                // Only show if survey was completed on a different day or significantly later
                if (createdDate !== surveyDate || (new Date(lead.survey_completed_at) - new Date(lead.created_at)) > 60000) {
                    document.getElementById('lead-survey-date').textContent = formatDate(lead.survey_completed_at);
                    document.getElementById('lead-survey-wrapper').classList.remove('hidden');
                }
            }

            // Source badge
            const badge = document.getElementById('lead-source-badge');
            badge.textContent = src.name;
            badge.className = `inline-flex items-center px-2 py-0.5 rounded border text-[10px] font-medium ${src.color} ${src.bg} ${src.border}`;

            // Update pipeline stepper
            const status = lead.status || 'new';
            updatePipelineStepper(status);

            // Form fields
            document.getElementById('field-email').value = lead.email;
            document.getElementById('field-phone').value = lead.phone || '';
            // Enable/disable phone action buttons
            const hasPhone = !!lead.phone;
            document.getElementById('btn-call').disabled = !hasPhone;
            document.getElementById('btn-whatsapp').disabled = !hasPhone;
            document.getElementById('field-name').value = lead.name || '';
            document.getElementById('field-company').value = lead.company || '';
            document.getElementById('field-nip').value = lead.nip || '';
            document.getElementById('field-address').value = lead.address || '';

            // Set offer if available, otherwise set default offer
            if (lead.offer_id) {
                document.getElementById('field-offer').value = lead.offer_id;
            } else {
                // Set default offer if one exists
                const defaultOffer = offers.find(o => o.is_default);
                if (defaultOffer) {
                    document.getElementById('field-offer').value = defaultOffer.id;
                }
            }

            // Set deal_value - use offer price as default if deal_value is empty
            if (lead.deal_value) {
                document.getElementById('field-value').value = lead.deal_value;
            } else {
                // Try to get price from selected offer
                const offerSelect = document.getElementById('field-offer');
                const selectedOption = offerSelect.options[offerSelect.selectedIndex];
                if (selectedOption && selectedOption.dataset.price && selectedOption.dataset.price !== '0') {
                    document.getElementById('field-value').value = selectedOption.dataset.price;
                } else {
                    document.getElementById('field-value').value = '';
                }
            }
            document.getElementById('field-expected-close').value = lead.expected_close || '';
            document.getElementById('field-assigned-to').value = lead.assigned_to || '';
            document.getElementById('field-notes').value = '';

            // Load and render notes history
            notesHistory = lead.notes_history || [];
            renderNotesHistory();

            // Load email history
            loadEmailHistory();

            // Enable/disable call button based on phone
            document.getElementById('btn-call').disabled = !lead.phone;

            // Tracking (from separate tracking table)
            document.getElementById('tracking-source').textContent = tracking?.utm_source || '-';
            document.getElementById('tracking-medium').textContent = tracking?.utm_medium || '-';
            document.getElementById('tracking-campaign').textContent = tracking?.utm_campaign || '-';
            document.getElementById('tracking-clickid').textContent = getClickId(tracking) || '-';
            document.getElementById('tracking-landing').textContent = tracking?.landing_page || '-';
            document.getElementById('tracking-useragent').textContent = tracking?.user_agent || '-';

            // Survey responses
            renderSurvey();
        }

        function formatSurveyHours(value) {
            const map = {
                '1-2h': '1-2 godziny',
                '3-5h': '3-5 godzin',
                '5h+': 'Ponad 5 godzin'
            };
            return map[value] || value || '-';
        }

        function formatSurveyMoney(value) {
            const map = {
                '5-10k': '5 000 - 10 000 zł',
                '10-20k': '10 000 - 20 000 zł',
                '20-40k': '20 000 - 40 000 zł',
                '40k+': 'Ponad 40 000 zł'
            };
            return map[value] || value || '-';
        }

        function renderSurvey() {
            const section = document.getElementById('survey-section');

            // Show section only if lead has survey data
            if (!lead.weekly_hours && !lead.target_income && !lead.experience) {
                section.classList.add('hidden');
                return;
            }

            section.classList.remove('hidden');

            document.getElementById('survey-hours').textContent = formatSurveyHours(lead.weekly_hours);
            document.getElementById('survey-income').textContent = formatSurveyMoney(lead.target_income);
            document.getElementById('survey-experience').textContent = lead.experience || '-';

            // Show open question if available
            const openContainer = document.getElementById('survey-open-container');
            if (lead.open_question) {
                openContainer.classList.remove('hidden');
                document.getElementById('survey-open').textContent = lead.open_question;
            } else {
                openContainer.classList.add('hidden');
            }
        }

        async function loadActivities() {
            // Start with stored activities
            activities = lead.activities || [];

            // Add creation event if not exists
            if (!activities.find(a => a.type === 'created')) {
                activities.unshift({
                    type: 'created',
                    content: 'Lead utworzony',
                    created_at: lead.created_at
                });
            }

            // Fetch email events from email_messages table
            try {
                const { data: emails } = await supabaseClient
                    .from('email_messages')
                    .select('id, direction, subject, from_email, to_email, sent_at, received_at, created_at')
                    .eq('lead_id', lead.id)
                    .order('created_at', { ascending: false });

                if (emails) {
                    for (const email of emails) {
                        const existsInActivities = activities.some(a =>
                            a.type === 'email_event' && a.email_id === email.id
                        );
                        if (!existsInActivities) {
                            const isInbound = email.direction === 'inbound';
                            activities.push({
                                type: 'email_event',
                                email_id: email.id,
                                content: isInbound
                                    ? `📧 Otrzymano email: "${email.subject || '(bez tematu)'}"`
                                    : `📤 Wysłano email: "${email.subject || '(bez tematu)'}"`,
                                created_at: email.sent_at || email.received_at || email.created_at
                            });
                        }
                    }
                }
            } catch (e) {
                console.error('Error loading email activities:', e);
            }

            // Fetch offer view events from client_offer_views table
            try {
                if (clientOffer?.id) {
                    const { data: views } = await supabaseClient
                        .from('client_offer_views')
                        .select('id, viewed_at, ip_address, user_agent')
                        .eq('client_offer_id', clientOffer.id)
                        .order('viewed_at', { ascending: false });

                    if (views) {
                        for (const view of views) {
                            const existsInActivities = activities.some(a =>
                                a.type === 'offer_view' && a.view_id === view.id
                            );
                            if (!existsInActivities) {
                                activities.push({
                                    type: 'offer_view',
                                    view_id: view.id,
                                    content: '👁️ Klient wyświetlił ofertę',
                                    created_at: view.viewed_at
                                });
                            }
                        }
                    }
                }
            } catch (e) {
                console.error('Error loading offer view activities:', e);
            }

            renderActivities();
        }

        function renderActivities() {
            const timeline = document.getElementById('activity-timeline');
            const empty = document.getElementById('activity-empty');
            const countEl = document.getElementById('activity-count');

            countEl.textContent = activities.length;

            if (activities.length === 0) {
                timeline.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }

            empty.classList.add('hidden');

            // Sort by date desc
            const sorted = [...activities].sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

            timeline.innerHTML = sorted.map((activity, index) => {
                const performerName = activity.performed_by_name || (activity.type === 'created' ? 'System' : null);
                const performerInfo = performerName ? `<span class="text-zinc-400">przez</span> <span class="text-zinc-300">${DOMPurify.sanitize(performerName)}</span>` : '';

                return `
                    <div class="flex gap-3 relative ${index < sorted.length - 1 ? 'pb-4' : ''}">
                        ${index < sorted.length - 1 ? '<div class="timeline-line"></div>' : ''}
                        <div class="w-6 h-6 rounded-full ${getActivityColor(activity.type)} flex items-center justify-center flex-shrink-0 z-10">
                            <i class="ph ${getActivityIcon(activity.type)} text-white text-xs"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="text-sm text-white">${DOMPurify.sanitize(activity.content || '')}</div>
                            <div class="text-[10px] text-zinc-500 font-mono mt-0.5 flex items-center gap-2">
                                <span>${formatDateRelative(activity.created_at)}</span>
                                ${performerInfo}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderNotesHistory() {
            const container = document.getElementById('notes-history');
            const list = document.getElementById('notes-history-list');
            const countEl = document.getElementById('notes-count');
            const tabCountEl = document.getElementById('activity-tab-count');

            // Update tab badge with actual notes count
            const notesCount = notesHistory ? notesHistory.length : 0;
            if (tabCountEl) tabCountEl.textContent = notesCount;

            if (!notesHistory || notesHistory.length === 0) {
                container.classList.add('hidden');
                if (countEl) countEl.textContent = '0';
                return;
            }

            container.classList.remove('hidden');
            if (countEl) countEl.textContent = notesHistory.length;

            // Sort by date desc (newest first)
            const sorted = [...notesHistory].sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

            list.innerHTML = sorted.map(note => {
                const statusLabel = getStatusLabel(note.lead_status);
                const authorName = note.performed_by_name || 'Nieznany';
                const dateStr = new Date(note.created_at).toLocaleString('pl-PL', {
                    day: 'numeric',
                    month: 'short',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                return `
                    <div class="p-3 bg-zinc-950/50 rounded-lg border border-white/5">
                        <div class="text-sm text-white whitespace-pre-wrap mb-2">${DOMPurify.sanitize(note.content || '')}</div>
                        <div class="flex items-center gap-3 text-[10px] font-mono text-zinc-500">
                            <span class="flex items-center gap-1">
                                <i class="ph ph-clock"></i>
                                ${dateStr}
                            </span>
                            <span class="flex items-center gap-1">
                                <i class="ph ph-user"></i>
                                ${DOMPurify.sanitize(authorName)}
                            </span>
                            <span class="flex items-center gap-1 px-1.5 py-0.5 rounded bg-zinc-800 border border-white/5">
                                <i class="ph ph-tag"></i>
                                ${statusLabel}
                            </span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Email History
        async function loadEmailHistory() {
            const container = document.getElementById('email-history');
            const countEl = document.getElementById('email-count');
            const tabCountEl = document.getElementById('email-tab-count');

            if (!lead?.id) {
                container.innerHTML = '<div class="text-center text-zinc-600 text-xs py-4">Brak emaili</div>';
                return;
            }

            // Load emails for this lead - by lead_id OR by email address
            const leadEmail = lead?.email?.toLowerCase();

            let query = supabaseClient
                .from('email_messages')
                .select('*')
                .order('created_at', { ascending: false })
                .limit(50);

            // Query by lead_id OR by email address (to/from)
            if (leadEmail) {
                query = query.or(`lead_id.eq.${lead.id},to_email.ilike.${leadEmail},from_email.ilike.${leadEmail}`);
            } else {
                query = query.eq('lead_id', lead.id);
            }

            const { data: emails, error } = await query;

            if (error) {
                console.error('Error loading emails:', error);
                container.innerHTML = '<div class="text-center text-red-400 text-xs py-4">Błąd ładowania emaili</div>';
                return;
            }

            const count = emails?.length || 0;
            countEl.textContent = count;
            tabCountEl.textContent = count;

            if (!emails || emails.length === 0) {
                container.innerHTML = '<div class="text-center text-zinc-600 text-xs py-4">Brak historii emaili</div>';
                return;
            }

            container.innerHTML = emails.map(email => {
                const isInbound = email.direction === 'inbound';
                const dateStr = new Date(email.created_at).toLocaleString('pl-PL', {
                    day: 'numeric',
                    month: 'short',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const directionIcon = isInbound
                    ? '<i class="ph ph-arrow-down text-blue-400"></i>'
                    : '<i class="ph ph-arrow-up text-emerald-400"></i>';

                const directionLabel = isInbound ? 'Otrzymano' : 'Wysłano';
                const bgClass = isInbound ? 'border-blue-500/20' : 'border-emerald-500/20';

                return `
                    <div class="p-3 bg-zinc-950/50 rounded-lg border ${bgClass} cursor-pointer hover:bg-zinc-900/50 transition-colors" onclick="showEmailDetail('${email.id}')">
                        <div class="flex items-start gap-2">
                            <div class="mt-0.5">${directionIcon}</div>
                            <div class="flex-1 min-w-0">
                                <div class="text-xs text-white font-medium truncate">${email.subject || '(bez tematu)'}</div>
                                <div class="text-[10px] text-zinc-500 mt-0.5 truncate">
                                    ${isInbound ? 'Od: ' + email.from_email : 'Do: ' + email.to_email}
                                </div>
                            </div>
                            <div class="text-[10px] text-zinc-600 font-mono whitespace-nowrap">${dateStr}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showEmailDetail(emailId) {
            // Fetch and show email in modal (can be expanded later)
            supabaseClient
                .from('email_messages')
                .select('*')
                .eq('id', emailId)
                .single()
                .then(({ data: email, error }) => {
                    if (error || !email) return;

                    const isInbound = email.direction === 'inbound';
                    const dateStr = new Date(email.created_at).toLocaleString('pl-PL');

                    const content = `
                        <div class="space-y-4">
                            <div class="flex items-center gap-2 text-xs">
                                <span class="px-2 py-1 rounded ${isInbound ? 'bg-blue-500/20 text-blue-400' : 'bg-emerald-500/20 text-emerald-400'}">
                                    ${isInbound ? 'Otrzymano' : 'Wysłano'}
                                </span>
                                <span class="text-zinc-500">${dateStr}</span>
                            </div>
                            <div class="text-xs text-zinc-400">
                                <div><strong>Od:</strong> ${email.from_name ? DOMPurify.sanitize(email.from_name) + ' &lt;' + DOMPurify.sanitize(email.from_email) + '&gt;' : DOMPurify.sanitize(email.from_email)}</div>
                                <div><strong>Do:</strong> ${DOMPurify.sanitize(email.to_email || '')}</div>
                                <div><strong>Temat:</strong> ${DOMPurify.sanitize(email.subject || '(bez tematu)')}</div>
                            </div>
                            <div class="border-t border-white/10 pt-4">
                                <div class="prose prose-invert prose-sm max-w-none text-zinc-300 text-sm email-body-content">
                                </div>
                            </div>
                        </div>
                    `;

                    // Create modal with sanitized content
                    const modal = document.createElement('div');
                    modal.className = 'fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4';
                    modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
                    modal.innerHTML = `
                        <div class="bg-zinc-900 border border-white/10 rounded-xl w-full max-w-2xl max-h-[80vh] overflow-hidden">
                            <div class="flex items-center justify-between p-4 border-b border-white/5">
                                <h3 class="text-white font-medium">${DOMPurify.sanitize(email.subject || 'Email')}</h3>
                                <button onclick="this.closest('.fixed').remove()" class="text-zinc-500 hover:text-white">
                                    <i class="ph ph-x text-xl"></i>
                                </button>
                            </div>
                            <div class="p-4 overflow-y-auto max-h-[60vh]">
                                ${content}
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);

                    // Safely insert sanitized email body
                    const emailBodyEl = modal.querySelector('.email-body-content');
                    if (emailBodyEl) {
                        const bodyContent = email.body_html || email.body_text || '<em class="text-zinc-500">Brak treści</em>';
                        emailBodyEl.innerHTML = DOMPurify.sanitize(bodyContent, {
                            ALLOWED_TAGS: ['p', 'br', 'strong', 'b', 'em', 'i', 'u', 'a', 'ul', 'ol', 'li', 'div', 'span', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'blockquote', 'pre', 'code', 'table', 'thead', 'tbody', 'tr', 'td', 'th', 'img'],
                            ALLOWED_ATTR: ['href', 'src', 'alt', 'class', 'style', 'target'],
                            ALLOW_DATA_ATTR: false
                        });
                    }
                });
        }

        function getStatusLabel(status) {
            if (!status) return 'Brak';
            if (status === 'won') return 'Wygrany';
            if (status === 'lost') return 'Przegrany';
            if (status === 'abandoned') return 'Porzucony';
            const stage = pipelineStages.find(s => s.id === status);
            return stage?.name || status;
        }

        // Pipeline stages - loaded dynamically from settings
        const DEFAULT_PIPELINE_STAGES = [
            { id: 'new', name: 'Nowy', order: 0 },
            { id: 'contacted', name: 'Skontaktowany', order: 1 },
            { id: 'qualified', name: 'Zakwalifikowany', order: 2 },
            { id: 'proposal', name: 'Propozycja', order: 3 },
            { id: 'negotiation', name: 'Negocjacje', order: 4 }
        ];

        let pipelineStages = [...DEFAULT_PIPELINE_STAGES];
        let PIPELINE_STAGES = pipelineStages.map(s => s.id);
        let STATUS_LABELS = {
            won: 'Wygrany',
            lost: 'Przegrany',
            abandoned: 'Porzucony'
        };

        async function loadPipelineSettings() {
            const { data, error } = await supabaseClient
                .from('settings')
                .select('*')
                .eq('key', 'pipeline_stages')
                .single();

            if (!error && data?.value) {
                try {
                    pipelineStages = JSON.parse(data.value);
                } catch (e) {
                    pipelineStages = [...DEFAULT_PIPELINE_STAGES];
                }
            }

            // Update PIPELINE_STAGES array
            PIPELINE_STAGES = pipelineStages.map(s => s.id);

            // Build STATUS_LABELS from dynamic stages
            STATUS_LABELS = { won: 'Wygrany', lost: 'Przegrany', abandoned: 'Porzucony' };
            pipelineStages.forEach(stage => {
                STATUS_LABELS[stage.id] = stage.name;
            });

            // Render the stepper
            renderPipelineStepper();
        }

        // Stage colors and icons for pipeline mini
        const STAGE_COLORS = [
            { bg: 'bg-emerald-500/20', text: 'text-emerald-400', border: 'border-emerald-500/30', glow: 'rgba(52, 211, 153, 0.3)' },
            { bg: 'bg-blue-500/20', text: 'text-blue-400', border: 'border-blue-500/30', glow: 'rgba(59, 130, 246, 0.3)' },
            { bg: 'bg-violet-500/20', text: 'text-violet-400', border: 'border-violet-500/30', glow: 'rgba(139, 92, 246, 0.3)' },
            { bg: 'bg-amber-500/20', text: 'text-amber-400', border: 'border-amber-500/30', glow: 'rgba(245, 158, 11, 0.3)' },
            { bg: 'bg-orange-500/20', text: 'text-orange-400', border: 'border-orange-500/30', glow: 'rgba(249, 115, 22, 0.3)' },
            { bg: 'bg-cyan-500/20', text: 'text-cyan-400', border: 'border-cyan-500/30', glow: 'rgba(34, 211, 238, 0.3)' },
            { bg: 'bg-pink-500/20', text: 'text-pink-400', border: 'border-pink-500/30', glow: 'rgba(236, 72, 153, 0.3)' }
        ];
        const STAGE_ICONS = ['ph-user-plus', 'ph-chat-circle', 'ph-check-circle', 'ph-file-text', 'ph-handshake', 'ph-star', 'ph-flag'];

        function renderPipelineStepper() {
            const container = document.getElementById('pipeline-stages-container');
            if (!container) return;

            // Render regular stages
            let html = pipelineStages.map((stage, index) => {
                const colors = STAGE_COLORS[index % STAGE_COLORS.length];
                const icon = STAGE_ICONS[index % STAGE_ICONS.length];
                return `
                    <button data-stage="${stage.id}" class="stage-pill ${colors.text}" style="--glow-color: ${colors.glow}">
                        <div class="stage-icon ${colors.bg}">
                            <i class="ph ${icon}"></i>
                        </div>
                        <span class="stage-name">${stage.name}</span>
                        <i class="ph ph-check stage-check"></i>
                    </button>
                `;
            }).join('');

            // Add terminal stages
            html += `
                <button data-stage="won" class="stage-pill text-emerald-400" style="--glow-color: rgba(34, 197, 94, 0.4)">
                    <div class="stage-icon bg-emerald-500/20">
                        <i class="ph ph-trophy"></i>
                    </div>
                    <span class="stage-name">Wygrany</span>
                </button>
                <button data-stage="lost" class="stage-pill text-red-400" style="--glow-color: rgba(239, 68, 68, 0.4)">
                    <div class="stage-icon bg-red-500/20">
                        <i class="ph ph-x-circle"></i>
                    </div>
                    <span class="stage-name">Przegrany</span>
                </button>
                <button data-stage="abandoned" class="stage-pill text-zinc-400" style="--glow-color: rgba(113, 113, 122, 0.4)">
                    <div class="stage-icon bg-zinc-500/20">
                        <i class="ph ph-prohibit"></i>
                    </div>
                    <span class="stage-name">Porzucony</span>
                </button>
            `;

            container.innerHTML = html;

            // Attach click handlers
            container.querySelectorAll('.stage-pill').forEach(pill => {
                pill.addEventListener('click', () => {
                    const newStatus = pill.dataset.stage;
                    const currentStatus = lead.status || 'new';
                    const isCurrentlyTerminal = currentStatus === 'won' || currentStatus === 'lost' || currentStatus === 'abandoned';

                    // Confirm when reopening from terminal state
                    if (isCurrentlyTerminal && newStatus !== 'won' && newStatus !== 'lost' && newStatus !== 'abandoned') {
                        const statusLabel = currentStatus === 'won' ? 'wygrany' : currentStatus === 'lost' ? 'przegrany' : 'porzucony';
                        showConfirmModal({
                            title: 'Ponownie otwórz leada',
                            message: `Lead jest oznaczony jako ${statusLabel}. Czy chcesz go ponownie otworzyć?`,
                            theme: 'reopen',
                            onConfirm: () => changeStatus(newStatus)
                        });
                        return;
                    }

                    // Confirm terminal states with custom modal
                    if (newStatus === 'won') {
                        showConfirmModal({
                            title: 'Oznacz jako wygrany',
                            message: 'Czy na pewno chcesz oznaczyć tego leada jako wygrany? To oznacza zamknięcie dealu.',
                            theme: 'won',
                            onConfirm: () => changeStatus(newStatus)
                        });
                        return;
                    }

                    if (newStatus === 'lost') {
                        showConfirmModal({
                            title: 'Oznacz jako przegrany',
                            message: 'Czy na pewno chcesz oznaczyć tego leada jako przegrany? Będziesz mógł później zmienić status.',
                            theme: 'lost',
                            onConfirm: () => changeStatus(newStatus)
                        });
                        return;
                    }

                    if (newStatus === 'abandoned') {
                        showConfirmModal({
                            title: 'Oznacz jako porzucony',
                            message: 'Czy na pewno chcesz oznaczyć tego leada jako porzucony? To oznacza, że nie ma sensu się z nim kontaktować.',
                            theme: 'abandoned',
                            onConfirm: () => changeStatus(newStatus)
                        });
                        return;
                    }

                    changeStatus(newStatus);
                });
            });
        }

        function updatePipelineStepper(status) {
            const stepper = document.getElementById('pipeline-stepper');
            const pills = document.querySelectorAll('.stage-pill');
            const currentIndex = PIPELINE_STAGES.indexOf(status);
            const isTerminal = status === 'won' || status === 'lost' || status === 'abandoned';

            // Reset all pills
            pills.forEach(pill => {
                pill.classList.remove('completed', 'current', 'terminal-won', 'terminal-lost', 'terminal-abandoned');
            });

            // Handle terminal states
            if (isTerminal) {
                stepper.classList.add('terminal-state');
                const terminalPill = document.querySelector(`[data-stage="${status}"]`);
                if (terminalPill) {
                    terminalPill.classList.add(status === 'won' ? 'terminal-won' : status === 'lost' ? 'terminal-lost' : 'terminal-abandoned');
                }
                // Mark all regular stages as completed
                pipelineStages.forEach((stage, index) => {
                    const pill = document.querySelector(`[data-stage="${stage.id}"]`);
                    if (pill) pill.classList.add('completed');
                });
            } else {
                stepper.classList.remove('terminal-state');
                // Update regular stages
                pipelineStages.forEach((stage, index) => {
                    const pill = document.querySelector(`[data-stage="${stage.id}"]`);
                    if (!pill) return;

                    if (index < currentIndex) {
                        pill.classList.add('completed');
                    } else if (index === currentIndex) {
                        pill.classList.add('current');
                    }
                });
            }
        }

        function changeStatus(newStatus) {
            const oldStatus = lead.status || 'new';
            if (newStatus !== oldStatus) {
                lead.status = newStatus;

                // Add activity with performer info
                activities.push({
                    type: 'status_change',
                    content: `Status zmieniony: ${STATUS_LABELS[oldStatus]} → ${STATUS_LABELS[newStatus]}`,
                    created_at: new Date().toISOString(),
                    performed_by: currentMember?.id || null,
                    performed_by_name: currentMember?.name || null
                });

                // Log status change to audit
                logAuditActivity('status_change', 'lead', lead.id, lead.email,
                    { status: oldStatus },
                    { status: newStatus }
                );

                updatePipelineStepper(newStatus);
                renderActivities();
                autoSave();
            }
        }

        // Auto-save with debounce
        let saveTimeout = null;
        let isSaving = false;

        function showSaveStatus(status) {
            const statusEl = document.getElementById('save-status-text');
            if (status === 'saving') {
                statusEl.innerHTML = '<i class="ph ph-circle-notch animate-spin"></i> Zapisywanie...';
                statusEl.className = 'text-zinc-400';
            } else if (status === 'saved') {
                statusEl.innerHTML = '<i class="ph ph-check-circle"></i> Zapisano';
                statusEl.className = 'text-emerald-400';
                setTimeout(() => {
                    statusEl.innerHTML = '';
                }, 2000);
            } else if (status === 'error') {
                statusEl.innerHTML = '<i class="ph ph-warning-circle"></i> Błąd zapisu';
                statusEl.className = 'text-red-400';
            } else {
                statusEl.innerHTML = '';
            }
        }

        async function autoSave() {
            if (isSaving || !lead) return;

            isSaving = true;
            showSaveStatus('saving');

            const updates = {
                status: lead.status,
                phone: document.getElementById('field-phone').value || null,
                name: document.getElementById('field-name').value || null,
                company: document.getElementById('field-company').value || null,
                nip: document.getElementById('field-nip').value || null,
                address: document.getElementById('field-address').value || null,
                offer_id: document.getElementById('field-offer').value || null,
                deal_value: document.getElementById('field-value').value ? parseFloat(document.getElementById('field-value').value) : null,
                expected_close: document.getElementById('field-expected-close').value || null,
                assigned_to: document.getElementById('field-assigned-to').value || null,
                activities: activities.filter(a => a.type !== 'created')
            };

            // Track what changed for audit log
            const changedFields = {};
            const oldValues = {};
            const fieldsToTrack = ['phone', 'name', 'company', 'nip', 'address', 'offer_id', 'deal_value', 'expected_close', 'assigned_to'];
            fieldsToTrack.forEach(field => {
                if (lead[field] !== updates[field]) {
                    oldValues[field] = lead[field];
                    changedFields[field] = updates[field];
                }
            });

            const { error } = await supabaseClient.from('leads').update(updates).eq('id', lead.id);

            isSaving = false;

            if (error) {
                showSaveStatus('error');
                console.error('Auto-save error:', error);
            } else {
                // Log field changes if any
                if (Object.keys(changedFields).length > 0) {
                    logAuditActivity('update', 'lead', lead.id, lead.email, oldValues, changedFields);
                    // Update local lead object
                    Object.assign(lead, changedFields);
                }
                hasChanges = false;
                showSaveStatus('saved');
            }
        }

        function triggerAutoSave() {
            hasChanges = true;
            if (saveTimeout) clearTimeout(saveTimeout);
            saveTimeout = setTimeout(autoSave, 1000); // Save 1 second after last change
        }

        // Track changes on all editable fields
        const editableFields = ['field-phone', 'field-name', 'field-company', 'field-nip', 'field-address', 'field-value', 'field-expected-close'];
        const selectFields = ['field-assigned-to'];

        editableFields.forEach(id => {
            document.getElementById(id).addEventListener('input', triggerAutoSave);
        });

        selectFields.forEach(id => {
            document.getElementById(id).addEventListener('change', triggerAutoSave);
        });

        // Offer change handler - always set price from offer
        document.getElementById('field-offer').addEventListener('change', (e) => {
            const selectedOption = e.target.options[e.target.selectedIndex];
            const price = selectedOption.dataset.price;
            const valueField = document.getElementById('field-value');

            // Always set price from offer when offer is selected
            if (price && price !== '0') {
                valueField.value = price;
            }

            triggerAutoSave();

            // Update client offer section visibility
            updateClientOfferSection();
        });

        // Fetch company data from NIP
        document.getElementById('btn-fetch-nip').addEventListener('click', async () => {
            const nip = document.getElementById('field-nip').value.replace(/[\s-]/g, '');
            if (!nip || nip.length !== 10) {
                alert('Podaj prawidłowy NIP (10 cyfr)');
                return;
            }

            const btn = document.getElementById('btn-fetch-nip');
            const originalHtml = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="ph ph-circle-notch animate-spin text-lg"></i>';

            try {
                const today = new Date().toISOString().split('T')[0];
                const response = await fetch(`https://wl-api.mf.gov.pl/api/search/nip/${nip}?date=${today}`);
                const data = await response.json();

                if (data.result && data.result.subject) {
                    const subject = data.result.subject;

                    // Fill company name
                    if (subject.name) {
                        document.getElementById('field-company').value = subject.name;
                    }

                    // Fill address (prefer workingAddress, fallback to residenceAddress)
                    const address = subject.workingAddress || subject.residenceAddress;
                    if (address) {
                        document.getElementById('field-address').value = address;
                    }

                    triggerAutoSave();

                    // Show success feedback
                    btn.innerHTML = '<i class="ph ph-check text-lg"></i>';
                    btn.className = btn.className.replace('bg-blue-500/20', 'bg-emerald-500/20').replace('border-blue-500/30', 'border-emerald-500/30').replace('text-blue-400', 'text-emerald-400');
                    setTimeout(() => {
                        btn.innerHTML = originalHtml;
                        btn.className = btn.className.replace('bg-emerald-500/20', 'bg-blue-500/20').replace('border-emerald-500/30', 'border-blue-500/30').replace('text-emerald-400', 'text-blue-400');
                        btn.disabled = false;
                    }, 2000);
                } else {
                    alert('Nie znaleziono firmy o podanym NIP');
                    btn.innerHTML = originalHtml;
                    btn.disabled = false;
                }
            } catch (err) {
                console.error('Error fetching NIP data:', err);
                alert('Błąd pobierania danych. Spróbuj ponownie.');
                btn.innerHTML = originalHtml;
                btn.disabled = false;
            }
        });

        // Click-to-email
        document.getElementById('btn-mailto').addEventListener('click', () => {
            const email = document.getElementById('field-email').value;
            if (email) {
                window.location.href = `mailto:${email}`;
            }
        });

        // Click-to-call
        document.getElementById('btn-call').addEventListener('click', () => {
            const phone = document.getElementById('field-phone').value.trim();
            if (phone) {
                window.location.href = `tel:${phone.replace(/\s/g, '')}`;
            }
        });

        // Click-to-WhatsApp
        document.getElementById('btn-whatsapp').addEventListener('click', async () => {
            const phone = document.getElementById('field-phone').value.trim();
            if (phone) {
                // Remove spaces, dashes and Polish prefix, ensure proper format
                let cleaned = phone.replace(/[\s\-\(\)]/g, '').replace(/^\+?48/, '');

                // First contact with new lead - add pre-filled message
                const isFirstContactWithNewLead = !lead.whatsapp_contacted_at && lead.status === 'new';
                let url = `https://wa.me/48${cleaned}`;
                if (isFirstContactWithNewLead) {
                    url += `?text=${encodeURIComponent('Cześć, piszę w sprawie inwestycji.')}`;
                }

                // Mark as contacted immediately to prevent duplicate messages on rapid clicks
                lead.whatsapp_contacted_at = new Date().toISOString();

                window.open(url, '_blank');

                // Always save WhatsApp contact timestamp to database (tracks last contact)
                await supabaseClient
                    .from('leads')
                    .update({ whatsapp_contacted_at: lead.whatsapp_contacted_at })
                    .eq('id', lead.id);
            }
        });

        // Enable/disable call and whatsapp buttons based on phone field
        document.getElementById('field-phone').addEventListener('input', (e) => {
            const phone = e.target.value.trim();
            document.getElementById('btn-call').disabled = !phone;
            document.getElementById('btn-whatsapp').disabled = !phone;
        });

        // Delete
        document.getElementById('delete-btn').addEventListener('click', async () => {
            if (!confirm('Czy na pewno chcesz usunąć tego leada? Ta akcja jest nieodwracalna.')) return;

            // Log deletion before actually deleting
            await logAuditActivity('delete', 'lead', lead.id, lead.email, {
                email: lead.email,
                name: lead.name,
                company: lead.company,
                status: lead.status
            }, null);

            const { error } = await supabaseClient.from('leads').delete().eq('id', lead.id);

            if (error) {
                alert('Błąd usuwania: ' + error.message);
                return;
            }

            window.location.href = getLeadsPath();
        });

        // Save note
        document.getElementById('save-note-btn').addEventListener('click', async () => {
            const noteContent = document.getElementById('field-notes').value.trim();
            if (!noteContent) {
                alert('Wpisz treść notatki');
                return;
            }

            const btn = document.getElementById('save-note-btn');
            const originalHtml = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="ph ph-circle-notch animate-spin"></i> Zapisywanie...';

            // Create new note entry
            const newNote = {
                content: noteContent,
                created_at: new Date().toISOString(),
                performed_by: currentMember?.id || null,
                performed_by_name: currentMember?.name || null,
                lead_status: lead.status || 'new'
            };

            // Add to notes history
            notesHistory.push(newNote);

            // Save to database
            const { error } = await supabaseClient
                .from('leads')
                .update({ notes_history: notesHistory })
                .eq('id', lead.id);

            btn.innerHTML = originalHtml;
            btn.disabled = false;

            if (error) {
                console.error('Error saving note:', error);
                alert('Błąd zapisywania notatki');
                // Revert if error
                notesHistory.pop();
                return;
            }

            // Log note creation
            logAuditActivity('create', 'note', lead.id, lead.email, null, {
                content: noteContent,
                lead_status: lead.status
            });

            // Clear textarea and re-render history
            document.getElementById('field-notes').value = '';
            renderNotesHistory();

            // Also add to activity timeline
            activities.push({
                type: 'note',
                content: `Dodano notatkę: "${noteContent.substring(0, 50)}${noteContent.length > 50 ? '...' : ''}"`,
                created_at: new Date().toISOString(),
                performed_by: currentMember?.id || null,
                performed_by_name: currentMember?.name || null
            });
            renderActivities();
            autoSave(); // Save activities
        });

        // Quick note from info tab
        document.getElementById('quick-note-save-btn').addEventListener('click', async () => {
            const noteInput = document.getElementById('quick-note-input');
            const noteContent = noteInput.value.trim();
            if (!noteContent) return;

            const btn = document.getElementById('quick-note-save-btn');
            const originalHtml = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="ph ph-circle-notch animate-spin"></i>';

            // Create new note entry
            const newNote = {
                content: noteContent,
                created_at: new Date().toISOString(),
                performed_by: currentMember?.id || null,
                performed_by_name: currentMember?.name || null,
                lead_status: lead.status || 'new'
            };

            notesHistory.push(newNote);

            const { error } = await supabaseClient
                .from('leads')
                .update({ notes_history: notesHistory })
                .eq('id', lead.id);

            btn.innerHTML = originalHtml;
            btn.disabled = false;

            if (error) {
                console.error('Error saving quick note:', error);
                notesHistory.pop();
                return;
            }

            logAuditActivity('create', 'note', lead.id, lead.email, null, {
                content: noteContent,
                lead_status: lead.status
            });

            noteInput.value = '';
            renderNotesHistory();

            activities.push({
                type: 'note',
                content: `Dodano notatkę: "${noteContent.substring(0, 50)}${noteContent.length > 50 ? '...' : ''}"`,
                created_at: new Date().toISOString(),
                performed_by: currentMember?.id || null,
                performed_by_name: currentMember?.name || null
            });
            renderActivities();
            autoSave();
        });

        // Warn before leaving with unsaved changes
        window.addEventListener('beforeunload', (e) => {
            if (hasChanges) {
                e.preventDefault();
                e.returnValue = '';
            }
        });

        // Fix links for local development
        if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
            const base = getBasePath();
            document.querySelectorAll('a[data-page]').forEach(link => {
                link.href = base + '/' + link.dataset.page + '.html';
            });
        }

        // =============================================
        // MEETINGS / CALENDAR
        // =============================================
        async function loadMeetings() {
            const leadId = getLeadId();
            if (!leadId) return;

            const { data, error } = await supabaseClient
                .from('calendar_events')
                .select('*')
                .eq('lead_id', leadId)
                .order('start_time', { ascending: true });

            if (error) {
                console.error('Error loading meetings:', error);
                return;
            }

            meetings = data || [];
            renderMeetings();
        }

        function renderMeetings() {
            const container = document.getElementById('meetings-list');
            const empty = document.getElementById('meetings-empty');
            const countEl = document.getElementById('meetings-count');
            const now = new Date();

            // Filter to upcoming and recent meetings
            const relevantMeetings = meetings.filter(m => {
                const endTime = new Date(m.end_time);
                // Show meetings that end after 24 hours ago
                return endTime > new Date(now.getTime() - 24 * 60 * 60 * 1000);
            });

            countEl.textContent = relevantMeetings.length;

            if (relevantMeetings.length === 0) {
                container.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }

            empty.classList.add('hidden');

            container.innerHTML = relevantMeetings.map(meeting => {
                const startTime = new Date(meeting.start_time);
                const endTime = new Date(meeting.end_time);
                const isPast = endTime < now;
                const isToday = startTime.toDateString() === now.toDateString();
                const isTomorrow = startTime.toDateString() === new Date(now.getTime() + 24 * 60 * 60 * 1000).toDateString();

                let dateLabel;
                if (isToday) {
                    dateLabel = 'Dziś';
                } else if (isTomorrow) {
                    dateLabel = 'Jutro';
                } else {
                    dateLabel = startTime.toLocaleDateString('pl-PL', { day: 'numeric', month: 'short' });
                }

                const timeStr = startTime.toLocaleTimeString('pl-PL', { hour: '2-digit', minute: '2-digit' });

                return `
                    <div class="flex items-center gap-3 p-3 rounded-lg border ${isPast ? 'bg-zinc-900/30 border-white/5 opacity-60' : 'bg-pink-500/5 border-pink-500/20'} group">
                        <div class="w-10 h-10 rounded-lg ${isPast ? 'bg-zinc-800' : 'bg-pink-500/20'} flex flex-col items-center justify-center flex-shrink-0">
                            <span class="text-[10px] font-mono ${isPast ? 'text-zinc-500' : 'text-pink-400'}">${dateLabel}</span>
                            <span class="text-xs font-semibold ${isPast ? 'text-zinc-400' : 'text-white'}">${timeStr}</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="font-medium text-white text-sm truncate ${isPast ? 'line-through opacity-70' : ''}">${meeting.title}</div>
                            ${meeting.description ? `<div class="text-zinc-500 text-xs truncate">${meeting.description}</div>` : ''}
                        </div>
                        <button onclick="deleteMeeting('${meeting.id}')" class="p-1.5 text-zinc-500 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-all" title="Usuń">
                            <i class="ph ph-trash text-sm"></i>
                        </button>
                    </div>
                `;
            }).join('');
        }

        // Meeting modal functions
        function openMeetingModal() {
            const modal = document.getElementById('meeting-modal');
            const content = document.getElementById('meeting-modal-content');

            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('meeting-date').value = today;
            document.getElementById('meeting-title').value = '';
            document.getElementById('meeting-description').value = '';
            document.getElementById('meeting-time').value = '10:00';
            document.getElementById('meeting-duration').value = '60';

            modal.classList.remove('hidden');
            requestAnimationFrame(() => {
                content.classList.remove('scale-95', 'opacity-0');
                content.classList.add('scale-100', 'opacity-100');
            });

            document.getElementById('meeting-title').focus();
        }

        function closeMeetingModal() {
            const modal = document.getElementById('meeting-modal');
            const content = document.getElementById('meeting-modal-content');

            content.classList.remove('scale-100', 'opacity-100');
            content.classList.add('scale-95', 'opacity-0');

            setTimeout(() => {
                modal.classList.add('hidden');
            }, 200);
        }

        // Meeting modal event listeners
        document.getElementById('meeting-modal-backdrop').addEventListener('click', closeMeetingModal);
        document.getElementById('close-meeting-modal').addEventListener('click', closeMeetingModal);
        document.getElementById('cancel-meeting').addEventListener('click', closeMeetingModal);
        document.getElementById('add-meeting-btn').addEventListener('click', openMeetingModal);

        // Save meeting
        document.getElementById('meeting-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const title = document.getElementById('meeting-title').value.trim();
            const date = document.getElementById('meeting-date').value;
            const time = document.getElementById('meeting-time').value;
            const duration = parseInt(document.getElementById('meeting-duration').value);
            const description = document.getElementById('meeting-description').value.trim();

            if (!title || !date || !time) return;

            const startTime = new Date(`${date}T${time}`);
            const endTime = new Date(startTime.getTime() + duration * 60 * 1000);

            const btn = document.getElementById('save-meeting');
            btn.disabled = true;
            btn.innerHTML = '<i class="ph ph-circle-notch animate-spin"></i> Zapisywanie...';

            const { error } = await supabaseClient
                .from('calendar_events')
                .insert({
                    title: title,
                    description: description || null,
                    start_time: startTime.toISOString(),
                    end_time: endTime.toISOString(),
                    lead_id: lead.id,
                    assigned_to: currentMember?.id || null
                });

            btn.disabled = false;
            btn.innerHTML = '<i class="ph ph-calendar-plus"></i> Dodaj spotkanie';

            if (error) {
                console.error('Error creating meeting:', error);
                alert('Błąd tworzenia spotkania');
                return;
            }

            // Log meeting creation
            logAuditActivity('create', 'meeting', lead.id, lead.email, null, {
                title: title,
                date: date,
                time: time,
                duration: duration
            });

            closeMeetingModal();
            await loadMeetings();

            // Add activity about the meeting
            activities.push({
                type: 'meeting',
                content: `Zaplanowano spotkanie: ${title} (${startTime.toLocaleDateString('pl-PL')} ${time})`,
                created_at: new Date().toISOString(),
                performed_by: currentMember?.id || null,
                performed_by_name: currentMember?.name || null
            });
            renderActivities();
            autoSave();
        });

        async function deleteMeeting(meetingId) {
            if (!confirm('Czy na pewno chcesz usunąć to spotkanie?')) return;

            // Find meeting info for audit log
            const meetingToDelete = meetings.find(m => m.id === meetingId);

            const { error } = await supabaseClient
                .from('calendar_events')
                .delete()
                .eq('id', meetingId);

            if (error) {
                console.error('Error deleting meeting:', error);
                alert('Błąd usuwania spotkania');
                return;
            }

            // Log meeting deletion
            logAuditActivity('delete', 'meeting', lead.id, lead.email, {
                title: meetingToDelete?.title,
                meeting_id: meetingId
            }, null);

            await loadMeetings();
        }

        window.deleteMeeting = deleteMeeting;

        // Escape key for meeting modal
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !document.getElementById('meeting-modal').classList.contains('hidden')) {
                closeMeetingModal();
            }
        });

        // ============ CLIENT OFFER FUNCTIONS ============

        async function loadClientOffer() {
            if (!lead) return;

            const { data, error } = await supabaseClient
                .from('client_offers')
                .select('*')
                .eq('lead_id', lead.id)
                .order('created_at', { ascending: false })
                .limit(1)
                .single();

            if (data && !error) {
                clientOffer = data;
            } else {
                clientOffer = null;
            }

            updateClientOfferSection();
        }

        function updateClientOfferSection() {
            const section = document.getElementById('client-offer-section');
            const emptyState = document.getElementById('client-offer-empty');
            const existsState = document.getElementById('client-offer-exists');
            const offerId = document.getElementById('field-offer').value;

            // Show section only if offer is selected
            if (!offerId) {
                section.classList.add('hidden');
                return;
            }

            section.classList.remove('hidden');

            if (clientOffer) {
                // Show existing offer
                emptyState.classList.add('hidden');
                existsState.classList.remove('hidden');

                // Set URL (local dev uses query param, production uses path)
                const offerUrl = getClientOfferUrl(clientOffer.unique_token);
                document.getElementById('client-offer-url').value = offerUrl;

                // Set stats
                const validDate = new Date(clientOffer.valid_until);
                document.getElementById('client-offer-valid-display').textContent = validDate.toLocaleDateString('pl-PL');
                document.getElementById('client-offer-views').textContent = clientOffer.view_count || 0;
            } else {
                // Show empty state - form to generate
                emptyState.classList.remove('hidden');
                existsState.classList.add('hidden');

                // Set default validity date (5 days from now)
                const defaultDate = new Date();
                defaultDate.setDate(defaultDate.getDate() + 5);
                document.getElementById('client-offer-valid-until').value = defaultDate.toISOString().split('T')[0];
            }
        }

        function generateToken() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let token = '';
            for (let i = 0; i < 32; i++) {
                token += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return token;
        }

        // Schedule offer flow emails (3 emails - first one is sent immediately)
        async function scheduleOfferEmails(lead, clientOffer, validUntil, selectedOffer, offerUrl) {
            // Check if lead has already purchased (skip entire email flow)
            const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString();
            const { data: paidOrder } = await supabaseClient
                .from('orders')
                .select('id')
                .eq('customer_email', lead.email)
                .eq('status', 'paid')
                .gte('created_at', sevenDaysAgo)
                .limit(1)
                .single();

            if (paidOrder) {
                console.log('Lead has already purchased - skipping email flow:', lead.email);
                return; // Don't send any emails
            }

            const now = new Date();
            const validUntilDate = new Date(validUntil + 'T23:59:59');

            // Calculate halfway point between now and expiration
            const halfwayTime = new Date(now.getTime() + (validUntilDate.getTime() - now.getTime()) / 2);

            // 1. Send first email (offer_created) immediately
            try {
                await sendEmail('offer_created', {
                    email: lead.email,
                    clientName: lead.name || lead.company || 'Cześć',
                    offerName: selectedOffer.name,
                    offerPrice: selectedOffer.price,
                    validUntil: validUntil,
                    offerUrl: offerUrl
                });
                console.log('Sent offer_created email immediately to:', lead.email);
            } catch (emailErr) {
                console.error('Error sending offer_created email:', emailErr);
            }

            // 2. Schedule reminder email at halfway point
            const emailRecords = [{
                lead_id: lead.id,
                client_offer_id: clientOffer.id,
                email_type: 'offer_reminder_halfway',
                scheduled_for: halfwayTime.toISOString(),
                metadata: { offer_id: lead.offer_id }
            }];

            const { error } = await supabaseClient.from('scheduled_emails').insert(emailRecords);
            if (error) {
                console.error('Error scheduling emails:', error);
            } else {
                console.log('Scheduled reminder email for lead:', lead.email);
            }
        }

        async function generateClientOffer() {
            if (!lead || !currentMember) return;

            const offerId = document.getElementById('field-offer').value;
            if (!offerId) {
                alert('Najpierw wybierz ofertę');
                return;
            }

            const validUntil = document.getElementById('client-offer-valid-until').value;
            if (!validUntil) {
                alert('Podaj datę ważności oferty');
                return;
            }

            // Get selected offer type
            const offerType = document.querySelector('input[name="offer-type"]:checked')?.value || 'starter';

            // Get custom price (optional)
            const customPriceInput = document.getElementById('client-offer-custom-price').value;
            const customPrice = customPriceInput ? parseFloat(customPriceInput) : null;

            const token = generateToken();

            const btn = document.getElementById('generate-client-offer-btn');
            btn.disabled = true;
            btn.innerHTML = '<i class="ph ph-spinner animate-spin"></i>';

            const insertData = {
                lead_id: lead.id,
                offer_id: offerId,
                unique_token: token,
                valid_until: validUntil,
                created_by: currentMember.id,
                offer_type: offerType
            };

            // Add custom_price only if provided
            if (customPrice !== null && customPrice > 0) {
                insertData.custom_price = customPrice;
            }

            const { data, error } = await supabaseClient
                .from('client_offers')
                .insert([insertData])
                .select()
                .single();

            btn.disabled = false;
            btn.innerHTML = '<i class="ph ph-magic-wand"></i> Wygeneruj link';

            if (error) {
                console.error('Error generating offer:', error);
                alert('Błąd podczas generowania oferty');
                return;
            }

            clientOffer = data;
            updateClientOfferSection();

            // Log to audit
            logAuditActivity('create', 'client_offer', data.id, lead.email, null, {
                offer_id: offerId,
                valid_until: validUntil,
                token: token
            });

            // Send first email immediately + schedule follow-up emails
            const selectedOffer = offers.find(o => o.id === offerId);
            console.log('Offer flow check:', { email: lead.email, selectedOffer: selectedOffer?.name, offerId, offerType });
            if (lead.email && selectedOffer) {
                const offerUrl = getClientOfferUrl(token, offerType);
                await scheduleOfferEmails(lead, data, validUntil, selectedOffer, offerUrl);
            } else {
                console.warn('Skipped email flow - missing email or offer:', { email: lead.email, offerId });
            }
        }

        function copyOfferUrl() {
            const urlInput = document.getElementById('client-offer-url');
            urlInput.select();
            document.execCommand('copy');

            // Show feedback
            const btn = urlInput.nextElementSibling;
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<i class="ph ph-check text-emerald-400"></i>';
            setTimeout(() => {
                btn.innerHTML = originalHtml;
            }, 1500);
        }

        function getClientOfferUrl(token, offerType = null) {
            const baseUrl = window.location.origin;
            const isLocal = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
            const type = offerType || clientOffer?.offer_type || 'full';

            // Starter offers use different page
            if (type === 'starter') {
                if (isLocal) {
                    const base = getBasePath();
                    return `${baseUrl}${base}/offer-starter.html?token=${token}`;
                }
                return `${baseUrl}/offer-starter?token=${token}`;
            }

            // Full offers use existing page
            if (isLocal) {
                const base = getBasePath();
                return `${baseUrl}${base}/client-offer.html?token=${token}`;
            }
            return `${baseUrl}/p/${token}`;
        }

        function openOfferPreview() {
            if (!clientOffer) return;
            window.open(getClientOfferUrl(clientOffer.unique_token), '_blank');
        }

        async function downloadProformaFromCRM() {
            const btn = event.target.closest('button');
            const originalHtml = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="ph ph-circle-notch animate-spin"></i>';

            try {
                // Pobierz wybraną ofertę
                const offerId = document.getElementById('field-offer').value;
                const selectedOffer = offers.find(o => o.id === offerId);
                if (!selectedOffer) {
                    throw new Error('Nie wybrano oferty.');
                }

                // Przygotuj dane dla Edge Function
                const addressParts = parseAddress(lead.address);
                const today = new Date().toISOString().split('T')[0];

                const requestData = {
                    buyer: {
                        name: lead.name,
                        company: lead.company,
                        email: lead.email,
                        nip: lead.nip || '',
                        street: addressParts.street,
                        postCode: addressParts.postCode,
                        city: addressParts.city
                    },
                    offer: {
                        name: selectedOffer.name,
                        description: selectedOffer.description,
                        price: selectedOffer.price
                    },
                    validUntil: clientOffer ? clientOffer.valid_until : today
                };

                // Wywołaj Edge Function
                const response = await fetch(`${SUPABASE_URL}/functions/v1/fakturownia-proforma`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify(requestData)
                });

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'Błąd generowania proformy');
                }

                // Otwórz PDF
                window.open(result.pdfUrl, '_blank');

                // Loguj aktywność - proforma wygenerowana przez handlowca
                logAuditActivity('create', 'proforma', lead.id, lead.email, null, {
                    offer_name: selectedOffer.name,
                    offer_price: selectedOffer.price,
                    invoice_id: result.invoiceId,
                    generated_by: 'salesperson'
                });

                // Dodaj do historii aktywności leada
                await supabaseClient.from('lead_activities').insert([{
                    lead_id: lead.id,
                    type: 'proforma',
                    description: `Wygenerowano proformę przez handlowca (${currentMember?.name || 'Nieznany'})`,
                    metadata: {
                        offer_name: selectedOffer.name,
                        offer_price: selectedOffer.price,
                        invoice_id: result.invoiceId,
                        generated_by: 'salesperson',
                        generated_by_name: currentMember?.name
                    }
                }]);

                // Odśwież historię aktywności
                loadActivities();

                // Send Slack notification about proforma generation
                sendSlackNotification('proforma_generated', {
                    lead_name: lead.name,
                    lead_email: lead.email,
                    lead_company: lead.company,
                    lead_id: lead.id,
                    offer_name: selectedOffer.name,
                    offer_price: selectedOffer.price,
                    generated_by: 'salesperson',
                    salesperson_name: currentMember?.name
                });

                // Send proforma email to client
                sendEmail('proforma_generated', {
                    email: lead.email,
                    clientName: lead.name,
                    offerName: selectedOffer.name,
                    offerPrice: selectedOffer.price,
                    pdfUrl: result.pdfUrl,
                    checkoutUrl: `https://crm.tomekniedzwiecki.pl/checkout?offer=${selectedOffer.id}`
                });

            } catch (error) {
                console.error('Proforma error:', error);
                alert('Błąd: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        }

        function parseAddress(address) {
            if (!address) return { street: '', postCode: '', city: '' };
            const match = address.match(/^(.+?),?\s*(\d{2}-\d{3})\s+(.+)$/);
            if (match) return { street: match[1].trim(), postCode: match[2], city: match[3].trim() };
            return { street: address, postCode: '', city: '' };
        }

        async function deleteClientOffer() {
            if (!clientOffer) return;

            showConfirmModal({
                title: 'Usuń ofertę',
                message: 'Czy na pewno chcesz usunąć wygenerowaną ofertę? Link przestanie działać.',
                theme: 'lost',
                onConfirm: async () => {
                    const { error } = await supabaseClient
                        .from('client_offers')
                        .delete()
                        .eq('id', clientOffer.id);

                    if (error) {
                        console.error('Error deleting offer:', error);
                        alert('Błąd podczas usuwania oferty');
                        return;
                    }

                    // Log to audit
                    logAuditActivity('delete', 'client_offer', clientOffer.id, lead.email, {
                        token: clientOffer.unique_token,
                        valid_until: clientOffer.valid_until
                    }, null);

                    clientOffer = null;
                    updateClientOfferSection();
                }
            });
        }

        // ============ CUSTOM PAYMENT LINK FUNCTIONS ============

        function generateCustomPaymentLink() {
            const amountInput = document.getElementById('custom-payment-amount');
            const descriptionInput = document.getElementById('custom-payment-description');

            const amount = parseFloat(amountInput.value);
            const description = descriptionInput.value.trim();

            // Validate
            if (!amount || amount <= 0) {
                amountInput.classList.add('shake');
                amountInput.style.borderColor = '#ef4444';
                setTimeout(() => {
                    amountInput.classList.remove('shake');
                    amountInput.style.borderColor = '';
                }, 500);
                return;
            }

            if (!description) {
                descriptionInput.classList.add('shake');
                descriptionInput.style.borderColor = '#ef4444';
                setTimeout(() => {
                    descriptionInput.classList.remove('shake');
                    descriptionInput.style.borderColor = '';
                }, 500);
                return;
            }

            // Generate URL
            const baseUrl = location.origin;
            const isLocal = location.hostname === 'localhost';
            const checkoutPath = isLocal ? '/checkout/index.html' : '/checkout';

            const params = new URLSearchParams({
                amount: amount.toFixed(2),
                description: description,
                lead_id: lead?.id || ''
            });

            const paymentUrl = `${baseUrl}${checkoutPath}?${params.toString()}`;

            // Update UI
            document.getElementById('custom-payment-url').value = paymentUrl;
            document.getElementById('custom-payment-amount-display').textContent = formatPrice(amount);
            document.getElementById('custom-payment-description-display').textContent = description;

            document.getElementById('custom-payment-form').classList.add('hidden');
            document.getElementById('custom-payment-result').classList.remove('hidden');

            // Log activity
            if (lead?.email) {
                logAuditActivity('create', 'custom_payment_link', null, lead.email, null, {
                    amount: amount,
                    description: description,
                    url: paymentUrl
                });
            }

            console.log('[custom-payment] Generated link:', paymentUrl);
        }

        function copyCustomPaymentUrl() {
            const urlInput = document.getElementById('custom-payment-url');
            urlInput.select();
            document.execCommand('copy');

            // Show feedback
            const btn = urlInput.nextElementSibling;
            const icon = btn.querySelector('i');
            icon.classList.remove('ph-copy');
            icon.classList.add('ph-check');
            icon.classList.add('text-emerald-400');

            setTimeout(() => {
                icon.classList.remove('ph-check', 'text-emerald-400');
                icon.classList.add('ph-copy');
            }, 2000);
        }

        function openCustomPaymentUrl() {
            const url = document.getElementById('custom-payment-url').value;
            if (url) {
                window.open(url, '_blank');
            }
        }

        function resetCustomPaymentForm() {
            document.getElementById('custom-payment-amount').value = '';
            document.getElementById('custom-payment-description').value = '';
            document.getElementById('custom-payment-form').classList.remove('hidden');
            document.getElementById('custom-payment-result').classList.add('hidden');
        }

        // Event listener for generate button
        document.getElementById('generate-custom-payment-btn')?.addEventListener('click', generateCustomPaymentLink);

        // View History Functions
        function toggleViewHistory() {
            const dropdown = document.getElementById('view-history-dropdown');
            const isHidden = dropdown.classList.contains('hidden');

            if (isHidden) {
                renderViewHistory();
                dropdown.classList.remove('hidden');

                // Close on outside click
                setTimeout(() => {
                    document.addEventListener('click', closeViewHistoryOnOutsideClick);
                }, 0);
            } else {
                dropdown.classList.add('hidden');
                document.removeEventListener('click', closeViewHistoryOnOutsideClick);
            }
        }

        function closeViewHistoryOnOutsideClick(e) {
            const dropdown = document.getElementById('view-history-dropdown');
            const button = e.target.closest('button[onclick="toggleViewHistory()"]');

            if (!dropdown.contains(e.target) && !button) {
                dropdown.classList.add('hidden');
                document.removeEventListener('click', closeViewHistoryOnOutsideClick);
            }
        }

        function renderViewHistory() {
            const container = document.getElementById('view-history-list');
            if (!clientOffer) {
                container.innerHTML = '<p class="text-zinc-500 text-xs p-3">Brak danych</p>';
                return;
            }

            const history = clientOffer.view_history || [];

            if (history.length === 0) {
                container.innerHTML = '<p class="text-zinc-500 text-xs p-3 text-center">Brak wyświetleń</p>';
                return;
            }

            // Sort by date descending (newest first)
            const sorted = [...history].sort((a, b) => new Date(b) - new Date(a));

            container.innerHTML = sorted.map((timestamp, index) => {
                const date = new Date(timestamp);
                const formattedDate = date.toLocaleDateString('pl-PL', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
                const formattedTime = date.toLocaleTimeString('pl-PL', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });

                return `
                    <div class="flex items-center justify-between px-3 py-2 hover:bg-white/5 border-b border-white/5 last:border-b-0">
                        <div class="flex items-center gap-2">
                            <span class="text-zinc-500 text-[10px] font-mono w-4">${sorted.length - index}</span>
                            <i class="ph ph-eye text-cyan-400/60 text-xs"></i>
                        </div>
                        <div class="text-right">
                            <div class="text-zinc-200 text-xs font-medium">${formattedDate}</div>
                            <div class="text-zinc-500 text-[10px] font-mono">${formattedTime}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Offer type selection toggle
        document.querySelectorAll('.offer-type-option').forEach(option => {
            option.addEventListener('click', () => {
                document.querySelectorAll('.offer-type-option').forEach(o => o.classList.remove('selected'));
                option.classList.add('selected');
                option.querySelector('input').checked = true;
            });
        });

        // Generate button click handler
        document.getElementById('generate-client-offer-btn').addEventListener('click', generateClientOffer);

        // ============ TAB NAVIGATION ============

        let currentEmailFilter = 'all';
        let allEmails = [];

        function switchTab(tabName) {
            // Update buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                if (btn.dataset.tab === tabName) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            // Update content
            document.querySelectorAll('.tab-content').forEach(content => {
                if (content.id === `tab-${tabName}`) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });

            // Load email data when switching to email tab
            if (tabName === 'email' && allEmails.length === 0) {
                loadEmailHistoryFull();
            }
        }

        // ============ FULL EMAIL HISTORY (EMAIL TAB) ============

        async function loadEmailHistoryFull() {
            const container = document.getElementById('email-history-full');
            const countEl = document.getElementById('email-history-count');
            const tabCountEl = document.getElementById('email-tab-count');
            const sentStat = document.getElementById('email-stat-sent');
            const receivedStat = document.getElementById('email-stat-received');

            if (!lead?.id) {
                container.innerHTML = '<div class="text-center text-zinc-600 text-xs py-8">Brak emaili</div>';
                return;
            }

            // Show loading
            container.innerHTML = `
                <div class="text-center text-zinc-600 text-xs py-8">
                    <i class="ph ph-circle-notch animate-spin text-xl"></i>
                    <p class="mt-2">Ładowanie...</p>
                </div>
            `;

            // Load emails for this lead - by lead_id OR by email address
            // This catches both linked emails and outreach emails sent to this address
            const leadEmail = lead?.email?.toLowerCase();

            let query = supabaseClient
                .from('email_messages')
                .select('*')
                .order('created_at', { ascending: false })
                .limit(100);

            // Query by lead_id OR by email address (to/from)
            if (leadEmail) {
                query = query.or(`lead_id.eq.${lead.id},to_email.ilike.${leadEmail},from_email.ilike.${leadEmail}`);
            } else {
                query = query.eq('lead_id', lead.id);
            }

            const { data: emails, error } = await query;

            if (error) {
                console.error('Error loading emails:', error);
                container.innerHTML = '<div class="text-center text-red-400 text-xs py-8">Błąd ładowania emaili</div>';
                return;
            }

            allEmails = emails || [];

            // Update counts
            const totalCount = allEmails.length;
            const sentCount = allEmails.filter(e => e.direction === 'outbound').length;
            const receivedCount = allEmails.filter(e => e.direction === 'inbound').length;

            countEl.textContent = totalCount;
            tabCountEl.textContent = totalCount;
            sentStat.textContent = sentCount;
            receivedStat.textContent = receivedCount;

            // Render emails
            renderEmailList(allEmails);
        }

        function renderEmailList(emails) {
            const container = document.getElementById('email-history-full');

            if (!emails || emails.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-zinc-600 text-xs py-8">
                        <i class="ph ph-envelope-open text-3xl mb-2 opacity-50"></i>
                        <p>Brak historii emaili</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = emails.map(email => {
                const isInbound = email.direction === 'inbound';
                const dateStr = new Date(email.created_at).toLocaleString('pl-PL', {
                    day: 'numeric',
                    month: 'short',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const directionIcon = isInbound
                    ? '<i class="ph ph-arrow-down text-blue-400"></i>'
                    : '<i class="ph ph-arrow-up text-emerald-400"></i>';

                const directionLabel = isInbound ? 'Otrzymano' : 'Wysłano';
                const bgClass = isInbound ? 'border-blue-500/20 hover:border-blue-500/40' : 'border-emerald-500/20 hover:border-emerald-500/40';
                const labelClass = isInbound ? 'bg-blue-500/20 text-blue-400' : 'bg-emerald-500/20 text-emerald-400';

                // Truncate body preview
                const bodyPreview = (email.body_text || '').substring(0, 120).replace(/\n/g, ' ') + ((email.body_text?.length > 120) ? '...' : '');

                return `
                    <div class="p-4 bg-zinc-950/50 rounded-lg border ${bgClass} cursor-pointer transition-colors" onclick="showEmailDetail('${email.id}')">
                        <div class="flex items-start gap-3">
                            <div class="mt-1">${directionIcon}</div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="px-2 py-0.5 rounded text-[10px] font-medium ${labelClass}">${directionLabel}</span>
                                    <span class="text-[10px] text-zinc-600 font-mono">${dateStr}</span>
                                </div>
                                <div class="text-sm text-white font-medium mb-1">${email.subject || '(bez tematu)'}</div>
                                <div class="text-xs text-zinc-500 mb-2">
                                    ${isInbound ? 'Od: ' + (email.from_name || email.from_email) : 'Do: ' + email.to_email}
                                </div>
                                ${bodyPreview ? `<div class="text-xs text-zinc-600 line-clamp-2">${bodyPreview}</div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterEmails(filter) {
            currentEmailFilter = filter;

            // Update button styles
            document.querySelectorAll('.email-filter-btn').forEach(btn => {
                if (btn.dataset.filter === filter) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            // Filter and render
            let filteredEmails = allEmails;
            if (filter === 'inbound') {
                filteredEmails = allEmails.filter(e => e.direction === 'inbound');
            } else if (filter === 'outbound') {
                filteredEmails = allEmails.filter(e => e.direction === 'outbound');
            }

            renderEmailList(filteredEmails);
        }

        // ============ SEND EMAIL ============

        async function sendEmailToLead() {
            if (!lead || !lead.email) {
                alert('Brak adresu email leada');
                return;
            }

            const subject = document.getElementById('compose-subject').value.trim();
            const body = document.getElementById('compose-body').value.trim();

            if (!subject || !body) {
                alert('Podaj temat i treść wiadomości');
                return;
            }

            const btn = document.getElementById('send-email-btn');
            const originalHtml = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="ph ph-circle-notch animate-spin"></i> Wysyłanie...';

            try {
                // Send via Resend API through Edge Function
                const response = await fetch(`${SUPABASE_URL}/functions/v1/send-email`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify({
                        to: lead.email,
                        subject: subject,
                        html: body.replace(/\n/g, '<br>'),
                        lead_id: lead.id,
                        sender_id: currentMember?.id,
                        sender_name: currentMember?.name || 'Tomek Niedzwiecki'
                    })
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Błąd wysyłania');
                }

                // Clear form
                document.getElementById('compose-subject').value = '';
                document.getElementById('compose-body').value = '';

                // Reload emails
                await loadEmailHistoryFull();
                await loadEmailHistory(); // Also update sidebar

                // Log to audit
                logAuditActivity('create', 'email', lead.id, lead.email, null, {
                    subject: subject,
                    to: lead.email
                });

                // Show success
                btn.innerHTML = '<i class="ph ph-check"></i> Wysłano!';
                btn.className = btn.className.replace('bg-purple-600', 'bg-emerald-600').replace('hover:bg-purple-500', 'hover:bg-emerald-500');
                setTimeout(() => {
                    btn.innerHTML = originalHtml;
                    btn.className = btn.className.replace('bg-emerald-600', 'bg-purple-600').replace('hover:bg-emerald-500', 'hover:bg-purple-500');
                    btn.disabled = false;
                }, 2000);

            } catch (error) {
                console.error('Email send error:', error);
                alert('Błąd wysyłania: ' + error.message);
                btn.innerHTML = originalHtml;
                btn.disabled = false;
            }
        }

        // Make functions global
        window.switchTab = switchTab;
        window.filterEmails = filterEmails;
        window.sendEmailToLead = sendEmailToLead;

        // ============ PURCHASE HISTORY ============

        let historicalLTV = null;
        let crmOrders = [];

        async function loadPurchaseHistory() {
            if (!lead?.email) return;

            await Promise.all([
                loadHistoricalLTV(),
                loadCrmOrders()
            ]);

            updatePurchaseHistorySection();
        }

        async function loadHistoricalLTV() {
            if (!lead?.email) return;

            const { data, error } = await supabaseClient
                .from('outreach_contacts')
                .select('*')
                .ilike('email', lead.email)
                .limit(1)
                .single();

            if (!error && data) {
                historicalLTV = data;
            }
        }

        async function loadCrmOrders() {
            if (!lead) return;

            // Query by lead_id OR by email
            let query = supabaseClient
                .from('orders')
                .select('*')
                .order('created_at', { ascending: false });

            if (lead.email) {
                query = query.or(`lead_id.eq.${lead.id},customer_email.ilike.${lead.email.toLowerCase()}`);
            } else {
                query = query.eq('lead_id', lead.id);
            }

            const { data, error } = await query;

            if (!error && data) {
                crmOrders = data;
            }
        }

        function updatePurchaseHistorySection() {
            const section = document.getElementById('purchase-history-section');
            const totalBadge = document.getElementById('purchase-total-badge');
            const ltvSection = document.getElementById('historical-ltv-section');
            const ordersSection = document.getElementById('crm-orders-section');
            const ordersList = document.getElementById('crm-orders-list');
            const ordersCount = document.getElementById('crm-orders-count');

            // Calculate totals
            let totalLTV = historicalLTV?.ltv_pln || 0;
            let ordersTotal = crmOrders.filter(o => o.status === 'paid').reduce((sum, o) => sum + parseFloat(o.amount || 0), 0);
            let grandTotal = totalLTV + ordersTotal;

            // Show section only if there's any data
            if (!historicalLTV && crmOrders.length === 0) {
                section.classList.add('hidden');
                return;
            }

            section.classList.remove('hidden');
            totalBadge.textContent = new Intl.NumberFormat('pl-PL', { style: 'currency', currency: 'PLN', minimumFractionDigits: 0 }).format(grandTotal);

            // Historical LTV
            if (historicalLTV) {
                ltvSection.classList.remove('hidden');

                document.getElementById('ltv-value').textContent = new Intl.NumberFormat('pl-PL', { style: 'currency', currency: 'PLN', minimumFractionDigits: 0 }).format(historicalLTV.ltv_pln || 0);
                document.getElementById('ltv-transactions').textContent = historicalLTV.transaction_count || 0;

                const formatDate = (dateStr) => {
                    if (!dateStr) return '-';
                    return new Date(dateStr).toLocaleDateString('pl-PL', { year: 'numeric', month: 'short', day: 'numeric' });
                };

                document.getElementById('ltv-first').textContent = formatDate(historicalLTV.first_purchase);
                document.getElementById('ltv-last').textContent = formatDate(historicalLTV.last_purchase);

                // Products
                const products = historicalLTV.products || [];
                document.getElementById('ltv-products').textContent = products.length > 0
                    ? products.slice(0, 5).join(', ') + (products.length > 5 ? ` (+${products.length - 5} więcej)` : '')
                    : '-';
            } else {
                ltvSection.classList.add('hidden');
            }

            // CRM Orders
            ordersCount.textContent = crmOrders.length;

            if (crmOrders.length === 0) {
                ordersList.innerHTML = '<div class="text-center text-zinc-600 text-xs py-4">Brak zamówień w systemie</div>';
            } else {
                const statusColors = {
                    pending: { bg: 'bg-yellow-500/10', text: 'text-yellow-400', border: 'border-yellow-500/20', label: 'Oczekujące' },
                    paid: { bg: 'bg-green-500/10', text: 'text-green-400', border: 'border-green-500/20', label: 'Opłacone' },
                    cancelled: { bg: 'bg-red-500/10', text: 'text-red-400', border: 'border-red-500/20', label: 'Anulowane' }
                };

                ordersList.innerHTML = crmOrders.map(order => {
                    const status = statusColors[order.status] || statusColors.pending;
                    const amount = new Intl.NumberFormat('pl-PL', { style: 'currency', currency: 'PLN', minimumFractionDigits: 0 }).format(order.amount || 0);
                    const date = new Date(order.created_at).toLocaleDateString('pl-PL', { day: 'numeric', month: 'short', year: 'numeric' });

                    return `
                        <div class="p-3 bg-zinc-900/60 rounded-lg border border-white/5 flex items-center justify-between">
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-white text-sm font-medium">${order.order_number}</span>
                                    <span class="${status.bg} ${status.text} ${status.border} border text-[9px] px-1.5 py-0.5 rounded font-medium">${status.label}</span>
                                </div>
                                <div class="text-zinc-500 text-xs truncate">${order.description || '-'}</div>
                                <div class="text-zinc-600 text-[10px] font-mono mt-1">${date}</div>
                            </div>
                            <div class="text-right flex-shrink-0 ml-3">
                                <div class="${order.status === 'paid' ? 'text-green-400' : 'text-zinc-400'} font-bold">${amount}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        // Lead navigation (prev/next) - within same status
        async function setupLeadNavigation() {
            const currentId = getLeadId();
            if (!currentId || !lead) return;

            const currentStatus = lead.status || 'new';
            const basePath = (location.hostname === 'localhost' || location.hostname === '127.0.0.1')
                ? `${getBasePath()}/lead.html`
                : '/lead';

            // Get all leads with same status, sorted by date in status (oldest first)
            const { data: statusLeads } = await supabaseClient
                .from('leads')
                .select('id, created_at, activities')
                .eq('status', currentStatus)
                .order('created_at', { ascending: true });

            if (!statusLeads || statusLeads.length === 0) return;

            // Sort by date when entered current status (using activities)
            const leadsWithStatusDate = statusLeads.map(l => {
                const activities = l.activities || [];
                const statusChanges = activities
                    .filter(a => a.type === 'status_change')
                    .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                const statusDate = statusChanges.length > 0
                    ? new Date(statusChanges[0].created_at)
                    : new Date(l.created_at);
                return { ...l, statusDate };
            }).sort((a, b) => a.statusDate - b.statusDate); // oldest first

            // Find current lead position
            const currentIndex = leadsWithStatusDate.findIndex(l => l.id === currentId);
            if (currentIndex === -1) return;

            const prevLead = currentIndex > 0 ? leadsWithStatusDate[currentIndex - 1] : null;
            const nextLead = currentIndex < leadsWithStatusDate.length - 1 ? leadsWithStatusDate[currentIndex + 1] : null;

            const prevBtn = document.getElementById('prev-lead-btn');
            const nextBtn = document.getElementById('next-lead-btn');

            // Show status badge with position and color
            const statusBadge = document.getElementById('nav-status-badge');
            const statusIcon = document.getElementById('nav-status-icon');
            const statusLabel = document.getElementById('nav-status-label');
            const statusPosition = document.getElementById('nav-status-position');
            const statusTotal = document.getElementById('nav-status-total');

            // Determine color and icon based on status
            let colorClass = 'text-zinc-400';
            let iconClass = 'ph-circle';

            if (currentStatus === 'won') {
                colorClass = 'text-green-400';
                iconClass = 'ph-trophy';
            } else if (currentStatus === 'lost') {
                colorClass = 'text-red-400';
                iconClass = 'ph-x-circle';
            } else if (currentStatus === 'abandoned') {
                colorClass = 'text-zinc-500';
                iconClass = 'ph-prohibit';
            } else {
                // Regular pipeline stage - get color by index
                const stageIndex = pipelineStages.findIndex(s => s.id === currentStatus);
                if (stageIndex !== -1) {
                    const colors = ['text-emerald-400', 'text-blue-400', 'text-violet-400', 'text-amber-400', 'text-orange-400', 'text-cyan-400', 'text-pink-400'];
                    const icons = ['ph-user-plus', 'ph-chat-circle', 'ph-check-circle', 'ph-file-text', 'ph-handshake', 'ph-star', 'ph-flag'];
                    colorClass = colors[stageIndex % colors.length];
                    iconClass = icons[stageIndex % icons.length];
                }
            }

            statusBadge.classList.remove('hidden');
            statusIcon.className = `ph ${iconClass} text-xs ${colorClass}`;
            statusLabel.className = `text-[11px] font-medium ${colorClass}`;
            statusLabel.textContent = STATUS_LABELS[currentStatus] || currentStatus;
            statusPosition.textContent = currentIndex + 1;
            statusTotal.textContent = leadsWithStatusDate.length;

            if (prevLead) {
                prevBtn.disabled = false;
                prevBtn.onclick = () => { window.location.href = `${basePath}?id=${prevLead.id}`; };
            }

            if (nextLead) {
                nextBtn.disabled = false;
                nextBtn.onclick = () => { window.location.href = `${basePath}?id=${nextLead.id}`; };
            }

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) return;
                if (e.key === 'ArrowLeft' && prevLead) {
                    window.location.href = `${basePath}?id=${prevLead.id}`;
                } else if (e.key === 'ArrowRight' && nextLead) {
                    window.location.href = `${basePath}?id=${nextLead.id}`;
                }
            });
        }

        async function init() {
            const session = await checkAuth();
            if (session) {
                await loadPipelineSettings();
                await loadLead();
                await loadClientOffer();
                await loadMeetings();
                // Reload activities after clientOffer is loaded to include offer views
                await loadActivities();
                // Load purchase history (historical LTV + CRM orders)
                await loadPurchaseHistory();
                // Setup lead navigation after lead is loaded
                await setupLeadNavigation();
            }
        }
        init();

        // Register service worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').catch(() => {});
        }
    </script>
</body>
</html>
