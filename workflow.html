<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TN CRM - Projekt</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#050505">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bcryptjs/2.4.3/bcrypt.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="components/sidebar.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    }
                }
            }
        }
    </script>
    <style>
        body { background: #050505; color: #e5e5e5; }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        ::selection { background: white; color: black; }

        @media (max-width: 768px) {
            aside { display: none !important; }
            .mobile-back-btn { display: flex !important; }
        }
        @media (min-width: 769px) {
            .mobile-back-btn { display: none !important; }
        }

        .glass-header {
            background: rgba(5, 5, 5, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-enter { animation: fadeIn 0.4s ease-out forwards; }

        .progress-bar {
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
            transition: width 0.5s ease;
        }

        .milestone-card {
            transition: all 0.2s;
        }
        .milestone-card:hover {
            border-color: rgba(255,255,255,0.15);
        }
        .milestone-card.active {
            border-color: rgba(139, 92, 246, 0.5);
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.1);
        }
        .milestone-card.completed {
            border-color: rgba(34, 197, 94, 0.3);
        }

        .task-row {
            transition: all 0.15s;
        }
        .task-row:hover {
            background: rgba(255,255,255,0.02);
        }

        .task-checkbox {
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .task-checkbox:hover {
            border-color: rgba(255,255,255,0.4);
        }
        .task-checkbox.checked {
            background: #10b981;
            border-color: #10b981;
        }

        .responsible-badge {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 500;
            text-transform: uppercase;
        }
        .responsible-team { background: rgba(139, 92, 246, 0.2); color: #a78bfa; }
        .responsible-client { background: rgba(6, 182, 212, 0.2); color: #22d3ee; }
        .responsible-shared { background: rgba(245, 158, 11, 0.2); color: #fbbf24; }

        .input-field {
            background: #0a0a0a;
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.2s;
        }
        .input-field:focus {
            border-color: rgba(255,255,255,0.25);
            outline: none;
        }
    </style>
</head>
<body class="h-screen flex overflow-hidden font-sans text-sm tracking-tight antialiased">

    <!-- Sidebar -->
    <aside id="sidebar" class="w-[280px] bg-zinc-950 border-r border-white/5 flex flex-col flex-shrink-0"></aside>

    <!-- Main -->
    <main class="flex-1 flex flex-col bg-black relative min-w-0">
        <!-- Header -->
        <header class="h-16 glass-header flex items-center justify-between px-4 md:px-6 sticky top-0 z-30">
            <div class="flex items-center gap-3">
                <a href="/workflows" data-page="workflows" class="mobile-back-btn hidden items-center justify-center w-9 h-9 rounded-lg hover:bg-white/5 text-zinc-400 hover:text-white transition-colors">
                    <i class="ph ph-arrow-left text-xl"></i>
                </a>
                <div class="flex items-center gap-2 text-zinc-500">
                    <a href="/workflows" data-page="workflows" class="text-zinc-400 hover:text-white transition-colors hidden sm:inline">projekty</a>
                    <span class="text-zinc-700 hidden sm:inline">/</span>
                    <span id="breadcrumb-name" class="text-white font-medium truncate max-w-[200px]">...</span>
                </div>
            </div>
            <div class="flex items-center gap-2 md:gap-3">
                <button id="copy-link-btn" class="text-cyan-400 hover:text-cyan-300 border border-cyan-500/30 hover:border-cyan-500/50 px-3 py-2 rounded-lg text-xs font-medium transition-all flex items-center gap-2">
                    <i class="ph ph-link"></i>
                    <span class="hidden md:inline">Link klienta</span>
                </button>
                <div class="relative">
                    <button id="actions-btn" class="text-zinc-400 hover:text-white border border-zinc-700 hover:border-zinc-600 px-3 py-2 rounded-lg text-xs font-medium transition-all flex items-center gap-2">
                        <i class="ph ph-dots-three"></i>
                        <span class="hidden md:inline">Akcje</span>
                    </button>
                    <div id="actions-menu" class="hidden absolute right-0 top-full mt-2 bg-zinc-900 border border-white/10 rounded-lg shadow-xl py-1 min-w-[180px] z-50">
                        <button onclick="openPasswordModal()" class="w-full text-left px-4 py-2.5 hover:bg-white/5 text-zinc-300 flex items-center gap-2">
                            <i class="ph ph-key"></i>
                            Ustaw haslo klienta
                        </button>
                        <button onclick="changeStatus('paused')" class="w-full text-left px-4 py-2.5 hover:bg-white/5 text-amber-400 flex items-center gap-2">
                            <i class="ph ph-pause"></i>
                            Wstrzymaj projekt
                        </button>
                        <button onclick="changeStatus('completed')" class="w-full text-left px-4 py-2.5 hover:bg-white/5 text-blue-400 flex items-center gap-2">
                            <i class="ph ph-check-circle"></i>
                            Oznacz jako ukonczony
                        </button>
                        <hr class="border-white/5 my-1">
                        <button onclick="changeStatus('cancelled')" class="w-full text-left px-4 py-2.5 hover:bg-white/5 text-red-400 flex items-center gap-2">
                            <i class="ph ph-x-circle"></i>
                            Anuluj projekt
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Content -->
        <div class="flex-1 overflow-y-auto p-4 md:p-6 lg:p-10">
            <div class="max-w-5xl mx-auto animate-enter">

                <!-- Loading State -->
                <div id="loading-state" class="py-16 text-center">
                    <div class="w-5 h-5 mx-auto mb-3 border-2 border-zinc-700 border-t-white rounded-full animate-spin"></div>
                    <p class="text-zinc-500 text-sm font-mono">Ladowanie...</p>
                </div>

                <!-- Main Content (hidden until loaded) -->
                <div id="main-content" class="hidden">

                    <!-- Tabs Navigation -->
                    <div class="flex items-center gap-1 mb-6 border-b border-white/5 pb-px">
                        <button onclick="switchTab('projekt')" data-tab="projekt" class="workflow-tab px-4 py-2.5 text-sm font-medium rounded-t-lg transition-all border-b-2 -mb-px text-white border-white">
                            <i class="ph ph-kanban mr-1.5"></i>
                            Projekt
                        </button>
                        <button onclick="switchTab('umowa')" data-tab="umowa" class="workflow-tab px-4 py-2.5 text-sm font-medium rounded-t-lg transition-all border-b-2 -mb-px text-zinc-500 border-transparent hover:text-zinc-300">
                            <i class="ph ph-file-text mr-1.5"></i>
                            Umowa
                            <span id="contract-status-badge" class="ml-2 px-1.5 py-0.5 rounded text-[10px] font-medium bg-amber-500/20 text-amber-400">Oczekuje</span>
                        </button>
                    </div>

                    <!-- TAB: Projekt -->
                    <div id="tab-projekt" class="workflow-panel">

                    <!-- Top Section: Info + Progress -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">

                        <!-- Client Info Card -->
                        <div class="lg:col-span-2 bg-zinc-900/40 border border-white/5 rounded-lg p-5">
                            <div class="flex items-start justify-between mb-4">
                                <div class="flex items-center gap-3">
                                    <div class="w-12 h-12 rounded-lg bg-gradient-to-br from-violet-500/20 to-purple-500/20 border border-violet-500/30 flex items-center justify-center">
                                        <i class="ph ph-user text-xl text-violet-400"></i>
                                    </div>
                                    <div>
                                        <h2 id="customer-name" class="text-xl font-semibold text-white">-</h2>
                                        <p id="customer-email" class="text-zinc-500 text-sm">-</p>
                                    </div>
                                </div>
                                <div id="status-badge" class="px-3 py-1 rounded-lg text-xs font-medium">Aktywny</div>
                            </div>

                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                <div>
                                    <span class="text-zinc-500 text-xs block mb-1">Firma</span>
                                    <span id="customer-company" class="text-zinc-200">-</span>
                                </div>
                                <div>
                                    <span class="text-zinc-500 text-xs block mb-1">Telefon</span>
                                    <span id="customer-phone" class="text-zinc-200">-</span>
                                </div>
                                <div>
                                    <span class="text-zinc-500 text-xs block mb-1">Oferta</span>
                                    <span id="offer-name" class="text-zinc-200">-</span>
                                </div>
                                <div>
                                    <span class="text-zinc-500 text-xs block mb-1">Kwota</span>
                                    <span id="amount" class="text-white font-mono font-medium">-</span>
                                </div>
                            </div>

                            <div class="flex items-center gap-4 mt-4 pt-4 border-t border-white/5 text-xs">
                                <div class="flex items-center gap-2">
                                    <i class="ph ph-calendar text-zinc-500"></i>
                                    <span class="text-zinc-500">Start:</span>
                                    <span id="started-at" class="text-zinc-300">-</span>
                                </div>
                                <div id="client-access-info" class="flex items-center gap-2">
                                    <i class="ph ph-eye text-zinc-500"></i>
                                    <span class="text-zinc-500">Wizyty klienta:</span>
                                    <span id="access-count" class="text-zinc-300">0</span>
                                </div>
                            </div>
                        </div>

                        <!-- Progress Card -->
                        <div class="bg-zinc-900/40 border border-white/5 rounded-lg p-5">
                            <h3 class="text-zinc-400 text-xs font-medium uppercase tracking-wider mb-4">Postep projektu</h3>

                            <div class="text-center mb-4">
                                <div id="progress-percent" class="text-4xl font-bold text-white mb-1">0%</div>
                                <div class="text-zinc-500 text-xs font-mono">
                                    <span id="completed-tasks">0</span> / <span id="total-tasks">0</span> zadan
                                </div>
                            </div>

                            <div class="h-2 bg-zinc-800 rounded-full overflow-hidden mb-4">
                                <div id="progress-bar" class="progress-bar h-full rounded-full" style="width: 0%"></div>
                            </div>

                            <div class="flex items-center justify-between text-xs">
                                <div>
                                    <span class="text-zinc-500">Etap:</span>
                                    <span id="current-milestone" class="text-zinc-200 ml-1">-</span>
                                </div>
                                <div>
                                    <span class="text-zinc-500">Deadline:</span>
                                    <span id="current-deadline" class="text-zinc-200 ml-1">-</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Milestones Section -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                            <i class="ph ph-path text-violet-400"></i>
                            Etapy realizacji
                        </h3>

                        <div id="milestones-container" class="space-y-4">
                            <!-- Milestones rendered here -->
                        </div>
                    </div>

                    </div><!-- /tab-projekt -->

                    <!-- TAB: Umowa -->
                    <div id="tab-umowa" class="workflow-panel hidden">

                        <!-- Contract Status Overview -->
                        <div class="bg-zinc-900/40 border border-white/5 rounded-lg p-5 mb-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                                    <i class="ph ph-file-text text-emerald-400"></i>
                                    Status umowy
                                </h3>
                                <div id="contract-status-indicator" class="flex items-center gap-2 text-sm">
                                    <span class="w-2 h-2 rounded-full bg-amber-400"></span>
                                    <span class="text-amber-400">Oczekuje na dane</span>
                                </div>
                            </div>

                            <!-- Progress Steps -->
                            <div class="flex items-center gap-2 mb-6">
                                <div id="step-data" class="flex-1 flex items-center gap-2 p-3 rounded-lg bg-amber-500/10 border border-amber-500/20">
                                    <div class="w-6 h-6 rounded-full bg-amber-500/20 flex items-center justify-center text-amber-400 text-xs font-bold">1</div>
                                    <span class="text-xs text-amber-400 font-medium">Dane klienta</span>
                                </div>
                                <i class="ph ph-arrow-right text-zinc-600"></i>
                                <div id="step-contract" class="flex-1 flex items-center gap-2 p-3 rounded-lg bg-zinc-800/50 border border-white/5">
                                    <div class="w-6 h-6 rounded-full bg-zinc-700 flex items-center justify-center text-zinc-500 text-xs font-bold">2</div>
                                    <span class="text-xs text-zinc-500 font-medium">Generuj umowe</span>
                                </div>
                                <i class="ph ph-arrow-right text-zinc-600"></i>
                                <div id="step-signature" class="flex-1 flex items-center gap-2 p-3 rounded-lg bg-zinc-800/50 border border-white/5">
                                    <div class="w-6 h-6 rounded-full bg-zinc-700 flex items-center justify-center text-zinc-500 text-xs font-bold">3</div>
                                    <span class="text-xs text-zinc-500 font-medium">Podpis</span>
                                </div>
                            </div>
                        </div>

                        <!-- Client Data Filled Info (visible when client filled data) -->
                        <div id="client-data-filled-info" class="hidden bg-emerald-500/10 border border-emerald-500/20 rounded-lg p-5 mb-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-lg bg-emerald-500/20 flex items-center justify-center">
                                        <i class="ph-bold ph-check-circle text-emerald-400 text-xl"></i>
                                    </div>
                                    <div>
                                        <h3 class="text-white font-medium">Klient wypelnil dane</h3>
                                        <p id="client-data-filled-date" class="text-emerald-400/70 text-xs"></p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <button onclick="downloadContractPDF()" class="bg-white text-black hover:bg-zinc-200 px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
                                        <i class="ph ph-file-pdf"></i>
                                        Pobierz PDF
                                    </button>
                                    <button onclick="toggleContractEdit()" id="edit-contract-btn" class="bg-zinc-700 hover:bg-zinc-600 text-white px-3 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
                                        <i class="ph ph-pencil-simple"></i>
                                        Edytuj
                                    </button>
                                </div>
                            </div>

                            <!-- Readonly data display -->
                            <div id="contract-data-readonly" class="grid grid-cols-2 md:grid-cols-3 gap-3 text-sm">
                                <div class="bg-zinc-900/50 rounded-lg p-3">
                                    <span class="text-zinc-500 text-[10px] font-mono uppercase block mb-1">Imie i nazwisko</span>
                                    <span id="ro-name" class="text-white">-</span>
                                </div>
                                <div class="bg-zinc-900/50 rounded-lg p-3">
                                    <span class="text-zinc-500 text-[10px] font-mono uppercase block mb-1">Firma</span>
                                    <span id="ro-company" class="text-zinc-400">-</span>
                                </div>
                                <div class="bg-zinc-900/50 rounded-lg p-3">
                                    <span class="text-zinc-500 text-[10px] font-mono uppercase block mb-1">Email</span>
                                    <span id="ro-email" class="text-white">-</span>
                                </div>
                                <div class="bg-zinc-900/50 rounded-lg p-3">
                                    <span class="text-zinc-500 text-[10px] font-mono uppercase block mb-1">Telefon</span>
                                    <span id="ro-phone" class="text-white">-</span>
                                </div>
                                <div class="bg-zinc-900/50 rounded-lg p-3 md:col-span-2">
                                    <span class="text-zinc-500 text-[10px] font-mono uppercase block mb-1">Adres</span>
                                    <span id="ro-address" class="text-white">-</span>
                                </div>
                                <div class="bg-zinc-900/50 rounded-lg p-3">
                                    <span class="text-zinc-500 text-[10px] font-mono uppercase block mb-1">PESEL</span>
                                    <span id="ro-pesel" class="text-white font-mono">-</span>
                                </div>
                                <div class="bg-zinc-900/50 rounded-lg p-3">
                                    <span class="text-zinc-500 text-[10px] font-mono uppercase block mb-1">Nr dowodu</span>
                                    <span id="ro-id" class="text-white font-mono">-</span>
                                </div>
                                <div class="bg-zinc-900/50 rounded-lg p-3">
                                    <span class="text-zinc-500 text-[10px] font-mono uppercase block mb-1">NIP</span>
                                    <span id="ro-nip" class="text-zinc-400 font-mono">-</span>
                                </div>
                            </div>
                        </div>

                        <!-- Client Data Form (Admin can edit) -->
                        <div id="contract-data-form" class="bg-zinc-900/40 border border-white/5 rounded-lg p-5 mb-6">
                            <h3 class="text-sm font-medium text-white mb-4 flex items-center gap-2">
                                <i class="ph ph-user text-violet-400"></i>
                                Dane klienta do umowy
                            </h3>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Imie i nazwisko *</label>
                                    <input type="text" id="contract-name" class="input-field w-full text-sm text-white px-3 py-2.5 rounded-lg" placeholder="Jan Kowalski">
                                </div>
                                <div>
                                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Firma</label>
                                    <input type="text" id="contract-company" class="input-field w-full text-sm text-white px-3 py-2.5 rounded-lg" placeholder="Nazwa firmy (opcjonalnie)">
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Ulica *</label>
                                    <input type="text" id="contract-street" class="input-field w-full text-sm text-white px-3 py-2.5 rounded-lg" placeholder="ul. Przykładowa 123/45">
                                </div>
                                <div>
                                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Kod pocztowy *</label>
                                    <input type="text" id="contract-postal" class="input-field w-full text-sm text-white px-3 py-2.5 rounded-lg" placeholder="00-000">
                                </div>
                                <div>
                                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Miejscowosc *</label>
                                    <input type="text" id="contract-city" class="input-field w-full text-sm text-white px-3 py-2.5 rounded-lg" placeholder="Warszawa">
                                </div>
                                <div>
                                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Kraj</label>
                                    <input type="text" id="contract-country" class="input-field w-full text-sm text-white px-3 py-2.5 rounded-lg" value="Polska">
                                </div>
                                <div>
                                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">PESEL *</label>
                                    <input type="text" id="contract-pesel" class="input-field w-full text-sm text-white px-3 py-2.5 rounded-lg font-mono" placeholder="00000000000" maxlength="11">
                                </div>
                                <div>
                                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Nr dowodu osobistego *</label>
                                    <input type="text" id="contract-id-number" class="input-field w-full text-sm text-white px-3 py-2.5 rounded-lg font-mono" placeholder="ABC123456" maxlength="9">
                                </div>
                                <div>
                                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">NIP</label>
                                    <input type="text" id="contract-nip" class="input-field w-full text-sm text-white px-3 py-2.5 rounded-lg font-mono" placeholder="0000000000" maxlength="10">
                                </div>
                                <div>
                                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Email *</label>
                                    <input type="email" id="contract-email" class="input-field w-full text-sm text-white px-3 py-2.5 rounded-lg" placeholder="email@example.com">
                                </div>
                                <div>
                                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Telefon *</label>
                                    <input type="tel" id="contract-phone" class="input-field w-full text-sm text-white px-3 py-2.5 rounded-lg" placeholder="+48 600 000 000">
                                </div>
                            </div>

                            <div class="mt-4 flex items-center justify-between">
                                <span id="contract-data-status" class="text-xs text-zinc-500">
                                    <i class="ph ph-info"></i>
                                    Wypelnij wszystkie wymagane pola
                                </span>
                                <div class="flex items-center gap-2">
                                    <button onclick="cancelContractEdit()" id="cancel-edit-btn" class="hidden bg-zinc-700 hover:bg-zinc-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                        Anuluj
                                    </button>
                                    <button onclick="saveContractData()" class="bg-white text-black hover:bg-zinc-200 px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                        Zapisz dane
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Contract Generation (visible when data is filled) -->
                        <div id="contract-generation-section" class="hidden">
                            <div class="bg-zinc-900/40 border border-white/5 rounded-lg p-5 mb-6">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-sm font-medium text-white flex items-center gap-2">
                                        <i class="ph ph-file-doc text-cyan-400"></i>
                                        Umowa
                                    </h3>
                                    <div class="flex items-center gap-2">
                                        <button onclick="toggleContractCodeView()" id="toggle-code-btn" class="text-xs text-zinc-400 hover:text-white px-2 py-1 rounded transition-colors flex items-center gap-1">
                                            <i class="ph ph-code"></i>
                                            <span id="toggle-code-label">Edytuj HTML</span>
                                        </button>
                                    </div>
                                </div>

                                <div id="no-template-warning" class="hidden p-4 bg-amber-500/10 border border-amber-500/20 rounded-lg mb-4">
                                    <div class="flex items-center gap-2 text-amber-400 text-sm">
                                        <i class="ph ph-warning"></i>
                                        Brak szablonu umowy dla tej oferty. Dodaj szablon w edytorze oferty.
                                    </div>
                                </div>

                                <!-- Preview mode -->
                                <div id="contract-preview-mode" class="bg-zinc-950 border border-white/5 rounded-lg p-4 mb-4 max-h-[500px] overflow-y-auto">
                                    <pre id="contract-text" class="text-xs text-zinc-300 whitespace-pre-wrap font-mono leading-relaxed"></pre>
                                </div>

                                <!-- Code editor mode -->
                                <div id="contract-code-mode" class="hidden mb-4">
                                    <textarea id="contract-html-editor" class="w-full h-[500px] bg-zinc-950 border border-white/5 rounded-lg p-4 text-xs text-zinc-300 font-mono resize-none focus:outline-none focus:border-cyan-500/50" spellcheck="false"></textarea>
                                    <div class="mt-2 flex items-center gap-2">
                                        <button onclick="saveContractHtml()" class="bg-cyan-500/10 hover:bg-cyan-500/20 text-cyan-400 px-3 py-1.5 rounded text-xs font-medium transition-colors flex items-center gap-1">
                                            <i class="ph ph-floppy-disk"></i>
                                            Zapisz zmiany
                                        </button>
                                        <button onclick="resetContractHtml()" class="text-zinc-500 hover:text-zinc-300 px-3 py-1.5 rounded text-xs font-medium transition-colors">
                                            Przywroc oryginał
                                        </button>
                                        <span id="contract-save-status" class="text-xs text-zinc-500 ml-2"></span>
                                    </div>
                                </div>

                                <div class="flex items-center gap-3">
                                    <button onclick="generateContract()" class="bg-cyan-500/10 hover:bg-cyan-500/20 text-cyan-400 px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
                                        <i class="ph ph-arrows-clockwise"></i>
                                        Odswierz podglad
                                    </button>
                                    <button onclick="downloadContractPDF()" class="bg-white text-black hover:bg-zinc-200 px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
                                        <i class="ph ph-file-pdf"></i>
                                        Pobierz PDF
                                    </button>
                                </div>

                                <!-- Add signed contract section -->
                                <div class="mt-6 pt-6 border-t border-white/5">
                                    <h4 class="text-sm font-medium text-white mb-4 flex items-center gap-2">
                                        <i class="ph ph-signature text-emerald-400"></i>
                                        Dodaj podpisana umowe
                                    </h4>

                                    <div class="space-y-4">
                                        <!-- Upload fully signed contract -->
                                        <div class="p-4 bg-zinc-800/50 border border-white/5 rounded-lg">
                                            <label class="block text-zinc-400 text-sm mb-2">Wgraj w pelni podpisana umowe (Twoj + klienta podpis):</label>
                                            <input type="file" id="seller-signed-contract" accept=".pdf" class="text-sm text-zinc-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-zinc-700 file:text-white hover:file:bg-zinc-600">
                                            <p class="text-zinc-500 text-xs mt-2">Klient otrzyma email z informacja, ze umowa zostala podpisana i bedzie mogl ja pobrac.</p>
                                        </div>

                                        <!-- Uploaded file indicator -->
                                        <div id="seller-contract-uploaded" class="hidden p-3 bg-emerald-500/10 border border-emerald-500/20 rounded-lg">
                                            <div class="flex items-center gap-2 text-emerald-400 text-sm">
                                                <i class="ph ph-check-circle"></i>
                                                <span>Podpisana umowa zostala zapisana</span>
                                                <a id="seller-contract-link" href="#" target="_blank" class="ml-auto text-cyan-400 hover:text-cyan-300">
                                                    <i class="ph ph-download-simple"></i>
                                                </a>
                                            </div>
                                        </div>

                                        <button onclick="sendContractToClient()" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-3 rounded-lg text-sm font-medium transition-colors flex items-center justify-center gap-2">
                                            <i class="ph ph-check-circle"></i>
                                            Zapisz i powiadom klienta
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Signing Instructions (visible when contract is sent) -->
                        <div id="signing-section" class="hidden">
                            <div class="bg-zinc-900/40 border border-white/5 rounded-lg p-5 mb-6">
                                <h3 class="text-sm font-medium text-white mb-4 flex items-center gap-2">
                                    <i class="ph ph-pen text-emerald-400"></i>
                                    Podpisanie umowy
                                </h3>

                                <div class="space-y-4">
                                    <!-- Signed file upload -->
                                    <div class="p-4 bg-zinc-800/50 border border-white/5 rounded-lg">
                                        <label class="block text-zinc-400 text-sm mb-2">Klient podpisal umowe? Wgraj podpisany plik:</label>
                                        <input type="file" id="signed-contract-file" accept=".pdf" class="text-sm text-zinc-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-zinc-700 file:text-white hover:file:bg-zinc-600">
                                    </div>

                                    <!-- Signature type -->
                                    <div>
                                        <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-2">Typ podpisu</label>
                                        <div class="flex gap-2">
                                            <button onclick="setSignatureType('zaufany')" class="sig-type-btn flex-1 p-3 rounded-lg border border-white/5 bg-zinc-800/50 hover:border-violet-500/50 transition-colors text-center" data-type="zaufany">
                                                <i class="ph ph-identification-badge text-xl text-violet-400 mb-1"></i>
                                                <div class="text-xs text-zinc-300">Podpis zaufany</div>
                                                <div class="text-[10px] text-zinc-500">gov.pl</div>
                                            </button>
                                            <button onclick="setSignatureType('kwalifikowany')" class="sig-type-btn flex-1 p-3 rounded-lg border border-white/5 bg-zinc-800/50 hover:border-cyan-500/50 transition-colors text-center" data-type="kwalifikowany">
                                                <i class="ph ph-certificate text-xl text-cyan-400 mb-1"></i>
                                                <div class="text-xs text-zinc-300">Kwalifikowany</div>
                                                <div class="text-[10px] text-zinc-500">e-podpis</div>
                                            </button>
                                            <button onclick="setSignatureType('fizyczny')" class="sig-type-btn flex-1 p-3 rounded-lg border border-white/5 bg-zinc-800/50 hover:border-amber-500/50 transition-colors text-center" data-type="fizyczny">
                                                <i class="ph ph-package text-xl text-amber-400 mb-1"></i>
                                                <div class="text-xs text-zinc-300">Fizyczny</div>
                                                <div class="text-[10px] text-zinc-500">paczkomat</div>
                                            </button>
                                        </div>
                                    </div>

                                    <button onclick="confirmSignature()" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-3 rounded-lg text-sm font-medium transition-colors flex items-center justify-center gap-2">
                                        <i class="ph ph-check-circle"></i>
                                        Potwierdz podpisanie umowy
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Signed Contract Info (visible when signed) -->
                        <div id="signed-section" class="hidden">
                            <div class="bg-emerald-500/10 border border-emerald-500/20 rounded-lg p-5">
                                <div class="flex items-center gap-3 mb-4">
                                    <div class="w-10 h-10 rounded-full bg-emerald-500/20 flex items-center justify-center">
                                        <i class="ph ph-check-circle text-emerald-400 text-xl"></i>
                                    </div>
                                    <div>
                                        <h3 class="text-white font-medium">Umowa podpisana</h3>
                                        <p id="signed-date" class="text-emerald-400 text-sm">-</p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-4 text-sm">
                                    <span class="text-zinc-400">Typ podpisu:</span>
                                    <span id="signed-type" class="text-white">-</span>
                                </div>
                                <div class="mt-4">
                                    <a id="signed-file-link" href="#" target="_blank" class="text-cyan-400 hover:text-cyan-300 text-sm flex items-center gap-2">
                                        <i class="ph ph-file-pdf"></i>
                                        Pobierz podpisana umowe
                                    </a>
                                </div>
                            </div>
                        </div>

                    </div><!-- /tab-umowa -->

                </div>
            </div>
        </div>
    </main>

    <!-- Password Modal -->
    <div id="password-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-zinc-950 border border-white/10 rounded-lg w-full max-w-md shadow-2xl">
            <div class="flex items-center justify-between px-5 py-4 border-b border-white/5">
                <h2 class="text-sm font-medium text-white flex items-center gap-2">
                    <i class="ph ph-key text-amber-400"></i>
                    Haslo dostepu klienta
                </h2>
                <button onclick="closePasswordModal()" class="text-zinc-500 hover:text-white transition-colors">
                    <i class="ph ph-x text-lg"></i>
                </button>
            </div>

            <div class="p-5 space-y-4">
                <p class="text-zinc-400 text-sm">Ustaw haslo, ktore klient musi podac aby zobaczyc projekt. Pozostaw puste aby usunac haslo.</p>

                <div>
                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Nowe haslo</label>
                    <input type="password" id="new-password" class="input-field w-full text-sm text-white px-3 py-3 rounded-lg" placeholder="Wprowadz haslo...">
                </div>

                <div>
                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Potwierdz haslo</label>
                    <input type="password" id="confirm-password" class="input-field w-full text-sm text-white px-3 py-3 rounded-lg" placeholder="Powtorz haslo...">
                </div>

                <div id="password-current" class="text-xs text-zinc-500">
                    Status: <span id="password-status" class="text-zinc-300">brak hasla</span>
                </div>
            </div>

            <div class="flex gap-3 px-5 py-4 border-t border-white/5 bg-zinc-900/50">
                <button onclick="removePassword()" id="remove-password-btn" class="hidden text-red-400 hover:text-red-300 border border-red-500/20 hover:border-red-500/40 px-4 py-2 rounded-lg text-sm transition-colors">
                    Usun haslo
                </button>
                <div class="flex-1"></div>
                <button onclick="closePasswordModal()" class="text-zinc-400 hover:text-white border border-zinc-700 hover:border-zinc-600 px-4 py-2 rounded-lg text-sm transition-colors">
                    Anuluj
                </button>
                <button onclick="savePassword()" class="bg-white text-black hover:bg-zinc-200 px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                    Zapisz
                </button>
            </div>
        </div>
    </div>

    <!-- Task Notes Modal -->
    <div id="notes-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-zinc-950 border border-white/10 rounded-lg w-full max-w-lg shadow-2xl">
            <div class="flex items-center justify-between px-5 py-4 border-b border-white/5">
                <h2 class="text-sm font-medium text-white flex items-center gap-2">
                    <i class="ph ph-note text-amber-400"></i>
                    <span id="notes-modal-title">Notatki do zadania</span>
                </h2>
                <button onclick="closeNotesModal()" class="text-zinc-500 hover:text-white transition-colors">
                    <i class="ph ph-x text-lg"></i>
                </button>
            </div>

            <div class="p-5 space-y-4">
                <input type="hidden" id="notes-task-id">
                <div>
                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Notatki</label>
                    <textarea id="task-notes" rows="5" class="input-field w-full text-sm text-white px-3 py-3 rounded-lg resize-none" placeholder="Dodaj notatki..."></textarea>
                </div>

                <div>
                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Linki</label>
                    <div id="links-container" class="space-y-2 mb-2">
                        <!-- Links rendered here -->
                    </div>
                    <div class="flex gap-2">
                        <input type="text" id="new-link-url" class="input-field flex-1 text-sm text-white px-3 py-2 rounded-lg" placeholder="https://...">
                        <input type="text" id="new-link-title" class="input-field w-32 text-sm text-white px-3 py-2 rounded-lg" placeholder="Tytul">
                        <button onclick="addLink()" class="bg-zinc-800 hover:bg-zinc-700 text-white px-3 py-2 rounded-lg transition-colors">
                            <i class="ph ph-plus"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="flex gap-3 px-5 py-4 border-t border-white/5 bg-zinc-900/50">
                <div class="flex-1"></div>
                <button onclick="closeNotesModal()" class="text-zinc-400 hover:text-white border border-zinc-700 hover:border-zinc-600 px-4 py-2 rounded-lg text-sm transition-colors">
                    Anuluj
                </button>
                <button onclick="saveTaskNotes()" class="bg-white text-black hover:bg-zinc-200 px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                    Zapisz
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Milestone Modal -->
    <div id="edit-milestone-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-zinc-950 border border-white/10 rounded-lg w-full max-w-md shadow-2xl">
            <div class="flex items-center justify-between px-5 py-4 border-b border-white/5">
                <h2 class="text-sm font-medium text-white flex items-center gap-2">
                    <i class="ph ph-pencil-simple text-violet-400"></i>
                    Edytuj etap
                </h2>
                <button onclick="closeEditMilestoneModal()" class="text-zinc-500 hover:text-white transition-colors">
                    <i class="ph ph-x text-lg"></i>
                </button>
            </div>

            <div class="p-5 space-y-4">
                <input type="hidden" id="edit-milestone-id">
                <div>
                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Nazwa etapu</label>
                    <input type="text" id="edit-milestone-title" class="input-field w-full text-sm text-white px-3 py-3 rounded-lg" placeholder="Nazwa etapu...">
                </div>
                <div>
                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Opis (opcjonalnie)</label>
                    <textarea id="edit-milestone-description" rows="3" class="input-field w-full text-sm text-white px-3 py-3 rounded-lg resize-none" placeholder="Opis etapu..."></textarea>
                </div>
                <div>
                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Czas trwania (dni)</label>
                    <input type="number" id="edit-milestone-duration" min="1" class="input-field w-24 text-sm text-white px-3 py-3 rounded-lg" placeholder="1">
                </div>
            </div>

            <div class="flex gap-3 px-5 py-4 border-t border-white/5 bg-zinc-900/50">
                <div class="flex-1"></div>
                <button onclick="closeEditMilestoneModal()" class="text-zinc-400 hover:text-white border border-zinc-700 hover:border-zinc-600 px-4 py-2 rounded-lg text-sm transition-colors">
                    Anuluj
                </button>
                <button onclick="saveMilestone()" class="bg-white text-black hover:bg-zinc-200 px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                    Zapisz
                </button>
            </div>
        </div>
    </div>

    <!-- Add Task Modal -->
    <div id="add-task-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-zinc-950 border border-white/10 rounded-lg w-full max-w-md shadow-2xl">
            <div class="flex items-center justify-between px-5 py-4 border-b border-white/5">
                <h2 class="text-sm font-medium text-white flex items-center gap-2">
                    <i class="ph ph-plus-circle text-emerald-400"></i>
                    Dodaj zadanie
                </h2>
                <button onclick="closeAddTaskModal()" class="text-zinc-500 hover:text-white transition-colors">
                    <i class="ph ph-x text-lg"></i>
                </button>
            </div>

            <div class="p-5 space-y-4">
                <input type="hidden" id="add-task-milestone-id">
                <div>
                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Nazwa zadania</label>
                    <input type="text" id="add-task-title" class="input-field w-full text-sm text-white px-3 py-3 rounded-lg" placeholder="Nazwa zadania...">
                </div>
                <div>
                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Odpowiedzialny</label>
                    <select id="add-task-responsible" class="input-field w-full text-sm text-white px-3 py-3 rounded-lg">
                        <option value="team">Zespol (TN)</option>
                        <option value="client">Klient</option>
                        <option value="shared">Wspolne</option>
                    </select>
                </div>
            </div>

            <div class="flex gap-3 px-5 py-4 border-t border-white/5 bg-zinc-900/50">
                <div class="flex-1"></div>
                <button onclick="closeAddTaskModal()" class="text-zinc-400 hover:text-white border border-zinc-700 hover:border-zinc-600 px-4 py-2 rounded-lg text-sm transition-colors">
                    Anuluj
                </button>
                <button onclick="saveNewTask()" class="bg-white text-black hover:bg-zinc-200 px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                    Dodaj
                </button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://yxmavwkwnfuphjqbelws.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl4bWF2d2t3bmZ1cGhqcWJlbHdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NjQyNTUsImV4cCI6MjA4NDM0MDI1NX0.XeR0Fc7OFn6YbNJrOKTBEj36JtmLISZTM87y4ai9340';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        Sidebar.render();
        Sidebar.setupLogout(supabaseClient);

        let workflow = null;
        let milestones = [];
        let tasks = [];
        let currentTaskLinks = [];

        let teamMembers = [];
        let currentMember = null;
        let isAdmin = false;

        async function checkAuth() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
                window.location.href = Sidebar.getLoginPath();
                return null;
            }
            Sidebar.setUserEmail(session.user.email.split('@')[0]);
            await loadTeamMembers(session.user.id);
            return session;
        }

        async function loadTeamMembers(userId) {
            const { data, error } = await supabaseClient
                .from('team_members')
                .select('*');

            if (error) {
                console.error('Error loading team members:', error);
                return;
            }

            teamMembers = data || [];
            currentMember = teamMembers.find(m => m.user_id === userId);
            isAdmin = currentMember?.role === 'admin';

            if (currentMember) {
                Sidebar.setUserName(currentMember.name);
                Sidebar.setUserColor(currentMember.color);
                Sidebar.setupProfileClick();
            }

            Sidebar.showAdminNav(isAdmin);
        }

        function getWorkflowId() {
            const params = new URLSearchParams(window.location.search);
            return params.get('id');
        }

        async function loadWorkflow() {
            const workflowId = getWorkflowId();
            if (!workflowId) {
                window.location.href = '/workflows';
                return;
            }

            // Load workflow
            const { data: workflowData, error: workflowError } = await supabaseClient
                .from('workflows')
                .select('*')
                .eq('id', workflowId)
                .single();

            if (workflowError || !workflowData) {
                console.error('Error loading workflow:', workflowError);
                window.location.href = '/workflows';
                return;
            }

            workflow = workflowData;

            // Load milestones
            const { data: milestonesData } = await supabaseClient
                .from('workflow_milestones')
                .select('*')
                .eq('workflow_id', workflowId)
                .order('milestone_index');

            milestones = milestonesData || [];

            // Load tasks
            const { data: tasksData } = await supabaseClient
                .from('workflow_tasks')
                .select('*')
                .eq('workflow_id', workflowId)
                .order('task_index');

            tasks = tasksData || [];

            // Load access count
            const { count: accessCount } = await supabaseClient
                .from('workflow_access_log')
                .select('*', { count: 'exact', head: true })
                .eq('workflow_id', workflowId);

            workflow.accessCount = accessCount || 0;

            renderWorkflow();
        }

        function formatPrice(price) {
            return new Intl.NumberFormat('pl-PL', {
                style: 'currency',
                currency: 'PLN',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(price || 0);
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('pl-PL', { day: 'numeric', month: 'short', year: 'numeric' });
        }

        function formatDeadline(deadline) {
            if (!deadline) return '-';
            const date = new Date(deadline);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const deadlineDate = new Date(deadline);
            deadlineDate.setHours(0, 0, 0, 0);

            const diffDays = Math.ceil((deadlineDate - today) / (1000 * 60 * 60 * 24));

            if (diffDays < 0) {
                return `<span class="text-red-400">${Math.abs(diffDays)} dni temu</span>`;
            } else if (diffDays === 0) {
                return `<span class="text-amber-400">dzisiaj</span>`;
            } else if (diffDays <= 3) {
                return `<span class="text-amber-400">za ${diffDays} dni</span>`;
            }
            return formatDate(deadline);
        }

        function getStatusBadge(status) {
            const styles = {
                active: 'bg-emerald-500/10 text-emerald-400 border border-emerald-500/20',
                completed: 'bg-blue-500/10 text-blue-400 border border-blue-500/20',
                paused: 'bg-amber-500/10 text-amber-400 border border-amber-500/20',
                cancelled: 'bg-red-500/10 text-red-400 border border-red-500/20'
            };
            const labels = {
                active: 'Aktywny',
                completed: 'Ukonczony',
                paused: 'Wstrzymany',
                cancelled: 'Anulowany'
            };
            return { style: styles[status] || styles.active, label: labels[status] || status };
        }

        function getResponsibleBadge(responsible) {
            const labels = { team: 'TN', client: 'Klient', shared: 'Wspolne' };
            return `<span class="responsible-badge responsible-${responsible}">${labels[responsible] || responsible}</span>`;
        }

        function renderWorkflow() {
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');

            const customerDisplay = workflow.customer_name || workflow.customer_company || workflow.customer_email.split('@')[0];

            // Header
            document.getElementById('breadcrumb-name').textContent = customerDisplay;

            // Customer info
            document.getElementById('customer-name').textContent = customerDisplay;
            document.getElementById('customer-email').textContent = workflow.customer_email;
            document.getElementById('customer-company').textContent = workflow.customer_company || '-';
            document.getElementById('customer-phone').textContent = workflow.customer_phone || '-';
            document.getElementById('offer-name').textContent = workflow.offer_name;
            document.getElementById('amount').textContent = formatPrice(workflow.amount);
            document.getElementById('started-at').textContent = formatDate(workflow.started_at);
            document.getElementById('access-count').textContent = workflow.accessCount;

            // Status badge
            const statusInfo = getStatusBadge(workflow.status);
            const statusBadge = document.getElementById('status-badge');
            statusBadge.className = `px-3 py-1 rounded-lg text-xs font-medium ${statusInfo.style}`;
            statusBadge.textContent = statusInfo.label;

            // Password status
            const hasPassword = !!workflow.client_password_hash;
            document.getElementById('password-status').textContent = hasPassword ? 'ustawione' : 'brak hasla';
            document.getElementById('remove-password-btn').classList.toggle('hidden', !hasPassword);

            // Calculate progress
            const totalTasks = tasks.length;
            const completedTasks = tasks.filter(t => t.completed).length;
            const progressPercent = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

            document.getElementById('progress-percent').textContent = progressPercent + '%';
            document.getElementById('completed-tasks').textContent = completedTasks;
            document.getElementById('total-tasks').textContent = totalTasks;
            document.getElementById('progress-bar').style.width = progressPercent + '%';

            // Current milestone
            const currentMilestone = milestones.find(m => m.status === 'in_progress');
            document.getElementById('current-milestone').textContent = currentMilestone ? `[${milestones.indexOf(currentMilestone) + 1}/${milestones.length}] ${currentMilestone.title}` : '-';
            document.getElementById('current-deadline').innerHTML = currentMilestone ? formatDeadline(currentMilestone.deadline) : '-';

            // Render milestones
            renderMilestones();
        }

        function renderMilestones() {
            const container = document.getElementById('milestones-container');

            container.innerHTML = milestones.map((milestone, index) => {
                const milestoneTasks = tasks.filter(t => t.milestone_id === milestone.id);
                const completedCount = milestoneTasks.filter(t => t.completed).length;
                const totalCount = milestoneTasks.length;
                const progressPercent = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;

                const isActive = milestone.status === 'in_progress';
                const isCompleted = milestone.status === 'completed';
                const isPending = milestone.status === 'pending';

                const deliverables = milestone.deliverables || [];

                return `
                <div class="milestone-card bg-zinc-900/40 border border-white/5 rounded-lg overflow-hidden ${isActive ? 'active' : ''} ${isCompleted ? 'completed' : ''}">
                    <!-- Milestone Header -->
                    <div class="p-4 flex items-center justify-between">
                        <div class="flex items-center gap-3 flex-1 cursor-pointer" onclick="toggleMilestone('${milestone.id}')">
                            <div class="w-8 h-8 rounded-lg flex items-center justify-center text-sm font-bold ${
                                isCompleted ? 'bg-emerald-500/20 text-emerald-400' :
                                isActive ? 'bg-violet-500/20 text-violet-400' :
                                'bg-zinc-800 text-zinc-500'
                            }">
                                ${isCompleted ? '<i class="ph ph-check"></i>' : index + 1}
                            </div>
                            <div>
                                <h4 class="font-medium ${isCompleted || isActive ? 'text-white' : 'text-zinc-400'}">${milestone.title}</h4>
                                <div class="flex items-center gap-3 text-xs text-zinc-500">
                                    <span>${milestone.duration_days} dni</span>
                                    <span>|</span>
                                    <span>${formatDate(milestone.start_date)} - ${formatDate(milestone.deadline)}</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <button onclick="event.stopPropagation(); openEditMilestoneModal('${milestone.id}')" class="p-1.5 text-zinc-500 hover:text-violet-400 hover:bg-white/5 rounded transition-colors" title="Edytuj etap">
                                <i class="ph ph-pencil-simple text-sm"></i>
                            </button>
                            <div class="text-right hidden sm:block">
                                <div class="text-xs text-zinc-400">${completedCount}/${totalCount} zadan</div>
                                <div class="w-24 h-1.5 bg-zinc-800 rounded-full overflow-hidden mt-1">
                                    <div class="h-full rounded-full ${isCompleted ? 'bg-emerald-500' : 'bg-violet-500'}" style="width: ${progressPercent}%"></div>
                                </div>
                            </div>
                            <i class="ph ph-caret-down text-zinc-500 transition-transform milestone-chevron cursor-pointer" id="chevron-${milestone.id}" onclick="toggleMilestone('${milestone.id}')"></i>
                        </div>
                    </div>

                    <!-- Milestone Content (collapsible) -->
                    <div id="content-${milestone.id}" class="hidden border-t border-white/5">
                        ${milestone.description ? `
                            <div class="px-4 py-3 border-b border-white/5 text-zinc-400 text-sm">${milestone.description}</div>
                        ` : ''}

                        <!-- Tasks -->
                        <div class="divide-y divide-white/5">
                            ${milestoneTasks.map(task => `
                                <div class="task-row px-4 py-3 flex items-center gap-3 group">
                                    <div class="task-checkbox ${task.completed ? 'checked' : ''}" onclick="toggleTask('${task.id}', ${!task.completed})">
                                        ${task.completed ? '<i class="ph-bold ph-check text-white text-xs"></i>' : ''}
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <span class="${task.completed ? 'text-zinc-500 line-through' : 'text-zinc-200'}">${task.title}</span>
                                        ${task.notes || (task.links && task.links.length > 0) ? `
                                            <div class="flex items-center gap-2 mt-1">
                                                ${task.notes ? '<i class="ph ph-note text-amber-400 text-xs"></i>' : ''}
                                                ${task.links && task.links.length > 0 ? `<i class="ph ph-link text-cyan-400 text-xs"></i><span class="text-xs text-zinc-500">${task.links.length}</span>` : ''}
                                            </div>
                                        ` : ''}
                                    </div>
                                    ${getResponsibleBadge(task.responsible)}
                                    <button onclick="openNotesModal('${task.id}')" class="p-1.5 text-zinc-500 hover:text-white hover:bg-white/5 rounded transition-colors" title="Notatki">
                                        <i class="ph ph-note-pencil text-sm"></i>
                                    </button>
                                    <button onclick="deleteTask('${task.id}')" class="p-1.5 text-zinc-500 hover:text-red-400 hover:bg-white/5 rounded transition-colors opacity-0 group-hover:opacity-100" title="Usun zadanie">
                                        <i class="ph ph-trash text-sm"></i>
                                    </button>
                                </div>
                            `).join('')}
                        </div>

                        <!-- Add Task Button -->
                        <div class="px-4 py-3 border-t border-white/5">
                            <button onclick="openAddTaskModal('${milestone.id}')" class="text-zinc-500 hover:text-emerald-400 text-sm flex items-center gap-2 transition-colors">
                                <i class="ph ph-plus"></i>
                                Dodaj zadanie
                            </button>
                        </div>

                        <!-- Deliverables -->
                        ${deliverables.length > 0 ? `
                            <div class="px-4 py-3 border-t border-white/5 bg-zinc-900/30">
                                <div class="text-xs text-zinc-500 uppercase tracking-wider mb-2">Rezultaty etapu</div>
                                <ul class="space-y-1">
                                    ${deliverables.map(d => `
                                        <li class="flex items-center gap-2 text-sm text-zinc-400">
                                            <i class="ph ph-check-circle text-emerald-400"></i>
                                            ${d}
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        ` : ''}

                        <!-- Milestone Actions -->
                        ${isActive && !isCompleted ? `
                            <div class="px-4 py-3 border-t border-white/5 flex justify-end">
                                <button onclick="completeMilestone('${milestone.id}')" class="bg-emerald-500/10 hover:bg-emerald-500/20 text-emerald-400 px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2" ${completedCount < totalCount ? 'disabled title="Ukoncz wszystkie zadania"' : ''}>
                                    <i class="ph ph-check-circle"></i>
                                    Ukoncz etap
                                </button>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `}).join('');

            // Expand active milestone by default
            const activeMilestone = milestones.find(m => m.status === 'in_progress');
            if (activeMilestone) {
                toggleMilestone(activeMilestone.id, true);
            }
        }

        function toggleMilestone(milestoneId, forceOpen = false) {
            const content = document.getElementById(`content-${milestoneId}`);
            const chevron = document.getElementById(`chevron-${milestoneId}`);

            if (forceOpen || content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                chevron.style.transform = 'rotate(180deg)';
            } else {
                content.classList.add('hidden');
                chevron.style.transform = 'rotate(0deg)';
            }
        }

        async function toggleTask(taskId, completed) {
            const { error } = await supabaseClient
                .from('workflow_tasks')
                .update({
                    completed,
                    completed_at: completed ? new Date().toISOString() : null,
                    completed_by: completed && currentMember ? currentMember.id : null
                })
                .eq('id', taskId);

            if (error) {
                console.error('Error updating task:', error);
                showToast('Blad aktualizacji zadania', 'error');
                return;
            }

            // Update local state
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                task.completed = completed;
                task.completed_at = completed ? new Date().toISOString() : null;
            }

            renderWorkflow();
        }

        async function completeMilestone(milestoneId) {
            const milestone = milestones.find(m => m.id === milestoneId);
            if (!milestone) return;

            const milestoneTasks = tasks.filter(t => t.milestone_id === milestoneId);
            const allCompleted = milestoneTasks.every(t => t.completed);

            if (!allCompleted) {
                showToast('Ukoncz wszystkie zadania przed zakonczeniem etapu', 'warning');
                return;
            }

            // Update milestone status
            const { error } = await supabaseClient
                .from('workflow_milestones')
                .update({
                    status: 'completed',
                    completed_at: new Date().toISOString()
                })
                .eq('id', milestoneId);

            if (error) {
                console.error('Error completing milestone:', error);
                showToast('Blad aktualizacji etapu', 'error');
                return;
            }

            // Find next milestone and set it to in_progress
            const currentIndex = milestones.findIndex(m => m.id === milestoneId);
            const nextMilestone = milestones[currentIndex + 1];

            if (nextMilestone) {
                await supabaseClient
                    .from('workflow_milestones')
                    .update({
                        status: 'in_progress',
                        started_at: new Date().toISOString()
                    })
                    .eq('id', nextMilestone.id);
            } else {
                // All milestones completed - mark workflow as completed
                await supabaseClient
                    .from('workflows')
                    .update({
                        status: 'completed',
                        completed_at: new Date().toISOString()
                    })
                    .eq('id', workflow.id);
            }

            // Send email notification
            try {
                const currentIndex = milestones.findIndex(m => m.id === milestoneId);
                await fetch('https://yxmavwkwnfuphjqbelws.supabase.co/functions/v1/workflow-stage-completed', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify({
                        workflow_id: workflow.id,
                        milestone_id: milestoneId,
                        milestone_title: milestone.title,
                        milestone_index: currentIndex,
                        total_milestones: milestones.length
                    })
                });
            } catch (emailErr) {
                console.log('Could not send notification email:', emailErr);
            }

            showToast('Etap ukonczony!', 'success');
            await loadWorkflow();
        }

        async function changeStatus(newStatus) {
            const { error } = await supabaseClient
                .from('workflows')
                .update({
                    status: newStatus,
                    completed_at: newStatus === 'completed' ? new Date().toISOString() : null
                })
                .eq('id', workflow.id);

            if (error) {
                console.error('Error changing status:', error);
                showToast('Blad zmiany statusu', 'error');
                return;
            }

            closeActionsMenu();
            showToast('Status zmieniony', 'success');
            await loadWorkflow();
        }

        // Actions Menu
        document.getElementById('actions-btn').addEventListener('click', function(e) {
            e.stopPropagation();
            document.getElementById('actions-menu').classList.toggle('hidden');
        });

        function closeActionsMenu() {
            document.getElementById('actions-menu').classList.add('hidden');
        }

        document.addEventListener('click', closeActionsMenu);

        // Copy client link
        document.getElementById('copy-link-btn').addEventListener('click', async function() {
            const url = `https://crm.tomekniedzwiecki.pl/projekt/${workflow.unique_token}`;

            try {
                await navigator.clipboard.writeText(url);
                showToast('Link skopiowany!', 'success');
            } catch (err) {
                const textArea = document.createElement('textarea');
                textArea.value = url;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showToast('Link skopiowany!', 'success');
            }
        });

        // Password Modal
        function openPasswordModal() {
            closeActionsMenu();
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-password').value = '';
            document.getElementById('password-modal').classList.remove('hidden');
        }

        function closePasswordModal() {
            document.getElementById('password-modal').classList.add('hidden');
        }

        async function savePassword() {
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;

            if (newPassword && newPassword !== confirmPassword) {
                showToast('Hasla nie sa identyczne', 'error');
                return;
            }

            let passwordHash = null;
            if (newPassword) {
                passwordHash = dcodeIO.bcrypt.hashSync(newPassword, 10);
            }

            const { error } = await supabaseClient
                .from('workflows')
                .update({ client_password_hash: passwordHash })
                .eq('id', workflow.id);

            if (error) {
                console.error('Error saving password:', error);
                showToast('Blad zapisywania hasla', 'error');
                return;
            }

            workflow.client_password_hash = passwordHash;
            closePasswordModal();
            showToast(newPassword ? 'Haslo ustawione' : 'Haslo usuniete', 'success');
            renderWorkflow();
        }

        async function removePassword() {
            const { error } = await supabaseClient
                .from('workflows')
                .update({ client_password_hash: null })
                .eq('id', workflow.id);

            if (error) {
                console.error('Error removing password:', error);
                showToast('Blad usuwania hasla', 'error');
                return;
            }

            workflow.client_password_hash = null;
            closePasswordModal();
            showToast('Haslo usuniete', 'success');
            renderWorkflow();
        }

        // Notes Modal
        function openNotesModal(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            document.getElementById('notes-task-id').value = taskId;
            document.getElementById('notes-modal-title').textContent = task.title;
            document.getElementById('task-notes').value = task.notes || '';
            currentTaskLinks = task.links ? [...task.links] : [];
            renderLinks();

            document.getElementById('notes-modal').classList.remove('hidden');
        }

        function closeNotesModal() {
            document.getElementById('notes-modal').classList.add('hidden');
            currentTaskLinks = [];
        }

        function renderLinks() {
            const container = document.getElementById('links-container');
            container.innerHTML = currentTaskLinks.map((link, index) => `
                <div class="flex items-center gap-2 bg-zinc-900 rounded-lg px-3 py-2">
                    <i class="ph ph-link text-cyan-400"></i>
                    <a href="${link.url}" target="_blank" class="flex-1 text-cyan-400 hover:text-cyan-300 text-sm truncate">${link.title || link.url}</a>
                    <button onclick="removeLink(${index})" class="text-zinc-500 hover:text-red-400 transition-colors">
                        <i class="ph ph-x"></i>
                    </button>
                </div>
            `).join('');
        }

        function addLink() {
            const url = document.getElementById('new-link-url').value.trim();
            const title = document.getElementById('new-link-title').value.trim();

            if (!url) return;

            currentTaskLinks.push({ url, title: title || url });
            document.getElementById('new-link-url').value = '';
            document.getElementById('new-link-title').value = '';
            renderLinks();
        }

        function removeLink(index) {
            currentTaskLinks.splice(index, 1);
            renderLinks();
        }

        async function saveTaskNotes() {
            const taskId = document.getElementById('notes-task-id').value;
            const notes = document.getElementById('task-notes').value.trim();

            const { error } = await supabaseClient
                .from('workflow_tasks')
                .update({
                    notes: notes || null,
                    links: currentTaskLinks.length > 0 ? currentTaskLinks : []
                })
                .eq('id', taskId);

            if (error) {
                console.error('Error saving notes:', error);
                showToast('Blad zapisywania notatek', 'error');
                return;
            }

            // Update local state
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                task.notes = notes || null;
                task.links = currentTaskLinks.length > 0 ? currentTaskLinks : [];
            }

            closeNotesModal();
            showToast('Zapisano', 'success');
            renderMilestones();
        }

        function showToast(message, type = 'success') {
            const existing = document.getElementById('toast-notification');
            if (existing) existing.remove();

            const colors = {
                success: 'text-emerald-400',
                error: 'text-red-400',
                warning: 'text-amber-400'
            };
            const icons = {
                success: 'ph-check-circle',
                error: 'ph-x-circle',
                warning: 'ph-warning'
            };

            const toast = document.createElement('div');
            toast.id = 'toast-notification';
            toast.className = 'fixed bottom-6 right-6 bg-zinc-800 border border-white/10 text-white px-4 py-3 rounded-lg shadow-xl z-50 flex items-center gap-2 animate-enter';
            toast.innerHTML = `<i class="ph ${icons[type]} ${colors[type]}"></i> ${message}`;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(10px)';
                toast.style.transition = 'all 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Edit Milestone Modal
        function openEditMilestoneModal(milestoneId) {
            const milestone = milestones.find(m => m.id === milestoneId);
            if (!milestone) return;

            document.getElementById('edit-milestone-id').value = milestoneId;
            document.getElementById('edit-milestone-title').value = milestone.title || '';
            document.getElementById('edit-milestone-description').value = milestone.description || '';
            document.getElementById('edit-milestone-duration').value = milestone.duration_days || 1;

            document.getElementById('edit-milestone-modal').classList.remove('hidden');
            document.getElementById('edit-milestone-title').focus();
        }

        function closeEditMilestoneModal() {
            document.getElementById('edit-milestone-modal').classList.add('hidden');
        }

        async function saveMilestone() {
            const milestoneId = document.getElementById('edit-milestone-id').value;
            const title = document.getElementById('edit-milestone-title').value.trim();
            const description = document.getElementById('edit-milestone-description').value.trim();
            const durationDays = parseInt(document.getElementById('edit-milestone-duration').value) || 1;

            if (!title) {
                showToast('Podaj nazwe etapu', 'error');
                return;
            }

            const { error } = await supabaseClient
                .from('workflow_milestones')
                .update({
                    title,
                    description: description || null,
                    duration_days: durationDays
                })
                .eq('id', milestoneId);

            if (error) {
                console.error('Error updating milestone:', error);
                showToast('Blad aktualizacji etapu', 'error');
                return;
            }

            // Update local state
            const milestone = milestones.find(m => m.id === milestoneId);
            if (milestone) {
                milestone.title = title;
                milestone.description = description || null;
                milestone.duration_days = durationDays;
            }

            closeEditMilestoneModal();
            showToast('Etap zaktualizowany', 'success');
            renderWorkflow();
        }

        // Add Task Modal
        function openAddTaskModal(milestoneId) {
            document.getElementById('add-task-milestone-id').value = milestoneId;
            document.getElementById('add-task-title').value = '';
            document.getElementById('add-task-responsible').value = 'team';

            document.getElementById('add-task-modal').classList.remove('hidden');
            document.getElementById('add-task-title').focus();
        }

        function closeAddTaskModal() {
            document.getElementById('add-task-modal').classList.add('hidden');
        }

        async function saveNewTask() {
            const milestoneId = document.getElementById('add-task-milestone-id').value;
            const title = document.getElementById('add-task-title').value.trim();
            const responsible = document.getElementById('add-task-responsible').value;

            if (!title) {
                showToast('Podaj nazwe zadania', 'error');
                return;
            }

            // Get the highest task_index for this milestone
            const milestoneTasks = tasks.filter(t => t.milestone_id === milestoneId);
            const maxIndex = milestoneTasks.length > 0
                ? Math.max(...milestoneTasks.map(t => t.task_index))
                : -1;

            const { data: newTask, error } = await supabaseClient
                .from('workflow_tasks')
                .insert({
                    milestone_id: milestoneId,
                    workflow_id: workflow.id,
                    task_index: maxIndex + 1,
                    title,
                    responsible
                })
                .select()
                .single();

            if (error) {
                console.error('Error creating task:', error);
                showToast('Blad tworzenia zadania', 'error');
                return;
            }

            // Add to local state
            tasks.push(newTask);

            closeAddTaskModal();
            showToast('Zadanie dodane', 'success');
            renderWorkflow();
        }

        // Delete Task
        async function deleteTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            if (!confirm(`Czy na pewno chcesz usunac zadanie "${task.title}"?`)) {
                return;
            }

            const { error } = await supabaseClient
                .from('workflow_tasks')
                .delete()
                .eq('id', taskId);

            if (error) {
                console.error('Error deleting task:', error);
                showToast('Blad usuwania zadania', 'error');
                return;
            }

            // Remove from local state
            tasks = tasks.filter(t => t.id !== taskId);

            showToast('Zadanie usuniete', 'success');
            renderWorkflow();
        }

        // Make functions global
        window.toggleMilestone = toggleMilestone;
        window.toggleTask = toggleTask;
        window.completeMilestone = completeMilestone;
        window.changeStatus = changeStatus;
        window.openPasswordModal = openPasswordModal;
        window.closePasswordModal = closePasswordModal;
        window.savePassword = savePassword;
        window.removePassword = removePassword;
        window.openNotesModal = openNotesModal;
        window.closeNotesModal = closeNotesModal;
        window.addLink = addLink;
        window.removeLink = removeLink;
        window.saveTaskNotes = saveTaskNotes;
        window.openEditMilestoneModal = openEditMilestoneModal;
        window.closeEditMilestoneModal = closeEditMilestoneModal;
        window.saveMilestone = saveMilestone;
        window.openAddTaskModal = openAddTaskModal;
        window.closeAddTaskModal = closeAddTaskModal;
        window.saveNewTask = saveNewTask;
        window.deleteTask = deleteTask;

        // =============================================
        // TABS
        // =============================================
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.workflow-tab').forEach(btn => {
                const isActive = btn.dataset.tab === tabName;
                btn.classList.toggle('text-white', isActive);
                btn.classList.toggle('border-white', isActive);
                btn.classList.toggle('text-zinc-500', !isActive);
                btn.classList.toggle('border-transparent', !isActive);
            });

            // Update tab panels
            document.querySelectorAll('.workflow-panel').forEach(panel => {
                panel.classList.add('hidden');
            });
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');

            // Load contract data when switching to umowa tab
            if (tabName === 'umowa') {
                loadContractData();
            }
        }
        window.switchTab = switchTab;

        // =============================================
        // CONTRACT MANAGEMENT
        // =============================================
        // Contract template URLs by offer ID (static HTML files)
        const CONTRACT_TEMPLATES = {
            '30bf199b-8bc1-4810-8716-43dbffeb9113': '/umowy/umowa-budowa-sklepu.html',
            'bc5212fd-3f57-46a8-a2e9-07c030e97a3f': '/umowy/umowa-mentoring-ai.html'
        };

        let contractTemplateUrl = null;
        let contractHtml = null;
        let selectedSignatureType = null;

        let isEditingContract = false;

        async function loadContractData() {
            if (!workflow) return;

            // Get contract template URL from mapping
            contractTemplateUrl = CONTRACT_TEMPLATES[workflow.offer_id] || null;

            // Populate form with existing data
            document.getElementById('contract-name').value = workflow.customer_name || '';
            document.getElementById('contract-company').value = workflow.customer_company || '';
            document.getElementById('contract-street').value = workflow.client_street || '';
            document.getElementById('contract-postal').value = workflow.client_postal_code || '';
            document.getElementById('contract-city').value = workflow.client_city || '';
            document.getElementById('contract-country').value = workflow.client_country || 'Polska';
            document.getElementById('contract-pesel').value = workflow.client_pesel || '';
            document.getElementById('contract-id-number').value = workflow.client_id_number || '';
            document.getElementById('contract-nip').value = workflow.client_nip || '';
            document.getElementById('contract-email').value = workflow.customer_email || '';
            document.getElementById('contract-phone').value = workflow.customer_phone || '';

            // Populate readonly view
            document.getElementById('ro-name').textContent = workflow.customer_name || '-';
            document.getElementById('ro-company').textContent = workflow.customer_company || '-';
            document.getElementById('ro-email').textContent = workflow.customer_email || '-';
            document.getElementById('ro-phone').textContent = workflow.customer_phone || '-';
            document.getElementById('ro-pesel').textContent = workflow.client_pesel || '-';
            document.getElementById('ro-id').textContent = workflow.client_id_number || '-';
            document.getElementById('ro-nip').textContent = workflow.client_nip || '-';

            const address = [
                workflow.client_street,
                [workflow.client_postal_code, workflow.client_city].filter(Boolean).join(' '),
                workflow.client_country
            ].filter(Boolean).join(', ');
            document.getElementById('ro-address').textContent = address || '-';

            // Set filled date
            if (workflow.contract_data_filled_at) {
                document.getElementById('client-data-filled-date').textContent =
                    'Wypelniono ' + new Date(workflow.contract_data_filled_at).toLocaleDateString('pl-PL', {
                        day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit'
                    });
            }

            updateContractUI();
        }

        function toggleContractEdit() {
            isEditingContract = true;
            document.getElementById('client-data-filled-info').classList.add('hidden');
            document.getElementById('contract-data-form').classList.remove('hidden');
            document.getElementById('cancel-edit-btn').classList.remove('hidden');
        }
        window.toggleContractEdit = toggleContractEdit;

        function cancelContractEdit() {
            isEditingContract = false;
            loadContractData();
        }
        window.cancelContractEdit = cancelContractEdit;

        function updateContractUI() {
            const status = workflow.contract_status || 'pending_data';

            // Update status badge in tab
            const badge = document.getElementById('contract-status-badge');
            const statusLabels = {
                'pending_data': { text: 'Oczekuje', class: 'bg-amber-500/20 text-amber-400' },
                'data_filled': { text: 'Dane OK', class: 'bg-cyan-500/20 text-cyan-400' },
                'contract_sent': { text: 'Wysłano', class: 'bg-violet-500/20 text-violet-400' },
                'pending_signature': { text: 'Do podpisu', class: 'bg-violet-500/20 text-violet-400' },
                'signed': { text: 'Podpisana', class: 'bg-emerald-500/20 text-emerald-400' },
                'rejected': { text: 'Odrzucona', class: 'bg-red-500/20 text-red-400' }
            };
            const statusInfo = statusLabels[status] || statusLabels['pending_data'];
            badge.textContent = statusInfo.text;
            badge.className = `ml-2 px-1.5 py-0.5 rounded text-[10px] font-medium ${statusInfo.class}`;

            // Update status indicator
            const indicator = document.getElementById('contract-status-indicator');
            const indicatorColors = {
                'pending_data': 'bg-amber-400',
                'data_filled': 'bg-cyan-400',
                'contract_sent': 'bg-violet-400',
                'pending_signature': 'bg-violet-400',
                'signed': 'bg-emerald-400',
                'rejected': 'bg-red-400'
            };
            indicator.innerHTML = `
                <span class="w-2 h-2 rounded-full ${indicatorColors[status] || 'bg-amber-400'}"></span>
                <span class="${statusInfo.class.split(' ')[1] || 'text-amber-400'}">${statusInfo.text}</span>
            `;

            // Update progress steps
            const steps = ['pending_data', 'data_filled', 'contract_sent', 'pending_signature', 'signed'];
            const currentIndex = steps.indexOf(status);

            updateStepUI('step-data', currentIndex >= 1, currentIndex === 0);
            updateStepUI('step-contract', currentIndex >= 2, currentIndex === 1);
            updateStepUI('step-signature', currentIndex >= 4, currentIndex >= 2 && currentIndex < 4);

            // Show/hide sections based on status
            const hasData = status !== 'pending_data';
            const isSent = ['contract_sent', 'pending_signature'].includes(status);
            const isSigned = status === 'signed';

            // Show readonly info when client filled data (and not editing)
            const showReadonly = hasData && !isEditingContract;
            document.getElementById('client-data-filled-info').classList.toggle('hidden', !showReadonly);
            document.getElementById('contract-data-form').classList.toggle('hidden', showReadonly);
            document.getElementById('cancel-edit-btn').classList.toggle('hidden', !isEditingContract);

            document.getElementById('contract-generation-section').classList.toggle('hidden', !hasData || isSigned);
            document.getElementById('signing-section').classList.toggle('hidden', !isSent);
            document.getElementById('signed-section').classList.toggle('hidden', !isSigned);

            // Update no template warning
            if (hasData && !contractTemplateUrl) {
                document.getElementById('no-template-warning').classList.remove('hidden');
            } else {
                document.getElementById('no-template-warning').classList.add('hidden');
            }

            // Generate contract preview
            if (hasData && contractTemplateUrl) {
                generateContract();
            }

            // Show signed info
            if (isSigned) {
                document.getElementById('signed-date').textContent = workflow.contract_signed_at
                    ? new Date(workflow.contract_signed_at).toLocaleDateString('pl-PL', { day: 'numeric', month: 'long', year: 'numeric' })
                    : '-';
                const sigTypes = { 'zaufany': 'Podpis zaufany (gov.pl)', 'kwalifikowany': 'Podpis kwalifikowany', 'fizyczny': 'Podpis fizyczny' };
                document.getElementById('signed-type').textContent = sigTypes[workflow.contract_signature_type] || workflow.contract_signature_type || '-';
                if (workflow.contract_signed_file_url) {
                    document.getElementById('signed-file-link').href = workflow.contract_signed_file_url;
                }
            }
        }

        function updateStepUI(stepId, completed, active) {
            const step = document.getElementById(stepId);
            if (completed) {
                step.className = 'flex-1 flex items-center gap-2 p-3 rounded-lg bg-emerald-500/10 border border-emerald-500/20';
                step.querySelector('div').className = 'w-6 h-6 rounded-full bg-emerald-500/20 flex items-center justify-center text-emerald-400 text-xs font-bold';
                step.querySelector('span').className = 'text-xs text-emerald-400 font-medium';
            } else if (active) {
                step.className = 'flex-1 flex items-center gap-2 p-3 rounded-lg bg-amber-500/10 border border-amber-500/20';
                step.querySelector('div').className = 'w-6 h-6 rounded-full bg-amber-500/20 flex items-center justify-center text-amber-400 text-xs font-bold';
                step.querySelector('span').className = 'text-xs text-amber-400 font-medium';
            } else {
                step.className = 'flex-1 flex items-center gap-2 p-3 rounded-lg bg-zinc-800/50 border border-white/5';
                step.querySelector('div').className = 'w-6 h-6 rounded-full bg-zinc-700 flex items-center justify-center text-zinc-500 text-xs font-bold';
                step.querySelector('span').className = 'text-xs text-zinc-500 font-medium';
            }
        }

        async function saveContractData() {
            const data = {
                customer_name: document.getElementById('contract-name').value.trim(),
                customer_company: document.getElementById('contract-company').value.trim() || null,
                client_street: document.getElementById('contract-street').value.trim(),
                client_postal_code: document.getElementById('contract-postal').value.trim(),
                client_city: document.getElementById('contract-city').value.trim(),
                client_country: document.getElementById('contract-country').value.trim() || 'Polska',
                client_pesel: document.getElementById('contract-pesel').value.trim(),
                client_id_number: document.getElementById('contract-id-number').value.trim().toUpperCase(),
                client_nip: document.getElementById('contract-nip').value.trim() || null,
                customer_email: document.getElementById('contract-email').value.trim(),
                customer_phone: document.getElementById('contract-phone').value.trim()
            };

            // Validate required fields
            const required = ['customer_name', 'client_street', 'client_postal_code', 'client_city', 'client_pesel', 'client_id_number', 'customer_email', 'customer_phone'];
            const missing = required.filter(f => !data[f]);

            if (missing.length > 0) {
                showToast('Wypelnij wszystkie wymagane pola', 'error');
                return;
            }

            // Validate PESEL (11 digits)
            if (!/^\d{11}$/.test(data.client_pesel)) {
                showToast('PESEL musi miec 11 cyfr', 'error');
                return;
            }

            // Update workflow
            const updates = {
                ...data,
                contract_status: 'data_filled',
                contract_data_filled_at: new Date().toISOString()
            };

            const { error } = await supabaseClient
                .from('workflows')
                .update(updates)
                .eq('id', workflow.id);

            if (error) {
                console.error('Error saving contract data:', error);
                showToast('Blad zapisywania danych', 'error');
                return;
            }

            Object.assign(workflow, updates);
            isEditingContract = false;
            showToast('Dane zapisane', 'success');
            loadContractData(); // Reload to update readonly view
        }
        window.saveContractData = saveContractData;

        async function generateContract() {
            if (!contractTemplateUrl || !workflow) return;

            try {
                // Fetch the contract template HTML
                const response = await fetch(contractTemplateUrl);
                if (!response.ok) {
                    throw new Error('Nie mozna pobrac szablonu umowy');
                }
                let html = await response.text();

                const today = new Date().toLocaleDateString('pl-PL', { day: 'numeric', month: 'long', year: 'numeric' });
                const startDate = workflow.started_at
                    ? new Date(workflow.started_at).toLocaleDateString('pl-PL')
                    : today;

                const variables = {
                    '{{imie_nazwisko}}': workflow.customer_name || '',
                    '{{firma}}': workflow.customer_company || '',
                    '{{ulica}}': workflow.client_street || '',
                    '{{miasto}}': workflow.client_city || '',
                    '{{kod_pocztowy}}': workflow.client_postal_code || '',
                    '{{kraj}}': workflow.client_country || 'Polska',
                    '{{pesel}}': workflow.client_pesel || '',
                    '{{dowod}}': workflow.client_id_number || '',
                    '{{nr_dowodu}}': workflow.client_id_number || '',
                    '{{email}}': workflow.customer_email || '',
                    '{{telefon}}': workflow.customer_phone || '',
                    '{{nazwa_oferty}}': workflow.offer_name || '',
                    '{{kwota}}': formatPrice(workflow.amount),
                    '{{cena}}': formatPrice(workflow.amount),
                    '{{data}}': today,
                    '{{data_dzis}}': today,
                    '{{data_rozpoczecia}}': startDate
                };

                Object.entries(variables).forEach(([key, value]) => {
                    html = html.replace(new RegExp(key.replace(/[{}]/g, '\\$&'), 'g'), value);
                });

                contractHtml = html;

                // Show preview (extract text content for display)
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                document.getElementById('contract-text').textContent = tempDiv.textContent || tempDiv.innerText || '';
            } catch (err) {
                console.error('Error generating contract:', err);
                document.getElementById('contract-text').textContent = 'Blad ladowania szablonu umowy.';
            }
        }
        window.generateContract = generateContract;

        let isCodeViewMode = false;
        let originalContractHtml = null;

        function toggleContractCodeView() {
            isCodeViewMode = !isCodeViewMode;
            const previewEl = document.getElementById('contract-preview-mode');
            const codeEl = document.getElementById('contract-code-mode');
            const labelEl = document.getElementById('toggle-code-label');

            if (isCodeViewMode) {
                // Switch to code editor
                previewEl.classList.add('hidden');
                codeEl.classList.remove('hidden');
                labelEl.textContent = 'Podglad tekstu';

                // Load HTML into editor
                if (contractHtml) {
                    originalContractHtml = contractHtml;
                    document.getElementById('contract-html-editor').value = contractHtml;
                }
            } else {
                // Switch to preview
                previewEl.classList.remove('hidden');
                codeEl.classList.add('hidden');
                labelEl.textContent = 'Edytuj HTML';

                // Refresh preview with current HTML
                if (contractHtml) {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = contractHtml;
                    document.getElementById('contract-text').textContent = tempDiv.textContent || tempDiv.innerText || '';
                }
            }
        }
        window.toggleContractCodeView = toggleContractCodeView;

        function saveContractHtml() {
            const editor = document.getElementById('contract-html-editor');
            contractHtml = editor.value;

            document.getElementById('contract-save-status').textContent = 'Zapisano (tylko w sesji)';
            setTimeout(() => {
                document.getElementById('contract-save-status').textContent = '';
            }, 3000);

            showToast('Zmiany zapisane', 'success');
        }
        window.saveContractHtml = saveContractHtml;

        function resetContractHtml() {
            if (originalContractHtml) {
                document.getElementById('contract-html-editor').value = originalContractHtml;
                contractHtml = originalContractHtml;
                showToast('Przywrocono oryginał', 'info');
            } else {
                generateContract();
                showToast('Pobrano ponownie z szablonu', 'info');
            }
        }
        window.resetContractHtml = resetContractHtml;

        async function downloadContractPDF() {
            if (!contractHtml) {
                showToast('Najpierw wygeneruj podglad umowy', 'error');
                return;
            }

            try {
                // Generate PDF using html2pdf.js
                const container = document.createElement('div');
                container.innerHTML = contractHtml;
                document.body.appendChild(container);

                const opt = {
                    margin: 10,
                    filename: `Umowa_${workflow.customer_name?.replace(/\s+/g, '_') || 'klient'}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, useCORS: true },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };

                await html2pdf().set(opt).from(container).save();
                document.body.removeChild(container);
                showToast('PDF pobrany', 'success');
            } catch (err) {
                console.error('Error generating PDF:', err);
                showToast('Blad generowania PDF', 'error');
            }
        }
        window.downloadContractPDF = downloadContractPDF;

        async function sendContractToClient() {
            const fileInput = document.getElementById('seller-signed-contract');
            const file = fileInput?.files[0];

            let sellerSignedUrl = null;

            // Upload seller-signed contract PDF if provided
            if (file) {
                const fileExt = file.name.split('.').pop();
                const fileName = `contracts/${workflow.id}/seller_signed_${Date.now()}.${fileExt}`;

                const { data: uploadData, error: uploadError } = await supabaseClient.storage
                    .from('attachments')
                    .upload(fileName, file);

                if (uploadError) {
                    showToast('Blad przesylania pliku', 'error');
                    return;
                }

                const { data: urlData } = supabaseClient.storage
                    .from('attachments')
                    .getPublicUrl(fileName);

                sellerSignedUrl = urlData.publicUrl;
            }

            const updateData = {
                contract_status: 'contract_sent',
                contract_sent_at: new Date().toISOString()
            };

            if (sellerSignedUrl) {
                updateData.contract_seller_signed_url = sellerSignedUrl;
            }

            const { error } = await supabaseClient
                .from('workflows')
                .update(updateData)
                .eq('id', workflow.id);

            if (error) {
                showToast('Blad wysylania', 'error');
                return;
            }

            // Send email to client
            const clientEmail = workflow.customer_email;
            const clientName = workflow.customer_name || workflow.customer_company || 'Klient';
            const projectUrl = `https://tomekniedzwiecki.pl/projekt/${workflow.public_id}`;
            const offerName = workflow.offer_name || 'Projekt';

            if (clientEmail) {
                try {
                    const response = await fetch(`${SUPABASE_URL}/functions/v1/send-email`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        },
                        body: JSON.stringify({
                            type: 'contract_sent',
                            data: {
                                email: clientEmail,
                                clientName: clientName,
                                offerName: offerName,
                                projectUrl: projectUrl,
                                contractUrl: sellerSignedUrl || projectUrl
                            }
                        })
                    });

                    const result = await response.json();
                    if (!result.success) {
                        console.warn('Email failed:', result.error);
                    }
                } catch (emailError) {
                    console.warn('Email error:', emailError);
                }
            }

            workflow.contract_status = 'contract_sent';
            workflow.contract_sent_at = new Date().toISOString();
            if (sellerSignedUrl) {
                workflow.contract_seller_signed_url = sellerSignedUrl;
            }
            showToast('Umowa wyslana do klienta!', 'success');
            updateContractUI();
        }
        window.sendContractToClient = sendContractToClient;

        function setSignatureType(type) {
            selectedSignatureType = type;
            document.querySelectorAll('.sig-type-btn').forEach(btn => {
                const isSelected = btn.dataset.type === type;
                btn.classList.toggle('border-violet-500', isSelected && type === 'zaufany');
                btn.classList.toggle('border-cyan-500', isSelected && type === 'kwalifikowany');
                btn.classList.toggle('border-amber-500', isSelected && type === 'fizyczny');
                btn.classList.toggle('border-white/5', !isSelected);
            });
        }
        window.setSignatureType = setSignatureType;

        async function confirmSignature() {
            if (!selectedSignatureType) {
                showToast('Wybierz typ podpisu', 'error');
                return;
            }

            const fileInput = document.getElementById('signed-contract-file');
            const file = fileInput?.files[0];

            let signedFileUrl = null;

            // Upload signed contract PDF if provided
            if (file) {
                const fileExt = file.name.split('.').pop();
                const fileName = `contracts/${workflow.id}/signed_${Date.now()}.${fileExt}`;

                const { data: uploadData, error: uploadError } = await supabaseClient.storage
                    .from('attachments')
                    .upload(fileName, file);

                if (uploadError) {
                    showToast('Blad przesylania pliku', 'error');
                    return;
                }

                const { data: urlData } = supabaseClient.storage
                    .from('attachments')
                    .getPublicUrl(fileName);

                signedFileUrl = urlData.publicUrl;
            }

            const updateData = {
                contract_status: 'signed',
                contract_signed_at: new Date().toISOString(),
                contract_signature_type: selectedSignatureType
            };

            if (signedFileUrl) {
                updateData.contract_signed_file_url = signedFileUrl;
            }

            const { error } = await supabaseClient
                .from('workflows')
                .update(updateData)
                .eq('id', workflow.id);

            if (error) {
                showToast('Blad potwierdzania', 'error');
                return;
            }

            workflow.contract_status = 'signed';
            workflow.contract_signed_at = new Date().toISOString();
            workflow.contract_signature_type = selectedSignatureType;
            if (signedFileUrl) {
                workflow.contract_signed_file_url = signedFileUrl;
            }
            showToast('Umowa oznaczona jako podpisana!', 'success');
            updateContractUI();
        }
        window.confirmSignature = confirmSignature;

        async function init() {
            const session = await checkAuth();
            if (session) {
                await loadWorkflow();
            }
        }
        init();

        // Register service worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').catch(() => {});
        }
    </script>
</body>
</html>
