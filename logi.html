<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TN CRM - Logi</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#050505">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="components/shared-sidebar.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    }
                }
            }
        }
    </script>
    <style>
        body { background: #050505; color: #e5e5e5; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::selection { background: white; color: black; }

        .glass-header {
            background: rgba(5, 5, 5, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-enter { animation: fadeIn 0.4s ease-out forwards; }

        /* Row hover effect */
        .log-row {
            transition: background-color 0.15s ease;
        }
        .log-row:hover {
            background-color: rgba(255, 255, 255, 0.03);
        }
    </style>
</head>
<body class="h-screen flex overflow-hidden font-sans text-sm tracking-tight antialiased">

    <!-- Sidebar -->
    <aside id="sidebar" class="w-[280px] bg-zinc-950 border-r border-white/5 flex flex-col flex-shrink-0"></aside>

    <!-- Main -->
    <main class="flex-1 flex flex-col bg-black relative min-w-0">
        <!-- Header -->
        <header class="h-16 glass-header flex items-center justify-between px-4 md:px-6 sticky top-0 z-30">
            <div class="flex items-center gap-3">
                <button onclick="Sidebar.toggle()" class="mobile-menu-btn hidden items-center justify-center w-9 h-9 rounded-lg hover:bg-white/5 text-zinc-400 hover:text-white transition-colors">
                    <i class="ph ph-list text-xl"></i>
                </button>
                <div class="flex items-center gap-2 text-zinc-500">
                    <span class="text-zinc-400 hidden sm:inline">tn-crm</span>
                    <span class="text-zinc-700 hidden sm:inline">/</span>
                    <span class="text-white font-medium">logi</span>
                </div>
            </div>
            <div class="flex items-center gap-2 md:gap-3">
                <button id="refresh-btn" class="text-zinc-400 hover:text-white border border-zinc-800 hover:border-zinc-700 px-3 md:px-4 py-2 rounded-lg text-xs font-medium transition-all flex items-center gap-2">
                    <i class="ph ph-arrows-clockwise"></i>
                    <span class="hidden md:inline">Odśwież</span>
                </button>
            </div>
        </header>

        <!-- Content -->
        <div class="flex-1 overflow-y-auto">

            <div class="h-full">
                <!-- Logs Content Area -->
                <div class="flex-1 p-3 sm:p-6 lg:p-8 overflow-y-auto">
                    <div class="max-w-6xl animate-enter">

                        <!-- Access denied message for non-admins -->
                        <div id="access-denied" class="hidden bg-red-500/10 border border-red-500/20 rounded-lg p-6 text-center">
                            <i class="ph ph-lock-key text-4xl text-red-400 mb-3"></i>
                            <h2 class="text-lg font-medium text-white mb-2">Brak dostępu</h2>
                            <p class="text-zinc-400">Tylko administrator ma dostęp do logów systemowych.</p>
                        </div>

                        <!-- Logs content (admin only) -->
                        <div id="logs-content" class="hidden">

                            <!-- TAB: Activity (Aktywność) -->
                            <div id="tab-activity" class="logs-panel hidden">
                                <div class="flex items-center justify-between mb-6">
                                    <div>
                                        <h1 class="text-2xl font-semibold text-white tracking-tight mb-1">Dziennik aktywności</h1>
                                        <p class="text-zinc-500 text-sm">Wszystkie akcje wykonane w systemie</p>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-2xl font-semibold text-white" id="activity-total-count">-</div>
                                        <div class="text-zinc-600 text-[10px] font-mono">wszystkich wpisów</div>
                                    </div>
                                </div>

                                <!-- Activity Filters -->
                                <div class="bg-zinc-900/30 border border-white/5 rounded-lg p-4 mb-6">
                                    <div class="flex flex-wrap items-center gap-3">
                                        <select id="activity-filter-user" class="bg-zinc-900 border border-zinc-800 rounded-lg px-3 py-2 text-xs text-zinc-300 cursor-pointer outline-none hover:border-zinc-700 focus:border-zinc-600 min-w-0 sm:min-w-[140px]">
                                            <option value="">Wszyscy</option>
                                        </select>
                                        <select id="activity-filter-action" class="bg-zinc-900 border border-zinc-800 rounded-lg px-3 py-2 text-xs text-zinc-300 cursor-pointer outline-none hover:border-zinc-700 focus:border-zinc-600 min-w-0 sm:min-w-[130px]">
                                            <option value="">Wszystkie akcje</option>
                                            <option value="create">Utworzono</option>
                                            <option value="update">Zaktualizowano</option>
                                            <option value="delete">Usunięto</option>
                                            <option value="status_change">Zmiana statusu</option>
                                            <option value="batch_delete">Usunięto wiele</option>
                                        </select>
                                        <select id="activity-filter-entity" class="bg-zinc-900 border border-zinc-800 rounded-lg px-3 py-2 text-xs text-zinc-300 cursor-pointer outline-none hover:border-zinc-700 focus:border-zinc-600 min-w-0 sm:min-w-[130px]">
                                            <option value="">Wszystkie encje</option>
                                            <option value="lead">Lead</option>
                                            <option value="meeting">Spotkanie</option>
                                            <option value="activity">Aktywność</option>
                                            <option value="note">Notatka</option>
                                            <option value="offer">Oferta</option>
                                            <option value="proforma">Proforma</option>
                                            <option value="client_offer">Oferta klienta</option>
                                            <option value="team_member">Użytkownik</option>
                                            <option value="settings">Ustawienia</option>
                                        </select>
                                        <input type="date" id="activity-filter-date-from" class="bg-zinc-900 border border-zinc-800 rounded-lg px-3 py-2 text-xs text-zinc-300 outline-none hover:border-zinc-700 focus:border-zinc-600">
                                        <input type="date" id="activity-filter-date-to" class="bg-zinc-900 border border-zinc-800 rounded-lg px-3 py-2 text-xs text-zinc-300 outline-none hover:border-zinc-700 focus:border-zinc-600">
                                        <div class="relative flex-1 min-w-0 sm:min-w-[180px]">
                                            <input type="text" id="activity-filter-search" placeholder="Szukaj..." class="w-full bg-zinc-900 border border-zinc-800 rounded-lg pl-9 pr-3 py-2 text-xs text-zinc-300 outline-none hover:border-zinc-700 focus:border-zinc-600">
                                            <i class="ph ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-zinc-500"></i>
                                        </div>
                                        <button id="activity-clear-filters" class="text-zinc-500 hover:text-white px-2 py-2 text-xs transition-colors hidden">
                                            <i class="ph ph-x"></i>
                                        </button>
                                    </div>
                                </div>

                                <!-- Activity Results -->
                                <div class="flex items-center justify-between mb-3">
                                    <div class="text-[10px] text-zinc-500 font-mono">
                                        <span id="activity-showing-count">0</span> z <span id="activity-filtered-count">0</span>
                                    </div>
                                </div>

                                <!-- Activity Table -->
                                <div class="bg-zinc-900/20 border border-white/5 rounded-lg overflow-x-auto">
                                    <table class="w-full text-left text-xs">
                                        <thead class="bg-zinc-900/50 text-zinc-500 border-b border-white/5">
                                            <tr>
                                                <th class="px-4 py-3 font-medium w-[160px]">Czas</th>
                                                <th class="px-4 py-3 font-medium w-[140px]">Użytkownik</th>
                                                <th class="px-4 py-3 font-medium w-[120px]">Akcja</th>
                                                <th class="px-4 py-3 font-medium">Encja</th>
                                                <th class="px-4 py-3 font-medium w-[60px] text-center">Info</th>
                                            </tr>
                                        </thead>
                                        <tbody id="activity-table" class="divide-y divide-white/5"></tbody>
                                    </table>
                                    <div id="activity-empty-state" class="hidden p-12 text-center">
                                        <i class="ph ph-clipboard-text text-3xl text-zinc-700 mb-2"></i>
                                        <p class="text-zinc-600 text-sm">Brak wpisów</p>
                                    </div>
                                    <div id="activity-loading-state" class="p-12 text-center">
                                        <i class="ph ph-circle-notch animate-spin text-3xl text-zinc-700 mb-2"></i>
                                        <p class="text-zinc-600 text-sm">Ładowanie...</p>
                                    </div>
                                </div>

                                <!-- Activity Pagination -->
                                <div class="flex items-center justify-between mt-4">
                                    <button id="activity-prev-page" class="text-zinc-400 hover:text-white border border-zinc-800 hover:border-zinc-700 px-3 py-1.5 rounded-lg text-xs font-medium transition-all disabled:opacity-30 disabled:cursor-not-allowed flex items-center gap-1">
                                        <i class="ph ph-caret-left"></i>
                                        Wstecz
                                    </button>
                                    <span class="text-zinc-600 text-xs font-mono">
                                        <span id="activity-current-page">1</span> / <span id="activity-total-pages">1</span>
                                    </span>
                                    <button id="activity-next-page" class="text-zinc-400 hover:text-white border border-zinc-800 hover:border-zinc-700 px-3 py-1.5 rounded-lg text-xs font-medium transition-all disabled:opacity-30 disabled:cursor-not-allowed flex items-center gap-1">
                                        Dalej
                                        <i class="ph ph-caret-right"></i>
                                    </button>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const SUPABASE_URL = 'https://yxmavwkwnfuphjqbelws.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl4bWF2d2t3bmZ1cGhqcWJlbHdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NjQyNTUsImV4cCI6MjA4NDM0MDI1NX0.XeR0Fc7OFn6YbNJrOKTBEj36JtmLISZTM87y4ai9340';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const ITEMS_PER_PAGE = 50;
        let teamMembers = [];
        let teamMembersMap = {};
        let currentMember = null;
        let isAdmin = false;

        // Activity data
        let auditLogs = [];
        let filteredAuditLogs = [];
        let activityPage = 1;

        // Action type labels and styles
        const ACTION_TYPES = {
            create: { label: 'Utworzono', icon: 'ph-plus-circle', color: 'emerald' },
            update: { label: 'Zaktualizowano', icon: 'ph-pencil-simple', color: 'blue' },
            delete: { label: 'Usunięto', icon: 'ph-trash', color: 'red' },
            status_change: { label: 'Zmiana statusu', icon: 'ph-arrows-left-right', color: 'violet' },
            batch_delete: { label: 'Usunięto wiele', icon: 'ph-trash', color: 'red' }
        };

        // Entity type labels and icons
        const ENTITY_TYPES = {
            lead: { label: 'Lead', icon: 'ph-user' },
            meeting: { label: 'Spotkanie', icon: 'ph-calendar' },
            activity: { label: 'Aktywność', icon: 'ph-clock' },
            note: { label: 'Notatka', icon: 'ph-note' },
            offer: { label: 'Oferta', icon: 'ph-package' },
            proforma: { label: 'Proforma', icon: 'ph-file-pdf' },
            team_member: { label: 'Użytkownik', icon: 'ph-users-three' },
            settings: { label: 'Ustawienia', icon: 'ph-gear' },
            client_offer: { label: 'Oferta klienta', icon: 'ph-link' }
        };

        const STATUS_LABELS = {
            new: 'Nowy',
            contacted: 'Skontaktowany',
            qualified: 'Zakwalifikowany',
            proposal: 'Propozycja',
            negotiation: 'Negocjacje',
            won: 'Wygrany',
            lost: 'Przegrany',
            abandoned: 'Porzucony'
        };

        // ==================== AUTH ====================
        async function checkAuth() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
                window.location.href = Sidebar.getLoginPath();
                return null;
            }
            Sidebar.setUserEmail(session.user.email.split('@')[0]);
            await loadTeamMembers(session.user.id);
            return session;
        }

        async function loadTeamMembers(userId) {
            const { data, error } = await supabaseClient.from('team_members').select('*');
            if (error) {
                console.error('Error loading team members:', error);
                return;
            }

            teamMembers = data || [];
            teamMembersMap = {};
            teamMembers.forEach(member => {
                teamMembersMap[member.id] = member;
            });

            currentMember = teamMembers.find(m => m.user_id === userId);
            isAdmin = currentMember?.role === 'admin';

            if (currentMember) {
                Sidebar.setUserName(currentMember.name);
                Sidebar.setUserColor(currentMember.color);
                Sidebar.setupProfileClick();
            }

            Sidebar.showAdminNav(isAdmin);

            if (isAdmin) {
                document.getElementById('logs-content').classList.remove('hidden');
                document.getElementById('access-denied').classList.add('hidden');
                populateUserFilter();
                // Load activity data
                initActivityView();
            } else {
                document.getElementById('logs-content').classList.add('hidden');
                document.getElementById('access-denied').classList.remove('hidden');
            }
        }

        // ==================== INITIALIZATION ====================
        function initActivityView() {
            // Show activity panel directly (no tabs needed)
            const panel = document.getElementById('tab-activity');
            if (panel) panel.classList.remove('hidden');
            loadAuditLogs();
        }

        // ==================== HELPERS ====================
        function populateUserFilter() {
            const select = document.getElementById('activity-filter-user');
            select.innerHTML = '<option value="">Wszyscy</option>' +
                teamMembers.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
        }

        function getMemberInitials(memberId) {
            const member = teamMembersMap[memberId];
            if (!member) return '??';
            return member.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
        }

        function getMemberColor(memberId) {
            const member = teamMembersMap[memberId];
            if (!member) return 'bg-zinc-500';
            const colorMap = {
                'violet': 'bg-violet-500',
                'blue': 'bg-blue-500',
                'emerald': 'bg-emerald-500',
                'amber': 'bg-amber-500',
                'pink': 'bg-pink-500',
                'cyan': 'bg-cyan-500'
            };
            return colorMap[member.color] || 'bg-zinc-500';
        }

        function formatDateTime(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            let relative;
            if (minutes < 1) relative = 'Teraz';
            else if (minutes < 60) relative = `${minutes}m temu`;
            else if (hours < 24) relative = `${hours}h temu`;
            else if (days < 7) relative = `${days}d temu`;
            else relative = date.toLocaleDateString('pl-PL');

            const time = date.toLocaleTimeString('pl-PL', { hour: '2-digit', minute: '2-digit' });
            return { relative, time, full: date.toLocaleString('pl-PL') };
        }

        function formatFutureDateTime(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = date - now;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            let relative;
            if (diff < 0) {
                relative = 'Zaległy';
            } else if (minutes < 60) {
                relative = `za ${minutes}m`;
            } else if (hours < 24) {
                relative = `za ${hours}h`;
            } else {
                relative = `za ${days}d`;
            }

            const time = date.toLocaleTimeString('pl-PL', { hour: '2-digit', minute: '2-digit' });
            const dateStr = date.toLocaleDateString('pl-PL', { day: 'numeric', month: 'short' });
            return { relative, time, dateStr, full: date.toLocaleString('pl-PL') };
        }

        async function goToLead(email) {
            const { data } = await supabaseClient.from('leads').select('id').eq('email', email).maybeSingle();
            if (data) window.location.href = '/lead?id=' + data.id;
        }

        // ==================== ACTIVITY (AUDIT LOGS) ====================
        async function loadAuditLogs() {
            document.getElementById('activity-loading-state').classList.remove('hidden');
            document.getElementById('activity-empty-state').classList.add('hidden');

            const { data, error } = await supabaseClient
                .from('audit_log')
                .select('*')
                .order('created_at', { ascending: false });

            document.getElementById('activity-loading-state').classList.add('hidden');

            if (error) {
                console.error('Error loading audit logs:', error);
                return;
            }

            auditLogs = data || [];
            document.getElementById('activity-total-count').textContent = auditLogs.length;
            applyActivityFilters();
        }

        function applyActivityFilters() {
            const userFilter = document.getElementById('activity-filter-user').value;
            const actionFilter = document.getElementById('activity-filter-action').value;
            const entityFilter = document.getElementById('activity-filter-entity').value;
            const dateFromFilter = document.getElementById('activity-filter-date-from').value;
            const dateToFilter = document.getElementById('activity-filter-date-to').value;
            const searchFilter = document.getElementById('activity-filter-search').value.toLowerCase();

            filteredAuditLogs = auditLogs.filter(log => {
                if (userFilter && log.performed_by !== userFilter) return false;
                if (actionFilter && log.action_type !== actionFilter) return false;
                if (entityFilter && log.entity_type !== entityFilter) return false;
                if (dateFromFilter) {
                    const logDate = new Date(log.created_at).toISOString().split('T')[0];
                    if (logDate < dateFromFilter) return false;
                }
                if (dateToFilter) {
                    const logDate = new Date(log.created_at).toISOString().split('T')[0];
                    if (logDate > dateToFilter) return false;
                }
                if (searchFilter) {
                    const searchIn = [log.entity_identifier, log.performed_by_name].filter(Boolean).join(' ').toLowerCase();
                    if (!searchIn.includes(searchFilter)) return false;
                }
                return true;
            });

            const hasFilters = userFilter || actionFilter || entityFilter || dateFromFilter || dateToFilter || searchFilter;
            document.getElementById('activity-clear-filters').classList.toggle('hidden', !hasFilters);

            document.getElementById('activity-filtered-count').textContent = filteredAuditLogs.length;
            activityPage = 1;
            renderActivityLogs();
        }

        function renderActivityLogs() {
            const tbody = document.getElementById('activity-table');
            const emptyState = document.getElementById('activity-empty-state');
            const totalPages = Math.ceil(filteredAuditLogs.length / ITEMS_PER_PAGE);

            if (filteredAuditLogs.length === 0) {
                tbody.innerHTML = '';
                emptyState.classList.remove('hidden');
                document.getElementById('activity-showing-count').textContent = '0';
                return;
            }

            emptyState.classList.add('hidden');

            const start = (activityPage - 1) * ITEMS_PER_PAGE;
            const end = Math.min(start + ITEMS_PER_PAGE, filteredAuditLogs.length);
            const pageItems = filteredAuditLogs.slice(start, end);

            document.getElementById('activity-showing-count').textContent = pageItems.length;
            document.getElementById('activity-current-page').textContent = activityPage;
            document.getElementById('activity-total-pages').textContent = totalPages || 1;

            document.getElementById('activity-prev-page').disabled = activityPage <= 1;
            document.getElementById('activity-next-page').disabled = activityPage >= totalPages;

            tbody.innerHTML = pageItems.map((log, index) => {
                const dateTime = formatDateTime(log.created_at);
                const action = ACTION_TYPES[log.action_type] || { label: log.action_type, icon: 'ph-question', color: 'zinc' };
                const entity = ENTITY_TYPES[log.entity_type] || { label: log.entity_type, icon: 'ph-question' };
                const memberColor = getMemberColor(log.performed_by);
                const memberInitials = getMemberInitials(log.performed_by);
                const rowId = `activity-details-${start + index}`;

                const colorClasses = {
                    emerald: 'bg-emerald-500/10 text-emerald-400 border-emerald-500/20',
                    blue: 'bg-blue-500/10 text-blue-400 border-blue-500/20',
                    red: 'bg-red-500/10 text-red-400 border-red-500/20',
                    violet: 'bg-violet-500/10 text-violet-400 border-violet-500/20',
                    zinc: 'bg-zinc-500/10 text-zinc-400 border-zinc-500/20'
                };

                // Link for entity
                let linkUrl = null;
                if (log.entity_id) {
                    const relatedLeadId = log.new_value?.lead_id || log.old_value?.lead_id;
                    switch (log.entity_type) {
                        case 'lead': linkUrl = `/lead?id=${log.entity_id}`; break;
                        case 'offer': linkUrl = `/offer?id=${log.entity_id}`; break;
                        case 'client_offer':
                        case 'note':
                        case 'activity':
                        case 'meeting':
                            if (relatedLeadId) linkUrl = `/lead?id=${relatedLeadId}`;
                            break;
                    }
                }

                return `
                    <tr class="log-row">
                        <td class="px-4 py-3">
                            <div class="text-white text-xs">${dateTime.relative}</div>
                            <div class="text-zinc-600 text-[10px] font-mono">${dateTime.time}</div>
                        </td>
                        <td class="px-4 py-3">
                            <div class="flex items-center gap-2">
                                <div class="w-6 h-6 rounded-full ${memberColor} flex items-center justify-center text-white text-[9px] font-bold flex-shrink-0">
                                    ${memberInitials}
                                </div>
                                <span class="text-zinc-300 text-xs truncate">${log.performed_by_name || '-'}</span>
                            </div>
                        </td>
                        <td class="px-4 py-3">
                            <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded border ${colorClasses[action.color]} text-[10px] font-medium">
                                <i class="ph ${action.icon}"></i>
                                ${action.label}
                            </span>
                        </td>
                        <td class="px-4 py-3">
                            <div class="flex items-center gap-2">
                                <i class="ph ${entity.icon} text-zinc-500"></i>
                                <div>
                                    ${linkUrl
                                        ? `<a href="${linkUrl}" class="text-white text-xs hover:text-blue-400 transition-colors">${entity.label}</a>`
                                        : `<span class="text-white text-xs">${entity.label}</span>`
                                    }
                                    ${(() => {
                                        const ident = log.entity_identifier || '-';
                                        const isEmail = ident.includes('@');
                                        return isEmail
                                            ? `<a href="#" onclick="event.preventDefault();goToLead('${ident.replace(/'/g, "\\'")}')" class="text-zinc-600 hover:text-blue-400 text-[10px] truncate max-w-[200px] block transition-colors cursor-pointer" title="${ident}">${ident}</a>`
                                            : (linkUrl
                                                ? `<a href="${linkUrl}" class="text-zinc-600 hover:text-blue-400 text-[10px] truncate max-w-[200px] block transition-colors" title="${ident}">${ident}</a>`
                                                : `<div class="text-zinc-600 text-[10px] truncate max-w-[200px]" title="${ident}">${ident}</div>`);
                                    })()}
                                </div>
                            </div>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <button onclick="toggleActivityDetails('${rowId}')" class="p-1 text-zinc-500 hover:text-white hover:bg-white/10 rounded transition-colors">
                                <i class="ph ph-caret-down text-xs" id="icon-${rowId}"></i>
                            </button>
                        </td>
                    </tr>
                    <tr id="${rowId}" class="hidden bg-zinc-950/50">
                        <td colspan="5" class="px-4 py-3 border-t border-white/5">
                            <div class="text-zinc-600 text-[10px] font-mono uppercase tracking-wider mb-2">Szczegóły</div>
                            <div class="bg-zinc-900/50 rounded-lg p-3 text-xs">
                                ${formatActivityDetails(log.old_value, log.new_value, log.action_type)}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function toggleActivityDetails(rowId) {
            const row = document.getElementById(rowId);
            const icon = document.getElementById('icon-' + rowId);
            if (row.classList.contains('hidden')) {
                row.classList.remove('hidden');
                icon.classList.remove('ph-caret-down');
                icon.classList.add('ph-caret-up');
            } else {
                row.classList.add('hidden');
                icon.classList.remove('ph-caret-up');
                icon.classList.add('ph-caret-down');
            }
        }

        function formatActivityDetails(oldValue, newValue, actionType) {
            if (actionType === 'status_change' && oldValue?.status && newValue?.status) {
                const oldLabel = STATUS_LABELS[oldValue.status] || oldValue.status;
                const newLabel = STATUS_LABELS[newValue.status] || newValue.status;
                return `
                    <div class="flex items-center gap-3">
                        <span class="px-2 py-1 rounded bg-zinc-800 text-zinc-400">${oldLabel}</span>
                        <i class="ph ph-arrow-right text-zinc-600"></i>
                        <span class="px-2 py-1 rounded bg-blue-500/10 text-blue-400">${newLabel}</span>
                    </div>
                `;
            }

            if (actionType === 'create' && newValue) {
                return `<pre class="text-zinc-400 text-[10px] font-mono whitespace-pre-wrap overflow-x-auto">${JSON.stringify(newValue, null, 2)}</pre>`;
            }

            if (actionType === 'delete' && oldValue) {
                return `<pre class="text-red-400/60 text-[10px] font-mono whitespace-pre-wrap overflow-x-auto">${JSON.stringify(oldValue, null, 2)}</pre>`;
            }

            if (oldValue || newValue) {
                const allKeys = new Set([...Object.keys(oldValue || {}), ...Object.keys(newValue || {})]);
                const changes = [];
                allKeys.forEach(key => {
                    if (key === 'stages') return;
                    const oldVal = oldValue?.[key];
                    const newVal = newValue?.[key];
                    if (JSON.stringify(oldVal) !== JSON.stringify(newVal)) {
                        changes.push(`<div class="flex items-center gap-2 py-1">
                            <span class="text-zinc-500 w-24">${key}:</span>
                            <span class="text-red-400/60 line-through">${oldVal ?? '-'}</span>
                            <i class="ph ph-arrow-right text-zinc-700"></i>
                            <span class="text-emerald-400">${newVal ?? '-'}</span>
                        </div>`);
                    }
                });
                return changes.length > 0 ? changes.join('') : '<span class="text-zinc-600">Brak zmian</span>';
            }

            return '<span class="text-zinc-600">Brak szczegółów</span>';
        }

        // ==================== EVENT LISTENERS ====================
        document.getElementById('refresh-btn').addEventListener('click', () => {
            auditLogs = [];
            loadAuditLogs();
        });

        // Activity filters
        document.getElementById('activity-filter-user').addEventListener('change', applyActivityFilters);
        document.getElementById('activity-filter-action').addEventListener('change', applyActivityFilters);
        document.getElementById('activity-filter-entity').addEventListener('change', applyActivityFilters);
        document.getElementById('activity-filter-date-from').addEventListener('change', applyActivityFilters);
        document.getElementById('activity-filter-date-to').addEventListener('change', applyActivityFilters);
        document.getElementById('activity-filter-search').addEventListener('input', applyActivityFilters);
        document.getElementById('activity-clear-filters').addEventListener('click', () => {
            document.getElementById('activity-filter-user').value = '';
            document.getElementById('activity-filter-action').value = '';
            document.getElementById('activity-filter-entity').value = '';
            document.getElementById('activity-filter-date-from').value = '';
            document.getElementById('activity-filter-date-to').value = '';
            document.getElementById('activity-filter-search').value = '';
            applyActivityFilters();
        });

        // Activity pagination
        document.getElementById('activity-prev-page').addEventListener('click', () => {
            if (activityPage > 1) { activityPage--; renderActivityLogs(); }
        });
        document.getElementById('activity-next-page').addEventListener('click', () => {
            const totalPages = Math.ceil(filteredAuditLogs.length / ITEMS_PER_PAGE);
            if (activityPage < totalPages) { activityPage++; renderActivityLogs(); }
        });

        // ==================== INIT ====================
        async function init() {
            Sidebar.render();
            Sidebar.setupLogout(supabaseClient);
            await checkAuth();
        }
        init();

        // Register service worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').catch(() => {});
        }
    </script>
</body>
</html>
