<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twoj projekt - tomekniedzwiecki.pl</title>
    <link rel="icon" type="image/svg+xml" href="/favicon-tn.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bcryptjs/2.4.3/bcrypt.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    }
                }
            }
        }
    </script>
    <style>
        /* ═══════════════════════════════════════════════════════════════════
           VERCEL DESIGN SYSTEM - Premium Dark Theme
           ═══════════════════════════════════════════════════════════════════ */

        :root {
            --background: #000;
            --background-secondary: #0a0a0a;
            --surface: #111;
            --surface-hover: #171717;
            --border: #1a1a1a;
            --border-hover: #2a2a2a;
            --border-active: #333;
            --text-primary: #fafafa;
            --text-secondary: #a1a1a1;
            --text-tertiary: #666;
            --accent: #fff;
            --accent-secondary: #888;
            --success: #00d084;
            --success-muted: rgba(0, 208, 132, 0.1);
            --warning: #f5a623;
            --warning-muted: rgba(245, 166, 35, 0.1);
            --error: #ee5050;
            --info: #0070f3;
            --info-muted: rgba(0, 112, 243, 0.1);
        }

        body {
            background: var(--background);
            color: var(--text-primary);
            font-feature-settings: 'cv02', 'cv03', 'cv04', 'cv11';
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #222; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #333; }
        ::selection { background: var(--accent); color: var(--background); }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        .animate-enter { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .animate-slide { animation: slideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        /* Design Tokens */
        .border-default { border-color: var(--border); }
        .text-secondary { color: var(--text-secondary); }
        .text-tertiary { color: var(--text-tertiary); }

        /* ═══════════════════════════════════════════════════════════════════
           CARDS - Vercel Surface Style
           ═══════════════════════════════════════════════════════════════════ */
        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .card-hover:hover {
            border-color: var(--border-hover);
            transform: translateY(-1px);
        }
        .card-interactive {
            cursor: pointer;
        }
        .card-interactive:hover {
            border-color: var(--border-active);
            background: var(--surface-hover);
        }

        /* ═══════════════════════════════════════════════════════════════════
           PROGRESS RING - Animated Circle
           ═══════════════════════════════════════════════════════════════════ */
        .progress-ring { transform: rotate(-90deg); }
        .progress-ring-bg { stroke: var(--border); }
        .progress-ring-fill {
            stroke: var(--accent);
            stroke-linecap: round;
            transition: stroke-dashoffset 0.8s cubic-bezier(0.16, 1, 0.3, 1);
        }

        /* ═══════════════════════════════════════════════════════════════════
           MILESTONES
           ═══════════════════════════════════════════════════════════════════ */
        .milestone-card {
            transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
            background: var(--surface);
        }
        .milestone-card:hover {
            border-color: var(--border-hover);
        }
        .milestone-card.active {
            border-color: var(--border-active);
            background: var(--surface);
        }
        .milestone-card.completed {
            border-color: rgba(0, 208, 132, 0.2);
            background: linear-gradient(to right, rgba(0, 208, 132, 0.02), transparent);
        }

        /* ═══════════════════════════════════════════════════════════════════
           FORM INPUTS - Vercel Style
           ═══════════════════════════════════════════════════════════════════ */
        .form-input {
            width: 100%;
            background: var(--background);
            border: 1px solid var(--border-hover);
            border-radius: 8px;
            padding: 11px 14px;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.15s ease;
        }
        .form-input:hover { border-color: var(--border-active); }
        .form-input:focus {
            border-color: var(--accent-secondary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.05);
        }
        .form-input::placeholder { color: var(--text-tertiary); }

        /* ═══════════════════════════════════════════════════════════════════
           BADGES - Vercel Pill Style
           ═══════════════════════════════════════════════════════════════════ */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 5px 10px;
            border-radius: 9999px;
            font-size: 12px;
            font-weight: 500;
            letter-spacing: -0.01em;
            border: 1px solid transparent;
        }
        .badge-success {
            background: var(--success-muted);
            color: var(--success);
            border-color: rgba(0, 208, 132, 0.15);
        }
        .badge-warning {
            background: var(--warning-muted);
            color: var(--warning);
            border-color: rgba(245, 166, 35, 0.15);
        }
        .badge-info {
            background: var(--info-muted);
            color: var(--info);
            border-color: rgba(0, 112, 243, 0.15);
        }
        .badge-neutral {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-secondary);
            border-color: var(--border);
        }
        /* Legacy mappings */
        .badge-emerald { background: var(--success-muted); color: var(--success); border-color: rgba(0, 208, 132, 0.15); }
        .badge-amber { background: var(--warning-muted); color: var(--warning); border-color: rgba(245, 166, 35, 0.15); }
        .badge-blue { background: var(--info-muted); color: var(--info); border-color: rgba(0, 112, 243, 0.15); }
        .badge-violet { background: rgba(139, 92, 246, 0.1); color: #a78bfa; border-color: rgba(139, 92, 246, 0.15); }

        /* Responsible badges */
        .responsible-team {
            background: rgba(139, 92, 246, 0.08);
            color: #c4b5fd;
            border: 1px solid rgba(139, 92, 246, 0.15);
        }
        .responsible-client {
            background: rgba(34, 211, 238, 0.08);
            color: #67e8f9;
            border: 1px solid rgba(34, 211, 238, 0.15);
        }
        .responsible-shared {
            background: rgba(251, 191, 36, 0.08);
            color: #fcd34d;
            border: 1px solid rgba(251, 191, 36, 0.15);
        }

        /* ═══════════════════════════════════════════════════════════════════
           COMMENTS
           ═══════════════════════════════════════════════════════════════════ */
        .comment-team {
            background: var(--surface-hover);
            border: 1px solid var(--border);
            border-radius: 16px 16px 16px 4px;
        }
        .comment-client {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(139, 92, 246, 0.05));
            border: 1px solid rgba(139, 92, 246, 0.15);
            border-radius: 16px 16px 4px 16px;
        }

        /* ═══════════════════════════════════════════════════════════════════
           BUTTONS - Vercel Style
           ═══════════════════════════════════════════════════════════════════ */
        .btn-primary {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: var(--accent);
            color: var(--background);
            font-weight: 500;
            font-size: 14px;
            padding: 10px 16px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        .btn-primary:hover {
            background: #e5e5e5;
            transform: translateY(-1px);
        }
        .btn-primary:active { transform: translateY(0); }

        .btn-secondary {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: transparent;
            color: var(--text-primary);
            font-weight: 500;
            font-size: 14px;
            padding: 10px 16px;
            border-radius: 8px;
            border: 1px solid var(--border-hover);
            cursor: pointer;
            transition: all 0.15s ease;
        }
        .btn-secondary:hover {
            background: var(--surface);
            border-color: var(--border-active);
        }

        /* ═══════════════════════════════════════════════════════════════════
           SECTION HEADERS
           ═══════════════════════════════════════════════════════════════════ */
        .section-title {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 16px;
        }
        .page-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            letter-spacing: -0.02em;
            margin-bottom: 24px;
        }

        /* ═══════════════════════════════════════════════════════════════════
           EMPTY STATES
           ═══════════════════════════════════════════════════════════════════ */
        .empty-state {
            padding: 32px 0;
        }

        /* ═══════════════════════════════════════════════════════════════════
           SPECIAL ELEMENTS
           ═══════════════════════════════════════════════════════════════════ */
        .gradient-border {
            position: relative;
            background: var(--surface);
            border-radius: 12px;
        }
        .gradient-border::before {
            content: '';
            position: absolute;
            inset: -1px;
            border-radius: 13px;
            padding: 1px;
            background: linear-gradient(135deg, rgba(255,255,255,0.1), transparent, rgba(0, 208, 132, 0.2));
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            pointer-events: none;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            letter-spacing: -0.03em;
            background: linear-gradient(180deg, #fff 0%, #999 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .glow-success {
            box-shadow: 0 0 20px -5px rgba(0, 208, 132, 0.3);
        }

        /* File icons with colors */
        .file-icon-pdf { color: #ee5050; }
        .file-icon-doc { color: #0070f3; }
        .file-icon-img { color: #00d084; }
        .file-icon-video { color: #f5a623; }

        /* ═══════════════════════════════════════════════════════════════════
           RESPONSIVE
           ═══════════════════════════════════════════════════════════════════ */
        /* ═══════════════════════════════════════════════════════════════════
           SIDEBAR NAVIGATION
           ═══════════════════════════════════════════════════════════════════ */
        .sidebar-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
            padding: 9px 12px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 450;
            letter-spacing: -0.01em;
            color: var(--text-secondary);
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all 0.15s ease;
            text-align: left;
        }
        .sidebar-btn:hover {
            color: var(--text-primary);
            background: var(--surface);
        }
        .sidebar-btn.active {
            color: var(--text-primary);
            background: var(--surface-hover);
        }
        .sidebar-btn i {
            font-size: 16px;
            opacity: 0.7;
            width: 18px;
            text-align: center;
            flex-shrink: 0;
        }
        .sidebar-btn.active i { opacity: 1; }

        /* Top nav tabs (Vercel style) */
        .topnav-btn {
            position: relative;
            padding: 10px 12px;
            font-size: 13px;
            font-weight: 450;
            color: var(--text-tertiary);
            transition: color 0.15s;
            white-space: nowrap;
            border: none;
            background: none;
            cursor: pointer;
        }
        .topnav-btn:hover { color: var(--text-secondary); }
        .topnav-btn.active { color: var(--text-primary); }
        .topnav-btn.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 12px;
            right: 12px;
            height: 1px;
            background: var(--text-primary);
        }

        @media (max-width: 768px) {
            .stat-value { font-size: 24px; }
        }

        /* Hide scrollbar for section navigation */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="min-h-screen font-sans antialiased">

    <!-- Loading Screen -->
    <div id="loading-screen" class="min-h-screen flex items-center justify-center bg-black">
        <div class="text-center animate-enter">
            <div class="w-7 h-7 mx-auto mb-5 border-2 border-[#222] border-t-white rounded-full animate-spin"></div>
            <p class="text-tertiary text-sm">Ładowanie projektu...</p>
        </div>
    </div>

    <!-- Not Found Screen -->
    <div id="not-found-screen" class="hidden min-h-screen flex items-center justify-center p-4 bg-black">
        <div class="text-center animate-enter max-w-md">
            <div class="w-14 h-14 mx-auto mb-6 rounded-xl bg-[#111] border border-[#222] flex items-center justify-center">
                <i class="ph ph-warning text-2xl text-[#f5a623]"></i>
            </div>
            <h1 class="text-xl font-semibold text-white mb-3">Projekt nie znaleziony</h1>
            <p class="text-tertiary text-sm leading-relaxed">Link do projektu jest nieprawidłowy lub wygasł.<br>Skontaktuj się z zespołem.</p>
        </div>
    </div>

    <!-- Set Password Screen (First Time) -->
    <div id="set-password-screen" class="hidden min-h-screen flex items-center justify-center p-4 bg-black">
        <div class="w-full max-w-sm animate-enter">
            <div class="text-center mb-8">
                <div class="w-12 h-12 mx-auto mb-5 rounded-xl bg-[#00d084]/10 border border-[#00d084]/20 flex items-center justify-center">
                    <i class="ph ph-lock-key text-xl text-[#00d084]"></i>
                </div>
                <h1 class="text-xl font-semibold text-white mb-2 tracking-tight">Ustaw hasło dostępu</h1>
                <p class="text-tertiary text-sm">Utwórz hasło do logowania do projektu.</p>
            </div>

            <div class="card p-6">
                <form onsubmit="setPassword(event)">
                    <div class="mb-4">
                        <label class="block text-tertiary text-xs uppercase tracking-wider mb-2">Hasło</label>
                        <input type="password" id="set-password-input" class="form-input" placeholder="Minimum 6 znaków" required minlength="6">
                    </div>
                    <div class="mb-6">
                        <label class="block text-tertiary text-xs uppercase tracking-wider mb-2">Potwierdź hasło</label>
                        <input type="password" id="set-password-confirm" class="form-input" placeholder="Powtórz hasło" required>
                    </div>
                    <button type="submit" class="btn-primary w-full py-3">
                        Ustaw hasło
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Password Screen (Login) -->
    <div id="password-screen" class="hidden min-h-screen flex items-center justify-center p-4 bg-black">
        <div class="w-full max-w-sm animate-enter">
            <div class="text-center mb-8">
                <div class="w-12 h-12 mx-auto mb-5 rounded-xl bg-[#111] border border-[#222] flex items-center justify-center">
                    <i class="ph ph-lock text-xl text-[#666]"></i>
                </div>
                <h1 class="text-xl font-semibold text-white mb-2 tracking-tight">Zaloguj się</h1>
                <p class="text-tertiary text-sm">Wprowadź hasło, aby uzyskać dostęp.</p>
            </div>

            <div class="card p-6">
                <form onsubmit="checkPassword(event)">
                    <div class="mb-6">
                        <label class="block text-tertiary text-xs uppercase tracking-wider mb-2">Hasło</label>
                        <input type="password" id="password-input" class="form-input" placeholder="Wprowadź hasło" required>
                    </div>
                    <button type="submit" class="btn-primary w-full py-3">
                        Zaloguj
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Contract Data Screen -->
    <div id="contract-data-screen" class="hidden min-h-screen flex items-center justify-center p-4 py-12 bg-black">
        <div class="w-full max-w-2xl animate-enter">
            <div class="text-center mb-8">
                <div class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-[#00d084]/10 border border-[#00d084]/20 text-[#00d084] text-xs font-medium mb-5">
                    <i class="ph ph-check-circle"></i>
                    Krok 1 z 2
                </div>
                <h1 class="text-2xl font-semibold text-white mb-2 tracking-tight">Dane do umowy</h1>
                <p class="text-tertiary text-sm">Wprowadź dane potrzebne do przygotowania umowy.</p>
            </div>

            <div class="card p-6 md:p-8">
                <form onsubmit="submitContractData(event)">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-5">
                        <div>
                            <label class="block text-tertiary text-xs uppercase tracking-wider mb-2">Imię i nazwisko *</label>
                            <input type="text" id="contract-name" class="form-input" required>
                        </div>
                        <div>
                            <label class="block text-tertiary text-xs uppercase tracking-wider mb-2">Firma (opcjonalnie)</label>
                            <input type="text" id="contract-company" class="form-input">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-5">
                        <div>
                            <label class="block text-tertiary text-xs uppercase tracking-wider mb-2">PESEL *</label>
                            <input type="text" id="contract-pesel" class="form-input" maxlength="11" required>
                            <p id="pesel-error" class="text-[#ee5050] text-xs mt-1.5 hidden"></p>
                        </div>
                        <div>
                            <label class="block text-tertiary text-xs uppercase tracking-wider mb-2">Nr dowodu osobistego *</label>
                            <input type="text" id="contract-id" class="form-input" maxlength="9" required>
                            <p id="id-error" class="text-[#ee5050] text-xs mt-1.5 hidden"></p>
                        </div>
                    </div>

                    <div class="mb-5">
                        <label class="block text-tertiary text-xs uppercase tracking-wider mb-2">NIP (opcjonalnie)</label>
                        <input type="text" id="contract-nip" class="form-input" maxlength="10">
                    </div>

                    <div class="mb-5">
                        <label class="block text-tertiary text-xs uppercase tracking-wider mb-2">Ulica i numer *</label>
                        <input type="text" id="contract-street" class="form-input" required>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-5">
                        <div>
                            <label class="block text-tertiary text-xs uppercase tracking-wider mb-2">Kod pocztowy *</label>
                            <input type="text" id="contract-postal" class="form-input" placeholder="00-000" required>
                        </div>
                        <div>
                            <label class="block text-tertiary text-xs uppercase tracking-wider mb-2">Miasto *</label>
                            <input type="text" id="contract-city" class="form-input" required>
                        </div>
                        <div class="col-span-2 md:col-span-1">
                            <label class="block text-tertiary text-xs uppercase tracking-wider mb-2">Kraj *</label>
                            <input type="text" id="contract-country" class="form-input" value="Polska" required>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                        <div>
                            <label class="block text-tertiary text-xs uppercase tracking-wider mb-2">Email *</label>
                            <input type="email" id="contract-email" class="form-input" required>
                        </div>
                        <div>
                            <label class="block text-tertiary text-xs uppercase tracking-wider mb-2">Telefon</label>
                            <input type="tel" id="contract-phone" class="form-input">
                        </div>
                    </div>

                    <button type="submit" class="btn-primary w-full py-3">
                        Dalej
                        <i class="ph ph-arrow-right"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Contract Signing Screen -->
    <div id="contract-signing-screen" class="hidden min-h-screen flex items-center justify-center p-4 py-12 bg-black">
        <div class="w-full max-w-2xl animate-enter">
            <div class="text-center mb-8">
                <div class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-violet-500/10 border border-violet-500/20 text-violet-400 text-xs font-medium mb-5">
                    <i class="ph ph-signature"></i>
                    Krok 2 z 2
                </div>
                <h1 class="text-2xl font-semibold text-white mb-2 tracking-tight">Podpisanie umowy</h1>
                <p class="text-tertiary text-sm">Pobierz umowę, podpisz ją i prześlij do nas.</p>
            </div>

            <div class="card p-6 md:p-8 mb-4">
                <div class="space-y-4">
                    <!-- Krok 1: Pobierz -->
                    <div class="flex items-start gap-4 p-4 rounded-xl border border-[#1a1a1a] bg-black/30">
                        <div class="w-8 h-8 rounded-full bg-[#00d084]/15 flex items-center justify-center flex-shrink-0 mt-0.5">
                            <span class="text-[#00d084] text-xs font-bold">1</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-white font-medium text-sm mb-1">Pobierz umowę</p>
                            <p class="text-tertiary text-xs mb-3">Dokument PDF z Twoimi danymi</p>
                            <button onclick="generateAndDownloadContract()" class="btn-primary text-sm py-2 px-4">
                                <i class="ph ph-download-simple"></i>
                                Pobierz PDF
                            </button>
                        </div>
                    </div>

                    <!-- Krok 2: Podpisz -->
                    <div class="flex items-start gap-4 p-4 rounded-xl border border-[#1a1a1a]">
                        <div class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center flex-shrink-0 mt-0.5">
                            <span class="text-tertiary text-xs font-bold">2</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-white font-medium text-sm mb-1">Podpisz dokument</p>
                            <p class="text-tertiary text-xs"><a href="https://www.gov.pl/web/podpis-zaufany" target="_blank" class="text-[#00d084] hover:underline">Podpis zaufany (gov.pl)</a> — najszybsza, bezpłatna opcja. Możesz też użyć podpisu kwalifikowanego.</p>
                        </div>
                    </div>

                    <!-- Krok 3: Wyślij -->
                    <div class="flex items-start gap-4 p-4 rounded-xl border border-[#1a1a1a]">
                        <div class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center flex-shrink-0 mt-0.5">
                            <span class="text-tertiary text-xs font-bold">3</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-white font-medium text-sm mb-1">Wyślij podpisaną umowę</p>
                            <p class="text-tertiary text-xs">Prześlij na <a href="mailto:ceo@tomekniedzwiecki.pl" class="text-[#0070f3] hover:underline font-medium">ceo@tomekniedzwiecki.pl</a>. Otrzymasz powiadomienie gdy umowa zostanie zaakceptowana.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div>
                <button onclick="goToProject()" class="btn-secondary w-full py-3">
                    Przejdź do projektu
                </button>
            </div>
        </div>
    </div>

    <!-- Main Project Screen -->
    <div id="project-screen" class="hidden min-h-screen flex flex-col">
        <!-- Mobile Header -->
        <header class="sticky top-0 z-40 bg-black/80 backdrop-blur-xl border-b border-[#1a1a1a] md:hidden">
            <div class="flex items-center justify-between h-14 px-4">
                <div class="flex items-center gap-3">
                    <div class="w-7 h-7 rounded-md bg-white flex items-center justify-center">
                        <span class="text-black text-[10px] font-bold tracking-tight">TN</span>
                    </div>
                    <h1 id="project-title-mobile" class="text-[14px] font-medium text-white tracking-tight truncate max-w-[200px]">Projekt</h1>
                </div>
                <button onclick="toggleMobileMenu()" id="mobile-menu-btn" class="w-9 h-9 flex items-center justify-center rounded-lg hover:bg-[#111] transition-colors">
                    <i class="ph ph-list text-xl text-white"></i>
                </button>
            </div>
        </header>

        <div class="flex flex-1">
            <!-- Sidebar -->
            <aside class="hidden md:flex flex-col w-[220px] min-w-[220px] border-r border-[#1a1a1a] bg-black sticky top-0 h-screen overflow-y-auto">
                <!-- Logo row -->
                <div class="h-14 px-4 flex items-center gap-3 border-b border-[#1a1a1a] flex-shrink-0">
                    <div class="w-7 h-7 rounded-md bg-white flex items-center justify-center flex-shrink-0">
                        <span class="text-black text-[10px] font-bold tracking-tight">TN</span>
                    </div>
                    <h1 id="project-title" class="text-[13px] font-medium text-white tracking-tight truncate">Projekt</h1>
                    <span id="project-status-badge" class="badge badge-success ml-auto flex-shrink-0" style="font-size:10px; padding:2px 8px;">
                        <span class="w-1.5 h-1.5 rounded-full bg-current animate-pulse"></span>
                        Aktywny
                    </span>
                </div>

                <!-- Navigation -->
                <nav class="flex-1 py-4 px-3 space-y-0.5">
                    <button onclick="switchTab('projekt')" data-tab="projekt" class="sidebar-btn active">
                        <i class="ph ph-house-simple"></i> Przegląd
                    </button>
                    <button onclick="switchTab('dokumenty')" data-tab="dokumenty" class="sidebar-btn">
                        <i class="ph ph-file-text"></i> Dokumenty
                    </button>
                    <button onclick="switchTab('produkty')" data-tab="produkty" class="sidebar-btn">
                        <i class="ph ph-package"></i> Produkty
                    </button>
                    <button onclick="switchTab('raporty')" data-tab="raporty" class="sidebar-btn">
                        <i class="ph ph-chart-line-up"></i> Raporty
                    </button>
                    <button onclick="switchTab('branding')" data-tab="branding" class="sidebar-btn">
                        <i class="ph ph-paint-brush"></i> Branding
                    </button>
                    <button onclick="switchTab('strona')" data-tab="strona" class="sidebar-btn">
                        <i class="ph ph-globe"></i> Strona
                    </button>
                    <button onclick="switchTab('materialy')" data-tab="materialy" class="sidebar-btn">
                        <i class="ph ph-folder-open"></i> Materiały
                    </button>
                    <button onclick="switchTab('komentarze')" data-tab="komentarze" class="sidebar-btn relative">
                        <i class="ph ph-chat-circle-text"></i> Komentarze
                        <span id="comments-badge" class="hidden ml-auto bg-[#00d084] text-black text-[10px] font-bold rounded-full min-w-[18px] h-[18px] flex items-center justify-center px-1">0</span>
                    </button>

                    <!-- Etap 2 -->
                    <div class="pt-4 mt-4 border-t border-[#1a1a1a]">
                        <span class="text-[10px] text-[#444] uppercase tracking-wider px-3 mb-2 block">Etap 2</span>
                        <button onclick="switchTab('takedrop')" data-tab="takedrop" class="sidebar-btn">
                            <i class="ph ph-storefront"></i> Konto TakeDrop
                        </button>
                    </div>
                </nav>

                <!-- Footer -->
                <div class="p-4 border-t border-[#1a1a1a]">
                    <a href="mailto:kontakt@tomekniedzwiecki.pl" class="text-tertiary hover:text-secondary text-xs transition-colors">Kontakt</a>
                </div>
            </aside>

            <!-- Mobile Menu Overlay -->
            <div id="mobile-menu" class="hidden fixed inset-0 z-50 md:hidden">
                <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="toggleMobileMenu()"></div>
                <div class="absolute left-0 top-0 bottom-0 w-[260px] bg-black border-r border-[#1a1a1a] animate-slide overflow-y-auto">
                    <div class="p-4 border-b border-[#1a1a1a] flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-7 h-7 rounded-md bg-white flex items-center justify-center">
                                <span class="text-black text-[10px] font-bold">TN</span>
                            </div>
                            <span class="text-[13px] text-zinc-400">Menu</span>
                        </div>
                        <button onclick="toggleMobileMenu()" class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-[#111]">
                            <i class="ph ph-x text-lg text-white"></i>
                        </button>
                    </div>
                    <nav class="py-3 px-3 space-y-0.5" id="mobile-nav">
                        <button onclick="switchTab('projekt');toggleMobileMenu()" data-tab="projekt" class="sidebar-btn active">
                            <i class="ph ph-house-simple"></i> Przegląd
                        </button>
                        <button onclick="switchTab('dokumenty');toggleMobileMenu()" data-tab="dokumenty" class="sidebar-btn">
                            <i class="ph ph-file-text"></i> Dokumenty
                        </button>
                        <button onclick="switchTab('produkty');toggleMobileMenu()" data-tab="produkty" class="sidebar-btn">
                            <i class="ph ph-package"></i> Produkty
                        </button>
                        <button onclick="switchTab('raporty');toggleMobileMenu()" data-tab="raporty" class="sidebar-btn">
                            <i class="ph ph-chart-line-up"></i> Raporty
                        </button>
                        <button onclick="switchTab('branding');toggleMobileMenu()" data-tab="branding" class="sidebar-btn">
                            <i class="ph ph-paint-brush"></i> Branding
                        </button>
                        <button onclick="switchTab('strona');toggleMobileMenu()" data-tab="strona" class="sidebar-btn">
                            <i class="ph ph-globe"></i> Strona
                        </button>
                        <button onclick="switchTab('materialy');toggleMobileMenu()" data-tab="materialy" class="sidebar-btn">
                            <i class="ph ph-folder-open"></i> Materiały
                        </button>
                        <button onclick="switchTab('komentarze');toggleMobileMenu()" data-tab="komentarze" class="sidebar-btn">
                            <i class="ph ph-chat-circle-text"></i> Komentarze
                        </button>
                        <!-- Etap 2 -->
                        <div class="pt-3 mt-3 border-t border-[#1a1a1a]">
                            <span class="text-[10px] text-[#444] uppercase tracking-wider px-3 mb-2 block">Etap 2</span>
                            <button onclick="switchTab('takedrop');toggleMobileMenu()" data-tab="takedrop" class="sidebar-btn">
                                <i class="ph ph-storefront"></i> Konto TakeDrop
                            </button>
                        </div>
                    </nav>
                </div>
            </div>

            <!-- Main Content -->
            <main class="flex-1 min-w-0 px-4 md:px-10 py-8 md:py-10">

            <!-- TAB: Projekt -->
            <div id="tab-projekt" class="tab-panel animate-enter">
                <!-- Progress Overview -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-10">
                    <!-- Progress Card -->
                    <div class="card p-6">
                        <div class="flex items-center gap-6">
                            <div class="relative">
                                <svg class="progress-ring w-[72px] h-[72px]" viewBox="0 0 100 100">
                                    <circle class="progress-ring-bg" cx="50" cy="50" r="42" fill="none" stroke-width="5"/>
                                    <circle id="progress-ring-fill" class="progress-ring-fill" cx="50" cy="50" r="42" fill="none" stroke-width="5" stroke-dasharray="264" stroke-dashoffset="264"/>
                                </svg>
                                <div class="absolute inset-0 flex items-center justify-center">
                                    <span id="progress-percent" class="text-lg font-semibold text-white">0%</span>
                                </div>
                            </div>
                            <div>
                                <p class="text-tertiary text-xs uppercase tracking-wider mb-1">Postęp</p>
                                <p class="text-white text-lg font-semibold tracking-tight"><span id="completed-tasks">0</span><span class="text-tertiary font-normal"> / <span id="total-tasks">0</span> zadań</span></p>
                            </div>
                        </div>
                    </div>

                    <!-- Current Milestone Card -->
                    <div class="card p-6">
                        <p class="text-tertiary text-xs uppercase tracking-wider mb-3">Aktualny etap</p>
                        <p id="current-milestone" class="text-white font-semibold mb-3 leading-tight tracking-tight">-</p>
                        <p class="text-sm"><span class="text-tertiary">Deadline</span> <span class="text-white font-medium" id="current-deadline">-</span></p>
                    </div>

                    <!-- Project Info Card -->
                    <div class="card p-6">
                        <p class="text-tertiary text-xs uppercase tracking-wider mb-3">Projekt</p>
                        <p id="offer-name" class="text-white font-semibold mb-3 leading-tight tracking-tight">-</p>
                        <p class="text-sm"><span class="text-tertiary">Start</span> <span class="text-white font-medium" id="started-at">-</span></p>
                    </div>
                </div>

                <!-- Milestones -->
                <div>
                    <h2 class="section-title">Etapy realizacji</h2>
                    <div id="milestones-container" class="space-y-3">
                        <!-- Milestones rendered here -->
                    </div>
                </div>
            </div>

            <!-- TAB: Dokumenty -->
            <div id="tab-dokumenty" class="tab-panel hidden animate-enter">
                <h2 class="page-title">Dokumenty</h2>

                <!-- Signed Contract Section -->
                <div id="signed-contract-section" class="hidden mb-6">
                    <div class="card p-5 glow-success" style="border-color: rgba(0, 208, 132, 0.2); background: linear-gradient(to right, rgba(0, 208, 132, 0.05), transparent);">
                        <div class="flex items-center justify-between flex-wrap gap-4">
                            <div class="flex items-center gap-4">
                                <div class="w-11 h-11 rounded-xl bg-[#00d084]/10 flex items-center justify-center">
                                    <i class="ph ph-seal-check text-xl text-[#00d084]"></i>
                                </div>
                                <div>
                                    <p class="text-white font-medium">Podpisana umowa</p>
                                    <p class="text-[#00d084] text-sm">Umowa podpisana przez obie strony</p>
                                </div>
                            </div>
                            <a id="signed-contract-download" href="#" target="_blank" class="btn-primary bg-[#00d084] hover:bg-[#00b871]">
                                <i class="ph ph-download-simple"></i>
                                Pobierz
                            </a>
                        </div>
                    </div>
                </div>

                <div id="documents-list" class="space-y-3">
                    <!-- Documents rendered here -->
                </div>

                <div id="documents-empty" class="empty-state">
                    <div class="card p-10 md:p-16 text-center max-w-lg mx-auto" style="border-style: dashed;">
                        <div class="w-16 h-16 mx-auto mb-5 rounded-2xl bg-[#111] border border-[#222] flex items-center justify-center">
                            <i class="ph ph-file-text text-3xl text-[#444]"></i>
                        </div>
                        <h3 class="text-white font-medium text-lg mb-2">Brak dokumentów</h3>
                        <p class="text-tertiary text-sm leading-relaxed">Umowy, faktury i inne ważne dokumenty pojawią się tutaj, gdy zostaną dodane przez zespół.</p>
                    </div>
                </div>
            </div>

            <!-- TAB: Materialy -->
            <div id="tab-materialy" class="tab-panel hidden animate-enter">
                <h2 class="page-title">Materiały</h2>

                <div id="materials-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Materials rendered here -->
                </div>

                <div id="materials-empty" class="empty-state">
                    <div class="card p-10 md:p-16 text-center max-w-lg mx-auto" style="border-style: dashed;">
                        <div class="w-16 h-16 mx-auto mb-5 rounded-2xl bg-[#111] border border-[#222] flex items-center justify-center">
                            <i class="ph ph-folder-open text-3xl text-[#444]"></i>
                        </div>
                        <h3 class="text-white font-medium text-lg mb-2">Brak materiałów</h3>
                        <p class="text-tertiary text-sm leading-relaxed">Pliki projektowe, grafiki i inne materiały będą dostępne tutaj w miarę postępu prac.</p>
                    </div>
                </div>
            </div>

            <!-- TAB: Branding -->
            <div id="tab-branding" class="tab-panel hidden animate-enter">

                <!-- 1. Brand Hero / Info -->
                <div id="branding-hero" class="hidden mb-12">
                    <div class="card overflow-hidden relative">
                        <!-- Glow background driven by brand primary color -->
                        <div id="brand-hero-glow" class="absolute inset-0 opacity-[0.07]" style="background: radial-gradient(ellipse at 50% 0%, var(--brand-primary, #fff) 0%, transparent 70%)"></div>
                        <div class="relative z-10 p-10 md:p-16">
                            <!-- Logo -->
                            <div id="brand-hero-logo" class="mb-8 hidden">
                                <img id="brand-hero-logo-img" src="" alt="" class="max-h-20 mx-auto object-contain rounded-xl">
                            </div>
                            <!-- Name -->
                            <h1 id="brand-hero-name" class="text-5xl md:text-6xl font-bold text-white tracking-tight text-center mb-3"></h1>
                            <!-- Domain pill -->
                            <div id="brand-hero-domain-wrap" class="hidden flex justify-center mb-5">
                                <span id="brand-hero-domain" class="inline-block text-[11px] font-mono tracking-wider px-3 py-1 rounded-full border border-white/10 text-white/40"></span>
                            </div>
                            <!-- Tagline -->
                            <p id="brand-hero-tagline" class="text-xl md:text-2xl text-center font-medium text-white/60 mb-6"></p>
                            <!-- Color strip -->
                            <div id="brand-hero-colors" class="hidden flex justify-center gap-1.5 mb-8">
                                <!-- filled by JS -->
                            </div>
                            <!-- Description -->
                            <p id="brand-hero-description" class="text-tertiary text-sm leading-relaxed max-w-2xl mx-auto text-center"></p>
                        </div>
                    </div>
                </div>
                <div id="branding-hero-empty" class="mb-12">
                    <h2 class="page-title">Branding</h2>
                    <div class="card p-10 text-center" style="border-style: dashed;">
                        <i class="ph ph-paint-brush text-2xl text-[#444] mb-2"></i>
                        <p class="text-tertiary text-sm">Brand kit jest w przygotowaniu</p>
                    </div>
                </div>

                <!-- 2. Galeria (Logo + Mockupy razem) -->
                <div class="mb-12">
                    <h3 class="section-title">Galeria</h3>
                    <div id="branding-gallery" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                        <!-- Logos + Mockups rendered here -->
                    </div>
                    <div id="branding-gallery-empty" class="card p-10 text-center hidden" style="border-style: dashed;">
                        <div class="w-12 h-12 mx-auto mb-3 rounded-xl bg-[#111] border border-[#222] flex items-center justify-center">
                            <i class="ph ph-images text-xl text-[#444]"></i>
                        </div>
                        <p class="text-tertiary text-sm">Grafiki pojawią się tutaj</p>
                    </div>
                </div>

                <!-- 3. Colors -->
                <div class="mb-12">
                    <h3 class="section-title">Paleta kolorów</h3>
                    <div id="branding-colors" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                        <!-- Colors rendered here -->
                    </div>
                    <div id="branding-colors-empty" class="card p-8 text-center hidden" style="border-style: dashed;">
                        <div class="flex justify-center gap-2 mb-3">
                            <div class="w-8 h-8 rounded-full bg-[#1a1a1a] border border-[#222]"></div>
                            <div class="w-8 h-8 rounded-full bg-[#1a1a1a] border border-[#222]"></div>
                            <div class="w-8 h-8 rounded-full bg-[#1a1a1a] border border-[#222]"></div>
                        </div>
                        <p class="text-tertiary text-sm">Paleta kolorów pojawi się tutaj</p>
                    </div>
                </div>

                <!-- 4. Typography -->
                <div class="mb-12">
                    <h3 class="section-title">Typografia</h3>
                    <div id="branding-fonts" class="space-y-4">
                        <!-- Fonts rendered here -->
                    </div>
                    <div id="branding-fonts-empty" class="card p-8 text-center hidden" style="border-style: dashed;">
                        <p class="text-[#333] text-3xl font-bold mb-2">Aa</p>
                        <p class="text-tertiary text-sm">Czcionki pojawią się tutaj</p>
                    </div>
                </div>

                <!-- (Mockupy są teraz w Galeria powyżej) -->

                <!-- 6. Downloads -->
                <div>
                    <h3 class="section-title">Pliki do pobrania</h3>
                    <div id="branding-guidelines" class="space-y-3">
                        <!-- Guidelines rendered here -->
                    </div>
                    <div id="branding-guidelines-empty" class="card p-8 text-center hidden" style="border-style: dashed;">
                        <div class="w-12 h-12 mx-auto mb-3 rounded-xl bg-[#111] border border-[#222] flex items-center justify-center">
                            <i class="ph ph-file-arrow-down text-xl text-[#444]"></i>
                        </div>
                        <p class="text-tertiary text-sm">Pliki do pobrania pojawią się tutaj</p>
                    </div>
                </div>
            </div>

            <!-- TAB: Strona -->
            <div id="tab-strona" class="tab-panel hidden animate-enter">
                <h2 class="page-title">Strona sprzedażowa</h2>

                <div id="sales-page-content" class="hidden">
                    <!-- Deployment-style card -->
                    <div class="card overflow-hidden">
                        <!-- Success header bar -->
                        <div class="px-6 py-4 flex items-center gap-3 border-b border-white/5" style="background: linear-gradient(135deg, rgba(16,185,129,0.06) 0%, transparent 100%);">
                            <div class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></div>
                            <span class="text-emerald-400 text-xs font-medium uppercase tracking-wider">Live</span>
                            <span class="text-zinc-600 text-xs">&middot;</span>
                            <span class="text-zinc-500 text-xs">Strona opublikowana</span>
                        </div>

                        <!-- Main content -->
                        <div class="p-8 md:p-12">
                            <!-- Checkmark animation -->
                            <div class="w-14 h-14 mx-auto mb-6 rounded-full flex items-center justify-center" style="background: linear-gradient(135deg, rgba(16,185,129,0.15) 0%, rgba(16,185,129,0.05) 100%); border: 1px solid rgba(16,185,129,0.2);">
                                <i class="ph ph-check-circle text-2xl text-emerald-400"></i>
                            </div>

                            <div class="text-center mb-8">
                                <h3 class="text-white font-semibold text-lg mb-2">Twoja strona jest gotowa</h3>
                                <p class="text-zinc-500 text-sm">Przygotowałem Twoją stronę sprzedażową. Znajdziesz ją pod linkiem poniżej.</p>
                            </div>

                            <!-- URL bar -->
                            <div class="max-w-lg mx-auto mb-6">
                                <div class="flex items-center gap-2 bg-black/40 border border-white/5 rounded-lg px-4 py-3">
                                    <i class="ph ph-link text-zinc-600 text-sm"></i>
                                    <span id="sales-page-url-display" class="text-zinc-400 text-sm truncate flex-1 font-mono"></span>
                                    <a id="sales-page-link-copy" href="#" onclick="navigator.clipboard.writeText(this.dataset.url); this.querySelector('i').className='ph ph-check text-emerald-400 text-sm'; setTimeout(() => this.querySelector('i').className='ph ph-copy text-zinc-500 text-sm', 1500); return false;" class="flex-shrink-0 p-1 hover:bg-white/5 rounded transition-colors" title="Kopiuj link">
                                        <i class="ph ph-copy text-zinc-500 text-sm"></i>
                                    </a>
                                </div>
                            </div>

                            <!-- CTA button -->
                            <div class="text-center">
                                <a id="sales-page-link" href="#" target="_blank" class="inline-flex items-center gap-2.5 bg-white text-black font-medium px-8 py-3 rounded-lg transition-all text-sm hover:bg-zinc-200">
                                    Otwórz stronę
                                    <i class="ph ph-arrow-square-out"></i>
                                </a>
                            </div>
                        </div>

                        <!-- Footer note -->
                        <div class="px-6 py-3.5 border-t border-white/5 flex items-center gap-2">
                            <i class="ph ph-paint-brush text-amber-500/60 text-xs"></i>
                            <span class="text-zinc-600 text-xs">Grafiki i zdjęcia produktowe zostaną dodane w kolejnym etapie.</span>
                        </div>
                    </div>
                </div>

                <div id="sales-page-empty" class="empty-state">
                    <div class="card p-10 md:p-16 text-center max-w-lg mx-auto" style="border-style: dashed;">
                        <div class="w-16 h-16 mx-auto mb-5 rounded-2xl bg-[#111] border border-[#222] flex items-center justify-center">
                            <i class="ph ph-globe text-3xl text-[#444]"></i>
                        </div>
                        <h3 class="text-white font-medium text-lg mb-2">Strona w przygotowaniu</h3>
                        <p class="text-tertiary text-sm leading-relaxed">Twoja strona sprzedażowa jest w trakcie realizacji. Pojawi się tutaj, gdy będzie gotowa.</p>
                    </div>
                </div>
            </div>

            <!-- TAB: Produkty -->
            <div id="tab-produkty" class="tab-panel hidden animate-enter">
                <h2 class="page-title">Propozycje produktowe</h2>
                <p class="text-tertiary text-sm mb-6">Wybierz produkt, wokół którego zbudujemy Twój sklep i markę.</p>

                <!-- Selected product hero -->
                <div id="product-selected-hero" class="hidden mb-8"></div>

                <div id="products-list" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3">
                    <!-- Products rendered here -->
                </div>

                <div id="products-empty" class="empty-state">
                    <div class="card p-10 md:p-16 text-center max-w-lg mx-auto" style="border-style: dashed;">
                        <div class="w-16 h-16 mx-auto mb-5 rounded-2xl bg-[#111] border border-[#222] flex items-center justify-center">
                            <i class="ph ph-package text-3xl text-[#444]"></i>
                        </div>
                        <h3 class="text-white font-medium text-lg mb-2">Brak produktów</h3>
                        <p class="text-tertiary text-sm leading-relaxed">Propozycje produktowe pojawią się tutaj wkrótce.</p>
                    </div>
                </div>
            </div>

            <!-- TAB: Raporty -->
            <div id="tab-raporty" class="tab-panel hidden animate-enter">
                <h2 class="page-title">Raporty</h2>

                <p class="text-zinc-500 text-sm mb-8 leading-relaxed">Raporty zostały przygotowane przy pomocy AI. Nie są ostatecznym źródłem decyzyjnym a jedynie podpowiedzią.</p>

                <div id="reports-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Reports rendered here -->
                </div>

                <div id="reports-empty" class="empty-state">
                    <div class="card p-10 md:p-16 text-center max-w-lg mx-auto" style="border-style: dashed;">
                        <div class="w-16 h-16 mx-auto mb-5 rounded-2xl bg-[#111] border border-[#222] flex items-center justify-center">
                            <i class="ph ph-chart-line-up text-3xl text-[#444]"></i>
                        </div>
                        <h3 class="text-white font-medium text-lg mb-2">Brak raportów</h3>
                        <p class="text-tertiary text-sm leading-relaxed">Raporty analityczne i wyniki kampanii będą widoczne tutaj po ich wygenerowaniu.</p>
                    </div>
                </div>
            </div>

            <!-- TAB: Komentarze -->
            <div id="tab-komentarze" class="tab-panel hidden animate-enter">
                <h2 class="page-title">Komentarze</h2>

                <div class="max-w-2xl">
                    <div id="comments-list" class="space-y-4 mb-6">
                        <!-- Comments rendered here -->
                    </div>

                    <div id="comments-empty" class="card p-10 text-center mb-6" style="border-style: dashed;">
                        <div class="w-14 h-14 mx-auto mb-4 rounded-2xl bg-[#111] border border-[#222] flex items-center justify-center">
                            <i class="ph ph-chat-circle-text text-2xl text-[#444]"></i>
                        </div>
                        <h3 class="text-white font-medium mb-1">Brak komentarzy</h3>
                        <p class="text-tertiary text-sm">Rozpocznij rozmowę z zespołem poniżej</p>
                    </div>

                    <!-- Add Comment Form -->
                    <div class="card p-5">
                        <textarea id="new-comment" rows="3" class="form-input resize-none mb-4" placeholder="Napisz komentarz..."></textarea>
                        <div class="flex justify-end">
                            <button onclick="postComment()" class="btn-primary">
                                <i class="ph ph-paper-plane-tilt"></i>
                                Wyślij
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB: TakeDrop (Etap 3) -->
            <div id="tab-takedrop" class="tab-panel hidden animate-enter">
                <h2 class="page-title">Konto TakeDrop</h2>

                <div class="max-w-xl">
                    <!-- TakeDrop Info -->
                    <div class="mb-8">
                        <div class="flex items-center gap-3 mb-2">
                            <h3 class="text-[15px] font-medium text-white">TakeDrop</h3>
                            <span class="text-[11px] text-[#666] bg-[#1a1a1a] px-2 py-0.5 rounded">Platforma e-commerce</span>
                        </div>
                        <p class="text-[13px] text-[#666] leading-relaxed">
                            Załóż konto na platformie TakeDrop, aby zarządzać swoim sklepem i produktami.
                        </p>
                    </div>

                    <!-- Features -->
                    <div class="flex gap-6 mb-8 text-[13px]">
                        <div class="flex items-center gap-2">
                            <span class="w-1.5 h-1.5 rounded-full bg-[#50e3c2]"></span>
                            <span class="text-[#888]">21 dni za darmo</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-1.5 h-1.5 rounded-full bg-[#50e3c2]"></span>
                            <span class="text-[#888]">99 zł / miesiąc</span>
                        </div>
                    </div>

                    <!-- CTA Button -->
                    <a href="https://app.takedrop.pl/pay/0f949713-70a6-4968-af37-9400ed886baa" target="_blank" rel="noopener noreferrer"
                       class="inline-flex items-center gap-2 bg-white text-black text-[13px] font-medium px-5 py-2.5 rounded-md hover:bg-[#e5e5e5] transition-colors mb-3">
                        Załóż konto w TakeDrop
                        <i class="ph ph-arrow-up-right text-[14px]"></i>
                    </a>

                    <p class="text-[12px] text-[#555] mb-10">
                        Po założeniu konta wróć tutaj i potwierdź poniżej.
                    </p>

                    <!-- Divider -->
                    <div class="border-t border-[#222] pt-8">
                        <div class="flex items-center justify-between mb-4">
                            <div class="text-[12px] text-[#666]">Dane logowania do TakeDrop</div>
                            <!-- Success state (shown when confirmed) -->
                            <div id="takedrop-success-state" class="hidden flex items-center gap-2">
                                <span class="w-1.5 h-1.5 rounded-full bg-[#50e3c2]"></span>
                                <span class="text-[12px] text-[#50e3c2]">Potwierdzone</span>
                                <span id="takedrop-confirmed-date" class="text-[11px] text-[#555]"></span>
                            </div>
                        </div>

                        <!-- Login form (always visible) -->
                        <div id="takedrop-login-form">
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-[12px] text-[#666] mb-1.5">Email</label>
                                    <input type="email" id="takedrop-client-email" class="w-full bg-transparent border border-[#333] rounded-md px-3 py-2 text-[13px] text-white placeholder-[#555] focus:border-[#666] focus:outline-none transition-colors" placeholder="twoj@email.pl">
                                </div>
                                <div>
                                    <label class="block text-[12px] text-[#666] mb-1.5">Hasło</label>
                                    <input type="password" id="takedrop-client-password" class="w-full bg-transparent border border-[#333] rounded-md px-3 py-2 text-[13px] text-white placeholder-[#555] focus:border-[#666] focus:outline-none transition-colors" placeholder="••••••••">
                                </div>
                            </div>
                            <button id="takedrop-confirm-btn" onclick="confirmTakeDropAccount()" class="bg-white text-black text-[13px] font-medium px-4 py-2 rounded-md hover:bg-[#e5e5e5] transition-colors">
                                Potwierdź założenie konta
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </main>
        </div><!-- /flex -->
    </div>

    <!-- Toast -->
    <!-- Product Selection Confirmation Modal -->
    <div id="product-confirm-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-[#0a0a0a] border border-[#222] rounded-xl w-full max-w-md shadow-2xl">
            <div class="p-6">
                <div id="confirm-product-image" class="w-full aspect-[3/2] rounded-lg bg-[#111] overflow-hidden mb-5"></div>
                <h3 id="confirm-product-name" class="text-white font-semibold text-lg mb-2"></h3>
                <p class="text-[#888] text-sm leading-relaxed">Czy na pewno wybierasz ten produkt? Wokół niego zbudujemy Twój sklep i markę.</p>
            </div>
            <div class="flex gap-3 px-6 py-4 border-t border-[#222]">
                <button onclick="closeConfirmModal()" class="flex-1 text-[#888] hover:text-white border border-[#333] hover:border-[#555] py-2.5 rounded-lg text-sm font-medium transition-colors">
                    Anuluj
                </button>
                <button onclick="confirmProductSelection()" class="flex-1 bg-emerald-500 hover:bg-emerald-400 text-white py-2.5 rounded-lg text-sm font-semibold transition-colors">
                    Tak, wybieram
                </button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-6 right-6 z-50 hidden">
        <div class="bg-[#111] border border-[#222] text-white pl-4 pr-5 py-3 rounded-lg shadow-2xl flex items-center gap-3 animate-slide">
            <i id="toast-icon" class="ph ph-check-circle text-[#00d084]"></i>
            <span id="toast-message" class="text-sm">Sukces</span>
        </div>
    </div>

    <!-- Image Lightbox -->
    <div id="image-lightbox" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center p-6 z-[60] cursor-pointer" onclick="closeImageLightbox()">
        <img id="lightbox-img" src="" class="max-w-full max-h-full object-contain rounded-lg shadow-2xl" onclick="event.stopPropagation()">
        <button onclick="closeImageLightbox()" class="absolute top-4 right-4 w-10 h-10 bg-white/10 hover:bg-white/20 text-white rounded-full flex items-center justify-center transition-colors">
            <i class="ph ph-x text-xl"></i>
        </button>
    </div>

    <script>
        function openImageLightbox(url) {
            document.getElementById('lightbox-img').src = url;
            document.getElementById('image-lightbox').classList.remove('hidden');
        }
        function closeImageLightbox() {
            document.getElementById('image-lightbox').classList.add('hidden');
            document.getElementById('lightbox-img').src = '';
        }

        const SUPABASE_URL = 'https://yxmavwkwnfuphjqbelws.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl4bWF2d2t3bmZ1cGhqcWJlbHdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NjQyNTUsImV4cCI6MjA4NDM0MDI1NX0.XeR0Fc7OFn6YbNJrOKTBEj36JtmLISZTM87y4ai9340';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let workflow = null;
        let milestones = [];
        let tasks = [];
        let documents = [];
        let materials = [];
        let brandingItems = [];
        let products = [];

        let reports = [];
        let comments = [];
        let isAuthenticated = false;

        const CONTRACT_TEMPLATES = {
            '30bf199b-8bc1-4810-8716-43dbffeb9113': '/umowy/umowa-budowa-sklepu.html',
            'bc5212fd-3f57-46a8-a2e9-07c030e97a3f': '/umowy/umowa-mentoring-ai.html'
        };

        function formatPrice(v) {
            const n = parseFloat(v);
            if (isNaN(n)) return '0 zł';
            return n.toLocaleString('pl-PL', { minimumFractionDigits: 0, maximumFractionDigits: 2 }) + ' zł';
        }

        let clientContractHtml = null;

        async function prepareContractHtml() {
            if (clientContractHtml) return;
            const templateUrl = CONTRACT_TEMPLATES[workflow.offer_id];
            if (!templateUrl) return;
            try {
                const response = await fetch(templateUrl);
                if (!response.ok) throw new Error('Nie mozna pobrac szablonu');
                let html = await response.text();

                const today = new Date().toLocaleDateString('pl-PL', { day: 'numeric', month: 'long', year: 'numeric' });
                const startDate = workflow.started_at ? new Date(workflow.started_at).toLocaleDateString('pl-PL') : today;
                const adresParts = [workflow.client_street, [workflow.client_postal_code, workflow.client_city].filter(Boolean).join(' ')].filter(Boolean).join(', ');
                const firmaLinia = workflow.customer_company ? (' / ' + workflow.customer_company) : '';

                const variables = {
                    '{{imie_nazwisko}}': workflow.customer_name || '',
                    '{{firma}}': workflow.customer_company || '',
                    '{{firma_linia}}': firmaLinia,
                    '{{nip}}': workflow.client_nip || '',
                    '{{adres}}': adresParts,
                    '{{nr_umowy}}': workflow.contract_number || (workflow.id ? workflow.id.substring(0, 8).toUpperCase() : ''),
                    '{{data_zawarcia}}': today,
                    '{{ulica}}': workflow.client_street || '',
                    '{{miasto}}': workflow.client_city || '',
                    '{{kod_pocztowy}}': workflow.client_postal_code || '',
                    '{{kraj}}': workflow.client_country || 'Polska',
                    '{{pesel}}': workflow.client_pesel || '',
                    '{{dowod}}': workflow.client_id_number || '',
                    '{{nr_dowodu}}': workflow.client_id_number || '',
                    '{{email}}': workflow.customer_email || '',
                    '{{telefon}}': workflow.customer_phone || '',
                    '{{nazwa_oferty}}': workflow.offer_name || '',
                    '{{kwota}}': formatPrice(workflow.amount),
                    '{{cena}}': formatPrice(workflow.amount),
                    '{{data}}': today,
                    '{{data_dzis}}': today,
                    '{{data_rozpoczecia}}': startDate
                };

                Object.entries(variables).forEach(([key, value]) => {
                    html = html.replace(new RegExp(key.replace(/[{}]/g, '\\$&'), 'g'), value);
                });

                const clientName = workflow.customer_name?.trim() || 'klient';
                const pdfTitle = `Umowa_${clientName.replace(/\s+/g, '_')}`;
                html = html.replace(/<title>[^<]*<\/title>/, `<title>${pdfTitle}</title>`);

                clientContractHtml = html;
            } catch (err) {
                console.error('Error preparing contract:', err);
            }
        }

        function generateAndDownloadContract() {
            if (!clientContractHtml) {
                showToast('Umowa nie jest jeszcze gotowa, spróbuj ponownie', 'error');
                return;
            }
            const blob = new Blob([clientContractHtml], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const win = window.open(url, '_blank');
            if (win) {
                win.onload = () => { URL.revokeObjectURL(url); win.print(); };
            } else {
                URL.revokeObjectURL(url);
                showToast('Odblokuj wyskakujące okna w przeglądarce', 'error');
            }
        }

        function getAuthKey() {
            return `auth_${getToken()}`;
        }

        function checkSavedAuth() {
            const saved = localStorage.getItem(getAuthKey());
            if (!saved) return false;
            try {
                const { expires } = JSON.parse(saved);
                if (Date.now() < expires) return true;
                localStorage.removeItem(getAuthKey());
            } catch (e) { localStorage.removeItem(getAuthKey()); }
            return false;
        }

        function saveAuth() {
            localStorage.setItem(getAuthKey(), JSON.stringify({ expires: Date.now() + 7 * 24 * 60 * 60 * 1000 }));
        }

        function getToken() {
            const path = window.location.pathname;
            const match = path.match(/\/projekt\/([a-f0-9]+)/i);
            return match ? match[1] : null;
        }

        function showScreen(screenName) {
            ['loading', 'set-password', 'password', 'not-found', 'contract-data', 'contract-signing', 'project'].forEach(name => {
                const el = document.getElementById(`${name}-screen`);
                if (el) el.classList.toggle('hidden', name !== screenName);
            });
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toast-icon');
            const msg = document.getElementById('toast-message');

            icon.className = `ph ph-${type === 'success' ? 'check-circle text-emerald-400' : type === 'error' ? 'x-circle text-red-400' : 'info text-blue-400'}`;
            msg.textContent = message;

            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }

        // PESEL validation
        function validatePesel(pesel) {
            if (!/^[0-9]{11}$/.test(pesel)) return { valid: false, error: 'PESEL musi miec 11 cyfr.' };
            const weights = [1, 3, 7, 9, 1, 3, 7, 9, 1, 3];
            let sum = 0;
            for (let i = 0; i < 10; i++) sum += parseInt(pesel[i]) * weights[i];
            if ((10 - (sum % 10)) % 10 !== parseInt(pesel[10])) return { valid: false, error: 'Nieprawidlowy PESEL.' };
            return { valid: true };
        }

        // ID validation
        function validateIdNumber(idNumber) {
            const id = idNumber.toUpperCase().replace(/\s/g, '');
            if (!/^[A-Z]{3}[0-9]{6}$/.test(id)) return { valid: false, error: 'Format: 3 litery + 6 cyfr.' };
            return { valid: true };
        }

        async function loadProject() {
            const token = getToken();
            if (!token) { showScreen('not-found'); return; }

            const { data: workflowData, error } = await supabaseClient
                .from('workflows')
                .select('*')
                .eq('unique_token', token)
                .single();

            if (error || !workflowData) { showScreen('not-found'); return; }
            workflow = workflowData;

            if (!workflow.client_password_hash) { showScreen('set-password'); return; }
            if (!isAuthenticated && checkSavedAuth()) { isAuthenticated = true; }
            if (!isAuthenticated) { showScreen('password'); return; }

            await logAccess();

            // Contract flow
            if (workflow.contract_seller_signed_url || workflow.contract_status === 'signed') {
                // Continue to project
            } else if (workflow.contract_status === 'pending_data') {
                prefillContractForm();
                showScreen('contract-data');
                return;
            } else if (['data_filled', 'pending_signature'].includes(workflow.contract_status)) {
                prepareContractHtml();
                showScreen('contract-signing');
                return;
            }

            await loadAllData();
            renderProject();
            showScreen('project');

            // Handle hash in URL (e.g. #raporty from email link)
            const hash = window.location.hash.replace('#', '');
            if (hash && document.getElementById(`tab-${hash}`)) {
                switchTab(hash);
            }
        }

        async function loadAllData() {
            const [milestonesRes, tasksRes, docsRes, matsRes, brandRes, prodsRes, repsRes, comsRes] = await Promise.all([
                supabaseClient.from('workflow_milestones').select('*').eq('workflow_id', workflow.id).order('milestone_index'),
                supabaseClient.from('workflow_tasks').select('*').eq('workflow_id', workflow.id).order('task_index'),
                supabaseClient.from('workflow_documents').select('*').eq('workflow_id', workflow.id).eq('visible_to_client', true).order('uploaded_at', { ascending: false }),
                supabaseClient.from('workflow_materials').select('*').eq('workflow_id', workflow.id).eq('visible_to_client', true).order('uploaded_at', { ascending: false }),
                supabaseClient.from('workflow_branding').select('*').eq('workflow_id', workflow.id).order('sort_order'),
                supabaseClient.from('workflow_products').select('*').is('workflow_id', null).eq('visible_to_client', true).eq('is_active', true).order('created_at', { ascending: false }),
                supabaseClient.from('workflow_reports').select('*').eq('workflow_id', workflow.id).eq('visible_to_client', true).order('created_at', { ascending: false }),
                supabaseClient.from('workflow_comments').select('*').eq('workflow_id', workflow.id).order('created_at', { ascending: true })
            ]);

            milestones = milestonesRes.data || [];
            tasks = tasksRes.data || [];
            documents = docsRes.data || [];
            materials = matsRes.data || [];
            brandingItems = brandRes.data || [];
            products = prodsRes.data || [];
            reports = repsRes.data || [];
            comments = comsRes.data || [];

            // Update comments badge after loading
            updateCommentsBadge();
        }

        async function logAccess() {
            try {
                await supabaseClient.from('workflow_access_log').insert({ workflow_id: workflow.id, user_agent: navigator.userAgent });
            } catch (e) {}
        }

        // Password functions
        async function setPassword(e) {
            e.preventDefault();
            const password = document.getElementById('set-password-input').value;
            const confirm = document.getElementById('set-password-confirm').value;

            if (password !== confirm) { showToast('Hasla nie pasuja', 'error'); return; }
            if (password.length < 6) { showToast('Haslo za krotkie', 'error'); return; }

            const hash = dcodeIO.bcrypt.hashSync(password, 10);
            const { error } = await supabaseClient.from('workflows').update({ client_password_hash: hash }).eq('id', workflow.id);

            if (error) { showToast('Blad zapisu', 'error'); return; }

            workflow.client_password_hash = hash;
            isAuthenticated = true;
            saveAuth();
            loadProject();
        }
        window.setPassword = setPassword;

        async function checkPassword(e) {
            e.preventDefault();
            const password = document.getElementById('password-input').value;

            if (dcodeIO.bcrypt.compareSync(password, workflow.client_password_hash)) {
                isAuthenticated = true;
                saveAuth();
                loadProject();
            } else {
                showToast('Nieprawidlowe haslo', 'error');
            }
        }
        window.checkPassword = checkPassword;

        // Contract functions
        function prefillContractForm() {
            document.getElementById('contract-name').value = workflow.customer_name || '';
            document.getElementById('contract-company').value = workflow.customer_company || '';
            document.getElementById('contract-email').value = workflow.customer_email || '';
            document.getElementById('contract-phone').value = workflow.customer_phone || '';
            document.getElementById('contract-pesel').value = workflow.client_pesel || '';
            document.getElementById('contract-id').value = workflow.client_id_number || '';
            document.getElementById('contract-nip').value = workflow.client_nip || '';
            document.getElementById('contract-street').value = workflow.client_street || '';
            document.getElementById('contract-postal').value = workflow.client_postal_code || '';
            document.getElementById('contract-city').value = workflow.client_city || '';
            document.getElementById('contract-country').value = workflow.client_country || 'Polska';
        }

        async function submitContractData(e) {
            e.preventDefault();

            const pesel = document.getElementById('contract-pesel').value;
            const idNumber = document.getElementById('contract-id').value;

            const peselResult = validatePesel(pesel);
            if (!peselResult.valid) {
                document.getElementById('pesel-error').textContent = peselResult.error;
                document.getElementById('pesel-error').classList.remove('hidden');
                return;
            }
            document.getElementById('pesel-error').classList.add('hidden');

            const idResult = validateIdNumber(idNumber);
            if (!idResult.valid) {
                document.getElementById('id-error').textContent = idResult.error;
                document.getElementById('id-error').classList.remove('hidden');
                return;
            }
            document.getElementById('id-error').classList.add('hidden');

            const updateData = {
                customer_name: document.getElementById('contract-name').value,
                customer_company: document.getElementById('contract-company').value,
                customer_email: document.getElementById('contract-email').value,
                customer_phone: document.getElementById('contract-phone').value,
                client_pesel: pesel,
                client_id_number: idNumber.toUpperCase(),
                client_nip: document.getElementById('contract-nip').value,
                client_street: document.getElementById('contract-street').value,
                client_postal_code: document.getElementById('contract-postal').value,
                client_city: document.getElementById('contract-city').value,
                client_country: document.getElementById('contract-country').value,
                contract_status: 'data_filled',
                contract_data_filled_at: new Date().toISOString()
            };

            const { error } = await supabaseClient.from('workflows').update(updateData).eq('id', workflow.id);

            if (error) { showToast('Blad zapisu', 'error'); return; }

            Object.assign(workflow, updateData);
            showScreen('contract-signing');
        }
        window.submitContractData = submitContractData;

        async function goToProject() {
            await loadAllData();
            renderProject();
            showScreen('project');
        }
        window.goToProject = goToProject;

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.sidebar-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tabName);
            });
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.add('hidden');
            });
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');

            // Load tab-specific data
            switch(tabName) {
                case 'dokumenty': renderDocuments(); break;
                case 'materialy': renderMaterials(); break;
                case 'branding': renderBranding(); break;
                case 'strona': renderSalesPage(); break;
                case 'produkty': renderProducts(); break;
                case 'raporty': renderReports(); break;
                case 'komentarze':
                    renderComments();
                    markCommentsAsRead();
                    break;
                case 'takedrop':
                    renderTakeDrop();
                    break;
            }
        }
        window.switchTab = switchTab;

        // TakeDrop functions
        let takeDropData = null;

        async function loadTakeDrop() {
            try {
                const { data, error } = await supabaseClient
                    .from('workflow_takedrop')
                    .select('is_active, account_created, account_created_at')
                    .eq('workflow_id', workflow.id)
                    .maybeSingle();

                if (error) throw error;
                takeDropData = data;

                // Show/hide TakeDrop tab based on is_active
                const takedropBtns = document.querySelectorAll('[data-tab="takedrop"]');
                const etap2Divs = document.querySelectorAll('[data-tab="takedrop"]');
                etap2Divs.forEach(btn => {
                    const parent = btn.closest('div.pt-4, div.pt-3');
                    if (parent) {
                        parent.style.display = (takeDropData && takeDropData.is_active) ? '' : 'none';
                    }
                });

                renderTakeDrop();
            } catch (err) {
                console.error('Error loading TakeDrop:', err);
            }
        }

        function renderTakeDrop() {
            const successState = document.getElementById('takedrop-success-state');
            const confirmedDate = document.getElementById('takedrop-confirmed-date');
            const emailInput = document.getElementById('takedrop-client-email');
            const passwordInput = document.getElementById('takedrop-client-password');
            const confirmBtn = document.getElementById('takedrop-confirm-btn');

            if (!successState) return;

            if (takeDropData && takeDropData.account_created) {
                successState.classList.remove('hidden');
                if (confirmedDate && takeDropData.account_created_at) {
                    confirmedDate.textContent = new Date(takeDropData.account_created_at).toLocaleDateString('pl-PL');
                }
                // Pre-fill fields with existing data
                if (emailInput) emailInput.value = takeDropData.account_email || '';
                if (passwordInput) passwordInput.value = takeDropData.account_password || '';
                // Change button text
                if (confirmBtn) confirmBtn.textContent = 'Zaktualizuj dane';
            } else {
                successState.classList.add('hidden');
                if (confirmBtn) confirmBtn.textContent = 'Potwierdź założenie konta';
            }
        }

        async function confirmTakeDropAccount() {
            const emailInput = document.getElementById('takedrop-client-email');
            const passwordInput = document.getElementById('takedrop-client-password');

            const email = emailInput?.value?.trim();
            const password = passwordInput?.value;

            if (!email) {
                showToast('Podaj email do konta TakeDrop', 'error');
                emailInput?.focus();
                return;
            }

            if (!password) {
                showToast('Podaj hasło do konta TakeDrop', 'error');
                passwordInput?.focus();
                return;
            }

            const isUpdate = takeDropData && takeDropData.account_created;

            try {
                const updateData = {
                    account_email: email,
                    account_password: password,
                    account_created: true
                };

                // Only set account_created_at on first confirmation
                if (!isUpdate) {
                    updateData.account_created_at = new Date().toISOString();
                }

                const { error } = await supabaseClient
                    .from('workflow_takedrop')
                    .update(updateData)
                    .eq('workflow_id', workflow.id);

                if (error) throw error;

                takeDropData = {
                    ...takeDropData,
                    account_email: email,
                    account_password: password,
                    account_created: true,
                    account_created_at: takeDropData?.account_created_at || new Date().toISOString()
                };
                renderTakeDrop();
                showToast(isUpdate ? 'Dane zaktualizowane' : 'Dziękujemy za potwierdzenie!', 'success');

            } catch (err) {
                console.error('Error confirming TakeDrop:', err);
                showToast('Błąd potwierdzenia', 'error');
            }
        }
        window.confirmTakeDropAccount = confirmTakeDropAccount;

        // Mobile menu toggle
        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            menu.classList.toggle('hidden');
        }
        window.toggleMobileMenu = toggleMobileMenu;

        // Comments badge - track unread team comments for client
        function getLastSeenKey() {
            return `comments_last_seen_${workflow?.id || 'unknown'}`;
        }

        function updateCommentsBadge() {
            const badge = document.getElementById('comments-badge');
            if (!badge || !workflow) return;

            const lastSeen = localStorage.getItem(getLastSeenKey());
            const lastSeenDate = lastSeen ? new Date(lastSeen) : new Date(0);

            // Count team comments newer than last seen
            const unreadCount = comments.filter(c =>
                c.author_type === 'team' && new Date(c.created_at) > lastSeenDate
            ).length;

            if (unreadCount > 0) {
                badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        function markCommentsAsRead() {
            if (!workflow) return;
            localStorage.setItem(getLastSeenKey(), new Date().toISOString());
            const badge = document.getElementById('comments-badge');
            if (badge) badge.classList.add('hidden');
        }

        // Render functions
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            return new Date(dateStr).toLocaleDateString('pl-PL', { day: 'numeric', month: 'short', year: 'numeric' });
        }

        function formatDateTime(dateStr) {
            if (!dateStr) return '';
            return new Date(dateStr).toLocaleDateString('pl-PL', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
        }

        function renderProject() {
            // Header
            document.getElementById('project-title').textContent = workflow.offer_name || 'Projekt';
            const mobileTitle = document.getElementById('project-title-mobile');
            if (mobileTitle) mobileTitle.textContent = workflow.offer_name || 'Projekt';
            document.getElementById('offer-name').textContent = workflow.offer_name || '-';
            document.getElementById('started-at').textContent = formatDate(workflow.started_at);

            // Status
            const statusBadge = document.getElementById('project-status-badge');
            const statusConfig = {
                active: { class: 'badge-emerald', text: 'Aktywny' },
                completed: { class: 'badge-blue', text: 'Ukonczony' },
                paused: { class: 'badge-amber', text: 'Wstrzymany' },
                cancelled: { class: 'badge-red', text: 'Anulowany' }
            };
            const status = statusConfig[workflow.status] || statusConfig.active;
            statusBadge.className = `badge ${status.class}`;
            statusBadge.innerHTML = `<span class="w-1.5 h-1.5 rounded-full bg-current"></span>${status.text}`;

            // Progress
            const totalTasks = tasks.length;
            const completedTasks = tasks.filter(t => t.completed).length;
            const progressPercent = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

            document.getElementById('progress-percent').textContent = progressPercent + '%';
            document.getElementById('completed-tasks').textContent = completedTasks;
            document.getElementById('total-tasks').textContent = totalTasks;

            // Progress ring
            const ring = document.getElementById('progress-ring-fill');
            const circumference = 264;
            ring.style.strokeDashoffset = circumference - (progressPercent / 100 * circumference);

            // Current milestone
            const currentMilestone = milestones.find(m => m.status === 'in_progress');
            document.getElementById('current-milestone').textContent = currentMilestone ? currentMilestone.title : 'Brak';
            document.getElementById('current-deadline').textContent = currentMilestone ? formatDate(currentMilestone.deadline) : '-';

            // Signed contract
            if (workflow.contract_seller_signed_url) {
                document.getElementById('signed-contract-section').classList.remove('hidden');
                document.getElementById('signed-contract-download').href = workflow.contract_seller_signed_url;
            }

            // Milestones
            renderMilestones();

            // Show/hide Produkty tab based on sharing
            const produktyBtns = document.querySelectorAll('[data-tab="produkty"]');
            produktyBtns.forEach(btn => {
                btn.style.display = workflow.products_shared_at ? '' : 'none';
            });

            // Hide Dokumenty tab for Budowa sklepu starter
            const STARTER_OFFER_ID = '6ee10c3a-f8c7-409e-8570-8eff29e2b759';
            const dokumentyBtns = document.querySelectorAll('[data-tab="dokumenty"]');
            dokumentyBtns.forEach(btn => {
                btn.style.display = workflow.offer_id === STARTER_OFFER_ID ? 'none' : '';
            });

            // Load TakeDrop (Etap 3)
            loadTakeDrop();
        }

        function renderMilestones() {
            const container = document.getElementById('milestones-container');

            container.innerHTML = milestones.map((milestone, index) => {
                const milestoneTasks = tasks.filter(t => t.milestone_id === milestone.id);
                const completedCount = milestoneTasks.filter(t => t.completed).length;
                const totalCount = milestoneTasks.length;
                const progressPercent = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;

                const isActive = milestone.status === 'in_progress';
                const isCompleted = milestone.status === 'completed';

                return `
                    <div class="card milestone-card ${isActive ? 'active' : ''} ${isCompleted ? 'completed' : ''} overflow-hidden">
                        <div class="p-4 cursor-pointer" onclick="toggleMilestone('${milestone.id}')">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 rounded-lg flex items-center justify-center text-sm font-medium ${
                                        isCompleted ? 'bg-emerald-500/10 text-emerald-400' :
                                        isActive ? 'bg-white/10 text-white' :
                                        'bg-zinc-800 text-zinc-500'
                                    }">
                                        ${isCompleted ? '<i class="ph ph-check text-xs"></i>' : index + 1}
                                    </div>
                                    <div>
                                        <h3 class="font-medium ${isCompleted || isActive ? 'text-white' : 'text-zinc-400'}">${milestone.title}</h3>
                                        <p class="text-tertiary text-xs">${milestone.deadline ? `${formatDate(milestone.start_date)} - ${formatDate(milestone.deadline)}` : ''}</p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-4">
                                    <div class="text-right hidden sm:block">
                                        <p class="text-secondary text-xs">${completedCount}/${totalCount}</p>
                                        <div class="w-20 h-1.5 bg-zinc-800 rounded-full overflow-hidden mt-1">
                                            <div class="h-full rounded-full ${isCompleted ? 'bg-emerald-500' : 'bg-white'}" style="width: ${progressPercent}%"></div>
                                        </div>
                                    </div>
                                    <i class="ph ph-caret-down text-zinc-500 transition-transform" id="chevron-${milestone.id}"></i>
                                </div>
                            </div>
                        </div>

                        <div id="content-${milestone.id}" class="hidden border-t border-default">
                            <div class="p-4 space-y-2">
                                ${milestoneTasks.map(task => `
                                    <div class="flex items-center gap-3 py-2">
                                        <div class="w-5 h-5 rounded flex items-center justify-center ${task.completed ? 'bg-emerald-500' : 'border border-zinc-700'}">
                                            ${task.completed ? '<i class="ph ph-check text-white text-xs"></i>' : ''}
                                        </div>
                                        <span class="${task.completed ? 'text-zinc-500 line-through' : 'text-white'}">${task.title}</span>
                                        <span class="badge text-[10px] px-2 py-1 responsible-${task.responsible || 'team'}">${
                                            task.responsible === 'client' ? 'Ty' : task.responsible === 'shared' ? 'Wspólnie' : 'Tomasz Niedźwiecki'
                                        }</span>
                                    </div>
                                `).join('')}
                                ${milestoneTasks.length === 0 ? '<p class="text-tertiary text-sm py-2">Brak zadan</p>' : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleMilestone(id) {
            const content = document.getElementById(`content-${id}`);
            const chevron = document.getElementById(`chevron-${id}`);
            content.classList.toggle('hidden');
            chevron.style.transform = content.classList.contains('hidden') ? '' : 'rotate(180deg)';
        }
        window.toggleMilestone = toggleMilestone;

        function renderDocuments() {
            const container = document.getElementById('documents-list');
            const empty = document.getElementById('documents-empty');
            const hasSignedContract = workflow.contract_seller_signed_url;

            if (documents.length === 0 && !hasSignedContract) {
                container.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }

            empty.classList.add('hidden');

            if (documents.length === 0) {
                container.innerHTML = '';
                return;
            }
            container.innerHTML = documents.map(d => `
                <div class="card card-hover p-4 flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-lg bg-red-500/10 flex items-center justify-center">
                            <i class="ph ph-file-pdf text-red-400"></i>
                        </div>
                        <div>
                            <p class="text-white font-medium">${d.title}</p>
                            <p class="text-tertiary text-xs">${d.category || 'Dokument'} • ${formatDate(d.uploaded_at)}</p>
                        </div>
                    </div>
                    <a href="${d.file_url}" target="_blank" class="text-white hover:text-zinc-300 p-2">
                        <i class="ph ph-download-simple text-lg"></i>
                    </a>
                </div>
            `).join('');
        }

        function renderMaterials() {
            const container = document.getElementById('materials-grid');
            const empty = document.getElementById('materials-empty');

            if (materials.length === 0) {
                container.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }

            empty.classList.add('hidden');
            const fileIcons = { pdf: 'file-pdf', doc: 'file-doc', docx: 'file-doc', jpg: 'file-image', jpeg: 'file-image', png: 'file-image', gif: 'file-image', svg: 'file-image', mp4: 'file-video', zip: 'file-zip' };

            container.innerHTML = materials.map(m => `
                <div class="card card-hover p-4">
                    <div class="flex items-start gap-3">
                        <div class="w-10 h-10 rounded-lg bg-cyan-500/10 flex items-center justify-center flex-shrink-0">
                            <i class="ph ph-${fileIcons[m.file_type?.toLowerCase()] || 'file'} text-cyan-400"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-white font-medium truncate">${m.title}</p>
                            ${m.description ? `<p class="text-tertiary text-xs line-clamp-2 mt-1">${m.description}</p>` : ''}
                            <p class="text-tertiary text-xs mt-2">${m.category || 'Plik'}</p>
                        </div>
                    </div>
                    <a href="${m.file_url}" target="_blank" class="mt-3 block text-center bg-zinc-800 hover:bg-zinc-700 text-white py-2 rounded-lg text-sm transition-colors">
                        Pobierz
                    </a>
                </div>
            `).join('');
        }

        const loadedFontsClient = new Set();
        function loadGoogleFontClient(fontName, weights) {
            const key = fontName + weights.join(',');
            if (loadedFontsClient.has(key)) return;
            loadedFontsClient.add(key);
            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = `https://fonts.googleapis.com/css2?family=${encodeURIComponent(fontName)}:wght@${weights.join(';')}&display=swap`;
            document.head.appendChild(link);
        }

        function parseBrandNotes(notes) {
            if (!notes) return {};
            try { return JSON.parse(notes); } catch(e) { return {}; }
        }

        function hexToRgbClient(hex) {
            const r = parseInt(hex.slice(1,3), 16);
            const g = parseInt(hex.slice(3,5), 16);
            const b = parseInt(hex.slice(5,7), 16);
            return `${r}, ${g}, ${b}`;
        }

        const clientRoleLabels = { primary: 'Primary', secondary: 'Secondary', accent: 'Accent', neutral: 'Neutral' };
        const clientVariantLabels = { main: 'Główne', dark: 'Ciemne tło', light: 'Jasne tło', mono: 'Mono', favicon: 'Favicon' };
        const clientFontRoleLabels = { heading: 'Nagłówki', body: 'Tekst', accent: 'Akcent' };

        function renderBranding() {
            const brandInfo = brandingItems.find(b => b.type === 'brand_info');
            const logos = brandingItems.filter(b => b.type === 'logo');
            const colors = brandingItems.filter(b => b.type === 'color');
            const fonts = brandingItems.filter(b => b.type === 'font');
            const mockups = brandingItems.filter(b => b.type === 'mockup');
            const guidelines = brandingItems.filter(b => b.type === 'guideline');

            const hasContent = brandInfo || logos.length > 0 || colors.length > 0 || fonts.length > 0;

            // Brand Hero
            const heroEl = document.getElementById('branding-hero');
            const heroEmpty = document.getElementById('branding-hero-empty');
            if (brandInfo) {
                const info = parseBrandNotes(brandInfo.value);
                heroEmpty.classList.add('hidden');
                heroEl.classList.remove('hidden');

                // Apply brand primary color as CSS variable for glow
                const primaryColor = colors.find(c => { const m = parseBrandNotes(c.notes); return m.role === 'primary'; });
                if (primaryColor) {
                    heroEl.querySelector('.card').style.setProperty('--brand-primary', primaryColor.value);
                }

                // Apply heading font to brand name
                const headingFont = fonts.find(f => f.value === 'heading');
                const nameEl = document.getElementById('brand-hero-name');
                nameEl.textContent = info.name || '';
                if (headingFont) {
                    const meta = parseBrandNotes(headingFont.notes);
                    loadGoogleFontClient(headingFont.title, meta.weights || ['400','700']);
                    nameEl.style.fontFamily = `'${headingFont.title}', sans-serif`;
                }

                // Domain pill
                const domainWrap = document.getElementById('brand-hero-domain-wrap');
                const domainEl = document.getElementById('brand-hero-domain');
                if (info.domain) {
                    domainEl.textContent = info.domain;
                    if (primaryColor) domainEl.style.borderColor = primaryColor.value + '30';
                    domainWrap.classList.remove('hidden');
                } else {
                    domainWrap.classList.add('hidden');
                }

                document.getElementById('brand-hero-tagline').textContent = info.tagline || '';
                document.getElementById('brand-hero-description').textContent = info.description || '';

                // Color strip in hero
                const colorStrip = document.getElementById('brand-hero-colors');
                if (colors.length > 0) {
                    colorStrip.classList.remove('hidden');
                    colorStrip.innerHTML = colors.map(c =>
                        `<div class="w-8 h-8 md:w-10 md:h-10 rounded-full border border-white/10" style="background:${c.value}" title="${c.title}"></div>`
                    ).join('');
                } else {
                    colorStrip.classList.add('hidden');
                }

                // Show main logo in hero if available
                const mainLogo = logos.find(l => { const m = parseBrandNotes(l.notes); return m.variant === 'main'; }) || logos[0];
                const heroLogo = document.getElementById('brand-hero-logo');
                if (mainLogo) {
                    heroLogo.classList.remove('hidden');
                    document.getElementById('brand-hero-logo-img').src = mainLogo.file_url;
                    document.getElementById('brand-hero-logo-img').alt = mainLogo.title;
                } else {
                    heroLogo.classList.add('hidden');
                }
            } else if (hasContent) {
                heroEmpty.classList.add('hidden');
                heroEl.classList.add('hidden');
            } else {
                heroEmpty.classList.remove('hidden');
                heroEl.classList.add('hidden');
            }

            // Gallery (logos + mockups combined)
            const galleryContainer = document.getElementById('branding-gallery');
            const galleryEmpty = document.getElementById('branding-gallery-empty');
            const galleryItems = [...logos, ...mockups];
            if (galleryItems.length > 0) {
                galleryEmpty.classList.add('hidden');
                galleryContainer.innerHTML = galleryItems.map(item => {
                    const isLogo = item.type === 'logo';
                    const meta = parseBrandNotes(item.notes);
                    if (isLogo) {
                        const bgClass = meta.variant === 'light' ? 'bg-white' : 'bg-[#0a0a0a]';
                        return `
                        <div class="${bgClass} aspect-square flex items-center justify-center cursor-pointer hover:opacity-80 transition-all rounded-xl overflow-hidden" onclick="openImageLightbox('${item.file_url}')">
                            <img src="${item.file_url}" alt="${item.title}" class="max-w-[80%] max-h-[80%] object-contain">
                        </div>`;
                    } else {
                        return `
                        <div class="overflow-hidden cursor-pointer hover:opacity-80 transition-all rounded-xl" onclick="openImageLightbox('${item.file_url}')">
                            <img src="${item.file_url}" alt="${item.title}" class="w-full aspect-square object-cover">
                        </div>`;
                    }
                }).join('');
            } else {
                galleryEmpty.classList.remove('hidden');
                galleryContainer.innerHTML = '';
            }

            // Colors
            const colorsContainer = document.getElementById('branding-colors');
            const colorsEmpty = document.getElementById('branding-colors-empty');
            if (colors.length > 0) {
                colorsEmpty.classList.add('hidden');
                colorsContainer.innerHTML = colors.map(c => {
                    const meta = parseBrandNotes(c.notes);
                    const role = clientRoleLabels[meta.role] || '';
                    const rgb = hexToRgbClient(c.value || '#000000');
                    return `
                    <div class="card overflow-hidden">
                        <div class="h-24 w-full" style="background: ${c.value}"></div>
                        <div class="p-4">
                            <div class="flex items-center justify-between mb-1">
                                <p class="text-white text-sm font-medium">${c.title}</p>
                                ${role ? `<span class="text-[10px] text-tertiary uppercase tracking-wider">${role}</span>` : ''}
                            </div>
                            <p class="text-tertiary text-xs font-mono">${c.value}</p>
                            <p class="text-tertiary text-xs font-mono" style="opacity:0.5">RGB ${rgb}</p>
                        </div>
                    </div>`;
                }).join('');
            } else {
                colorsEmpty.classList.remove('hidden');
                colorsContainer.innerHTML = '';
            }

            // Fonts
            const fontsContainer = document.getElementById('branding-fonts');
            const fontsEmpty = document.getElementById('branding-fonts-empty');
            if (fonts.length > 0) {
                fontsEmpty.classList.add('hidden');
                fonts.forEach(f => {
                    const meta = parseBrandNotes(f.notes);
                    const weights = meta.weights || ['400'];
                    loadGoogleFontClient(f.title, weights);
                });
                fontsContainer.innerHTML = fonts.map(f => {
                    const meta = parseBrandNotes(f.notes);
                    const role = clientFontRoleLabels[meta.role] || '';
                    const weights = meta.weights ? meta.weights.join(', ') : '';
                    return `
                    <div class="card p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <p class="text-white font-medium">${f.title}</p>
                                ${role ? `<span class="text-[10px] text-tertiary uppercase tracking-wider">${role}</span>` : ''}
                            </div>
                            ${weights ? `<p class="text-tertiary text-xs font-mono">Wagi: ${weights}</p>` : ''}
                        </div>
                        <p class="text-4xl text-white mb-3" style="font-family: '${f.title}', sans-serif">Aa Bb Cc Dd Ee</p>
                        <p class="text-sm text-tertiary leading-relaxed" style="font-family: '${f.title}', sans-serif">ABCDEFGHIJKLMNOPQRSTUVWXYZ<br>abcdefghijklmnopqrstuvwxyz<br>0123456789</p>
                    </div>`;
                }).join('');
            } else {
                fontsEmpty.classList.remove('hidden');
                fontsContainer.innerHTML = '';
            }

            // (Mockups are now rendered in Gallery above)

            // Guidelines / Downloads
            const guidelinesContainer = document.getElementById('branding-guidelines');
            const guidelinesEmpty = document.getElementById('branding-guidelines-empty');
            if (guidelines.length > 0) {
                guidelinesEmpty.classList.add('hidden');
                guidelinesContainer.innerHTML = guidelines.map(g => {
                    const ext = (g.file_url || '').split('.').pop().toLowerCase();
                    const icon = ext === 'pdf' ? 'ph-file-pdf text-red-400' : ext === 'zip' || ext === 'rar' || ext === '7z' ? 'ph-file-zip text-yellow-400' : 'ph-file text-white/40';
                    return `
                    <div class="card card-hover px-4 py-3 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <i class="ph ${icon} text-lg"></i>
                            <div>
                                <p class="text-white text-sm">${g.title}</p>
                                ${g.notes ? `<p class="text-tertiary text-xs">${g.notes}</p>` : ''}
                            </div>
                        </div>
                        <a href="${g.file_url}" target="_blank" class="text-white hover:text-zinc-300 p-2">
                            <i class="ph ph-download-simple"></i>
                        </a>
                    </div>`;
                }).join('');
            } else {
                guidelinesEmpty.classList.remove('hidden');
                guidelinesContainer.innerHTML = '';
            }

            // Hide empty sections that have no data
            document.getElementById('branding-logos').parentElement.style.display = logos.length > 0 ? '' : (hasContent ? 'none' : '');
            document.getElementById('branding-colors').parentElement.style.display = colors.length > 0 ? '' : (hasContent ? 'none' : '');
            document.getElementById('branding-fonts').parentElement.style.display = fonts.length > 0 ? '' : (hasContent ? 'none' : '');
            document.getElementById('branding-mockups').parentElement.style.display = mockups.length > 0 ? '' : 'none';
            document.getElementById('branding-guidelines').parentElement.style.display = guidelines.length > 0 ? '' : (hasContent ? 'none' : '');
        }

        function renderSalesPage() {
            const content = document.getElementById('sales-page-content');
            const empty = document.getElementById('sales-page-empty');

            if (workflow.sales_page_url && workflow.sales_page_shared_at) {
                empty.classList.add('hidden');
                content.classList.remove('hidden');
                document.getElementById('sales-page-link').href = workflow.sales_page_url;
                document.getElementById('sales-page-url-display').textContent = workflow.sales_page_url;
                const copyBtn = document.getElementById('sales-page-link-copy');
                if (copyBtn) copyBtn.dataset.url = workflow.sales_page_url;
            } else {
                content.classList.add('hidden');
                empty.classList.remove('hidden');
            }
        }



        let pendingProductId = null;

        function renderProducts() {
            const container = document.getElementById('products-list');
            const empty = document.getElementById('products-empty');
            const heroEl = document.getElementById('product-selected-hero');
            const selectedId = workflow.selected_product_id;

            if (products.length === 0) {
                container.innerHTML = '';
                heroEl.classList.add('hidden');
                empty.classList.remove('hidden');
                return;
            }

            empty.classList.add('hidden');

            const selected = selectedId ? products.find(p => p.id === selectedId) : null;

            // If product is selected — show only that product, hide grid
            if (selected) {
                container.innerHTML = '';
                heroEl.classList.remove('hidden');
                heroEl.innerHTML = `
                    <div class="rounded-2xl border border-emerald-500/20 bg-gradient-to-b from-emerald-500/5 to-transparent overflow-hidden">
                        <div class="flex flex-col md:flex-row">
                            ${selected.image_url
                                ? `<div class="md:w-80 flex-shrink-0 aspect-square md:aspect-auto bg-[#080808] overflow-hidden"><img src="${selected.image_url}" alt="" class="w-full h-full object-cover"></div>`
                                : `<div class="md:w-80 flex-shrink-0 aspect-square md:aspect-auto bg-[#080808] flex items-center justify-center"><i class="ph ph-package text-5xl text-[#333]"></i></div>`
                            }
                            <div class="flex-1 p-6 md:p-8 flex flex-col justify-center">
                                <div class="inline-flex items-center gap-1.5 bg-emerald-500/15 text-emerald-400 text-xs font-semibold px-3 py-1.5 rounded-full mb-4 w-fit">
                                    <i class="ph-fill ph-check-circle"></i> Twój wybrany produkt
                                </div>
                                <h3 class="text-white font-semibold text-xl md:text-2xl mb-3 leading-tight">${selected.name}</h3>
                                <p class="text-[#888] text-sm leading-relaxed mb-6">Wokół tego produktu zbudujemy Twój sklep i markę. Zajmiemy się wszystkim — od projektu graficznego po uruchomienie sprzedaży.</p>
                                ${selected.source_url ? `<a href="${selected.source_url}" target="_blank" class="inline-flex items-center gap-2 text-[#888] hover:text-orange-400 text-sm font-medium transition-colors"><i class="ph ph-arrow-square-out"></i> Zobacz produkt na AliExpress</a>` : ''}
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            // No selection yet — show grid
            heroEl.classList.add('hidden');
            heroEl.innerHTML = '';

            container.innerHTML = products.map(p => `
                <div class="group rounded-xl border border-[#1a1a1a] bg-[#0a0a0a] overflow-hidden hover:border-[#333] transition-all duration-200">
                    <div class="relative aspect-square bg-[#080808] overflow-hidden">
                        ${p.image_url
                            ? `<img src="${p.image_url}" alt="${p.name}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300" loading="lazy">`
                            : `<div class="w-full h-full flex items-center justify-center"><i class="ph ph-package text-3xl text-[#333]"></i></div>`
                        }
                    </div>
                    <div class="p-3 space-y-2">
                        <h4 class="text-[#ccc] font-medium text-xs leading-snug" style="display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;">${p.name}</h4>
                        ${p.source_url ? `<a href="${p.source_url}" target="_blank" class="w-full py-1.5 rounded-lg text-[11px] font-medium text-[#777] border border-[#222] hover:border-[#444] hover:text-white transition-colors flex items-center justify-center gap-1"><i class="ph ph-arrow-square-out"></i> Podgląd</a>` : ''}
                        <button onclick="openConfirmModal('${p.id}')" class="w-full bg-white text-black hover:bg-zinc-200 py-1.5 rounded-lg text-[11px] font-semibold transition-colors">Wybieram ten produkt</button>
                    </div>
                </div>
            `).join('');
        }

        function openConfirmModal(productId) {
            pendingProductId = productId;
            const product = products.find(p => p.id === productId);
            if (!product) return;

            const imgContainer = document.getElementById('confirm-product-image');
            imgContainer.innerHTML = product.image_url
                ? `<img src="${product.image_url}" alt="" class="w-full h-full object-cover">`
                : `<div class="w-full h-full flex items-center justify-center"><i class="ph ph-package text-4xl text-[#444]"></i></div>`;

            document.getElementById('confirm-product-name').textContent = product.name;
            document.getElementById('product-confirm-modal').classList.remove('hidden');
        }

        function closeConfirmModal() {
            document.getElementById('product-confirm-modal').classList.add('hidden');
            pendingProductId = null;
        }

        async function confirmProductSelection() {
            if (!pendingProductId) return;
            const id = pendingProductId;

            const { error } = await supabaseClient
                .from('workflows')
                .update({ selected_product_id: id })
                .eq('id', workflow.id);

            closeConfirmModal();

            if (error) {
                console.error(error);
                showToast('Wystąpił błąd', 'error');
                return;
            }

            workflow.selected_product_id = id;
            renderProducts();
            showToast('Produkt wybrany!', 'success');
        }
        window.openConfirmModal = openConfirmModal;
        window.closeConfirmModal = closeConfirmModal;
        window.confirmProductSelection = confirmProductSelection;

        // =============================================
        // REPORT TYPE CONFIG
        // =============================================
        const REPORT_TYPE_CONFIG_CLIENT = {
            report_pdf: {
                icon: 'ph-file-pdf',
                label: 'PDF',
                accent: '#ef4444',
                gradient: 'linear-gradient(135deg, #1a0505 0%, #0a0a0a 50%, #150808 100%)',
                pattern: `<svg class="absolute inset-0 w-full h-full opacity-[0.04]" xmlns="http://www.w3.org/2000/svg"><defs><pattern id="pp" width="20" height="20" patternUnits="userSpaceOnUse"><path d="M0 10h20M10 0v20" stroke="#ef4444" stroke-width="0.5"/></pattern></defs><rect fill="url(#pp)" width="100%" height="100%"/></svg>`
            },
            report_infographic: {
                icon: 'ph-image',
                label: 'Infografika',
                accent: '#8b5cf6',
                gradient: 'linear-gradient(135deg, #0d0519 0%, #0a0a0a 50%, #0f0720 100%)',
                pattern: `<svg class="absolute inset-0 w-full h-full opacity-[0.05]" xmlns="http://www.w3.org/2000/svg"><defs><pattern id="pi" width="24" height="24" patternUnits="userSpaceOnUse"><circle cx="12" cy="12" r="1.5" fill="#8b5cf6"/></pattern></defs><rect fill="url(#pi)" width="100%" height="100%"/></svg>`
            },
            report_presentation: {
                icon: 'ph-presentation-chart',
                label: 'Prezentacja',
                accent: '#3b82f6',
                gradient: 'linear-gradient(135deg, #050d1a 0%, #0a0a0a 50%, #081020 100%)',
                pattern: `<svg class="absolute inset-0 w-full h-full opacity-[0.04]" xmlns="http://www.w3.org/2000/svg"><defs><pattern id="pb" width="32" height="32" patternUnits="userSpaceOnUse"><path d="M0 16h32" stroke="#3b82f6" stroke-width="0.5"/></pattern></defs><rect fill="url(#pb)" width="100%" height="100%"/></svg>`
            },
            report_video: {
                icon: 'ph-video',
                label: 'Video analiza',
                accent: '#ec4899',
                gradient: 'linear-gradient(135deg, #1a0515 0%, #0a0a0a 50%, #150812 100%)',
                pattern: `<svg class="absolute inset-0 w-full h-full opacity-[0.04]" xmlns="http://www.w3.org/2000/svg"><defs><pattern id="pv" width="24" height="24" patternUnits="userSpaceOnUse"><polygon points="10,6 18,12 10,18" fill="#ec4899"/></pattern></defs><rect fill="url(#pv)" width="100%" height="100%"/></svg>`
            },
            product_analysis: {
                icon: 'ph-chart-line-up',
                label: 'Analiza',
                accent: '#00d084',
                gradient: 'linear-gradient(135deg, #021a0f 0%, #0a0a0a 50%, #041a10 100%)',
                pattern: `<svg class="absolute inset-0 w-full h-full opacity-[0.04]" xmlns="http://www.w3.org/2000/svg"><defs><pattern id="pg" width="20" height="20" patternUnits="userSpaceOnUse"><path d="M0 10h20M10 0v20" stroke="#00d084" stroke-width="0.5"/></pattern></defs><rect fill="url(#pg)" width="100%" height="100%"/></svg>`
            }
        };

        const REPORT_FALLBACK_CONFIG = { icon: 'ph-file', label: 'Plik', accent: '#666', gradient: 'linear-gradient(135deg, #111 0%, #0a0a0a 100%)', pattern: '' };

        // ===================================
        // RENDER REPORTS
        // ===================================
        function renderReports() {
            const container = document.getElementById('reports-list');
            const empty = document.getElementById('reports-empty');

            if (reports.length === 0) {
                container.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }

            empty.classList.add('hidden');

            container.innerHTML = reports.map((r, i) => {
                const config = REPORT_TYPE_CONFIG_CLIENT[r.type] || REPORT_FALLBACK_CONFIG;
                const fileSize = r.content?.file_size ? formatFileSize(r.content.file_size) : '';

                return `
                    <div class="group rounded-xl border border-[#1a1a1a] hover:border-[#2a2a2a] bg-[#111] overflow-hidden transition-all duration-300 hover:shadow-lg hover:shadow-black/20" style="animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) ${i * 0.08}s both;">
                        <!-- Visual header -->
                        <div class="relative h-36 overflow-hidden" style="background: ${config.gradient};">
                            ${config.pattern}
                            <div class="absolute inset-0 flex items-center justify-center">
                                <div class="w-16 h-16 rounded-2xl flex items-center justify-center transition-transform duration-300 group-hover:scale-110" style="background: ${config.accent}12; backdrop-filter: blur(8px); border: 1px solid ${config.accent}20;">
                                    <i class="ph ${config.icon} text-3xl" style="color: ${config.accent};"></i>
                                </div>
                            </div>
                            <!-- Glow effect -->
                            <div class="absolute bottom-0 left-1/2 -translate-x-1/2 w-32 h-16 rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-500 blur-2xl" style="background: ${config.accent};"></div>
                        </div>

                        <!-- Content -->
                        <div class="p-4">
                            <h3 class="text-[15px] font-semibold text-white">${r.title}</h3>
                            <p class="text-zinc-500 text-xs mt-1">${config.label}${fileSize ? ' · ' + fileSize : ''}</p>

                            <!-- Actions -->
                            <div class="flex gap-2 mt-4">
                                <a href="${r.file_url}" target="_blank" class="flex-1 inline-flex items-center justify-center gap-1.5 py-2.5 text-xs font-medium rounded-lg border border-[#2a2a2a] text-zinc-300 hover:text-white hover:border-[#444] hover:bg-white/5 transition-all">
                                    <i class="ph ph-arrow-square-out text-sm"></i> Otwórz
                                </a>
                                <a href="${r.file_url}" target="_blank" download class="flex-1 inline-flex items-center justify-center gap-1.5 py-2.5 text-xs font-medium rounded-lg text-black bg-white hover:bg-zinc-200 transition-all">
                                    <i class="ph ph-download-simple text-sm"></i> Pobierz
                                </a>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1048576) return (bytes / 1024).toFixed(0) + ' KB';
            return (bytes / 1048576).toFixed(1) + ' MB';
        }


        function renderComments() {
            const container = document.getElementById('comments-list');
            const empty = document.getElementById('comments-empty');

            if (comments.length === 0) {
                container.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }

            empty.classList.add('hidden');
            container.innerHTML = comments.map(c => {
                const isTeam = c.author_type === 'team';
                return `
                    <div class="flex gap-3 ${isTeam ? '' : 'flex-row-reverse'}">
                        <div class="w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center ${isTeam ? 'bg-violet-500/10' : 'bg-cyan-500/10'}">
                            <i class="ph ph-user text-sm ${isTeam ? 'text-violet-400' : 'text-cyan-400'}"></i>
                        </div>
                        <div class="${isTeam ? '' : 'text-right'} flex-1">
                            <div class="inline-block ${isTeam ? 'comment-team' : 'comment-client'} rounded-xl px-4 py-3 max-w-[85%] ${isTeam ? '' : 'text-left'}">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-white text-sm font-medium">${c.author_name}</span>
                                    <span class="text-tertiary text-xs">${formatDateTime(c.created_at)}</span>
                                </div>
                                <p class="text-zinc-300 text-sm whitespace-pre-wrap">${c.content}</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Scroll to bottom
            setTimeout(() => container.scrollTop = container.scrollHeight, 100);
        }

        async function postComment() {
            const content = document.getElementById('new-comment').value.trim();
            if (!content) return;

            const { data, error } = await supabaseClient
                .from('workflow_comments')
                .insert({
                    workflow_id: workflow.id,
                    author_type: 'client',
                    author_name: workflow.customer_name || 'Klient',
                    content: content
                })
                .select()
                .single();

            if (error) {
                showToast('Blad wysylania', 'error');
                return;
            }

            comments.push(data);
            renderComments();
            document.getElementById('new-comment').value = '';
            showToast('Komentarz wyslany');
        }
        window.postComment = postComment;

        // Initialize
        loadProject();
    </script>
</body>
</html>
