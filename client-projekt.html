<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twoj projekt - tomekniedzwiecki.pl</title>
    <link rel="icon" type="image/svg+xml" href="/favicon-tn.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bcryptjs/2.4.3/bcrypt.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    }
                }
            }
        }
    </script>
    <style>
        body { background: #000000; color: #ededed; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::selection { background: white; color: black; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-enter { animation: fadeIn 0.4s ease-out forwards; }

        .input-field {
            background: #0a0a0a;
            border: 1px solid rgba(255,255,255,0.08);
            transition: all 0.15s ease;
        }
        .input-field:focus {
            border-color: rgba(255,255,255,0.2);
            outline: none;
        }

        .glass-card {
            background: linear-gradient(to bottom, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
            border: 1px solid rgba(255,255,255,0.06);
        }

        .progress-bar {
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
            transition: width 0.5s ease;
        }

        .milestone-card {
            transition: all 0.15s ease;
        }
        .milestone-card:hover {
            border-color: rgba(255,255,255,0.1);
        }
        .milestone-card.active {
            border-color: rgba(255,255,255,0.15);
            background: linear-gradient(to bottom, rgba(255,255,255,0.04), rgba(255,255,255,0.01));
        }
        .milestone-card.completed {
            border-color: rgba(16, 185, 129, 0.2);
        }

        .milestone-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.2s ease-out;
            opacity: 0;
        }
        .milestone-content.expanded {
            max-height: 2000px;
            opacity: 1;
        }

        .responsible-badge {
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }
        .responsible-team { background: rgba(139, 92, 246, 0.15); color: #a78bfa; border: 1px solid rgba(139, 92, 246, 0.2); }
        .responsible-client { background: rgba(6, 182, 212, 0.15); color: #22d3ee; border: 1px solid rgba(6, 182, 212, 0.2); }
        .responsible-shared { background: rgba(245, 158, 11, 0.15); color: #fbbf24; border: 1px solid rgba(245, 158, 11, 0.2); }

        /* Vercel-style form */
        .form-group { margin-bottom: 1.25rem; }
        .form-label {
            display: block;
            color: #888;
            font-size: 0.8125rem;
            font-weight: 400;
            margin-bottom: 0.5rem;
            letter-spacing: -0.01em;
        }
        .form-input {
            width: 100%;
            background: #000;
            border: 1px solid #333;
            border-radius: 0.5rem;
            padding: 0.625rem 0.875rem;
            color: #ededed;
            font-size: 0.875rem;
            transition: border-color 0.15s ease, box-shadow 0.15s ease;
        }
        .form-input:hover {
            border-color: #444;
        }
        .form-input:focus {
            border-color: #888;
            outline: none;
            box-shadow: 0 0 0 1px #888;
        }
        .form-input.error {
            border-color: #e5484d;
        }
        .form-input::placeholder {
            color: #666;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        @media (max-width: 640px) {
            .form-row { grid-template-columns: 1fr; }
        }

        /* Vercel-style step indicator */
        .step-indicator {
            display: flex;
            align-items: center;
            gap: 0;
            margin-bottom: 2rem;
            padding: 0.75rem 1rem;
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 9999px;
        }
        .step {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .step-number {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        .step-number.active {
            background: #fff;
            color: #000;
        }
        .step-number.completed {
            background: #10b981;
            color: #fff;
        }
        .step-number.pending {
            background: transparent;
            border: 1px solid #333;
            color: #666;
        }
        .step-text {
            font-size: 0.875rem;
            font-weight: 500;
            letter-spacing: -0.01em;
        }
        .step-text.active { color: #fff; }
        .step-text.completed { color: #10b981; }
        .step-text.pending { color: #666; }
        .step-line {
            flex: 1;
            height: 1px;
            background: #333;
            margin: 0 1rem;
        }
        .step-line.completed {
            background: #10b981;
        }

        /* Vercel-style signing options */
        .signing-option {
            background: transparent;
            border: 1px solid #333;
            border-radius: 0.75rem;
            padding: 1.25rem;
            cursor: pointer;
            transition: all 0.15s ease;
            position: relative;
        }
        .signing-option:hover {
            border-color: #555;
            background: rgba(255,255,255,0.02);
        }
        .signing-option.recommended {
            border-color: #10b981;
            background: linear-gradient(to bottom, rgba(16, 185, 129, 0.08), rgba(16, 185, 129, 0.02));
        }
        .signing-option.recommended:hover {
            border-color: #10b981;
            background: linear-gradient(to bottom, rgba(16, 185, 129, 0.12), rgba(16, 185, 129, 0.04));
        }

        /* Vercel-style section headers */
        .section-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.25rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }
        .section-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Vercel-style buttons */
        .btn-primary {
            background: #fff;
            color: #000;
            border: none;
            border-radius: 0.5rem;
            padding: 0.75rem 1.25rem;
            font-weight: 500;
            font-size: 0.875rem;
            transition: all 0.15s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .btn-primary:hover {
            background: #e5e5e5;
        }
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-secondary {
            background: transparent;
            color: #888;
            border: 1px solid #333;
            border-radius: 0.5rem;
            padding: 0.625rem 1rem;
            font-weight: 500;
            font-size: 0.875rem;
            transition: all 0.15s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .btn-secondary:hover {
            background: rgba(255,255,255,0.05);
            border-color: #555;
            color: #fff;
        }

        /* PDF download card */
        .pdf-card {
            background: linear-gradient(to bottom, rgba(255,255,255,0.04), rgba(255,255,255,0.01));
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 0.75rem;
            padding: 1rem 1.25rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }
        .pdf-icon {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
    </style>
</head>
<body class="min-h-screen font-sans text-sm tracking-tight antialiased">

    <!-- Loading Screen -->
    <div id="loading-screen" class="min-h-screen flex items-center justify-center px-4">
        <div class="text-center animate-enter">
            <div class="w-5 h-5 mx-auto mb-4 border-2 border-[#333] border-t-white rounded-full animate-spin"></div>
            <p class="text-[#666] text-sm">Ladowanie projektu...</p>
        </div>
    </div>

    <!-- Set Password Screen (first time) -->
    <div id="set-password-screen" class="min-h-screen flex items-center justify-center px-4 hidden">
        <div class="w-full max-w-sm animate-enter">
            <div class="text-center mb-8">
                <div class="w-12 h-12 bg-white text-black rounded-xl flex items-center justify-center mx-auto mb-5">
                    <i class="ph-bold ph-shield-check text-xl"></i>
                </div>
                <h1 class="text-xl font-semibold text-white mb-2 tracking-tight">Zabezpiecz swoj projekt</h1>
                <p class="text-[#888] text-sm">Ustaw haslo, ktore bedzie chronilo dostep do Twojego projektu i wrazliwych danych.</p>
            </div>

            <div class="glass-card rounded-xl p-6">
                <div class="mb-4">
                    <label class="form-label">Nowe haslo</label>
                    <input type="password" id="new-password-input"
                           class="form-input"
                           placeholder="Minimum 6 znakow..."
                           minlength="6"
                           autofocus>
                </div>
                <div class="mb-4">
                    <label class="form-label">Powtorz haslo</label>
                    <input type="password" id="confirm-password-input"
                           class="form-input"
                           placeholder="Powtorz haslo...">
                </div>
                <div id="set-password-error" class="text-red-400 text-sm mb-4 hidden"></div>
                <button id="set-password-btn" class="btn-primary w-full">
                    <span>Ustaw haslo i kontynuuj</span>
                    <i class="ph ph-arrow-right"></i>
                </button>
            </div>

            <div class="mt-4 p-3 bg-amber-500/10 border border-amber-500/20 rounded-lg">
                <div class="flex items-start gap-2">
                    <i class="ph ph-lightbulb text-amber-400 mt-0.5 flex-shrink-0"></i>
                    <p class="text-amber-200/80 text-xs">
                        <strong>Podpowiedz:</strong> Zapisz haslo w bezpiecznym miejscu (np. menedzer hasel). Bedzie wymagane przy kazdym wejsciu na strone projektu.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Password Screen (login) -->
    <div id="password-screen" class="min-h-screen flex items-center justify-center px-4 hidden">
        <div class="w-full max-w-sm animate-enter">
            <div class="text-center mb-8">
                <div class="w-12 h-12 bg-white text-black rounded-xl flex items-center justify-center mx-auto mb-5">
                    <i class="ph-bold ph-lock-key text-xl"></i>
                </div>
                <h1 class="text-xl font-semibold text-white mb-2 tracking-tight">Twoj projekt</h1>
                <p class="text-[#888] text-sm">Wprowadz haslo, aby zobaczyc postep prac</p>
            </div>

            <div class="glass-card rounded-xl p-6">
                <div class="mb-4">
                    <label class="form-label">Haslo</label>
                    <input type="password" id="password-input"
                           class="form-input"
                           placeholder="Wprowadz haslo..."
                           autofocus>
                </div>
                <div id="password-error" class="text-red-400 text-sm mb-4 hidden">Nieprawidlowe haslo</div>
                <button id="password-btn" class="btn-primary w-full">
                    <span>Zobacz projekt</span>
                    <i class="ph ph-arrow-right"></i>
                </button>
            </div>

            <p class="text-[#555] text-xs text-center mt-4">
                Nie pamietasz hasla? Napisz na <a href="mailto:ceo@tomekniedzwiecki.pl" class="text-blue-400 hover:text-blue-300">ceo@tomekniedzwiecki.pl</a>
            </p>
        </div>
    </div>

    <!-- Not Found Screen -->
    <div id="not-found-screen" class="min-h-screen flex items-center justify-center px-4 hidden">
        <div class="w-full max-w-sm text-center animate-enter">
            <div class="w-16 h-16 bg-[#111] border border-[#333] rounded-2xl flex items-center justify-center mx-auto mb-6">
                <i class="ph ph-question text-3xl text-[#666]"></i>
            </div>
            <h1 class="text-xl font-semibold text-white mb-2 tracking-tight">Nie znaleziono projektu</h1>
            <p class="text-[#888] text-sm">Ten link jest nieprawidlowy lub projekt zostal usuniety.</p>
        </div>
    </div>

    <!-- Contract Data Screen -->
    <div id="contract-data-screen" class="hidden">
        <header class="sticky top-0 z-50 bg-black/80 backdrop-blur-xl border-b border-white/[0.06]">
            <div class="max-w-2xl mx-auto px-4 sm:px-6 py-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <img src="/favicon-tn.svg" alt="TN" class="w-8 h-8 rounded-lg">
                    <span class="font-medium text-white text-sm">tomekniedzwiecki.pl</span>
                </div>
            </div>
        </header>

        <main class="max-w-2xl mx-auto px-4 sm:px-6 py-8 sm:py-12 animate-enter">
            <!-- Step Indicator -->
            <div class="step-indicator">
                <div class="step">
                    <div class="step-number active">1</div>
                    <span class="step-text active">Dane do umowy</span>
                </div>
                <div class="step-line"></div>
                <div class="step">
                    <div class="step-number pending">2</div>
                    <span class="step-text pending">Podpis</span>
                </div>
                <div class="step-line"></div>
                <div class="step">
                    <div class="step-number pending">3</div>
                    <span class="step-text pending">Projekt</span>
                </div>
            </div>

            <div class="glass-card rounded-xl p-6 sm:p-8">
                <div class="mb-8">
                    <h1 class="text-2xl font-semibold text-white mb-2 tracking-tight">Dane do umowy</h1>
                    <p class="text-[#888] text-[0.9375rem]">Potrzebujemy Twoich danych do przygotowania umowy przed rozpoczeciem projektu.</p>
                </div>

                <form id="contract-form" onsubmit="submitContractData(event)">
                    <!-- Personal Data -->
                    <div class="mb-8">
                        <div class="section-header">
                            <div class="section-icon bg-gradient-to-br from-violet-500/20 to-purple-600/20">
                                <i class="ph ph-user text-violet-400"></i>
                            </div>
                            <span class="text-white font-medium">Dane osobowe</span>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Imie i nazwisko</label>
                            <input type="text" id="cd-name" class="form-input" required placeholder="Jan Kowalski">
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Firma <span class="text-[#555]">(opcjonalnie)</span></label>
                                <input type="text" id="cd-company" class="form-input" placeholder="Nazwa firmy">
                            </div>
                            <div class="form-group">
                                <label class="form-label">NIP <span class="text-[#555]">(opcjonalnie)</span></label>
                                <input type="text" id="cd-nip" class="form-input" placeholder="0000000000" maxlength="10">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">PESEL</label>
                                <input type="text" id="cd-pesel" class="form-input" required
                                       placeholder="00000000000" maxlength="11" pattern="[0-9]{11}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Nr dowodu osobistego</label>
                                <input type="text" id="cd-id-number" class="form-input" required
                                       placeholder="ABC123456" maxlength="9">
                            </div>
                        </div>
                    </div>

                    <!-- Address -->
                    <div class="mb-8">
                        <div class="section-header">
                            <div class="section-icon bg-gradient-to-br from-blue-500/20 to-cyan-600/20">
                                <i class="ph ph-map-pin text-blue-400"></i>
                            </div>
                            <span class="text-white font-medium">Adres zamieszkania</span>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Ulica i numer</label>
                            <input type="text" id="cd-street" class="form-input" required placeholder="ul. Przykladowa 123/4">
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Kod pocztowy</label>
                                <input type="text" id="cd-postal" class="form-input" required
                                       placeholder="00-000" maxlength="6">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Miejscowosc</label>
                                <input type="text" id="cd-city" class="form-input" required placeholder="Warszawa">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Kraj</label>
                            <input type="text" id="cd-country" class="form-input" required value="Polska">
                        </div>
                    </div>

                    <!-- Contact -->
                    <div class="mb-8">
                        <div class="section-header">
                            <div class="section-icon bg-gradient-to-br from-emerald-500/20 to-green-600/20">
                                <i class="ph ph-envelope text-emerald-400"></i>
                            </div>
                            <span class="text-white font-medium">Dane kontaktowe</span>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Email</label>
                                <input type="email" id="cd-email" class="form-input" required placeholder="jan@email.pl">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Telefon</label>
                                <input type="tel" id="cd-phone" class="form-input" required placeholder="+48 600 000 000">
                            </div>
                        </div>
                    </div>

                    <div id="contract-form-error" class="hidden bg-red-500/10 border border-red-500/30 rounded-lg p-4 mb-6 text-red-400 text-sm">
                        Wypelnij wszystkie wymagane pola poprawnie.
                    </div>

                    <button type="submit" id="contract-submit-btn" class="btn-primary w-full py-3">
                        <span>Kontynuuj</span>
                        <i class="ph ph-arrow-right"></i>
                    </button>
                </form>
            </div>
        </main>
    </div>

    <!-- Contract Signing Screen -->
    <div id="contract-signing-screen" class="hidden">
        <header class="sticky top-0 z-50 bg-black/80 backdrop-blur-xl border-b border-white/[0.06]">
            <div class="max-w-2xl mx-auto px-4 sm:px-6 py-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <img src="/favicon-tn.svg" alt="TN" class="w-8 h-8 rounded-lg">
                    <span class="font-medium text-white text-sm">tomekniedzwiecki.pl</span>
                </div>
            </div>
        </header>

        <main class="max-w-2xl mx-auto px-4 sm:px-6 py-8 sm:py-12 animate-enter">
            <!-- Step Indicator -->
            <div class="step-indicator">
                <div class="step">
                    <div class="step-number completed"><i class="ph-bold ph-check text-xs"></i></div>
                    <span class="step-text completed">Dane do umowy</span>
                </div>
                <div class="step-line completed"></div>
                <div class="step">
                    <div class="step-number active">2</div>
                    <span class="step-text active">Podpis</span>
                </div>
                <div class="step-line"></div>
                <div class="step">
                    <div class="step-number pending">3</div>
                    <span class="step-text pending">Projekt</span>
                </div>
            </div>

            <div class="glass-card rounded-xl p-6 sm:p-8 mb-4">
                <div class="mb-8">
                    <h1 class="text-2xl font-semibold text-white mb-2 tracking-tight">Podpisz umowe</h1>
                    <p class="text-[#888] text-[0.9375rem]">Twoja umowa jest gotowa. Pobierz ja i wybierz sposob podpisania.</p>
                </div>

                <!-- Download Contract -->
                <div class="pdf-card mb-8">
                    <div class="flex items-center gap-4">
                        <div class="pdf-icon">
                            <i class="ph-bold ph-file-pdf text-white text-xl"></i>
                        </div>
                        <div>
                            <div class="text-white font-medium" id="contract-filename">Umowa.pdf</div>
                            <div class="text-[#666] text-sm">Pobierz i przeczytaj przed podpisaniem</div>
                        </div>
                    </div>
                    <button onclick="downloadContract()" class="btn-primary">
                        <i class="ph ph-download-simple"></i>
                        <span>Pobierz</span>
                    </button>
                </div>

                <!-- Signing Options -->
                <div class="mb-6">
                    <h3 class="text-[#888] text-sm font-medium mb-4">Wybierz metode podpisu</h3>

                    <div class="space-y-3">
                        <!-- Option 1: Podpis Zaufany -->
                        <div class="signing-option recommended" onclick="selectSigningMethod('zaufany')">
                            <div class="flex items-start gap-4">
                                <div class="w-11 h-11 bg-gradient-to-br from-emerald-500/30 to-green-600/20 rounded-xl flex items-center justify-center flex-shrink-0">
                                    <i class="ph-bold ph-shield-check text-emerald-400 text-xl"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-1.5">
                                        <h4 class="font-medium text-white">Podpis zaufany (gov.pl)</h4>
                                        <span class="bg-emerald-500/20 text-emerald-400 text-[11px] font-medium px-2 py-0.5 rounded-full uppercase tracking-wide">Zalecane</span>
                                    </div>
                                    <p class="text-[#888] text-sm mb-4">Darmowy podpis elektroniczny przez profil zaufany. Najszybsza i najwygodniejsza metoda.</p>
                                    <div class="bg-black/30 rounded-lg p-3 space-y-2">
                                        <div class="flex items-start gap-2 text-sm">
                                            <span class="text-[#555] font-mono">1.</span>
                                            <span class="text-[#888]">Pobierz umowe PDF powyzej</span>
                                        </div>
                                        <div class="flex items-start gap-2 text-sm">
                                            <span class="text-[#555] font-mono">2.</span>
                                            <span class="text-[#888]">Wejdz na <a href="https://www.gov.pl/web/gov/podpisz-dokument-elektronicznie-wykorzystaj-podpis-zaufany" target="_blank" class="text-blue-400 hover:text-blue-300 transition-colors">gov.pl/podpisz</a></span>
                                        </div>
                                        <div class="flex items-start gap-2 text-sm">
                                            <span class="text-[#555] font-mono">3.</span>
                                            <span class="text-[#888]">Zaloguj sie profilem zaufanym i podpisz</span>
                                        </div>
                                        <div class="flex items-start gap-2 text-sm">
                                            <span class="text-[#555] font-mono">4.</span>
                                            <span class="text-[#888]">Wyslij plik na <span class="text-blue-400">ceo@tomekniedzwiecki.pl</span></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Option 2: Podpis Kwalifikowany -->
                        <div class="signing-option" onclick="selectSigningMethod('kwalifikowany')">
                            <div class="flex items-start gap-4">
                                <div class="w-11 h-11 bg-gradient-to-br from-violet-500/30 to-purple-600/20 rounded-xl flex items-center justify-center flex-shrink-0">
                                    <i class="ph-bold ph-certificate text-violet-400 text-xl"></i>
                                </div>
                                <div class="flex-1">
                                    <h4 class="font-medium text-white mb-1.5">Podpis kwalifikowany</h4>
                                    <p class="text-[#888] text-sm mb-4">Jesli posiadasz certyfikat kwalifikowany (np. Szafir, Certum, KIR).</p>
                                    <div class="bg-black/30 rounded-lg p-3 space-y-2">
                                        <div class="flex items-start gap-2 text-sm">
                                            <span class="text-[#555] font-mono">1.</span>
                                            <span class="text-[#888]">Pobierz umowe PDF powyzej</span>
                                        </div>
                                        <div class="flex items-start gap-2 text-sm">
                                            <span class="text-[#555] font-mono">2.</span>
                                            <span class="text-[#888]">Podpisz dokument swoim podpisem kwalifikowanym</span>
                                        </div>
                                        <div class="flex items-start gap-2 text-sm">
                                            <span class="text-[#555] font-mono">3.</span>
                                            <span class="text-[#888]">Wyslij plik na <span class="text-blue-400">ceo@tomekniedzwiecki.pl</span></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Option 3: Podpis Fizyczny -->
                        <div class="signing-option" onclick="selectSigningMethod('fizyczny')">
                            <div class="flex items-start gap-4">
                                <div class="w-11 h-11 bg-gradient-to-br from-amber-500/30 to-orange-600/20 rounded-xl flex items-center justify-center flex-shrink-0">
                                    <i class="ph-bold ph-package text-amber-400 text-xl"></i>
                                </div>
                                <div class="flex-1">
                                    <h4 class="font-medium text-white mb-1.5">Podpis fizyczny (paczkomat)</h4>
                                    <p class="text-[#888] text-sm mb-4">Tradycyjny podpis na papierze. Wyslemy umowe do Twojego paczkomatu.</p>
                                    <div class="bg-black/30 rounded-lg p-3 space-y-2">
                                        <div class="flex items-start gap-2 text-sm">
                                            <span class="text-[#555] font-mono">1.</span>
                                            <span class="text-[#888]">Skontaktuj sie z nami podajac paczkomat</span>
                                        </div>
                                        <div class="flex items-start gap-2 text-sm">
                                            <span class="text-[#555] font-mono">2.</span>
                                            <span class="text-[#888]">Odbierz przesylke i podpisz dokument</span>
                                        </div>
                                        <div class="flex items-start gap-2 text-sm">
                                            <span class="text-[#555] font-mono">3.</span>
                                            <span class="text-[#888]">Odeslij umowe na nasz adres (w przesylce)</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action buttons -->
            <div class="flex items-center justify-between">
                <button onclick="goBackToEditData()" class="btn-secondary">
                    <i class="ph ph-arrow-left"></i>
                    <span>Popraw dane</span>
                </button>
                <button onclick="skipToProject()" class="btn-secondary">
                    <span>Przejdz do projektu</span>
                    <i class="ph ph-arrow-right"></i>
                </button>
            </div>
            <p class="text-[#555] text-xs text-center mt-3">Mozesz kontynuowac, ale umowa musi byc podpisana przed zakonczeniem projektu</p>
        </main>
    </div>

    <!-- Main Project View -->
    <div id="project-screen" class="hidden">
        <!-- Header -->
        <header class="sticky top-0 z-50 bg-black/80 backdrop-blur-xl border-b border-white/[0.06]">
            <div class="max-w-5xl mx-auto px-4 sm:px-6 py-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <img src="/favicon-tn.svg" alt="TN" class="w-8 h-8 rounded-lg">
                    <span class="font-medium text-white text-sm">tomekniedzwiecki.pl</span>
                </div>
                <div class="flex items-center gap-3 text-sm">
                    <span class="text-[#666] hidden sm:inline">Projekt:</span>
                    <div id="header-customer" class="text-white font-medium">-</div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-5xl mx-auto px-4 sm:px-6 py-6 sm:py-10">

            <!-- Progress Overview -->
            <div class="glass-card rounded-xl p-5 sm:p-8 mb-6 sm:mb-8 animate-enter">
                <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 sm:gap-6 mb-6">
                    <div>
                        <h1 id="offer-name" class="text-xl sm:text-2xl font-semibold text-white mb-1 tracking-tight">-</h1>
                        <div class="flex items-center gap-3 text-sm text-[#888]">
                            <span id="status-label" class="flex items-center gap-1.5">
                                <span class="w-2 h-2 rounded-full bg-emerald-400"></span>
                                W realizacji
                            </span>
                            <span class="text-[#333]">|</span>
                            <span>Start: <span id="started-at" class="text-white">-</span></span>
                        </div>
                    </div>
                    <div class="text-left sm:text-right">
                        <div class="text-3xl sm:text-4xl font-semibold text-white mb-1">
                            <span id="progress-percent">0</span>%
                        </div>
                        <div class="text-[#666] text-xs">ukonczono</div>
                    </div>
                </div>

                <!-- Progress Bar -->
                <div class="h-2 bg-[#1a1a1a] rounded-full overflow-hidden mb-4">
                    <div id="progress-bar" class="progress-bar h-full rounded-full" style="width: 0%"></div>
                </div>

                <!-- Stats -->
                <div class="flex flex-wrap items-center gap-4 sm:gap-6 text-sm">
                    <div class="flex items-center gap-2">
                        <i class="ph ph-check-square text-emerald-400"></i>
                        <span class="text-[#888]">Zadania:</span>
                        <span class="text-white font-medium"><span id="completed-tasks">0</span>/<span id="total-tasks">0</span></span>
                    </div>
                    <div class="flex items-center gap-2">
                        <i class="ph ph-path text-violet-400"></i>
                        <span class="text-[#888]">Etapy:</span>
                        <span class="text-white font-medium"><span id="completed-milestones">0</span>/<span id="total-milestones">0</span></span>
                    </div>
                    <div id="deadline-info" class="flex items-center gap-2">
                        <i class="ph ph-clock text-amber-400"></i>
                        <span class="text-[#888]">Deadline:</span>
                        <span id="current-deadline" class="text-white">-</span>
                    </div>
                </div>
            </div>

            <!-- Milestones -->
            <div class="space-y-4 animate-enter" style="animation-delay: 0.1s">
                <h2 class="text-base font-medium text-white flex items-center gap-2">
                    <i class="ph ph-path text-violet-400"></i>
                    Etapy realizacji
                </h2>

                <div id="milestones-container" class="space-y-3">
                    <!-- Milestones rendered here -->
                </div>
            </div>

            <!-- Contact Section -->
            <div class="glass-card rounded-xl p-5 sm:p-8 mt-8 animate-enter" style="animation-delay: 0.2s">
                <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 sm:gap-6">
                    <div>
                        <h3 class="text-base font-medium text-white mb-1">Masz pytania?</h3>
                        <p class="text-[#888] text-sm">Skontaktuj sie z nami, chetnie odpowiemy.</p>
                    </div>
                    <div class="flex gap-2 sm:gap-3">
                        <a href="mailto:ceo@tomekniedzwiecki.pl" class="btn-secondary flex-1 sm:flex-initial">
                            <i class="ph ph-envelope"></i>
                            Email
                        </a>
                        <a href="https://wa.me/48533308623" target="_blank" class="btn-secondary flex-1 sm:flex-initial">
                            <i class="ph ph-whatsapp-logo"></i>
                            WhatsApp
                        </a>
                    </div>
                </div>
            </div>

        </main>

        <!-- Footer -->
        <footer class="border-t border-white/[0.06] mt-12">
            <div class="max-w-5xl mx-auto px-6 py-8 text-center">
                <p class="text-[#555] text-sm">
                    Powered by <span class="text-[#888]">tomekniedzwiecki.pl</span>
                </p>
            </div>
        </footer>
    </div>

    <script>
        const SUPABASE_URL = 'https://yxmavwkwnfuphjqbelws.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl4bWF2d2t3bmZ1cGhqcWJlbHdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NjQyNTUsImV4cCI6MjA4NDM0MDI1NX0.XeR0Fc7OFn6YbNJrOKTBEj36JtmLISZTM87y4ai9340';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let workflow = null;
        let milestones = [];
        let tasks = [];
        let isAuthenticated = false;
        let contractData = {};
        let offer = null;

        function getToken() {
            const path = window.location.pathname;
            const match = path.match(/\/projekt\/([a-f0-9]+)/i);
            return match ? match[1] : null;
        }

        // PESEL validation with checksum
        function validatePesel(pesel) {
            if (!/^[0-9]{11}$/.test(pesel)) {
                return { valid: false, error: 'PESEL musi skladac sie z 11 cyfr.' };
            }

            const weights = [1, 3, 7, 9, 1, 3, 7, 9, 1, 3];
            let sum = 0;
            for (let i = 0; i < 10; i++) {
                sum += parseInt(pesel[i]) * weights[i];
            }
            const checkDigit = (10 - (sum % 10)) % 10;

            if (checkDigit !== parseInt(pesel[10])) {
                return { valid: false, error: 'Nieprawidlowy numer PESEL (bledna suma kontrolna).' };
            }

            return { valid: true };
        }

        // Polish ID number validation (3 letters + 6 digits with checksum)
        function validateIdNumber(idNumber) {
            const id = idNumber.toUpperCase().replace(/\s/g, '');

            if (!/^[A-Z]{3}[0-9]{6}$/.test(id)) {
                return { valid: false, error: 'Nr dowodu musi skladac sie z 3 liter i 6 cyfr (np. ABC123456).' };
            }

            // Convert letters to numbers (A=10, B=11, ..., Z=35)
            const letterToNumber = (char) => char.charCodeAt(0) - 55;

            const weights = [7, 3, 1, 7, 3, 1, 7, 3, 1];
            let sum = 0;

            // First 3 characters are letters
            for (let i = 0; i < 3; i++) {
                sum += letterToNumber(id[i]) * weights[i];
            }
            // Next 6 characters are digits
            for (let i = 3; i < 9; i++) {
                sum += parseInt(id[i]) * weights[i];
            }

            // The check digit is the 4th character (index 3)
            const checkDigit = parseInt(id[3]);
            const calculatedCheck = sum % 10;

            // For Polish ID, the check digit validation is different
            // The sum of weighted values should be divisible by 10
            // Actually, Polish ID uses the 4th position as check digit
            // Let me recalculate properly:
            // Series: 3 letters (positions 0-2)
            // Check digit: position 3 (first digit)
            // Number: positions 4-8

            // Simpler approach: validate format and basic checksum
            const seriesWeights = [7, 3, 1];
            const numberWeights = [7, 3, 1, 7, 3, 1];

            let checkSum = 0;
            // Series (letters)
            for (let i = 0; i < 3; i++) {
                checkSum += letterToNumber(id[i]) * seriesWeights[i];
            }
            // Check digit (first digit of number part - position 3)
            const expectedCheck = parseInt(id[3]);
            // Remaining digits (positions 4-8)
            for (let i = 0; i < 5; i++) {
                checkSum += parseInt(id[4 + i]) * numberWeights[i + 1];
            }

            // The check digit should make (checkSum + checkDigit * 7) % 10 == 0
            // Actually Polish ID validation: sum all weighted, check digit included, should give remainder
            // Simplified: just validate format for now, full checksum is complex
            // Most important is format validation

            return { valid: true };
        }

        async function loadProject() {
            const token = getToken();
            if (!token) {
                showScreen('not-found');
                return;
            }

            // Load workflow by token
            const { data: workflowData, error: workflowError } = await supabaseClient
                .from('workflows')
                .select('*')
                .eq('unique_token', token)
                .single();

            if (workflowError || !workflowData) {
                console.error('Error loading workflow:', workflowError);
                showScreen('not-found');
                return;
            }

            workflow = workflowData;

            // Load offer to get contract template URL
            if (workflow.offer_id) {
                const { data: offerData } = await supabaseClient
                    .from('offers')
                    .select('contract_template_url')
                    .eq('id', workflow.offer_id)
                    .single();
                offer = offerData;
            }

            // Check if password is required
            // Check if password needs to be set (first time)
            if (!workflow.client_password_hash) {
                showScreen('set-password');
                return;
            }

            // Check if password is required (already set)
            if (workflow.client_password_hash && !isAuthenticated) {
                showScreen('password');
                return;
            }

            // Log access
            await logAccess();

            // If contract is already signed, skip directly to project
            if (workflow.contract_status === 'signed') {
                // Contract is signed - continue to load project
            } else if (workflow.contract_status === 'pending_data') {
                // Check contract status - if pending_data, show data form first
                prefillContractForm();
                showScreen('contract-data');
                return;
            } else if (workflow.contract_status === 'data_filled' || workflow.contract_status === 'contract_sent' || workflow.contract_status === 'pending_signature') {
                // If data filled but not signed, show signing instructions
                showScreen('contract-signing');
                return;
            }

            // Load milestones
            const { data: milestonesData } = await supabaseClient
                .from('workflow_milestones')
                .select('*')
                .eq('workflow_id', workflow.id)
                .order('milestone_index');

            milestones = milestonesData || [];

            // Load tasks
            const { data: tasksData } = await supabaseClient
                .from('workflow_tasks')
                .select('*')
                .eq('workflow_id', workflow.id)
                .order('task_index');

            tasks = tasksData || [];

            renderProject();
            showScreen('project');
        }

        async function logAccess() {
            try {
                await supabaseClient.from('workflow_access_log').insert({
                    workflow_id: workflow.id,
                    user_agent: navigator.userAgent
                });
            } catch (err) {
                console.log('Could not log access');
            }
        }

        function showScreen(screenName) {
            ['loading', 'set-password', 'password', 'not-found', 'contract-data', 'contract-signing', 'project'].forEach(name => {
                const el = document.getElementById(`${name}-screen`);
                if (el) el.classList.toggle('hidden', name !== screenName);
            });
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('pl-PL', { day: 'numeric', month: 'short', year: 'numeric' });
        }

        function formatDeadline(deadline) {
            if (!deadline) return '-';
            const date = new Date(deadline);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const deadlineDate = new Date(deadline);
            deadlineDate.setHours(0, 0, 0, 0);

            const diffDays = Math.ceil((deadlineDate - today) / (1000 * 60 * 60 * 24));

            if (diffDays < 0) {
                return `<span class="text-red-400">${Math.abs(diffDays)} dni temu</span>`;
            } else if (diffDays === 0) {
                return `<span class="text-amber-400">dzisiaj</span>`;
            } else if (diffDays <= 3) {
                return `<span class="text-amber-400">za ${diffDays} dni</span>`;
            }
            return formatDate(deadline);
        }

        function getStatusLabel(status) {
            const labels = {
                active: { text: 'W realizacji', color: 'bg-emerald-400' },
                completed: { text: 'Ukonczony', color: 'bg-blue-400' },
                paused: { text: 'Wstrzymany', color: 'bg-amber-400' },
                cancelled: { text: 'Anulowany', color: 'bg-red-400' }
            };
            return labels[status] || labels.active;
        }

        function getResponsibleBadge(responsible) {
            const labels = { team: 'TN', client: 'Ty', shared: 'Wspolne' };
            return `<span class="responsible-badge responsible-${responsible}">${labels[responsible] || responsible}</span>`;
        }

        function renderProject() {
            const customerDisplay = workflow.customer_name || workflow.customer_company || workflow.customer_email.split('@')[0];

            // Header
            document.getElementById('header-customer').textContent = customerDisplay;
            document.title = `${customerDisplay} - tomekniedzwiecki.pl`;

            // Overview
            document.getElementById('offer-name').textContent = workflow.offer_name;
            document.getElementById('started-at').textContent = formatDate(workflow.started_at);

            // Status
            const statusInfo = getStatusLabel(workflow.status);
            document.getElementById('status-label').innerHTML = `
                <span class="w-2 h-2 rounded-full ${statusInfo.color}"></span>
                ${statusInfo.text}
            `;

            // Calculate progress
            const totalTasks = tasks.length;
            const completedTasks = tasks.filter(t => t.completed).length;
            const progressPercent = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            const completedMilestones = milestones.filter(m => m.status === 'completed').length;

            document.getElementById('progress-percent').textContent = progressPercent;
            document.getElementById('progress-bar').style.width = progressPercent + '%';
            document.getElementById('completed-tasks').textContent = completedTasks;
            document.getElementById('total-tasks').textContent = totalTasks;
            document.getElementById('completed-milestones').textContent = completedMilestones;
            document.getElementById('total-milestones').textContent = milestones.length;

            // Current deadline
            const currentMilestone = milestones.find(m => m.status === 'in_progress');
            if (currentMilestone) {
                document.getElementById('current-deadline').innerHTML = formatDeadline(currentMilestone.deadline);
            } else {
                document.getElementById('deadline-info').classList.add('hidden');
            }

            // Render milestones
            renderMilestones();
        }

        function renderMilestones() {
            const container = document.getElementById('milestones-container');

            container.innerHTML = milestones.map((milestone, index) => {
                const milestoneTasks = tasks.filter(t => t.milestone_id === milestone.id);
                const completedCount = milestoneTasks.filter(t => t.completed).length;
                const totalCount = milestoneTasks.length;
                const progressPercent = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;

                const isActive = milestone.status === 'in_progress';
                const isCompleted = milestone.status === 'completed';

                const deliverables = milestone.deliverables || [];

                return `
                <div class="milestone-card glass-card rounded-xl overflow-hidden ${isActive ? 'active' : ''} ${isCompleted ? 'completed' : ''}">
                    <!-- Header -->
                    <div class="p-4 flex items-center justify-between cursor-pointer" onclick="toggleMilestone('${milestone.id}')">
                        <div class="flex items-center gap-3">
                            <div class="w-9 h-9 rounded-lg flex items-center justify-center text-sm font-medium ${
                                isCompleted ? 'bg-emerald-500/20 text-emerald-400' :
                                isActive ? 'bg-white text-black' :
                                'bg-[#1a1a1a] text-[#666] border border-[#333]'
                            }">
                                ${isCompleted ? '<i class="ph-bold ph-check text-base"></i>' : index + 1}
                            </div>
                            <div>
                                <h3 class="font-medium ${isCompleted || isActive ? 'text-white' : 'text-[#888]'}">${milestone.title}</h3>
                                <div class="flex items-center gap-2 text-xs text-[#666]">
                                    <span>${formatDate(milestone.start_date)} - ${formatDate(milestone.deadline)}</span>
                                    ${isActive ? `<span class="text-white bg-white/10 px-1.5 py-0.5 rounded text-[10px] font-medium">AKTUALNY</span>` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="text-right hidden sm:block">
                                <div class="text-xs ${isCompleted ? 'text-emerald-400' : 'text-[#888]'}">${progressPercent}%</div>
                                <div class="w-20 h-1 bg-[#1a1a1a] rounded-full overflow-hidden mt-1">
                                    <div class="h-full rounded-full ${isCompleted ? 'bg-emerald-500' : 'bg-white'}" style="width: ${progressPercent}%"></div>
                                </div>
                            </div>
                            <i class="ph ph-caret-down text-[#666] transition-transform" id="chevron-${milestone.id}"></i>
                        </div>
                    </div>

                    <!-- Content -->
                    <div class="milestone-content" id="content-${milestone.id}">
                        <div class="border-t border-white/[0.06]">
                            ${milestone.description ? `
                                <div class="px-4 py-3 border-b border-white/[0.06] text-[#888] text-sm">${milestone.description}</div>
                            ` : ''}

                            <!-- Tasks -->
                            <div class="divide-y divide-white/[0.06]">
                                ${milestoneTasks.map(task => `
                                    <div class="px-4 py-3 flex items-start gap-3">
                                        <div class="w-5 h-5 rounded flex items-center justify-center flex-shrink-0 mt-0.5 ${
                                            task.completed
                                                ? 'bg-emerald-500/20 text-emerald-400'
                                                : 'border border-[#333] text-transparent'
                                        }">
                                            ${task.completed ? '<i class="ph-bold ph-check text-xs"></i>' : ''}
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <span class="${task.completed ? 'text-[#666] line-through' : 'text-white'}">${task.title}</span>
                                            ${task.notes ? `<p class="text-[#666] text-xs mt-1">${task.notes}</p>` : ''}
                                            ${task.links && task.links.length > 0 ? `
                                                <div class="flex flex-wrap gap-2 mt-2">
                                                    ${task.links.map(link => `
                                                        <a href="${link.url}" target="_blank" class="inline-flex items-center gap-1 text-xs text-blue-400 hover:text-blue-300 bg-blue-500/10 px-2 py-1 rounded">
                                                            <i class="ph ph-link"></i>
                                                            ${link.title || 'Link'}
                                                        </a>
                                                    `).join('')}
                                                </div>
                                            ` : ''}
                                        </div>
                                        ${getResponsibleBadge(task.responsible)}
                                    </div>
                                `).join('')}
                            </div>

                            <!-- Deliverables -->
                            ${deliverables.length > 0 ? `
                                <div class="px-4 py-3 border-t border-white/[0.06] bg-white/[0.01]">
                                    <div class="text-xs text-[#666] uppercase tracking-wider mb-2">Rezultaty etapu</div>
                                    <ul class="space-y-1.5">
                                        ${deliverables.map(d => `
                                            <li class="flex items-start gap-2 text-sm text-[#888]">
                                                <i class="ph ph-check-circle text-emerald-400 mt-0.5 flex-shrink-0"></i>
                                                <span>${d}</span>
                                            </li>
                                        `).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `}).join('');

            // Expand active milestone by default
            const activeMilestone = milestones.find(m => m.status === 'in_progress');
            if (activeMilestone) {
                toggleMilestone(activeMilestone.id, true);
            }
        }

        function toggleMilestone(milestoneId, forceOpen = false) {
            const content = document.getElementById(`content-${milestoneId}`);
            const chevron = document.getElementById(`chevron-${milestoneId}`);

            if (forceOpen || !content.classList.contains('expanded')) {
                content.classList.add('expanded');
                chevron.style.transform = 'rotate(180deg)';
            } else {
                content.classList.remove('expanded');
                chevron.style.transform = 'rotate(0deg)';
            }
        }

        // Contract form functions
        function prefillContractForm() {
            if (!workflow) return;

            // Pre-fill known data from workflow
            document.getElementById('cd-name').value = workflow.customer_name || '';
            document.getElementById('cd-company').value = workflow.customer_company || '';
            document.getElementById('cd-nip').value = workflow.client_nip || '';
            document.getElementById('cd-email').value = workflow.customer_email || '';
            document.getElementById('cd-phone').value = workflow.customer_phone || '';
            document.getElementById('cd-street').value = workflow.client_street || '';
            document.getElementById('cd-postal').value = workflow.client_postal_code || '';
            document.getElementById('cd-city').value = workflow.client_city || '';
            document.getElementById('cd-country').value = workflow.client_country || 'Polska';
            document.getElementById('cd-pesel').value = workflow.client_pesel || '';
            document.getElementById('cd-id-number').value = workflow.client_id_number || '';
        }

        async function submitContractData(event) {
            event.preventDefault();

            const form = document.getElementById('contract-form');
            const errorDiv = document.getElementById('contract-form-error');
            const submitBtn = document.getElementById('contract-submit-btn');

            // Validate form
            if (!form.checkValidity()) {
                errorDiv.classList.remove('hidden');
                return;
            }

            // Validate PESEL
            const pesel = document.getElementById('cd-pesel').value.trim();
            const peselValidation = validatePesel(pesel);
            if (!peselValidation.valid) {
                errorDiv.textContent = peselValidation.error;
                errorDiv.classList.remove('hidden');
                document.getElementById('cd-pesel').focus();
                return;
            }

            // Validate ID number
            const idNumber = document.getElementById('cd-id-number').value.trim();
            const idValidation = validateIdNumber(idNumber);
            if (!idValidation.valid) {
                errorDiv.textContent = idValidation.error;
                errorDiv.classList.remove('hidden');
                document.getElementById('cd-id-number').focus();
                return;
            }

            errorDiv.classList.add('hidden');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="w-4 h-4 border-2 border-black/20 border-t-black rounded-full animate-spin"></span>';

            // Collect form data
            contractData = {
                customer_name: document.getElementById('cd-name').value.trim(),
                customer_company: document.getElementById('cd-company').value.trim() || null,
                client_nip: document.getElementById('cd-nip').value.trim() || null,
                client_street: document.getElementById('cd-street').value.trim(),
                client_postal_code: document.getElementById('cd-postal').value.trim(),
                client_city: document.getElementById('cd-city').value.trim(),
                client_country: document.getElementById('cd-country').value.trim(),
                client_pesel: pesel,
                client_id_number: document.getElementById('cd-id-number').value.trim().toUpperCase(),
                customer_email: document.getElementById('cd-email').value.trim(),
                customer_phone: document.getElementById('cd-phone').value.trim(),
                contract_status: 'data_filled',
                contract_data_filled_at: new Date().toISOString()
            };

            // Save to database
            const { error } = await supabaseClient
                .from('workflows')
                .update(contractData)
                .eq('id', workflow.id);

            if (error) {
                console.error('Error saving contract data:', error);
                errorDiv.textContent = 'Wystapil blad podczas zapisywania danych. Sprobuj ponownie.';
                errorDiv.classList.remove('hidden');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<span>Zapisz i kontynuuj</span><i class="ph ph-arrow-right"></i>';
                return;
            }

            // Update local workflow
            Object.assign(workflow, contractData);

            // Show signing screen
            showScreen('contract-signing');
        }

        async function downloadContract() {
            // If there's a signed contract file, open it directly
            if (workflow.contract_file_url) {
                window.open(workflow.contract_file_url, '_blank');
                return;
            }

            // Get contract template URL from offer
            const templateUrl = offer?.contract_template_url;
            if (!templateUrl) {
                alert('Szablon umowy nie zostal jeszcze skonfigurowany dla tej oferty. Skontaktuj sie z nami.');
                return;
            }

            try {
                // Fetch the contract template HTML
                const response = await fetch(templateUrl);
                if (!response.ok) {
                    throw new Error('Nie mozna pobrac szablonu umowy');
                }
                let contractHtml = await response.text();

                // Build full address
                const fullAddress = [
                    workflow.client_street,
                    [workflow.client_postal_code, workflow.client_city].filter(Boolean).join(' '),
                    workflow.client_country
                ].filter(Boolean).join(', ');

                // Build firma line (add after name if company exists)
                const firmaLinia = workflow.customer_company ? ` / ${workflow.customer_company}` : '';

                // Generate contract number from workflow
                const nrUmowy = workflow.order_number || `TN-${new Date().getFullYear()}-${workflow.id?.substring(0, 6).toUpperCase() || '000000'}`;

                // Replace template variables with actual data
                const replacements = {
                    '{{imie_nazwisko}}': workflow.customer_name || '',
                    '{{firma_linia}}': firmaLinia,
                    '{{nip}}': workflow.client_nip || '-',
                    '{{pesel}}': workflow.client_pesel || '',
                    '{{dowod}}': workflow.client_id_number || '',
                    '{{adres}}': fullAddress,
                    '{{email}}': workflow.customer_email || '',
                    '{{telefon}}': workflow.customer_phone || '',
                    '{{nr_umowy}}': nrUmowy,
                    '{{data_zawarcia}}': new Date().toLocaleDateString('pl-PL'),
                    '{{nazwa_oferty}}': workflow.offer_name || '',
                    '{{kwota}}': workflow.amount ? workflow.amount.toLocaleString('pl-PL') + ' PLN' : '',
                    '{{data_rozpoczecia}}': formatDate(workflow.started_at)
                };

                for (const [placeholder, value] of Object.entries(replacements)) {
                    contractHtml = contractHtml.replace(new RegExp(placeholder.replace(/[{}]/g, '\\$&'), 'g'), value);
                }

                // Open contract in new window - user can use built-in "Pobierz PDF" button
                const newWindow = window.open('', '_blank');
                if (newWindow) {
                    newWindow.document.write(contractHtml);
                    newWindow.document.close();
                } else {
                    alert('Nie mozna otworzyc nowego okna. Odblokuj wyskakujace okna w przegladarce.');
                }

            } catch (err) {
                console.error('Error generating contract:', err);
                alert('Wystapil blad podczas generowania umowy. Sprobuj ponownie lub skontaktuj sie z nami.');
            }
        }

        function selectSigningMethod(method) {
            // Visual feedback
            document.querySelectorAll('.signing-option').forEach(el => {
                el.style.borderColor = '#333';
                el.style.background = 'transparent';
            });
            event.currentTarget.style.borderColor = '#888';
            event.currentTarget.style.background = 'rgba(255,255,255,0.02)';

            // The actual signing happens outside the system
            // We just provide instructions here
        }

        async function goBackToEditData() {
            // Reset contract status to pending_data to allow editing
            const { error } = await supabaseClient
                .from('workflows')
                .update({ contract_status: 'pending_data' })
                .eq('id', workflow.id);

            if (error) {
                console.error('Error resetting contract status:', error);
                return;
            }

            workflow.contract_status = 'pending_data';
            prefillContractForm();
            showScreen('contract-data');
        }

        async function skipToProject() {
            // Allow viewing project even without signed contract
            // Load milestones and tasks
            const { data: milestonesData } = await supabaseClient
                .from('workflow_milestones')
                .select('*')
                .eq('workflow_id', workflow.id)
                .order('milestone_index');

            milestones = milestonesData || [];

            const { data: tasksData } = await supabaseClient
                .from('workflow_tasks')
                .select('*')
                .eq('workflow_id', workflow.id)
                .order('task_index');

            tasks = tasksData || [];

            renderProject();
            showScreen('project');
        }

        // Password verification
        // Set password (first time) listeners
        document.getElementById('set-password-btn').addEventListener('click', setPassword);
        document.getElementById('new-password-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') document.getElementById('confirm-password-input').focus();
        });
        document.getElementById('confirm-password-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') setPassword();
        });

        async function setPassword() {
            const password = document.getElementById('new-password-input').value;
            const confirmPassword = document.getElementById('confirm-password-input').value;
            const errorDiv = document.getElementById('set-password-error');
            const btn = document.getElementById('set-password-btn');

            // Validation
            if (!password || password.length < 6) {
                errorDiv.textContent = 'Haslo musi miec minimum 6 znakow.';
                errorDiv.classList.remove('hidden');
                return;
            }

            if (password !== confirmPassword) {
                errorDiv.textContent = 'Hasla nie sa takie same.';
                errorDiv.classList.remove('hidden');
                return;
            }

            errorDiv.classList.add('hidden');
            btn.disabled = true;
            btn.innerHTML = '<span class="w-4 h-4 border-2 border-black/20 border-t-black rounded-full animate-spin"></span>';

            try {
                // Hash the password
                const salt = dcodeIO.bcrypt.genSaltSync(10);
                const hash = dcodeIO.bcrypt.hashSync(password, salt);

                // Save to database
                const { error } = await supabaseClient
                    .from('workflows')
                    .update({ client_password_hash: hash })
                    .eq('id', workflow.id);

                if (error) {
                    throw error;
                }

                // Update local workflow and mark as authenticated
                workflow.client_password_hash = hash;
                isAuthenticated = true;

                // Continue to the next step
                await loadProject();

            } catch (err) {
                console.error('Error setting password:', err);
                errorDiv.textContent = 'Wystapil blad. Sprobuj ponownie.';
                errorDiv.classList.remove('hidden');
                btn.disabled = false;
                btn.innerHTML = '<span>Ustaw haslo i kontynuuj</span><i class="ph ph-arrow-right"></i>';
            }
        }

        // Login password listeners
        document.getElementById('password-btn').addEventListener('click', verifyPassword);
        document.getElementById('password-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') verifyPassword();
        });

        async function verifyPassword() {
            const password = document.getElementById('password-input').value;
            if (!password) return;

            const isValid = dcodeIO.bcrypt.compareSync(password, workflow.client_password_hash);

            if (isValid) {
                isAuthenticated = true;
                document.getElementById('password-error').classList.add('hidden');
                await loadProject();
            } else {
                document.getElementById('password-error').classList.remove('hidden');
                document.getElementById('password-input').value = '';
                document.getElementById('password-input').focus();
            }
        }

        // Make functions global
        window.toggleMilestone = toggleMilestone;
        window.submitContractData = submitContractData;
        window.downloadContract = downloadContract;
        window.selectSigningMethod = selectSigningMethod;
        window.skipToProject = skipToProject;
        window.goBackToEditData = goBackToEditData;

        // Initialize
        loadProject();
    </script>
</body>
</html>
