<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twoj projekt - tomekniedzwiecki.pl</title>
    <link rel="icon" type="image/svg+xml" href="/favicon-tn.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bcryptjs/2.4.3/bcrypt.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    }
                }
            }
        }
    </script>
    <style>
        /* ═══════════════════════════════════════════════════════════════════
           VERCEL DESIGN SYSTEM - Premium Dark Theme
           ═══════════════════════════════════════════════════════════════════ */

        :root {
            --background: #000;
            --background-secondary: #0a0a0a;
            --surface: #111;
            --surface-hover: #171717;
            --border: #1a1a1a;
            --border-hover: #2a2a2a;
            --border-active: #333;
            --text-primary: #fafafa;
            --text-secondary: #a1a1a1;
            --text-tertiary: #666;
            --accent: #fff;
            --accent-secondary: #888;
            --success: #00d084;
            --success-muted: rgba(0, 208, 132, 0.1);
            --warning: #f5a623;
            --warning-muted: rgba(245, 166, 35, 0.1);
            --error: #ee5050;
            --info: #0070f3;
            --info-muted: rgba(0, 112, 243, 0.1);
        }

        body {
            background: var(--background);
            color: var(--text-primary);
            font-feature-settings: 'cv02', 'cv03', 'cv04', 'cv11';
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #222; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #333; }
        ::selection { background: var(--accent); color: var(--background); }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        .animate-enter { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .animate-slide { animation: slideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        /* Design Tokens */
        .border-default { border-color: var(--border); }
        .text-secondary { color: var(--text-secondary); }
        .text-tertiary { color: var(--text-tertiary); }

        /* ═══════════════════════════════════════════════════════════════════
           CARDS - Vercel Surface Style
           ═══════════════════════════════════════════════════════════════════ */
        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .card-hover:hover {
            border-color: var(--border-hover);
            transform: translateY(-1px);
        }
        .card-interactive {
            cursor: pointer;
        }
        .card-interactive:hover {
            border-color: var(--border-active);
            background: var(--surface-hover);
        }

        /* ═══════════════════════════════════════════════════════════════════
           PROGRESS RING - Animated Circle
           ═══════════════════════════════════════════════════════════════════ */
        .progress-ring { transform: rotate(-90deg); }
        .progress-ring-bg { stroke: var(--border); }
        .progress-ring-fill {
            stroke: var(--accent);
            stroke-linecap: round;
            transition: stroke-dashoffset 0.8s cubic-bezier(0.16, 1, 0.3, 1);
        }

        /* ═══════════════════════════════════════════════════════════════════
           MILESTONES
           ═══════════════════════════════════════════════════════════════════ */
        .milestone-card {
            transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
            background: var(--surface);
        }
        .milestone-card:hover {
            border-color: var(--border-hover);
        }
        .milestone-card.active {
            border-color: var(--border-active);
            background: var(--surface);
        }
        .milestone-card.completed {
            border-color: rgba(0, 208, 132, 0.2);
            background: linear-gradient(to right, rgba(0, 208, 132, 0.02), transparent);
        }

        /* ═══════════════════════════════════════════════════════════════════
           FORM INPUTS - Vercel Style
           ═══════════════════════════════════════════════════════════════════ */
        .form-input {
            width: 100%;
            background: var(--background);
            border: 1px solid var(--border-hover);
            border-radius: 8px;
            padding: 11px 14px;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.15s ease;
        }
        .form-input:hover { border-color: var(--border-active); }
        .form-input:focus {
            border-color: var(--accent-secondary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.05);
        }
        .form-input::placeholder { color: var(--text-tertiary); }

        /* ═══════════════════════════════════════════════════════════════════
           BADGES - Vercel Pill Style
           ═══════════════════════════════════════════════════════════════════ */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 5px 10px;
            border-radius: 9999px;
            font-size: 12px;
            font-weight: 500;
            letter-spacing: -0.01em;
            border: 1px solid transparent;
        }
        .badge-success {
            background: var(--success-muted);
            color: var(--success);
            border-color: rgba(0, 208, 132, 0.15);
        }
        .badge-warning {
            background: var(--warning-muted);
            color: var(--warning);
            border-color: rgba(245, 166, 35, 0.15);
        }
        .badge-info {
            background: var(--info-muted);
            color: var(--info);
            border-color: rgba(0, 112, 243, 0.15);
        }
        .badge-neutral {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-secondary);
            border-color: var(--border);
        }
        /* Legacy mappings */
        .badge-emerald { background: var(--success-muted); color: var(--success); border-color: rgba(0, 208, 132, 0.15); }
        .badge-amber { background: var(--warning-muted); color: var(--warning); border-color: rgba(245, 166, 35, 0.15); }
        .badge-blue { background: var(--info-muted); color: var(--info); border-color: rgba(0, 112, 243, 0.15); }
        .badge-violet { background: rgba(139, 92, 246, 0.1); color: #a78bfa; border-color: rgba(139, 92, 246, 0.15); }

        /* Responsible badges */
        .responsible-team {
            background: rgba(139, 92, 246, 0.08);
            color: #c4b5fd;
            border: 1px solid rgba(139, 92, 246, 0.15);
        }
        .responsible-client {
            background: rgba(34, 211, 238, 0.08);
            color: #67e8f9;
            border: 1px solid rgba(34, 211, 238, 0.15);
        }
        .responsible-shared {
            background: rgba(251, 191, 36, 0.08);
            color: #fcd34d;
            border: 1px solid rgba(251, 191, 36, 0.15);
        }

        /* ═══════════════════════════════════════════════════════════════════
           COMMENTS
           ═══════════════════════════════════════════════════════════════════ */
        .comment-team {
            background: var(--surface-hover);
            border: 1px solid var(--border);
            border-radius: 16px 16px 16px 4px;
        }
        .comment-client {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(139, 92, 246, 0.05));
            border: 1px solid rgba(139, 92, 246, 0.15);
            border-radius: 16px 16px 4px 16px;
        }

        /* ═══════════════════════════════════════════════════════════════════
           BUTTONS - Vercel Style
           ═══════════════════════════════════════════════════════════════════ */
        .btn-primary {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: var(--accent);
            color: var(--background);
            font-weight: 500;
            font-size: 14px;
            padding: 10px 16px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        .btn-primary:hover {
            background: #e5e5e5;
            transform: translateY(-1px);
        }
        .btn-primary:active { transform: translateY(0); }

        .btn-secondary {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: transparent;
            color: var(--text-primary);
            font-weight: 500;
            font-size: 14px;
            padding: 10px 16px;
            border-radius: 8px;
            border: 1px solid var(--border-hover);
            cursor: pointer;
            transition: all 0.15s ease;
        }
        .btn-secondary:hover {
            background: var(--surface);
            border-color: var(--border-active);
        }

        /* ═══════════════════════════════════════════════════════════════════
           SECTION HEADERS
           ═══════════════════════════════════════════════════════════════════ */
        .section-title {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 16px;
        }
        .page-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            letter-spacing: -0.02em;
            margin-bottom: 24px;
        }

        /* ═══════════════════════════════════════════════════════════════════
           EMPTY STATES
           ═══════════════════════════════════════════════════════════════════ */
        .empty-state {
            padding: 32px 0;
        }

        /* ═══════════════════════════════════════════════════════════════════
           SPECIAL ELEMENTS
           ═══════════════════════════════════════════════════════════════════ */
        .gradient-border {
            position: relative;
            background: var(--surface);
            border-radius: 12px;
        }
        .gradient-border::before {
            content: '';
            position: absolute;
            inset: -1px;
            border-radius: 13px;
            padding: 1px;
            background: linear-gradient(135deg, rgba(255,255,255,0.1), transparent, rgba(0, 208, 132, 0.2));
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            pointer-events: none;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            letter-spacing: -0.03em;
            background: linear-gradient(180deg, #fff 0%, #999 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .glow-success {
            box-shadow: 0 0 20px -5px rgba(0, 208, 132, 0.3);
        }

        /* File icons with colors */
        .file-icon-pdf { color: #ee5050; }
        .file-icon-doc { color: #0070f3; }
        .file-icon-img { color: #00d084; }
        .file-icon-video { color: #f5a623; }

        /* ═══════════════════════════════════════════════════════════════════
           RESPONSIVE
           ═══════════════════════════════════════════════════════════════════ */
        /* ═══════════════════════════════════════════════════════════════════
           SIDEBAR NAVIGATION
           ═══════════════════════════════════════════════════════════════════ */
        .sidebar-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 450;
            color: var(--text-secondary);
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all 0.15s ease;
            text-align: left;
        }
        .sidebar-btn:hover {
            color: var(--text-primary);
            background: var(--surface);
        }
        .sidebar-btn.active {
            color: var(--text-primary);
            background: var(--surface-hover);
        }
        .sidebar-btn i {
            font-size: 16px;
            opacity: 0.7;
            width: 18px;
            text-align: center;
            flex-shrink: 0;
        }
        .sidebar-btn.active i { opacity: 1; }

        @media (max-width: 768px) {
            .stat-value { font-size: 24px; }
        }
    </style>
</head>
<body class="min-h-screen font-sans antialiased">

    <!-- Loading Screen -->
    <div id="loading-screen" class="min-h-screen flex items-center justify-center bg-black">
        <div class="text-center animate-enter">
            <div class="w-7 h-7 mx-auto mb-5 border-2 border-[#222] border-t-white rounded-full animate-spin"></div>
            <p class="text-tertiary text-sm">Ładowanie projektu...</p>
        </div>
    </div>

    <!-- Not Found Screen -->
    <div id="not-found-screen" class="hidden min-h-screen flex items-center justify-center p-4 bg-black">
        <div class="text-center animate-enter max-w-md">
            <div class="w-14 h-14 mx-auto mb-6 rounded-xl bg-[#111] border border-[#222] flex items-center justify-center">
                <i class="ph ph-warning text-2xl text-[#f5a623]"></i>
            </div>
            <h1 class="text-xl font-semibold text-white mb-3">Projekt nie znaleziony</h1>
            <p class="text-tertiary text-sm leading-relaxed">Link do projektu jest nieprawidłowy lub wygasł.<br>Skontaktuj się z zespołem.</p>
        </div>
    </div>

    <!-- Set Password Screen (First Time) -->
    <div id="set-password-screen" class="hidden min-h-screen flex items-center justify-center p-4 bg-black">
        <div class="w-full max-w-sm animate-enter">
            <div class="text-center mb-8">
                <div class="w-12 h-12 mx-auto mb-5 rounded-xl bg-[#00d084]/10 border border-[#00d084]/20 flex items-center justify-center">
                    <i class="ph ph-lock-key text-xl text-[#00d084]"></i>
                </div>
                <h1 class="text-xl font-semibold text-white mb-2 tracking-tight">Ustaw hasło dostępu</h1>
                <p class="text-tertiary text-sm">Utwórz hasło do logowania do projektu.</p>
            </div>

            <div class="card p-6">
                <form onsubmit="setPassword(event)">
                    <div class="mb-4">
                        <label class="block text-tertiary text-xs uppercase tracking-wider mb-2">Hasło</label>
                        <input type="password" id="set-password-input" class="form-input" placeholder="Minimum 6 znaków" required minlength="6">
                    </div>
                    <div class="mb-6">
                        <label class="block text-tertiary text-xs uppercase tracking-wider mb-2">Potwierdź hasło</label>
                        <input type="password" id="set-password-confirm" class="form-input" placeholder="Powtórz hasło" required>
                    </div>
                    <button type="submit" class="btn-primary w-full py-3">
                        Ustaw hasło
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Password Screen (Login) -->
    <div id="password-screen" class="hidden min-h-screen flex items-center justify-center p-4 bg-black">
        <div class="w-full max-w-sm animate-enter">
            <div class="text-center mb-8">
                <div class="w-12 h-12 mx-auto mb-5 rounded-xl bg-[#111] border border-[#222] flex items-center justify-center">
                    <i class="ph ph-lock text-xl text-[#666]"></i>
                </div>
                <h1 class="text-xl font-semibold text-white mb-2 tracking-tight">Zaloguj się</h1>
                <p class="text-tertiary text-sm">Wprowadź hasło, aby uzyskać dostęp.</p>
            </div>

            <div class="card p-6">
                <form onsubmit="checkPassword(event)">
                    <div class="mb-6">
                        <label class="block text-tertiary text-xs uppercase tracking-wider mb-2">Hasło</label>
                        <input type="password" id="password-input" class="form-input" placeholder="Wprowadź hasło" required>
                    </div>
                    <button type="submit" class="btn-primary w-full py-3">
                        Zaloguj
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Contract Data Screen -->
    <div id="contract-data-screen" class="hidden min-h-screen flex items-center justify-center p-4 py-12 bg-black">
        <div class="w-full max-w-2xl animate-enter">
            <div class="text-center mb-8">
                <div class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-[#00d084]/10 border border-[#00d084]/20 text-[#00d084] text-xs font-medium mb-5">
                    <i class="ph ph-check-circle"></i>
                    Krok 1 z 2
                </div>
                <h1 class="text-2xl font-semibold text-white mb-2 tracking-tight">Dane do umowy</h1>
                <p class="text-tertiary text-sm">Wprowadź dane potrzebne do przygotowania umowy.</p>
            </div>

            <div class="card p-6 md:p-8">
                <form onsubmit="submitContractData(event)">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-5">
                        <div>
                            <label class="block text-tertiary text-xs uppercase tracking-wider mb-2">Imię i nazwisko *</label>
                            <input type="text" id="contract-name" class="form-input" required>
                        </div>
                        <div>
                            <label class="block text-tertiary text-xs uppercase tracking-wider mb-2">Firma (opcjonalnie)</label>
                            <input type="text" id="contract-company" class="form-input">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-5">
                        <div>
                            <label class="block text-tertiary text-xs uppercase tracking-wider mb-2">PESEL *</label>
                            <input type="text" id="contract-pesel" class="form-input" maxlength="11" required>
                            <p id="pesel-error" class="text-[#ee5050] text-xs mt-1.5 hidden"></p>
                        </div>
                        <div>
                            <label class="block text-tertiary text-xs uppercase tracking-wider mb-2">Nr dowodu osobistego *</label>
                            <input type="text" id="contract-id" class="form-input" maxlength="9" required>
                            <p id="id-error" class="text-[#ee5050] text-xs mt-1.5 hidden"></p>
                        </div>
                    </div>

                    <div class="mb-5">
                        <label class="block text-tertiary text-xs uppercase tracking-wider mb-2">NIP (opcjonalnie)</label>
                        <input type="text" id="contract-nip" class="form-input" maxlength="10">
                    </div>

                    <div class="mb-5">
                        <label class="block text-tertiary text-xs uppercase tracking-wider mb-2">Ulica i numer *</label>
                        <input type="text" id="contract-street" class="form-input" required>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-5">
                        <div>
                            <label class="block text-tertiary text-xs uppercase tracking-wider mb-2">Kod pocztowy *</label>
                            <input type="text" id="contract-postal" class="form-input" placeholder="00-000" required>
                        </div>
                        <div>
                            <label class="block text-tertiary text-xs uppercase tracking-wider mb-2">Miasto *</label>
                            <input type="text" id="contract-city" class="form-input" required>
                        </div>
                        <div class="col-span-2 md:col-span-1">
                            <label class="block text-tertiary text-xs uppercase tracking-wider mb-2">Kraj *</label>
                            <input type="text" id="contract-country" class="form-input" value="Polska" required>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                        <div>
                            <label class="block text-tertiary text-xs uppercase tracking-wider mb-2">Email *</label>
                            <input type="email" id="contract-email" class="form-input" required>
                        </div>
                        <div>
                            <label class="block text-tertiary text-xs uppercase tracking-wider mb-2">Telefon</label>
                            <input type="tel" id="contract-phone" class="form-input">
                        </div>
                    </div>

                    <button type="submit" class="btn-primary w-full py-3">
                        Dalej
                        <i class="ph ph-arrow-right"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Contract Signing Screen -->
    <div id="contract-signing-screen" class="hidden min-h-screen flex items-center justify-center p-4 py-12 bg-black">
        <div class="w-full max-w-2xl animate-enter">
            <div class="text-center mb-8">
                <div class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-violet-500/10 border border-violet-500/20 text-violet-400 text-xs font-medium mb-5">
                    <i class="ph ph-signature"></i>
                    Krok 2 z 2
                </div>
                <h1 class="text-2xl font-semibold text-white mb-2 tracking-tight">Podpisanie umowy</h1>
                <p class="text-tertiary text-sm">Pobierz umowę, podpisz ją i prześlij do nas.</p>
            </div>

            <div class="card p-6 md:p-8 mb-4">
                <div class="flex items-center gap-4 p-4 bg-black/50 rounded-xl border border-[#1a1a1a] mb-6">
                    <div class="w-11 h-11 rounded-xl bg-[#ee5050]/10 flex items-center justify-center flex-shrink-0">
                        <i class="ph ph-file-pdf text-xl text-[#ee5050]"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-white font-medium text-sm">Umowa do podpisu</p>
                        <p class="text-tertiary text-xs">Dokument PDF</p>
                    </div>
                    <a id="download-contract-btn" href="#" target="_blank" class="btn-primary text-sm py-2">
                        <i class="ph ph-download-simple"></i>
                        Pobierz
                    </a>
                </div>

                <div class="space-y-3">
                    <h3 class="text-white font-medium text-sm mb-4">Jak podpisać umowę?</h3>

                    <div class="p-4 border border-[#00d084]/20 bg-[#00d084]/5 rounded-xl">
                        <div class="flex items-start gap-3">
                            <div class="w-6 h-6 rounded-full bg-[#00d084]/20 flex items-center justify-center flex-shrink-0 mt-0.5">
                                <span class="text-[#00d084] text-xs font-bold">1</span>
                            </div>
                            <div>
                                <p class="text-white font-medium text-sm mb-1">Podpis zaufany (gov.pl)</p>
                                <p class="text-tertiary text-sm">Najszybsza opcja. Podpisz bezpłatnie przez profil zaufany na <a href="https://www.gov.pl/web/podpis-zaufany" target="_blank" class="text-[#00d084] hover:underline">gov.pl</a>.</p>
                            </div>
                        </div>
                    </div>

                    <div class="p-4 border border-[#1a1a1a] rounded-xl">
                        <div class="flex items-start gap-3">
                            <div class="w-6 h-6 rounded-full bg-[#1a1a1a] flex items-center justify-center flex-shrink-0 mt-0.5">
                                <span class="text-tertiary text-xs font-bold">2</span>
                            </div>
                            <div>
                                <p class="text-white font-medium text-sm mb-1">Podpis kwalifikowany</p>
                                <p class="text-tertiary text-sm">Jeśli posiadasz certyfikat kwalifikowany (np. Certum, Sigillum).</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card p-5">
                <p class="text-tertiary text-sm mb-4 flex items-start gap-2">
                    <i class="ph ph-info text-[#0070f3] mt-0.5"></i>
                    <span>Po podpisaniu umowy wyślij ją do nas mailem. Otrzymasz powiadomienie gdy umowa zostanie zaakceptowana.</span>
                </p>
                <button onclick="goToProject()" class="btn-secondary w-full py-3">
                    Przejdź do projektu
                </button>
            </div>
        </div>
    </div>

    <!-- Main Project Screen -->
    <div id="project-screen" class="hidden min-h-screen flex flex-col">
        <!-- Top Header Bar -->
        <header class="sticky top-0 z-40 bg-black/80 backdrop-blur-xl border-b border-[#1a1a1a] md:hidden">
            <div class="flex items-center justify-between h-14 px-4">
                <div class="flex items-center gap-3">
                    <div class="w-7 h-7 rounded-md bg-white flex items-center justify-center">
                        <span class="text-black text-[10px] font-bold tracking-tight">TN</span>
                    </div>
                    <h1 id="project-title-mobile" class="text-[15px] font-medium text-white tracking-tight truncate max-w-[200px]">Projekt</h1>
                </div>
                <button onclick="toggleMobileMenu()" id="mobile-menu-btn" class="w-9 h-9 flex items-center justify-center rounded-lg hover:bg-[#111] transition-colors">
                    <i class="ph ph-list text-xl text-white"></i>
                </button>
            </div>
        </header>

        <!-- Layout: Sidebar + Content -->
        <div class="flex flex-1">
            <!-- Sidebar -->
            <aside id="sidebar" class="hidden md:flex flex-col w-[240px] min-w-[240px] border-r border-[#1a1a1a] bg-black sticky top-0 h-screen overflow-y-auto">
                <!-- Logo & Project -->
                <div class="p-4 border-b border-[#1a1a1a]">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-7 h-7 rounded-md bg-white flex items-center justify-center flex-shrink-0">
                            <span class="text-black text-[10px] font-bold tracking-tight">TN</span>
                        </div>
                        <span class="text-[13px] text-tertiary">tomekniedzwiecki.pl</span>
                    </div>
                    <h1 id="project-title" class="text-[15px] font-medium text-white tracking-tight leading-tight mb-2">Projekt</h1>
                    <span id="project-status-badge" class="badge badge-success">
                        <span class="w-1.5 h-1.5 rounded-full bg-current animate-pulse"></span>
                        Aktywny
                    </span>
                </div>

                <!-- Navigation -->
                <nav class="flex-1 py-3 px-2">
                    <div class="mb-1">
                        <p class="px-3 py-2 text-[10px] uppercase tracking-widest text-tertiary font-medium">Projekt</p>
                    </div>
                    <button onclick="switchTab('projekt')" data-tab="projekt" class="sidebar-btn active">
                        <i class="ph ph-house-simple"></i>
                        Przegląd
                    </button>
                    <button onclick="switchTab('dokumenty')" data-tab="dokumenty" class="sidebar-btn">
                        <i class="ph ph-file-text"></i>
                        Dokumenty
                    </button>
                    <button onclick="switchTab('materialy')" data-tab="materialy" class="sidebar-btn">
                        <i class="ph ph-folder-open"></i>
                        Materiały
                    </button>
                    <button onclick="switchTab('branding')" data-tab="branding" class="sidebar-btn">
                        <i class="ph ph-paint-brush"></i>
                        Branding
                    </button>

                    <div class="mb-1 mt-4">
                        <p class="px-3 py-2 text-[10px] uppercase tracking-widest text-tertiary font-medium">Pozostałe</p>
                    </div>
                    <button onclick="switchTab('strona')" data-tab="strona" class="sidebar-btn">
                        <i class="ph ph-globe"></i>
                        Strona
                    </button>
                    <button onclick="switchTab('produkty')" data-tab="produkty" class="sidebar-btn">
                        <i class="ph ph-package"></i>
                        Produkty
                    </button>
                    <button onclick="switchTab('raporty')" data-tab="raporty" class="sidebar-btn">
                        <i class="ph ph-chart-line-up"></i>
                        Raporty
                    </button>
                    <button onclick="switchTab('komentarze')" data-tab="komentarze" class="sidebar-btn relative">
                        <i class="ph ph-chat-circle-text"></i>
                        Komentarze
                        <span id="comments-badge" class="hidden ml-auto bg-[#00d084] text-black text-[10px] font-bold rounded-full min-w-[18px] h-[18px] flex items-center justify-center px-1">0</span>
                    </button>
                </nav>

                <!-- Footer -->
                <div class="p-4 border-t border-[#1a1a1a]">
                    <a href="mailto:kontakt@tomekniedzwiecki.pl" class="text-tertiary hover:text-secondary text-xs transition-colors">Kontakt</a>
                </div>
            </aside>

            <!-- Mobile Menu Overlay -->
            <div id="mobile-menu" class="hidden fixed inset-0 z-50 md:hidden">
                <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="toggleMobileMenu()"></div>
                <div class="absolute left-0 top-0 bottom-0 w-[260px] bg-black border-r border-[#1a1a1a] animate-slide overflow-y-auto">
                    <div class="p-4 border-b border-[#1a1a1a] flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-7 h-7 rounded-md bg-white flex items-center justify-center">
                                <span class="text-black text-[10px] font-bold">TN</span>
                            </div>
                            <span class="text-[13px] text-tertiary">Projekt</span>
                        </div>
                        <button onclick="toggleMobileMenu()" class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-[#111]">
                            <i class="ph ph-x text-lg text-white"></i>
                        </button>
                    </div>
                    <nav class="py-3 px-2" id="mobile-nav">
                        <button onclick="switchTab('projekt');toggleMobileMenu()" data-tab="projekt" class="sidebar-btn active">
                            <i class="ph ph-house-simple"></i> Przegląd
                        </button>
                        <button onclick="switchTab('dokumenty');toggleMobileMenu()" data-tab="dokumenty" class="sidebar-btn">
                            <i class="ph ph-file-text"></i> Dokumenty
                        </button>
                        <button onclick="switchTab('materialy');toggleMobileMenu()" data-tab="materialy" class="sidebar-btn">
                            <i class="ph ph-folder-open"></i> Materiały
                        </button>
                        <button onclick="switchTab('branding');toggleMobileMenu()" data-tab="branding" class="sidebar-btn">
                            <i class="ph ph-paint-brush"></i> Branding
                        </button>
                        <button onclick="switchTab('strona');toggleMobileMenu()" data-tab="strona" class="sidebar-btn">
                            <i class="ph ph-globe"></i> Strona
                        </button>
                        <button onclick="switchTab('produkty');toggleMobileMenu()" data-tab="produkty" class="sidebar-btn">
                            <i class="ph ph-package"></i> Produkty
                        </button>
                        <button onclick="switchTab('raporty');toggleMobileMenu()" data-tab="raporty" class="sidebar-btn">
                            <i class="ph ph-chart-line-up"></i> Raporty
                        </button>
                        <button onclick="switchTab('komentarze');toggleMobileMenu()" data-tab="komentarze" class="sidebar-btn">
                            <i class="ph ph-chat-circle-text"></i> Komentarze
                        </button>
                    </nav>
                </div>
            </div>

            <!-- Main Content -->
            <main class="flex-1 min-w-0 px-4 md:px-10 py-8 md:py-10">

            <!-- TAB: Projekt -->
            <div id="tab-projekt" class="tab-panel animate-enter">
                <!-- Progress Overview -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-10">
                    <!-- Progress Card -->
                    <div class="card p-6">
                        <div class="flex items-center gap-6">
                            <div class="relative">
                                <svg class="progress-ring w-[72px] h-[72px]" viewBox="0 0 100 100">
                                    <circle class="progress-ring-bg" cx="50" cy="50" r="42" fill="none" stroke-width="5"/>
                                    <circle id="progress-ring-fill" class="progress-ring-fill" cx="50" cy="50" r="42" fill="none" stroke-width="5" stroke-dasharray="264" stroke-dashoffset="264"/>
                                </svg>
                                <div class="absolute inset-0 flex items-center justify-center">
                                    <span id="progress-percent" class="text-lg font-semibold text-white">0%</span>
                                </div>
                            </div>
                            <div>
                                <p class="text-tertiary text-xs uppercase tracking-wider mb-1">Postęp</p>
                                <p class="text-white text-lg font-semibold tracking-tight"><span id="completed-tasks">0</span><span class="text-tertiary font-normal"> / <span id="total-tasks">0</span> zadań</span></p>
                            </div>
                        </div>
                    </div>

                    <!-- Current Milestone Card -->
                    <div class="card p-6">
                        <p class="text-tertiary text-xs uppercase tracking-wider mb-3">Aktualny etap</p>
                        <p id="current-milestone" class="text-white font-semibold mb-3 leading-tight tracking-tight">-</p>
                        <p class="text-sm"><span class="text-tertiary">Deadline</span> <span class="text-white font-medium" id="current-deadline">-</span></p>
                    </div>

                    <!-- Project Info Card -->
                    <div class="card p-6">
                        <p class="text-tertiary text-xs uppercase tracking-wider mb-3">Projekt</p>
                        <p id="offer-name" class="text-white font-semibold mb-3 leading-tight tracking-tight">-</p>
                        <p class="text-sm"><span class="text-tertiary">Start</span> <span class="text-white font-medium" id="started-at">-</span></p>
                    </div>
                </div>

                <!-- Milestones -->
                <div>
                    <h2 class="section-title">Etapy realizacji</h2>
                    <div id="milestones-container" class="space-y-3">
                        <!-- Milestones rendered here -->
                    </div>
                </div>
            </div>

            <!-- TAB: Dokumenty -->
            <div id="tab-dokumenty" class="tab-panel hidden animate-enter">
                <h2 class="page-title">Dokumenty</h2>

                <!-- Signed Contract Section -->
                <div id="signed-contract-section" class="hidden mb-6">
                    <div class="card p-5 glow-success" style="border-color: rgba(0, 208, 132, 0.2); background: linear-gradient(to right, rgba(0, 208, 132, 0.05), transparent);">
                        <div class="flex items-center justify-between flex-wrap gap-4">
                            <div class="flex items-center gap-4">
                                <div class="w-11 h-11 rounded-xl bg-[#00d084]/10 flex items-center justify-center">
                                    <i class="ph ph-seal-check text-xl text-[#00d084]"></i>
                                </div>
                                <div>
                                    <p class="text-white font-medium">Podpisana umowa</p>
                                    <p class="text-[#00d084] text-sm">Umowa podpisana przez obie strony</p>
                                </div>
                            </div>
                            <a id="signed-contract-download" href="#" target="_blank" class="btn-primary bg-[#00d084] hover:bg-[#00b871]">
                                <i class="ph ph-download-simple"></i>
                                Pobierz
                            </a>
                        </div>
                    </div>
                </div>

                <div id="documents-list" class="space-y-3">
                    <!-- Documents rendered here -->
                </div>

                <div id="documents-empty" class="empty-state">
                    <div class="card p-10 md:p-16 text-center max-w-lg mx-auto" style="border-style: dashed;">
                        <div class="w-16 h-16 mx-auto mb-5 rounded-2xl bg-[#111] border border-[#222] flex items-center justify-center">
                            <i class="ph ph-file-text text-3xl text-[#444]"></i>
                        </div>
                        <h3 class="text-white font-medium text-lg mb-2">Brak dokumentów</h3>
                        <p class="text-tertiary text-sm leading-relaxed">Umowy, faktury i inne ważne dokumenty pojawią się tutaj, gdy zostaną dodane przez zespół.</p>
                    </div>
                </div>
            </div>

            <!-- TAB: Materialy -->
            <div id="tab-materialy" class="tab-panel hidden animate-enter">
                <h2 class="page-title">Materiały</h2>

                <div id="materials-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Materials rendered here -->
                </div>

                <div id="materials-empty" class="empty-state">
                    <div class="card p-10 md:p-16 text-center max-w-lg mx-auto" style="border-style: dashed;">
                        <div class="w-16 h-16 mx-auto mb-5 rounded-2xl bg-[#111] border border-[#222] flex items-center justify-center">
                            <i class="ph ph-folder-open text-3xl text-[#444]"></i>
                        </div>
                        <h3 class="text-white font-medium text-lg mb-2">Brak materiałów</h3>
                        <p class="text-tertiary text-sm leading-relaxed">Pliki projektowe, grafiki i inne materiały będą dostępne tutaj w miarę postępu prac.</p>
                    </div>
                </div>
            </div>

            <!-- TAB: Branding -->
            <div id="tab-branding" class="tab-panel hidden animate-enter">
                <h2 class="page-title">Branding</h2>

                <!-- Logos -->
                <div class="mb-10">
                    <h3 class="section-title">Logo</h3>
                    <div id="branding-logos" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <!-- Logos rendered here -->
                    </div>
                    <div id="branding-logos-empty" class="card p-10 text-center" style="border-style: dashed;">
                        <div class="w-12 h-12 mx-auto mb-3 rounded-xl bg-[#111] border border-[#222] flex items-center justify-center">
                            <i class="ph ph-image text-xl text-[#444]"></i>
                        </div>
                        <p class="text-tertiary text-sm">Logotypy pojawią się tutaj</p>
                    </div>
                </div>

                <!-- Colors -->
                <div class="mb-10">
                    <h3 class="section-title">Kolory</h3>
                    <div id="branding-colors" class="flex flex-wrap gap-3">
                        <!-- Colors rendered here -->
                    </div>
                    <div id="branding-colors-empty" class="card p-8 text-center" style="border-style: dashed;">
                        <div class="flex justify-center gap-2 mb-3">
                            <div class="w-8 h-8 rounded-full bg-[#1a1a1a] border border-[#222]"></div>
                            <div class="w-8 h-8 rounded-full bg-[#1a1a1a] border border-[#222]"></div>
                            <div class="w-8 h-8 rounded-full bg-[#1a1a1a] border border-[#222]"></div>
                        </div>
                        <p class="text-tertiary text-sm">Paleta kolorów pojawi się tutaj</p>
                    </div>
                </div>

                <!-- Fonts -->
                <div class="mb-10">
                    <h3 class="section-title">Czcionki</h3>
                    <div id="branding-fonts" class="space-y-3">
                        <!-- Fonts rendered here -->
                    </div>
                    <div id="branding-fonts-empty" class="card p-8 text-center" style="border-style: dashed;">
                        <p class="text-[#333] text-2xl font-semibold mb-2">Aa</p>
                        <p class="text-tertiary text-sm">Czcionki pojawią się tutaj</p>
                    </div>
                </div>

                <!-- Guidelines -->
                <div>
                    <h3 class="section-title">Wytyczne</h3>
                    <div id="branding-guidelines" class="space-y-3">
                        <!-- Guidelines rendered here -->
                    </div>
                    <div id="branding-guidelines-empty" class="card p-8 text-center" style="border-style: dashed;">
                        <div class="w-12 h-12 mx-auto mb-3 rounded-xl bg-[#111] border border-[#222] flex items-center justify-center">
                            <i class="ph ph-book-open text-xl text-[#444]"></i>
                        </div>
                        <p class="text-tertiary text-sm">Wytyczne brandingowe pojawią się tutaj</p>
                    </div>
                </div>
            </div>

            <!-- TAB: Strona -->
            <div id="tab-strona" class="tab-panel hidden animate-enter">
                <h2 class="page-title">Strona sprzedażowa</h2>

                <div id="sales-page-content" class="hidden">
                    <div class="card overflow-hidden">
                        <div class="aspect-video bg-[#0a0a0a] relative">
                            <iframe id="sales-page-iframe" class="w-full h-full" src=""></iframe>
                        </div>
                        <div class="p-4 flex items-center justify-between border-t border-[#1a1a1a] flex-wrap gap-3">
                            <div class="flex items-center gap-3">
                                <span id="sales-page-status" class="badge badge-success">
                                    <span class="w-1.5 h-1.5 rounded-full bg-current"></span>
                                    Live
                                </span>
                                <span id="sales-page-url-display" class="text-tertiary text-sm truncate max-w-xs font-mono"></span>
                            </div>
                            <a id="sales-page-link" href="#" target="_blank" class="btn-secondary text-sm py-2">
                                Otwórz stronę
                                <i class="ph ph-arrow-square-out"></i>
                            </a>
                        </div>
                    </div>
                </div>

                <div id="sales-page-empty" class="empty-state">
                    <div class="card p-10 md:p-16 text-center max-w-lg mx-auto" style="border-style: dashed;">
                        <div class="w-16 h-16 mx-auto mb-5 rounded-2xl bg-[#111] border border-[#222] flex items-center justify-center">
                            <i class="ph ph-globe text-3xl text-[#444]"></i>
                        </div>
                        <h3 class="text-white font-medium text-lg mb-2">Brak strony sprzedażowej</h3>
                        <p class="text-tertiary text-sm leading-relaxed">Link do Twojej strony sprzedażowej pojawi się tutaj, gdy zostanie przygotowana.</p>
                    </div>
                </div>
            </div>

            <!-- TAB: Produkty -->
            <div id="tab-produkty" class="tab-panel hidden animate-enter">
                <h2 class="page-title">Propozycje produktowe</h2>
                <p class="text-tertiary text-sm mb-6">Wybierz produkt, wokół którego zbudujemy Twój sklep i markę.</p>

                <!-- Selected product hero -->
                <div id="product-selected-hero" class="hidden mb-8"></div>

                <div id="products-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5">
                    <!-- Products rendered here -->
                </div>

                <div id="products-empty" class="empty-state">
                    <div class="card p-10 md:p-16 text-center max-w-lg mx-auto" style="border-style: dashed;">
                        <div class="w-16 h-16 mx-auto mb-5 rounded-2xl bg-[#111] border border-[#222] flex items-center justify-center">
                            <i class="ph ph-package text-3xl text-[#444]"></i>
                        </div>
                        <h3 class="text-white font-medium text-lg mb-2">Brak produktów</h3>
                        <p class="text-tertiary text-sm leading-relaxed">Propozycje produktowe pojawią się tutaj wkrótce.</p>
                    </div>
                </div>
            </div>

            <!-- TAB: Raporty -->
            <div id="tab-raporty" class="tab-panel hidden animate-enter">
                <h2 class="page-title">Raporty</h2>

                <div id="reports-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Reports rendered here -->
                </div>

                <div id="reports-empty" class="empty-state">
                    <div class="card p-10 md:p-16 text-center max-w-lg mx-auto" style="border-style: dashed;">
                        <div class="w-16 h-16 mx-auto mb-5 rounded-2xl bg-[#111] border border-[#222] flex items-center justify-center">
                            <i class="ph ph-chart-line-up text-3xl text-[#444]"></i>
                        </div>
                        <h3 class="text-white font-medium text-lg mb-2">Brak raportów</h3>
                        <p class="text-tertiary text-sm leading-relaxed">Raporty analityczne i wyniki kampanii będą widoczne tutaj po ich wygenerowaniu.</p>
                    </div>
                </div>
            </div>

            <!-- TAB: Komentarze -->
            <div id="tab-komentarze" class="tab-panel hidden animate-enter">
                <h2 class="page-title">Komentarze</h2>

                <div class="max-w-2xl">
                    <div id="comments-list" class="space-y-4 mb-6">
                        <!-- Comments rendered here -->
                    </div>

                    <div id="comments-empty" class="card p-10 text-center mb-6" style="border-style: dashed;">
                        <div class="w-14 h-14 mx-auto mb-4 rounded-2xl bg-[#111] border border-[#222] flex items-center justify-center">
                            <i class="ph ph-chat-circle-text text-2xl text-[#444]"></i>
                        </div>
                        <h3 class="text-white font-medium mb-1">Brak komentarzy</h3>
                        <p class="text-tertiary text-sm">Rozpocznij rozmowę z zespołem poniżej</p>
                    </div>

                    <!-- Add Comment Form -->
                    <div class="card p-5">
                        <textarea id="new-comment" rows="3" class="form-input resize-none mb-4" placeholder="Napisz komentarz..."></textarea>
                        <div class="flex justify-end">
                            <button onclick="postComment()" class="btn-primary">
                                <i class="ph ph-paper-plane-tilt"></i>
                                Wyślij
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </main>
        </div><!-- /flex layout -->
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-6 right-6 z-50 hidden">
        <div class="bg-[#111] border border-[#222] text-white pl-4 pr-5 py-3 rounded-lg shadow-2xl flex items-center gap-3 animate-slide">
            <i id="toast-icon" class="ph ph-check-circle text-[#00d084]"></i>
            <span id="toast-message" class="text-sm">Sukces</span>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://yxmavwkwnfuphjqbelws.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl4bWF2d2t3bmZ1cGhqcWJlbHdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NjQyNTUsImV4cCI6MjA4NDM0MDI1NX0.XeR0Fc7OFn6YbNJrOKTBEj36JtmLISZTM87y4ai9340';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let workflow = null;
        let milestones = [];
        let tasks = [];
        let documents = [];
        let materials = [];
        let brandingItems = [];
        let products = [];
        let reports = [];
        let comments = [];
        let isAuthenticated = false;

        function getAuthKey() {
            return `auth_${getToken()}`;
        }

        function checkSavedAuth() {
            const saved = localStorage.getItem(getAuthKey());
            if (!saved) return false;
            try {
                const { expires } = JSON.parse(saved);
                if (Date.now() < expires) return true;
                localStorage.removeItem(getAuthKey());
            } catch (e) { localStorage.removeItem(getAuthKey()); }
            return false;
        }

        function saveAuth() {
            localStorage.setItem(getAuthKey(), JSON.stringify({ expires: Date.now() + 7 * 24 * 60 * 60 * 1000 }));
        }

        function getToken() {
            const path = window.location.pathname;
            const match = path.match(/\/projekt\/([a-f0-9]+)/i);
            return match ? match[1] : null;
        }

        function showScreen(screenName) {
            ['loading', 'set-password', 'password', 'not-found', 'contract-data', 'contract-signing', 'project'].forEach(name => {
                const el = document.getElementById(`${name}-screen`);
                if (el) el.classList.toggle('hidden', name !== screenName);
            });
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toast-icon');
            const msg = document.getElementById('toast-message');

            icon.className = `ph ph-${type === 'success' ? 'check-circle text-emerald-400' : type === 'error' ? 'x-circle text-red-400' : 'info text-blue-400'}`;
            msg.textContent = message;

            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }

        // PESEL validation
        function validatePesel(pesel) {
            if (!/^[0-9]{11}$/.test(pesel)) return { valid: false, error: 'PESEL musi miec 11 cyfr.' };
            const weights = [1, 3, 7, 9, 1, 3, 7, 9, 1, 3];
            let sum = 0;
            for (let i = 0; i < 10; i++) sum += parseInt(pesel[i]) * weights[i];
            if ((10 - (sum % 10)) % 10 !== parseInt(pesel[10])) return { valid: false, error: 'Nieprawidlowy PESEL.' };
            return { valid: true };
        }

        // ID validation
        function validateIdNumber(idNumber) {
            const id = idNumber.toUpperCase().replace(/\s/g, '');
            if (!/^[A-Z]{3}[0-9]{6}$/.test(id)) return { valid: false, error: 'Format: 3 litery + 6 cyfr.' };
            return { valid: true };
        }

        async function loadProject() {
            const token = getToken();
            if (!token) { showScreen('not-found'); return; }

            const { data: workflowData, error } = await supabaseClient
                .from('workflows')
                .select('*')
                .eq('unique_token', token)
                .single();

            if (error || !workflowData) { showScreen('not-found'); return; }
            workflow = workflowData;

            if (!workflow.client_password_hash) { showScreen('set-password'); return; }
            if (!isAuthenticated && checkSavedAuth()) { isAuthenticated = true; }
            if (!isAuthenticated) { showScreen('password'); return; }

            await logAccess();

            // Contract flow
            if (workflow.contract_seller_signed_url || workflow.contract_status === 'signed') {
                // Continue to project
            } else if (workflow.contract_status === 'pending_data') {
                prefillContractForm();
                showScreen('contract-data');
                return;
            } else if (['data_filled', 'pending_signature'].includes(workflow.contract_status)) {
                showScreen('contract-signing');
                return;
            }

            await loadAllData();
            renderProject();
            showScreen('project');
        }

        async function loadAllData() {
            const [milestonesRes, tasksRes, docsRes, matsRes, brandRes, prodsRes, repsRes, comsRes] = await Promise.all([
                supabaseClient.from('workflow_milestones').select('*').eq('workflow_id', workflow.id).order('milestone_index'),
                supabaseClient.from('workflow_tasks').select('*').eq('workflow_id', workflow.id).order('task_index'),
                supabaseClient.from('workflow_documents').select('*').eq('workflow_id', workflow.id).eq('visible_to_client', true).order('uploaded_at', { ascending: false }),
                supabaseClient.from('workflow_materials').select('*').eq('workflow_id', workflow.id).eq('visible_to_client', true).order('uploaded_at', { ascending: false }),
                supabaseClient.from('workflow_branding').select('*').eq('workflow_id', workflow.id).order('sort_order'),
                supabaseClient.from('workflow_products').select('*').eq('workflow_id', workflow.id).eq('visible_to_client', true).order('created_at', { ascending: false }),
                supabaseClient.from('workflow_reports').select('*').eq('workflow_id', workflow.id).eq('visible_to_client', true).order('created_at', { ascending: false }),
                supabaseClient.from('workflow_comments').select('*').eq('workflow_id', workflow.id).order('created_at', { ascending: true })
            ]);

            milestones = milestonesRes.data || [];
            tasks = tasksRes.data || [];
            documents = docsRes.data || [];
            materials = matsRes.data || [];
            brandingItems = brandRes.data || [];
            products = prodsRes.data || [];
            reports = repsRes.data || [];
            comments = comsRes.data || [];

            // Update comments badge after loading
            updateCommentsBadge();
        }

        async function logAccess() {
            try {
                await supabaseClient.from('workflow_access_log').insert({ workflow_id: workflow.id, user_agent: navigator.userAgent });
            } catch (e) {}
        }

        // Password functions
        async function setPassword(e) {
            e.preventDefault();
            const password = document.getElementById('set-password-input').value;
            const confirm = document.getElementById('set-password-confirm').value;

            if (password !== confirm) { showToast('Hasla nie pasuja', 'error'); return; }
            if (password.length < 6) { showToast('Haslo za krotkie', 'error'); return; }

            const hash = dcodeIO.bcrypt.hashSync(password, 10);
            const { error } = await supabaseClient.from('workflows').update({ client_password_hash: hash }).eq('id', workflow.id);

            if (error) { showToast('Blad zapisu', 'error'); return; }

            workflow.client_password_hash = hash;
            isAuthenticated = true;
            saveAuth();
            loadProject();
        }
        window.setPassword = setPassword;

        async function checkPassword(e) {
            e.preventDefault();
            const password = document.getElementById('password-input').value;

            if (dcodeIO.bcrypt.compareSync(password, workflow.client_password_hash)) {
                isAuthenticated = true;
                saveAuth();
                loadProject();
            } else {
                showToast('Nieprawidlowe haslo', 'error');
            }
        }
        window.checkPassword = checkPassword;

        // Contract functions
        function prefillContractForm() {
            document.getElementById('contract-name').value = workflow.customer_name || '';
            document.getElementById('contract-company').value = workflow.customer_company || '';
            document.getElementById('contract-email').value = workflow.customer_email || '';
            document.getElementById('contract-phone').value = workflow.customer_phone || '';
            document.getElementById('contract-pesel').value = workflow.client_pesel || '';
            document.getElementById('contract-id').value = workflow.client_id_number || '';
            document.getElementById('contract-nip').value = workflow.client_nip || '';
            document.getElementById('contract-street').value = workflow.client_street || '';
            document.getElementById('contract-postal').value = workflow.client_postal_code || '';
            document.getElementById('contract-city').value = workflow.client_city || '';
            document.getElementById('contract-country').value = workflow.client_country || 'Polska';
        }

        async function submitContractData(e) {
            e.preventDefault();

            const pesel = document.getElementById('contract-pesel').value;
            const idNumber = document.getElementById('contract-id').value;

            const peselResult = validatePesel(pesel);
            if (!peselResult.valid) {
                document.getElementById('pesel-error').textContent = peselResult.error;
                document.getElementById('pesel-error').classList.remove('hidden');
                return;
            }
            document.getElementById('pesel-error').classList.add('hidden');

            const idResult = validateIdNumber(idNumber);
            if (!idResult.valid) {
                document.getElementById('id-error').textContent = idResult.error;
                document.getElementById('id-error').classList.remove('hidden');
                return;
            }
            document.getElementById('id-error').classList.add('hidden');

            const updateData = {
                customer_name: document.getElementById('contract-name').value,
                customer_company: document.getElementById('contract-company').value,
                customer_email: document.getElementById('contract-email').value,
                customer_phone: document.getElementById('contract-phone').value,
                client_pesel: pesel,
                client_id_number: idNumber.toUpperCase(),
                client_nip: document.getElementById('contract-nip').value,
                client_street: document.getElementById('contract-street').value,
                client_postal_code: document.getElementById('contract-postal').value,
                client_city: document.getElementById('contract-city').value,
                client_country: document.getElementById('contract-country').value,
                contract_status: 'data_filled',
                contract_data_filled_at: new Date().toISOString()
            };

            const { error } = await supabaseClient.from('workflows').update(updateData).eq('id', workflow.id);

            if (error) { showToast('Blad zapisu', 'error'); return; }

            Object.assign(workflow, updateData);
            showScreen('contract-signing');
        }
        window.submitContractData = submitContractData;

        function goToProject() {
            loadProject();
        }
        window.goToProject = goToProject;

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.sidebar-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tabName);
            });
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.add('hidden');
            });
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');

            // Load tab-specific data
            switch(tabName) {
                case 'dokumenty': renderDocuments(); break;
                case 'materialy': renderMaterials(); break;
                case 'branding': renderBranding(); break;
                case 'strona': renderSalesPage(); break;
                case 'produkty': renderProducts(); break;
                case 'raporty': renderReports(); break;
                case 'komentarze':
                    renderComments();
                    markCommentsAsRead();
                    break;
            }
        }
        window.switchTab = switchTab;

        // Mobile menu toggle
        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            menu.classList.toggle('hidden');
        }
        window.toggleMobileMenu = toggleMobileMenu;

        // Comments badge - track unread team comments for client
        function getLastSeenKey() {
            return `comments_last_seen_${workflow?.id || 'unknown'}`;
        }

        function updateCommentsBadge() {
            const badge = document.getElementById('comments-badge');
            if (!badge || !workflow) return;

            const lastSeen = localStorage.getItem(getLastSeenKey());
            const lastSeenDate = lastSeen ? new Date(lastSeen) : new Date(0);

            // Count team comments newer than last seen
            const unreadCount = comments.filter(c =>
                c.author_type === 'team' && new Date(c.created_at) > lastSeenDate
            ).length;

            if (unreadCount > 0) {
                badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        function markCommentsAsRead() {
            if (!workflow) return;
            localStorage.setItem(getLastSeenKey(), new Date().toISOString());
            const badge = document.getElementById('comments-badge');
            if (badge) badge.classList.add('hidden');
        }

        // Render functions
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            return new Date(dateStr).toLocaleDateString('pl-PL', { day: 'numeric', month: 'short', year: 'numeric' });
        }

        function formatDateTime(dateStr) {
            if (!dateStr) return '';
            return new Date(dateStr).toLocaleDateString('pl-PL', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
        }

        function renderProject() {
            // Header
            document.getElementById('project-title').textContent = workflow.offer_name || 'Projekt';
            document.getElementById('project-title-mobile').textContent = workflow.offer_name || 'Projekt';
            document.getElementById('offer-name').textContent = workflow.offer_name || '-';
            document.getElementById('started-at').textContent = formatDate(workflow.started_at);

            // Status
            const statusBadge = document.getElementById('project-status-badge');
            const statusConfig = {
                active: { class: 'badge-emerald', text: 'Aktywny' },
                completed: { class: 'badge-blue', text: 'Ukonczony' },
                paused: { class: 'badge-amber', text: 'Wstrzymany' },
                cancelled: { class: 'badge-red', text: 'Anulowany' }
            };
            const status = statusConfig[workflow.status] || statusConfig.active;
            statusBadge.className = `badge ${status.class}`;
            statusBadge.innerHTML = `<span class="w-1.5 h-1.5 rounded-full bg-current"></span>${status.text}`;

            // Progress
            const totalTasks = tasks.length;
            const completedTasks = tasks.filter(t => t.completed).length;
            const progressPercent = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

            document.getElementById('progress-percent').textContent = progressPercent + '%';
            document.getElementById('completed-tasks').textContent = completedTasks;
            document.getElementById('total-tasks').textContent = totalTasks;

            // Progress ring
            const ring = document.getElementById('progress-ring-fill');
            const circumference = 264;
            ring.style.strokeDashoffset = circumference - (progressPercent / 100 * circumference);

            // Current milestone
            const currentMilestone = milestones.find(m => m.status === 'in_progress');
            document.getElementById('current-milestone').textContent = currentMilestone ? currentMilestone.title : 'Brak';
            document.getElementById('current-deadline').textContent = currentMilestone ? formatDate(currentMilestone.deadline) : '-';

            // Signed contract
            if (workflow.contract_seller_signed_url) {
                document.getElementById('signed-contract-section').classList.remove('hidden');
                document.getElementById('signed-contract-download').href = workflow.contract_seller_signed_url;
            }

            // Milestones
            renderMilestones();
        }

        function renderMilestones() {
            const container = document.getElementById('milestones-container');

            container.innerHTML = milestones.map((milestone, index) => {
                const milestoneTasks = tasks.filter(t => t.milestone_id === milestone.id);
                const completedCount = milestoneTasks.filter(t => t.completed).length;
                const totalCount = milestoneTasks.length;
                const progressPercent = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;

                const isActive = milestone.status === 'in_progress';
                const isCompleted = milestone.status === 'completed';

                return `
                    <div class="card milestone-card ${isActive ? 'active' : ''} ${isCompleted ? 'completed' : ''} overflow-hidden">
                        <div class="p-4 cursor-pointer" onclick="toggleMilestone('${milestone.id}')">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 rounded-lg flex items-center justify-center text-sm font-medium ${
                                        isCompleted ? 'bg-emerald-500/10 text-emerald-400' :
                                        isActive ? 'bg-white/10 text-white' :
                                        'bg-zinc-800 text-zinc-500'
                                    }">
                                        ${isCompleted ? '<i class="ph ph-check text-xs"></i>' : index + 1}
                                    </div>
                                    <div>
                                        <h3 class="font-medium ${isCompleted || isActive ? 'text-white' : 'text-zinc-400'}">${milestone.title}</h3>
                                        <p class="text-tertiary text-xs">${formatDate(milestone.start_date)} - ${formatDate(milestone.deadline)}</p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-4">
                                    <div class="text-right hidden sm:block">
                                        <p class="text-secondary text-xs">${completedCount}/${totalCount}</p>
                                        <div class="w-20 h-1.5 bg-zinc-800 rounded-full overflow-hidden mt-1">
                                            <div class="h-full rounded-full ${isCompleted ? 'bg-emerald-500' : 'bg-white'}" style="width: ${progressPercent}%"></div>
                                        </div>
                                    </div>
                                    <i class="ph ph-caret-down text-zinc-500 transition-transform" id="chevron-${milestone.id}"></i>
                                </div>
                            </div>
                        </div>

                        <div id="content-${milestone.id}" class="hidden border-t border-default">
                            <div class="p-4 space-y-2">
                                ${milestoneTasks.map(task => `
                                    <div class="flex items-center gap-3 py-2">
                                        <div class="w-5 h-5 rounded flex items-center justify-center ${task.completed ? 'bg-emerald-500' : 'border border-zinc-700'}">
                                            ${task.completed ? '<i class="ph ph-check text-white text-xs"></i>' : ''}
                                        </div>
                                        <span class="${task.completed ? 'text-zinc-500 line-through' : 'text-white'}">${task.title}</span>
                                        <span class="badge text-[10px] px-2 py-1 responsible-${task.responsible || 'team'}">${
                                            task.responsible === 'client' ? 'Ty' : task.responsible === 'shared' ? 'Wspólnie' : 'Tomasz Niedźwiecki'
                                        }</span>
                                    </div>
                                `).join('')}
                                ${milestoneTasks.length === 0 ? '<p class="text-tertiary text-sm py-2">Brak zadan</p>' : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleMilestone(id) {
            const content = document.getElementById(`content-${id}`);
            const chevron = document.getElementById(`chevron-${id}`);
            content.classList.toggle('hidden');
            chevron.style.transform = content.classList.contains('hidden') ? '' : 'rotate(180deg)';
        }
        window.toggleMilestone = toggleMilestone;

        function renderDocuments() {
            const container = document.getElementById('documents-list');
            const empty = document.getElementById('documents-empty');
            const hasSignedContract = workflow.contract_seller_signed_url;

            if (documents.length === 0 && !hasSignedContract) {
                container.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }

            empty.classList.add('hidden');

            if (documents.length === 0) {
                container.innerHTML = '';
                return;
            }
            container.innerHTML = documents.map(d => `
                <div class="card card-hover p-4 flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-lg bg-red-500/10 flex items-center justify-center">
                            <i class="ph ph-file-pdf text-red-400"></i>
                        </div>
                        <div>
                            <p class="text-white font-medium">${d.title}</p>
                            <p class="text-tertiary text-xs">${d.category || 'Dokument'} • ${formatDate(d.uploaded_at)}</p>
                        </div>
                    </div>
                    <a href="${d.file_url}" target="_blank" class="text-white hover:text-zinc-300 p-2">
                        <i class="ph ph-download-simple text-lg"></i>
                    </a>
                </div>
            `).join('');
        }

        function renderMaterials() {
            const container = document.getElementById('materials-grid');
            const empty = document.getElementById('materials-empty');

            if (materials.length === 0) {
                container.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }

            empty.classList.add('hidden');
            const fileIcons = { pdf: 'file-pdf', doc: 'file-doc', docx: 'file-doc', jpg: 'file-image', jpeg: 'file-image', png: 'file-image', gif: 'file-image', svg: 'file-image', mp4: 'file-video', zip: 'file-zip' };

            container.innerHTML = materials.map(m => `
                <div class="card card-hover p-4">
                    <div class="flex items-start gap-3">
                        <div class="w-10 h-10 rounded-lg bg-cyan-500/10 flex items-center justify-center flex-shrink-0">
                            <i class="ph ph-${fileIcons[m.file_type?.toLowerCase()] || 'file'} text-cyan-400"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-white font-medium truncate">${m.title}</p>
                            ${m.description ? `<p class="text-tertiary text-xs line-clamp-2 mt-1">${m.description}</p>` : ''}
                            <p class="text-tertiary text-xs mt-2">${m.category || 'Plik'}</p>
                        </div>
                    </div>
                    <a href="${m.file_url}" target="_blank" class="mt-3 block text-center bg-zinc-800 hover:bg-zinc-700 text-white py-2 rounded-lg text-sm transition-colors">
                        Pobierz
                    </a>
                </div>
            `).join('');
        }

        function renderBranding() {
            const logos = brandingItems.filter(b => b.type === 'logo');
            const colors = brandingItems.filter(b => b.type === 'color');
            const fonts = brandingItems.filter(b => b.type === 'font');
            const guidelines = brandingItems.filter(b => b.type === 'guideline');

            // Logos
            const logosContainer = document.getElementById('branding-logos');
            const logosEmpty = document.getElementById('branding-logos-empty');
            if (logos.length > 0) {
                logosEmpty.classList.add('hidden');
                logosContainer.innerHTML = logos.map(l => `
                    <div class="card p-4 aspect-square flex items-center justify-center">
                        <img src="${l.file_url}" alt="${l.title}" class="max-w-full max-h-full object-contain">
                    </div>
                `).join('');
            } else {
                logosEmpty.classList.remove('hidden');
                logosContainer.innerHTML = '';
            }

            // Colors
            const colorsContainer = document.getElementById('branding-colors');
            const colorsEmpty = document.getElementById('branding-colors-empty');
            if (colors.length > 0) {
                colorsEmpty.classList.add('hidden');
                colorsContainer.innerHTML = colors.map(c => `
                    <div class="flex items-center gap-3 card px-4 py-3">
                        <div class="w-10 h-10 rounded-lg" style="background: ${c.value}"></div>
                        <div>
                            <p class="text-white text-sm">${c.title}</p>
                            <p class="text-tertiary text-xs font-mono">${c.value}</p>
                        </div>
                    </div>
                `).join('');
            } else {
                colorsEmpty.classList.remove('hidden');
                colorsContainer.innerHTML = '';
            }

            // Fonts
            const fontsContainer = document.getElementById('branding-fonts');
            const fontsEmpty = document.getElementById('branding-fonts-empty');
            if (fonts.length > 0) {
                fontsEmpty.classList.add('hidden');
                fontsContainer.innerHTML = fonts.map(f => `
                    <div class="card px-4 py-3 flex items-center justify-between">
                        <div>
                            <p class="text-white">${f.title}</p>
                            <p class="text-tertiary text-sm">${f.value || ''}</p>
                        </div>
                    </div>
                `).join('');
            } else {
                fontsEmpty.classList.remove('hidden');
                fontsContainer.innerHTML = '';
            }

            // Guidelines
            const guidelinesContainer = document.getElementById('branding-guidelines');
            const guidelinesEmpty = document.getElementById('branding-guidelines-empty');
            if (guidelines.length > 0) {
                guidelinesEmpty.classList.add('hidden');
                guidelinesContainer.innerHTML = guidelines.map(g => `
                    <div class="card card-hover px-4 py-3 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <i class="ph ph-file-pdf text-red-400"></i>
                            <p class="text-white">${g.title}</p>
                        </div>
                        <a href="${g.file_url}" target="_blank" class="text-white hover:text-zinc-300">
                            <i class="ph ph-download-simple"></i>
                        </a>
                    </div>
                `).join('');
            } else {
                guidelinesEmpty.classList.remove('hidden');
                guidelinesContainer.innerHTML = '';
            }
        }

        function renderSalesPage() {
            const content = document.getElementById('sales-page-content');
            const empty = document.getElementById('sales-page-empty');

            if (workflow.sales_page_url) {
                empty.classList.add('hidden');
                content.classList.remove('hidden');
                document.getElementById('sales-page-iframe').src = workflow.sales_page_url;
                document.getElementById('sales-page-link').href = workflow.sales_page_url;
                document.getElementById('sales-page-url-display').textContent = workflow.sales_page_url;

                const statusBadge = document.getElementById('sales-page-status');
                if (workflow.sales_page_status === 'live') {
                    statusBadge.className = 'badge badge-emerald';
                    statusBadge.innerHTML = '<span class="w-1.5 h-1.5 rounded-full bg-current"></span>Live';
                } else {
                    statusBadge.className = 'badge badge-amber';
                    statusBadge.innerHTML = '<span class="w-1.5 h-1.5 rounded-full bg-current"></span>Draft';
                }
            } else {
                content.classList.add('hidden');
                empty.classList.remove('hidden');
            }
        }

        function renderProducts() {
            const container = document.getElementById('products-list');
            const empty = document.getElementById('products-empty');
            const heroEl = document.getElementById('product-selected-hero');

            if (products.length === 0) {
                container.innerHTML = '';
                heroEl.classList.add('hidden');
                empty.classList.remove('hidden');
                return;
            }

            empty.classList.add('hidden');

            // Show selected product hero
            const selected = products.find(p => p.selected_by_client);
            if (selected) {
                heroEl.classList.remove('hidden');
                heroEl.innerHTML = `
                    <div class="card overflow-hidden border-emerald-500/30" style="border-color: rgba(16,185,129,0.3);">
                        <div class="flex flex-col md:flex-row">
                            ${selected.image_url ? `<div class="md:w-48 h-48 md:h-auto bg-[#0a0a0a] flex-shrink-0"><img src="${selected.image_url}" alt="" class="w-full h-full object-cover"></div>` : ''}
                            <div class="p-6 flex-1">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="inline-flex items-center gap-1 bg-emerald-500/20 text-emerald-400 text-xs font-medium px-2 py-1 rounded-md">
                                        <i class="ph-fill ph-check-circle"></i> Twój wybrany produkt
                                    </span>
                                </div>
                                <h3 class="text-white font-semibold text-lg mb-1">${selected.name}</h3>
                                ${selected.description ? `<p class="text-tertiary text-sm mb-3">${selected.description}</p>` : ''}
                                ${selected.price ? `<p class="text-white font-bold text-2xl">${parseFloat(selected.price).toFixed(2)} <span class="text-tertiary text-sm font-normal">${selected.currency || 'USD'}</span></p>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            } else {
                heroEl.classList.add('hidden');
                heroEl.innerHTML = '';
            }

            // Render product cards (exclude selected from grid if shown in hero)
            const gridProducts = selected ? products.filter(p => !p.selected_by_client) : products;
            const hasAnySelected = !!selected;

            if (gridProducts.length === 0 && hasAnySelected) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = gridProducts.map(p => {
                return `
                    <div class="card overflow-hidden group hover:border-[#333] transition-all duration-200">
                        <div class="relative aspect-square bg-[#0a0a0a] overflow-hidden">
                            ${p.image_url
                                ? `<img src="${p.image_url}" alt="${p.name}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300">`
                                : `<div class="w-full h-full flex items-center justify-center"><i class="ph ph-package text-5xl text-[#333]"></i></div>`
                            }
                        </div>
                        <div class="p-5">
                            <h4 class="text-white font-medium text-sm mb-1 leading-tight" style="display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;">${p.name}</h4>
                            ${p.description ? `<p class="text-tertiary text-xs mb-3" style="display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;">${p.description}</p>` : '<div class="mb-3"></div>'}
                            ${p.price ? `<p class="text-white font-bold text-xl mb-4">${parseFloat(p.price).toFixed(2)} <span class="text-tertiary text-xs font-normal">${p.currency || 'USD'}</span></p>` : '<div class="mb-4"></div>'}
                            ${!hasAnySelected ? `
                                <button onclick="selectProduct('${p.id}')" class="w-full bg-white text-black hover:bg-zinc-200 py-3 rounded-lg text-sm font-semibold transition-colors flex items-center justify-center gap-2">
                                    <i class="ph ph-check-circle"></i>
                                    Wybieram ten produkt
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function selectProduct(id) {
            const product = products.find(p => p.id === id);
            if (!product) return;
            if (!confirm(`Czy na pewno chcesz wybrać "${product.name}" jako swój produkt? Wokół niego zbudujemy Twój sklep i markę.`)) return;

            // Unselect all, then select this one
            const { error: resetError } = await supabaseClient
                .from('workflow_products')
                .update({ selected_by_client: false })
                .eq('workflow_id', workflow.id);

            if (resetError) { console.error(resetError); return; }

            const { error } = await supabaseClient
                .from('workflow_products')
                .update({ selected_by_client: true })
                .eq('id', id);

            if (error) { console.error(error); return; }

            // Update local data
            products.forEach(p => p.selected_by_client = (p.id === id));
            renderProducts();
        }
        window.selectProduct = selectProduct;

        function renderReports() {
            const container = document.getElementById('reports-list');
            const empty = document.getElementById('reports-empty');

            if (reports.length === 0) {
                container.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }

            empty.classList.add('hidden');
            container.innerHTML = reports.map(r => `
                <div class="card p-4">
                    <div class="flex items-start gap-3 mb-3">
                        <div class="w-10 h-10 rounded-lg bg-green-500/10 flex items-center justify-center">
                            <i class="ph ph-chart-line-up text-green-400"></i>
                        </div>
                        <div class="flex-1">
                            <p class="text-white font-medium">${r.title}</p>
                            <p class="text-tertiary text-xs">${r.type || 'Raport'}</p>
                        </div>
                    </div>
                    ${r.period_start && r.period_end ? `
                        <p class="text-tertiary text-xs mb-3">Okres: ${formatDate(r.period_start)} - ${formatDate(r.period_end)}</p>
                    ` : ''}
                    ${r.file_url ? `
                        <a href="${r.file_url}" target="_blank" class="block text-center bg-zinc-800 hover:bg-zinc-700 text-white py-2 rounded-lg text-sm transition-colors">
                            <i class="ph ph-file-pdf mr-1"></i>
                            Pobierz PDF
                        </a>
                    ` : ''}
                </div>
            `).join('');
        }

        function renderComments() {
            const container = document.getElementById('comments-list');
            const empty = document.getElementById('comments-empty');

            if (comments.length === 0) {
                container.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }

            empty.classList.add('hidden');
            container.innerHTML = comments.map(c => {
                const isTeam = c.author_type === 'team';
                return `
                    <div class="flex gap-3 ${isTeam ? '' : 'flex-row-reverse'}">
                        <div class="w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center ${isTeam ? 'bg-violet-500/10' : 'bg-cyan-500/10'}">
                            <i class="ph ph-user text-sm ${isTeam ? 'text-violet-400' : 'text-cyan-400'}"></i>
                        </div>
                        <div class="${isTeam ? '' : 'text-right'} flex-1">
                            <div class="inline-block ${isTeam ? 'comment-team' : 'comment-client'} rounded-xl px-4 py-3 max-w-[85%] ${isTeam ? '' : 'text-left'}">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-white text-sm font-medium">${c.author_name}</span>
                                    <span class="text-tertiary text-xs">${formatDateTime(c.created_at)}</span>
                                </div>
                                <p class="text-zinc-300 text-sm whitespace-pre-wrap">${c.content}</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Scroll to bottom
            setTimeout(() => container.scrollTop = container.scrollHeight, 100);
        }

        async function postComment() {
            const content = document.getElementById('new-comment').value.trim();
            if (!content) return;

            const { data, error } = await supabaseClient
                .from('workflow_comments')
                .insert({
                    workflow_id: workflow.id,
                    author_type: 'client',
                    author_name: workflow.customer_name || 'Klient',
                    content: content
                })
                .select()
                .single();

            if (error) {
                showToast('Blad wysylania', 'error');
                return;
            }

            comments.push(data);
            renderComments();
            document.getElementById('new-comment').value = '';
            showToast('Komentarz wyslany');
        }
        window.postComment = postComment;

        // Initialize
        loadProject();
    </script>
</body>
</html>
