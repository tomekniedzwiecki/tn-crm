<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TN CRM - Aktywność</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    }
                }
            }
        }
    </script>
    <style>
        body { background: #050505; color: #e5e5e5; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::selection { background: white; color: black; }

        .glass-header {
            background: rgba(5, 5, 5, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-enter { animation: fadeIn 0.4s ease-out forwards; }

        .details-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .details-content.expanded {
            max-height: 500px;
        }
    </style>
</head>
<body class="h-screen flex overflow-hidden font-sans text-sm tracking-tight antialiased">

    <!-- Sidebar -->
    <aside class="w-[280px] bg-zinc-950 border-r border-white/5 flex flex-col flex-shrink-0">
        <div class="h-16 flex items-center px-5 hover:bg-white/5 transition-colors cursor-pointer border-b border-white/5">
            <div class="w-7 h-7 bg-white text-black rounded flex items-center justify-center mr-3 shadow-[0_0_15px_rgba(255,255,255,0.1)]">
                <i class="ph-bold ph-lightning text-sm"></i>
            </div>
            <span class="font-medium text-base text-zinc-200">TN CRM</span>
            <i class="ph-bold ph-caret-up-down ml-auto text-zinc-500"></i>
        </div>

        <nav class="flex-1 px-4 py-6">
            <div class="text-xs uppercase tracking-wider text-zinc-500 font-semibold px-2 mb-3">Workspace</div>

            <a href="/dashboard" data-page="dashboard" class="flex items-center gap-3 px-3 py-2.5 text-zinc-400 hover:text-zinc-100 hover:bg-white/5 rounded-lg transition-all mb-1">
                <i class="ph ph-house text-xl"></i>
                <span class="font-medium">Overview</span>
            </a>

            <a href="/leads" data-page="leads" class="flex items-center gap-3 px-3 py-2.5 text-zinc-400 hover:text-zinc-100 hover:bg-white/5 rounded-lg transition-all mb-1">
                <i class="ph ph-users text-xl"></i>
                <span class="font-medium">Leady</span>
            </a>

            <a href="/pipeline" data-page="pipeline" class="flex items-center gap-3 px-3 py-2.5 text-zinc-400 hover:text-zinc-100 hover:bg-white/5 rounded-lg transition-all mb-1">
                <i class="ph ph-kanban text-xl"></i>
                <span class="font-medium">Pipeline</span>
            </a>

            <a href="/calendar" data-page="calendar" class="flex items-center gap-3 px-3 py-2.5 text-zinc-400 hover:text-zinc-100 hover:bg-white/5 rounded-lg transition-all mb-1">
                <i class="ph ph-calendar text-xl"></i>
                <span class="font-medium">Kalendarz</span>
            </a>

            <a href="/offers" data-page="offers" class="flex items-center gap-3 px-3 py-2.5 text-zinc-400 hover:text-zinc-100 hover:bg-white/5 rounded-lg transition-all mb-1">
                <i class="ph ph-package text-xl"></i>
                <span class="font-medium">Oferty</span>
            </a>

            <a href="/settings" data-page="settings" id="nav-settings" class="flex items-center gap-3 px-3 py-2.5 text-zinc-400 hover:text-zinc-100 hover:bg-white/5 rounded-lg transition-all mb-1 hidden">
                <i class="ph ph-gear text-xl"></i>
                <span class="font-medium">Ustawienia</span>
            </a>

            <a href="/audit" data-page="audit" class="flex items-center gap-3 px-3 py-2.5 bg-white/10 text-white rounded-lg border border-white/5 shadow-sm mb-1">
                <i class="ph ph-shield-check text-xl"></i>
                <span class="font-medium">Aktywność</span>
            </a>
        </nav>

        <div class="p-4 border-t border-white/5">
            <div class="flex items-center gap-3 p-2 hover:bg-white/5 rounded-lg transition-colors cursor-pointer">
                <div class="w-9 h-9 rounded-full bg-gradient-to-b from-zinc-700 to-zinc-800 border border-white/10 flex items-center justify-center text-sm font-medium">TN</div>
                <div class="flex-1 min-w-0">
                    <div id="user-email" class="text-sm font-medium text-zinc-200 truncate"></div>
                    <div class="text-xs text-zinc-500 truncate">Admin</div>
                </div>
                <button id="logout-btn" class="p-1.5 text-zinc-500 hover:text-white transition-colors" title="Wyloguj">
                    <i class="ph ph-sign-out text-lg"></i>
                </button>
            </div>
        </div>
    </aside>

    <!-- Main -->
    <main class="flex-1 flex flex-col bg-black relative min-w-0">
        <!-- Header -->
        <header class="h-16 glass-header flex items-center justify-between px-6 sticky top-0 z-30">
            <div class="flex items-center gap-2 text-zinc-500">
                <span class="text-zinc-400">tn-crm</span>
                <span class="text-zinc-700">/</span>
                <span class="text-white font-medium">audit</span>
            </div>
            <div class="flex items-center gap-3">
                <button id="refresh-btn" class="text-zinc-400 hover:text-white border border-zinc-800 hover:border-zinc-700 px-4 py-2 rounded-lg text-xs font-medium transition-all flex items-center gap-2">
                    <i class="ph ph-arrows-clockwise"></i>
                    Odswież
                </button>
            </div>
        </header>

        <!-- Content -->
        <div class="flex-1 overflow-y-auto p-6 lg:p-10">
            <div class="max-w-6xl mx-auto animate-enter">
                <!-- Access denied message for non-admins -->
                <div id="access-denied" class="hidden bg-red-500/10 border border-red-500/20 rounded-lg p-6 text-center">
                    <i class="ph ph-lock-key text-4xl text-red-400 mb-3"></i>
                    <h2 class="text-lg font-medium text-white mb-2">Brak dostępu</h2>
                    <p class="text-zinc-400">Tylko administrator ma dostęp do dziennika aktywności.</p>
                </div>

                <!-- Audit content (admin only) -->
                <div id="audit-content" class="hidden">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h1 class="text-3xl font-semibold text-white tracking-tight mb-1">Dziennik aktywności</h1>
                            <p class="text-zinc-500">Przegląd wszystkich akcji wykonanych w systemie przez handlowców.</p>
                        </div>
                        <div class="text-right">
                            <div class="text-3xl font-semibold text-white" id="total-count">-</div>
                            <div class="text-zinc-500 text-xs font-mono">wszystkich wpisów</div>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="bg-zinc-900/50 border border-white/5 rounded-lg p-4 mb-6">
                        <div class="flex flex-wrap items-center gap-3">
                            <!-- Team member filter -->
                            <select id="filter-user" class="bg-zinc-900 border border-zinc-800 rounded-lg px-3 py-2 text-sm text-zinc-300 cursor-pointer outline-none hover:border-zinc-700 focus:border-zinc-600 min-w-[160px]">
                                <option value="">Wszyscy użytkownicy</option>
                            </select>

                            <!-- Action type filter -->
                            <select id="filter-action" class="bg-zinc-900 border border-zinc-800 rounded-lg px-3 py-2 text-sm text-zinc-300 cursor-pointer outline-none hover:border-zinc-700 focus:border-zinc-600 min-w-[140px]">
                                <option value="">Wszystkie akcje</option>
                                <option value="create">Utworzono</option>
                                <option value="update">Zaktualizowano</option>
                                <option value="delete">Usunięto</option>
                                <option value="status_change">Zmiana statusu</option>
                                <option value="batch_delete">Usunięto wiele</option>
                            </select>

                            <!-- Entity type filter -->
                            <select id="filter-entity" class="bg-zinc-900 border border-zinc-800 rounded-lg px-3 py-2 text-sm text-zinc-300 cursor-pointer outline-none hover:border-zinc-700 focus:border-zinc-600 min-w-[140px]">
                                <option value="">Wszystkie encje</option>
                                <option value="lead">Lead</option>
                                <option value="meeting">Spotkanie</option>
                                <option value="activity">Aktywność</option>
                                <option value="note">Notatka</option>
                                <option value="offer">Oferta</option>
                                <option value="team_member">Użytkownik</option>
                                <option value="settings">Ustawienia</option>
                            </select>

                            <!-- Date from -->
                            <input type="date" id="filter-date-from" class="bg-zinc-900 border border-zinc-800 rounded-lg px-3 py-2 text-sm text-zinc-300 outline-none hover:border-zinc-700 focus:border-zinc-600">

                            <!-- Date to -->
                            <input type="date" id="filter-date-to" class="bg-zinc-900 border border-zinc-800 rounded-lg px-3 py-2 text-sm text-zinc-300 outline-none hover:border-zinc-700 focus:border-zinc-600">

                            <!-- Search -->
                            <div class="relative flex-1 min-w-[200px]">
                                <input type="text" id="filter-search" placeholder="Szukaj po encji..." class="w-full bg-zinc-900 border border-zinc-800 rounded-lg pl-9 pr-3 py-2 text-sm text-zinc-300 outline-none hover:border-zinc-700 focus:border-zinc-600">
                                <i class="ph ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-zinc-500"></i>
                            </div>

                            <!-- Clear filters -->
                            <button id="clear-filters" class="text-zinc-500 hover:text-white px-3 py-2 text-sm transition-colors hidden">
                                <i class="ph ph-x mr-1"></i> Wyczyść
                            </button>
                        </div>
                    </div>

                    <!-- Results info -->
                    <div class="flex items-center justify-between mb-4">
                        <div class="text-xs text-zinc-500">
                            Pokazuję <span id="showing-count" class="text-zinc-300">0</span> z <span id="filtered-count" class="text-zinc-300">0</span> wpisów
                        </div>
                    </div>

                    <!-- Tabela Aktywności -->
                    <div class="bg-zinc-900/30 border border-white/5 rounded-lg overflow-hidden">
                        <table class="w-full text-left text-xs">
                            <thead class="bg-zinc-900/80 text-zinc-500 border-b border-white/5">
                                <tr>
                                    <th class="px-5 py-3 font-medium w-[180px]">Data / Czas</th>
                                    <th class="px-5 py-3 font-medium w-[160px]">Użytkownik</th>
                                    <th class="px-5 py-3 font-medium w-[140px]">Akcja</th>
                                    <th class="px-5 py-3 font-medium">Encja</th>
                                    <th class="px-5 py-3 font-medium w-[80px] text-center">Szczegóły</th>
                                </tr>
                            </thead>
                            <tbody id="audit-table" class="divide-y divide-white/5">
                                <!-- Audit entries will be rendered here -->
                            </tbody>
                        </table>

                        <!-- Empty state -->
                        <div id="empty-state" class="hidden p-12 text-center">
                            <i class="ph ph-clipboard-text text-4xl text-zinc-600 mb-3"></i>
                            <p class="text-zinc-500">Brak wpisów do wyświetlenia</p>
                        </div>

                        <!-- Loading state -->
                        <div id="loading-state" class="p-12 text-center">
                            <i class="ph ph-circle-notch animate-spin text-4xl text-zinc-600 mb-3"></i>
                            <p class="text-zinc-500">Ładowanie...</p>
                        </div>
                    </div>

                    <!-- Pagination -->
                    <div class="flex items-center justify-between mt-4">
                        <button id="prev-page" class="text-zinc-400 hover:text-white border border-zinc-800 hover:border-zinc-700 px-4 py-2 rounded-lg text-xs font-medium transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
                            <i class="ph ph-caret-left"></i>
                            Poprzednia
                        </button>
                        <span class="text-zinc-500 text-xs">
                            Strona <span id="current-page" class="text-zinc-300">1</span> z <span id="total-pages" class="text-zinc-300">1</span>
                        </span>
                        <button id="next-page" class="text-zinc-400 hover:text-white border border-zinc-800 hover:border-zinc-700 px-4 py-2 rounded-lg text-xs font-medium transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
                            Następna
                            <i class="ph ph-caret-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const SUPABASE_URL = 'https://yxmavwkwnfuphjqbelws.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl4bWF2d2t3bmZ1cGhqcWJlbHdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NjQyNTUsImV4cCI6MjA4NDM0MDI1NX0.XeR0Fc7OFn6YbNJrOKTBEj36JtmLISZTM87y4ai9340';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const ITEMS_PER_PAGE = 50;
        let auditLogs = [];
        let filteredLogs = [];
        let currentPage = 1;
        let teamMembers = [];
        let teamMembersMap = {};
        let currentMember = null;
        let isAdmin = false;

        // Action type labels and styles
        const ACTION_TYPES = {
            create: { label: 'Utworzono', icon: 'ph-plus-circle', color: 'emerald' },
            update: { label: 'Zaktualizowano', icon: 'ph-pencil-simple', color: 'blue' },
            delete: { label: 'Usunięto', icon: 'ph-trash', color: 'red' },
            status_change: { label: 'Zmiana statusu', icon: 'ph-arrows-left-right', color: 'violet' },
            batch_delete: { label: 'Usunięto wiele', icon: 'ph-trash', color: 'red' }
        };

        // Entity type labels and icons
        const ENTITY_TYPES = {
            lead: { label: 'Lead', icon: 'ph-user' },
            meeting: { label: 'Spotkanie', icon: 'ph-calendar' },
            activity: { label: 'Aktywność', icon: 'ph-clock' },
            note: { label: 'Notatka', icon: 'ph-note' },
            offer: { label: 'Oferta', icon: 'ph-package' },
            team_member: { label: 'Użytkownik', icon: 'ph-users-three' },
            settings: { label: 'Ustawienia', icon: 'ph-gear' }
        };

        function getBasePath() {
            if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
                const path = location.pathname;
                const match = path.match(/^(\/[^\/]+)\//);
                return match ? match[1] : '';
            }
            return '';
        }

        function getLoginPath() {
            const base = getBasePath();
            return (location.hostname === 'localhost' || location.hostname === '127.0.0.1') ? `${base}/index.html` : '/';
        }

        async function checkAuth() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
                window.location.href = getLoginPath();
                return null;
            }
            document.getElementById('user-email').textContent = session.user.email.split('@')[0];
            await loadTeamMembers(session.user.id);
            return session;
        }

        async function loadTeamMembers(userId) {
            const { data, error } = await supabaseClient
                .from('team_members')
                .select('*');

            if (error) {
                console.error('Error loading team members:', error);
                return;
            }

            teamMembers = data || [];
            teamMembersMap = {};
            teamMembers.forEach(member => {
                teamMembersMap[member.id] = member;
            });

            currentMember = teamMembers.find(m => m.user_id === userId);
            isAdmin = currentMember?.role === 'admin';

            // Show/hide content based on admin status
            const navSettings = document.getElementById('nav-settings');
            if (navSettings && isAdmin) navSettings.classList.remove('hidden');

            if (isAdmin) {
                document.getElementById('audit-content').classList.remove('hidden');
                document.getElementById('access-denied').classList.add('hidden');
                populateUserFilter();
                await loadAuditLogs();
            } else {
                document.getElementById('audit-content').classList.add('hidden');
                document.getElementById('access-denied').classList.remove('hidden');
            }
        }

        function populateUserFilter() {
            const select = document.getElementById('filter-user');
            select.innerHTML = '<option value="">Wszyscy użytkownicy</option>' +
                teamMembers.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
        }

        function getMemberInitials(memberId) {
            const member = teamMembersMap[memberId];
            if (!member) return '??';
            return member.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
        }

        function getMemberColor(memberId) {
            const member = teamMembersMap[memberId];
            if (!member) return 'bg-zinc-500';
            const colorMap = {
                'violet': 'bg-violet-500',
                'blue': 'bg-blue-500',
                'emerald': 'bg-emerald-500',
                'amber': 'bg-amber-500',
                'pink': 'bg-pink-500',
                'cyan': 'bg-cyan-500'
            };
            return colorMap[member.color] || 'bg-zinc-500';
        }

        async function loadAuditLogs() {
            document.getElementById('loading-state').classList.remove('hidden');
            document.getElementById('empty-state').classList.add('hidden');

            const { data, error } = await supabaseClient
                .from('audit_log')
                .select('*')
                .order('created_at', { ascending: false });

            document.getElementById('loading-state').classList.add('hidden');

            if (error) {
                console.error('Error loading audit logs:', error);
                return;
            }

            auditLogs = data || [];
            document.getElementById('total-count').textContent = auditLogs.length;
            applyFilters();
        }

        function applyFilters() {
            const userFilter = document.getElementById('filter-user').value;
            const actionFilter = document.getElementById('filter-action').value;
            const entityFilter = document.getElementById('filter-entity').value;
            const dateFromFilter = document.getElementById('filter-date-from').value;
            const dateToFilter = document.getElementById('filter-date-to').value;
            const searchFilter = document.getElementById('filter-search').value.toLowerCase();

            filteredLogs = auditLogs.filter(log => {
                // User filter
                if (userFilter && log.performed_by !== userFilter) return false;

                // Action filter
                if (actionFilter && log.action_type !== actionFilter) return false;

                // Entity filter
                if (entityFilter && log.entity_type !== entityFilter) return false;

                // Date from filter
                if (dateFromFilter) {
                    const logDate = new Date(log.created_at).toISOString().split('T')[0];
                    if (logDate < dateFromFilter) return false;
                }

                // Date to filter
                if (dateToFilter) {
                    const logDate = new Date(log.created_at).toISOString().split('T')[0];
                    if (logDate > dateToFilter) return false;
                }

                // Search filter
                if (searchFilter) {
                    const searchIn = [
                        log.entity_identifier,
                        log.performed_by_name
                    ].filter(Boolean).join(' ').toLowerCase();
                    if (!searchIn.includes(searchFilter)) return false;
                }

                return true;
            });

            // Show/hide clear button
            const hasFilters = userFilter || actionFilter || entityFilter || dateFromFilter || dateToFilter || searchFilter;
            document.getElementById('clear-filters').classList.toggle('hidden', !hasFilters);

            document.getElementById('filtered-count').textContent = filteredLogs.length;
            currentPage = 1;
            renderLogs();
        }

        function formatDateTime(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            let relative;
            if (minutes < 1) relative = 'Przed chwilą';
            else if (minutes < 60) relative = `${minutes} min temu`;
            else if (hours < 24) relative = `${hours} godz. temu`;
            else if (days < 7) relative = `${days} dni temu`;
            else relative = date.toLocaleDateString('pl-PL');

            const time = date.toLocaleTimeString('pl-PL', { hour: '2-digit', minute: '2-digit' });

            return { relative, time, full: date.toLocaleString('pl-PL') };
        }

        function getActionBadge(actionType) {
            const action = ACTION_TYPES[actionType] || { label: actionType, icon: 'ph-question', color: 'zinc' };
            const colorClasses = {
                emerald: 'bg-emerald-500/10 text-emerald-400 border-emerald-500/20',
                blue: 'bg-blue-500/10 text-blue-400 border-blue-500/20',
                red: 'bg-red-500/10 text-red-400 border-red-500/20',
                violet: 'bg-violet-500/10 text-violet-400 border-violet-500/20',
                zinc: 'bg-zinc-500/10 text-zinc-400 border-zinc-500/20'
            };
            const classes = colorClasses[action.color] || colorClasses.zinc;

            return `<span class="inline-flex items-center gap-1.5 px-2 py-1 rounded border ${classes} text-[10px] font-medium">
                <i class="ph ${action.icon}"></i>
                ${action.label}
            </span>`;
        }

        function getEntityDisplay(log) {
            const entity = ENTITY_TYPES[log.entity_type] || { label: log.entity_type, icon: 'ph-question' };
            const identifier = log.entity_identifier || '-';

            return `<div class="flex items-center gap-2">
                <i class="ph ${entity.icon} text-zinc-500"></i>
                <div>
                    <div class="text-white font-medium">${entity.label}</div>
                    <div class="text-zinc-500 text-[10px] truncate max-w-[200px]" title="${identifier}">${identifier}</div>
                </div>
            </div>`;
        }

        // Polish labels for fields
        const FIELD_LABELS = {
            status: 'Status',
            name: 'Nazwa',
            email: 'Email',
            phone: 'Telefon',
            company: 'Firma',
            deal_value: 'Wartość',
            expected_close: 'Planowane zamknięcie',
            notes: 'Notatki',
            description: 'Opis',
            price: 'Cena',
            is_active: 'Aktywna',
            role: 'Rola',
            color: 'Kolor',
            title: 'Tytuł',
            date: 'Data',
            time: 'Godzina',
            duration: 'Czas trwania',
            value: 'Wartość',
            stages: 'Etapy',
            offer_id: 'Oferta',
            assigned_to: 'Przypisany do',
            nip: 'NIP',
            address: 'Adres'
        };

        const STATUS_LABELS = {
            new: 'Nowy',
            contacted: 'Skontaktowany',
            qualified: 'Zakwalifikowany',
            proposal: 'Propozycja',
            negotiation: 'Negocjacje',
            won: 'Wygrany',
            lost: 'Przegrany'
        };

        const ROLE_LABELS = {
            admin: 'Administrator',
            manager: 'Manager',
            sales: 'Handlowiec'
        };

        function formatFieldValue(key, value) {
            if (value === null || value === undefined) return '<span class="text-zinc-600 italic">brak</span>';
            if (value === true) return '<span class="text-emerald-400">Tak</span>';
            if (value === false) return '<span class="text-red-400">Nie</span>';

            // Special formatting for status
            if (key === 'status') {
                const label = STATUS_LABELS[value] || value;
                const colors = {
                    won: 'text-emerald-400',
                    lost: 'text-red-400',
                    new: 'text-zinc-300',
                    contacted: 'text-blue-400',
                    qualified: 'text-violet-400',
                    proposal: 'text-amber-400',
                    negotiation: 'text-orange-400'
                };
                return `<span class="${colors[value] || 'text-zinc-300'} font-medium">${label}</span>`;
            }

            // Role formatting
            if (key === 'role') {
                return `<span class="text-zinc-200">${ROLE_LABELS[value] || value}</span>`;
            }

            // Price/value formatting
            if (key === 'price' || key === 'deal_value' || key === 'value') {
                if (typeof value === 'number') {
                    return `<span class="text-emerald-400 font-mono">${value.toLocaleString('pl-PL')} PLN</span>`;
                }
            }

            // Duration formatting
            if (key === 'duration' && typeof value === 'number') {
                return `<span class="text-zinc-200">${value} min</span>`;
            }

            // Array/object - show count or simplified
            if (Array.isArray(value)) {
                if (key === 'stages') {
                    return `<span class="text-zinc-300">${value.length} etapów</span>`;
                }
                return `<span class="text-zinc-400">${value.length} elementów</span>`;
            }

            if (typeof value === 'object') {
                return `<span class="text-zinc-400 text-xs">${JSON.stringify(value)}</span>`;
            }

            return `<span class="text-zinc-200">${value}</span>`;
        }

        function formatDetailsNicely(oldValue, newValue, actionType) {
            // Handle status_change specially
            if (actionType === 'status_change' && oldValue?.status && newValue?.status) {
                const oldLabel = STATUS_LABELS[oldValue.status] || oldValue.status;
                const newLabel = STATUS_LABELS[newValue.status] || newValue.status;
                const oldColor = oldValue.status === 'won' ? 'emerald' : oldValue.status === 'lost' ? 'red' : 'zinc';
                const newColor = newValue.status === 'won' ? 'emerald' : newValue.status === 'lost' ? 'red' : 'blue';

                return `
                    <div class="flex items-center gap-4">
                        <div class="flex items-center gap-2">
                            <span class="px-3 py-1.5 rounded-lg bg-${oldColor}-500/10 border border-${oldColor}-500/20 text-${oldColor}-400 text-sm font-medium">
                                ${oldLabel}
                            </span>
                        </div>
                        <i class="ph ph-arrow-right text-zinc-500 text-xl"></i>
                        <div class="flex items-center gap-2">
                            <span class="px-3 py-1.5 rounded-lg bg-${newColor}-500/10 border border-${newColor}-500/20 text-${newColor}-400 text-sm font-medium">
                                ${newLabel}
                            </span>
                        </div>
                    </div>
                `;
            }

            // For create/delete - show single value nicely
            if (actionType === 'create' && newValue && !oldValue) {
                return formatObjectNicely(newValue, 'emerald');
            }

            if (actionType === 'delete' && oldValue && !newValue) {
                return formatObjectNicely(oldValue, 'red');
            }

            // For updates - show diff
            if (oldValue || newValue) {
                return formatDiffNicely(oldValue, newValue);
            }

            return '<span class="text-zinc-600 italic">Brak szczegółów</span>';
        }

        function formatObjectNicely(obj, color = 'zinc') {
            if (!obj || typeof obj !== 'object') return '';

            const rows = Object.entries(obj)
                .filter(([key]) => key !== 'stages' || !Array.isArray(obj[key])) // Skip large arrays
                .map(([key, value]) => {
                    const label = FIELD_LABELS[key] || key;
                    return `
                        <div class="flex items-center gap-3 py-1.5">
                            <span class="text-zinc-500 text-xs w-32">${label}</span>
                            <span class="text-${color}-400">${formatFieldValue(key, value).replace(/text-[a-z]+-\d+/g, `text-${color}-400`)}</span>
                        </div>
                    `;
                }).join('');

            return `<div class="space-y-0.5">${rows}</div>`;
        }

        function formatDiffNicely(oldValue, newValue) {
            const allKeys = new Set([
                ...Object.keys(oldValue || {}),
                ...Object.keys(newValue || {})
            ]);

            const rows = [];

            allKeys.forEach(key => {
                // Skip metadata-like fields and large arrays
                if (key === 'stages' && (Array.isArray(oldValue?.[key]) || Array.isArray(newValue?.[key]))) {
                    const oldCount = oldValue?.[key]?.length || 0;
                    const newCount = newValue?.[key]?.length || 0;
                    if (oldCount !== newCount) {
                        rows.push(`
                            <div class="flex items-center gap-3 py-1.5 border-b border-white/5">
                                <span class="text-zinc-500 text-xs w-32">Etapy pipeline</span>
                                <span class="text-red-400/70 line-through">${oldCount} etapów</span>
                                <i class="ph ph-arrow-right text-zinc-600"></i>
                                <span class="text-emerald-400">${newCount} etapów</span>
                            </div>
                        `);
                    }
                    return;
                }

                const oldVal = oldValue?.[key];
                const newVal = newValue?.[key];
                const label = FIELD_LABELS[key] || key;

                // Only show if values differ
                if (JSON.stringify(oldVal) !== JSON.stringify(newVal)) {
                    rows.push(`
                        <div class="flex items-center gap-3 py-1.5 border-b border-white/5">
                            <span class="text-zinc-500 text-xs w-32">${label}</span>
                            ${oldVal !== undefined ? `<span class="text-red-400/70 line-through text-sm">${formatFieldValue(key, oldVal).replace(/text-[a-z]+-\d+/g, 'text-red-400/70')}</span>` : ''}
                            <i class="ph ph-arrow-right text-zinc-600"></i>
                            ${newVal !== undefined ? `<span class="text-emerald-400 text-sm">${formatFieldValue(key, newVal).replace(/text-[a-z]+-\d+/g, 'text-emerald-400')}</span>` : '<span class="text-zinc-600 italic">usunięto</span>'}
                        </div>
                    `);
                }
            });

            return rows.length > 0 ? `<div class="space-y-0.5">${rows.join('')}</div>` : '<span class="text-zinc-600 italic">Brak zmian</span>';
        }

        function renderLogs() {
            const tbody = document.getElementById('audit-table');
            const emptyState = document.getElementById('empty-state');
            const totalPages = Math.ceil(filteredLogs.length / ITEMS_PER_PAGE);

            if (filteredLogs.length === 0) {
                tbody.innerHTML = '';
                emptyState.classList.remove('hidden');
                document.getElementById('showing-count').textContent = '0';
                document.getElementById('current-page').textContent = '1';
                document.getElementById('total-pages').textContent = '1';
                return;
            }

            emptyState.classList.add('hidden');

            const start = (currentPage - 1) * ITEMS_PER_PAGE;
            const end = Math.min(start + ITEMS_PER_PAGE, filteredLogs.length);
            const pageItems = filteredLogs.slice(start, end);

            document.getElementById('showing-count').textContent = pageItems.length;
            document.getElementById('current-page').textContent = currentPage;
            document.getElementById('total-pages').textContent = totalPages || 1;

            document.getElementById('prev-page').disabled = currentPage <= 1;
            document.getElementById('next-page').disabled = currentPage >= totalPages;

            tbody.innerHTML = pageItems.map((log, index) => {
                const dateTime = formatDateTime(log.created_at);
                const memberColor = getMemberColor(log.performed_by);
                const memberInitials = getMemberInitials(log.performed_by);
                const rowId = `details-${start + index}`;

                return `
                    <tr class="hover:bg-white/5 transition-colors">
                        <td class="px-5 py-3">
                            <div class="text-white">${dateTime.relative}</div>
                            <div class="text-zinc-500 text-[10px]">${dateTime.time}</div>
                        </td>
                        <td class="px-5 py-3">
                            <div class="flex items-center gap-2">
                                <div class="w-7 h-7 rounded-full ${memberColor} flex items-center justify-center text-white text-[10px] font-bold flex-shrink-0">
                                    ${memberInitials}
                                </div>
                                <span class="text-white truncate">${log.performed_by_name || '-'}</span>
                            </div>
                        </td>
                        <td class="px-5 py-3">
                            ${getActionBadge(log.action_type)}
                        </td>
                        <td class="px-5 py-3">
                            ${getEntityDisplay(log)}
                        </td>
                        <td class="px-5 py-3 text-center">
                            <button onclick="toggleDetails('${rowId}')" class="p-1.5 text-zinc-500 hover:text-white hover:bg-white/10 rounded transition-colors">
                                <i class="ph ph-caret-down" id="icon-${rowId}"></i>
                            </button>
                        </td>
                    </tr>
                    <tr id="${rowId}" class="hidden bg-zinc-950/50">
                        <td colspan="5" class="px-5 py-4 border-t border-white/5">
                            <div class="text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-3">Szczegóły zmiany</div>
                            <div class="bg-zinc-900/50 rounded-lg p-4">
                                ${formatDetailsNicely(log.old_value, log.new_value, log.action_type)}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function toggleDetails(rowId) {
            const row = document.getElementById(rowId);
            const icon = document.getElementById('icon-' + rowId);

            if (row.classList.contains('hidden')) {
                row.classList.remove('hidden');
                icon.classList.remove('ph-caret-down');
                icon.classList.add('ph-caret-up');
            } else {
                row.classList.add('hidden');
                icon.classList.remove('ph-caret-up');
                icon.classList.add('ph-caret-down');
            }
        }

        // Event listeners
        document.getElementById('logout-btn').addEventListener('click', async () => {
            await supabaseClient.auth.signOut();
            window.location.href = getLoginPath();
        });

        document.getElementById('refresh-btn').addEventListener('click', loadAuditLogs);

        document.getElementById('filter-user').addEventListener('change', applyFilters);
        document.getElementById('filter-action').addEventListener('change', applyFilters);
        document.getElementById('filter-entity').addEventListener('change', applyFilters);
        document.getElementById('filter-date-from').addEventListener('change', applyFilters);
        document.getElementById('filter-date-to').addEventListener('change', applyFilters);
        document.getElementById('filter-search').addEventListener('input', applyFilters);

        document.getElementById('clear-filters').addEventListener('click', () => {
            document.getElementById('filter-user').value = '';
            document.getElementById('filter-action').value = '';
            document.getElementById('filter-entity').value = '';
            document.getElementById('filter-date-from').value = '';
            document.getElementById('filter-date-to').value = '';
            document.getElementById('filter-search').value = '';
            applyFilters();
        });

        document.getElementById('prev-page').addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderLogs();
            }
        });

        document.getElementById('next-page').addEventListener('click', () => {
            const totalPages = Math.ceil(filteredLogs.length / ITEMS_PER_PAGE);
            if (currentPage < totalPages) {
                currentPage++;
                renderLogs();
            }
        });

        // Fix navigation paths for local development
        function fixNavPaths() {
            const base = getBasePath();
            document.querySelectorAll('a[data-page]').forEach(link => {
                link.href = base + '/' + link.dataset.page + '.html';
            });
        }

        async function init() {
            fixNavPaths();
            const session = await checkAuth();
        }
        init();
    </script>
</body>
</html>
