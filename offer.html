<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TN CRM - Oferta</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#050505">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="components/shared-sidebar.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    }
                }
            }
        }
    </script>
    <style>
        body { background: #050505; color: #e5e5e5; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::selection { background: white; color: black; }

        @media (max-width: 768px) {
            .mobile-back-btn { display: flex !important; }
        }
        @media (min-width: 769px) {
            .mobile-back-btn { display: none !important; }
        }

        .glass-header {
            background: rgba(5, 5, 5, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-enter { animation: fadeIn 0.4s ease-out forwards; }

        .input-field {
            background: #0a0a0a;
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.2s;
        }
        .input-field:focus {
            border-color: rgba(255,255,255,0.25);
            outline: none;
        }
        .input-field:hover:not(:focus) {
            border-color: rgba(255,255,255,0.15);
        }

        .milestone-card {
            transition: all 0.2s;
        }
        .milestone-card.dragging {
            opacity: 0.5;
            border-style: dashed;
        }
        .milestone-card.drag-over {
            border-color: rgba(245, 158, 11, 0.5);
            background: rgba(245, 158, 11, 0.05);
        }

        .task-item.task-drag-over {
            border-top: 2px solid rgba(139, 92, 246, 0.5);
        }

        .timeline-line {
            background: linear-gradient(to bottom, rgba(245, 158, 11, 0.5), rgba(245, 158, 11, 0.1), transparent);
        }

        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4); }
            50% { box-shadow: 0 0 0 4px rgba(245, 158, 11, 0); }
        }

        /* Modal - Vercel style */
        .modal-overlay {
            background: rgba(0, 0, 0, 0.7);
        }
        .modal-content {
            background: #000;
            border: 1px solid #262626;
            border-radius: 12px;
            box-shadow: 0 0 0 1px rgba(255,255,255,0.05), 0 25px 50px -12px rgba(0,0,0,0.8);
        }

        /* Submenu tabs */
        .submenu-tab {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            border-radius: 8px;
            color: #a1a1aa;
            transition: all 0.15s ease;
            cursor: pointer;
            width: 100%;
            text-align: left;
        }
        .submenu-tab:hover {
            color: #fff;
            background: rgba(255,255,255,0.05);
        }
        .submenu-tab.active {
            color: #fff;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.05);
        }
        .submenu-tab .tab-icon {
            font-size: 18px;
        }
        .submenu-tab .tab-label {
            font-size: 14px;
            font-weight: 500;
        }
        .submenu-tab .tab-count {
            margin-left: auto;
            font-size: 11px;
            font-family: 'JetBrains Mono', monospace;
            background: rgba(255,255,255,0.1);
            padding: 2px 8px;
            border-radius: 4px;
            color: #a1a1aa;
        }

        /* Tab content */
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body class="h-screen flex overflow-hidden font-sans text-sm tracking-tight antialiased">

    <!-- Sidebar -->
    <aside id="sidebar" class="w-[280px] bg-zinc-950 border-r border-white/5 flex flex-col flex-shrink-0"></aside>

    <!-- Main -->
    <main class="flex-1 flex flex-col bg-black relative min-w-0">
        <!-- Header -->
        <header class="h-16 glass-header flex items-center justify-between px-4 md:px-6 sticky top-0 z-30">
            <div class="flex items-center gap-3">
                <a href="/offers" data-page="offers" class="mobile-back-btn hidden items-center justify-center w-9 h-9 rounded-lg hover:bg-white/5 text-zinc-400 hover:text-white transition-colors">
                    <i class="ph ph-arrow-left text-xl"></i>
                </a>
                <div class="flex items-center gap-2 text-zinc-500">
                    <a href="/offers" class="text-zinc-400 hover:text-white transition-colors hidden sm:inline">offers</a>
                    <span class="text-zinc-700 hidden sm:inline">/</span>
                    <span id="header-name" class="text-white font-medium truncate max-w-[150px] md:max-w-[200px]">...</span>
                </div>
            </div>
            <div class="flex items-center gap-2 md:gap-4">
                <span id="save-status" class="text-xs text-zinc-500 hidden md:flex items-center gap-1.5"></span>
                <a href="/offers" class="hidden md:flex text-zinc-400 hover:text-white border border-zinc-800 hover:border-zinc-700 px-3 py-1.5 rounded-lg text-xs transition-colors items-center gap-1.5">
                    <i class="ph ph-arrow-left"></i>
                    Wstecz
                </a>
            </div>
        </header>

        <!-- Content with submenu -->
        <div class="flex-1 flex overflow-hidden">
            <!-- Submenu sidebar -->
            <nav class="w-56 flex-shrink-0 border-r border-white/5 p-4 overflow-y-auto hidden md:block">
                <div class="space-y-1">
                    <a href="/offers" class="submenu-tab">
                        <i class="ph ph-list tab-icon"></i>
                        <span class="tab-label">Wszystkie oferty</span>
                    </a>
                    <button onclick="switchTab('codes')" data-tab="codes" class="submenu-tab">
                        <i class="ph ph-ticket tab-icon"></i>
                        <span class="tab-label">Kody rabatowe</span>
                        <span id="submenu-codes-count" class="tab-count">-</span>
                    </button>
                </div>
            </nav>

            <!-- Tab content area -->
            <div class="flex-1 overflow-y-auto">
                <!-- Offer Tab -->
                <div id="tab-offer" class="tab-content active p-6 lg:p-10">
                    <div class="max-w-6xl mx-auto animate-enter">

                        <!-- Loading State -->
                        <div id="loading-state" class="py-16 text-center">
                            <div class="w-5 h-5 mx-auto mb-3 border-2 border-zinc-700 border-t-white rounded-full animate-spin"></div>
                            <p class="text-zinc-500 text-sm font-mono">Ładowanie...</p>
                        </div>

                        <!-- Offer Content -->
                        <div id="offer-content" class="hidden">

                    <!-- Offer Header -->
                    <div class="flex items-start gap-6 mb-8">
                        <div class="w-16 h-16 rounded-xl bg-gradient-to-br from-amber-500/20 to-orange-500/20 border border-amber-500/30 flex items-center justify-center flex-shrink-0">
                            <i class="ph ph-package text-3xl text-amber-400"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <input type="text" id="offer-name" class="text-3xl font-semibold text-white tracking-tight bg-transparent border-none outline-none w-full placeholder-zinc-600" placeholder="Nazwa oferty...">
                            <div class="flex items-center gap-3 mt-2">
                                <span id="created-date" class="text-xs text-zinc-500 font-mono"></span>
                                <span class="text-zinc-700">|</span>
                                <button id="toggle-active" class="text-xs flex items-center gap-1 transition-colors">
                                    <span id="status-indicator"></span>
                                </button>
                            </div>
                        </div>
                        <div class="text-right flex-shrink-0">
                            <div class="flex items-baseline gap-1">
                                <input type="number" id="offer-price" class="text-3xl font-semibold text-white font-mono bg-transparent text-right w-32 border-none outline-none placeholder-zinc-600" placeholder="0" min="0" step="0.01">
                                <span class="text-zinc-500 text-lg">PLN</span>
                            </div>
                        </div>
                    </div>

                    <!-- Offer Link -->
                    <div id="offer-link-section" class="hidden mb-6 bg-zinc-900/40 rounded-lg border border-white/5 p-4">
                        <div class="flex items-center justify-between gap-4">
                            <div class="flex items-center gap-3 flex-1 min-w-0">
                                <div class="w-10 h-10 rounded-lg bg-emerald-500/20 border border-emerald-500/30 flex items-center justify-center flex-shrink-0">
                                    <i class="ph ph-link text-emerald-400"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="text-xs text-zinc-500 mb-1">Link do płatności</div>
                                    <div id="offer-checkout-url" class="text-sm text-zinc-300 font-mono truncate"></div>
                                </div>
                            </div>
                            <div class="flex items-center gap-2 flex-shrink-0">
                                <button onclick="copyOfferLink()" class="flex items-center gap-2 px-3 py-2 bg-zinc-800 hover:bg-zinc-700 text-white rounded-lg text-sm transition-colors">
                                    <i class="ph ph-copy"></i>
                                    Kopiuj
                                </button>
                                <button onclick="openOfferLink()" class="flex items-center gap-2 px-3 py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg text-sm transition-colors">
                                    <i class="ph ph-arrow-square-out"></i>
                                    Otwórz
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Discount Codes Section -->
                    <div class="mb-6 bg-zinc-900/40 rounded-lg border border-white/5 p-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-emerald-500/10 rounded-lg flex items-center justify-center">
                                    <i class="ph ph-ticket text-lg text-emerald-400"></i>
                                </div>
                                <div>
                                    <h3 class="text-sm font-medium text-white flex items-center gap-2">
                                        Kody rabatowe
                                        <span id="discount-codes-count" class="text-[10px] bg-zinc-800 text-zinc-400 px-1.5 py-0.5 rounded font-mono">0</span>
                                    </h3>
                                    <p class="text-xs text-zinc-500">Szybko stwórz kod rabatowy dla tej oferty</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <button onclick="quickAddDiscountCode()" class="text-emerald-400 hover:text-emerald-300 bg-emerald-500/10 hover:bg-emerald-500/20 px-3 py-1.5 rounded-lg text-xs font-medium transition-colors flex items-center gap-1.5">
                                    <i class="ph ph-plus"></i>
                                    Nowy kod
                                </button>
                                <a id="all-codes-link" href="/offers?tab=codes" class="text-zinc-400 hover:text-white hover:bg-white/5 px-3 py-1.5 rounded-lg text-xs transition-colors flex items-center gap-1.5">
                                    <i class="ph ph-list"></i>
                                    Wszystkie
                                </a>
                            </div>
                        </div>
                        <!-- Quick codes list for this offer -->
                        <div id="offer-discount-codes" class="mt-3 hidden">
                            <div class="border-t border-white/5 pt-3">
                                <div id="offer-codes-list" class="space-y-2"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Contract Template Section (only for specific offers) -->
                    <div id="contract-section" class="mb-6 bg-zinc-900/40 rounded-lg border border-white/5 p-4 hidden">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-blue-500/10 rounded-lg flex items-center justify-center">
                                    <i class="ph ph-file-text text-lg text-blue-400"></i>
                                </div>
                                <div>
                                    <h3 class="text-sm font-medium text-white flex items-center gap-2">
                                        Wzór umowy
                                    </h3>
                                    <p class="text-xs text-zinc-500">Umowa o współpracy dla tej oferty</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <a id="contract-link" href="#" target="_blank" class="text-blue-400 hover:text-blue-300 bg-blue-500/10 hover:bg-blue-500/20 px-3 py-1.5 rounded-lg text-xs font-medium transition-colors flex items-center gap-1.5">
                                    <i class="ph ph-arrow-square-out"></i>
                                    Otwórz umowę
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Two Column Layout -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

                        <!-- Left Column (2/3) -->
                        <div class="lg:col-span-2 space-y-6">

                            <!-- Basic Info -->
                            <div class="bg-zinc-900/40 rounded-lg border border-white/5 p-5">
                                <h3 class="text-sm font-medium text-white mb-4 flex items-center gap-2">
                                    <i class="ph ph-info text-zinc-500"></i>
                                    Opis oferty
                                </h3>
                                <textarea id="offer-description" rows="4" class="input-field w-full rounded-lg px-3 py-2.5 text-sm text-white resize-none" placeholder="Ogólny opis oferty..."></textarea>
                            </div>

                            <!-- Contract Template -->
                            <div class="bg-zinc-900/40 rounded-lg border border-white/5 p-5">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-sm font-medium text-white flex items-center gap-2">
                                        <i class="ph ph-file-text text-emerald-400"></i>
                                        Wzor umowy
                                    </h3>
                                    <button type="button" onclick="toggleContractHelp()" class="text-zinc-500 hover:text-zinc-300 text-xs flex items-center gap-1">
                                        <i class="ph ph-question"></i>
                                        Zmienne
                                    </button>
                                </div>
                                <div id="contract-help" class="hidden mb-4 p-3 bg-zinc-800/50 rounded-lg text-xs text-zinc-400">
                                    <p class="mb-2">Dostepne zmienne (beda automatycznie zastapione):</p>
                                    <div class="grid grid-cols-2 gap-1 font-mono text-[10px]">
                                        <span>{{imie_nazwisko}}</span>
                                        <span>{{firma}}</span>
                                        <span>{{ulica}}</span>
                                        <span>{{miasto}}</span>
                                        <span>{{kod_pocztowy}}</span>
                                        <span>{{kraj}}</span>
                                        <span>{{pesel}}</span>
                                        <span>{{nr_dowodu}}</span>
                                        <span>{{email}}</span>
                                        <span>{{telefon}}</span>
                                        <span>{{nazwa_oferty}}</span>
                                        <span>{{cena}}</span>
                                        <span>{{data_dzis}}</span>
                                    </div>
                                </div>
                                <textarea id="offer-contract-template" rows="12" class="input-field w-full rounded-lg px-3 py-2.5 text-sm text-white resize-y font-mono text-xs leading-relaxed" placeholder="Wklej wzor umowy...&#10;&#10;Uzyj zmiennych np. {{imie_nazwisko}}, {{firma}}, {{pesel}} itd."></textarea>
                            </div>

                            <!-- Milestones Editor -->
                            <div class="bg-zinc-900/40 rounded-lg border border-white/5 p-5">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-sm font-medium text-white flex items-center gap-2">
                                        <i class="ph ph-path text-amber-400"></i>
                                        Etapy realizacji
                                        <span id="milestones-count" class="text-[10px] bg-zinc-800 text-zinc-400 px-1.5 py-0.5 rounded font-mono">0</span>
                                    </h3>
                                    <button id="add-milestone-btn" class="text-zinc-400 hover:text-white text-xs flex items-center gap-1 hover:bg-white/5 px-2 py-1 rounded transition-colors">
                                        <i class="ph ph-plus"></i>
                                        Dodaj etap
                                    </button>
                                </div>

                                <div id="milestones-list" class="space-y-4">
                                    <!-- Milestones rendered here -->
                                </div>

                                <div id="milestones-empty" class="text-center py-8">
                                    <i class="ph ph-path text-2xl text-zinc-700 mb-2"></i>
                                    <p class="text-zinc-500 text-xs">Brak etapów realizacji</p>
                                    <p class="text-zinc-600 text-[10px] mb-3">Dodaj pierwszy etap, aby stworzyć harmonogram</p>
                                    <button onclick="addMilestone()" class="text-white bg-zinc-800 hover:bg-zinc-700 px-3 py-1.5 rounded-lg text-xs transition-colors">
                                        <i class="ph ph-plus mr-1"></i> Dodaj etap
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column (1/3) - Timeline Preview -->
                        <div class="lg:col-span-1">
                            <div class="bg-zinc-900/40 rounded-lg border border-white/5 p-5">
                                <h3 class="text-sm font-medium text-white mb-4 flex items-center gap-2">
                                    <i class="ph ph-chart-line text-cyan-400"></i>
                                    Harmonogram
                                </h3>

                                <div id="timeline-preview" class="relative">
                                    <!-- Timeline rendered here -->
                                </div>

                                <!-- Summary -->
                                <div class="mt-6 pt-4 border-t border-white/5">
                                    <!-- Top row: General stats -->
                                    <div class="flex items-center justify-center gap-6 mb-4">
                                        <div class="flex items-center gap-2">
                                            <div class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center">
                                                <i class="ph ph-calendar-blank text-white/60 text-sm"></i>
                                            </div>
                                            <div>
                                                <div class="text-lg font-semibold text-white font-mono leading-none" id="total-days">0</div>
                                                <div class="text-[9px] text-zinc-500 uppercase">dni</div>
                                            </div>
                                        </div>
                                        <div class="w-px h-8 bg-white/10"></div>
                                        <div class="flex items-center gap-2">
                                            <div class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center">
                                                <i class="ph ph-flag-checkered text-white/60 text-sm"></i>
                                            </div>
                                            <div>
                                                <div class="text-lg font-semibold text-white font-mono leading-none" id="total-milestones">0</div>
                                                <div class="text-[9px] text-zinc-500 uppercase">etapów</div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Bottom row: Task breakdown -->
                                    <div class="flex items-center justify-between gap-2 p-2 bg-zinc-950/30 rounded-lg">
                                        <div class="flex-1 flex items-center justify-center gap-1.5 py-1.5 px-2 rounded bg-violet-500/10 border border-violet-500/20">
                                            <i class="ph ph-users-three text-violet-400 text-xs"></i>
                                            <span class="text-sm font-semibold text-violet-400 font-mono" id="total-team-tasks">0</span>
                                            <span class="text-[9px] text-violet-400/60 uppercase">TN</span>
                                        </div>
                                        <div class="flex-1 flex items-center justify-center gap-1.5 py-1.5 px-2 rounded bg-cyan-500/10 border border-cyan-500/20">
                                            <i class="ph ph-user text-cyan-400 text-xs"></i>
                                            <span class="text-sm font-semibold text-cyan-400 font-mono" id="total-client-tasks">0</span>
                                            <span class="text-[9px] text-cyan-400/60 uppercase">Klient</span>
                                        </div>
                                        <div class="flex-1 flex items-center justify-center gap-1.5 py-1.5 px-2 rounded bg-amber-500/10 border border-amber-500/20">
                                            <i class="ph ph-handshake text-amber-400 text-xs"></i>
                                            <span class="text-sm font-semibold text-amber-400 font-mono" id="total-shared-tasks">0</span>
                                            <span class="text-[9px] text-amber-400/60 uppercase">Wspólnie</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                        <!-- Not Found State -->
                        <div id="not-found-state" class="hidden py-16 text-center">
                            <i class="ph ph-warning text-4xl text-zinc-700 mb-3"></i>
                            <p class="text-zinc-400 text-sm mb-1">Nie znaleziono oferty</p>
                            <a href="/offers" class="text-white underline text-sm">Wróć do listy ofert</a>
                        </div>
                    </div>
                </div>

                <!-- Discount Codes Tab -->
                <div id="tab-codes" class="tab-content">
                    <iframe id="codes-iframe" class="w-full h-full border-0" style="min-height: calc(100vh - 64px);"></iframe>
                </div>
            </div>
        </div>
    </main>

    <!-- Quick Add Discount Code Modal -->
    <div id="discount-code-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="modal-overlay absolute inset-0 bg-black/70" onclick="closeDiscountCodeModal()"></div>
        <div class="modal-content w-full max-w-md relative animate-enter">
            <!-- Header -->
            <div class="flex items-center justify-between p-5 border-b border-[#262626]">
                <h2 class="text-lg font-semibold text-white flex items-center gap-2">
                    <i class="ph ph-ticket text-emerald-400"></i>
                    Nowy kod rabatowy
                </h2>
                <button onclick="closeDiscountCodeModal()" class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-[#262626] text-neutral-400 hover:text-white transition-colors">
                    <i class="ph ph-x text-lg"></i>
                </button>
            </div>

            <!-- Form -->
            <form id="discount-code-form" class="p-5 space-y-4">
                <!-- Code -->
                <div>
                    <label class="block text-[11px] uppercase tracking-wider text-neutral-500 mb-2">Kod</label>
                    <div class="flex gap-2">
                        <input type="text" id="dc-code" class="input-field flex-1 uppercase rounded-lg px-3 py-2.5" placeholder="np. RABAT20" required>
                        <button type="button" onclick="generateDiscountCode()" class="text-zinc-400 hover:text-white border border-zinc-700 hover:border-zinc-600 px-3 rounded-lg transition-colors" title="Generuj losowy kod">
                            <i class="ph ph-shuffle text-lg"></i>
                        </button>
                    </div>
                </div>

                <!-- Prices -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[11px] uppercase tracking-wider text-neutral-500 mb-2">Cena oryginalna</label>
                        <div class="relative">
                            <input type="number" id="dc-original-price" class="input-field w-full pr-12 rounded-lg px-3 py-2.5" step="0.01" min="0" readonly>
                            <span class="absolute right-3 top-1/2 -translate-y-1/2 text-neutral-500 text-sm">PLN</span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-[11px] uppercase tracking-wider text-neutral-500 mb-2">Cena po rabacie *</label>
                        <div class="relative">
                            <input type="number" id="dc-target-price" class="input-field w-full pr-12 rounded-lg px-3 py-2.5" step="0.01" min="0" placeholder="0.00" required>
                            <span class="absolute right-3 top-1/2 -translate-y-1/2 text-neutral-500 text-sm">PLN</span>
                        </div>
                    </div>
                </div>

                <!-- Discount preview -->
                <div id="dc-discount-preview" class="hidden bg-zinc-900 border border-zinc-800 rounded-lg p-3">
                    <div class="flex items-center justify-between">
                        <span class="text-neutral-400 text-sm">Wysokość rabatu:</span>
                        <span id="dc-preview-discount" class="text-emerald-400 font-medium">-</span>
                    </div>
                </div>

                <!-- Usage limit -->
                <div>
                    <label class="block text-[11px] uppercase tracking-wider text-neutral-500 mb-2">Limit użyć</label>
                    <div class="flex items-center gap-3">
                        <input type="number" id="dc-limit" class="input-field w-32 rounded-lg px-3 py-2.5" min="1" placeholder="∞">
                        <span class="text-neutral-500 text-xs">Zostaw puste = bez limitu</span>
                    </div>
                </div>

                <!-- Description -->
                <div>
                    <label class="block text-[11px] uppercase tracking-wider text-neutral-500 mb-2">Opis (wewnętrzny)</label>
                    <input type="text" id="dc-description" class="input-field w-full rounded-lg px-3 py-2.5" placeholder="np. Promocja dla subskrybentów">
                </div>
            </form>

            <!-- Footer -->
            <div class="flex items-center justify-between p-5 border-t border-[#262626]">
                <button type="button" onclick="closeDiscountCodeModal()" class="text-zinc-400 hover:text-white border border-zinc-700 hover:border-zinc-600 px-4 py-2 rounded-lg text-sm transition-colors">
                    Anuluj
                </button>
                <button type="button" onclick="saveDiscountCode()" class="bg-emerald-500 text-white hover:bg-emerald-600 px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
                    <i class="ph ph-check"></i>
                    Zapisz kod
                </button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://yxmavwkwnfuphjqbelws.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl4bWF2d2t3bmZ1cGhqcWJlbHdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NjQyNTUsImV4cCI6MjA4NDM0MDI1NX0.XeR0Fc7OFn6YbNJrOKTBEj36JtmLISZTM87y4ai9340';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let offer = null;
        let milestones = [];
        let hasChanges = false;
        let saveTimeout = null;
        let isSaving = false;
        let draggedMilestone = null;

        let teamMembers = [];
        let currentMember = null;
        let isAdmin = false;

        function getBasePath() {
            if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
                const path = location.pathname;
                const match = path.match(/^(\/[^\/]+)\//);
                return match ? match[1] : '';
            }
            return '';
        }

        function generateId() {
            return 'xxxx-xxxx'.replace(/x/g, () => Math.floor(Math.random() * 16).toString(16));
        }

        async function checkAuth() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
                window.location.href = Sidebar.getLoginPath();
                return null;
            }
            Sidebar.setUserEmail(session.user.email.split('@')[0]);
            await loadTeamMembers(session.user.id);
            return session;
        }

        async function loadTeamMembers(userId) {
            const { data, error } = await supabaseClient.from('team_members').select('*');
            if (error) {
                console.error('Error loading team members:', error);
                return;
            }
            teamMembers = data || [];
            currentMember = teamMembers.find(m => m.user_id === userId);
            isAdmin = currentMember?.role === 'admin';

            // Update sidebar user info
            if (currentMember) {
                Sidebar.setUserName(currentMember.name);
                Sidebar.setUserColor(currentMember.color);
                Sidebar.setupProfileClick();
            }

            // Show admin navigation items for admins
            Sidebar.showAdminNav(isAdmin);
        }

        async function logAuditActivity(action_type, entity_type, entity_id, entity_identifier, old_value, new_value, metadata = {}) {
            if (!currentMember) return;
            try {
                await supabaseClient.from('audit_log').insert([{
                    action_type,
                    entity_type,
                    entity_id,
                    entity_identifier,
                    old_value,
                    new_value,
                    performed_by: currentMember.id,
                    performed_by_name: currentMember.name,
                    metadata: { ...metadata, source_page: window.location.pathname }
                }]);
            } catch (err) {
                console.error('Audit log error:', err);
            }
        }

        Sidebar.render();
        Sidebar.setupLogout(supabaseClient);

        // Contract template help toggle
        function toggleContractHelp() {
            const help = document.getElementById('contract-help');
            help.classList.toggle('hidden');
        }
        window.toggleContractHelp = toggleContractHelp;

        // Save status
        function showSaveStatus(status) {
            const statusEl = document.getElementById('save-status');
            if (status === 'saving') {
                statusEl.innerHTML = '<i class="ph ph-circle-notch animate-spin"></i> Zapisywanie...';
                statusEl.className = 'text-xs text-zinc-400 flex items-center gap-1.5';
            } else if (status === 'saved') {
                statusEl.innerHTML = '<i class="ph ph-check-circle"></i> Zapisano';
                statusEl.className = 'text-xs text-emerald-400 flex items-center gap-1.5';
                setTimeout(() => { statusEl.innerHTML = ''; }, 2000);
            } else if (status === 'error') {
                statusEl.innerHTML = '<i class="ph ph-warning-circle"></i> Błąd zapisu';
                statusEl.className = 'text-xs text-red-400 flex items-center gap-1.5';
            }
        }

        // Auto-save
        async function autoSave() {
            if (isSaving || !offer) return;

            isSaving = true;
            showSaveStatus('saving');

            const oldOffer = { ...offer };

            const updates = {
                name: document.getElementById('offer-name').value.trim() || 'Bez nazwy',
                description: document.getElementById('offer-description').value.trim() || null,
                price: parseFloat(document.getElementById('offer-price').value) || 0,
                is_active: offer.is_active,
                milestones: milestones,
                contract_template: document.getElementById('offer-contract-template').value.trim() || null
            };

            const { error } = await supabaseClient
                .from('offers')
                .update(updates)
                .eq('id', offer.id);

            isSaving = false;

            if (error) {
                showSaveStatus('error');
                console.error('Auto-save error:', error);
            } else {
                await logAuditActivity('update', 'offer', offer.id, updates.name,
                    { name: oldOffer.name, milestones_count: (oldOffer.milestones || []).length },
                    { name: updates.name, milestones_count: milestones.length }
                );
                Object.assign(offer, updates);
                hasChanges = false;
                showSaveStatus('saved');
                document.getElementById('header-name').textContent = updates.name;
            }
        }

        function triggerAutoSave() {
            hasChanges = true;
            if (saveTimeout) clearTimeout(saveTimeout);
            saveTimeout = setTimeout(autoSave, 1000);
        }

        // Load offer
        async function loadOffer() {
            const params = new URLSearchParams(window.location.search);
            const offerId = params.get('id');

            if (!offerId) {
                document.getElementById('loading-state').classList.add('hidden');
                document.getElementById('not-found-state').classList.remove('hidden');
                return;
            }

            const { data, error } = await supabaseClient
                .from('offers')
                .select('*')
                .eq('id', offerId)
                .single();

            document.getElementById('loading-state').classList.add('hidden');

            if (error || !data) {
                document.getElementById('not-found-state').classList.remove('hidden');
                return;
            }

            offer = data;
            milestones = offer.milestones || [];

            // Populate fields
            document.getElementById('offer-name').value = offer.name || '';
            document.getElementById('offer-description').value = offer.description || '';
            document.getElementById('offer-price').value = offer.price || '';
            document.getElementById('offer-contract-template').value = offer.contract_template || '';
            document.getElementById('header-name').textContent = offer.name || 'Bez nazwy';
            document.getElementById('created-date').textContent = `Utworzono: ${new Date(offer.created_at).toLocaleDateString('pl-PL')}`;

            updateStatusIndicator();
            renderMilestones();
            renderTimelinePreview();
            updateOfferLink();

            document.getElementById('offer-content').classList.remove('hidden');

            // Load discount codes for this offer
            await loadOfferDiscountCodes();

            // Show contract section for specific offers
            const contractTemplates = {
                '30bf199b-8bc1-4810-8716-43dbffeb9113': '/umowy/umowa-budowa-sklepu.html',
                'bc5212fd-3f57-46a8-a2e9-07c030e97a3f': '/umowy/umowa-mentoring-ai.html'
            };
            if (contractTemplates[offer.id]) {
                const contractSection = document.getElementById('contract-section');
                const contractLink = document.getElementById('contract-link');
                if (contractSection && contractLink) {
                    contractLink.href = contractTemplates[offer.id];
                    contractSection.classList.remove('hidden');
                }
            }

            // Fix all-codes link to include offer filter
            const allCodesLink = document.getElementById('all-codes-link');
            if (allCodesLink) {
                const isLocal = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
                const base = getBasePath();
                allCodesLink.href = isLocal
                    ? `${base}/offers.html?tab=codes`
                    : `/offers?tab=codes`;
            }

            // Attach event listeners
            document.getElementById('offer-name').addEventListener('input', triggerAutoSave);
            document.getElementById('offer-description').addEventListener('input', triggerAutoSave);
            document.getElementById('offer-contract-template').addEventListener('input', triggerAutoSave);
            document.getElementById('offer-price').addEventListener('input', () => {
                triggerAutoSave();
                // Update link visibility when price changes
                offer.price = parseFloat(document.getElementById('offer-price').value) || 0;
                updateOfferLink();
            });
        }

        function updateStatusIndicator() {
            const indicator = document.getElementById('status-indicator');
            if (offer.is_active) {
                indicator.innerHTML = '<span class="text-emerald-400">● Aktywna</span>';
            } else {
                indicator.innerHTML = '<span class="text-zinc-500">○ Nieaktywna</span>';
            }
        }

        // Checkout link functions
        function getCheckoutUrl() {
            if (!offer) return '';
            const baseUrl = location.origin;
            const base = getBasePath();
            const isLocal = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
            const checkoutPath = isLocal ? `${base}/checkout/index.html` : '/checkout';
            return `${baseUrl}${checkoutPath}?offer=${offer.id}`;
        }

        function updateOfferLink() {
            if (!offer || !offer.price || offer.price <= 0) {
                document.getElementById('offer-link-section').classList.add('hidden');
                return;
            }
            const url = getCheckoutUrl();
            document.getElementById('offer-checkout-url').textContent = url;
            document.getElementById('offer-link-section').classList.remove('hidden');
        }

        async function copyOfferLink() {
            const url = getCheckoutUrl();
            try {
                await navigator.clipboard.writeText(url);
                showToast('Link skopiowany do schowka');
            } catch (err) {
                const textArea = document.createElement('textarea');
                textArea.value = url;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showToast('Link skopiowany do schowka');
            }
        }

        function openOfferLink() {
            const url = getCheckoutUrl();
            window.open(url, '_blank');
        }

        function showToast(message) {
            const existing = document.getElementById('toast-notification');
            if (existing) existing.remove();

            const toast = document.createElement('div');
            toast.id = 'toast-notification';
            toast.className = 'fixed bottom-6 right-6 bg-zinc-800 border border-white/10 text-white px-4 py-3 rounded-lg shadow-xl z-50 flex items-center gap-2 animate-enter';
            toast.innerHTML = `<i class="ph ph-check-circle text-emerald-400"></i> ${message}`;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(10px)';
                toast.style.transition = 'all 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Make link functions globally available
        window.copyOfferLink = copyOfferLink;
        window.openOfferLink = openOfferLink;

        document.getElementById('toggle-active').addEventListener('click', async () => {
            if (!offer) return;
            offer.is_active = !offer.is_active;
            updateStatusIndicator();
            triggerAutoSave();
        });

        // Milestones management
        function addMilestone() {
            const newMilestone = {
                id: generateId(),
                order: milestones.length,
                title: '',
                description: '',
                duration_days: 7,
                deliverables: [],
                tasks: []
            };

            milestones.push(newMilestone);
            renderMilestones();
            renderTimelinePreview();
            triggerAutoSave();

            // Focus on new milestone
            setTimeout(() => {
                const input = document.querySelector(`[data-milestone-id="${newMilestone.id}"] .milestone-title`);
                if (input) input.focus();
            }, 50);
        }

        function deleteMilestone(id) {
            if (!confirm('Czy na pewno chcesz usunąć ten etap?')) return;

            milestones = milestones.filter(m => m.id !== id);
            reorderMilestones();
            renderMilestones();
            renderTimelinePreview();
            triggerAutoSave();
        }

        function reorderMilestones() {
            milestones.forEach((m, index) => m.order = index);
        }

        function addDeliverable(milestoneId) {
            const milestone = milestones.find(m => m.id === milestoneId);
            if (!milestone) return;

            milestone.deliverables.push('');
            renderMilestoneDeliverables(milestoneId);
            renderTimelinePreview();
            triggerAutoSave();

            // Focus on new deliverable
            setTimeout(() => {
                const inputs = document.querySelectorAll(`[data-milestone-id="${milestoneId}"] .deliverable-input`);
                if (inputs.length > 0) inputs[inputs.length - 1].focus();
            }, 50);
        }

        function removeDeliverable(milestoneId, index) {
            const milestone = milestones.find(m => m.id === milestoneId);
            if (!milestone) return;

            milestone.deliverables.splice(index, 1);
            renderMilestoneDeliverables(milestoneId);
            renderTimelinePreview();
            triggerAutoSave();
        }

        function updateDeliverable(milestoneId, index, value) {
            const milestone = milestones.find(m => m.id === milestoneId);
            if (!milestone) return;

            milestone.deliverables[index] = value;
            triggerAutoSave();
        }

        function addTask(milestoneId, responsible = 'team') {
            const milestone = milestones.find(m => m.id === milestoneId);
            if (!milestone) return;

            milestone.tasks.push({
                id: generateId(),
                title: '',
                completed: false,
                responsible: responsible // 'team', 'client', or 'shared'
            });
            renderMilestoneTasks(milestoneId);
            renderTimelinePreview();
            triggerAutoSave();

            // Focus on new task
            setTimeout(() => {
                const inputs = document.querySelectorAll(`[data-milestone-id="${milestoneId}"] .task-input`);
                if (inputs.length > 0) inputs[inputs.length - 1].focus();
            }, 50);
        }

        function toggleTaskResponsible(milestoneId, taskId) {
            const milestone = milestones.find(m => m.id === milestoneId);
            if (!milestone) return;

            const task = milestone.tasks.find(t => t.id === taskId);
            if (task) {
                // Cycle: team → client → shared → team
                if (task.responsible === 'team') {
                    task.responsible = 'client';
                } else if (task.responsible === 'client') {
                    task.responsible = 'shared';
                } else {
                    task.responsible = 'team';
                }
                renderMilestoneTasks(milestoneId);
                renderTimelinePreview();
                triggerAutoSave();
            }
        }

        function removeTask(milestoneId, taskId) {
            const milestone = milestones.find(m => m.id === milestoneId);
            if (!milestone) return;

            milestone.tasks = milestone.tasks.filter(t => t.id !== taskId);
            renderMilestoneTasks(milestoneId);
            renderTimelinePreview();
            triggerAutoSave();
        }

        function updateTask(milestoneId, taskId, value) {
            const milestone = milestones.find(m => m.id === milestoneId);
            if (!milestone) return;

            const task = milestone.tasks.find(t => t.id === taskId);
            if (task) task.title = value;
            triggerAutoSave();
        }

        function toggleTaskComplete(milestoneId, taskId) {
            const milestone = milestones.find(m => m.id === milestoneId);
            if (!milestone) return;

            const task = milestone.tasks.find(t => t.id === taskId);
            if (task) {
                task.completed = !task.completed;
                renderMilestoneTasks(milestoneId);
                triggerAutoSave();
            }
        }

        function updateMilestoneField(milestoneId, field, value) {
            const milestone = milestones.find(m => m.id === milestoneId);
            if (!milestone) return;

            if (field === 'duration_days') {
                const parsed = parseInt(value);
                milestone[field] = isNaN(parsed) ? 1 : Math.max(0, parsed);
                renderTimelinePreview();
            } else {
                milestone[field] = value;
            }
            triggerAutoSave();
        }

        // Render milestones
        function renderMilestones() {
            const container = document.getElementById('milestones-list');
            const emptyState = document.getElementById('milestones-empty');

            document.getElementById('milestones-count').textContent = milestones.length;

            if (milestones.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');

            container.innerHTML = milestones.map((milestone, index) => `
                <div class="milestone-card group bg-zinc-950/50 rounded-lg border border-white/5 hover:border-white/10 transition-all"
                     data-milestone-id="${milestone.id}" draggable="true">

                    <!-- Header -->
                    <div class="flex items-center gap-3 px-4 py-3 border-b border-white/5">
                        <div class="drag-handle cursor-grab text-zinc-600 hover:text-zinc-400 active:cursor-grabbing">
                            <i class="ph ph-dots-six-vertical"></i>
                        </div>
                        <div class="w-8 h-8 rounded-lg bg-amber-500/20 flex items-center justify-center flex-shrink-0">
                            <span class="text-amber-400 text-xs font-bold">${index + 1}</span>
                        </div>
                        <input type="text"
                               class="milestone-title flex-1 bg-transparent text-white font-medium text-sm border-none outline-none placeholder-zinc-600"
                               value="${escapeHtml(milestone.title)}"
                               placeholder="Nazwa etapu..."
                               onchange="updateMilestoneField('${milestone.id}', 'title', this.value)"
                               oninput="updateMilestoneField('${milestone.id}', 'title', this.value)">
                        <div class="flex items-center gap-2">
                            <input type="number"
                                   class="milestone-duration w-16 bg-zinc-900 text-white text-sm px-2 py-1 rounded border border-zinc-800 text-center focus:border-zinc-600 outline-none"
                                   value="${milestone.duration_days}"
                                   min="0"
                                   onchange="updateMilestoneField('${milestone.id}', 'duration_days', this.value)">
                            <span class="text-zinc-500 text-xs">dni</span>
                        </div>
                        <button onclick="deleteMilestone('${milestone.id}')"
                                class="opacity-0 group-hover:opacity-100 text-red-400 hover:text-red-300 p-1 transition-all"
                                title="Usuń etap">
                            <i class="ph ph-trash text-sm"></i>
                        </button>
                    </div>

                    <!-- Description -->
                    <div class="px-4 py-3 border-b border-white/5">
                        <textarea class="milestone-description w-full bg-transparent text-zinc-300 text-sm resize-none border-none outline-none placeholder-zinc-600"
                                  rows="2"
                                  placeholder="Opis etapu..."
                                  onchange="updateMilestoneField('${milestone.id}', 'description', this.value)"
                                  oninput="updateMilestoneField('${milestone.id}', 'description', this.value)">${escapeHtml(milestone.description || '')}</textarea>
                    </div>

                    <!-- Deliverables -->
                    <div class="px-4 py-3 border-b border-white/5">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-[10px] font-mono text-zinc-500 uppercase tracking-wider">Rezultaty</span>
                            <button onclick="addDeliverable('${milestone.id}')" class="text-zinc-500 hover:text-white text-xs transition-colors">
                                <i class="ph ph-plus"></i>
                            </button>
                        </div>
                        <div class="deliverables-list space-y-1" data-milestone-id="${milestone.id}">
                            ${renderDeliverables(milestone)}
                        </div>
                    </div>

                    <!-- Tasks -->
                    <div class="px-4 py-3">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-[10px] font-mono text-zinc-500 uppercase tracking-wider">Zadania</span>
                            <div class="flex items-center gap-1">
                                <button onclick="addTask('${milestone.id}', 'team')" class="flex items-center gap-1 text-violet-400 hover:text-violet-300 text-[10px] px-1.5 py-0.5 rounded hover:bg-violet-500/10 transition-colors" title="Dodaj zadanie dla zespołu TN">
                                    <i class="ph ph-plus text-[10px]"></i>
                                    <i class="ph ph-users-three text-[10px]"></i>
                                </button>
                                <button onclick="addTask('${milestone.id}', 'client')" class="flex items-center gap-1 text-cyan-400 hover:text-cyan-300 text-[10px] px-1.5 py-0.5 rounded hover:bg-cyan-500/10 transition-colors" title="Dodaj zadanie dla klienta">
                                    <i class="ph ph-plus text-[10px]"></i>
                                    <i class="ph ph-user text-[10px]"></i>
                                </button>
                                <button onclick="addTask('${milestone.id}', 'shared')" class="flex items-center gap-1 text-amber-400 hover:text-amber-300 text-[10px] px-1.5 py-0.5 rounded hover:bg-amber-500/10 transition-colors" title="Dodaj zadanie wspólne">
                                    <i class="ph ph-plus text-[10px]"></i>
                                    <i class="ph ph-handshake text-[10px]"></i>
                                </button>
                            </div>
                        </div>
                        <div class="tasks-list space-y-1" data-milestone-id="${milestone.id}">
                            ${renderTasks(milestone)}
                        </div>
                    </div>
                </div>
            `).join('');

            initDragDrop();
            initTaskDragDrop();
        }

        function renderDeliverables(milestone) {
            if (milestone.deliverables.length === 0) {
                return '<p class="text-zinc-600 text-xs">Brak rezultatów</p>';
            }

            return milestone.deliverables.map((deliverable, index) => `
                <div class="deliverable-item flex items-center gap-2 group/item">
                    <i class="ph ph-check-circle text-emerald-400 text-sm flex-shrink-0"></i>
                    <input type="text"
                           class="deliverable-input flex-1 bg-transparent text-sm text-zinc-300 border-none outline-none placeholder-zinc-600"
                           value="${escapeHtml(deliverable)}"
                           placeholder="Nazwa rezultatu..."
                           onchange="updateDeliverable('${milestone.id}', ${index}, this.value)"
                           oninput="updateDeliverable('${milestone.id}', ${index}, this.value)">
                    <button onclick="removeDeliverable('${milestone.id}', ${index})"
                            class="opacity-0 group-hover/item:opacity-100 text-zinc-500 hover:text-red-400 transition-all">
                        <i class="ph ph-x text-xs"></i>
                    </button>
                </div>
            `).join('');
        }

        function renderMilestoneDeliverables(milestoneId) {
            const milestone = milestones.find(m => m.id === milestoneId);
            if (!milestone) return;

            const container = document.querySelector(`.deliverables-list[data-milestone-id="${milestoneId}"]`);
            if (container) {
                container.innerHTML = renderDeliverables(milestone);
            }
        }

        function renderTasks(milestone) {
            if (milestone.tasks.length === 0) {
                return '<p class="text-zinc-600 text-xs">Brak zadań</p>';
            }

            return milestone.tasks.map(task => {
                let responsibleColor, responsibleIcon, responsibleLabel;
                if (task.responsible === 'client') {
                    responsibleColor = 'cyan';
                    responsibleIcon = 'ph-user';
                    responsibleLabel = 'Klient';
                } else if (task.responsible === 'shared') {
                    responsibleColor = 'amber';
                    responsibleIcon = 'ph-handshake';
                    responsibleLabel = 'Wspólnie';
                } else {
                    // Default: team
                    responsibleColor = 'violet';
                    responsibleIcon = 'ph-users-three';
                    responsibleLabel = 'TN';
                }

                return `
                <div class="task-item flex items-center gap-2 group/item transition-all"
                     draggable="true"
                     data-task-id="${task.id}"
                     data-milestone-id="${milestone.id}">
                    <div class="task-drag-handle cursor-grab text-zinc-700 hover:text-zinc-500 active:cursor-grabbing opacity-0 group-hover/item:opacity-100 transition-opacity">
                        <i class="ph ph-dots-six-vertical text-xs"></i>
                    </div>
                    <button onclick="toggleTaskResponsible('${milestone.id}', '${task.id}')"
                            class="flex items-center gap-1 px-1.5 py-0.5 rounded text-[10px] font-medium bg-${responsibleColor}-500/10 text-${responsibleColor}-400 border border-${responsibleColor}-500/20 hover:bg-${responsibleColor}-500/20 transition-colors flex-shrink-0"
                            title="Kliknij, aby zmienić wykonawcę">
                        <i class="ph ${responsibleIcon} text-[10px]"></i>
                        ${responsibleLabel}
                    </button>
                    <input type="text"
                           class="task-input flex-1 bg-transparent text-sm text-zinc-300 border-none outline-none placeholder-zinc-600"
                           value="${escapeHtml(task.title)}"
                           placeholder="Nazwa zadania..."
                           onchange="updateTask('${milestone.id}', '${task.id}', this.value)"
                           oninput="updateTask('${milestone.id}', '${task.id}', this.value)">
                    <button onclick="removeTask('${milestone.id}', '${task.id}')"
                            class="opacity-0 group-hover/item:opacity-100 text-zinc-500 hover:text-red-400 transition-all">
                        <i class="ph ph-x text-xs"></i>
                    </button>
                </div>
            `}).join('');
        }

        function renderMilestoneTasks(milestoneId) {
            const milestone = milestones.find(m => m.id === milestoneId);
            if (!milestone) return;

            const container = document.querySelector(`.tasks-list[data-milestone-id="${milestoneId}"]`);
            if (container) {
                container.innerHTML = renderTasks(milestone);
                // Re-initialize drag & drop for new task elements
                container.querySelectorAll('.task-item').forEach(item => {
                    item.addEventListener('dragstart', handleTaskDragStart);
                    item.addEventListener('dragend', handleTaskDragEnd);
                    item.addEventListener('dragover', handleTaskDragOver);
                    item.addEventListener('dragleave', handleTaskDragLeave);
                    item.addEventListener('drop', handleTaskDrop);
                });
            }
        }

        // Drag and drop
        function initDragDrop() {
            document.querySelectorAll('.milestone-card').forEach(card => {
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragend', handleDragEnd);
                card.addEventListener('dragover', handleDragOver);
                card.addEventListener('dragleave', handleDragLeave);
                card.addEventListener('drop', handleDrop);
            });
        }

        function handleDragStart(e) {
            draggedMilestone = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('.milestone-card').forEach(card => {
                card.classList.remove('drag-over');
            });
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            if (this !== draggedMilestone) {
                this.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            this.classList.remove('drag-over');

            if (draggedMilestone === this) return;

            const draggedId = draggedMilestone.dataset.milestoneId;
            const targetId = this.dataset.milestoneId;

            const draggedIndex = milestones.findIndex(m => m.id === draggedId);
            const targetIndex = milestones.findIndex(m => m.id === targetId);

            const [removed] = milestones.splice(draggedIndex, 1);
            milestones.splice(targetIndex, 0, removed);

            reorderMilestones();
            renderMilestones();
            renderTimelinePreview();
            triggerAutoSave();
        }

        // Task drag and drop
        let draggedTask = null;
        let draggedTaskMilestoneId = null;

        function initTaskDragDrop() {
            document.querySelectorAll('.task-item').forEach(item => {
                item.addEventListener('dragstart', handleTaskDragStart);
                item.addEventListener('dragend', handleTaskDragEnd);
                item.addEventListener('dragover', handleTaskDragOver);
                item.addEventListener('dragleave', handleTaskDragLeave);
                item.addEventListener('drop', handleTaskDrop);
            });
        }

        function handleTaskDragStart(e) {
            e.stopPropagation();
            draggedTask = this;
            draggedTaskMilestoneId = this.dataset.milestoneId;
            this.style.opacity = '0.5';
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', this.dataset.taskId);
        }

        function handleTaskDragEnd(e) {
            this.style.opacity = '1';
            document.querySelectorAll('.task-item').forEach(item => {
                item.classList.remove('task-drag-over');
            });
            draggedTask = null;
            draggedTaskMilestoneId = null;
        }

        function handleTaskDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            e.dataTransfer.dropEffect = 'move';
            if (this !== draggedTask && this.dataset.milestoneId === draggedTaskMilestoneId) {
                this.classList.add('task-drag-over');
            }
        }

        function handleTaskDragLeave(e) {
            this.classList.remove('task-drag-over');
        }

        function handleTaskDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            this.classList.remove('task-drag-over');

            if (draggedTask === this) return;
            if (this.dataset.milestoneId !== draggedTaskMilestoneId) return;

            const milestoneId = this.dataset.milestoneId;
            const milestone = milestones.find(m => m.id === milestoneId);
            if (!milestone) return;

            const draggedTaskId = draggedTask.dataset.taskId;
            const targetTaskId = this.dataset.taskId;

            const draggedIndex = milestone.tasks.findIndex(t => t.id === draggedTaskId);
            const targetIndex = milestone.tasks.findIndex(t => t.id === targetTaskId);

            if (draggedIndex === -1 || targetIndex === -1) return;

            const [removed] = milestone.tasks.splice(draggedIndex, 1);
            milestone.tasks.splice(targetIndex, 0, removed);

            renderMilestoneTasks(milestoneId);
            initTaskDragDrop();
            triggerAutoSave();
        }

        window.initTaskDragDrop = initTaskDragDrop;

        // Timeline preview
        function renderTimelinePreview() {
            const container = document.getElementById('timeline-preview');

            // Calculate totals
            const totalTeamTasks = milestones.reduce((sum, m) => sum + m.tasks.filter(t => !t.responsible || t.responsible === 'team').length, 0);
            const totalClientTasks = milestones.reduce((sum, m) => sum + m.tasks.filter(t => t.responsible === 'client').length, 0);
            const totalSharedTasks = milestones.reduce((sum, m) => sum + m.tasks.filter(t => t.responsible === 'shared').length, 0);

            // Update summary stats
            document.getElementById('total-milestones').textContent = milestones.length;
            document.getElementById('total-team-tasks').textContent = totalTeamTasks;
            document.getElementById('total-client-tasks').textContent = totalClientTasks;
            document.getElementById('total-shared-tasks').textContent = totalSharedTasks;

            if (milestones.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-zinc-600">
                        <i class="ph ph-chart-line text-2xl mb-2"></i>
                        <p class="text-xs">Dodaj etapy, aby zobaczyć harmonogram</p>
                    </div>
                `;
                document.getElementById('total-days').textContent = '0';
                return;
            }

            let currentDay = 1;
            const timelineHtml = milestones.map((milestone, index) => {
                const startDay = currentDay;
                const endDay = currentDay + milestone.duration_days - 1;
                currentDay = endDay + 1;

                const deliverableCount = milestone.deliverables.filter(d => d.trim()).length;
                const teamTasks = milestone.tasks.filter(t => !t.responsible || t.responsible === 'team').length;
                const clientTasks = milestone.tasks.filter(t => t.responsible === 'client').length;
                const sharedTasks = milestone.tasks.filter(t => t.responsible === 'shared').length;

                return `
                    <div class="relative">
                        <div class="absolute -left-8 top-0 w-6 h-6 rounded-full bg-amber-500/20 border-2 border-amber-500 flex items-center justify-center">
                            <span class="text-[10px] text-amber-400 font-bold">${index + 1}</span>
                        </div>

                        <div class="text-sm text-white font-medium">${escapeHtml(milestone.title) || 'Bez nazwy'}</div>
                        <div class="flex items-center gap-2 text-[10px] text-zinc-500 font-mono mt-0.5">
                            <i class="ph ph-clock"></i>
                            <span>${milestone.duration_days} dni</span>
                            <span class="text-zinc-700">|</span>
                            <span>Dzień ${startDay} - ${endDay}</span>
                        </div>
                        ${deliverableCount > 0 || teamTasks > 0 || clientTasks > 0 || sharedTasks > 0 ? `
                            <div class="flex flex-wrap gap-1 mt-2">
                                ${deliverableCount > 0 ? `
                                    <span class="text-[9px] px-1.5 py-0.5 bg-emerald-500/10 text-emerald-400 rounded border border-emerald-500/20">
                                        ${deliverableCount} rezultatów
                                    </span>
                                ` : ''}
                                ${teamTasks > 0 ? `
                                    <span class="text-[9px] px-1.5 py-0.5 bg-violet-500/10 text-violet-400 rounded border border-violet-500/20 flex items-center gap-0.5">
                                        <i class="ph ph-users-three text-[8px]"></i>
                                        ${teamTasks}
                                    </span>
                                ` : ''}
                                ${clientTasks > 0 ? `
                                    <span class="text-[9px] px-1.5 py-0.5 bg-cyan-500/10 text-cyan-400 rounded border border-cyan-500/20 flex items-center gap-0.5">
                                        <i class="ph ph-user text-[8px]"></i>
                                        ${clientTasks}
                                    </span>
                                ` : ''}
                                ${sharedTasks > 0 ? `
                                    <span class="text-[9px] px-1.5 py-0.5 bg-amber-500/10 text-amber-400 rounded border border-amber-500/20 flex items-center gap-0.5">
                                        <i class="ph ph-handshake text-[8px]"></i>
                                        ${sharedTasks}
                                    </span>
                                ` : ''}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');

            container.innerHTML = `
                <div class="absolute left-3 top-0 bottom-0 w-0.5 timeline-line"></div>
                <div class="space-y-4 pl-8">
                    ${timelineHtml}
                </div>
            `;

            const totalDays = milestones.reduce((sum, m) => sum + m.duration_days, 0);
            document.getElementById('total-days').textContent = totalDays;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        // ==========================================
        // DISCOUNT CODES MANAGEMENT
        // ==========================================

        let offerDiscountCodes = [];

        function formatPrice(price) {
            return parseFloat(price || 0).toFixed(2);
        }

        async function loadOfferDiscountCodes() {
            if (!offer) return;

            const { data, error } = await supabaseClient
                .from('discount_codes')
                .select('*')
                .eq('offer_id', offer.id)
                .eq('is_active', true)
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error loading discount codes:', error);
                return;
            }

            offerDiscountCodes = data || [];
            document.getElementById('discount-codes-count').textContent = offerDiscountCodes.length;
            updateCodesCount();

            // Render codes if any
            const container = document.getElementById('offer-discount-codes');
            const list = document.getElementById('offer-codes-list');

            if (offerDiscountCodes.length > 0) {
                container.classList.remove('hidden');
                list.innerHTML = offerDiscountCodes.slice(0, 2).map(code => `
                    <div class="flex items-center justify-between p-2 bg-zinc-900/60 rounded-lg border border-white/5">
                        <div class="flex items-center gap-2">
                            <span class="font-mono text-sm text-emerald-400 bg-emerald-500/10 px-2 py-0.5 rounded">${code.code}</span>
                            <span class="text-xs text-zinc-500">-${formatPrice(code.discount_amount)} PLN</span>
                            ${code.uses_limit ? `<span class="text-[10px] text-zinc-600">(${code.uses_count || 0}/${code.uses_limit})</span>` : ''}
                        </div>
                        <div class="flex items-center gap-1">
                            <button onclick="copyCheckoutWithCode('${code.code}')" class="text-zinc-500 hover:text-emerald-400 p-1 rounded hover:bg-emerald-500/10 transition-colors" title="Kopiuj link do checkout z kodem">
                                <i class="ph ph-link text-sm"></i>
                            </button>
                            <button onclick="copyDiscountCode('${code.code}')" class="text-zinc-500 hover:text-white p-1 rounded hover:bg-white/5 transition-colors" title="Kopiuj kod">
                                <i class="ph ph-copy text-sm"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            } else {
                container.classList.add('hidden');
            }
        }

        function copyDiscountCode(code) {
            navigator.clipboard.writeText(code);
            showToast('Kod skopiowany');
        }

        function copyCheckoutWithCode(code) {
            if (!offer) return;
            const isLocal = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
            const base = isLocal ? getBasePath() : '';
            const checkoutPath = isLocal ? `${base}/checkout/index.html` : '/checkout';
            const url = `${location.origin}${checkoutPath}?offer=${offer.id}&code=${code}`;
            navigator.clipboard.writeText(url);
            showToast('Link z kodem skopiowany');
        }

        function quickAddDiscountCode() {
            if (!offer) return;

            // Reset form
            document.getElementById('dc-code').value = '';
            document.getElementById('dc-original-price').value = offer.price || 0;
            document.getElementById('dc-target-price').value = '';
            document.getElementById('dc-limit').value = '';
            document.getElementById('dc-description').value = '';
            document.getElementById('dc-discount-preview').classList.add('hidden');

            // Generate a random code
            generateDiscountCode();

            // Show modal
            document.getElementById('discount-code-modal').classList.remove('hidden');
            document.getElementById('dc-target-price').focus();
        }

        function closeDiscountCodeModal() {
            document.getElementById('discount-code-modal').classList.add('hidden');
        }

        function generateDiscountCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 8; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            document.getElementById('dc-code').value = code;
        }

        function updateDiscountPreview() {
            const original = parseFloat(document.getElementById('dc-original-price').value) || 0;
            const target = parseFloat(document.getElementById('dc-target-price').value) || 0;
            const preview = document.getElementById('dc-discount-preview');
            const previewText = document.getElementById('dc-preview-discount');

            if (original > 0 && target > 0 && original > target) {
                const discount = original - target;
                const percent = ((discount / original) * 100).toFixed(0);
                previewText.textContent = `-${discount.toFixed(0)} PLN (${percent}%)`;
                preview.classList.remove('hidden');
            } else {
                preview.classList.add('hidden');
            }
        }

        // Add event listener for discount preview
        document.getElementById('dc-target-price')?.addEventListener('input', updateDiscountPreview);

        async function saveDiscountCode() {
            if (!offer) return;

            const code = document.getElementById('dc-code').value.toUpperCase().trim();
            const originalPrice = document.getElementById('dc-original-price').value;
            const targetPrice = document.getElementById('dc-target-price').value;
            const limit = document.getElementById('dc-limit').value;
            const description = document.getElementById('dc-description').value.trim();

            if (!code || !targetPrice) {
                alert('Wypełnij wymagane pola: kod i cena po rabacie');
                return;
            }

            const data = {
                code,
                offer_id: offer.id,
                original_price: originalPrice ? parseFloat(originalPrice) : null,
                target_price: parseFloat(targetPrice),
                uses_limit: limit ? parseInt(limit) : null,
                description: description || null,
                is_active: true
            };

            try {
                const { error } = await supabaseClient
                    .from('discount_codes')
                    .insert(data);

                if (error) throw error;

                closeDiscountCodeModal();
                await loadOfferDiscountCodes();
                showToast('Kod rabatowy utworzony');

                // Log audit
                await logAuditActivity(
                    'create',
                    'discount_code',
                    null,
                    code,
                    null,
                    data,
                    { offer_id: offer.id, offer_name: offer.name }
                );
            } catch (err) {
                console.error('Error saving discount code:', err);
                alert('Błąd zapisywania kodu: ' + err.message);
            }
        }

        // Make discount code functions globally available
        window.quickAddDiscountCode = quickAddDiscountCode;
        window.closeDiscountCodeModal = closeDiscountCodeModal;
        window.generateDiscountCode = generateDiscountCode;
        window.saveDiscountCode = saveDiscountCode;
        window.copyDiscountCode = copyDiscountCode;
        window.copyCheckoutWithCode = copyCheckoutWithCode;

        // Event listeners
        document.getElementById('add-milestone-btn').addEventListener('click', addMilestone);

        // Make functions globally available
        window.addMilestone = addMilestone;
        window.deleteMilestone = deleteMilestone;
        window.addDeliverable = addDeliverable;
        window.removeDeliverable = removeDeliverable;
        window.updateDeliverable = updateDeliverable;
        window.addTask = addTask;
        window.removeTask = removeTask;
        window.updateTask = updateTask;
        window.toggleTaskComplete = toggleTaskComplete;
        window.toggleTaskResponsible = toggleTaskResponsible;
        window.updateMilestoneField = updateMilestoneField;

        // Fix links for local development
        if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
            const base = getBasePath();
            document.querySelectorAll('a[data-page]').forEach(link => {
                link.href = base + '/' + link.dataset.page + '.html';
            });
            // Fix back link
            const backLink = document.querySelector('a[href="/offers"]');
            if (backLink) backLink.href = base + '/offers.html';
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 's' && (e.ctrlKey || e.metaKey)) {
                e.preventDefault();
                if (hasChanges) autoSave();
            }
            if (e.key === 'Escape') {
                closeDiscountCodeModal();
            }
        });

        // Warn before leaving with unsaved changes
        window.addEventListener('beforeunload', (e) => {
            if (hasChanges) {
                e.preventDefault();
                e.returnValue = '';
            }
        });

        // Tab switching
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.submenu-tab[data-tab]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tabName);
            });

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            const activeTab = document.getElementById('tab-' + tabName);
            if (activeTab) {
                activeTab.classList.add('active');
            }

            // Initialize codes iframe on first switch
            if (tabName === 'codes') {
                const iframe = document.getElementById('codes-iframe');
                if (iframe && !iframe.src && offer) {
                    const isLocal = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
                    const base = isLocal ? getBasePath() : '';
                    const iframePath = isLocal ? `${base}/discount-codes.html` : '/discount-codes';
                    iframe.src = `${iframePath}?offer=${offer.id}`;
                }
            }
        }

        function updateCodesCount() {
            const countEl = document.getElementById('submenu-codes-count');
            if (countEl && offerDiscountCodes) {
                countEl.textContent = offerDiscountCodes.length;
            }
        }

        // Init
        async function init() {
            const session = await checkAuth();
            if (session) await loadOffer();
        }
        init();

        // Register service worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').catch(() => {});
        }
    </script>
</body>
</html>
