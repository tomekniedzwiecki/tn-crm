<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TN CRM - Pipeline</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    }
                }
            }
        }
    </script>
    <style>
        body { background: #050505; color: #e5e5e5; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::selection { background: white; color: black; }

        .glass-header {
            background: rgba(5, 5, 5, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-enter { animation: fadeIn 0.4s ease-out forwards; }

        .pipeline-column {
            min-width: 280px;
            max-width: 280px;
        }

        .lead-card {
            cursor: grab;
            transition: all 0.2s;
        }
        .lead-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px -5px rgba(0,0,0,0.5);
        }
        .lead-card:active {
            cursor: grabbing;
        }
        .lead-card.dragging {
            opacity: 0.5;
            transform: rotate(3deg);
        }

        .column-drop-zone {
            min-height: 100px;
            transition: all 0.2s;
        }
        .column-drop-zone.drag-over {
            background: rgba(255,255,255,0.05);
            border-color: rgba(255,255,255,0.2);
        }
    </style>
</head>
<body class="h-screen flex overflow-hidden font-sans text-[13px] tracking-tight antialiased">

    <!-- Sidebar -->
    <aside class="w-[260px] bg-zinc-950 border-r border-white/5 flex flex-col flex-shrink-0">
        <div class="h-14 flex items-center px-4 hover:bg-white/5 transition-colors cursor-pointer border-b border-white/5">
            <div class="w-5 h-5 bg-white text-black rounded flex items-center justify-center mr-3 shadow-[0_0_15px_rgba(255,255,255,0.1)]">
                <i class="ph-bold ph-lightning text-xs"></i>
            </div>
            <span class="font-medium text-sm text-zinc-200">TN CRM</span>
            <i class="ph-bold ph-caret-up-down ml-auto text-zinc-500"></i>
        </div>

        <nav class="flex-1 px-3 py-6">
            <div class="text-[10px] uppercase tracking-wider text-zinc-500 font-semibold px-2 mb-2">Workspace</div>

            <a href="/dashboard" data-page="dashboard" class="flex items-center gap-3 px-2 py-1.5 text-zinc-400 hover:text-zinc-100 hover:bg-white/5 rounded-md transition-all mb-0.5">
                <i class="ph ph-house text-lg"></i>
                <span class="font-medium">Overview</span>
            </a>

            <a href="/leads" data-page="leads" class="flex items-center gap-3 px-2 py-1.5 text-zinc-400 hover:text-zinc-100 hover:bg-white/5 rounded-md transition-all mb-0.5">
                <i class="ph ph-users text-lg"></i>
                <span class="font-medium">Leady</span>
                <span id="nav-leads-count" class="ml-auto text-[10px] bg-zinc-800 text-zinc-400 px-1.5 rounded-sm font-mono border border-white/5">0</span>
            </a>

            <a href="/pipeline" data-page="pipeline" class="flex items-center gap-3 px-2 py-1.5 bg-white/10 text-white rounded-md border border-white/5 shadow-sm mb-0.5">
                <i class="ph ph-kanban text-lg"></i>
                <span class="font-medium">Pipeline</span>
            </a>

            <a href="#" class="flex items-center gap-3 px-2 py-1.5 text-zinc-400 hover:text-zinc-100 hover:bg-white/5 rounded-md transition-all">
                <i class="ph ph-gear text-lg"></i>
                <span class="font-medium">Ustawienia</span>
            </a>
        </nav>

        <div class="p-3 border-t border-white/5">
            <div class="flex items-center gap-3 p-2 hover:bg-white/5 rounded-md transition-colors cursor-pointer">
                <div class="w-7 h-7 rounded-full bg-gradient-to-b from-zinc-700 to-zinc-800 border border-white/10 flex items-center justify-center text-xs font-medium">TN</div>
                <div class="flex-1 min-w-0">
                    <div id="user-email" class="text-xs font-medium text-zinc-200 truncate"></div>
                    <div class="text-[10px] text-zinc-500 truncate">Free Plan</div>
                </div>
                <button id="logout-btn" class="p-1 text-zinc-500 hover:text-white transition-colors" title="Wyloguj">
                    <i class="ph ph-sign-out text-base"></i>
                </button>
            </div>
        </div>
    </aside>

    <!-- Main -->
    <main class="flex-1 flex flex-col bg-black relative min-w-0">
        <!-- Header -->
        <header class="h-14 glass-header flex items-center justify-between px-6 sticky top-0 z-30">
            <div class="flex items-center gap-4">
                <h1 class="text-white font-semibold">Pipeline</h1>
                <div class="flex items-center gap-2 text-xs">
                    <span id="total-value" class="text-zinc-400 font-mono bg-zinc-900 px-2 py-1 rounded border border-white/5">0 PLN</span>
                    <span class="text-zinc-600">•</span>
                    <span id="total-deals" class="text-zinc-500">0 leadów</span>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <button id="add-test-leads-btn" class="text-zinc-400 hover:text-white border border-zinc-800 hover:border-zinc-600 px-3 py-1.5 rounded text-xs font-medium transition-all flex items-center gap-2">
                    <i class="ph ph-flask"></i>
                    Testowe
                </button>
                <button id="add-lead-btn" class="bg-white text-black hover:bg-zinc-200 px-3 py-1.5 rounded font-medium text-xs transition-colors shadow-[0_0_15px_rgba(255,255,255,0.1)] flex items-center gap-1.5">
                    <i class="ph ph-plus"></i>
                    Dodaj Lead
                </button>
            </div>
        </header>

        <!-- Pipeline Board -->
        <div class="flex-1 overflow-x-auto overflow-y-hidden p-6">
            <div id="pipeline-board" class="flex gap-4 h-full animate-enter">
                <!-- Columns will be inserted here -->
            </div>
        </div>
    </main>

    <!-- Add Lead Modal -->
    <div id="add-lead-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-zinc-950 border border-white/10 rounded-lg w-full max-w-lg shadow-2xl">
            <div class="flex items-center justify-between px-5 py-4 border-b border-white/5">
                <h2 class="text-sm font-medium text-white flex items-center gap-2">
                    <i class="ph ph-user-plus text-emerald-400"></i>
                    Dodaj nowy lead
                </h2>
                <button id="close-add-modal" class="text-zinc-500 hover:text-white transition-colors">
                    <i class="ph ph-x text-lg"></i>
                </button>
            </div>

            <form id="add-lead-form" class="p-5 space-y-4">
                <div>
                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Email *</label>
                    <input type="email" id="add-email" required class="w-full text-sm text-white bg-zinc-900 border border-zinc-800 px-3 py-2.5 rounded-lg outline-none focus:border-zinc-600" placeholder="email@example.com">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Imię i nazwisko</label>
                        <input type="text" id="add-name" class="w-full text-sm text-white bg-zinc-900 border border-zinc-800 px-3 py-2.5 rounded-lg outline-none focus:border-zinc-600" placeholder="Jan Kowalski">
                    </div>
                    <div>
                        <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Firma</label>
                        <input type="text" id="add-company" class="w-full text-sm text-white bg-zinc-900 border border-zinc-800 px-3 py-2.5 rounded-lg outline-none focus:border-zinc-600" placeholder="Nazwa firmy">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Telefon</label>
                        <input type="tel" id="add-phone" class="w-full text-sm text-white bg-zinc-900 border border-zinc-800 px-3 py-2.5 rounded-lg outline-none focus:border-zinc-600" placeholder="+48 ...">
                    </div>
                    <div>
                        <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Etap</label>
                        <select id="add-status" class="w-full text-sm text-white bg-zinc-900 border border-zinc-800 px-3 py-2.5 rounded-lg outline-none focus:border-zinc-600">
                            <option value="new">Nowy</option>
                            <option value="contacted">Skontaktowany</option>
                            <option value="qualified">Zakwalifikowany</option>
                            <option value="proposal">Propozycja</option>
                            <option value="negotiation">Negocjacje</option>
                            <option value="won">Wygrany</option>
                            <option value="lost">Przegrany</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Wartość (PLN)</label>
                        <input type="number" id="add-value" class="w-full text-sm text-white bg-zinc-900 border border-zinc-800 px-3 py-2.5 rounded-lg outline-none focus:border-zinc-600" placeholder="0">
                    </div>
                    <div>
                        <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Planowane zamknięcie</label>
                        <input type="date" id="add-expected-close" class="w-full text-sm text-white bg-zinc-900 border border-zinc-800 px-3 py-2.5 rounded-lg outline-none focus:border-zinc-600">
                    </div>
                </div>
            </form>

            <div class="flex gap-3 px-5 py-4 border-t border-white/5 bg-zinc-900/50">
                <div class="flex-1"></div>
                <button id="cancel-add-modal" class="text-zinc-400 hover:text-white border border-zinc-700 hover:border-zinc-600 px-4 py-2 rounded-lg text-sm transition-colors">
                    Anuluj
                </button>
                <button id="submit-add-lead" class="bg-emerald-500 text-white hover:bg-emerald-600 px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
                    <i class="ph ph-plus"></i>
                    Dodaj lead
                </button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://yxmavwkwnfuphjqbelws.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl4bWF2d2t3bmZ1cGhqcWJlbHdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NjQyNTUsImV4cCI6MjA4NDM0MDI1NX0.XeR0Fc7OFn6YbNJrOKTBEj36JtmLISZTM87y4ai9340';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let leads = [];

        // Pipeline stages configuration
        const STAGES = [
            { id: 'new', name: 'Nowy', color: 'emerald', icon: 'ph-user-plus' },
            { id: 'contacted', name: 'Skontaktowany', color: 'blue', icon: 'ph-chat-circle' },
            { id: 'qualified', name: 'Zakwalifikowany', color: 'violet', icon: 'ph-check-circle' },
            { id: 'proposal', name: 'Propozycja', color: 'amber', icon: 'ph-file-text' },
            { id: 'negotiation', name: 'Negocjacje', color: 'orange', icon: 'ph-handshake' },
            { id: 'won', name: 'Wygrany', color: 'green', icon: 'ph-trophy' },
            { id: 'lost', name: 'Przegrany', color: 'red', icon: 'ph-x-circle' }
        ];

        function getBasePath() {
            if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
                const path = location.pathname;
                const match = path.match(/^(\/[^\/]+)\//);
                return match ? match[1] : '';
            }
            return '';
        }

        function getLoginPath() {
            const base = getBasePath();
            return (location.hostname === 'localhost' || location.hostname === '127.0.0.1') ? `${base}/index.html` : '/';
        }

        function getLeadPath(id) {
            const base = getBasePath();
            const basePath = (location.hostname === 'localhost' || location.hostname === '127.0.0.1') ? `${base}/lead.html` : '/lead';
            return `${basePath}?id=${id}`;
        }

        async function checkAuth() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
                window.location.href = getLoginPath();
                return null;
            }
            document.getElementById('user-email').textContent = session.user.email.split('@')[0];
            return session;
        }

        document.getElementById('logout-btn').addEventListener('click', async () => {
            await supabaseClient.auth.signOut();
            window.location.href = getLoginPath();
        });

        function formatCurrency(value) {
            if (!value) return '0 PLN';
            return new Intl.NumberFormat('pl-PL').format(value) + ' PLN';
        }

        function getStageColor(stageId) {
            const stage = STAGES.find(s => s.id === stageId);
            return stage ? stage.color : 'zinc';
        }

        function getAvatarGradient(email) {
            const colors = [
                'from-violet-500 to-purple-600',
                'from-blue-500 to-cyan-600',
                'from-emerald-500 to-green-600',
                'from-orange-500 to-amber-600',
                'from-pink-500 to-rose-600'
            ];
            const index = email.charCodeAt(0) % colors.length;
            return colors[index];
        }

        async function loadLeads() {
            const { data, error } = await supabaseClient
                .from('leads')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error loading leads:', error);
                return;
            }

            leads = data || [];
            document.getElementById('nav-leads-count').textContent = leads.length;
            renderPipeline();
        }

        function renderPipeline() {
            const board = document.getElementById('pipeline-board');

            // Calculate totals
            let totalValue = 0;
            leads.forEach(lead => {
                if (lead.deal_value) totalValue += parseFloat(lead.deal_value);
            });
            document.getElementById('total-value').textContent = formatCurrency(totalValue);
            document.getElementById('total-deals').textContent = `${leads.length} leadów`;

            // Render columns
            board.innerHTML = STAGES.map(stage => {
                const stageLeads = leads.filter(l => (l.status || 'new') === stage.id);
                const stageValue = stageLeads.reduce((sum, l) => sum + (parseFloat(l.deal_value) || 0), 0);

                const colorClasses = {
                    emerald: { border: 'border-emerald-500/20', bg: 'bg-emerald-500/10', text: 'text-emerald-400' },
                    blue: { border: 'border-blue-500/20', bg: 'bg-blue-500/10', text: 'text-blue-400' },
                    violet: { border: 'border-violet-500/20', bg: 'bg-violet-500/10', text: 'text-violet-400' },
                    amber: { border: 'border-amber-500/20', bg: 'bg-amber-500/10', text: 'text-amber-400' },
                    orange: { border: 'border-orange-500/20', bg: 'bg-orange-500/10', text: 'text-orange-400' },
                    green: { border: 'border-green-500/20', bg: 'bg-green-500/10', text: 'text-green-400' },
                    red: { border: 'border-red-500/20', bg: 'bg-red-500/10', text: 'text-red-400' },
                    zinc: { border: 'border-zinc-500/20', bg: 'bg-zinc-500/10', text: 'text-zinc-400' }
                };
                const colors = colorClasses[stage.color] || colorClasses.zinc;

                return `
                    <div class="pipeline-column flex flex-col" data-stage="${stage.id}">
                        <!-- Column Header -->
                        <div class="flex items-center justify-between mb-3 px-1">
                            <div class="flex items-center gap-2">
                                <div class="w-6 h-6 rounded-md ${colors.bg} flex items-center justify-center">
                                    <i class="ph ${stage.icon} ${colors.text} text-sm"></i>
                                </div>
                                <span class="font-medium text-white text-sm">${stage.name}</span>
                                <span class="text-[10px] ${colors.text} ${colors.bg} px-1.5 py-0.5 rounded font-mono">${stageLeads.length}</span>
                            </div>
                        </div>
                        <div class="text-[10px] text-zinc-500 font-mono mb-3 px-1">${formatCurrency(stageValue)}</div>

                        <!-- Cards Container -->
                        <div class="column-drop-zone flex-1 space-y-2 p-1 rounded-lg border border-transparent overflow-y-auto"
                             data-stage="${stage.id}"
                             ondragover="handleDragOver(event)"
                             ondragleave="handleDragLeave(event)"
                             ondrop="handleDrop(event)">
                            ${stageLeads.map(lead => renderLeadCard(lead, colors)).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderLeadCard(lead, colors) {
            const gradient = getAvatarGradient(lead.email);
            const initial = lead.email.charAt(0).toUpperCase();
            const displayName = lead.name || lead.email.split('@')[0];

            return `
                <div class="lead-card bg-zinc-900/60 border border-white/5 rounded-lg p-3 hover:border-white/10"
                     draggable="true"
                     data-id="${lead.id}"
                     ondragstart="handleDragStart(event)"
                     ondragend="handleDragEnd(event)"
                     onclick="openLead('${lead.id}')">
                    <div class="flex items-start gap-3 mb-2">
                        <div class="w-8 h-8 rounded-lg bg-gradient-to-br ${gradient} flex items-center justify-center text-white text-xs font-bold flex-shrink-0">
                            ${initial}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="font-medium text-white text-sm truncate">${displayName}</div>
                            ${lead.company ? `<div class="text-zinc-500 text-xs truncate">${lead.company}</div>` : ''}
                        </div>
                    </div>
                    ${lead.deal_value ? `
                        <div class="flex items-center gap-1.5 mt-2">
                            <div class="w-2 h-2 rounded-full bg-zinc-600"></div>
                            <span class="text-xs font-mono text-zinc-400">${formatCurrency(lead.deal_value)}</span>
                        </div>
                    ` : ''}
                    <div class="text-[10px] text-zinc-600 mt-2 font-mono truncate">${lead.email}</div>
                </div>
            `;
        }

        function openLead(id) {
            window.location.href = getLeadPath(id);
        }

        // Drag and Drop
        let draggedElement = null;
        let draggedLeadId = null;

        function handleDragStart(event) {
            draggedElement = event.target;
            draggedLeadId = event.target.dataset.id;
            event.target.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', draggedLeadId);
        }

        function handleDragEnd(event) {
            event.target.classList.remove('dragging');
            document.querySelectorAll('.column-drop-zone').forEach(zone => {
                zone.classList.remove('drag-over');
            });
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            event.currentTarget.classList.add('drag-over');
        }

        function handleDragLeave(event) {
            event.currentTarget.classList.remove('drag-over');
        }

        async function handleDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');

            const leadId = event.dataTransfer.getData('text/plain');
            const newStage = event.currentTarget.dataset.stage;

            if (!leadId || !newStage) return;

            // Update in database
            const { error } = await supabaseClient
                .from('leads')
                .update({ status: newStage })
                .eq('id', leadId);

            if (error) {
                console.error('Error updating lead status:', error);
                alert('Błąd aktualizacji statusu');
                return;
            }

            // Update local state and re-render
            const lead = leads.find(l => l.id === leadId);
            if (lead) {
                lead.status = newStage;
            }
            renderPipeline();
        }

        // Add test leads
        document.getElementById('add-test-leads-btn').addEventListener('click', async () => {
            const testLeads = [
                { email: 'jan.kowalski@techcorp.pl', name: 'Jan Kowalski', company: 'TechCorp', deal_value: 15000, status: 'new' },
                { email: 'anna.nowak@startup.io', name: 'Anna Nowak', company: 'Startup.io', deal_value: 8500, status: 'contacted' },
                { email: 'piotr.wisniewski@bigcompany.com', name: 'Piotr Wiśniewski', company: 'Big Company', deal_value: 45000, status: 'qualified' },
                { email: 'marta.zielinska@agency.pl', name: 'Marta Zielińska', company: 'Creative Agency', deal_value: 12000, status: 'proposal' },
                { email: 'tomasz.lewandowski@enterprise.eu', name: 'Tomasz Lewandowski', company: 'Enterprise EU', deal_value: 78000, status: 'negotiation' },
                { email: 'karolina.dabrowska@fintech.pl', name: 'Karolina Dąbrowska', company: 'FinTech Solutions', deal_value: 25000, status: 'new' },
            ];

            for (const lead of testLeads) {
                const { error } = await supabaseClient.from('leads').insert([lead]);
                if (error) {
                    console.error('Error adding test lead:', error);
                }
            }

            await loadLeads();
        });

        // Add Lead Modal
        function openAddModal() {
            document.getElementById('add-lead-modal').classList.remove('hidden');
            document.getElementById('add-email').focus();
        }

        function closeAddModal() {
            document.getElementById('add-lead-modal').classList.add('hidden');
            document.getElementById('add-lead-form').reset();
        }

        document.getElementById('add-lead-btn').addEventListener('click', openAddModal);
        document.getElementById('close-add-modal').addEventListener('click', closeAddModal);
        document.getElementById('cancel-add-modal').addEventListener('click', closeAddModal);

        document.getElementById('add-lead-modal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeAddModal();
        });

        document.getElementById('submit-add-lead').addEventListener('click', async () => {
            const email = document.getElementById('add-email').value.trim();
            if (!email) {
                alert('Email jest wymagany');
                return;
            }

            const leadData = {
                email: email,
                name: document.getElementById('add-name').value.trim() || null,
                company: document.getElementById('add-company').value.trim() || null,
                phone: document.getElementById('add-phone').value.trim() || null,
                status: document.getElementById('add-status').value,
                deal_value: document.getElementById('add-value').value ? parseFloat(document.getElementById('add-value').value) : null,
                expected_close: document.getElementById('add-expected-close').value || null,
                utm_source: 'manual'
            };

            const btn = document.getElementById('submit-add-lead');
            btn.disabled = true;
            btn.innerHTML = '<i class="ph ph-circle-notch animate-spin"></i> Zapisywanie...';

            const { error } = await supabaseClient.from('leads').insert([leadData]);

            btn.disabled = false;
            btn.innerHTML = '<i class="ph ph-plus"></i> Dodaj lead';

            if (error) {
                alert('Błąd: ' + error.message);
                return;
            }

            closeAddModal();
            await loadLeads();
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeAddModal();
        });

        // Fix links for local development
        if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
            const base = getBasePath();
            document.querySelectorAll('a[data-page]').forEach(link => {
                link.href = base + '/' + link.dataset.page + '.html';
            });
        }

        async function init() {
            const session = await checkAuth();
            if (session) await loadLeads();
        }
        init();
    </script>
</body>
</html>
