<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TN CRM - Pipeline</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#050505">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="components/shared-sidebar.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    }
                }
            }
        }
    </script>
    <style>
        body { background: #050505; color: #e5e5e5; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::selection { background: white; color: black; }

        .glass-header {
            background: rgba(5, 5, 5, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-enter { animation: fadeIn 0.4s ease-out forwards; }

        .pipeline-column {
            min-width: 320px;
            max-width: 320px;
        }

        .lead-card {
            cursor: grab;
            transition: all 0.2s;
            margin-bottom: 10px;
        }
        .lead-card:last-child {
            margin-bottom: 0;
        }
        .lead-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px -5px rgba(0,0,0,0.5);
        }
        .lead-card:active {
            cursor: grabbing;
        }
        .lead-card.dragging {
            opacity: 0.5;
            transform: rotate(3deg);
        }

        .column-drop-zone {
            min-height: 100px;
            transition: all 0.2s;
        }
        .column-drop-zone.drag-over {
            background: rgba(255,255,255,0.05);
            border-color: rgba(255,255,255,0.2);
        }

    </style>
</head>
<body class="h-screen flex overflow-hidden font-sans text-sm tracking-tight antialiased">

    <!-- Sidebar -->
    <aside id="sidebar" class="w-[280px] bg-zinc-950 border-r border-white/5 flex flex-col flex-shrink-0"></aside>

    <!-- Main -->
    <main class="flex-1 flex flex-col bg-black relative min-w-0">
        <!-- Header -->
        <header class="h-16 glass-header flex items-center justify-between px-4 md:px-6 sticky top-0 z-30">
            <div class="flex items-center gap-3 md:gap-4">
                <button onclick="Sidebar.toggle()" class="mobile-menu-btn hidden items-center justify-center w-9 h-9 rounded-lg hover:bg-white/5 text-zinc-400 hover:text-white transition-colors">
                    <i class="ph ph-list text-xl"></i>
                </button>
                <h1 class="text-white font-semibold">Pipeline</h1>
                <div class="flex items-center gap-2 text-xs">
                    <span id="total-value" class="text-zinc-400 font-mono bg-zinc-900 px-2 py-1 rounded border border-white/5">0 PLN</span>
                    <span class="text-zinc-600">•</span>
                    <span id="total-deals" class="text-zinc-500">0 leadów</span>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <button id="add-lead-btn" class="bg-white text-black hover:bg-zinc-200 px-4 py-2 rounded-lg font-medium text-sm transition-colors shadow-[0_0_15px_rgba(255,255,255,0.1)] flex items-center gap-1.5">
                    <i class="ph ph-plus"></i>
                    Dodaj Lead
                </button>
            </div>
        </header>

        <!-- Filters Bar -->
        <div class="px-6 py-3 border-b border-white/5 flex items-center gap-4 bg-zinc-950/50">
            <div class="relative">
                <i class="ph ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-zinc-600 text-xs"></i>
                <input type="text" id="filter-search" placeholder="Szukaj po nazwie, email, telefonie..." class="w-56 bg-zinc-900 border border-zinc-800 rounded-lg pl-8 pr-3 py-1.5 text-xs text-white placeholder:text-zinc-600 outline-none hover:border-zinc-700 focus:border-zinc-600">
            </div>
            <div class="w-px h-5 bg-zinc-800"></div>
            <div class="flex items-center gap-2 text-xs text-zinc-500">
                <i class="ph ph-funnel"></i>
                <span>Filtry:</span>
            </div>
            <div id="team-filter-container" class="hidden">
                <select id="filter-team" class="bg-zinc-900 border border-zinc-800 rounded-lg px-3 py-1.5 text-xs text-zinc-300 cursor-pointer outline-none hover:border-zinc-700 focus:border-zinc-600">
                    <option value="">Wszyscy handlowcy</option>
                </select>
            </div>
            <select id="filter-source" class="bg-zinc-900 border border-zinc-800 rounded-lg px-3 py-1.5 text-xs text-zinc-300 cursor-pointer outline-none hover:border-zinc-700 focus:border-zinc-600">
                <option value="">Wszystkie źródła</option>
                <option value="google">Google Ads</option>
                <option value="meta">Meta</option>
                <option value="tiktok">TikTok</option>
                <option value="email">Email</option>
                <option value="organic">Organic</option>
                <option value="manual">Manual</option>
            </select>
            <div class="flex items-center gap-2">
                <input type="number" id="filter-value-min" placeholder="Min PLN" class="w-24 bg-zinc-900 border border-zinc-800 rounded-lg px-3 py-1.5 text-xs text-white placeholder:text-zinc-600 outline-none hover:border-zinc-700 focus:border-zinc-600">
                <span class="text-zinc-600">-</span>
                <input type="number" id="filter-value-max" placeholder="Max PLN" class="w-24 bg-zinc-900 border border-zinc-800 rounded-lg px-3 py-1.5 text-xs text-white placeholder:text-zinc-600 outline-none hover:border-zinc-700 focus:border-zinc-600">
            </div>
            <button id="clear-pipeline-filters" class="text-zinc-500 hover:text-white px-2 py-1 text-xs transition-colors hidden">
                <i class="ph ph-x mr-1"></i> Wyczyść
            </button>

            <!-- Spacer -->
            <div class="flex-1"></div>

            <!-- Sort by date toggle -->
            <div class="flex items-center gap-2 text-xs text-zinc-500">
                <span>Sortuj:</span>
                <button id="sort-toggle" onclick="toggleSort()" class="flex items-center gap-1.5 bg-zinc-900 border border-zinc-800 rounded-lg px-3 py-1.5 text-zinc-300 hover:border-zinc-700 transition-colors">
                    <i id="sort-icon" class="ph ph-sort-ascending"></i>
                    <span id="sort-label">Najstarsze</span>
                </button>
            </div>

            <span class="text-zinc-700">|</span>

            <div class="text-xs text-zinc-500 font-mono">
                <span id="filtered-count">0</span> / <span id="all-count">0</span> leadów
            </div>
        </div>

        <!-- Pipeline Board -->
        <div class="flex-1 overflow-x-auto overflow-y-hidden p-6">
            <div id="pipeline-board" class="flex gap-4 h-full animate-enter">
                <!-- Columns will be inserted here -->
            </div>
        </div>
    </main>

    <!-- Add Lead Modal -->
    <div id="add-lead-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-zinc-950 border border-white/10 rounded-lg w-full max-w-lg shadow-2xl">
            <div class="flex items-center justify-between px-5 py-4 border-b border-white/5">
                <h2 class="text-sm font-medium text-white flex items-center gap-2">
                    <i class="ph ph-user-plus text-emerald-400"></i>
                    Dodaj nowy lead
                </h2>
                <button id="close-add-modal" class="text-zinc-500 hover:text-white transition-colors">
                    <i class="ph ph-x text-lg"></i>
                </button>
            </div>

            <form id="add-lead-form" class="p-5 space-y-4">
                <div>
                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Email *</label>
                    <input type="email" id="add-email" required class="w-full text-sm text-white bg-zinc-900 border border-zinc-800 px-3 py-3 rounded-lg outline-none focus:border-zinc-600" placeholder="email@example.com">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Imię i nazwisko</label>
                        <input type="text" id="add-name" class="w-full text-sm text-white bg-zinc-900 border border-zinc-800 px-3 py-3 rounded-lg outline-none focus:border-zinc-600" placeholder="Jan Kowalski">
                    </div>
                    <div>
                        <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Firma</label>
                        <input type="text" id="add-company" class="w-full text-sm text-white bg-zinc-900 border border-zinc-800 px-3 py-3 rounded-lg outline-none focus:border-zinc-600" placeholder="Nazwa firmy">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">NIP</label>
                        <input type="text" id="add-nip" class="w-full text-sm text-white bg-zinc-900 border border-zinc-800 px-3 py-3 rounded-lg outline-none focus:border-zinc-600" placeholder="0000000000">
                    </div>
                    <div>
                        <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Adres</label>
                        <input type="text" id="add-address" class="w-full text-sm text-white bg-zinc-900 border border-zinc-800 px-3 py-3 rounded-lg outline-none focus:border-zinc-600" placeholder="ul. Przykładowa 1">
                    </div>
                </div>
                <div>
                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Telefon</label>
                    <input type="tel" id="add-phone" class="w-full text-sm text-white bg-zinc-900 border border-zinc-800 px-3 py-3 rounded-lg outline-none focus:border-zinc-600" placeholder="+48 ...">
                </div>
                <!-- Offer -->
                <div>
                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">
                        <i class="ph ph-package text-amber-400 mr-1"></i>Zainteresowany ofertą
                    </label>
                    <select id="add-offer" class="w-full text-sm text-white bg-zinc-900 border border-zinc-800 px-3 py-3 rounded-lg outline-none focus:border-zinc-600">
                        <option value="">-- Wybierz ofertę --</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Wartość (PLN)</label>
                        <input type="number" id="add-value" class="w-full text-sm text-white bg-zinc-900 border border-zinc-800 px-3 py-3 rounded-lg outline-none focus:border-zinc-600" placeholder="0">
                    </div>
                    <div>
                        <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Planowane zamknięcie</label>
                        <input type="date" id="add-expected-close" class="w-full text-sm text-white bg-zinc-900 border border-zinc-800 px-3 py-3 rounded-lg outline-none focus:border-zinc-600">
                    </div>
                </div>
            </form>

            <div class="flex gap-3 px-5 py-4 border-t border-white/5 bg-zinc-900/50">
                <div class="flex-1"></div>
                <button id="cancel-add-modal" class="text-zinc-400 hover:text-white border border-zinc-700 hover:border-zinc-600 px-4 py-2 rounded-lg text-sm transition-colors">
                    Anuluj
                </button>
                <button id="submit-add-lead" class="bg-emerald-500 text-white hover:bg-emerald-600 px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
                    <i class="ph ph-plus"></i>
                    Dodaj lead
                </button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://yxmavwkwnfuphjqbelws.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl4bWF2d2t3bmZ1cGhqcWJlbHdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NjQyNTUsImV4cCI6MjA4NDM0MDI1NX0.XeR0Fc7OFn6YbNJrOKTBEj36JtmLISZTM87y4ai9340';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        Sidebar.render();
        Sidebar.setupLogout(supabaseClient);

        let leads = [];
        let offers = [];
        let offersMap = {};
        let teamMembers = [];
        let teamMembersMap = {};
        let currentMember = null; // Current logged-in team member
        let isAdmin = false;

        // Audit logging helper
        async function logAuditActivity(action_type, entity_type, entity_id, entity_identifier, old_value, new_value, metadata = {}) {
            if (!currentMember) return;

            try {
                await supabaseClient.from('audit_log').insert([{
                    action_type,
                    entity_type,
                    entity_id,
                    entity_identifier,
                    old_value,
                    new_value,
                    performed_by: currentMember.id,
                    performed_by_name: currentMember.name,
                    metadata: { ...metadata, source_page: window.location.pathname }
                }]);
            } catch (err) {
                console.error('Audit log error:', err);
            }
        }

        // Slack notification helper - fire and forget
        async function sendSlackNotification(type, data) {
            try {
                await fetch(`${SUPABASE_URL}/functions/v1/slack-notify`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify({ type, data })
                });
            } catch (err) {
                console.error('Slack notification error:', err);
            }
        }

        // Default pipeline stages (will be overwritten by settings)
        const DEFAULT_STAGES = [
            { id: 'new', name: 'Nowy', order: 0 },
            { id: 'contacted', name: 'Skontaktowany', order: 1 },
            { id: 'qualified', name: 'Zakwalifikowany', order: 2 },
            { id: 'proposal', name: 'Propozycja', order: 3 },
            { id: 'negotiation', name: 'Negocjacje', order: 4 }
        ];

        // Terminal stages (always present, can't be edited)
        const TERMINAL_STAGES = [
            { id: 'won', name: 'Wygrany', color: 'green', icon: 'ph-trophy' },
            { id: 'lost', name: 'Przegrany', color: 'red', icon: 'ph-x-circle' },
            { id: 'abandoned', name: 'Porzucony', color: 'zinc', icon: 'ph-prohibit' }
        ];

        // Stage colors by index
        const STAGE_COLORS = ['emerald', 'blue', 'violet', 'amber', 'orange', 'cyan', 'pink'];
        const STAGE_ICONS = ['ph-user-plus', 'ph-chat-circle', 'ph-check-circle', 'ph-file-text', 'ph-handshake', 'ph-star', 'ph-flag'];

        let pipelineStages = [...DEFAULT_STAGES];
        let STAGES = []; // Combined stages (pipeline + terminal)

        async function loadPipelineSettings() {
            const { data, error } = await supabaseClient
                .from('settings')
                .select('*')
                .eq('key', 'pipeline_stages')
                .single();

            if (!error && data?.value) {
                try {
                    pipelineStages = JSON.parse(data.value);
                } catch (e) {
                    console.error('Error parsing pipeline stages:', e);
                    pipelineStages = [...DEFAULT_STAGES];
                }
            }

            // Build STAGES array with colors and icons
            STAGES = pipelineStages.map((stage, index) => ({
                ...stage,
                color: STAGE_COLORS[index % STAGE_COLORS.length],
                icon: STAGE_ICONS[index % STAGE_ICONS.length]
            }));

            // Add terminal stages
            STAGES.push(...TERMINAL_STAGES);

            // Update status select in add modal
            updateStatusSelect();
        }

        function updateStatusSelect() {
            const select = document.getElementById('add-status');
            if (!select) return;

            select.innerHTML = pipelineStages.map(stage =>
                `<option value="${stage.id}">${stage.name}</option>`
            ).join('') + `
                <option value="won">Wygrany</option>
                <option value="lost">Przegrany</option>
            `;
        }

        function getCurrentFilters() {
            return {
                search: document.getElementById('filter-search')?.value?.trim() || '',
                team: document.getElementById('filter-team')?.value || '',
                source: document.getElementById('filter-source')?.value || '',
                minValue: document.getElementById('filter-value-min')?.value || '',
                maxValue: document.getElementById('filter-value-max')?.value || ''
            };
        }

        function getLeadPath(id) {
            const base = Sidebar.getBasePath();
            const basePath = (location.hostname === 'localhost' || location.hostname === '127.0.0.1') ? `${base}/lead.html` : '/lead';

            // Build URL with current filters
            const filters = getCurrentFilters();
            const params = new URLSearchParams({ id });

            if (filters.search) params.set('f_search', filters.search);
            if (filters.team) params.set('f_team', filters.team);
            if (filters.source) params.set('f_source', filters.source);
            if (filters.minValue) params.set('f_min', filters.minValue);
            if (filters.maxValue) params.set('f_max', filters.maxValue);

            return `${basePath}?${params.toString()}`;
        }

        async function checkAuth() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
                window.location.href = Sidebar.getLoginPath();
                return null;
            }
            Sidebar.setUserEmail(session.user.email.split('@')[0]);

            // Load team members and find current user
            await loadTeamMembers(session.user.id);

            return session;
        }

        async function loadTeamMembers(userId) {
            const { data, error } = await supabaseClient
                .from('team_members')
                .select('*');

            if (error) {
                console.error('Error loading team members:', error);
                return;
            }

            teamMembers = data || [];
            teamMembersMap = {};
            teamMembers.forEach(member => {
                teamMembersMap[member.id] = member;
            });

            // Find current user's team member record
            currentMember = teamMembers.find(m => m.user_id === userId);
            isAdmin = currentMember?.role === 'admin';

            // Update sidebar user info
            if (currentMember) {
                Sidebar.setUserName(currentMember.name);
                Sidebar.setUserColor(currentMember.color);
                Sidebar.setupProfileClick();
            }

            Sidebar.showAdminNav(isAdmin);

            // Show/hide admin-only elements
            updateAdminUI();
        }

        function updateAdminUI() {
            // Show team filter only for admins
            const teamFilterContainer = document.getElementById('team-filter-container');
            if (teamFilterContainer) {
                teamFilterContainer.classList.toggle('hidden', !isAdmin);
            }

            // Populate team filter
            const teamFilter = document.getElementById('filter-team');
            if (teamFilter && isAdmin) {
                teamFilter.innerHTML = '<option value="">Wszyscy handlowcy</option>';
                teamMembers.forEach(member => {
                    teamFilter.innerHTML += `<option value="${member.id}">${member.name}</option>`;
                });
            }
        }

        function getMemberInitials(memberId) {
            const member = teamMembersMap[memberId];
            if (!member) return '';
            return member.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
        }

        function getMemberColor(memberId) {
            const member = teamMembersMap[memberId];
            if (!member) return 'zinc';
            const colorMap = {
                'violet': 'bg-violet-500',
                'blue': 'bg-blue-500',
                'emerald': 'bg-emerald-500',
                'amber': 'bg-amber-500',
                'pink': 'bg-pink-500',
                'cyan': 'bg-cyan-500'
            };
            return colorMap[member.color] || 'bg-zinc-500';
        }

        function formatCurrency(value) {
            if (!value) return '0 PLN';
            return new Intl.NumberFormat('pl-PL').format(value) + ' PLN';
        }

        // Get lead value - from deal_value or offer price
        function getLeadValue(lead) {
            if (lead.deal_value) return parseFloat(lead.deal_value);
            if (lead.offer_id && offersMap[lead.offer_id]) {
                return parseFloat(offersMap[lead.offer_id].price) || 0;
            }
            return 0;
        }

        function getStageColor(stageId) {
            const stage = STAGES.find(s => s.id === stageId);
            return stage ? stage.color : 'zinc';
        }

        function getAvatarGradient(email) {
            const colors = [
                'from-violet-500 to-purple-600',
                'from-blue-500 to-cyan-600',
                'from-emerald-500 to-green-600',
                'from-orange-500 to-amber-600',
                'from-pink-500 to-rose-600'
            ];
            const index = email.charCodeAt(0) % colors.length;
            return colors[index];
        }

        function getSource(lead) {
            if (lead.gclid || lead.gbraid || lead.wbraid) return 'google';
            if (lead.fbclid) return 'meta';
            if (lead.ttclid) return 'tiktok';
            if (lead.utm_source === 'manual') return 'manual';
            if (lead.utm_source) {
                const src = lead.utm_source.toLowerCase();
                if (src.includes('google')) return 'google';
                if (src.includes('facebook') || src.includes('fb') || src.includes('meta')) return 'meta';
                if (src.includes('tiktok')) return 'tiktok';
                if (src.includes('mailerlite') || src.includes('email') || src.includes('newsletter')) return 'email';
            }
            if (lead.utm_medium === 'email') return 'email';
            return 'organic';
        }

        let filteredLeads = [];
        let sortDirection = 'asc'; // 'asc' = najstarsze na górze, 'desc' = najnowsze na górze

        function toggleSort() {
            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            const icon = document.getElementById('sort-icon');
            const label = document.getElementById('sort-label');
            if (sortDirection === 'asc') {
                icon.className = 'ph ph-sort-ascending';
                label.textContent = 'Najstarsze';
            } else {
                icon.className = 'ph ph-sort-descending';
                label.textContent = 'Najnowsze';
            }
            renderPipeline();
        }

        function getLeadStatusDate(lead) {
            // Get the date when lead entered current status
            const activities = lead.activities || [];
            const statusChanges = activities
                .filter(a => a.type === 'status_change')
                .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

            // If there's a status change, use that date, otherwise use created_at
            return statusChanges.length > 0
                ? new Date(statusChanges[0].created_at)
                : new Date(lead.created_at);
        }

        function applyFilters() {
            const searchTerm = document.getElementById('filter-search').value.trim().toLowerCase();
            const sourceFilter = document.getElementById('filter-source').value;
            const minValue = document.getElementById('filter-value-min').value;
            const maxValue = document.getElementById('filter-value-max').value;
            const teamFilter = document.getElementById('filter-team')?.value || '';

            filteredLeads = leads.filter(lead => {
                // Only show leads that have a pipeline status (not null)
                if (!lead.status) return false;

                // Search filter
                if (searchTerm) {
                    const name = (lead.name || '').toLowerCase();
                    const email = (lead.email || '').toLowerCase();
                    const phone = (lead.phone || '').replace(/\s/g, '').toLowerCase();
                    const searchNorm = searchTerm.replace(/\s/g, '');
                    if (!name.includes(searchTerm) && !email.includes(searchTerm) && !phone.includes(searchNorm)) return false;
                }

                // Team member filter (admin only)
                if (teamFilter && lead.assigned_to !== teamFilter) return false;

                // Source filter
                if (sourceFilter && getSource(lead) !== sourceFilter) return false;

                // Value range filter
                const dealValue = getLeadValue(lead);
                if (minValue && dealValue < parseFloat(minValue)) return false;
                if (maxValue && dealValue > parseFloat(maxValue)) return false;

                return true;
            });

            // Show/hide clear button
            const hasFilters = searchTerm || sourceFilter || minValue || maxValue || teamFilter;
            document.getElementById('clear-pipeline-filters').classList.toggle('hidden', !hasFilters);

            // Update counts
            document.getElementById('filtered-count').textContent = filteredLeads.length;
            document.getElementById('all-count').textContent = leads.length;

            renderPipeline();
        }

        // Filter event listeners
        document.getElementById('filter-search').addEventListener('input', applyFilters);
        document.getElementById('filter-source').addEventListener('change', applyFilters);
        document.getElementById('filter-value-min').addEventListener('input', applyFilters);
        document.getElementById('filter-value-max').addEventListener('input', applyFilters);
        document.getElementById('filter-team')?.addEventListener('change', applyFilters);
        document.getElementById('clear-pipeline-filters').addEventListener('click', () => {
            document.getElementById('filter-search').value = '';
            document.getElementById('filter-source').value = '';
            document.getElementById('filter-value-min').value = '';
            document.getElementById('filter-value-max').value = '';
            const teamFilter = document.getElementById('filter-team');
            if (teamFilter) teamFilter.value = '';
            applyFilters();
        });

        async function loadOffers() {
            const { data, error } = await supabaseClient
                .from('offers')
                .select('*');

            if (error) {
                console.error('Error loading offers:', error);
                return;
            }

            offers = data || [];
            offersMap = {};
            offers.forEach(offer => {
                offersMap[offer.id] = offer;
            });

            // Populate add-offer select
            const addOfferSelect = document.getElementById('add-offer');
            if (addOfferSelect) {
                const activeOffers = offers.filter(o => o.active);
                addOfferSelect.innerHTML = '<option value="">-- Wybierz ofertę --</option>' +
                    activeOffers.map(offer => `<option value="${offer.id}">${offer.name}</option>`).join('');
            }
        }

        // Auto-assign status='new' to leads with survey but no status
        async function autoAssignStatusForSurveyLeads(leadsData) {
            const leadsToUpdate = leadsData.filter(lead => lead.weekly_hours && !lead.status);

            for (const lead of leadsToUpdate) {
                const { error } = await supabaseClient
                    .from('leads')
                    .update({ status: 'new' })
                    .eq('id', lead.id);

                if (!error) {
                    lead.status = 'new'; // Update local state
                }
            }
        }

        async function loadLeads() {
            // Load offers first
            await loadOffers();

            const { data, error } = await supabaseClient
                .from('leads')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error loading leads:', error);
                return;
            }

            leads = data || [];

            // Auto-assign status for leads with survey but no status
            await autoAssignStatusForSurveyLeads(leads);

            document.getElementById('nav-leads-count').textContent = leads.filter(l => l.status === 'new' || !l.status).length;
            applyFilters(); // This will call renderPipeline
        }

        function renderPipeline() {
            const board = document.getElementById('pipeline-board');

            // Calculate totals for filtered leads
            let totalValue = 0;
            filteredLeads.forEach(lead => {
                totalValue += getLeadValue(lead);
            });
            document.getElementById('total-value').textContent = formatCurrency(totalValue);
            document.getElementById('total-deals').textContent = `${filteredLeads.length} leadów`;

            // Render columns
            board.innerHTML = STAGES.map(stage => {
                const stageLeads = filteredLeads
                    .filter(l => (l.status || 'new') === stage.id)
                    .sort((a, b) => {
                        const dateA = getLeadStatusDate(a);
                        const dateB = getLeadStatusDate(b);
                        return sortDirection === 'asc' ? dateA - dateB : dateB - dateA;
                    });
                const stageValue = stageLeads.reduce((sum, l) => sum + getLeadValue(l), 0);

                const colorClasses = {
                    emerald: { border: 'border-emerald-500/20', bg: 'bg-emerald-500/10', text: 'text-emerald-400' },
                    blue: { border: 'border-blue-500/20', bg: 'bg-blue-500/10', text: 'text-blue-400' },
                    violet: { border: 'border-violet-500/20', bg: 'bg-violet-500/10', text: 'text-violet-400' },
                    amber: { border: 'border-amber-500/20', bg: 'bg-amber-500/10', text: 'text-amber-400' },
                    orange: { border: 'border-orange-500/20', bg: 'bg-orange-500/10', text: 'text-orange-400' },
                    cyan: { border: 'border-cyan-500/20', bg: 'bg-cyan-500/10', text: 'text-cyan-400' },
                    pink: { border: 'border-pink-500/20', bg: 'bg-pink-500/10', text: 'text-pink-400' },
                    green: { border: 'border-green-500/20', bg: 'bg-green-500/10', text: 'text-green-400' },
                    red: { border: 'border-red-500/20', bg: 'bg-red-500/10', text: 'text-red-400' },
                    zinc: { border: 'border-zinc-500/20', bg: 'bg-zinc-500/10', text: 'text-zinc-400' }
                };
                const colors = colorClasses[stage.color] || colorClasses.zinc;

                return `
                    <div class="pipeline-column flex flex-col" data-stage="${stage.id}">
                        <!-- Column Header -->
                        <div class="flex items-center justify-between mb-3 px-1">
                            <div class="flex items-center gap-2">
                                <div class="w-6 h-6 rounded-md ${colors.bg} flex items-center justify-center">
                                    <i class="ph ${stage.icon} ${colors.text} text-sm"></i>
                                </div>
                                <span class="font-medium text-white text-sm">${stage.name}</span>
                                <span class="text-[10px] ${colors.text} ${colors.bg} px-1.5 py-0.5 rounded font-mono">${stageLeads.length}</span>
                            </div>
                        </div>
                        <div class="text-[10px] text-zinc-500 font-mono mb-3 px-1">${formatCurrency(stageValue)}</div>

                        <!-- Cards Container -->
                        <div class="column-drop-zone flex-1 p-1 rounded-lg border border-transparent overflow-y-auto"
                             data-stage="${stage.id}"
                             ondragover="handleColumnDragOver(event)"
                             ondragleave="handleColumnDragLeave(event)"
                             ondrop="handleDrop(event)">
                            ${stageLeads.map(lead => renderLeadCard(lead, colors)).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getDaysInStatus(lead) {
            const activities = lead.activities || [];
            // Find the last status_change activity
            const statusChanges = activities
                .filter(a => a.type === 'status_change')
                .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

            const lastChangeDate = statusChanges.length > 0
                ? new Date(statusChanges[0].created_at)
                : new Date(lead.created_at);

            const now = new Date();
            const diffMs = now - lastChangeDate;
            const days = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            return days;
        }

        function getDaysInStatusBadge(days) {
            let colorClasses, icon;
            if (days >= 5) {
                colorClasses = 'bg-red-500/20 text-red-400 border-red-500/30';
                icon = 'ph-warning';
            } else if (days >= 3) {
                colorClasses = 'bg-amber-500/20 text-amber-400 border-amber-500/30';
                icon = 'ph-clock';
            } else {
                colorClasses = 'bg-zinc-500/20 text-zinc-400 border-zinc-500/30';
                icon = 'ph-clock';
            }
            return `<div class="flex items-center gap-1 px-1.5 py-0.5 rounded border text-[10px] font-mono ${colorClasses}" title="Dni w tym statusie">
                <i class="ph ${icon} text-[10px]"></i>
                <span>${days}d</span>
            </div>`;
        }

        function renderLeadCard(lead, colors) {
            const gradient = getAvatarGradient(lead.email);
            const initial = lead.email.charAt(0).toUpperCase();
            const displayName = lead.name || lead.email.split('@')[0];
            const offer = lead.offer_id ? offersMap[lead.offer_id] : null;
            const assignedMember = lead.assigned_to ? teamMembersMap[lead.assigned_to] : null;
            const memberInitials = assignedMember ? getMemberInitials(lead.assigned_to) : '';
            const memberColor = assignedMember ? getMemberColor(lead.assigned_to) : '';
            const daysInStatus = getDaysInStatus(lead);

            return `
                <div class="lead-card group bg-zinc-900/60 border border-white/5 rounded-lg p-4 hover:border-white/10 relative"
                     draggable="true"
                     data-id="${lead.id}"
                     ondragstart="handleDragStart(event)"
                     ondragend="handleDragEnd(event)"
                     onclick="openLead('${lead.id}')">
                    <div class="flex items-start gap-3 mb-3">
                        <div class="w-10 h-10 rounded-lg bg-gradient-to-br ${gradient} flex items-center justify-center text-white text-sm font-bold flex-shrink-0">
                            ${initial}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="font-medium text-white text-base truncate">${displayName}</div>
                            ${lead.company ? `<div class="text-zinc-500 text-sm truncate">${lead.company}</div>` : ''}
                        </div>
                        <div class="absolute top-2 right-2 flex items-center gap-1">
                            ${assignedMember ? `
                                <div class="w-6 h-6 rounded-full ${memberColor} flex items-center justify-center text-white text-[10px] font-bold" title="${assignedMember.name}">
                                    ${memberInitials}
                                </div>
                            ` : ''}
                            <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button onclick="event.stopPropagation(); sendEmail('${lead.email}')" class="p-1 text-purple-400 hover:bg-purple-500/20 rounded transition-colors" title="Wyślij email">
                                    <i class="ph ph-envelope-simple text-xs"></i>
                                </button>
                                ${lead.phone ? `<button onclick="event.stopPropagation(); callPhone('${lead.phone.replace(/'/g, "\\'")}')" class="p-1 text-emerald-400 hover:bg-emerald-500/20 rounded transition-colors" title="Zadzwoń">
                                    <i class="ph ph-phone text-xs"></i>
                                </button>` : ''}
                                ${(lead.status === 'new' || !lead.status) ? `<button onclick="event.stopPropagation(); abandonLead('${lead.id}')" class="p-1 text-zinc-500 hover:text-zinc-300 hover:bg-zinc-500/20 rounded transition-colors" title="Porzuć">
                                    <i class="ph ph-prohibit text-xs"></i>
                                </button>` : ''}
                            </div>
                        </div>
                    </div>
                    ${offer ? `
                        <div class="flex items-center gap-2 mt-2">
                            <i class="ph ph-package text-amber-400 text-sm"></i>
                            <span class="text-sm text-amber-400/80 truncate">${offer.name}</span>
                        </div>
                    ` : ''}
                    ${getLeadValue(lead) > 0 ? `
                        <div class="flex items-center gap-2 mt-2">
                            <div class="w-2 h-2 rounded-full bg-zinc-600"></div>
                            <span class="text-sm font-mono text-zinc-400">${formatCurrency(getLeadValue(lead))}</span>
                        </div>
                    ` : ''}
                    <div class="flex items-center justify-between mt-3 gap-2">
                        <a href="/lead?id=${lead.id}" onclick="event.stopPropagation()" class="text-xs text-zinc-600 hover:text-blue-400 font-mono truncate block transition-colors">${lead.email}</a>
                        ${getDaysInStatusBadge(daysInStatus)}
                    </div>
                </div>
            `;
        }

        function openLead(id) {
            window.location.href = getLeadPath(id);
        }

        function sendEmail(email) {
            window.location.href = `mailto:${email}`;
        }

        function callPhone(phone) {
            window.location.href = `tel:${phone.replace(/\s/g, '')}`;
        }

        window.sendEmail = sendEmail;
        window.callPhone = callPhone;

        async function abandonLead(leadId) {
            if (!confirm('Czy na pewno chcesz porzucić tego leada?')) return;

            const lead = leads.find(l => l.id === leadId);
            if (!lead) return;

            const oldStatus = lead.status || 'new';

            // Add activity for status change
            const updatedActivities = [...(lead.activities || []), {
                type: 'status_change',
                content: `Status zmieniony: ${STATUS_LABELS[oldStatus]} → Porzucony`,
                created_at: new Date().toISOString(),
                performed_by: currentMember?.id || null,
                performed_by_name: currentMember?.name || null
            }];

            const { error } = await supabaseClient
                .from('leads')
                .update({ status: 'abandoned', activities: updatedActivities })
                .eq('id', leadId);

            if (error) {
                alert('Błąd: ' + error.message);
                return;
            }

            // Log audit
            logAuditActivity('status_change', 'lead', leadId, lead.email,
                { status: oldStatus },
                { status: 'abandoned' }
            );

            // Update local state
            lead.status = 'abandoned';
            lead.activities = updatedActivities;
            renderPipeline();
        }

        window.abandonLead = abandonLead;

        // Drag and Drop
        let draggedElement = null;
        let draggedLeadId = null;

        function handleDragStart(event) {
            draggedElement = event.target;
            draggedLeadId = event.target.dataset.id;
            event.target.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', draggedLeadId);
        }

        function handleDragEnd(event) {
            event.target.classList.remove('dragging');
            document.querySelectorAll('.column-drop-zone').forEach(zone => {
                zone.classList.remove('drag-over');
            });
        }

        function handleColumnDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            event.currentTarget.classList.add('drag-over');
        }

        function handleColumnDragLeave(event) {
            event.currentTarget.classList.remove('drag-over');
        }

        const STATUS_LABELS = {
            new: 'Nowy',
            contacted: 'Skontaktowany',
            qualified: 'Zakwalifikowany',
            proposal: 'Propozycja',
            negotiation: 'Negocjacje',
            won: 'Wygrany',
            lost: 'Przegrany',
            abandoned: 'Porzucony'
        };

        async function handleDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');

            const leadId = event.dataTransfer.getData('text/plain');
            const newStage = event.currentTarget.dataset.stage;

            if (!leadId || !newStage) return;

            const lead = leads.find(l => l.id === leadId);
            if (!lead) return;

            const oldStatus = lead.status || 'new';

            // If same stage, do nothing (no reordering within columns)
            if (oldStatus === newStage) return;

            // Prepare activity for status change
            const updatedActivities = [...(lead.activities || []), {
                type: 'status_change',
                content: `Status zmieniony: ${STATUS_LABELS[oldStatus]} → ${STATUS_LABELS[newStage]}`,
                created_at: new Date().toISOString(),
                performed_by: currentMember?.id || null,
                performed_by_name: currentMember?.name || null
            }];

            // Update in database
            const updateData = {
                status: newStage,
                activities: updatedActivities
            };

            const { error } = await supabaseClient
                .from('leads')
                .update(updateData)
                .eq('id', leadId);

            if (error) {
                console.error('Error updating lead:', error);
                alert('Błąd aktualizacji');
                return;
            }

            // Log status change
            logAuditActivity('status_change', 'lead', leadId, lead.email,
                { status: oldStatus },
                { status: newStage }
            );

            // Update local state and re-render
            lead.status = newStage;
            lead.activities = updatedActivities;
            renderPipeline();
        }

        // Add Lead Modal
        function openAddModal() {
            document.getElementById('add-lead-modal').classList.remove('hidden');
            document.getElementById('add-email').focus();
        }

        function closeAddModal() {
            document.getElementById('add-lead-modal').classList.add('hidden');
            document.getElementById('add-lead-form').reset();
        }

        document.getElementById('add-lead-btn').addEventListener('click', openAddModal);
        document.getElementById('close-add-modal').addEventListener('click', closeAddModal);
        document.getElementById('cancel-add-modal').addEventListener('click', closeAddModal);

        document.getElementById('add-lead-modal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeAddModal();
        });

        document.getElementById('submit-add-lead').addEventListener('click', async () => {
            const email = document.getElementById('add-email').value.trim();
            if (!email) {
                alert('Email jest wymagany');
                return;
            }

            const leadData = {
                email: email,
                name: document.getElementById('add-name').value.trim() || null,
                company: document.getElementById('add-company').value.trim() || null,
                nip: document.getElementById('add-nip').value.trim() || null,
                address: document.getElementById('add-address').value.trim() || null,
                phone: document.getElementById('add-phone').value.trim() || null,
                status: null, // Lead appears in pipeline only after survey is filled
                deal_value: document.getElementById('add-value').value ? parseFloat(document.getElementById('add-value').value) : null,
                expected_close: document.getElementById('add-expected-close').value || null,
                offer_id: document.getElementById('add-offer').value || null,
                utm_source: 'manual',
                assigned_to: currentMember?.id || null
            };

            const btn = document.getElementById('submit-add-lead');
            btn.disabled = true;
            btn.innerHTML = '<i class="ph ph-circle-notch animate-spin"></i> Zapisywanie...';

            const { data, error } = await supabaseClient.from('leads').insert([leadData]).select();

            btn.disabled = false;
            btn.innerHTML = '<i class="ph ph-plus"></i> Dodaj lead';

            if (error) {
                alert('Błąd: ' + error.message);
                return;
            }

            // Log lead creation
            if (data && data[0]) {
                logAuditActivity('create', 'lead', data[0].id, leadData.email, null, leadData);

                // Send Slack notification about new lead
                sendSlackNotification('new_lead', {
                    name: leadData.name,
                    email: leadData.email,
                    phone: leadData.phone,
                    company: leadData.company,
                    source: 'CRM (manual)',
                    deal_value: leadData.deal_value,
                    lead_id: data[0].id
                });
            }

            closeAddModal();
            await loadLeads();
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeAddModal();
        });

        async function init() {
            const session = await checkAuth();
            if (session) {
                await loadPipelineSettings();
                await loadLeads();
            }
        }
        init();

        // Register service worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').catch(() => {});
        }
    </script>
</body>
</html>
