<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TN CRM - Projekt</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#050505">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bcryptjs/2.4.3/bcrypt.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="../components/shared-sidebar.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    }
                }
            }
        }
    </script>
    <style>
        body { background: #000; color: #e5e5e5; }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        ::selection { background: white; color: black; }

        @media (max-width: 768px) {
            aside#sidebar { display: none !important; }
            .mobile-back-btn { display: flex !important; }
            .workflow-sidebar { display: none !important; }
        }
        @media (min-width: 769px) {
            .mobile-back-btn { display: none !important; }
        }

        .glass-header {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }

        .workflow-sidebar-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
            padding: 7px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 450;
            color: #888;
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all 0.15s ease;
            text-align: left;
            white-space: nowrap;
        }
        .workflow-sidebar-btn:hover {
            color: #fafafa;
            background: #111;
        }
        .workflow-sidebar-btn.active {
            color: #fafafa;
            background: #171717;
        }
        .workflow-sidebar-btn i {
            font-size: 15px;
            opacity: 0.6;
            width: 18px;
            text-align: center;
            flex-shrink: 0;
        }
        .workflow-sidebar-btn.active i { opacity: 1; }
        .workflow-sidebar-btn .ph-check-circle { opacity: 1 !important; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-enter { animation: fadeIn 0.4s ease-out forwards; }

        .progress-bar {
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
            transition: width 0.5s ease;
        }

        .milestone-card {
            transition: all 0.2s;
        }
        .milestone-card:hover {
            border-color: rgba(255,255,255,0.15);
        }
        .milestone-card.active {
            border-color: rgba(139, 92, 246, 0.5);
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.1);
        }
        .milestone-card.completed {
            border-color: rgba(34, 197, 94, 0.3);
        }

        .task-row {
            transition: all 0.15s;
        }
        .task-row:hover {
            background: rgba(255,255,255,0.02);
        }

        .task-checkbox {
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .task-checkbox:hover {
            border-color: rgba(255,255,255,0.4);
        }
        .task-checkbox.checked {
            background: #10b981;
            border-color: #10b981;
        }

        .responsible-badge {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 500;
            text-transform: uppercase;
        }
        .responsible-team { background: rgba(139, 92, 246, 0.2); color: #a78bfa; }
        .responsible-client { background: rgba(6, 182, 212, 0.2); color: #22d3ee; }
        .responsible-shared { background: rgba(245, 158, 11, 0.2); color: #fbbf24; }

        .input-field {
            background: #0a0a0a;
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.2s;
        }
        .input-field:focus {
            border-color: rgba(255,255,255,0.25);
            outline: none;
        }

        /* WhatsApp Voice Message Player */
        .whatsapp-voice-player {
            background: linear-gradient(135deg, #075e54 0%, #054d44 100%);
            border-radius: 16px;
            padding: 10px 14px;
            max-width: 340px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        .voice-main-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .voice-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            flex-shrink: 0;
            border: 2px solid rgba(255,255,255,0.2);
        }
        .voice-play-btn {
            width: 36px;
            height: 36px;
            background: rgba(255,255,255,0.15);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
            flex-shrink: 0;
        }
        .voice-play-btn:hover {
            background: rgba(255,255,255,0.25);
        }
        .voice-play-btn.playing {
            background: rgba(255,255,255,0.25);
        }
        .voice-content {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .voice-waveform-container {
            position: relative;
            height: 28px;
            cursor: pointer;
            user-select: none;
        }
        .voice-waveform {
            display: flex;
            align-items: center;
            gap: 2px;
            height: 100%;
        }
        .voice-bar {
            width: 3px;
            background: rgba(255,255,255,0.35);
            border-radius: 2px;
            transition: background 0.15s ease;
        }
        .voice-bar.played {
            background: rgba(255,255,255,0.95);
        }
        .voice-scrubber {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 10px;
            height: 10px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            opacity: 0;
            transition: opacity 0.2s ease;
            pointer-events: none;
            z-index: 10;
        }
        .voice-waveform-container:hover .voice-scrubber,
        .voice-waveform-container.seeking .voice-scrubber {
            opacity: 1;
        }
        .voice-time-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .voice-time {
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            color: rgba(255,255,255,0.6);
        }
    </style>
</head>
<body class="h-screen flex overflow-hidden font-sans text-sm tracking-tight antialiased" style="background:#000">

    <!-- Sidebar -->
    <aside id="sidebar" class="w-[280px] bg-zinc-950 border-r border-white/5 flex flex-col flex-shrink-0"></aside>

    <!-- Main -->
    <main class="flex-1 flex flex-col bg-black relative min-w-0">
        <!-- Header -->
        <header class="h-14 glass-header flex items-center justify-between px-4 md:px-6 sticky top-0 z-30">
            <div class="flex items-center gap-3">
                <a href="/tn-workflow/workflows" data-page="workflows" class="mobile-back-btn hidden items-center justify-center w-9 h-9 rounded-lg hover:bg-white/5 text-zinc-400 hover:text-white transition-colors">
                    <i class="ph ph-arrow-left text-xl"></i>
                </a>
                <div class="flex items-center gap-2 text-zinc-500">
                    <a href="/tn-workflow/workflows" data-page="workflows" class="text-zinc-400 hover:text-white transition-colors hidden sm:inline">projekty</a>
                    <span class="text-zinc-700 hidden sm:inline">/</span>
                    <span id="breadcrumb-name" class="text-white font-medium truncate max-w-[200px]">...</span>
                </div>
            </div>
        </header>

        <!-- Mobile Tab Bar -->
        <div class="flex md:hidden overflow-x-auto border-b border-white/5 px-3 gap-1" style="scrollbar-width:none;-ms-overflow-style:none;">
            <button onclick="switchTab('przeglad')" data-tab="przeglad" class="workflow-sidebar-btn active py-2.5 text-xs rounded-none border-b-2 border-transparent" style="border-radius:0">Przegląd</button>
            <button onclick="switchTab('etapy')" data-tab="etapy" class="workflow-sidebar-btn py-2.5 text-xs rounded-none" style="border-radius:0">Etapy</button>
            <button onclick="switchTab('dokumenty')" data-tab="dokumenty" class="workflow-sidebar-btn py-2.5 text-xs rounded-none" style="border-radius:0">Dokumenty</button>
            <button onclick="switchTab('produkty')" data-tab="produkty" class="workflow-sidebar-btn py-2.5 text-xs rounded-none" style="border-radius:0">Produkty</button>
            <button onclick="switchTab('raporty')" data-tab="raporty" class="workflow-sidebar-btn py-2.5 text-xs rounded-none" style="border-radius:0">Raporty</button>
            <button onclick="switchTab('branding')" data-tab="branding" class="workflow-sidebar-btn py-2.5 text-xs rounded-none" style="border-radius:0">Branding</button>
            <button onclick="switchTab('strona')" data-tab="strona" class="workflow-sidebar-btn py-2.5 text-xs rounded-none" style="border-radius:0">Strona</button>
            <button onclick="switchTab('historia')" data-tab="historia" class="workflow-sidebar-btn py-2.5 text-xs rounded-none" style="border-radius:0">Historia</button>
            <button onclick="switchTab('wiadomosci')" data-tab="wiadomosci" class="workflow-sidebar-btn py-2.5 text-xs rounded-none" style="border-radius:0">Wiadomości</button>
            <span class="text-[10px] text-zinc-600 px-2">|</span>
            <button onclick="switchTab('video')" data-tab="video" class="workflow-sidebar-btn py-2.5 text-xs rounded-none" style="border-radius:0">Video</button>
            <button onclick="switchTab('takedrop')" data-tab="takedrop" class="workflow-sidebar-btn py-2.5 text-xs rounded-none" style="border-radius:0">TakeDrop</button>
        </div>

        <!-- Content -->
        <div class="flex-1 flex overflow-hidden">
            <!-- Workflow Sidebar -->
            <div class="workflow-sidebar w-[200px] min-w-[200px] border-r border-white/5 bg-black py-4 px-2 overflow-y-auto flex-shrink-0 space-y-0.5">
                <button onclick="switchTab('przeglad')" data-tab="przeglad" class="workflow-sidebar-btn active">
                    <i class="ph ph-chart-line-up"></i>
                    Przegląd
                </button>
                <button onclick="switchTab('etapy')" data-tab="etapy" class="workflow-sidebar-btn">
                    <i class="ph ph-list-checks"></i>
                    Etapy
                </button>
                <button onclick="switchTab('dokumenty')" data-tab="dokumenty" class="workflow-sidebar-btn">
                    <i class="ph ph-file-text"></i>
                    Dokumenty
                    <span id="nav-check-dokumenty" class="ml-auto hidden"><i class="ph-fill ph-check-circle text-emerald-400 text-sm"></i></span>
                </button>
                <button onclick="switchTab('historia')" data-tab="historia" class="workflow-sidebar-btn">
                    <i class="ph ph-clock-counter-clockwise"></i>
                    Historia
                </button>
                <button onclick="switchTab('wiadomosci')" data-tab="wiadomosci" class="workflow-sidebar-btn">
                    <i class="ph ph-envelope"></i>
                    Wiadomości
                </button>

                <!-- Etap 1 - Produkt, Raporty, Branding, Strona -->
                <div id="stage-1-section" class="pt-4 mt-4 border-t border-white/5">
                    <button onclick="toggleStageSection(1)" class="flex items-center justify-between w-full px-3 mb-2 group cursor-pointer">
                        <span class="text-[10px] text-zinc-600 uppercase tracking-wider">Etap 1</span>
                        <i id="stage-1-chevron" class="ph ph-caret-down text-zinc-600 text-xs transition-transform"></i>
                    </button>
                    <div id="stage-1-content">
                        <button onclick="switchTab('produkty')" data-tab="produkty" class="workflow-sidebar-btn">
                            <i class="ph ph-package"></i>
                            Produkty
                            <span id="nav-check-produkty" class="ml-auto hidden"><i class="ph-fill ph-check-circle text-emerald-400 text-sm"></i></span>
                        </button>
                        <button onclick="switchTab('raporty')" data-tab="raporty" class="workflow-sidebar-btn">
                            <i class="ph ph-chart-bar"></i>
                            Raporty
                            <span id="nav-check-raporty" class="ml-auto hidden"><i class="ph-fill ph-check-circle text-emerald-400 text-sm"></i></span>
                        </button>
                        <button onclick="switchTab('branding')" data-tab="branding" class="workflow-sidebar-btn">
                            <i class="ph ph-paint-brush"></i>
                            Branding
                            <span id="nav-check-branding" class="ml-auto hidden"><i class="ph-fill ph-check-circle text-emerald-400 text-sm"></i></span>
                        </button>
                        <button onclick="switchTab('strona')" data-tab="strona" class="workflow-sidebar-btn">
                            <i class="ph ph-globe"></i>
                            Strona
                            <span id="nav-check-strona" class="ml-auto hidden"><i class="ph-fill ph-check-circle text-emerald-400 text-sm"></i></span>
                        </button>
                        <button onclick="switchTab('podsumowanie')" data-tab="podsumowanie" class="workflow-sidebar-btn">
                            <i class="ph ph-check-square"></i>
                            Podsumowanie
                            <span id="nav-check-podsumowanie" class="ml-auto hidden"><i id="nav-check-podsumowanie-icon" class="ph-fill ph-check-circle text-sm"></i></span>
                        </button>
                    </div>
                </div>

                <!-- Etap 2 - Video -->
                <div id="stage-2-section" class="pt-4 mt-4 border-t border-white/5">
                    <button onclick="toggleStageSection(2)" class="flex items-center justify-between w-full px-3 mb-2 group cursor-pointer">
                        <span class="text-[10px] text-zinc-600 uppercase tracking-wider">Etap 2</span>
                        <i id="stage-2-chevron" class="ph ph-caret-down text-zinc-600 text-xs transition-transform"></i>
                    </button>
                    <div id="stage-2-content">
                        <button onclick="switchTab('scenariusze')" data-tab="scenariusze" class="workflow-sidebar-btn">
                            <i class="ph ph-film-script"></i>
                            Scenariusze
                            <span id="nav-check-scenariusze" class="ml-auto hidden"><i id="nav-check-scenariusze-icon" class="ph-fill ph-check-circle text-sm"></i></span>
                        </button>
                        <button onclick="switchTab('profile')" data-tab="profile" class="workflow-sidebar-btn">
                            <i class="ph ph-user-circle"></i>
                            Profile
                            <span id="nav-check-profile" class="ml-auto hidden"><i id="nav-check-profile-icon" class="ph-fill ph-check-circle text-sm"></i></span>
                        </button>
                        <button onclick="switchTab('nagrania')" data-tab="nagrania" class="workflow-sidebar-btn">
                            <i class="ph ph-video"></i>
                            Nagrania
                            <span id="nav-check-nagrania" class="ml-auto"><span id="nav-check-nagrania-count" class="text-[10px] text-zinc-500"></span></span>
                        </button>
                    </div>
                </div>

                <!-- Etap 3 - TakeDrop -->
                <div id="stage-3-section" class="pt-4 mt-4 border-t border-white/5">
                    <button onclick="toggleStageSection(3)" class="flex items-center justify-between w-full px-3 mb-2 group cursor-pointer">
                        <span class="text-[10px] text-zinc-600 uppercase tracking-wider">Etap 3</span>
                        <i id="stage-3-chevron" class="ph ph-caret-down text-zinc-600 text-xs transition-transform"></i>
                    </button>
                    <div id="stage-3-content">
                        <button onclick="switchTab('takedrop')" data-tab="takedrop" class="workflow-sidebar-btn">
                            <i class="ph ph-storefront"></i>
                            Konto TakeDrop
                            <span id="nav-check-takedrop" class="ml-auto hidden"><i class="ph-fill ph-check-circle text-emerald-400 text-sm"></i></span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="flex-1 overflow-y-auto p-4 md:p-6 lg:p-8 min-w-0">
            <div class="max-w-4xl animate-enter">

                <!-- Loading State -->
                <div id="loading-state" class="py-16 text-center">
                    <div class="w-5 h-5 mx-auto mb-3 border-2 border-zinc-700 border-t-white rounded-full animate-spin"></div>
                    <p class="text-zinc-500 text-sm font-mono">Ładowanie...</p>
                </div>

                <!-- Main Content (hidden until loaded) -->
                <div id="main-content" class="hidden">

                    <!-- TAB: Przeglad (Overview) -->
                    <div id="tab-przeglad" class="workflow-panel">

                    <!-- Main Grid: Client + Progress -->
                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-5 mb-5">

                        <!-- Client Info Card -->
                        <div class="lg:col-span-8 bg-[#0a0a0a] border border-[#1a1a1a] rounded-xl p-6">
                            <div class="flex items-start justify-between mb-6">
                                <div class="flex items-center gap-4">
                                    <div id="client-logo-container" class="w-14 h-14 rounded-xl bg-gradient-to-br from-[#1a1a1a] to-[#0a0a0a] border border-[#262626] flex items-center justify-center overflow-hidden">
                                        <i class="ph ph-user text-2xl text-[#444]"></i>
                                    </div>
                                    <div>
                                        <h2 id="customer-name" class="text-[22px] font-semibold text-white tracking-tight">-</h2>
                                        <div class="flex items-center gap-2 mt-0.5">
                                            <p id="customer-email" class="text-[#666] text-[13px]">-</p>
                                            <span class="text-[#333]">•</span>
                                            <code id="workflow-id-display" class="text-[#555] text-[11px] font-mono bg-[#111] px-1.5 py-0.5 rounded">-</code>
                                            <button onclick="copyWorkflowId()" class="p-1 text-[#444] hover:text-white hover:bg-white/5 rounded transition-colors" title="Kopiuj ID">
                                                <i class="ph ph-copy text-[10px]"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <button onclick="toggleEditClientInfo()" id="edit-client-btn" class="w-8 h-8 text-[#444] hover:text-[#888] hover:bg-[#1a1a1a] transition-all duration-200 rounded-lg flex items-center justify-center" title="Edytuj">
                                    <i class="ph ph-pencil-simple"></i>
                                </button>
                            </div>

                            <!-- View mode -->
                            <div id="client-info-view" class="grid grid-cols-2 md:grid-cols-4 gap-6">
                                <div>
                                    <span class="text-[#555] text-[11px] font-medium uppercase tracking-wider block mb-1.5">Firma</span>
                                    <span id="customer-company" class="text-[#ccc] text-[14px]">-</span>
                                </div>
                                <div>
                                    <span class="text-[#555] text-[11px] font-medium uppercase tracking-wider block mb-1.5">Telefon</span>
                                    <span id="customer-phone" class="text-[#ccc] text-[14px] font-mono">-</span>
                                </div>
                                <div>
                                    <span class="text-[#555] text-[11px] font-medium uppercase tracking-wider block mb-1.5">Oferta</span>
                                    <span id="offer-name" class="text-[#ccc] text-[14px]">-</span>
                                </div>
                                <div>
                                    <span class="text-[#555] text-[11px] font-medium uppercase tracking-wider block mb-1.5">Kwota</span>
                                    <span id="amount" class="text-white text-[14px] font-mono font-semibold">-</span>
                                </div>
                            </div>

                            <!-- Actions Section -->
                            <div class="mt-6 pt-5 border-t border-[#1a1a1a]">
                                <div class="flex flex-wrap items-center gap-3">
                                    <div id="status-badge" class="h-7 px-3 rounded-full text-[11px] font-semibold uppercase tracking-wider flex items-center">Aktywny</div>
                                    <div class="flex-1"></div>
                                    <a id="crm-lead-link" href="#" target="_blank" class="hidden h-8 px-3 bg-transparent hover:bg-[#1a1a1a] border border-[#262626] text-[#666] hover:text-white text-[12px] font-medium rounded-lg transition-all duration-200 flex items-center gap-2">
                                        <i class="ph ph-address-book text-violet-400"></i>
                                        CRM
                                    </a>
                                    <button onclick="openClientPreview()" class="h-8 px-3 bg-transparent hover:bg-[#1a1a1a] border border-[#262626] text-[#666] hover:text-white text-[12px] font-medium rounded-lg transition-all duration-200 flex items-center gap-2">
                                        <i class="ph ph-eye"></i>
                                        Podgląd
                                    </button>
                                    <button onclick="copyClientLink()" class="h-8 px-3 bg-transparent hover:bg-[#1a1a1a] border border-[#262626] text-[#666] hover:text-white text-[12px] font-medium rounded-lg transition-all duration-200 flex items-center gap-2">
                                        <i class="ph ph-link"></i>
                                        Kopiuj link
                                    </button>
                                </div>
                            </div>

                            <!-- Edit mode (hidden by default) -->
                            <div id="client-info-edit" class="hidden">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-[#555] text-[11px] font-medium uppercase tracking-wider block mb-2">Imię i nazwisko</label>
                                        <input id="edit-customer-name" type="text" class="w-full h-10 bg-[#0a0a0a] border border-[#262626] rounded-lg px-3 text-white text-[14px] focus:outline-none focus:border-[#444] transition-colors">
                                    </div>
                                    <div>
                                        <label class="text-[#555] text-[11px] font-medium uppercase tracking-wider block mb-2">Email</label>
                                        <input id="edit-customer-email" type="email" class="w-full h-10 bg-[#0a0a0a] border border-[#262626] rounded-lg px-3 text-white text-[14px] focus:outline-none focus:border-[#444] transition-colors">
                                    </div>
                                    <div>
                                        <label class="text-[#555] text-[11px] font-medium uppercase tracking-wider block mb-2">Firma</label>
                                        <input id="edit-customer-company" type="text" class="w-full h-10 bg-[#0a0a0a] border border-[#262626] rounded-lg px-3 text-white text-[14px] focus:outline-none focus:border-[#444] transition-colors">
                                    </div>
                                    <div>
                                        <label class="text-[#555] text-[11px] font-medium uppercase tracking-wider block mb-2">Telefon</label>
                                        <input id="edit-customer-phone" type="text" class="w-full h-10 bg-[#0a0a0a] border border-[#262626] rounded-lg px-3 text-white text-[14px] focus:outline-none focus:border-[#444] transition-colors">
                                    </div>
                                </div>
                                <div class="flex items-center gap-3 mt-5 pt-5 border-t border-[#1a1a1a]">
                                    <button onclick="saveClientInfo()" class="h-9 px-4 bg-white hover:bg-[#e5e5e5] text-black text-[13px] font-medium rounded-lg transition-colors flex items-center gap-2">
                                        <i class="ph ph-check"></i>
                                        Zapisz zmiany
                                    </button>
                                    <button onclick="toggleEditClientInfo()" class="h-9 px-4 bg-transparent hover:bg-[#1a1a1a] border border-[#333] text-[#888] text-[13px] font-medium rounded-lg transition-colors">
                                        Anuluj
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Progress Card -->
                        <div class="lg:col-span-4 bg-[#0a0a0a] border border-[#1a1a1a] rounded-xl p-6 flex flex-col">
                            <div class="text-[#555] text-[11px] font-medium uppercase tracking-wider mb-4">Postęp projektu</div>

                            <div class="flex-1 flex flex-col items-center justify-center py-4">
                                <div id="progress-percent" class="text-[56px] font-bold text-white leading-none tracking-tight">0%</div>
                                <div class="text-[#555] text-[13px] mt-2 font-mono">
                                    <span id="completed-tasks">0</span> / <span id="total-tasks">0</span> zadań
                                </div>
                            </div>

                            <div class="h-1.5 bg-[#1a1a1a] rounded-full overflow-hidden">
                                <div id="progress-bar" class="h-full rounded-full bg-gradient-to-r from-emerald-500 to-emerald-400 transition-all duration-500" style="width: 0%"></div>
                            </div>

                            <div class="grid grid-cols-2 gap-4 mt-4 pt-4 border-t border-[#1a1a1a]">
                                <div>
                                    <div class="text-[#555] text-[10px] uppercase tracking-wider mb-1">Etap</div>
                                    <div id="current-milestone" class="text-[#ccc] text-[12px] truncate" title="">-</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-[#555] text-[10px] uppercase tracking-wider mb-1">Deadline</div>
                                    <div id="current-deadline" class="text-[#ccc] text-[12px]">-</div>
                                </div>
                            </div>

                            <!-- Last Admin Action -->
                            <div id="last-admin-action" class="mt-4 pt-4 border-t border-[#1a1a1a] hidden">
                                <div class="text-[#555] text-[10px] uppercase tracking-wider mb-2">Ostatnie działanie</div>
                                <div class="flex items-start gap-2">
                                    <i id="last-action-icon" class="ph ph-lightning text-amber-400 text-[12px] mt-0.5"></i>
                                    <div class="flex-1 min-w-0">
                                        <div id="last-action-text" class="text-[#ccc] text-[12px] truncate">-</div>
                                        <div id="last-action-time" class="text-[#555] text-[10px] mt-0.5">-</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Middle Row: Status + Engagement -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-5 mb-5">

                        <!-- Status Checklist -->
                        <div class="bg-[#0a0a0a] border border-[#1a1a1a] rounded-xl p-5">
                            <div class="text-[#555] text-[11px] font-medium uppercase tracking-wider mb-4">Status realizacji</div>
                            <div id="status-checklist" class="grid grid-cols-2 gap-2 auto-rows-fr">
                                <!-- Will be populated by JS -->
                            </div>
                        </div>

                        <!-- Client Engagement -->
                        <div class="bg-[#0a0a0a] border border-[#1a1a1a] rounded-xl p-6">
                            <div class="text-[#555] text-[11px] font-medium uppercase tracking-wider mb-5">Zaangażowanie klienta</div>
                            <div class="grid grid-cols-3 gap-0">
                                <div class="text-center py-4 cursor-pointer hover:bg-white/5 rounded-lg transition-colors" onclick="openVisitsModal()">
                                    <div id="access-count" class="text-[36px] font-bold text-white leading-none">0</div>
                                    <div class="text-[#555] text-[10px] mt-3 uppercase tracking-wider">Wizyty</div>
                                </div>
                                <div class="text-center py-4 border-x border-[#1a1a1a]">
                                    <div id="last-visit" class="text-[14px] font-medium text-[#888] leading-tight min-h-[36px] flex items-center justify-center">-</div>
                                    <div class="text-[#555] text-[10px] mt-3 uppercase tracking-wider">Ostatnia wizyta</div>
                                </div>
                                <div class="text-center py-3">
                                    <div id="client-messages-count" class="text-[36px] font-bold text-white leading-none min-h-[36px] flex items-center justify-center">0</div>
                                    <div class="text-[#555] text-[10px] mt-3 uppercase tracking-wider">Wiadomości</div>
                                </div>
                            </div>
                            <div class="mt-4 pt-4 border-t border-[#1a1a1a] flex items-center justify-center gap-2 text-[12px]">
                                <i class="ph ph-calendar text-[#444]"></i>
                                <span class="text-[#555]">Start projektu:</span>
                                <span id="started-at" class="text-[#888]">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Pending Actions -->
                    <div id="pending-actions-card" class="bg-[#0a0a0a] border border-amber-500/30 rounded-xl p-6 mb-5 hidden">
                        <div class="flex items-center gap-2 mb-4">
                            <div class="w-6 h-6 rounded-full bg-amber-500/10 flex items-center justify-center">
                                <i class="ph ph-warning text-amber-400 text-[12px]"></i>
                            </div>
                            <span class="text-amber-400 text-[11px] font-semibold uppercase tracking-wider">Wymaga uwagi</span>
                        </div>
                        <div id="pending-actions-list" class="space-y-2">
                            <!-- Will be populated by JS -->
                        </div>
                    </div>

                    <!-- Bottom Row: Activities + Messages + Comments -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-5">

                        <!-- Recent Activities -->
                        <div class="bg-[#0a0a0a] border border-[#1a1a1a] rounded-xl p-6">
                            <div class="flex items-center justify-between mb-5">
                                <span class="text-[#555] text-[11px] font-medium uppercase tracking-wider">Ostatnie działania</span>
                                <button onclick="switchTab('historia')" class="text-[12px] text-[#555] hover:text-[#999] transition-colors flex items-center gap-1">
                                    Wszystkie
                                    <i class="ph ph-arrow-right text-[10px]"></i>
                                </button>
                            </div>
                            <div id="activity-log" class="space-y-1">
                                <div class="text-[#444] text-[13px] py-2">Brak aktywności</div>
                            </div>
                        </div>

                        <!-- Recent Emails -->
                        <div class="bg-[#0a0a0a] border border-[#1a1a1a] rounded-xl p-6">
                            <div class="flex items-center justify-between mb-5">
                                <span class="text-[#555] text-[11px] font-medium uppercase tracking-wider">Wysłane wiadomości</span>
                                <button onclick="switchTab('wiadomosci')" class="text-[12px] text-[#555] hover:text-[#999] transition-colors flex items-center gap-1">
                                    Wszystkie
                                    <i class="ph ph-arrow-right text-[10px]"></i>
                                </button>
                            </div>
                            <div id="recent-emails" class="space-y-1">
                                <div class="text-[#444] text-[13px] py-2">Brak wysłanych wiadomości</div>
                            </div>
                        </div>

                        <!-- Recent Comments -->
                        <div class="bg-[#0a0a0a] border border-[#1a1a1a] rounded-xl p-6">
                            <div class="flex items-center justify-between mb-5">
                                <span class="text-[#555] text-[11px] font-medium uppercase tracking-wider">Ostatnie komentarze</span>
                                <button onclick="switchTab('komentarze')" class="text-[12px] text-[#555] hover:text-[#999] transition-colors flex items-center gap-1">
                                    Wszystkie
                                    <i class="ph ph-arrow-right text-[10px]"></i>
                                </button>
                            </div>
                            <div id="recent-comments" class="space-y-2 mb-4">
                                <div class="text-[#444] text-[13px] py-2">Brak komentarzy</div>
                            </div>
                            <div class="flex gap-2">
                                <input type="text" id="quick-comment" placeholder="Dodaj komentarz..."
                                    class="flex-1 h-9 bg-[#111] border border-[#262626] rounded-lg px-3 text-[13px] text-white placeholder-[#444] focus:outline-none focus:border-[#444] transition-colors"
                                    onkeydown="if(event.key==='Enter') postQuickComment()">
                                <button onclick="postQuickComment()" class="h-9 px-3 bg-[#1a1a1a] hover:bg-[#262626] border border-[#262626] text-[#888] hover:text-white rounded-lg transition-colors">
                                    <i class="ph ph-paper-plane-right text-[14px]"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    </div><!-- /tab-przeglad -->

                    <!-- TAB: Etapy (Milestones) -->
                    <div id="tab-etapy" class="workflow-panel hidden">
                        <div class="mb-8">
                            <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                                <i class="ph ph-path text-violet-400"></i>
                                Etapy realizacji
                            </h3>

                            <div id="milestones-container" class="space-y-4">
                                <!-- Milestones rendered here -->
                            </div>
                        </div>
                    </div><!-- /tab-etapy -->

                    <!-- TAB: Dokumenty (Documents & Contract) -->
                    <div id="tab-dokumenty" class="workflow-panel hidden">

                        <!-- Contract Status Overview -->
                        <div class="bg-zinc-900/40 border border-white/5 rounded-lg p-5 mb-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                                    <i class="ph ph-file-text text-emerald-400"></i>
                                    Status umowy
                                </h3>
                                <div id="contract-status-indicator" class="flex items-center gap-2 text-sm">
                                    <span class="w-2 h-2 rounded-full bg-amber-400"></span>
                                    <span class="text-amber-400">Oczekuje na dane</span>
                                </div>
                            </div>

                            <!-- Progress Steps -->
                            <div class="flex items-center gap-2 mb-6">
                                <div id="step-data" class="flex-1 flex items-center gap-2 p-3 rounded-lg bg-amber-500/10 border border-amber-500/20">
                                    <div class="w-6 h-6 rounded-full bg-amber-500/20 flex items-center justify-center text-amber-400 text-xs font-bold">1</div>
                                    <span class="text-xs text-amber-400 font-medium">Dane klienta</span>
                                </div>
                                <i class="ph ph-arrow-right text-zinc-600"></i>
                                <div id="step-contract" class="flex-1 flex items-center gap-2 p-3 rounded-lg bg-zinc-800/50 border border-white/5">
                                    <div class="w-6 h-6 rounded-full bg-zinc-700 flex items-center justify-center text-zinc-500 text-xs font-bold">2</div>
                                    <span class="text-xs text-zinc-500 font-medium">Generuj umowe</span>
                                </div>
                                <i class="ph ph-arrow-right text-zinc-600"></i>
                                <div id="step-signature" class="flex-1 flex items-center gap-2 p-3 rounded-lg bg-zinc-800/50 border border-white/5">
                                    <div class="w-6 h-6 rounded-full bg-zinc-700 flex items-center justify-center text-zinc-500 text-xs font-bold">3</div>
                                    <span class="text-xs text-zinc-500 font-medium">Podpis</span>
                                </div>
                            </div>
                        </div>

                        <!-- Client Data Filled Info (visible when client filled data) -->
                        <div id="client-data-filled-info" class="hidden bg-emerald-500/10 border border-emerald-500/20 rounded-lg p-5 mb-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-lg bg-emerald-500/20 flex items-center justify-center">
                                        <i class="ph-bold ph-check-circle text-emerald-400 text-xl"></i>
                                    </div>
                                    <div>
                                        <h3 class="text-white font-medium">Klient wypelnil dane</h3>
                                        <p id="client-data-filled-date" class="text-emerald-400/70 text-xs"></p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <button onclick="downloadContractPDF()" class="bg-white text-black hover:bg-zinc-200 px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
                                        <i class="ph ph-file-pdf"></i>
                                        Pobierz PDF
                                    </button>
                                    <button onclick="toggleContractEdit()" id="edit-contract-btn" class="bg-zinc-700 hover:bg-zinc-600 text-white px-3 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
                                        <i class="ph ph-pencil-simple"></i>
                                        Edytuj
                                    </button>
                                </div>
                            </div>

                            <!-- Readonly data display -->
                            <div id="contract-data-readonly" class="grid grid-cols-2 md:grid-cols-3 gap-3 text-sm">
                                <div class="bg-zinc-900/50 rounded-lg p-3">
                                    <span class="text-zinc-500 text-[10px] font-mono uppercase block mb-1">Imie i nazwisko</span>
                                    <span id="ro-name" class="text-white">-</span>
                                </div>
                                <div class="bg-zinc-900/50 rounded-lg p-3">
                                    <span class="text-zinc-500 text-[10px] font-mono uppercase block mb-1">Firma</span>
                                    <span id="ro-company" class="text-zinc-400">-</span>
                                </div>
                                <div class="bg-zinc-900/50 rounded-lg p-3">
                                    <span class="text-zinc-500 text-[10px] font-mono uppercase block mb-1">Email</span>
                                    <span id="ro-email" class="text-white">-</span>
                                </div>
                                <div class="bg-zinc-900/50 rounded-lg p-3">
                                    <span class="text-zinc-500 text-[10px] font-mono uppercase block mb-1">Telefon</span>
                                    <span id="ro-phone" class="text-white">-</span>
                                </div>
                                <div class="bg-zinc-900/50 rounded-lg p-3 md:col-span-2">
                                    <span class="text-zinc-500 text-[10px] font-mono uppercase block mb-1">Adres</span>
                                    <span id="ro-address" class="text-white">-</span>
                                </div>
                                <div class="bg-zinc-900/50 rounded-lg p-3">
                                    <span class="text-zinc-500 text-[10px] font-mono uppercase block mb-1">PESEL</span>
                                    <span id="ro-pesel" class="text-white font-mono">-</span>
                                </div>
                                <div class="bg-zinc-900/50 rounded-lg p-3">
                                    <span class="text-zinc-500 text-[10px] font-mono uppercase block mb-1">Nr dowodu</span>
                                    <span id="ro-id" class="text-white font-mono">-</span>
                                </div>
                                <div class="bg-zinc-900/50 rounded-lg p-3">
                                    <span class="text-zinc-500 text-[10px] font-mono uppercase block mb-1">NIP</span>
                                    <span id="ro-nip" class="text-zinc-400 font-mono">-</span>
                                </div>
                            </div>
                        </div>

                        <!-- Client Data Form (Admin can edit) -->
                        <div id="contract-data-form" class="bg-zinc-900/40 border border-white/5 rounded-lg p-5 mb-6">
                            <h3 class="text-sm font-medium text-white mb-4 flex items-center gap-2">
                                <i class="ph ph-user text-violet-400"></i>
                                Dane klienta do umowy
                            </h3>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Imie i nazwisko *</label>
                                    <input type="text" id="contract-name" class="input-field w-full text-sm text-white px-3 py-2.5 rounded-lg" placeholder="Jan Kowalski">
                                </div>
                                <div>
                                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Firma</label>
                                    <input type="text" id="contract-company" class="input-field w-full text-sm text-white px-3 py-2.5 rounded-lg" placeholder="Nazwa firmy (opcjonalnie)">
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Ulica *</label>
                                    <input type="text" id="contract-street" class="input-field w-full text-sm text-white px-3 py-2.5 rounded-lg" placeholder="ul. Przykładowa 123/45">
                                </div>
                                <div>
                                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Kod pocztowy *</label>
                                    <input type="text" id="contract-postal" class="input-field w-full text-sm text-white px-3 py-2.5 rounded-lg" placeholder="00-000">
                                </div>
                                <div>
                                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Miejscowosc *</label>
                                    <input type="text" id="contract-city" class="input-field w-full text-sm text-white px-3 py-2.5 rounded-lg" placeholder="Warszawa">
                                </div>
                                <div>
                                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Kraj</label>
                                    <input type="text" id="contract-country" class="input-field w-full text-sm text-white px-3 py-2.5 rounded-lg" value="Polska">
                                </div>
                                <div>
                                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">PESEL *</label>
                                    <input type="text" id="contract-pesel" class="input-field w-full text-sm text-white px-3 py-2.5 rounded-lg font-mono" placeholder="00000000000" maxlength="11">
                                </div>
                                <div>
                                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Nr dowodu osobistego *</label>
                                    <input type="text" id="contract-id-number" class="input-field w-full text-sm text-white px-3 py-2.5 rounded-lg font-mono" placeholder="ABC123456" maxlength="9">
                                </div>
                                <div>
                                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">NIP</label>
                                    <input type="text" id="contract-nip" class="input-field w-full text-sm text-white px-3 py-2.5 rounded-lg font-mono" placeholder="0000000000" maxlength="10">
                                </div>
                                <div>
                                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Email *</label>
                                    <input type="email" id="contract-email" class="input-field w-full text-sm text-white px-3 py-2.5 rounded-lg" placeholder="email@example.com">
                                </div>
                                <div>
                                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Telefon *</label>
                                    <input type="tel" id="contract-phone" class="input-field w-full text-sm text-white px-3 py-2.5 rounded-lg" placeholder="+48 600 000 000">
                                </div>
                            </div>

                            <div class="mt-4 flex items-center justify-between">
                                <span id="contract-data-status" class="text-xs text-zinc-500">
                                    <i class="ph ph-info"></i>
                                    Wypelnij wszystkie wymagane pola
                                </span>
                                <div class="flex items-center gap-2">
                                    <button onclick="cancelContractEdit()" id="cancel-edit-btn" class="hidden bg-zinc-700 hover:bg-zinc-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                        Anuluj
                                    </button>
                                    <button onclick="saveContractData()" class="bg-white text-black hover:bg-zinc-200 px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                        Zapisz dane
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Contract Generation (visible when data is filled) -->
                        <div id="contract-generation-section" class="hidden">
                            <div class="bg-zinc-900/40 border border-white/5 rounded-lg p-5 mb-6">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-sm font-medium text-white flex items-center gap-2">
                                        <i class="ph ph-file-doc text-cyan-400"></i>
                                        Umowa
                                    </h3>
                                    <div class="flex items-center gap-2">
                                        <button onclick="toggleContractCodeView()" id="toggle-code-btn" class="text-xs text-zinc-400 hover:text-white px-2 py-1 rounded transition-colors flex items-center gap-1">
                                            <i class="ph ph-code"></i>
                                            <span id="toggle-code-label">Edytuj HTML</span>
                                        </button>
                                    </div>
                                </div>

                                <div id="no-template-warning" class="hidden p-4 bg-amber-500/10 border border-amber-500/20 rounded-lg mb-4">
                                    <div class="flex items-center gap-2 text-amber-400 text-sm">
                                        <i class="ph ph-warning"></i>
                                        Brak szablonu umowy dla tej oferty. Dodaj szablon w edytorze oferty.
                                    </div>
                                </div>

                                <!-- Preview mode -->
                                <div id="contract-preview-mode" class="bg-zinc-950 border border-white/5 rounded-lg p-4 mb-4 max-h-[500px] overflow-y-auto">
                                    <pre id="contract-text" class="text-xs text-zinc-300 whitespace-pre-wrap font-mono leading-relaxed"></pre>
                                </div>

                                <!-- Code editor mode -->
                                <div id="contract-code-mode" class="hidden mb-4">
                                    <textarea id="contract-html-editor" class="w-full h-[500px] bg-zinc-950 border border-white/5 rounded-lg p-4 text-xs text-zinc-300 font-mono resize-none focus:outline-none focus:border-cyan-500/50" spellcheck="false"></textarea>
                                    <div class="mt-2 flex items-center gap-2">
                                        <button onclick="saveContractHtml()" class="bg-cyan-500/10 hover:bg-cyan-500/20 text-cyan-400 px-3 py-1.5 rounded text-xs font-medium transition-colors flex items-center gap-1">
                                            <i class="ph ph-floppy-disk"></i>
                                            Zapisz zmiany
                                        </button>
                                        <button onclick="resetContractHtml()" class="text-zinc-500 hover:text-zinc-300 px-3 py-1.5 rounded text-xs font-medium transition-colors">
                                            Przywroc oryginał
                                        </button>
                                        <span id="contract-save-status" class="text-xs text-zinc-500 ml-2"></span>
                                    </div>
                                </div>

                                <div class="flex items-center gap-3">
                                    <button onclick="generateContract()" class="bg-cyan-500/10 hover:bg-cyan-500/20 text-cyan-400 px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
                                        <i class="ph ph-arrows-clockwise"></i>
                                        Odswierz podglad
                                    </button>
                                    <button onclick="downloadContractPDF()" class="bg-white text-black hover:bg-zinc-200 px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
                                        <i class="ph ph-file-pdf"></i>
                                        Pobierz PDF
                                    </button>
                                </div>

                                <!-- Add signed contract section -->
                                <div class="mt-6 pt-6 border-t border-white/5">
                                    <h4 class="text-sm font-medium text-white mb-4 flex items-center gap-2">
                                        <i class="ph ph-signature text-emerald-400"></i>
                                        Dodaj podpisana umowe
                                    </h4>

                                    <div class="space-y-4">
                                        <!-- Upload fully signed contract -->
                                        <div class="p-4 bg-zinc-800/50 border border-white/5 rounded-lg">
                                            <label class="block text-zinc-400 text-sm mb-2">Wgraj w pelni podpisana umowe (Twoj + klienta podpis):</label>
                                            <input type="file" id="seller-signed-contract" accept=".pdf" class="text-sm text-zinc-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-zinc-700 file:text-white hover:file:bg-zinc-600">
                                            <p class="text-zinc-500 text-xs mt-2">Klient otrzyma email z informacja, ze umowa zostala podpisana i bedzie mogl ja pobrac.</p>
                                        </div>

                                        <!-- Uploaded file indicator -->
                                        <div id="seller-contract-uploaded" class="hidden p-3 bg-emerald-500/10 border border-emerald-500/20 rounded-lg">
                                            <div class="flex items-center gap-2 text-emerald-400 text-sm">
                                                <i class="ph ph-check-circle"></i>
                                                <span>Podpisana umowa zostala zapisana</span>
                                                <a id="seller-contract-link" href="#" target="_blank" class="ml-auto text-cyan-400 hover:text-cyan-300">
                                                    <i class="ph ph-download-simple"></i>
                                                </a>
                                            </div>
                                        </div>

                                        <button onclick="sendContractToClient()" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-3 rounded-lg text-sm font-medium transition-colors flex items-center justify-center gap-2">
                                            <i class="ph ph-check-circle"></i>
                                            Zapisz i powiadom klienta
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Signed Contract Info (visible when signed) -->
                        <div id="signed-section" class="hidden">
                            <div class="bg-emerald-500/10 border border-emerald-500/20 rounded-lg p-5">
                                <div class="flex items-center gap-3 mb-4">
                                    <div class="w-10 h-10 rounded-full bg-emerald-500/20 flex items-center justify-center">
                                        <i class="ph ph-check-circle text-emerald-400 text-xl"></i>
                                    </div>
                                    <div>
                                        <h3 class="text-white font-medium">Umowa podpisana</h3>
                                        <p id="signed-date" class="text-emerald-400 text-sm">-</p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-4 text-sm">
                                    <span class="text-zinc-400">Typ podpisu:</span>
                                    <span id="signed-type" class="text-white">-</span>
                                </div>
                                <div class="mt-4">
                                    <a id="signed-file-link" href="#" target="_blank" class="text-cyan-400 hover:text-cyan-300 text-sm flex items-center gap-2">
                                        <i class="ph ph-file-pdf"></i>
                                        Pobierz podpisana umowe
                                    </a>
                                </div>
                            </div>
                        </div>

                    </div><!-- /tab-dokumenty -->

                    <!-- TAB: Branding -->
                    <div id="tab-branding" class="workflow-panel hidden">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                                <i class="ph ph-paint-brush text-pink-400"></i>
                                Branding
                            </h3>
                            <div class="flex items-center gap-3">
                                <button onclick="copyAIPrompt('branding')" class="text-xs text-zinc-400 hover:text-white flex items-center gap-1.5 px-2.5 py-1.5 rounded-md bg-zinc-800/50 hover:bg-zinc-700/50 border border-zinc-700/50 transition-colors" title="Kopiuj prompt AI">
                                    <i class="ph ph-robot"></i> Prompt
                                </button>
                                <span id="branding-delivered-badge" class="hidden text-xs text-emerald-400 flex items-center gap-1">
                                    <i class="ph ph-check-circle"></i> Przekazano klientowi
                                </span>
                                <button id="branding-deliver-btn" onclick="deliverBranding()" class="hidden bg-emerald-600 hover:bg-emerald-500 text-white text-xs px-4 py-2 rounded-lg transition-colors flex items-center gap-1.5">
                                    <i class="ph ph-paper-plane-tilt"></i> Przekaż klientowi
                                </button>
                            </div>
                        </div>

                        <!-- 1. Brand Info -->
                        <div class="mb-10">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="text-sm font-medium text-zinc-400 uppercase tracking-wider">Informacje o marce</h4>
                                <button onclick="openBrandInfoModal()" class="text-zinc-500 hover:text-white text-xs flex items-center gap-1 transition-colors">
                                    <i class="ph ph-pencil-simple"></i> Edytuj
                                </button>
                            </div>
                            <div id="branding-info" class="hidden">
                                <div class="bg-zinc-900/40 border border-white/5 rounded-lg p-6">
                                    <h2 id="brand-info-name" class="text-2xl font-bold text-white mb-1"></h2>
                                    <p id="brand-info-domain" class="hidden text-xs text-zinc-500 mb-2 font-mono"></p>
                                    <p id="brand-info-tagline" class="text-pink-400 text-sm font-medium mb-3"></p>
                                    <p id="brand-info-description" class="text-zinc-400 text-sm leading-relaxed"></p>
                                </div>
                            </div>
                            <div id="branding-info-empty" class="bg-zinc-900/40 border border-dashed border-zinc-700 rounded-lg p-8 text-center cursor-pointer hover:border-zinc-500 transition-colors" onclick="openBrandInfoModal()">
                                <i class="ph ph-buildings text-2xl text-zinc-600 mb-2"></i>
                                <p class="text-zinc-500 text-sm">Dodaj informacje o marce</p>
                                <p class="text-zinc-600 text-xs mt-1">Nazwa, tagline, opis</p>
                            </div>
                        </div>

                        <!-- 2. Logo Section -->
                        <div class="mb-10">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="text-sm font-medium text-zinc-400 uppercase tracking-wider">Logo</h4>
                            </div>
                            <!-- Logo AI Prompt - visible by default -->
                            <div id="logo-prompt-box" class="mb-4 bg-gradient-to-r from-pink-500/10 to-transparent border border-pink-500/20 rounded-lg p-3">
                                <div class="flex items-center justify-between gap-3">
                                    <div class="flex items-center gap-2 min-w-0">
                                        <i class="ph ph-magic-wand text-pink-400 text-sm shrink-0"></i>
                                        <span class="text-zinc-400 text-xs truncate">Prompt: Logo na jasnym tle</span>
                                    </div>
                                    <button onclick="copyLogoPrompt()" id="logo-prompt-copy-btn" class="shrink-0 text-xs text-pink-400 hover:text-pink-300 flex items-center gap-1.5 px-2.5 py-1 rounded bg-pink-500/10 hover:bg-pink-500/20 transition-colors">
                                        <i class="ph ph-copy" id="logo-prompt-copy-icon"></i>
                                        <span id="logo-prompt-copy-text">Kopiuj</span>
                                    </button>
                                </div>
                            </div>
                            <!-- Logo grid - items + dropzone rendered by JS -->
                            <div id="branding-logos-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <!-- Logos + dropzone rendered here -->
                            </div>
                        </div>

                        <!-- 3. Colors Section -->
                        <div class="mb-10">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="text-sm font-medium text-zinc-400 uppercase tracking-wider">Paleta kolorów</h4>
                                <button onclick="openColorModal()" class="text-zinc-500 hover:text-white text-xs flex items-center gap-1 transition-colors">
                                    <i class="ph ph-plus"></i> Dodaj kolor
                                </button>
                            </div>
                            <div id="branding-colors" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                <!-- Colors rendered here -->
                            </div>
                            <div id="branding-colors-empty" class="bg-zinc-900/40 border border-dashed border-zinc-700 rounded-lg p-8 text-center cursor-pointer hover:border-zinc-500 transition-colors" onclick="openColorModal()">
                                <div class="flex justify-center gap-2 mb-3">
                                    <div class="w-6 h-6 rounded-full bg-zinc-800 border border-zinc-700"></div>
                                    <div class="w-6 h-6 rounded-full bg-zinc-800 border border-zinc-700"></div>
                                    <div class="w-6 h-6 rounded-full bg-zinc-800 border border-zinc-700"></div>
                                </div>
                                <p class="text-zinc-500 text-sm">Brak kolorów</p>
                                <p class="text-zinc-600 text-xs mt-1">Zdefiniuj paletę kolorów marki</p>
                            </div>
                        </div>

                        <!-- 4. Fonts Section - HIDDEN for admin, visible only for client -->
                        <div class="mb-10 hidden" id="branding-fonts-section">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="text-sm font-medium text-zinc-400 uppercase tracking-wider">Typografia</h4>
                                <button onclick="openFontModal()" class="text-zinc-500 hover:text-white text-xs flex items-center gap-1 transition-colors">
                                    <i class="ph ph-plus"></i> Dodaj czcionkę
                                </button>
                            </div>
                            <div id="branding-fonts" class="space-y-4">
                                <!-- Fonts rendered here -->
                            </div>
                            <div id="branding-fonts-empty" class="bg-zinc-900/40 border border-dashed border-zinc-700 rounded-lg p-8 text-center cursor-pointer hover:border-zinc-500 transition-colors" onclick="openFontModal()">
                                <p class="text-zinc-700 text-3xl font-bold mb-1">Aa</p>
                                <p class="text-zinc-500 text-sm">Brak czcionek</p>
                                <p class="text-zinc-600 text-xs mt-1">Dodaj czcionki marki</p>
                            </div>
                        </div>

                        <!-- 5. Mockups Section -->
                        <div class="mb-10">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="text-sm font-medium text-zinc-400 uppercase tracking-wider">Mockupy</h4>
                            </div>
                            <!-- Mockup prompts - visible inline -->
                            <div id="mockup-prompts-inline" class="mb-4 flex flex-wrap gap-2">
                                <!-- Generated by JS - compact prompt chips -->
                            </div>
                            <!-- Mockup grid - items + dropzone rendered by JS -->
                            <div id="branding-mockups-grid" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                <!-- Mockups + dropzone rendered here -->
                            </div>
                        </div>

                    </div><!-- /tab-branding -->

                    <!-- TAB: Strona (Sales Page) -->
                    <div id="tab-strona" class="workflow-panel hidden">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                                <i class="ph ph-globe text-blue-400"></i>
                                Strona sprzedazowa
                            </h3>
                            <div class="flex items-center gap-3">
                                <button onclick="copyAIPrompt('landing')" class="text-xs text-zinc-400 hover:text-white flex items-center gap-1.5 px-2.5 py-1.5 rounded-md bg-zinc-800/50 hover:bg-zinc-700/50 border border-zinc-700/50 transition-colors" title="Kopiuj prompt AI">
                                    <i class="ph ph-robot"></i> Prompt
                                </button>
                                <span id="sales-page-delivered-badge" class="hidden text-xs text-emerald-400 flex items-center gap-1">
                                    <i class="ph ph-check-circle"></i> Przekazano klientowi
                                </span>
                                <button id="sales-page-deliver-btn" onclick="deliverSalesPage()" class="hidden bg-emerald-600 hover:bg-emerald-500 text-white text-xs px-4 py-2 rounded-lg transition-colors flex items-center gap-1.5">
                                    <i class="ph ph-paper-plane-tilt"></i> Przekaz klientowi
                                </button>
                            </div>
                        </div>

                        <!-- URL + Status bar -->
                        <div class="bg-zinc-900/40 border border-white/5 rounded-lg p-5 mb-6">
                            <div class="flex flex-col sm:flex-row gap-4">
                                <div class="flex-1">
                                    <label class="block text-zinc-500 text-xs font-mono uppercase tracking-wider mb-2">URL strony</label>
                                    <div class="flex gap-2">
                                        <input type="url" id="sales-page-url" class="input-field flex-1 text-sm text-white px-3 py-2.5 rounded-lg" placeholder="https://twoja-strona.pl">
                                        <button onclick="saveSalesPageUrl()" class="bg-zinc-800 hover:bg-zinc-700 text-white px-4 py-2 rounded-lg text-sm transition-colors flex items-center gap-1.5">
                                            <i class="ph ph-floppy-disk"></i> Zapisz
                                        </button>
                                    </div>
                                </div>
                                <div class="sm:w-40">
                                    <label class="block text-zinc-500 text-xs font-mono uppercase tracking-wider mb-2">Status</label>
                                    <div class="flex items-center gap-4 h-[42px]">
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="radio" name="sales-page-status" value="draft" class="accent-zinc-500" checked>
                                            <span class="text-zinc-400 text-sm">Draft</span>
                                        </label>
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="radio" name="sales-page-status" value="live" class="accent-emerald-500">
                                            <span class="text-emerald-400 text-sm">Live</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sharing status banner -->
                        <div id="sales-page-sharing-banner" class="mb-6"></div>

                        <!-- Link to open page -->
                        <div id="sales-page-preview" class="hidden">
                            <a id="sales-page-link" href="#" target="_blank" class="inline-flex items-center gap-2 text-cyan-400 hover:text-cyan-300 text-sm transition-colors mt-2">
                                <i class="ph ph-arrow-square-out"></i>
                                Otworz w nowej karcie
                            </a>
                        </div>

                        <!-- Empty state -->
                        <div id="sales-page-empty" class="text-center py-16">
                            <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-zinc-900 flex items-center justify-center">
                                <i class="ph ph-globe text-2xl text-zinc-600"></i>
                            </div>
                            <p class="text-zinc-500 text-sm">Brak strony sprzedazowej</p>
                            <p class="text-zinc-600 text-xs mt-1">Wklej URL strony powyzej i kliknij Zapisz</p>
                        </div>
                    </div><!-- /tab-strona -->

                    <!-- TAB: Podsumowanie Etapu 1 -->
                    <div id="tab-podsumowanie" class="workflow-panel hidden">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                                <i class="ph ph-check-square text-emerald-400"></i>
                                Podsumowanie Etapu 1
                            </h3>
                        </div>

                        <!-- Status elementów etapu 1 -->
                        <div class="mb-8">
                            <h4 class="text-sm font-medium text-zinc-400 uppercase tracking-wider mb-4">Status elementów</h4>
                            <div class="bg-zinc-900/40 border border-white/5 rounded-lg p-4">
                                <div id="podsumowanie-checklist" class="space-y-3">
                                    <!-- Will be populated by JS -->
                                </div>
                            </div>
                        </div>

                        <!-- Akceptacja etapu -->
                        <div class="mb-8">
                            <h4 class="text-sm font-medium text-zinc-400 uppercase tracking-wider mb-4">Akceptacja etapu</h4>
                            <div class="bg-zinc-900/40 border border-white/5 rounded-lg p-4">
                                <div id="podsumowanie-not-accepted" class="flex items-center gap-3 text-amber-400">
                                    <i class="ph ph-hourglass text-lg"></i>
                                    <div>
                                        <div class="text-[13px] font-medium">Oczekuje na akceptację klienta</div>
                                        <div class="text-[11px] text-[#666] mt-0.5">Klient musi zaakceptować etap 1 w swoim panelu</div>
                                    </div>
                                </div>
                                <div id="podsumowanie-accepted" class="hidden">
                                    <div class="flex items-center gap-3 text-emerald-400">
                                        <i class="ph-fill ph-check-circle text-lg"></i>
                                        <div>
                                            <div class="text-[13px] font-medium">Etap 1 zaakceptowany</div>
                                            <div class="text-[11px] text-[#666] mt-0.5">Data akceptacji: <span id="podsumowanie-accepted-date" class="text-emerald-400/80">-</span></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div><!-- /tab-podsumowanie -->

                    <!-- TAB: Produkty (Products & Deliveries) -->
                    <div id="tab-produkty" class="workflow-panel hidden">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                                <i class="ph ph-package text-orange-400"></i>
                                Produkt klienta
                            </h3>
                            <a href="/tn-workflow/products" class="text-zinc-400 hover:text-white border border-zinc-700 hover:border-zinc-600 px-4 py-2 rounded-lg text-sm transition-colors flex items-center gap-2">
                                <i class="ph ph-arrow-square-out"></i>
                                Globalna baza produktów
                            </a>
                        </div>

                        <div id="products-sharing-banner" class="mb-6"></div>
                        <div id="product-selection-status"></div>
                    </div><!-- /tab-produkty -->

                    <!-- TAB: Raporty (Reports) -->
                    <div id="tab-raporty" class="workflow-panel hidden">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                                <i class="ph ph-chart-bar text-green-400"></i>
                                Raporty i analizy
                            </h3>
                            <div class="flex items-center gap-3">
                                <button onclick="downloadProductPDF()" class="text-xs text-zinc-400 hover:text-white flex items-center gap-1.5 px-2.5 py-1.5 rounded-md bg-zinc-800/50 hover:bg-zinc-700/50 border border-zinc-700/50 transition-colors" title="Pobierz PDF produktu">
                                    <i class="ph ph-file-pdf"></i> PDF
                                </button>
                                <button onclick="copyAIPrompt('report')" class="text-xs text-zinc-400 hover:text-white flex items-center gap-1.5 px-2.5 py-1.5 rounded-md bg-zinc-800/50 hover:bg-zinc-700/50 border border-zinc-700/50 transition-colors" title="Kopiuj prompt AI">
                                    <i class="ph ph-copy"></i> Prompt
                                </button>
                                <button id="publish-all-reports-btn" onclick="publishAllReports()" class="hidden bg-emerald-600 hover:bg-emerald-500 text-white px-3 py-1.5 rounded-lg text-xs font-medium transition-colors flex items-center gap-1.5">
                                    <i class="ph ph-checks"></i> Udostępnij wszystkie
                                </button>
                            </div>
                        </div>

                        <!-- Drag & Drop Zone -->
                        <div id="reports-dropzone"
                             class="relative border-2 border-dashed border-zinc-700 hover:border-green-500/50 rounded-xl p-8 mb-6 transition-all cursor-pointer group"
                             ondragover="handleReportDragOver(event)"
                             ondragleave="handleReportDragLeave(event)"
                             ondrop="handleReportDrop(event)"
                             onclick="document.getElementById('reports-dropzone-input').click()">
                            <input type="file" id="reports-dropzone-input" class="hidden" accept=".pdf,.png,.jpg,.jpeg,.webp,.mp4,.mov,.webm" onchange="handleReportFileSelect(event)" multiple>
                            <div class="flex flex-col items-center justify-center text-center">
                                <div class="w-12 h-12 rounded-full bg-zinc-800 group-hover:bg-green-500/10 flex items-center justify-center mb-3 transition-colors">
                                    <i class="ph ph-cloud-arrow-up text-2xl text-zinc-500 group-hover:text-green-400 transition-colors"></i>
                                </div>
                                <p class="text-zinc-400 text-sm group-hover:text-white transition-colors">Przeciągnij pliki lub kliknij</p>
                                <p class="text-zinc-600 text-xs mt-1">PDF, obrazy (PNG, JPG), wideo (MP4, MOV)</p>
                            </div>
                            <div id="reports-dropzone-active" class="hidden absolute inset-0 bg-green-500/10 border-2 border-green-500 rounded-xl flex items-center justify-center">
                                <div class="text-center">
                                    <i class="ph ph-cloud-arrow-up text-4xl text-green-400 mb-2"></i>
                                    <p class="text-green-400 font-medium">Upuść pliki tutaj</p>
                                </div>
                            </div>
                        </div>

                        <!-- Upload Progress -->
                        <div id="reports-upload-queue" class="hidden mb-6 space-y-2"></div>

                        <!-- Reports List -->
                        <div id="reports-list" class="space-y-2">
                            <!-- Reports rendered here -->
                        </div>

                        <div id="reports-empty" class="hidden text-center py-8">
                            <p class="text-zinc-600 text-sm">Brak raportów - przeciągnij pliki powyżej</p>
                        </div>
                    </div><!-- /tab-raporty -->

                    <!-- TAB: Scenariusze (Etap 2) -->
                    <div id="tab-scenariusze" class="workflow-panel hidden">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                                <i class="ph ph-film-script text-cyan-400"></i>
                                Scenariusze
                            </h3>
                            <button onclick="copyAIPrompt('video')" class="text-xs text-zinc-400 hover:text-white flex items-center gap-1.5 px-2.5 py-1.5 rounded-md bg-zinc-800/50 hover:bg-zinc-700/50 border border-zinc-700/50 transition-colors" title="Kopiuj prompt AI">
                                <i class="ph ph-robot"></i> Prompt
                            </button>
                        </div>

                        <!-- Widoczność dla klienta -->
                        <div class="mb-8">
                            <h4 class="text-sm font-medium text-zinc-400 uppercase tracking-wider mb-4">Udostępnienie etapu 2</h4>
                            <div class="bg-zinc-900/40 border border-white/5 rounded-lg p-4">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="text-[13px] text-white">Widoczność dla klienta</div>
                                        <div class="text-[12px] text-[#666] mt-0.5">Włącz, aby klient widział zakładkę Video</div>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="video-active" class="sr-only peer" onchange="toggleVideoActive()">
                                        <div class="w-[42px] h-[24px] bg-[#333] rounded-full peer peer-checked:bg-cyan-500 after:content-[''] after:absolute after:top-[3px] after:left-[3px] after:bg-white after:rounded-full after:h-[18px] after:w-[18px] after:transition-all peer-checked:after:translate-x-[18px]"></div>
                                    </label>
                                </div>
                                <div id="video-activated-info" class="hidden mt-3 pt-3 border-t border-[#222] text-[12px] text-[#666]">
                                    <i class="ph ph-calendar-check mr-1"></i> Aktywowano: <span id="video-activated-date" class="text-[#888]">-</span>
                                </div>
                            </div>
                        </div>

                        <!-- Scenariusze video -->
                        <div class="mb-8">
                            <h4 class="text-sm font-medium text-zinc-400 uppercase tracking-wider mb-4">Scenariusze video <span id="video-scenarios-count" class="text-[11px] text-[#555]"></span></h4>
                            <div id="video-scenarios-admin" class="space-y-2">
                                <!-- Scenarios will be loaded here -->
                            </div>
                            <div id="video-scenarios-empty" class="hidden bg-zinc-900/40 border border-dashed border-zinc-700 rounded-lg p-8 text-center">
                                <i class="ph ph-film-script text-2xl text-zinc-600 mb-2"></i>
                                <p class="text-zinc-500 text-sm">Brak scenariuszy</p>
                                <p class="text-zinc-600 text-xs mt-1">Wygeneruj scenariusze przez Claude</p>
                            </div>
                        </div>
                    </div><!-- /tab-scenariusze -->

                    <!-- TAB: Profile (Etap 2) -->
                    <div id="tab-profile" class="workflow-panel hidden">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                                <i class="ph ph-user-circle text-cyan-400"></i>
                                Profile społecznościowe
                            </h3>
                        </div>

                        <!-- Profile społecznościowe klienta -->
                        <div class="mb-8">
                            <h4 class="text-sm font-medium text-zinc-400 uppercase tracking-wider mb-4">Profile klienta</h4>
                            <div id="video-client-profiles" class="grid grid-cols-3 gap-3">
                                <div class="bg-zinc-900/40 border border-white/5 rounded-lg p-4 text-center">
                                    <i class="ph ph-tiktok-logo text-2xl text-[#444] mb-2"></i>
                                    <div id="video-client-tiktok" class="text-[12px] text-[#555] truncate">Nie podano</div>
                                </div>
                                <div class="bg-zinc-900/40 border border-white/5 rounded-lg p-4 text-center">
                                    <i class="ph ph-youtube-logo text-2xl text-[#444] mb-2"></i>
                                    <div id="video-client-youtube" class="text-[12px] text-[#555] truncate">Nie podano</div>
                                </div>
                                <div class="bg-zinc-900/40 border border-white/5 rounded-lg p-4 text-center">
                                    <i class="ph ph-instagram-logo text-2xl text-[#444] mb-2"></i>
                                    <div id="video-client-instagram" class="text-[12px] text-[#555] truncate">Nie podano</div>
                                </div>
                            </div>
                        </div>
                    </div><!-- /tab-profile -->

                    <!-- TAB: Nagrania (Etap 2) -->
                    <div id="tab-nagrania" class="workflow-panel hidden">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                                <i class="ph ph-video text-cyan-400"></i>
                                Nagrania od klienta
                            </h3>
                            <div class="flex items-center gap-3">
                                <span id="video-delivered-badge" class="hidden text-xs text-amber-400 flex items-center gap-1">
                                    <i class="ph ph-clock"></i> Oczekuje na klienta
                                </span>
                                <span id="video-completed-badge" class="hidden text-xs text-emerald-400 flex items-center gap-1">
                                    <i class="ph ph-check-circle"></i> Materiały otrzymane
                                </span>
                            </div>
                        </div>

                        <!-- Nagrania od klienta -->
                        <div class="mb-8">
                            <div id="video-client-links" class="space-y-2">
                                <!-- Video links will be loaded here -->
                            </div>
                            <div id="video-client-links-empty" class="bg-zinc-900/40 border border-dashed border-zinc-700 rounded-lg p-8 text-center">
                                <i class="ph ph-video text-2xl text-zinc-600 mb-2"></i>
                                <p class="text-zinc-500 text-sm">Brak nagrań</p>
                                <p class="text-zinc-600 text-xs mt-1">Klient nie przesłał jeszcze żadnych linków</p>
                            </div>
                        </div>

                        <!-- Finalizacja -->
                        <div>
                            <h4 class="text-sm font-medium text-zinc-400 uppercase tracking-wider mb-4">Finalizacja</h4>
                            <div class="bg-zinc-900/40 border border-white/5 rounded-lg p-4">
                                <label class="flex items-center gap-3 cursor-pointer group">
                                    <input type="checkbox" id="video-shared-checkbox" onchange="toggleVideoShared()"
                                           class="w-5 h-5 rounded border-[#333] bg-[#111] text-emerald-500 focus:ring-emerald-500 focus:ring-offset-0 focus:ring-1 cursor-pointer">
                                    <div>
                                        <div class="text-[13px] text-white group-hover:text-emerald-400 transition-colors">Video udostępnione</div>
                                        <div class="text-[11px] text-[#555]">Zaznacz gdy klient przekazał nagrane materiały</div>
                                    </div>
                                </label>
                                <div id="video-shared-info" class="hidden mt-3 pt-3 border-t border-[#222] text-[11px] text-emerald-400/60">
                                    <i class="ph ph-check-circle"></i> Udostępniono: <span id="video-shared-date">-</span>
                                </div>
                            </div>
                        </div>
                    </div><!-- /tab-nagrania -->

                    <!-- TAB: TakeDrop Account (Etap 3) -->
                    <div id="tab-takedrop" class="workflow-panel hidden">
                        <!-- Toggle widoczności -->
                        <div class="flex items-center justify-between py-4 border-b border-[#222]">
                            <div>
                                <div class="text-[13px] text-white">Widoczność dla klienta</div>
                                <div class="text-[12px] text-[#666] mt-0.5">Włącz, aby klient widział zakładkę TakeDrop</div>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="takedrop-active" class="sr-only peer" onchange="toggleTakeDropActive()">
                                <div class="w-[42px] h-[24px] bg-[#333] rounded-full peer peer-checked:bg-[#0070f3] after:content-[''] after:absolute after:top-[3px] after:left-[3px] after:bg-white after:rounded-full after:h-[18px] after:w-[18px] after:transition-all peer-checked:after:translate-x-[18px]"></div>
                            </label>
                        </div>
                        <div id="takedrop-activated-info" class="hidden py-3 border-b border-[#222] text-[12px] text-[#666]">
                            Aktywowano: <span id="takedrop-activated-date" class="text-[#888]">-</span>
                        </div>

                        <!-- Status klienta -->
                        <div class="py-4 border-b border-[#222]">
                            <div class="text-[12px] text-[#666] mb-3">Status</div>
                            <div id="takedrop-client-status" class="flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-[#666]" id="takedrop-status-dot"></span>
                                <span class="text-[13px] text-[#888]" id="takedrop-status-text">Oczekuje na założenie konta</span>
                            </div>
                            <div id="takedrop-created-info" class="hidden mt-3 text-[12px] text-[#666]">
                                Konto założone: <span id="takedrop-created-date" class="text-[#888]">-</span>
                            </div>
                        </div>

                        <!-- Dane konta -->
                        <div class="py-4">
                            <div class="text-[12px] text-[#666] mb-4">Dane logowania klienta</div>
                            <div class="space-y-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-[12px] text-[#666] mb-1.5">Email</label>
                                        <input type="email" id="takedrop-email" class="w-full bg-transparent border border-[#333] rounded-md px-3 py-2 text-[13px] text-white placeholder-[#555] focus:border-[#666] focus:outline-none transition-colors" placeholder="email@example.com">
                                    </div>
                                    <div>
                                        <label class="block text-[12px] text-[#666] mb-1.5">Hasło</label>
                                        <div class="relative">
                                            <input type="password" id="takedrop-password" class="w-full bg-transparent border border-[#333] rounded-md px-3 py-2 pr-9 text-[13px] text-white placeholder-[#555] focus:border-[#666] focus:outline-none transition-colors" placeholder="••••••••">
                                            <button type="button" onclick="togglePasswordVisibility('takedrop-password')" class="absolute right-2.5 top-1/2 -translate-y-1/2 text-[#555] hover:text-white transition-colors">
                                                <i class="ph ph-eye text-[14px]"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-[12px] text-[#666] mb-1.5">Notatki</label>
                                    <textarea id="takedrop-notes" rows="2" class="w-full bg-transparent border border-[#333] rounded-md px-3 py-2 text-[13px] text-white placeholder-[#555] focus:border-[#666] focus:outline-none transition-colors resize-none" placeholder="Opcjonalne notatki..."></textarea>
                                </div>
                                <div class="flex justify-end pt-2">
                                    <button onclick="saveTakeDropCredentials()" class="bg-white text-black text-[13px] font-medium px-4 py-2 rounded-md hover:bg-[#e5e5e5] transition-colors">
                                        Zapisz
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div><!-- /tab-takedrop -->

                    <!-- TAB: Historia (Full Activity History) -->
                    <div id="tab-historia" class="workflow-panel hidden">
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold text-white mb-2 flex items-center gap-2">
                                <i class="ph ph-clock-counter-clockwise text-violet-400"></i>
                                Historia aktywności
                            </h3>
                            <p class="text-zinc-500 text-sm">Pełna historia wszystkich działań w projekcie</p>
                        </div>

                        <!-- Filters -->
                        <div class="flex flex-wrap items-center gap-3 mb-6">
                            <select id="history-filter-type" onchange="filterHistory()" class="bg-zinc-900 border border-white/10 rounded-lg px-3 py-2 text-sm text-zinc-300">
                                <option value="">Wszystkie typy</option>
                                <option value="task">Zadania</option>
                                <option value="milestone">Etapy</option>
                                <option value="products">Produkty</option>
                                <option value="branding">Branding</option>
                                <option value="report">Raporty</option>
                                <option value="contract">Umowa</option>
                            </select>
                        </div>

                        <!-- Activity List -->
                        <div id="full-activity-log" class="space-y-3">
                            <div class="text-zinc-600 text-sm text-center py-8">Ładowanie historii...</div>
                        </div>

                        <!-- Load More -->
                        <div id="history-load-more" class="hidden text-center mt-6">
                            <button onclick="loadMoreHistory()" class="px-4 py-2 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 text-sm rounded-lg transition-colors">
                                Załaduj więcej
                            </button>
                        </div>
                    </div><!-- /tab-historia -->

                    <!-- TAB: Wiadomosci (Email History) -->
                    <div id="tab-wiadomosci" class="workflow-panel hidden">
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold text-white mb-2 flex items-center gap-2">
                                <i class="ph ph-envelope text-cyan-400"></i>
                                Wysłane wiadomości
                            </h3>
                            <p class="text-zinc-500 text-sm">Historia emaili wysłanych do klienta</p>
                        </div>

                        <!-- Email List -->
                        <div id="email-history-list" class="space-y-3">
                            <div class="text-zinc-600 text-sm text-center py-8">Ładowanie wiadomości...</div>
                        </div>
                    </div><!-- /tab-wiadomosci -->

                </div>
            </div>
            </div>
        </div>
    </main>

    <!-- Password Modal -->
    <div id="password-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-zinc-950 border border-white/10 rounded-lg w-full max-w-md shadow-2xl">
            <div class="flex items-center justify-between px-5 py-4 border-b border-white/5">
                <h2 class="text-sm font-medium text-white flex items-center gap-2">
                    <i class="ph ph-key text-amber-400"></i>
                    Haslo dostepu klienta
                </h2>
                <button onclick="closePasswordModal()" class="text-zinc-500 hover:text-white transition-colors">
                    <i class="ph ph-x text-lg"></i>
                </button>
            </div>

            <div class="p-5 space-y-4">
                <p class="text-zinc-400 text-sm">Ustaw haslo, ktore klient musi podac aby zobaczyc projekt. Pozostaw puste aby usunac haslo.</p>

                <div>
                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Nowe haslo</label>
                    <input type="password" id="new-password" class="input-field w-full text-sm text-white px-3 py-3 rounded-lg" placeholder="Wprowadz haslo...">
                </div>

                <div>
                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Potwierdz haslo</label>
                    <input type="password" id="confirm-password" class="input-field w-full text-sm text-white px-3 py-3 rounded-lg" placeholder="Powtorz haslo...">
                </div>

                <div id="password-current" class="text-xs text-zinc-500">
                    Status: <span id="password-status" class="text-zinc-300">brak hasla</span>
                </div>
            </div>

            <div class="flex gap-3 px-5 py-4 border-t border-white/5 bg-zinc-900/50">
                <button onclick="removePassword()" id="remove-password-btn" class="hidden text-red-400 hover:text-red-300 border border-red-500/20 hover:border-red-500/40 px-4 py-2 rounded-lg text-sm transition-colors">
                    Usun haslo
                </button>
                <div class="flex-1"></div>
                <button onclick="closePasswordModal()" class="text-zinc-400 hover:text-white border border-zinc-700 hover:border-zinc-600 px-4 py-2 rounded-lg text-sm transition-colors">
                    Anuluj
                </button>
                <button onclick="savePassword()" class="bg-white text-black hover:bg-zinc-200 px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                    Zapisz
                </button>
            </div>
        </div>
    </div>

    <!-- Task Notes Modal -->
    <div id="notes-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-zinc-950 border border-white/10 rounded-lg w-full max-w-lg shadow-2xl">
            <div class="flex items-center justify-between px-5 py-4 border-b border-white/5">
                <h2 class="text-sm font-medium text-white flex items-center gap-2">
                    <i class="ph ph-note text-amber-400"></i>
                    <span id="notes-modal-title">Notatki do zadania</span>
                </h2>
                <button onclick="closeNotesModal()" class="text-zinc-500 hover:text-white transition-colors">
                    <i class="ph ph-x text-lg"></i>
                </button>
            </div>

            <div class="p-5 space-y-4">
                <input type="hidden" id="notes-task-id">
                <div>
                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Notatki</label>
                    <textarea id="task-notes" rows="5" class="input-field w-full text-sm text-white px-3 py-3 rounded-lg resize-none" placeholder="Dodaj notatki..."></textarea>
                </div>

                <div>
                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Linki</label>
                    <div id="links-container" class="space-y-2 mb-2">
                        <!-- Links rendered here -->
                    </div>
                    <div class="flex gap-2">
                        <input type="text" id="new-link-url" class="input-field flex-1 text-sm text-white px-3 py-2 rounded-lg" placeholder="https://...">
                        <input type="text" id="new-link-title" class="input-field w-32 text-sm text-white px-3 py-2 rounded-lg" placeholder="Tytul">
                        <button onclick="addLink()" class="bg-zinc-800 hover:bg-zinc-700 text-white px-3 py-2 rounded-lg transition-colors">
                            <i class="ph ph-plus"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="flex gap-3 px-5 py-4 border-t border-white/5 bg-zinc-900/50">
                <div class="flex-1"></div>
                <button onclick="closeNotesModal()" class="text-zinc-400 hover:text-white border border-zinc-700 hover:border-zinc-600 px-4 py-2 rounded-lg text-sm transition-colors">
                    Anuluj
                </button>
                <button onclick="saveTaskNotes()" class="bg-white text-black hover:bg-zinc-200 px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                    Zapisz
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Milestone Modal -->
    <div id="edit-milestone-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-zinc-950 border border-white/10 rounded-lg w-full max-w-md shadow-2xl">
            <div class="flex items-center justify-between px-5 py-4 border-b border-white/5">
                <h2 class="text-sm font-medium text-white flex items-center gap-2">
                    <i class="ph ph-pencil-simple text-violet-400"></i>
                    Edytuj etap
                </h2>
                <button onclick="closeEditMilestoneModal()" class="text-zinc-500 hover:text-white transition-colors">
                    <i class="ph ph-x text-lg"></i>
                </button>
            </div>

            <div class="p-5 space-y-4">
                <input type="hidden" id="edit-milestone-id">
                <div>
                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Nazwa etapu</label>
                    <input type="text" id="edit-milestone-title" class="input-field w-full text-sm text-white px-3 py-3 rounded-lg" placeholder="Nazwa etapu...">
                </div>
                <div>
                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Opis (opcjonalnie)</label>
                    <textarea id="edit-milestone-description" rows="3" class="input-field w-full text-sm text-white px-3 py-3 rounded-lg resize-none" placeholder="Opis etapu..."></textarea>
                </div>
                <div>
                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Czas trwania (dni, 0 = bez terminu)</label>
                    <input type="number" id="edit-milestone-duration" min="0" class="input-field w-24 text-sm text-white px-3 py-3 rounded-lg" placeholder="0">
                </div>
            </div>

            <div class="flex gap-3 px-5 py-4 border-t border-white/5 bg-zinc-900/50">
                <div class="flex-1"></div>
                <button onclick="closeEditMilestoneModal()" class="text-zinc-400 hover:text-white border border-zinc-700 hover:border-zinc-600 px-4 py-2 rounded-lg text-sm transition-colors">
                    Anuluj
                </button>
                <button onclick="saveMilestone()" class="bg-white text-black hover:bg-zinc-200 px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                    Zapisz
                </button>
            </div>
        </div>
    </div>

    <!-- Add Task Modal -->
    <div id="add-task-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-zinc-950 border border-white/10 rounded-lg w-full max-w-md shadow-2xl">
            <div class="flex items-center justify-between px-5 py-4 border-b border-white/5">
                <h2 class="text-sm font-medium text-white flex items-center gap-2">
                    <i class="ph ph-plus-circle text-emerald-400"></i>
                    Dodaj zadanie
                </h2>
                <button onclick="closeAddTaskModal()" class="text-zinc-500 hover:text-white transition-colors">
                    <i class="ph ph-x text-lg"></i>
                </button>
            </div>

            <div class="p-5 space-y-4">
                <input type="hidden" id="add-task-milestone-id">
                <div>
                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Nazwa zadania</label>
                    <input type="text" id="add-task-title" class="input-field w-full text-sm text-white px-3 py-3 rounded-lg" placeholder="Nazwa zadania...">
                </div>
                <div>
                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Odpowiedzialny</label>
                    <select id="add-task-responsible" class="input-field w-full text-sm text-white px-3 py-3 rounded-lg">
                        <option value="team">Zespol (TN)</option>
                        <option value="client">Klient</option>
                        <option value="shared">Wspolne</option>
                    </select>
                </div>
            </div>

            <div class="flex gap-3 px-5 py-4 border-t border-white/5 bg-zinc-900/50">
                <div class="flex-1"></div>
                <button onclick="closeAddTaskModal()" class="text-zinc-400 hover:text-white border border-zinc-700 hover:border-zinc-600 px-4 py-2 rounded-lg text-sm transition-colors">
                    Anuluj
                </button>
                <button onclick="saveNewTask()" class="bg-white text-black hover:bg-zinc-200 px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                    Dodaj
                </button>
            </div>
        </div>
    </div>

    <!-- Report Upload Modal -->
    <div id="report-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-zinc-950 border border-white/10 rounded-lg w-full max-w-lg shadow-2xl">
            <div class="flex items-center justify-between px-5 py-4 border-b border-white/5">
                <h2 class="text-sm font-medium text-white flex items-center gap-2">
                    <i class="ph ph-upload-simple text-green-400"></i>
                    <span>Dodaj plik raportu</span>
                </h2>
                <button onclick="closeReportModal()" class="text-zinc-500 hover:text-white transition-colors">
                    <i class="ph ph-x text-lg"></i>
                </button>
            </div>

            <div class="p-5 space-y-4">
                <div>
                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Typ pliku</label>
                    <select id="report-file-type" class="input-field w-full text-sm text-white px-3 py-2 rounded-lg" onchange="updateReportFileAccept()">
                        <option value="report_pdf">Raport</option>
                        <option value="report_infographic">Infografika</option>
                        <option value="report_presentation">Prezentacja</option>
                        <option value="report_video">Video analiza</option>
                    </select>
                </div>
                <div>
                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Plik</label>
                    <input type="file" id="report-file-input" accept=".pdf" class="w-full text-sm text-zinc-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-zinc-700 file:text-white hover:file:bg-zinc-600">
                </div>
                <div id="report-upload-progress" class="hidden">
                    <div class="flex items-center gap-2 text-zinc-400 text-xs">
                        <i class="ph ph-spinner animate-spin"></i>
                        <span>Przesyłanie pliku...</span>
                    </div>
                </div>
            </div>

            <div class="flex justify-end gap-3 px-5 py-4 border-t border-white/5 bg-zinc-900/50">
                <button onclick="closeReportModal()" class="text-zinc-400 hover:text-white border border-zinc-700 hover:border-zinc-600 px-4 py-2 rounded-lg text-sm transition-colors">
                    Anuluj
                </button>
                <button onclick="uploadReport()" class="bg-white text-black hover:bg-zinc-200 px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                    <i class="ph ph-upload-simple mr-1"></i> Zapisz
                </button>
            </div>
        </div>
    </div>

    <!-- PDF Type Selection Modal (mini) -->
    <div id="pdf-type-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-zinc-950 border border-white/10 rounded-xl w-full max-w-sm shadow-2xl">
            <div class="p-5">
                <h3 class="text-white font-medium mb-1">Jaki to typ pliku PDF?</h3>
                <p class="text-zinc-500 text-xs mb-4" id="pdf-type-filename"></p>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="confirmPdfType('report_pdf')" class="flex flex-col items-center gap-2 p-4 rounded-lg bg-zinc-900 hover:bg-red-500/10 border border-zinc-800 hover:border-red-500/30 transition-all group">
                        <i class="ph ph-file-pdf text-2xl text-zinc-500 group-hover:text-red-400"></i>
                        <span class="text-sm text-zinc-400 group-hover:text-white">Raport</span>
                    </button>
                    <button onclick="confirmPdfType('report_presentation')" class="flex flex-col items-center gap-2 p-4 rounded-lg bg-zinc-900 hover:bg-blue-500/10 border border-zinc-800 hover:border-blue-500/30 transition-all group">
                        <i class="ph ph-presentation-chart text-2xl text-zinc-500 group-hover:text-blue-400"></i>
                        <span class="text-sm text-zinc-400 group-hover:text-white">Prezentacja</span>
                    </button>
                </div>
                <button onclick="closePdfTypeModal()" class="w-full mt-3 text-zinc-500 hover:text-white text-xs py-2 transition-colors">Anuluj</button>
            </div>
        </div>
    </div>

    <!-- Brand Info Modal -->
    <div id="brand-info-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-zinc-950 border border-white/10 rounded-lg w-full max-w-lg shadow-2xl">
            <div class="flex items-center justify-between px-5 py-4 border-b border-white/5">
                <h2 class="text-sm font-medium text-white flex items-center gap-2">
                    <i class="ph ph-buildings text-pink-400"></i>
                    <span>Informacje o marce</span>
                </h2>
                <button onclick="closeBrandInfoModal()" class="text-zinc-500 hover:text-white transition-colors">
                    <i class="ph ph-x text-lg"></i>
                </button>
            </div>
            <div class="p-5 space-y-4">
                <div>
                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Nazwa marki</label>
                    <input type="text" id="brand-info-name-input" class="input-field w-full text-sm text-white px-3 py-3 rounded-lg" placeholder="Nazwa marki...">
                </div>
                <div>
                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Tagline</label>
                    <input type="text" id="brand-info-tagline-input" class="input-field w-full text-sm text-white px-3 py-3 rounded-lg" placeholder="Krótki slogan marki...">
                </div>
                <div>
                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Opis marki</label>
                    <textarea id="brand-info-description-input" rows="4" class="input-field w-full text-sm text-white px-3 py-3 rounded-lg resize-none" placeholder="Krótki opis marki, jej misja i wartości..."></textarea>
                </div>
            </div>
            <div class="flex justify-end gap-3 px-5 py-4 border-t border-white/5 bg-zinc-900/50">
                <button onclick="closeBrandInfoModal()" class="text-zinc-400 hover:text-white border border-zinc-700 hover:border-zinc-600 px-4 py-2 rounded-lg text-sm transition-colors">Anuluj</button>
                <button onclick="saveBrandInfo()" class="bg-white text-black hover:bg-zinc-200 px-4 py-2 rounded-lg text-sm font-medium transition-colors">Zapisz</button>
            </div>
        </div>
    </div>

    <!-- Logo Upload Modal -->
    <div id="logo-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-zinc-950 border border-white/10 rounded-lg w-full max-w-lg shadow-2xl">
            <div class="flex items-center justify-between px-5 py-4 border-b border-white/5">
                <h2 class="text-sm font-medium text-white flex items-center gap-2">
                    <i class="ph ph-image text-pink-400"></i>
                    <span>Dodaj logo</span>
                </h2>
                <button onclick="closeLogoModal()" class="text-zinc-500 hover:text-white transition-colors">
                    <i class="ph ph-x text-lg"></i>
                </button>
            </div>
            <div class="p-5 space-y-4">
                <div>
                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Wariant</label>
                    <select id="logo-variant-input" class="input-field w-full text-sm text-white px-3 py-2 rounded-lg">
                        <option value="main">Główne</option>
                        <option value="dark">Na ciemnym tle</option>
                        <option value="light">Na jasnym tle</option>
                        <option value="mono">Monochromatyczne</option>
                        <option value="favicon">Favicon / ikona</option>
                    </select>
                </div>
                <div>
                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Plik logo</label>
                    <input type="file" id="logo-file-input" accept=".png,.jpg,.jpeg,.svg,.webp" class="hidden">
                    <div id="logo-dropzone" class="border-2 border-dashed border-zinc-700 rounded-lg p-6 text-center cursor-pointer hover:border-zinc-500 transition-colors"
                        onclick="document.getElementById('logo-file-input').click()"
                        ondragover="event.preventDefault(); this.classList.add('border-orange-500', 'bg-orange-500/5')"
                        ondragleave="this.classList.remove('border-orange-500', 'bg-orange-500/5')"
                        ondrop="event.preventDefault(); this.classList.remove('border-orange-500', 'bg-orange-500/5'); handleLogoFileDrop(event)">
                        <i class="ph ph-image text-2xl text-zinc-500 mb-2"></i>
                        <p class="text-zinc-400 text-sm" id="logo-dropzone-text">Przeciągnij plik lub kliknij</p>
                        <p class="text-zinc-600 text-xs mt-1">PNG, JPG, SVG, WebP</p>
                    </div>
                </div>
                <div id="logo-upload-progress" class="hidden">
                    <div class="flex items-center gap-2 text-zinc-400 text-xs">
                        <i class="ph ph-spinner animate-spin"></i>
                        <span>Przesyłanie...</span>
                    </div>
                </div>
            </div>
            <div class="flex justify-end gap-3 px-5 py-4 border-t border-white/5 bg-zinc-900/50">
                <button onclick="closeLogoModal()" class="text-zinc-400 hover:text-white border border-zinc-700 hover:border-zinc-600 px-4 py-2 rounded-lg text-sm transition-colors">Anuluj</button>
                <button onclick="saveLogo()" class="bg-white text-black hover:bg-zinc-200 px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                    <i class="ph ph-upload-simple mr-1"></i> Zapisz
                </button>
            </div>
        </div>
    </div>

    <!-- Color Modal -->
    <div id="color-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-zinc-950 border border-white/10 rounded-lg w-full max-w-lg shadow-2xl">
            <div class="flex items-center justify-between px-5 py-4 border-b border-white/5">
                <h2 class="text-sm font-medium text-white flex items-center gap-2">
                    <i class="ph ph-palette text-pink-400"></i>
                    <span>Dodaj kolor</span>
                </h2>
                <button onclick="closeColorModal()" class="text-zinc-500 hover:text-white transition-colors">
                    <i class="ph ph-x text-lg"></i>
                </button>
            </div>
            <div class="p-5 space-y-4">
                <div>
                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Nazwa koloru</label>
                    <input type="text" id="color-title-input" class="input-field w-full text-sm text-white px-3 py-3 rounded-lg" placeholder="np. Główny niebieski, Akcent...">
                </div>
                <div>
                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Rola</label>
                    <select id="color-role-input" class="input-field w-full text-sm text-white px-3 py-2 rounded-lg">
                        <option value="primary">Primary</option>
                        <option value="secondary">Secondary</option>
                        <option value="accent">Accent</option>
                        <option value="neutral">Neutral</option>
                        <option value="other">Inny</option>
                    </select>
                </div>
                <div>
                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Kolor (HEX)</label>
                    <div class="flex items-center gap-3">
                        <input type="color" id="color-picker-input" value="#6366f1" class="w-12 h-10 rounded-lg border border-white/10 cursor-pointer bg-transparent" oninput="document.getElementById('color-hex-input').value = this.value">
                        <input type="text" id="color-hex-input" class="input-field flex-1 text-sm text-white px-3 py-3 rounded-lg font-mono" placeholder="#000000" value="#6366f1" oninput="try{document.getElementById('color-picker-input').value = this.value}catch(e){}">
                    </div>
                </div>
            </div>
            <div class="flex justify-end gap-3 px-5 py-4 border-t border-white/5 bg-zinc-900/50">
                <button onclick="closeColorModal()" class="text-zinc-400 hover:text-white border border-zinc-700 hover:border-zinc-600 px-4 py-2 rounded-lg text-sm transition-colors">Anuluj</button>
                <button onclick="saveColor()" class="bg-white text-black hover:bg-zinc-200 px-4 py-2 rounded-lg text-sm font-medium transition-colors">Zapisz</button>
            </div>
        </div>
    </div>

    <!-- Font Modal -->
    <div id="font-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-zinc-950 border border-white/10 rounded-lg w-full max-w-lg shadow-2xl">
            <div class="flex items-center justify-between px-5 py-4 border-b border-white/5">
                <h2 class="text-sm font-medium text-white flex items-center gap-2">
                    <i class="ph ph-text-aa text-pink-400"></i>
                    <span>Dodaj czcionkę</span>
                </h2>
                <button onclick="closeFontModal()" class="text-zinc-500 hover:text-white transition-colors">
                    <i class="ph ph-x text-lg"></i>
                </button>
            </div>
            <div class="p-5 space-y-4">
                <div>
                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Nazwa czcionki</label>
                    <input type="text" id="font-title-input" class="input-field w-full text-sm text-white px-3 py-3 rounded-lg" placeholder="np. Inter, Montserrat, Playfair Display...">
                </div>
                <div>
                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Rola</label>
                    <select id="font-role-input" class="input-field w-full text-sm text-white px-3 py-2 rounded-lg">
                        <option value="heading">Nagłówki (Heading)</option>
                        <option value="body">Tekst (Body)</option>
                        <option value="accent">Akcent / Display</option>
                    </select>
                </div>
                <div>
                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Wagi (oddzielone przecinkiem)</label>
                    <input type="text" id="font-weights-input" class="input-field w-full text-sm text-white px-3 py-3 rounded-lg" placeholder="np. 400, 500, 700">
                </div>
            </div>
            <div class="flex justify-end gap-3 px-5 py-4 border-t border-white/5 bg-zinc-900/50">
                <button onclick="closeFontModal()" class="text-zinc-400 hover:text-white border border-zinc-700 hover:border-zinc-600 px-4 py-2 rounded-lg text-sm transition-colors">Anuluj</button>
                <button onclick="saveFont()" class="bg-white text-black hover:bg-zinc-200 px-4 py-2 rounded-lg text-sm font-medium transition-colors">Zapisz</button>
            </div>
        </div>
    </div>

    <!-- Mockup Upload Modal -->
    <div id="mockup-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-zinc-950 border border-white/10 rounded-lg w-full max-w-lg shadow-2xl">
            <div class="flex items-center justify-between px-5 py-4 border-b border-white/5">
                <h2 class="text-sm font-medium text-white flex items-center gap-2">
                    <i class="ph ph-t-shirt text-pink-400"></i>
                    <span>Dodaj mockup</span>
                </h2>
                <button onclick="closeMockupModal()" class="text-zinc-500 hover:text-white transition-colors">
                    <i class="ph ph-x text-lg"></i>
                </button>
            </div>
            <div class="p-5 space-y-4">
                <div>
                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Plik graficzny</label>
                    <input type="file" id="mockup-file-input" accept=".png,.jpg,.jpeg,.webp" class="hidden">
                    <div id="mockup-dropzone" class="border-2 border-dashed border-zinc-700 rounded-lg p-6 text-center cursor-pointer hover:border-zinc-500 transition-colors"
                        onclick="document.getElementById('mockup-file-input').click()"
                        ondragover="event.preventDefault(); this.classList.add('border-orange-500', 'bg-orange-500/5')"
                        ondragleave="this.classList.remove('border-orange-500', 'bg-orange-500/5')"
                        ondrop="event.preventDefault(); this.classList.remove('border-orange-500', 'bg-orange-500/5'); handleMockupFileDrop(event)">
                        <i class="ph ph-t-shirt text-2xl text-zinc-500 mb-2"></i>
                        <p class="text-zinc-400 text-sm" id="mockup-dropzone-text">Przeciągnij plik lub kliknij</p>
                        <p class="text-zinc-600 text-xs mt-1">PNG, JPG, WebP</p>
                    </div>
                </div>
                <div id="mockup-upload-progress" class="hidden">
                    <div class="flex items-center gap-2 text-zinc-400 text-xs">
                        <i class="ph ph-spinner animate-spin"></i>
                        <span>Przesyłanie...</span>
                    </div>
                </div>
            </div>
            <div class="flex justify-end gap-3 px-5 py-4 border-t border-white/5 bg-zinc-900/50">
                <button onclick="closeMockupModal()" class="text-zinc-400 hover:text-white border border-zinc-700 hover:border-zinc-600 px-4 py-2 rounded-lg text-sm transition-colors">Anuluj</button>
                <button onclick="saveMockup()" class="bg-white text-black hover:bg-zinc-200 px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                    <i class="ph ph-upload-simple mr-1"></i> Zapisz
                </button>
            </div>
        </div>
    </div>

    <!-- Guideline/File Upload Modal -->
    <div id="guideline-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-zinc-950 border border-white/10 rounded-lg w-full max-w-lg shadow-2xl">
            <div class="flex items-center justify-between px-5 py-4 border-b border-white/5">
                <h2 class="text-sm font-medium text-white flex items-center gap-2">
                    <i class="ph ph-file-arrow-down text-pink-400"></i>
                    <span>Dodaj plik</span>
                </h2>
                <button onclick="closeGuidelineModal()" class="text-zinc-500 hover:text-white transition-colors">
                    <i class="ph ph-x text-lg"></i>
                </button>
            </div>
            <div class="p-5 space-y-4">
                <div>
                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Nazwa pliku</label>
                    <input type="text" id="guideline-title-input" class="input-field w-full text-sm text-white px-3 py-3 rounded-lg" placeholder="np. Brand Guidelines, Logo Pack...">
                </div>
                <div>
                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Opis (opcjonalnie)</label>
                    <input type="text" id="guideline-notes-input" class="input-field w-full text-sm text-white px-3 py-3 rounded-lg" placeholder="Krótki opis zawartości...">
                </div>
                <div>
                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Plik</label>
                    <input type="file" id="guideline-file-input" accept=".pdf,.zip,.rar,.7z,.ai,.eps,.psd,.fig" class="w-full text-sm text-zinc-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-zinc-700 file:text-white hover:file:bg-zinc-600">
                </div>
                <div id="guideline-upload-progress" class="hidden">
                    <div class="flex items-center gap-2 text-zinc-400 text-xs">
                        <i class="ph ph-spinner animate-spin"></i>
                        <span>Przesyłanie...</span>
                    </div>
                </div>
            </div>
            <div class="flex justify-end gap-3 px-5 py-4 border-t border-white/5 bg-zinc-900/50">
                <button onclick="closeGuidelineModal()" class="text-zinc-400 hover:text-white border border-zinc-700 hover:border-zinc-600 px-4 py-2 rounded-lg text-sm transition-colors">Anuluj</button>
                <button onclick="saveGuideline()" class="bg-white text-black hover:bg-zinc-200 px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                    <i class="ph ph-upload-simple mr-1"></i> Zapisz
                </button>
            </div>
        </div>
    </div>

    <!-- Visits History Modal -->
    <div id="visits-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-zinc-900 border border-white/10 rounded-xl w-full max-w-lg max-h-[80vh] flex flex-col">
            <div class="flex items-center justify-between px-5 py-4 border-b border-white/5">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-lg bg-emerald-500/10 flex items-center justify-center">
                        <i class="ph ph-eye text-emerald-400"></i>
                    </div>
                    <span class="font-medium text-white">Historia wizyt klienta</span>
                </div>
                <button onclick="closeVisitsModal()" class="text-zinc-500 hover:text-white transition-colors">
                    <i class="ph ph-x text-xl"></i>
                </button>
            </div>
            <div id="visits-modal-content" class="p-5 overflow-y-auto flex-1">
                <div class="text-zinc-500 text-sm text-center py-8">Ładowanie...</div>
            </div>
            <div class="px-5 py-4 border-t border-white/5 bg-zinc-900/50">
                <button onclick="closeVisitsModal()" class="w-full text-zinc-400 hover:text-white border border-zinc-700 hover:border-zinc-600 px-4 py-2 rounded-lg text-sm transition-colors">Zamknij</button>
            </div>
        </div>
    </div>

    <!-- Image Lightbox -->
    <div id="image-lightbox" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center p-6 z-[60] cursor-pointer" onclick="closeImageLightbox()">
        <img id="lightbox-img" src="" class="max-w-full max-h-full object-contain rounded-lg shadow-2xl" onclick="event.stopPropagation()">
        <button onclick="closeImageLightbox()" class="absolute top-4 right-4 w-10 h-10 bg-white/10 hover:bg-white/20 text-white rounded-full flex items-center justify-center transition-colors">
            <i class="ph ph-x text-xl"></i>
        </button>
    </div>

    <!-- Alert Modal -->
    <div id="alert-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-zinc-900 border border-white/10 rounded-xl w-full max-w-sm">
            <div class="flex items-center justify-between px-5 py-4 border-b border-white/5">
                <div class="flex items-center gap-3">
                    <div id="alert-modal-icon" class="w-8 h-8 rounded-lg bg-amber-500/10 flex items-center justify-center">
                        <i class="ph ph-warning text-amber-400"></i>
                    </div>
                    <span id="alert-modal-title" class="font-medium text-white">Uwaga</span>
                </div>
                <button onclick="closeAlertModal()" class="text-zinc-500 hover:text-white transition-colors">
                    <i class="ph ph-x text-xl"></i>
                </button>
            </div>
            <div class="p-5">
                <p id="alert-modal-message" class="text-zinc-300 text-sm"></p>
            </div>
            <div class="px-5 py-4 border-t border-white/5 bg-zinc-900/50">
                <button onclick="closeAlertModal()" class="w-full bg-white text-black hover:bg-zinc-200 px-4 py-2 rounded-lg text-sm font-medium transition-colors">OK</button>
            </div>
        </div>
    </div>

    <script>
        function openImageLightbox(url) {
            document.getElementById('lightbox-img').src = url;
            document.getElementById('image-lightbox').classList.remove('hidden');
        }
        function closeImageLightbox() {
            document.getElementById('image-lightbox').classList.add('hidden');
            document.getElementById('lightbox-img').src = '';
        }

        const SUPABASE_URL = 'https://yxmavwkwnfuphjqbelws.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl4bWF2d2t3bmZ1cGhqcWJlbHdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NjQyNTUsImV4cCI6MjA4NDM0MDI1NX0.XeR0Fc7OFn6YbNJrOKTBEj36JtmLISZTM87y4ai9340';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        Sidebar.render();
        Sidebar.setupLogout(supabaseClient);

        let workflow = null;
        let milestones = [];
        let tasks = [];
        let currentTaskLinks = [];
        let activities = [];

        let teamMembers = [];
        let currentMember = null;
        let isAdmin = false;

        // Stage data for auto-collapse
        let videoAdminData = null;
        let takeDropData = null;

        // Activity logging helper
        async function logActivity(action, description, metadata = {}) {
            if (!workflow || !currentMember) return;

            try {
                await supabaseClient
                    .from('workflow_activities')
                    .insert({
                        workflow_id: workflow.id,
                        action,
                        description,
                        performed_by: currentMember.id,
                        performed_by_name: currentMember.name,
                        metadata
                    });

                // Reload activities
                await loadActivities();
                await loadLastAdminAction();
            } catch (err) {
                console.error('Error logging activity:', err);
            }
        }

        async function loadActivities() {
            if (!workflow) return;

            const { data } = await supabaseClient
                .from('workflow_activities')
                .select('*')
                .eq('workflow_id', workflow.id)
                .order('created_at', { ascending: false })
                .limit(20);

            activities = data || [];
            renderActivities();
        }

        function renderActivities(limit = 3) {
            const container = document.getElementById('activity-log');
            if (!container) return;

            if (activities.length === 0) {
                container.innerHTML = '<div class="text-[#444] text-[13px] py-2">Brak aktywności</div>';
                return;
            }

            // Show only limited items on overview
            const itemsToShow = activities.slice(0, limit);

            container.innerHTML = itemsToShow.map(a => {
                const timeAgo = formatTimeAgo(new Date(a.created_at));
                const actionIcon = getActivityIcon(a.action);
                const iconColor = getActivityColor(a.action);

                return `
                    <div class="flex items-start gap-3 py-3 border-b border-[#1a1a1a] last:border-0 group">
                        <div class="w-8 h-8 rounded-lg bg-[#111] border border-[#1a1a1a] flex items-center justify-center flex-shrink-0 group-hover:border-[#262626] transition-colors">
                            <i class="ph ${actionIcon} text-[13px] ${iconColor}"></i>
                        </div>
                        <div class="flex-1 min-w-0 pt-0.5">
                            <div class="text-[#ccc] text-[13px] leading-relaxed">${escapeHtml(a.description)}</div>
                            <div class="flex items-center gap-1.5 mt-1.5 text-[#555] text-[11px]">
                                <span class="text-[#666]">${a.performed_by_name || 'System'}</span>
                                <span class="text-[#333]">·</span>
                                <span>${timeAgo}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Full activity history for Historia tab
        let historyOffset = 0;
        const historyLimit = 50;

        async function loadFullHistory(reset = true) {
            if (!workflow) return;

            if (reset) historyOffset = 0;

            const filterType = document.getElementById('history-filter-type')?.value || '';
            let query = supabaseClient
                .from('workflow_activities')
                .select('*')
                .eq('workflow_id', workflow.id)
                .order('created_at', { ascending: false })
                .range(historyOffset, historyOffset + historyLimit - 1);

            if (filterType) {
                query = query.ilike('action', `%${filterType}%`);
            }

            const { data, error } = await query;

            if (error) {
                console.error('Error loading history:', error);
                return;
            }

            const container = document.getElementById('full-activity-log');
            if (!container) return;

            if (reset && (!data || data.length === 0)) {
                container.innerHTML = '<div class="text-zinc-600 text-sm text-center py-8">Brak aktywności do wyświetlenia</div>';
                document.getElementById('history-load-more')?.classList.add('hidden');
                return;
            }

            const html = data.map(a => {
                const date = new Date(a.created_at);
                const dateStr = date.toLocaleDateString('pl-PL', { day: 'numeric', month: 'long', year: 'numeric' });
                const timeStr = date.toLocaleTimeString('pl-PL', { hour: '2-digit', minute: '2-digit' });
                const actionIcon = getActivityIcon(a.action);
                const actionColor = getActivityColor(a.action);

                return `
                    <div class="flex items-start gap-4 p-4 bg-zinc-900/40 border border-white/5 rounded-lg">
                        <div class="w-10 h-10 rounded-full ${actionColor} flex items-center justify-center flex-shrink-0">
                            <i class="ph ${actionIcon} text-base"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="text-zinc-200 text-sm">${escapeHtml(a.description)}</div>
                            <div class="flex items-center gap-3 mt-2 text-zinc-500 text-xs">
                                <span class="flex items-center gap-1">
                                    <i class="ph ph-user"></i>
                                    ${a.performed_by_name || 'System'}
                                </span>
                                <span class="flex items-center gap-1">
                                    <i class="ph ph-calendar"></i>
                                    ${dateStr}
                                </span>
                                <span class="flex items-center gap-1">
                                    <i class="ph ph-clock"></i>
                                    ${timeStr}
                                </span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            if (reset) {
                container.innerHTML = html;
            } else {
                container.innerHTML += html;
            }

            // Show/hide load more button
            if (data.length >= historyLimit) {
                document.getElementById('history-load-more')?.classList.remove('hidden');
            } else {
                document.getElementById('history-load-more')?.classList.add('hidden');
            }

            historyOffset += data.length;
        }

        function filterHistory() {
            loadFullHistory(true);
        }

        function loadMoreHistory() {
            loadFullHistory(false);
        }

        function getActivityColor(action) {
            const colors = {
                'task_completed': 'bg-emerald-500/20 text-emerald-400',
                'milestone_completed': 'bg-violet-500/20 text-violet-400',
                'products_shared': 'bg-cyan-500/20 text-cyan-400',
                'branding_shared': 'bg-pink-500/20 text-pink-400',
                'sales_page_shared': 'bg-blue-500/20 text-blue-400',
                'report_published': 'bg-amber-500/20 text-amber-400',
                'contract_signed': 'bg-emerald-500/20 text-emerald-400',
                'comment_added': 'bg-zinc-500/20 text-zinc-400'
            };
            return colors[action] || 'bg-zinc-700/50 text-zinc-400';
        }

        // ============================================
        // EMAIL HISTORY (Wiadomości tab)
        // ============================================
        let workflowEmails = [];

        async function loadEmailHistory() {
            if (!workflow) return;

            const { data, error } = await supabaseClient
                .from('email_messages')
                .select('*')
                .eq('to_email', workflow.customer_email)
                .eq('direction', 'outbound')
                .order('created_at', { ascending: false })
                .limit(50);

            if (error) {
                console.error('Error loading emails:', error);
                return;
            }

            workflowEmails = data || [];
            renderEmailHistory();
            renderRecentEmails();
        }

        function renderEmailHistory() {
            const container = document.getElementById('email-history-list');
            if (!container) return;

            if (workflowEmails.length === 0) {
                container.innerHTML = '<div class="text-zinc-600 text-sm text-center py-8">Brak wysłanych wiadomości</div>';
                return;
            }

            container.innerHTML = workflowEmails.map(email => {
                const date = new Date(email.created_at);
                const dateStr = date.toLocaleDateString('pl-PL', { day: 'numeric', month: 'long', year: 'numeric' });
                const timeStr = date.toLocaleTimeString('pl-PL', { hour: '2-digit', minute: '2-digit' });

                const statusConfig = {
                    'sent': { icon: 'ph-paper-plane-tilt', color: 'text-zinc-400', label: 'Wysłano' },
                    'delivered': { icon: 'ph-check', color: 'text-emerald-400', label: 'Dostarczono' },
                    'bounced': { icon: 'ph-x-circle', color: 'text-red-400', label: 'Odrzucono' },
                    'failed': { icon: 'ph-warning', color: 'text-red-400', label: 'Błąd' }
                };
                const status = statusConfig[email.status] || statusConfig['sent'];

                return `
                    <div class="p-4 bg-zinc-900/40 border border-white/5 rounded-lg">
                        <div class="flex items-start justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <i class="ph ph-envelope text-cyan-400"></i>
                                <span class="text-white font-medium text-sm">${escapeHtml(email.subject || 'Bez tematu')}</span>
                            </div>
                            <span class="flex items-center gap-1 text-xs ${status.color}">
                                <i class="ph ${status.icon}"></i>
                                ${status.label}
                            </span>
                        </div>
                        <div class="text-zinc-400 text-xs mb-3 line-clamp-2">${escapeHtml(email.body_text?.substring(0, 150) || '')}</div>
                        <div class="flex items-center gap-3 text-zinc-500 text-xs">
                            <span class="flex items-center gap-1">
                                <i class="ph ph-at"></i>
                                ${email.to_email}
                            </span>
                            <span class="flex items-center gap-1">
                                <i class="ph ph-calendar"></i>
                                ${dateStr} ${timeStr}
                            </span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderRecentEmails() {
            const container = document.getElementById('recent-emails');
            if (!container) return;

            if (workflowEmails.length === 0) {
                container.innerHTML = '<div class="text-[#444] text-[13px] py-2">Brak wysłanych wiadomości</div>';
                return;
            }

            // Show only 3 most recent
            const recentEmails = workflowEmails.slice(0, 3);

            container.innerHTML = recentEmails.map(email => {
                const timeAgo = formatTimeAgo(new Date(email.created_at));
                const statusConfig = {
                    'sent': { icon: 'ph-paper-plane-tilt', bg: 'bg-[#111]', color: 'text-[#555]' },
                    'delivered': { icon: 'ph-check', bg: 'bg-emerald-500/10', color: 'text-emerald-400' },
                    'bounced': { icon: 'ph-x-circle', bg: 'bg-red-500/10', color: 'text-red-400' },
                    'failed': { icon: 'ph-warning', bg: 'bg-red-500/10', color: 'text-red-400' }
                };
                const status = statusConfig[email.status] || statusConfig['sent'];

                return `
                    <div class="flex items-center gap-3 py-3 border-b border-[#1a1a1a] last:border-0 group">
                        <div class="w-8 h-8 rounded-lg ${status.bg} border border-[#1a1a1a] flex items-center justify-center flex-shrink-0 group-hover:border-[#262626] transition-colors">
                            <i class="ph ${status.icon} text-[13px] ${status.color}"></i>
                        </div>
                        <div class="flex-1 min-w-0 pt-0.5">
                            <div class="text-[#ccc] text-[13px] truncate">${escapeHtml(email.subject || 'Bez tematu')}</div>
                            <div class="text-[#555] text-[11px] mt-1">${timeAgo}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderRecentComments() {
            const container = document.getElementById('recent-comments');
            if (!container) return;

            if (comments.length === 0) {
                container.innerHTML = '<div class="text-[#444] text-[13px] py-2">Brak komentarzy</div>';
                return;
            }

            // Show only 3 most recent
            const recentComments = comments.slice(0, 3);

            container.innerHTML = recentComments.map(c => {
                const isClient = c.author_type === 'client';
                const timeAgo = formatTimeAgo(new Date(c.created_at));
                const icon = isClient ? 'ph-user' : 'ph-user-circle-gear';
                const bgColor = isClient ? 'bg-amber-500/10' : 'bg-cyan-500/10';
                const iconColor = isClient ? 'text-amber-400' : 'text-cyan-400';
                const truncatedContent = c.content.length > 60 ? c.content.substring(0, 60) + '...' : c.content;

                return `
                    <div class="flex items-start gap-3 py-2 border-b border-[#1a1a1a] last:border-0">
                        <div class="w-6 h-6 rounded-full ${bgColor} flex items-center justify-center flex-shrink-0 mt-0.5">
                            <i class="ph ${icon} text-[11px] ${iconColor}"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="text-[#ccc] text-[12px] leading-relaxed">${escapeHtml(truncatedContent)}</div>
                            <div class="text-[#555] text-[10px] mt-1">${timeAgo}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ============================================
        // STATUS CHECKLIST
        // ============================================
        async function renderStatusChecklist() {
            const container = document.getElementById('status-checklist');
            if (!container || !workflow) return;

            const isStarter = workflow.offer_name?.toLowerCase().includes('starter');

            // Check if reports are published
            const { data: reports } = await supabaseClient
                .from('workflow_reports')
                .select('id, visible_to_client, type')
                .eq('workflow_id', workflow.id)
                .in('type', ['report_pdf', 'report_infographic', 'report_presentation', 'report_video']);

            const hasPublishedReports = (reports || []).some(r => r.visible_to_client);
            const hasAnyReports = (reports || []).length > 0;

            const items = [];

            // Contract (skip for Starter)
            if (!isStarter) {
                const contractDone = workflow.contract_status === 'signed';
                items.push({
                    label: 'Umowa',
                    done: contractDone,
                    inProgress: workflow.contract_status && !['pending_data', 'signed'].includes(workflow.contract_status),
                    icon: 'ph-file-text'
                });
            }

            // Products
            items.push({
                label: 'Produkty',
                done: !!workflow.selected_product_id,
                inProgress: !!workflow.products_shared_at && !workflow.selected_product_id,
                icon: 'ph-package'
            });

            // Reports - check if any are published to client
            items.push({
                label: 'Raporty',
                done: hasPublishedReports,
                inProgress: hasAnyReports && !hasPublishedReports,
                icon: 'ph-chart-bar'
            });

            // Branding
            items.push({
                label: 'Branding',
                done: !!workflow.branding_shared_at,
                icon: 'ph-paint-brush'
            });

            // Sales Page
            items.push({
                label: 'Strona',
                done: !!workflow.sales_page_shared_at,
                icon: 'ph-globe'
            });

            container.innerHTML = items.map(item => {
                let containerClass = 'bg-[#111] border-[#1a1a1a]';
                let iconBgClass = 'bg-[#1a1a1a]';
                let iconClass = 'text-[#444]';
                let textClass = 'text-[#666]';
                let statusIndicator = '';

                if (item.done) {
                    containerClass = 'bg-emerald-500/5 border-emerald-500/20';
                    iconBgClass = 'bg-emerald-500/10';
                    iconClass = 'text-emerald-400';
                    textClass = 'text-emerald-400';
                    statusIndicator = '<i class="ph-fill ph-check-circle text-emerald-400 text-[12px]"></i>';
                } else if (item.inProgress) {
                    containerClass = 'bg-amber-500/5 border-amber-500/20';
                    iconBgClass = 'bg-amber-500/10';
                    iconClass = 'text-amber-400';
                    textClass = 'text-amber-400';
                    statusIndicator = '<i class="ph ph-clock text-amber-400 text-[12px]"></i>';
                }

                return `
                    <div class="flex items-center gap-2 p-2.5 rounded-lg border ${containerClass} transition-colors">
                        <div class="w-6 h-6 rounded-md ${iconBgClass} flex items-center justify-center flex-shrink-0">
                            <i class="ph ${item.icon} ${iconClass} text-[12px]"></i>
                        </div>
                        <span class="text-[12px] font-medium ${textClass} flex-1">${item.label}</span>
                        ${statusIndicator}
                    </div>
                `;
            }).join('');
        }

        // ============================================
        // PENDING ACTIONS
        // ============================================
        function checkPendingActions() {
            if (!workflow) return;

            const actions = [];
            const isStarter = workflow.offer_name?.toLowerCase().includes('starter');

            // Unsigned contract (not for Starter)
            if (!isStarter && workflow.contract_status !== 'signed') {
                if (workflow.contract_status === 'pending_signature') {
                    actions.push({
                        icon: 'ph-pen',
                        text: 'Klient nie podpisał jeszcze umowy',
                        color: 'text-amber-400'
                    });
                } else if (workflow.contract_status === 'pending_data') {
                    actions.push({
                        icon: 'ph-user',
                        text: 'Klient nie wypełnił danych do umowy',
                        color: 'text-amber-400'
                    });
                }
            }

            // Products not shared
            if (!workflow.products_shared_at) {
                actions.push({
                    icon: 'ph-package',
                    text: 'Produkty nie zostały jeszcze udostępnione',
                    color: 'text-zinc-400',
                    action: "switchTab('produkty')",
                    actionLabel: 'Udostępnij'
                });
            } else if (!workflow.selected_product_id) {
                actions.push({
                    icon: 'ph-package',
                    text: 'Klient nie wybrał jeszcze produktu',
                    color: 'text-amber-400'
                });
            }

            // Branding not shared
            if (!workflow.branding_shared_at) {
                actions.push({
                    icon: 'ph-paint-brush',
                    text: 'Branding nie został jeszcze udostępniony',
                    color: 'text-zinc-400'
                });
            }

            // Sales page not shared
            if (!workflow.sales_page_shared_at && workflow.sales_page_url) {
                actions.push({
                    icon: 'ph-globe',
                    text: 'Strona sprzedażowa gotowa, ale nie udostępniona',
                    color: 'text-amber-400',
                    action: "switchTab('strona')",
                    actionLabel: 'Udostępnij'
                });
            }

            const container = document.getElementById('pending-actions-list');
            const card = document.getElementById('pending-actions-card');
            if (!container || !card) return;

            if (actions.length === 0) {
                card.classList.add('hidden');
                return;
            }

            card.classList.remove('hidden');
            container.innerHTML = actions.map(a => `
                <div class="flex items-center gap-3 py-2.5 px-3 rounded-lg bg-[#111]/50 border border-amber-500/10">
                    <div class="w-7 h-7 rounded-lg bg-amber-500/10 flex items-center justify-center flex-shrink-0">
                        <i class="ph ${a.icon} text-amber-400 text-[13px]"></i>
                    </div>
                    <span class="text-[#999] text-[13px] flex-1">${a.text}</span>
                    ${a.action ? `<button onclick="${a.action}" class="h-7 px-3 text-[12px] font-medium text-amber-400 hover:text-white hover:bg-amber-500/20 rounded-lg transition-colors flex items-center gap-1">${a.actionLabel} <i class="ph ph-arrow-right text-[10px]"></i></button>` : ''}
                </div>
            `).join('');
        }

        // ============================================
        // CRM LEAD LINK
        // ============================================
        async function loadCrmLeadLink() {
            if (!workflow || !workflow.customer_email) return;

            const { data: lead } = await supabaseClient
                .from('leads')
                .select('id')
                .eq('email', workflow.customer_email)
                .single();

            if (lead) {
                const link = document.getElementById('crm-lead-link');
                if (link) {
                    const basePath = (location.hostname === 'localhost' || location.hostname === '127.0.0.1')
                        ? '/leads.html' : '/leads';
                    link.href = `${basePath}?id=${lead.id}`;
                    link.classList.remove('hidden');
                }
            }
        }

        // ============================================
        // CLIENT ENGAGEMENT
        // ============================================
        async function loadClientEngagement() {
            if (!workflow) return;

            // Load all visits to count unique sessions (visits separated by 30+ min)
            const { data: accessLogs } = await supabaseClient
                .from('workflow_access_log')
                .select('accessed_at')
                .eq('workflow_id', workflow.id)
                .order('accessed_at', { ascending: false });

            // Count unique sessions (visits separated by at least 30 minutes)
            let sessionCount = 0;
            let lastVisitTime = null;
            const SESSION_GAP_MS = 30 * 60 * 1000; // 30 minutes

            if (accessLogs && accessLogs.length > 0) {
                // Sort ascending for session counting
                const sortedLogs = [...accessLogs].sort((a, b) =>
                    new Date(a.accessed_at) - new Date(b.accessed_at)
                );

                sortedLogs.forEach(log => {
                    const visitTime = new Date(log.accessed_at).getTime();
                    if (!lastVisitTime || (visitTime - lastVisitTime) > SESSION_GAP_MS) {
                        sessionCount++;
                    }
                    lastVisitTime = visitTime;
                });

                // Last visit display (most recent)
                const lastVisit = formatTimeAgo(new Date(accessLogs[0].accessed_at));
                document.getElementById('last-visit').textContent = lastVisit;
            } else {
                document.getElementById('last-visit').textContent = 'Brak wizyt';
            }

            // Update visit count (unique sessions)
            document.getElementById('access-count').textContent = sessionCount;

            // Load client messages count
            const { count: msgCount } = await supabaseClient
                .from('workflow_comments')
                .select('id', { count: 'exact', head: true })
                .eq('workflow_id', workflow.id)
                .eq('author_type', 'client');

            document.getElementById('client-messages-count').textContent = msgCount || 0;
        }

        async function openVisitsModal() {
            if (!workflow) return;
            document.getElementById('visits-modal').classList.remove('hidden');
            document.getElementById('visits-modal-content').innerHTML = '<div class="text-zinc-500 text-sm text-center py-8"><i class="ph ph-spinner animate-spin mr-2"></i>Ładowanie...</div>';

            // Load all visits
            const { data: visits, error } = await supabaseClient
                .from('workflow_access_log')
                .select('*')
                .eq('workflow_id', workflow.id)
                .order('accessed_at', { ascending: false })
                .limit(500);

            if (error || !visits || visits.length === 0) {
                document.getElementById('visits-modal-content').innerHTML = '<div class="text-zinc-500 text-sm text-center py-8">Brak wizyt klienta</div>';
                return;
            }

            // Group visits into sessions (30 min gap = new session)
            const SESSION_GAP_MS = 30 * 60 * 1000;
            const sessions = [];
            let currentSession = null;

            // Sort chronologically for session detection
            const sortedVisits = [...visits].sort((a, b) =>
                new Date(a.accessed_at) - new Date(b.accessed_at)
            );

            sortedVisits.forEach(v => {
                const visitTime = new Date(v.accessed_at).getTime();
                if (!currentSession || (visitTime - currentSession.endTime) > SESSION_GAP_MS) {
                    currentSession = {
                        startTime: visitTime,
                        endTime: visitTime,
                        visits: [v],
                        userAgent: v.user_agent
                    };
                    sessions.push(currentSession);
                } else {
                    currentSession.endTime = visitTime;
                    currentSession.visits.push(v);
                }
            });

            // Reverse to show most recent first
            sessions.reverse();

            // Group sessions by day
            const sessionsByDay = {};
            sessions.forEach(s => {
                const date = new Date(s.startTime);
                const dayKey = date.toLocaleDateString('pl-PL', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                if (!sessionsByDay[dayKey]) sessionsByDay[dayKey] = [];
                sessionsByDay[dayKey].push(s);
            });

            let html = `<div class="text-xs text-zinc-400 mb-4">Łącznie ${sessions.length} sesji (${visits.length} odsłon)</div>`;

            for (const [day, daySessions] of Object.entries(sessionsByDay)) {
                html += `<div class="mb-4">
                    <div class="text-xs text-zinc-500 font-medium uppercase tracking-wider mb-2">${day}</div>
                    <div class="space-y-2">`;

                daySessions.forEach(s => {
                    const startTime = new Date(s.startTime).toLocaleTimeString('pl-PL', { hour: '2-digit', minute: '2-digit' });
                    const endTime = new Date(s.endTime).toLocaleTimeString('pl-PL', { hour: '2-digit', minute: '2-digit' });
                    const duration = Math.round((s.endTime - s.startTime) / 60000);
                    const durationText = duration > 0 ? `${duration} min` : '<1 min';
                    const pageViews = s.visits.length;

                    const device = s.userAgent?.includes('Mobile') ? 'ph-device-mobile' : 'ph-desktop';
                    const isMobile = s.userAgent?.includes('Mobile');
                    const browser = s.userAgent?.includes('Samsung') ? 'Samsung Browser' :
                                   s.userAgent?.includes('Chrome') ? 'Chrome' :
                                   s.userAgent?.includes('Safari') ? 'Safari' :
                                   s.userAgent?.includes('Firefox') ? 'Firefox' : 'Przeglądarka';

                    html += `<div class="flex items-center gap-3 py-2.5 px-3 bg-zinc-800/50 rounded-lg">
                        <div class="w-8 h-8 rounded-full ${isMobile ? 'bg-cyan-500/10' : 'bg-violet-500/10'} flex items-center justify-center">
                            <i class="ph ${device} ${isMobile ? 'text-cyan-400' : 'text-violet-400'}"></i>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center gap-2">
                                <span class="text-white text-sm font-medium">${startTime}${duration > 0 ? ` - ${endTime}` : ''}</span>
                                <span class="text-zinc-600 text-xs">${durationText}</span>
                            </div>
                            <div class="text-zinc-500 text-xs">${browser} · ${pageViews} odsłon</div>
                        </div>
                    </div>`;
                });

                html += `</div></div>`;
            }

            document.getElementById('visits-modal-content').innerHTML = html;
        }

        function closeVisitsModal() {
            document.getElementById('visits-modal').classList.add('hidden');
        }

        async function loadLastAdminAction() {
            if (!workflow) return;

            // Load last admin activity (not system actions)
            const { data: activities } = await supabaseClient
                .from('workflow_activities')
                .select('*')
                .eq('workflow_id', workflow.id)
                .not('performed_by_name', 'is', null)
                .neq('performed_by_name', 'System')
                .order('created_at', { ascending: false })
                .limit(1);

            const container = document.getElementById('last-admin-action');
            if (!container) return;

            if (activities && activities.length > 0) {
                const activity = activities[0];
                const timeAgo = formatTimeAgo(new Date(activity.created_at));
                const iconClass = getActivityIcon(activity.action);
                const iconColor = getActivityColor(activity.action);

                document.getElementById('last-action-icon').className = `ph ${iconClass} ${iconColor} text-[12px] mt-0.5`;
                document.getElementById('last-action-text').textContent = activity.description;
                document.getElementById('last-action-text').title = activity.description;
                document.getElementById('last-action-time').textContent = timeAgo;
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }
        }

        // ============================================
        // QUICK ACTIONS
        // ============================================
        function openClientPreview() {
            if (!workflow) return;
            const url = `https://crm.tomekniedzwiecki.pl/projekt/${workflow.unique_token}?admin_preview=1`;
            window.open(url, '_blank');
        }

        async function copyClientLink() {
            if (!workflow) return;
            const url = `https://crm.tomekniedzwiecki.pl/projekt/${workflow.unique_token}`;

            try {
                await navigator.clipboard.writeText(url);
                showToast('Link skopiowany do schowka');
            } catch (err) {
                const textArea = document.createElement('textarea');
                textArea.value = url;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showToast('Link skopiowany do schowka');
            }
        }

        async function copyWorkflowId() {
            if (!workflow) return;
            try {
                await navigator.clipboard.writeText(workflow.id);
                showToast('ID skopiowane');
            } catch (err) {
                const textArea = document.createElement('textarea');
                textArea.value = workflow.id;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showToast('ID skopiowane');
            }
        }

        async function downloadProductPDF() {
            if (!workflow) return;

            if (!workflow.selected_product_id) {
                showToast('Brak wybranego produktu', 'warning');
                return;
            }

            const { data: product, error: prodErr } = await supabaseClient
                .from('workflow_products')
                .select('report_screenshot_url')
                .eq('id', workflow.selected_product_id)
                .maybeSingle();

            if (prodErr || !product?.report_screenshot_url) {
                showToast('Brak PDF produktu', 'warning');
                return;
            }

            window.open(product.report_screenshot_url, '_blank');
            showToast('PDF otwarty');
        }

        async function copyAIPrompt(templateKey) {
            if (!workflow) return;

            // Fetch template from database
            const { data: template, error } = await supabaseClient
                .from('ai_prompt_templates')
                .select('content')
                .eq('template_key', templateKey)
                .maybeSingle();

            if (error || !template || !template.content) {
                showToast('Brak szablonu - dodaj go w Ustawieniach', 'warning');
                return;
            }

            // Replace variables
            let content = template.content;
            content = content.replace(/\{\{customer_name\}\}/g, workflow.customer_name || workflow.customer_company || 'Klient');
            content = content.replace(/\{\{workflow_id\}\}/g, workflow.id);
            content = content.replace(/\{\{product_name\}\}/g, workflow.offer_name || 'Produkt');

            try {
                await navigator.clipboard.writeText(content);
                showToast('Prompt skopiowany');
            } catch (err) {
                // Fallback for older browsers or when clipboard API fails
                const textArea = document.createElement('textarea');
                textArea.value = content;
                textArea.style.position = 'fixed';
                textArea.style.left = '-9999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    showToast('Prompt skopiowany');
                } catch (e) {
                    showToast('Nie udało się skopiować', 'error');
                }
                document.body.removeChild(textArea);
            }
        }

        function showToast(message, type = 'success') {
            const existing = document.getElementById('toast-notification');
            if (existing) existing.remove();

            const icons = { success: 'ph-check-circle text-emerald-400', error: 'ph-x-circle text-red-400', warning: 'ph-warning text-amber-400' };
            const toast = document.createElement('div');
            toast.id = 'toast-notification';
            toast.className = 'fixed bottom-6 right-6 bg-zinc-800 border border-white/10 text-white px-4 py-3 rounded-lg shadow-xl z-50 flex items-center gap-2 animate-enter';
            toast.innerHTML = `<i class="ph ${icons[type] || icons.success}"></i> ${message}`;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(10px)';
                toast.style.transition = 'all 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function getActivityIcon(action) {
            const icons = {
                'task_completed': 'ph-check',
                'task_uncompleted': 'ph-x',
                'milestone_completed': 'ph-flag',
                'status_changed': 'ph-arrows-clockwise',
                'client_info_updated': 'ph-user',
                'products_shared': 'ph-package',
                'branding_shared': 'ph-paint-brush',
                'branding_updated': 'ph-paint-brush',
                'sales_page_shared': 'ph-globe',
                'report_published': 'ph-chart-bar',
                'report_created': 'ph-chart-bar',
                'contract_signed': 'ph-file-text',
                'product_selected': 'ph-check-circle',
                'comment_added': 'ph-chat-circle'
            };
            return icons[action] || 'ph-lightning';
        }

        function formatTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'przed chwilą';
            if (diffMins < 60) return `${diffMins} min temu`;
            if (diffHours < 24) return `${diffHours} godz. temu`;
            if (diffDays < 7) return `${diffDays} dni temu`;
            return date.toLocaleDateString('pl-PL', { day: 'numeric', month: 'short' });
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function checkAuth() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
                window.location.href = Sidebar.getLoginPath();
                return null;
            }
            Sidebar.setUserEmail(session.user.email.split('@')[0]);
            await loadTeamMembers(session.user.id);
            return session;
        }

        async function loadTeamMembers(userId) {
            const { data, error } = await supabaseClient
                .from('team_members')
                .select('*');

            if (error) {
                console.error('Error loading team members:', error);
                return;
            }

            teamMembers = data || [];
            currentMember = teamMembers.find(m => m.user_id === userId);
            isAdmin = currentMember?.role === 'admin';

            if (currentMember) {
                Sidebar.setUserName(currentMember.name);
                Sidebar.setUserColor(currentMember.color);
                Sidebar.setupProfileClick();
            }

            Sidebar.showAdminNav(isAdmin);
        }

        function getWorkflowId() {
            const params = new URLSearchParams(window.location.search);
            return params.get('id');
        }

        async function loadWorkflow() {
            const workflowId = getWorkflowId();
            if (!workflowId) {
                window.location.href = '/tn-workflow/workflows';
                return;
            }

            // Load workflow
            const { data: workflowData, error: workflowError } = await supabaseClient
                .from('workflows')
                .select('*')
                .eq('id', workflowId)
                .single();

            if (workflowError || !workflowData) {
                console.error('Error loading workflow:', workflowError);
                window.location.href = '/tn-workflow/workflows';
                return;
            }

            workflow = workflowData;

            // Load milestones
            const { data: milestonesData } = await supabaseClient
                .from('workflow_milestones')
                .select('*')
                .eq('workflow_id', workflowId)
                .order('milestone_index');

            milestones = milestonesData || [];

            // Load tasks
            const { data: tasksData } = await supabaseClient
                .from('workflow_tasks')
                .select('*')
                .eq('workflow_id', workflowId)
                .order('task_index');

            tasks = tasksData || [];

            // Load access count
            const { count: accessCount } = await supabaseClient
                .from('workflow_access_log')
                .select('*', { count: 'exact', head: true })
                .eq('workflow_id', workflowId);

            workflow.accessCount = accessCount || 0;

            renderWorkflow();
            updateNavChecks();
            loadActivities();

            // New dashboard functions
            renderStatusChecklist();
            checkPendingActions();
            loadCrmLeadLink();
            loadClientEngagement();
            loadLastAdminAction();
            loadEmailHistory();
        }

        async function updateNavChecks() {
            try {
                const toggle = (id, show) => {
                    const el = document.getElementById(id);
                    if (el) el.classList.toggle('hidden', !show);
                };

                // These don't need DB queries
                toggle('nav-check-dokumenty', workflow.contract_status === 'signed');
                toggle('nav-check-produkty', !!workflow.products_shared_at);
                toggle('nav-check-strona', !!workflow.sales_page_shared_at);

                // These need DB queries
                const [brandRes, repsRes, videoRes, takedropRes] = await Promise.all([
                    supabaseClient.from('workflow_branding').select('id', { count: 'exact', head: true }).eq('workflow_id', workflow.id),
                    supabaseClient.from('workflow_reports').select('workflow_id, visible_to_client, type').eq('workflow_id', workflow.id).in('type', ['report_pdf', 'report_infographic', 'report_presentation', 'report_video']),
                    supabaseClient.from('workflow_video').select('*').eq('workflow_id', workflow.id).maybeSingle(),
                    supabaseClient.from('workflow_takedrop').select('is_active').eq('workflow_id', workflow.id).maybeSingle()
                ]);

                // Store takedrop status for auto-collapse
                if (!takeDropData && takedropRes.data) {
                    takeDropData = takedropRes.data;
                }

                const hasPublished = (repsRes.data || []).some(r => r.visible_to_client);
                toggle('nav-check-raporty', hasPublished);
                toggle('nav-check-branding', !!workflow.branding_shared_at);

                // Store video data for auto-collapse
                const videoData = videoRes.data;
                if (!videoAdminData && videoData) {
                    videoAdminData = videoData;
                }

                // Podsumowanie check - green when stage accepted
                const navCheckPodsumowanie = document.getElementById('nav-check-podsumowanie');
                const navCheckPodsumowanieIcon = document.getElementById('nav-check-podsumowanie-icon');
                if (videoData?.stage_accepted) {
                    toggle('nav-check-podsumowanie', true);
                    if (navCheckPodsumowanieIcon) navCheckPodsumowanieIcon.className = 'ph-fill ph-check-circle text-emerald-400 text-sm';
                } else {
                    toggle('nav-check-podsumowanie', false);
                }

                // Scenariusze check - green when scenarios exist
                const scenarios = videoData?.video_scenarios || [];
                const navCheckScenariusze = document.getElementById('nav-check-scenariusze');
                const navCheckScenariuszeIcon = document.getElementById('nav-check-scenariusze-icon');
                if (scenarios.length > 0) {
                    toggle('nav-check-scenariusze', true);
                    if (navCheckScenariuszeIcon) navCheckScenariuszeIcon.className = 'ph-fill ph-check-circle text-emerald-400 text-sm';
                } else {
                    toggle('nav-check-scenariusze', false);
                }

                // Profile check - green when all 3, amber when partial
                const profiles = videoData?.social_profiles || {};
                const profileCount = [profiles.tiktok, profiles.youtube, profiles.instagram].filter(Boolean).length;
                const navCheckProfile = document.getElementById('nav-check-profile');
                const navCheckProfileIcon = document.getElementById('nav-check-profile-icon');
                if (profileCount === 3) {
                    toggle('nav-check-profile', true);
                    if (navCheckProfileIcon) navCheckProfileIcon.className = 'ph-fill ph-check-circle text-emerald-400 text-sm';
                } else if (profileCount > 0) {
                    toggle('nav-check-profile', true);
                    if (navCheckProfileIcon) navCheckProfileIcon.className = 'ph-fill ph-warning-circle text-amber-400 text-sm';
                } else {
                    toggle('nav-check-profile', false);
                }

                // Nagrania - show count instead of checkmark
                const videoLinks = videoData?.video_links || [];
                const navCheckNagraniaCount = document.getElementById('nav-check-nagrania-count');
                if (navCheckNagraniaCount) {
                    if (videoLinks.length > 0) {
                        navCheckNagraniaCount.textContent = videoLinks.length;
                        navCheckNagraniaCount.className = 'text-[10px] text-emerald-400 font-medium';
                    } else {
                        navCheckNagraniaCount.textContent = '';
                    }
                }

                // Auto-collapse previous stages if later stages are active
                autoCollapseStages();
            } catch (e) {
                console.error('updateNavChecks error:', e);
            }
        }

        function formatPrice(price) {
            return new Intl.NumberFormat('pl-PL', {
                style: 'currency',
                currency: 'PLN',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(price || 0);
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('pl-PL', { day: 'numeric', month: 'short', year: 'numeric' });
        }

        function formatDeadline(deadline) {
            if (!deadline) return '-';
            const date = new Date(deadline);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const deadlineDate = new Date(deadline);
            deadlineDate.setHours(0, 0, 0, 0);

            const diffDays = Math.ceil((deadlineDate - today) / (1000 * 60 * 60 * 24));

            if (diffDays < 0) {
                return `<span class="text-red-400">${Math.abs(diffDays)} dni temu</span>`;
            } else if (diffDays === 0) {
                return `<span class="text-amber-400">dzisiaj</span>`;
            } else if (diffDays <= 3) {
                return `<span class="text-amber-400">za ${diffDays} dni</span>`;
            }
            return formatDate(deadline);
        }

        function getStatusBadge(status) {
            const styles = {
                active: 'bg-emerald-500/10 text-emerald-400 border border-emerald-500/20',
                completed: 'bg-blue-500/10 text-blue-400 border border-blue-500/20',
                paused: 'bg-amber-500/10 text-amber-400 border border-amber-500/20',
                cancelled: 'bg-red-500/10 text-red-400 border border-red-500/20'
            };
            const labels = {
                active: 'Aktywny',
                completed: 'Ukonczony',
                paused: 'Wstrzymany',
                cancelled: 'Anulowany'
            };
            return { style: styles[status] || styles.active, label: labels[status] || status };
        }

        // ============================================
        // CLIENT INFO EDITING
        // ============================================
        function toggleEditClientInfo() {
            const viewEl = document.getElementById('client-info-view');
            const editEl = document.getElementById('client-info-edit');
            const isEditing = !editEl.classList.contains('hidden');

            if (isEditing) {
                // Cancel - switch back to view
                editEl.classList.add('hidden');
                viewEl.classList.remove('hidden');
            } else {
                // Switch to edit mode - populate fields
                document.getElementById('edit-customer-name').value = workflow.customer_name || '';
                document.getElementById('edit-customer-email').value = workflow.customer_email || '';
                document.getElementById('edit-customer-company').value = workflow.customer_company || '';
                document.getElementById('edit-customer-phone').value = workflow.customer_phone || '';
                viewEl.classList.add('hidden');
                editEl.classList.remove('hidden');
                document.getElementById('edit-customer-email').focus();
            }
        }

        async function saveClientInfo() {
            const newName = document.getElementById('edit-customer-name').value.trim();
            const newEmail = document.getElementById('edit-customer-email').value.trim();
            const newCompany = document.getElementById('edit-customer-company').value.trim();
            const newPhone = document.getElementById('edit-customer-phone').value.trim();

            if (!newEmail) {
                alert('Email jest wymagany');
                return;
            }

            const updates = {
                customer_name: newName || null,
                customer_email: newEmail,
                customer_company: newCompany || null,
                customer_phone: newPhone || null
            };

            const { error } = await supabaseClient
                .from('workflows')
                .update(updates)
                .eq('id', workflow.id);

            if (error) {
                console.error('Error updating client info:', error);
                alert('Nie udalo sie zapisac zmian');
                return;
            }

            // Log activity
            logActivity('client_info_updated', 'Zaktualizowano dane klienta', {
                changes: updates
            });

            // Update local state
            workflow.customer_name = updates.customer_name;
            workflow.customer_email = updates.customer_email;
            workflow.customer_company = updates.customer_company;
            workflow.customer_phone = updates.customer_phone;

            // Re-render and switch back to view
            renderWorkflow();
            document.getElementById('client-info-edit').classList.add('hidden');
            document.getElementById('client-info-view').classList.remove('hidden');
        }

        function getResponsibleBadge(responsible) {
            const labels = { team: 'TN', client: 'Klient', shared: 'Wspolne' };
            return `<span class="responsible-badge responsible-${responsible}">${labels[responsible] || responsible}</span>`;
        }

        function renderWorkflow() {
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');

            const customerDisplay = workflow.customer_name || workflow.customer_company || workflow.customer_email.split('@')[0];

            // Header
            document.getElementById('breadcrumb-name').textContent = customerDisplay;

            // Customer info
            document.getElementById('customer-name').textContent = customerDisplay;
            // Link email to lead if found (non-blocking)
            document.getElementById('customer-email').textContent = workflow.customer_email || '-';
            if (workflow.customer_email) {
                supabaseClient.from('leads').select('id').eq('email', workflow.customer_email).maybeSingle().then(({ data: leadMatch }) => {
                    if (leadMatch) {
                        document.getElementById('customer-email').innerHTML = `<a href="/lead?id=${leadMatch.id}" class="text-zinc-500 hover:text-blue-400 transition-colors">${workflow.customer_email}</a>`;
                    }
                });
            }
            document.getElementById('customer-company').textContent = workflow.customer_company || '-';
            document.getElementById('customer-phone').textContent = workflow.customer_phone || '-';
            document.getElementById('workflow-id-display').textContent = workflow.id || '-';
            document.getElementById('offer-name').textContent = workflow.offer_name;
            document.getElementById('amount').textContent = formatPrice(workflow.amount);
            document.getElementById('started-at').textContent = formatDate(workflow.started_at);
            document.getElementById('access-count').textContent = workflow.accessCount;

            // Status badge
            const statusInfo = getStatusBadge(workflow.status);
            const statusBadge = document.getElementById('status-badge');
            statusBadge.className = `px-3 py-1 rounded-lg text-xs font-medium ${statusInfo.style}`;
            statusBadge.textContent = statusInfo.label;

            // Password status
            const hasPassword = !!workflow.client_password_hash;
            document.getElementById('password-status').textContent = hasPassword ? 'ustawione' : 'brak hasla';
            document.getElementById('remove-password-btn').classList.toggle('hidden', !hasPassword);

            // Calculate progress
            const totalTasks = tasks.length;
            const completedTasks = tasks.filter(t => t.completed).length;
            const progressPercent = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

            document.getElementById('progress-percent').textContent = progressPercent + '%';
            document.getElementById('completed-tasks').textContent = completedTasks;
            document.getElementById('total-tasks').textContent = totalTasks;
            document.getElementById('progress-bar').style.width = progressPercent + '%';

            // Current milestone
            const currentMilestone = milestones.find(m => m.status === 'in_progress');
            document.getElementById('current-milestone').textContent = currentMilestone ? `[${milestones.indexOf(currentMilestone) + 1}/${milestones.length}] ${currentMilestone.title}` : '-';
            document.getElementById('current-deadline').innerHTML = currentMilestone ? (currentMilestone.deadline ? formatDeadline(currentMilestone.deadline) : 'Bez terminu') : '-';

            // Render milestones
            renderMilestones();

            // Load contract data to update status badge
            loadContractData();

            // Hide Dokumenty tab for Budowa sklepu starter
            const STARTER_OFFER_ID = '6ee10c3a-f8c7-409e-8570-8eff29e2b759';
            const dokumentyBtns = document.querySelectorAll('[data-tab="dokumenty"]');
            dokumentyBtns.forEach(btn => {
                btn.style.display = workflow.offer_id === STARTER_OFFER_ID ? 'none' : '';
            });
        }

        function renderMilestones() {
            const container = document.getElementById('milestones-container');

            container.innerHTML = milestones.map((milestone, index) => {
                const milestoneTasks = tasks.filter(t => t.milestone_id === milestone.id);
                const completedCount = milestoneTasks.filter(t => t.completed).length;
                const totalCount = milestoneTasks.length;
                const progressPercent = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;

                const isActive = milestone.status === 'in_progress';
                const isCompleted = milestone.status === 'completed';
                const isPending = milestone.status === 'pending';

                const deliverables = milestone.deliverables || [];

                return `
                <div class="milestone-card bg-zinc-900/40 border border-white/5 rounded-lg overflow-hidden ${isActive ? 'active' : ''} ${isCompleted ? 'completed' : ''}">
                    <!-- Milestone Header -->
                    <div class="p-4 flex items-center justify-between">
                        <div class="flex items-center gap-3 flex-1 cursor-pointer" onclick="toggleMilestone('${milestone.id}')">
                            <div class="w-8 h-8 rounded-lg flex items-center justify-center text-sm font-bold ${
                                isCompleted ? 'bg-emerald-500/20 text-emerald-400' :
                                isActive ? 'bg-violet-500/20 text-violet-400' :
                                'bg-zinc-800 text-zinc-500'
                            }">
                                ${isCompleted ? '<i class="ph ph-check"></i>' : index + 1}
                            </div>
                            <div>
                                <h4 class="font-medium ${isCompleted || isActive ? 'text-white' : 'text-zinc-400'}">${milestone.title}</h4>
                                <div class="flex items-center gap-3 text-xs text-zinc-500">
                                    ${milestone.duration_days > 0 ? `
                                        <span>${milestone.duration_days} dni</span>
                                        <span>|</span>
                                        <span>${formatDate(milestone.start_date)} - ${formatDate(milestone.deadline)}</span>
                                    ` : '<span>Bez terminu</span>'}
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <button onclick="event.stopPropagation(); openEditMilestoneModal('${milestone.id}')" class="p-1.5 text-zinc-500 hover:text-violet-400 hover:bg-white/5 rounded transition-colors" title="Edytuj etap">
                                <i class="ph ph-pencil-simple text-sm"></i>
                            </button>
                            <div class="text-right hidden sm:block">
                                <div class="text-xs text-zinc-400">${completedCount}/${totalCount} zadan</div>
                                <div class="w-24 h-1.5 bg-zinc-800 rounded-full overflow-hidden mt-1">
                                    <div class="h-full rounded-full ${isCompleted ? 'bg-emerald-500' : 'bg-violet-500'}" style="width: ${progressPercent}%"></div>
                                </div>
                            </div>
                            <i class="ph ph-caret-down text-zinc-500 transition-transform milestone-chevron cursor-pointer" id="chevron-${milestone.id}" onclick="toggleMilestone('${milestone.id}')"></i>
                        </div>
                    </div>

                    <!-- Milestone Content (collapsible) -->
                    <div id="content-${milestone.id}" class="hidden border-t border-white/5">
                        ${milestone.description ? `
                            <div class="px-4 py-3 border-b border-white/5 text-zinc-400 text-sm">${milestone.description}</div>
                        ` : ''}

                        <!-- Tasks -->
                        <div class="divide-y divide-white/5">
                            ${milestoneTasks.map(task => `
                                <div class="task-row px-4 py-3 flex items-center gap-3 group">
                                    <div class="task-checkbox ${task.completed ? 'checked' : ''}" onclick="toggleTask('${task.id}', ${!task.completed})">
                                        ${task.completed ? '<i class="ph-bold ph-check text-white text-xs"></i>' : ''}
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <span class="${task.completed ? 'text-zinc-500 line-through' : 'text-zinc-200'}">${task.title}</span>
                                        ${task.notes || (task.links && task.links.length > 0) ? `
                                            <div class="flex items-center gap-2 mt-1">
                                                ${task.notes ? '<i class="ph ph-note text-amber-400 text-xs"></i>' : ''}
                                                ${task.links && task.links.length > 0 ? `<i class="ph ph-link text-cyan-400 text-xs"></i><span class="text-xs text-zinc-500">${task.links.length}</span>` : ''}
                                            </div>
                                        ` : ''}
                                    </div>
                                    ${getResponsibleBadge(task.responsible)}
                                    <button onclick="openNotesModal('${task.id}')" class="p-1.5 text-zinc-500 hover:text-white hover:bg-white/5 rounded transition-colors" title="Notatki">
                                        <i class="ph ph-note-pencil text-sm"></i>
                                    </button>
                                    <button onclick="deleteTask('${task.id}')" class="p-1.5 text-zinc-500 hover:text-red-400 hover:bg-white/5 rounded transition-colors opacity-0 group-hover:opacity-100" title="Usun zadanie">
                                        <i class="ph ph-trash text-sm"></i>
                                    </button>
                                </div>
                            `).join('')}
                        </div>

                        <!-- Add Task Button -->
                        <div class="px-4 py-3 border-t border-white/5">
                            <button onclick="openAddTaskModal('${milestone.id}')" class="text-zinc-500 hover:text-emerald-400 text-sm flex items-center gap-2 transition-colors">
                                <i class="ph ph-plus"></i>
                                Dodaj zadanie
                            </button>
                        </div>

                        <!-- Deliverables -->
                        ${deliverables.length > 0 ? `
                            <div class="px-4 py-3 border-t border-white/5 bg-zinc-900/30">
                                <div class="text-xs text-zinc-500 uppercase tracking-wider mb-2">Rezultaty etapu</div>
                                <ul class="space-y-1">
                                    ${deliverables.map(d => `
                                        <li class="flex items-center gap-2 text-sm text-zinc-400">
                                            <i class="ph ph-check-circle text-emerald-400"></i>
                                            ${d}
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        ` : ''}

                        <!-- Milestone Actions -->
                        ${isActive && !isCompleted ? `
                            <div class="px-4 py-3 border-t border-white/5 flex justify-end">
                                <button onclick="completeMilestone('${milestone.id}')" class="bg-emerald-500/10 hover:bg-emerald-500/20 text-emerald-400 px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2" ${completedCount < totalCount ? 'disabled title="Ukoncz wszystkie zadania"' : ''}>
                                    <i class="ph ph-check-circle"></i>
                                    Ukoncz etap
                                </button>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `}).join('');

            // Expand active milestone by default
            const activeMilestone = milestones.find(m => m.status === 'in_progress');
            if (activeMilestone) {
                toggleMilestone(activeMilestone.id, true);
            }
        }

        function toggleMilestone(milestoneId, forceOpen = false) {
            const content = document.getElementById(`content-${milestoneId}`);
            const chevron = document.getElementById(`chevron-${milestoneId}`);

            if (forceOpen || content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                chevron.style.transform = 'rotate(180deg)';
            } else {
                content.classList.add('hidden');
                chevron.style.transform = 'rotate(0deg)';
            }
        }

        async function toggleTask(taskId, completed) {
            const task = tasks.find(t => t.id === taskId);

            const { error } = await supabaseClient
                .from('workflow_tasks')
                .update({
                    completed,
                    completed_at: completed ? new Date().toISOString() : null,
                    completed_by: completed && currentMember ? currentMember.id : null
                })
                .eq('id', taskId);

            if (error) {
                console.error('Error updating task:', error);
                showToast('Blad aktualizacji zadania', 'error');
                return;
            }

            // Log activity
            if (task) {
                const action = completed ? 'task_completed' : 'task_uncompleted';
                const desc = completed
                    ? `Ukończono zadanie: ${task.title}`
                    : `Cofnięto ukończenie: ${task.title}`;
                logActivity(action, desc, { task_id: taskId, task_title: task.title });
            }

            // Update local state
            if (task) {
                task.completed = completed;
                task.completed_at = completed ? new Date().toISOString() : null;
            }

            renderWorkflow();
        }

        async function completeMilestone(milestoneId) {
            const milestone = milestones.find(m => m.id === milestoneId);
            if (!milestone) return;

            const milestoneTasks = tasks.filter(t => t.milestone_id === milestoneId);
            const allCompleted = milestoneTasks.every(t => t.completed);

            if (!allCompleted) {
                showToast('Ukoncz wszystkie zadania przed zakonczeniem etapu', 'warning');
                return;
            }

            // Update milestone status
            const { error } = await supabaseClient
                .from('workflow_milestones')
                .update({
                    status: 'completed',
                    completed_at: new Date().toISOString()
                })
                .eq('id', milestoneId);

            if (error) {
                console.error('Error completing milestone:', error);
                showToast('Blad aktualizacji etapu', 'error');
                return;
            }

            // Find next milestone and set it to in_progress
            const currentIndex = milestones.findIndex(m => m.id === milestoneId);
            const nextMilestone = milestones[currentIndex + 1];

            if (nextMilestone) {
                await supabaseClient
                    .from('workflow_milestones')
                    .update({
                        status: 'in_progress',
                        started_at: new Date().toISOString()
                    })
                    .eq('id', nextMilestone.id);
            } else {
                // All milestones completed - mark workflow as completed
                await supabaseClient
                    .from('workflows')
                    .update({
                        status: 'completed',
                        completed_at: new Date().toISOString()
                    })
                    .eq('id', workflow.id);
            }

            // Log activity
            const milestoneIndex = milestones.findIndex(m => m.id === milestoneId);
            logActivity('milestone_completed', `Ukończono etap ${milestoneIndex + 1}: ${milestone.title}`, {
                milestone_id: milestoneId,
                milestone_title: milestone.title,
                milestone_index: milestoneIndex
            });

            showToast('Etap ukonczony!', 'success');
            await loadWorkflow();
        }

        async function changeStatus(newStatus) {
            const oldStatus = workflow.status;
            const statusLabels = {
                active: 'Aktywny',
                completed: 'Ukończony',
                paused: 'Wstrzymany',
                cancelled: 'Anulowany'
            };

            const { error } = await supabaseClient
                .from('workflows')
                .update({
                    status: newStatus,
                    completed_at: newStatus === 'completed' ? new Date().toISOString() : null
                })
                .eq('id', workflow.id);

            if (error) {
                console.error('Error changing status:', error);
                showToast('Blad zmiany statusu', 'error');
                return;
            }

            // Log activity
            logActivity('status_changed', `Zmieniono status: ${statusLabels[oldStatus] || oldStatus} → ${statusLabels[newStatus] || newStatus}`, {
                old_status: oldStatus,
                new_status: newStatus
            });

            closeActionsMenu();
            showToast('Status zmieniony', 'success');
            await loadWorkflow();
        }

        // No-op for backwards compatibility
        function closeActionsMenu() {}

        // Password Modal
        function openPasswordModal() {
            closeActionsMenu();
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-password').value = '';
            document.getElementById('password-modal').classList.remove('hidden');
        }

        function closePasswordModal() {
            document.getElementById('password-modal').classList.add('hidden');
        }

        async function savePassword() {
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;

            if (newPassword && newPassword !== confirmPassword) {
                showToast('Hasla nie sa identyczne', 'error');
                return;
            }

            let passwordHash = null;
            if (newPassword) {
                passwordHash = dcodeIO.bcrypt.hashSync(newPassword, 10);
            }

            const { error } = await supabaseClient
                .from('workflows')
                .update({ client_password_hash: passwordHash })
                .eq('id', workflow.id);

            if (error) {
                console.error('Error saving password:', error);
                showToast('Blad zapisywania hasla', 'error');
                return;
            }

            workflow.client_password_hash = passwordHash;
            closePasswordModal();
            showToast(newPassword ? 'Haslo ustawione' : 'Haslo usuniete', 'success');
            renderWorkflow();
        }

        async function removePassword() {
            const { error } = await supabaseClient
                .from('workflows')
                .update({ client_password_hash: null })
                .eq('id', workflow.id);

            if (error) {
                console.error('Error removing password:', error);
                showToast('Blad usuwania hasla', 'error');
                return;
            }

            workflow.client_password_hash = null;
            closePasswordModal();
            showToast('Haslo usuniete', 'success');
            renderWorkflow();
        }

        // Notes Modal
        function openNotesModal(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            document.getElementById('notes-task-id').value = taskId;
            document.getElementById('notes-modal-title').textContent = task.title;
            document.getElementById('task-notes').value = task.notes || '';
            currentTaskLinks = task.links ? [...task.links] : [];
            renderLinks();

            document.getElementById('notes-modal').classList.remove('hidden');
        }

        function closeNotesModal() {
            document.getElementById('notes-modal').classList.add('hidden');
            currentTaskLinks = [];
        }

        function renderLinks() {
            const container = document.getElementById('links-container');
            container.innerHTML = currentTaskLinks.map((link, index) => {
                // Validate URL to prevent javascript: XSS
                const safeUrl = link.url && (link.url.startsWith('http://') || link.url.startsWith('https://')) ? escapeHtml(link.url) : '#';
                return `
                <div class="flex items-center gap-2 bg-zinc-900 rounded-lg px-3 py-2">
                    <i class="ph ph-link text-cyan-400"></i>
                    <a href="${safeUrl}" target="_blank" rel="noopener noreferrer" class="flex-1 text-cyan-400 hover:text-cyan-300 text-sm truncate">${escapeHtml(link.title || link.url)}</a>
                    <button onclick="removeLink(${index})" class="text-zinc-500 hover:text-red-400 transition-colors">
                        <i class="ph ph-x"></i>
                    </button>
                </div>
            `}).join('');
        }

        function addLink() {
            const url = document.getElementById('new-link-url').value.trim();
            const title = document.getElementById('new-link-title').value.trim();

            if (!url) return;

            currentTaskLinks.push({ url, title: title || url });
            document.getElementById('new-link-url').value = '';
            document.getElementById('new-link-title').value = '';
            renderLinks();
        }

        function removeLink(index) {
            currentTaskLinks.splice(index, 1);
            renderLinks();
        }

        async function saveTaskNotes() {
            const taskId = document.getElementById('notes-task-id').value;
            const notes = document.getElementById('task-notes').value.trim();

            const { error } = await supabaseClient
                .from('workflow_tasks')
                .update({
                    notes: notes || null,
                    links: currentTaskLinks.length > 0 ? currentTaskLinks : []
                })
                .eq('id', taskId);

            if (error) {
                console.error('Error saving notes:', error);
                showToast('Blad zapisywania notatek', 'error');
                return;
            }

            // Update local state
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                task.notes = notes || null;
                task.links = currentTaskLinks.length > 0 ? currentTaskLinks : [];
            }

            closeNotesModal();
            showToast('Zapisano', 'success');
            renderMilestones();
        }

        function showToast(message, type = 'success') {
            const existing = document.getElementById('toast-notification');
            if (existing) existing.remove();

            const colors = {
                success: 'text-emerald-400',
                error: 'text-red-400',
                warning: 'text-amber-400'
            };
            const icons = {
                success: 'ph-check-circle',
                error: 'ph-x-circle',
                warning: 'ph-warning'
            };

            const toast = document.createElement('div');
            toast.id = 'toast-notification';
            toast.className = 'fixed bottom-6 right-6 bg-zinc-800 border border-white/10 text-white px-4 py-3 rounded-lg shadow-xl z-50 flex items-center gap-2 animate-enter';
            toast.innerHTML = `<i class="ph ${icons[type]} ${colors[type]}"></i> ${message}`;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(10px)';
                toast.style.transition = 'all 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Alert Modal
        function showModal(title, message, type = 'warning') {
            const iconEl = document.getElementById('alert-modal-icon');
            const icons = { warning: 'ph-warning', error: 'ph-x-circle', info: 'ph-info', success: 'ph-check-circle' };
            const colors = { warning: 'bg-amber-500/10 text-amber-400', error: 'bg-red-500/10 text-red-400', info: 'bg-blue-500/10 text-blue-400', success: 'bg-emerald-500/10 text-emerald-400' };

            iconEl.className = `w-8 h-8 rounded-lg flex items-center justify-center ${colors[type] || colors.warning}`;
            iconEl.innerHTML = `<i class="ph ${icons[type] || icons.warning}"></i>`;

            document.getElementById('alert-modal-title').textContent = title;
            document.getElementById('alert-modal-message').textContent = message;
            document.getElementById('alert-modal').classList.remove('hidden');
        }

        function closeAlertModal() {
            document.getElementById('alert-modal').classList.add('hidden');
        }

        // Edit Milestone Modal
        function openEditMilestoneModal(milestoneId) {
            const milestone = milestones.find(m => m.id === milestoneId);
            if (!milestone) return;

            document.getElementById('edit-milestone-id').value = milestoneId;
            document.getElementById('edit-milestone-title').value = milestone.title || '';
            document.getElementById('edit-milestone-description').value = milestone.description || '';
            document.getElementById('edit-milestone-duration').value = milestone.duration_days ?? 0;

            document.getElementById('edit-milestone-modal').classList.remove('hidden');
            document.getElementById('edit-milestone-title').focus();
        }

        function closeEditMilestoneModal() {
            document.getElementById('edit-milestone-modal').classList.add('hidden');
        }

        async function saveMilestone() {
            const milestoneId = document.getElementById('edit-milestone-id').value;
            const title = document.getElementById('edit-milestone-title').value.trim();
            const description = document.getElementById('edit-milestone-description').value.trim();
            const parsed = parseInt(document.getElementById('edit-milestone-duration').value);
            const durationDays = isNaN(parsed) ? 0 : Math.max(0, parsed);

            if (!title) {
                showToast('Podaj nazwe etapu', 'error');
                return;
            }

            const updateData = {
                title,
                description: description || null,
                duration_days: durationDays
            };
            if (durationDays === 0) {
                updateData.start_date = null;
                updateData.deadline = null;
            }

            const { error } = await supabaseClient
                .from('workflow_milestones')
                .update(updateData)
                .eq('id', milestoneId);

            if (error) {
                console.error('Error updating milestone:', error);
                showToast('Blad aktualizacji etapu', 'error');
                return;
            }

            // Update local state
            const milestone = milestones.find(m => m.id === milestoneId);
            if (milestone) {
                milestone.title = title;
                milestone.description = description || null;
                milestone.duration_days = durationDays;
                if (durationDays === 0) {
                    milestone.start_date = null;
                    milestone.deadline = null;
                }
            }

            // Log activity
            logActivity('milestone_updated', `Zaktualizowano etap: ${title}`, { milestone_id: milestoneId, title, duration_days: durationDays });

            closeEditMilestoneModal();
            showToast('Etap zaktualizowany', 'success');
            renderWorkflow();
        }

        // Add Task Modal
        function openAddTaskModal(milestoneId) {
            document.getElementById('add-task-milestone-id').value = milestoneId;
            document.getElementById('add-task-title').value = '';
            document.getElementById('add-task-responsible').value = 'team';

            document.getElementById('add-task-modal').classList.remove('hidden');
            document.getElementById('add-task-title').focus();
        }

        function closeAddTaskModal() {
            document.getElementById('add-task-modal').classList.add('hidden');
        }

        async function saveNewTask() {
            const milestoneId = document.getElementById('add-task-milestone-id').value;
            const title = document.getElementById('add-task-title').value.trim();
            const responsible = document.getElementById('add-task-responsible').value;

            if (!title) {
                showToast('Podaj nazwe zadania', 'error');
                return;
            }

            // Get the highest task_index for this milestone
            const milestoneTasks = tasks.filter(t => t.milestone_id === milestoneId);
            const maxIndex = milestoneTasks.length > 0
                ? Math.max(...milestoneTasks.map(t => t.task_index))
                : -1;

            const { data: newTask, error } = await supabaseClient
                .from('workflow_tasks')
                .insert({
                    milestone_id: milestoneId,
                    workflow_id: workflow.id,
                    task_index: maxIndex + 1,
                    title,
                    responsible
                })
                .select()
                .single();

            if (error) {
                console.error('Error creating task:', error);
                showToast('Blad tworzenia zadania', 'error');
                return;
            }

            // Add to local state
            tasks.push(newTask);

            // Log activity
            const milestone = milestones.find(m => m.id === milestoneId);
            logActivity('task_added', `Dodano zadanie: ${title}`, { task_id: newTask.id, milestone_title: milestone?.title, responsible });

            closeAddTaskModal();
            showToast('Zadanie dodane', 'success');
            renderWorkflow();
        }

        // Delete Task
        async function deleteTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            if (!confirm(`Czy na pewno chcesz usunac zadanie "${task.title}"?`)) {
                return;
            }

            const { error } = await supabaseClient
                .from('workflow_tasks')
                .delete()
                .eq('id', taskId);

            if (error) {
                console.error('Error deleting task:', error);
                showToast('Blad usuwania zadania', 'error');
                return;
            }

            // Remove from local state
            const deletedTaskTitle = task.title;
            tasks = tasks.filter(t => t.id !== taskId);

            // Log activity
            logActivity('task_deleted', `Usunięto zadanie: ${deletedTaskTitle}`, { task_id: taskId });

            showToast('Zadanie usuniete', 'success');
            renderWorkflow();
        }

        // Make functions global
        window.toggleMilestone = toggleMilestone;
        window.toggleTask = toggleTask;
        window.completeMilestone = completeMilestone;
        window.changeStatus = changeStatus;
        window.openPasswordModal = openPasswordModal;
        window.closePasswordModal = closePasswordModal;
        window.savePassword = savePassword;
        window.removePassword = removePassword;
        window.openNotesModal = openNotesModal;
        window.closeNotesModal = closeNotesModal;
        window.addLink = addLink;
        window.removeLink = removeLink;
        window.saveTaskNotes = saveTaskNotes;
        window.openEditMilestoneModal = openEditMilestoneModal;
        window.closeEditMilestoneModal = closeEditMilestoneModal;
        window.saveMilestone = saveMilestone;
        window.openAddTaskModal = openAddTaskModal;
        window.closeAddTaskModal = closeAddTaskModal;
        window.saveNewTask = saveNewTask;
        window.deleteTask = deleteTask;

        // =============================================
        // TABS
        // =============================================
        function switchTab(tabName) {
            // Expand stage section if tab belongs to a collapsed stage
            const stage1Tabs = ['produkty', 'raporty', 'branding', 'strona', 'podsumowanie'];
            const stage2Tabs = ['scenariusze', 'profile', 'nagrania'];
            const stage3Tabs = ['takedrop'];

            if (stage1Tabs.includes(tabName)) {
                expandStageSection(1);
            } else if (stage2Tabs.includes(tabName)) {
                expandStageSection(2);
            } else if (stage3Tabs.includes(tabName)) {
                expandStageSection(3);
            }

            // Update sidebar buttons
            document.querySelectorAll('.workflow-sidebar-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tabName);
            });

            // Update tab panels
            document.querySelectorAll('.workflow-panel').forEach(panel => {
                panel.classList.add('hidden');
            });
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');

            // Load data based on tab
            switch(tabName) {
                case 'dokumenty':
                    loadContractData();
                    break;
                case 'branding':
                    loadBranding();
                    break;
                case 'strona':
                    loadSalesPage();
                    break;
                case 'produkty':
                    loadProducts();
                    break;
                case 'raporty':
                    loadReports();
                    break;
                case 'podsumowanie':
                    loadPodsumowanie();
                    break;
                case 'scenariusze':
                    loadScenariusze();
                    break;
                case 'profile':
                    loadProfile();
                    break;
                case 'nagrania':
                    loadNagrania();
                    break;
                case 'takedrop':
                    loadTakeDrop();
                    break;
                case 'historia':
                    loadFullHistory(true);
                    break;
                case 'wiadomosci':
                    loadEmailHistory();
                    break;
            }
        }
        window.switchTab = switchTab;

        // =============================================
        // STAGE SECTIONS COLLAPSE/EXPAND
        // =============================================
        function toggleStageSection(stageNum) {
            const content = document.getElementById(`stage-${stageNum}-content`);
            const chevron = document.getElementById(`stage-${stageNum}-chevron`);
            if (content && chevron) {
                const isCollapsed = content.classList.contains('hidden');
                if (isCollapsed) {
                    content.classList.remove('hidden');
                    chevron.style.transform = 'rotate(0deg)';
                } else {
                    content.classList.add('hidden');
                    chevron.style.transform = 'rotate(-90deg)';
                }
            }
        }
        window.toggleStageSection = toggleStageSection;

        function collapseStageSection(stageNum) {
            const content = document.getElementById(`stage-${stageNum}-content`);
            const chevron = document.getElementById(`stage-${stageNum}-chevron`);
            if (content && chevron) {
                content.classList.add('hidden');
                chevron.style.transform = 'rotate(-90deg)';
            }
        }

        function expandStageSection(stageNum) {
            const content = document.getElementById(`stage-${stageNum}-content`);
            const chevron = document.getElementById(`stage-${stageNum}-chevron`);
            if (content && chevron) {
                content.classList.remove('hidden');
                chevron.style.transform = 'rotate(0deg)';
            }
        }

        function autoCollapseStages() {
            // Collapse previous stages if a later stage is active
            const stage3Active = takeDropData?.is_active || false;
            const stage2Active = videoAdminData?.is_active || false;

            // If stage 3 is active, collapse stages 1 and 2
            if (stage3Active) {
                collapseStageSection(1);
                collapseStageSection(2);
            }
            // If stage 2 is active (but not stage 3), collapse only stage 1
            else if (stage2Active) {
                collapseStageSection(1);
            }
        }

        // =============================================
        // PODSUMOWANIE (ETAP 1)
        // =============================================

        async function loadPodsumowanie() {
            // Load video data to check stage acceptance
            if (!videoAdminData) {
                const { data } = await supabaseClient
                    .from('workflow_video')
                    .select('*')
                    .eq('workflow_id', workflow.id)
                    .maybeSingle();
                videoAdminData = data;
            }
            renderPodsumowanie();
        }

        function renderPodsumowanie() {
            const checklist = document.getElementById('podsumowanie-checklist');
            const notAccepted = document.getElementById('podsumowanie-not-accepted');
            const accepted = document.getElementById('podsumowanie-accepted');
            const acceptedDate = document.getElementById('podsumowanie-accepted-date');
            const navCheck = document.getElementById('nav-check-podsumowanie');
            const navCheckIcon = document.getElementById('nav-check-podsumowanie-icon');

            if (!checklist) return;

            // Build checklist
            const items = [];

            // Contract (skip for Starter)
            const isStarter = workflow.offer_name?.toLowerCase().includes('starter');
            if (!isStarter) {
                const done = workflow.contract_status === 'signed';
                items.push({
                    label: 'Umowa',
                    done: done,
                    icon: done ? 'ph-fill ph-check-circle text-emerald-400' : 'ph ph-circle text-zinc-600'
                });
            }

            // Product
            const productDone = !!workflow.selected_product_id;
            items.push({
                label: 'Produkt',
                done: productDone,
                icon: productDone ? 'ph-fill ph-check-circle text-emerald-400' : 'ph ph-circle text-zinc-600'
            });

            // Reports (check if any published)
            const reportsDone = !!workflow.branding_shared_at; // Using branding as proxy for now
            items.push({
                label: 'Raporty',
                done: reportsDone,
                icon: reportsDone ? 'ph-fill ph-check-circle text-emerald-400' : 'ph ph-circle text-zinc-600'
            });

            // Branding
            const brandingDone = !!workflow.branding_shared_at;
            items.push({
                label: 'Branding',
                done: brandingDone,
                icon: brandingDone ? 'ph-fill ph-check-circle text-emerald-400' : 'ph ph-circle text-zinc-600'
            });

            // Sales page
            const stronaDone = !!workflow.sales_page_shared_at;
            items.push({
                label: 'Strona',
                done: stronaDone,
                icon: stronaDone ? 'ph-fill ph-check-circle text-emerald-400' : 'ph ph-circle text-zinc-600'
            });

            checklist.innerHTML = items.map(item => `
                <div class="flex items-center gap-3">
                    <i class="${item.icon} text-sm"></i>
                    <span class="text-[13px] ${item.done ? 'text-white' : 'text-zinc-500'}">${item.label}</span>
                </div>
            `).join('');

            // Check stage acceptance
            const isAccepted = videoAdminData?.stage_accepted;

            if (isAccepted) {
                notAccepted.classList.add('hidden');
                accepted.classList.remove('hidden');
                acceptedDate.textContent = videoAdminData.stage_accepted_at
                    ? new Date(videoAdminData.stage_accepted_at).toLocaleDateString('pl-PL')
                    : '-';

                // Show green check in nav
                if (navCheck) navCheck.classList.remove('hidden');
                if (navCheckIcon) navCheckIcon.className = 'ph-fill ph-check-circle text-emerald-400 text-sm';
            } else {
                notAccepted.classList.remove('hidden');
                accepted.classList.add('hidden');
                if (navCheck) navCheck.classList.add('hidden');
            }
        }

        // =============================================
        // SCENARIUSZE, PROFILE, NAGRANIA (ETAP 2)
        // =============================================

        async function loadScenariusze() {
            if (!videoAdminData) {
                const { data } = await supabaseClient
                    .from('workflow_video')
                    .select('*')
                    .eq('workflow_id', workflow.id)
                    .maybeSingle();
                videoAdminData = data;
            }
            renderScenariusze();
        }

        function renderScenariusze() {
            const activeCheckbox = document.getElementById('video-active');
            const activatedInfo = document.getElementById('video-activated-info');
            const activatedDate = document.getElementById('video-activated-date');

            if (!activeCheckbox) return;

            if (videoAdminData) {
                activeCheckbox.checked = videoAdminData.is_active || false;

                // Show activated info
                if (videoAdminData.is_active && videoAdminData.activated_at) {
                    activatedInfo.classList.remove('hidden');
                    activatedDate.textContent = new Date(videoAdminData.activated_at).toLocaleDateString('pl-PL');
                } else {
                    activatedInfo.classList.add('hidden');
                }
            }

            // Render scenarios
            renderVideoScenariosAdmin();

            // Update nav check
            updateScenariuszeNav();
        }

        function updateScenariuszeNav() {
            const navCheck = document.getElementById('nav-check-scenariusze');
            const navCheckIcon = document.getElementById('nav-check-scenariusze-icon');
            const scenarios = videoAdminData?.video_scenarios || [];

            if (scenarios.length > 0) {
                if (navCheck) navCheck.classList.remove('hidden');
                if (navCheckIcon) navCheckIcon.className = 'ph-fill ph-check-circle text-emerald-400 text-sm';
            } else {
                if (navCheck) navCheck.classList.add('hidden');
            }
        }

        async function loadProfile() {
            if (!videoAdminData) {
                const { data } = await supabaseClient
                    .from('workflow_video')
                    .select('*')
                    .eq('workflow_id', workflow.id)
                    .maybeSingle();
                videoAdminData = data;
            }
            renderProfile();
        }

        function renderProfile() {
            const profiles = videoAdminData?.social_profiles || {};

            const tiktok = document.getElementById('video-client-tiktok');
            const youtube = document.getElementById('video-client-youtube');
            const instagram = document.getElementById('video-client-instagram');

            if (tiktok) {
                if (profiles.tiktok) {
                    tiktok.innerHTML = `<a href="${escapeHtml(profiles.tiktok)}" target="_blank" class="text-pink-400 hover:underline">${escapeHtml(profiles.tiktok.replace(/^https?:\/\//, '').slice(0, 20))}...</a>`;
                } else {
                    tiktok.textContent = 'Nie podano';
                }
            }
            if (youtube) {
                if (profiles.youtube) {
                    youtube.innerHTML = `<a href="${escapeHtml(profiles.youtube)}" target="_blank" class="text-red-400 hover:underline">${escapeHtml(profiles.youtube.replace(/^https?:\/\//, '').slice(0, 20))}...</a>`;
                } else {
                    youtube.textContent = 'Nie podano';
                }
            }
            if (instagram) {
                if (profiles.instagram) {
                    instagram.innerHTML = `<a href="${escapeHtml(profiles.instagram)}" target="_blank" class="text-purple-400 hover:underline">${escapeHtml(profiles.instagram.replace(/^https?:\/\//, '').slice(0, 20))}...</a>`;
                } else {
                    instagram.textContent = 'Nie podano';
                }
            }

            // Update nav check
            updateProfileNav();
        }

        function updateProfileNav() {
            const navCheck = document.getElementById('nav-check-profile');
            const navCheckIcon = document.getElementById('nav-check-profile-icon');
            const profiles = videoAdminData?.social_profiles || {};
            const profileCount = [profiles.tiktok, profiles.youtube, profiles.instagram].filter(Boolean).length;

            if (profileCount === 3) {
                if (navCheck) navCheck.classList.remove('hidden');
                if (navCheckIcon) navCheckIcon.className = 'ph-fill ph-check-circle text-emerald-400 text-sm';
            } else if (profileCount > 0) {
                if (navCheck) navCheck.classList.remove('hidden');
                if (navCheckIcon) navCheckIcon.className = 'ph-fill ph-warning-circle text-amber-400 text-sm';
            } else {
                if (navCheck) navCheck.classList.add('hidden');
            }
        }

        async function loadNagrania() {
            if (!videoAdminData) {
                const { data } = await supabaseClient
                    .from('workflow_video')
                    .select('*')
                    .eq('workflow_id', workflow.id)
                    .maybeSingle();
                videoAdminData = data;
            }
            renderNagrania();
        }

        function renderNagrania() {
            const links = videoAdminData?.video_links || [];
            const linksContainer = document.getElementById('video-client-links');
            const linksEmpty = document.getElementById('video-client-links-empty');
            const deliveredBadge = document.getElementById('video-delivered-badge');
            const completedBadge = document.getElementById('video-completed-badge');
            const sharedCheckbox = document.getElementById('video-shared-checkbox');
            const sharedInfo = document.getElementById('video-shared-info');
            const sharedDate = document.getElementById('video-shared-date');

            if (!linksContainer || !linksEmpty) return;

            // Render links
            if (links.length === 0) {
                linksContainer.classList.add('hidden');
                linksEmpty.classList.remove('hidden');
            } else {
                linksContainer.classList.remove('hidden');
                linksEmpty.classList.add('hidden');

                linksContainer.innerHTML = links.map(link => `
                    <a href="${escapeHtml(link.url)}" target="_blank" rel="noopener"
                        class="flex items-center gap-3 bg-[#0a0a0a] border border-[#1a1a1a] rounded-lg p-3 hover:border-emerald-500/30 transition-colors group">
                        <div class="w-8 h-8 rounded-lg bg-emerald-500/10 flex items-center justify-center">
                            <i class="ph ph-video text-emerald-400"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="text-[13px] text-white truncate">${escapeHtml(link.title || 'Bez tytułu')}</div>
                            <div class="text-[11px] text-[#555] truncate">${escapeHtml(link.url)}</div>
                        </div>
                        <i class="ph ph-arrow-square-out text-[#555] group-hover:text-emerald-400 transition-colors"></i>
                    </a>
                `).join('');
            }

            // Header badges
            if (deliveredBadge && completedBadge) {
                if (links.length > 0 || videoAdminData?.video_shared) {
                    deliveredBadge.classList.add('hidden');
                    completedBadge.classList.remove('hidden');
                } else if (videoAdminData?.is_active) {
                    deliveredBadge.classList.remove('hidden');
                    completedBadge.classList.add('hidden');
                } else {
                    deliveredBadge.classList.add('hidden');
                    completedBadge.classList.add('hidden');
                }
            }

            // Video shared checkbox
            if (sharedCheckbox && videoAdminData) {
                sharedCheckbox.checked = videoAdminData.video_shared || false;
                if (videoAdminData.video_shared && videoAdminData.video_shared_at) {
                    sharedInfo.classList.remove('hidden');
                    sharedDate.textContent = new Date(videoAdminData.video_shared_at).toLocaleDateString('pl-PL');
                } else {
                    sharedInfo.classList.add('hidden');
                }
            }

            // Update nav - show count instead of checkmark
            updateNagraniaNav();
        }

        function updateNagraniaNav() {
            const navCount = document.getElementById('nav-check-nagrania-count');
            const links = videoAdminData?.video_links || [];

            if (navCount) {
                if (links.length > 0) {
                    navCount.textContent = links.length;
                    navCount.className = 'text-[10px] text-emerald-400 font-medium';
                } else {
                    navCount.textContent = '';
                }
            }
        }

        // Keep old function for backwards compatibility
        async function loadVideoAdmin() {
            try {
                const { data, error } = await supabaseClient
                    .from('workflow_video')
                    .select('*')
                    .eq('workflow_id', workflow.id)
                    .maybeSingle();

                if (error) throw error;
                videoAdminData = data;
                renderVideoAdmin();
            } catch (err) {
                console.error('Error loading Video:', err);
            }
        }

        function renderVideoAdmin() {
            const activeCheckbox = document.getElementById('video-active');
            const activatedInfo = document.getElementById('video-activated-info');
            const activatedDate = document.getElementById('video-activated-date');
            const statusDot = document.getElementById('video-status-dot');
            const statusText = document.getElementById('video-status-text');
            const acceptedInfo = document.getElementById('video-accepted-info');
            const acceptedDate = document.getElementById('video-accepted-date');
            const navCheck = document.getElementById('nav-check-video');
            const deliveredBadge = document.getElementById('video-delivered-badge');
            const completedBadge = document.getElementById('video-completed-badge');

            if (!activeCheckbox) return;

            if (videoAdminData) {
                activeCheckbox.checked = videoAdminData.is_active || false;

                // Header badges
                const videoLinks = videoAdminData.video_links || [];
                if (deliveredBadge && completedBadge) {
                    if (videoLinks.length > 0 || videoAdminData.video_shared) {
                        deliveredBadge.classList.add('hidden');
                        completedBadge.classList.remove('hidden');
                    } else if (videoAdminData.is_active) {
                        deliveredBadge.classList.remove('hidden');
                        completedBadge.classList.add('hidden');
                    } else {
                        deliveredBadge.classList.add('hidden');
                        completedBadge.classList.add('hidden');
                    }
                }

                // Show activated info
                if (videoAdminData.is_active && videoAdminData.activated_at) {
                    activatedInfo.classList.remove('hidden');
                    activatedDate.textContent = new Date(videoAdminData.activated_at).toLocaleDateString('pl-PL');
                } else {
                    activatedInfo.classList.add('hidden');
                }

                // Status
                if (videoAdminData.stage_accepted) {
                    statusDot.className = 'w-2 h-2 rounded-full bg-emerald-400';
                    statusText.textContent = 'Etap zaakceptowany';
                    statusText.className = 'text-[13px] text-emerald-400';
                    acceptedInfo.classList.remove('hidden');
                    acceptedDate.textContent = videoAdminData.stage_accepted_at
                        ? new Date(videoAdminData.stage_accepted_at).toLocaleDateString('pl-PL')
                        : '-';
                } else if (videoAdminData.is_active) {
                    statusDot.className = 'w-2 h-2 rounded-full bg-amber-400';
                    statusText.textContent = 'Oczekuje na akceptację klienta';
                    statusText.className = 'text-[13px] text-amber-400';
                    acceptedInfo.classList.add('hidden');
                } else {
                    statusDot.className = 'w-2 h-2 rounded-full bg-[#666]';
                    statusText.textContent = 'Nieaktywne';
                    statusText.className = 'text-[13px] text-[#888]';
                    acceptedInfo.classList.add('hidden');
                }

                // Steps progress (only after acceptance)
                renderVideoStepsProgress();

                // Scenarios
                renderVideoScenariosAdmin();

                // Client data
                renderVideoClientData();

                // Video shared checkbox
                const videoSharedCheckbox = document.getElementById('video-shared-checkbox');
                const videoSharedInfo = document.getElementById('video-shared-info');
                const videoSharedDate = document.getElementById('video-shared-date');
                if (videoSharedCheckbox) {
                    videoSharedCheckbox.checked = videoAdminData.video_shared || false;
                    if (videoAdminData.video_shared && videoAdminData.video_shared_at) {
                        videoSharedInfo.classList.remove('hidden');
                        videoSharedDate.textContent = new Date(videoAdminData.video_shared_at).toLocaleDateString('pl-PL');
                    } else {
                        videoSharedInfo.classList.add('hidden');
                    }
                }

                // Update nav check for video tab
                // Yellow = video stage active (admin shared to client), waiting for client to add links
                // Green = client added at least one video link
                const navCheckIcon = document.getElementById('nav-check-video-icon');
                if (videoLinks.length > 0) {
                    // Green - client added video links
                    navCheck.classList.remove('hidden');
                    if (navCheckIcon) navCheckIcon.className = 'ph-fill ph-check-circle text-emerald-400 text-sm';
                } else if (videoAdminData.is_active) {
                    // Yellow - video stage active, waiting for client to add links
                    navCheck.classList.remove('hidden');
                    if (navCheckIcon) navCheckIcon.className = 'ph-fill ph-check-circle text-amber-400 text-sm';
                } else {
                    navCheck.classList.add('hidden');
                }
            } else {
                activeCheckbox.checked = false;
                activatedInfo.classList.add('hidden');
                statusDot.className = 'w-2 h-2 rounded-full bg-[#666]';
                statusText.textContent = 'Brak danych';
                statusText.className = 'text-[13px] text-[#888]';

                // Reset video shared
                const videoSharedCheckbox = document.getElementById('video-shared-checkbox');
                const videoSharedInfo = document.getElementById('video-shared-info');
                if (videoSharedCheckbox) {
                    videoSharedCheckbox.checked = false;
                    videoSharedInfo.classList.add('hidden');
                }

                // Hide nav check
                if (navCheck) navCheck.classList.add('hidden');
            }
        }

        function toggleVideoScenarios() {
            const container = document.getElementById('video-scenarios-admin');
            const empty = document.getElementById('video-scenarios-empty');
            const chevron = document.getElementById('video-scenarios-chevron');
            const scenarios = videoAdminData?.video_scenarios || [];

            // Toggle visibility based on which element is shown
            const targetEl = scenarios.length > 0 ? container : empty;
            const isHidden = targetEl.classList.contains('hidden');

            if (isHidden) {
                targetEl.classList.remove('hidden');
                if (chevron) chevron.style.transform = 'rotate(0deg)';
            } else {
                targetEl.classList.add('hidden');
                if (chevron) chevron.style.transform = 'rotate(-90deg)';
            }
        }
        window.toggleVideoScenarios = toggleVideoScenarios;

        function renderVideoScenariosAdmin() {
            const container = document.getElementById('video-scenarios-admin');
            const empty = document.getElementById('video-scenarios-empty');
            const countEl = document.getElementById('video-scenarios-count');
            const scenarios = videoAdminData?.video_scenarios || [];

            if (!container || !empty) return;

            // Update count
            if (countEl) {
                countEl.textContent = scenarios.length > 0 ? `(${scenarios.length})` : '';
            }

            // Show scenarios or empty state
            if (scenarios.length === 0) {
                container.classList.add('hidden');
                empty.classList.remove('hidden');
                return;
            }

            // Show scenarios
            container.classList.remove('hidden');
            empty.classList.add('hidden');

            // Type badge colors
            const typeColors = {
                'POV': 'bg-blue-500/20 text-blue-400',
                'Rutyna': 'bg-emerald-500/20 text-emerald-400',
                'Reakcja': 'bg-amber-500/20 text-amber-400',
                'Efekt WOW': 'bg-pink-500/20 text-pink-400',
                'Porównanie': 'bg-purple-500/20 text-purple-400',
                'ASMR': 'bg-cyan-500/20 text-cyan-400',
                'Unboxing': 'bg-orange-500/20 text-orange-400',
                'Tutorial': 'bg-indigo-500/20 text-indigo-400',
                'Estetyka': 'bg-rose-500/20 text-rose-400',
                'Storytime': 'bg-violet-500/20 text-violet-400'
            };

            // Split into face/no-face
            const withFace = scenarios.filter((s, i) => ({ ...s, _idx: i })).filter(s => s.showFace === true);
            const noFace = scenarios.filter((s, i) => ({ ...s, _idx: i })).filter(s => s.showFace === false);
            const hasGroups = withFace.length > 0 || noFace.length > 0;

            const renderCard = (scenario, index) => {
                const typeClass = typeColors[scenario.type] || 'bg-zinc-500/20 text-zinc-400';
                const faceIcon = scenario.showFace === false ? 'ph-hand' : 'ph-user';
                const faceColor = scenario.showFace === false ? 'text-cyan-400' : 'text-pink-400';

                return `
                <div class="bg-[#0a0a0a] border border-[#1a1a1a] rounded-lg overflow-hidden">
                    <div onclick="toggleAdminScenario(${index})" class="flex items-center gap-3 p-3 cursor-pointer hover:bg-[#111] transition-colors">
                        <span class="w-6 h-6 rounded bg-purple-500/10 flex items-center justify-center text-purple-400 text-[10px] font-bold flex-shrink-0">${index + 1}</span>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-0.5">
                                ${scenario.type ? `<span class="px-1.5 py-0.5 text-[9px] font-medium rounded ${typeClass}">${escapeHtml(scenario.type)}</span>` : ''}
                                ${scenario.showFace !== undefined ? `<i class="ph ${faceIcon} ${faceColor} text-[10px]"></i>` : ''}
                                ${scenario.duration ? `<span class="text-[9px] text-[#555]">${escapeHtml(scenario.duration)}</span>` : ''}
                            </div>
                            <p class="text-white text-[12px] truncate">${escapeHtml(scenario.title || 'Bez tytułu')}</p>
                        </div>
                        <button onclick="event.stopPropagation(); removeVideoScenario(${index})" class="text-[#444] hover:text-red-400 transition-colors p-1">
                            <i class="ph ph-trash text-xs"></i>
                        </button>
                        <i class="ph ph-caret-down text-[#444] text-sm transition-transform" id="admin-scenario-arrow-${index}"></i>
                    </div>
                    <div id="admin-scenario-content-${index}" class="hidden border-t border-[#1a1a1a] p-3 bg-[#050505]">
                        <div class="space-y-2 text-[11px]">
                            ${scenario.hook ? `<div><span class="text-blue-400">Start:</span> <span class="text-[#777]">${escapeHtml(scenario.hook)}</span></div>` : ''}
                            ${scenario.action ? `<div><span class="text-emerald-400">Akcja:</span> <span class="text-[#777]">${escapeHtml(scenario.action)}</span></div>` : ''}
                            ${scenario.ending ? `<div><span class="text-purple-400">Koniec:</span> <span class="text-[#777]">${escapeHtml(scenario.ending)}</span></div>` : ''}
                            ${scenario.example ? `<div class="mt-2 p-2 bg-zinc-800/50 rounded text-[#888] italic">"${escapeHtml(scenario.example)}"</div>` : ''}
                            ${scenario.tip ? `<div class="mt-2 flex items-start gap-1.5"><i class="ph ph-lightbulb text-amber-400 mt-0.5"></i><span class="text-[#666]">${escapeHtml(scenario.tip)}</span></div>` : ''}
                            ${scenario.soundTip ? `<div class="mt-2 flex items-start gap-1.5"><i class="ph ph-music-notes text-cyan-400 mt-0.5"></i><span class="text-[#666]">${escapeHtml(scenario.soundTip)}</span></div>` : ''}
                            ${scenario.textOverlay ? `<div class="mt-2 flex items-start gap-1.5"><i class="ph ph-text-aa text-purple-400 mt-0.5"></i><span class="text-[#666]">${escapeHtml(scenario.textOverlay)}</span></div>` : ''}
                            ${scenario.description ? `<div class="mt-2 text-[#666]">${escapeHtml(scenario.description)}</div>` : ''}
                        </div>
                    </div>
                </div>
            `};

            let html = '';

            if (hasGroups) {
                // Show grouped by face/no-face
                let globalIdx = 0;
                if (withFace.length > 0) {
                    html += `<div class="mb-3"><div class="flex items-center gap-2 mb-2 text-[11px] text-[#666]"><i class="ph ph-user text-pink-400"></i>Z twarzą (${withFace.length})</div>`;
                    html += `<div class="space-y-2">`;
                    scenarios.forEach((s, i) => { if (s.showFace === true) html += renderCard(s, i); });
                    html += `</div></div>`;
                }
                if (noFace.length > 0) {
                    html += `<div><div class="flex items-center gap-2 mb-2 text-[11px] text-[#666]"><i class="ph ph-hand text-cyan-400"></i>Bez twarzy (${noFace.length})</div>`;
                    html += `<div class="space-y-2">`;
                    scenarios.forEach((s, i) => { if (s.showFace === false) html += renderCard(s, i); });
                    html += `</div></div>`;
                }
            } else {
                // Old format - no grouping
                html = `<div class="space-y-2">${scenarios.map((s, i) => renderCard(s, i)).join('')}</div>`;
            }

            container.innerHTML = html;
        }

        function toggleAdminScenario(index) {
            const content = document.getElementById(`admin-scenario-content-${index}`);
            const arrow = document.getElementById(`admin-scenario-arrow-${index}`);
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                arrow.style.transform = 'rotate(180deg)';
            } else {
                content.classList.add('hidden');
                arrow.style.transform = 'rotate(0deg)';
            }
        }
        window.toggleAdminScenario = toggleAdminScenario;

        function renderVideoClientData() {
            const profiles = videoAdminData?.social_profiles || {};
            const links = videoAdminData?.video_links || [];

            // Social profiles
            const tiktok = document.getElementById('video-client-tiktok');
            const youtube = document.getElementById('video-client-youtube');
            const instagram = document.getElementById('video-client-instagram');

            if (tiktok) {
                if (profiles.tiktok) {
                    tiktok.innerHTML = `<a href="${escapeHtml(profiles.tiktok)}" target="_blank" class="text-pink-400 hover:underline">${escapeHtml(profiles.tiktok.replace(/^https?:\/\//, '').slice(0, 20))}...</a>`;
                } else {
                    tiktok.textContent = 'Nie podano';
                }
            }
            if (youtube) {
                if (profiles.youtube) {
                    youtube.innerHTML = `<a href="${escapeHtml(profiles.youtube)}" target="_blank" class="text-red-400 hover:underline">${escapeHtml(profiles.youtube.replace(/^https?:\/\//, '').slice(0, 20))}...</a>`;
                } else {
                    youtube.textContent = 'Nie podano';
                }
            }
            if (instagram) {
                if (profiles.instagram) {
                    instagram.innerHTML = `<a href="${escapeHtml(profiles.instagram)}" target="_blank" class="text-purple-400 hover:underline">${escapeHtml(profiles.instagram.replace(/^https?:\/\//, '').slice(0, 20))}...</a>`;
                } else {
                    instagram.textContent = 'Nie podano';
                }
            }

            // Video links
            const linksContainer = document.getElementById('video-client-links');
            const linksEmpty = document.getElementById('video-client-links-empty');

            if (!linksContainer || !linksEmpty) return;

            if (links.length === 0) {
                linksContainer.classList.add('hidden');
                linksEmpty.classList.remove('hidden');
            } else {
                linksContainer.classList.remove('hidden');
                linksEmpty.classList.add('hidden');

                linksContainer.innerHTML = links.map(link => `
                    <a href="${escapeHtml(link.url)}" target="_blank" rel="noopener"
                        class="flex items-center gap-3 bg-[#0a0a0a] border border-[#1a1a1a] rounded-lg p-3 hover:border-emerald-500/30 transition-colors group">
                        <div class="w-8 h-8 rounded-lg bg-emerald-500/10 flex items-center justify-center">
                            <i class="ph ph-video text-emerald-400"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="text-[13px] text-white truncate">${escapeHtml(link.title || 'Bez tytułu')}</div>
                            <div class="text-[11px] text-[#555] truncate">${escapeHtml(link.url)}</div>
                        </div>
                        <i class="ph ph-arrow-square-out text-[#555] group-hover:text-emerald-400 transition-colors"></i>
                    </a>
                `).join('');
            }
        }

        function renderVideoStepsProgress() {
            const progressContainer = document.getElementById('video-steps-progress');
            if (!progressContainer) return;

            // Only show after stage accepted
            if (!videoAdminData?.stage_accepted) {
                progressContainer.classList.add('hidden');
                return;
            }

            progressContainer.classList.remove('hidden');

            // Profiles step
            const profiles = videoAdminData?.social_profiles || {};
            const profileCount = [profiles.tiktok, profiles.youtube, profiles.instagram].filter(Boolean).length;
            const profilesComplete = profileCount === 3;

            const profilesIcon = document.getElementById('video-step-profiles-icon');
            const profilesStatus = document.getElementById('video-step-profiles-status');

            if (profilesIcon) {
                if (profilesComplete) {
                    profilesIcon.className = 'ph-fill ph-check-circle text-emerald-400 text-sm';
                } else if (profileCount > 0) {
                    profilesIcon.className = 'ph-fill ph-warning-circle text-amber-400 text-sm';
                } else {
                    profilesIcon.className = 'ph ph-circle text-[#444] text-sm';
                }
            }
            if (profilesStatus) {
                profilesStatus.textContent = profilesComplete ? 'Kompletne' : `${profileCount}/3`;
                profilesStatus.className = profilesComplete
                    ? 'text-[11px] text-emerald-400/60 ml-auto'
                    : 'text-[11px] text-amber-400/60 ml-auto';
            }

            // Recordings step
            const recordings = videoAdminData?.video_links || [];
            const recordingsCount = recordings.length;
            const recordingsComplete = recordingsCount > 0;

            const recordingsIcon = document.getElementById('video-step-recordings-icon');
            const recordingsStatus = document.getElementById('video-step-recordings-status');

            if (recordingsIcon) {
                if (recordingsComplete) {
                    recordingsIcon.className = 'ph-fill ph-check-circle text-emerald-400 text-sm';
                } else {
                    recordingsIcon.className = 'ph ph-circle text-[#444] text-sm';
                }
            }
            if (recordingsStatus) {
                recordingsStatus.textContent = recordingsComplete ? `${recordingsCount} nagrań` : 'Brak';
                recordingsStatus.className = recordingsComplete
                    ? 'text-[11px] text-emerald-400/60 ml-auto'
                    : 'text-[11px] text-[#555] ml-auto';
            }
        }

        async function toggleVideoActive() {
            const checkbox = document.getElementById('video-active');
            const isActive = checkbox.checked;

            // Walidacja: nie można włączyć bez scenariuszy
            if (isActive) {
                const scenarios = videoAdminData?.video_scenarios || [];
                if (scenarios.length === 0) {
                    checkbox.checked = false;
                    showModal('Brak scenariuszy', 'Dodaj najpierw scenariusze video, aby włączyć tę zakładkę dla klienta.', 'warning');
                    return;
                }
            }

            // Store previous state BEFORE any updates
            const wasActive = videoAdminData?.is_active || false;
            const shouldTriggerAutomation = isActive && !wasActive;

            try {
                if (videoAdminData) {
                    // Update existing record
                    const updateData = { is_active: isActive };
                    if (isActive && !videoAdminData.activated_at) {
                        updateData.activated_at = new Date().toISOString();
                    }

                    const { error } = await supabaseClient
                        .from('workflow_video')
                        .update(updateData)
                        .eq('workflow_id', workflow.id);

                    if (error) throw error;
                } else {
                    // Create new record
                    const { error } = await supabaseClient
                        .from('workflow_video')
                        .insert({
                            workflow_id: workflow.id,
                            is_active: isActive,
                            activated_at: isActive ? new Date().toISOString() : null
                        });

                    if (error) throw error;
                }

                loadVideoAdmin();
                showToast(isActive ? 'Zakładka Video aktywowana' : 'Zakładka Video wyłączona', 'success');

                // Log activity
                if (isActive && !wasActive) {
                    logActivity('video_activated', 'Udostępniono zakładkę Video klientowi', {});
                } else if (!isActive && wasActive) {
                    logActivity('video_deactivated', 'Wyłączono zakładkę Video dla klienta', {});
                }

                // Trigger automation if activating for the first time (was inactive, now active)
                if (shouldTriggerAutomation) {
                    const projectUrl = `https://crm.tomekniedzwiecki.pl/projekt/${workflow.unique_token}#video-intro`;
                    try {
                        const { data, error } = await supabaseClient.functions.invoke('automation-trigger', {
                            body: {
                                trigger_type: 'video_activated',
                                entity_type: 'workflow',
                                entity_id: workflow.id,
                                context: {
                                    email: workflow.customer_email,
                                    clientName: workflow.customer_name || workflow.customer_company || 'Kliencie',
                                    workflow_id: workflow.id,
                                    projectUrl: projectUrl
                                }
                            }
                        });

                        if (error) {
                            console.error('Automation trigger error:', error);
                            showToast('Video aktywowane, ale email nie został wysłany', 'warning');
                        } else {
                            console.log('Video activation automation triggered:', data);
                            showToast('Email do klienta został wysłany', 'success');
                        }
                    } catch (triggerErr) {
                        console.error('Error triggering automation:', triggerErr);
                        showToast('Video aktywowane, ale wystąpił błąd wysyłki emaila', 'warning');
                    }
                }
            } catch (err) {
                console.error('Error toggling Video:', err);
                showToast('Błąd zapisu', 'error');
            }
        }

        async function toggleVideoShared() {
            const isShared = document.getElementById('video-shared-checkbox').checked;

            try {
                const updateData = { video_shared: isShared };
                if (isShared && !videoAdminData?.video_shared_at) {
                    updateData.video_shared_at = new Date().toISOString();
                } else if (!isShared) {
                    updateData.video_shared_at = null;
                }

                if (videoAdminData) {
                    const { error } = await supabaseClient
                        .from('workflow_video')
                        .update(updateData)
                        .eq('workflow_id', workflow.id);

                    if (error) throw error;
                } else {
                    const { error } = await supabaseClient
                        .from('workflow_video')
                        .insert({
                            workflow_id: workflow.id,
                            video_shared: isShared,
                            video_shared_at: isShared ? new Date().toISOString() : null
                        });

                    if (error) throw error;
                }

                loadVideoAdmin();
                showToast(isShared ? 'Oznaczono jako udostępnione' : 'Oznaczenie usunięte', 'success');
            } catch (err) {
                console.error('Error toggling video shared:', err);
                showToast('Błąd zapisu', 'error');
            }
        }

        async function addVideoScenario() {
            const scenarios = [...(videoAdminData?.video_scenarios || [])];
            scenarios.push({
                id: Date.now().toString(),
                title: '',
                description: '',
                tips: ''
            });

            try {
                if (videoAdminData) {
                    const { error } = await supabaseClient
                        .from('workflow_video')
                        .update({ video_scenarios: scenarios })
                        .eq('workflow_id', workflow.id);

                    if (error) throw error;
                } else {
                    const { error } = await supabaseClient
                        .from('workflow_video')
                        .insert({
                            workflow_id: workflow.id,
                            video_scenarios: scenarios
                        });

                    if (error) throw error;
                }

                loadVideoAdmin();
            } catch (err) {
                console.error('Error adding scenario:', err);
                showToast('Błąd dodawania', 'error');
            }
        }

        async function updateVideoScenario(index, field, value) {
            if (!videoAdminData) return;

            const scenarios = [...(videoAdminData.video_scenarios || [])];
            if (!scenarios[index]) return;

            scenarios[index][field] = value;

            try {
                const { error } = await supabaseClient
                    .from('workflow_video')
                    .update({ video_scenarios: scenarios })
                    .eq('workflow_id', workflow.id);

                if (error) throw error;

                videoAdminData.video_scenarios = scenarios;
            } catch (err) {
                console.error('Error updating scenario:', err);
                showToast('Błąd zapisu', 'error');
            }
        }

        async function removeVideoScenario(index) {
            if (!videoAdminData) return;

            const scenarios = [...(videoAdminData.video_scenarios || [])];
            scenarios.splice(index, 1);

            try {
                const { error } = await supabaseClient
                    .from('workflow_video')
                    .update({ video_scenarios: scenarios })
                    .eq('workflow_id', workflow.id);

                if (error) throw error;

                loadVideoAdmin();
                showToast('Scenariusz usunięty', 'success');
            } catch (err) {
                console.error('Error removing scenario:', err);
                showToast('Błąd usuwania', 'error');
            }
        }

        window.loadVideoAdmin = loadVideoAdmin;
        window.toggleVideoActive = toggleVideoActive;
        window.addVideoScenario = addVideoScenario;
        window.updateVideoScenario = updateVideoScenario;
        window.removeVideoScenario = removeVideoScenario;

        // =============================================
        // TAKEDROP ACCOUNT (ETAP 3)
        // =============================================

        async function loadTakeDrop() {
            try {
                const { data, error } = await supabaseClient
                    .from('workflow_takedrop')
                    .select('*')
                    .eq('workflow_id', workflow.id)
                    .maybeSingle();

                if (error) throw error;

                takeDropData = data;
                renderTakeDrop();
            } catch (err) {
                console.error('Error loading TakeDrop:', err);
            }
        }

        function renderTakeDrop() {
            const emailInput = document.getElementById('takedrop-email');
            const passwordInput = document.getElementById('takedrop-password');
            const notesInput = document.getElementById('takedrop-notes');
            const activeCheckbox = document.getElementById('takedrop-active');
            const activatedInfo = document.getElementById('takedrop-activated-info');
            const activatedDate = document.getElementById('takedrop-activated-date');
            const statusDot = document.getElementById('takedrop-status-dot');
            const statusText = document.getElementById('takedrop-status-text');
            const createdInfo = document.getElementById('takedrop-created-info');
            const createdDate = document.getElementById('takedrop-created-date');
            const navCheck = document.getElementById('nav-check-takedrop');

            if (takeDropData) {
                emailInput.value = takeDropData.account_email || '';
                passwordInput.value = takeDropData.account_password || '';
                notesInput.value = takeDropData.notes || '';
                activeCheckbox.checked = takeDropData.is_active;

                if (takeDropData.activated_at) {
                    activatedInfo.classList.remove('hidden');
                    activatedDate.textContent = new Date(takeDropData.activated_at).toLocaleString('pl-PL');
                } else {
                    activatedInfo.classList.add('hidden');
                }

                if (takeDropData.account_created) {
                    statusDot.className = 'w-2 h-2 rounded-full bg-[#50e3c2]';
                    statusText.textContent = 'Konto założone';
                    statusText.className = 'text-[13px] text-[#50e3c2]';
                    createdInfo.classList.remove('hidden');
                    createdDate.textContent = takeDropData.account_created_at
                        ? new Date(takeDropData.account_created_at).toLocaleString('pl-PL')
                        : '-';
                    navCheck.classList.remove('hidden');
                } else {
                    statusDot.className = 'w-2 h-2 rounded-full bg-[#666]';
                    statusText.textContent = takeDropData.is_active ? 'Oczekuje na założenie konta' : 'Konto nieaktywne';
                    statusText.className = 'text-[13px] text-[#888]';
                    createdInfo.classList.add('hidden');
                    navCheck.classList.add('hidden');
                }
            } else {
                emailInput.value = '';
                passwordInput.value = '';
                notesInput.value = '';
                activeCheckbox.checked = false;
                activatedInfo.classList.add('hidden');
                statusDot.className = 'w-2 h-2 rounded-full bg-[#666]';
                statusText.textContent = 'Konto nieaktywne';
                statusText.className = 'text-[13px] text-[#888]';
                createdInfo.classList.add('hidden');
                navCheck.classList.add('hidden');
            }
        }

        async function toggleTakeDropActive() {
            const isActive = document.getElementById('takedrop-active').checked;
            const wasActive = takeDropData?.is_active || false;
            const isFirstActivation = isActive && !wasActive;

            try {
                if (takeDropData) {
                    const { error } = await supabaseClient
                        .from('workflow_takedrop')
                        .update({
                            is_active: isActive,
                            activated_at: isActive ? new Date().toISOString() : null
                        })
                        .eq('id', takeDropData.id);

                    if (error) throw error;
                } else {
                    const { data, error } = await supabaseClient
                        .from('workflow_takedrop')
                        .insert({
                            workflow_id: workflow.id,
                            is_active: isActive,
                            activated_at: isActive ? new Date().toISOString() : null
                        })
                        .select()
                        .single();

                    if (error) throw error;
                    takeDropData = data;
                }

                showToast(isActive ? 'Zakładka aktywowana dla klienta' : 'Zakładka ukryta dla klienta', 'success');
                loadTakeDrop();

                // Trigger automation when activating for the first time
                if (isFirstActivation && workflow) {
                    const projectUrl = `https://crm.tomekniedzwiecki.pl/projekt/${workflow.unique_token}`;
                    try {
                        await supabaseClient.functions.invoke('automation-trigger', {
                            body: {
                                trigger_type: 'takedrop_activated',
                                entity_type: 'workflow',
                                entity_id: workflow.id,
                                context: {
                                    email: workflow.customer_email,
                                    clientName: workflow.customer_name || workflow.customer_company || 'Kliencie',
                                    workflow_id: workflow.id,
                                    projectUrl: projectUrl
                                }
                            }
                        });
                        console.log('TakeDrop activation automation triggered');
                    } catch (e) {
                        console.log('Automation trigger error:', e);
                    }
                }
            } catch (err) {
                console.error('Error toggling TakeDrop:', err);
                showToast('Błąd aktualizacji', 'error');
            }
        }

        async function saveTakeDropCredentials() {
            const email = document.getElementById('takedrop-email').value.trim();
            const password = document.getElementById('takedrop-password').value;
            const notes = document.getElementById('takedrop-notes').value.trim();

            try {
                if (takeDropData) {
                    const { error } = await supabaseClient
                        .from('workflow_takedrop')
                        .update({
                            account_email: email || null,
                            account_password: password || null,
                            notes: notes || null
                        })
                        .eq('id', takeDropData.id);

                    if (error) throw error;
                } else {
                    const { data, error } = await supabaseClient
                        .from('workflow_takedrop')
                        .insert({
                            workflow_id: workflow.id,
                            account_email: email || null,
                            account_password: password || null,
                            notes: notes || null
                        })
                        .select()
                        .single();

                    if (error) throw error;
                    takeDropData = data;
                }

                showToast('Dane zapisane', 'success');
            } catch (err) {
                console.error('Error saving TakeDrop:', err);
                showToast('Błąd zapisu', 'error');
            }
        }

        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            const icon = input.nextElementSibling.querySelector('i');
            if (input.type === 'password') {
                input.type = 'text';
                icon.className = 'ph ph-eye-slash';
            } else {
                input.type = 'password';
                icon.className = 'ph ph-eye';
            }
        }

        window.loadTakeDrop = loadTakeDrop;
        window.toggleTakeDropActive = toggleTakeDropActive;
        window.saveTakeDropCredentials = saveTakeDropCredentials;
        window.togglePasswordVisibility = togglePasswordVisibility;

        // =============================================
        // CONTRACT MANAGEMENT
        // =============================================
        // Contract template URLs by offer ID (static HTML files)
        const CONTRACT_TEMPLATES = {
            '30bf199b-8bc1-4810-8716-43dbffeb9113': '/umowy/umowa-budowa-sklepu.html',
            'bc5212fd-3f57-46a8-a2e9-07c030e97a3f': '/umowy/umowa-mentoring-ai.html'
        };

        let contractTemplateUrl = null;
        let contractHtml = null;

        let isEditingContract = false;

        async function loadContractData() {
            if (!workflow) return;

            // Get contract template URL from mapping
            contractTemplateUrl = CONTRACT_TEMPLATES[workflow.offer_id] || null;

            // Populate form with existing data
            document.getElementById('contract-name').value = workflow.customer_name || '';
            document.getElementById('contract-company').value = workflow.customer_company || '';
            document.getElementById('contract-street').value = workflow.client_street || '';
            document.getElementById('contract-postal').value = workflow.client_postal_code || '';
            document.getElementById('contract-city').value = workflow.client_city || '';
            document.getElementById('contract-country').value = workflow.client_country || 'Polska';
            document.getElementById('contract-pesel').value = workflow.client_pesel || '';
            document.getElementById('contract-id-number').value = workflow.client_id_number || '';
            document.getElementById('contract-nip').value = workflow.client_nip || '';
            document.getElementById('contract-email').value = workflow.customer_email || '';
            document.getElementById('contract-phone').value = workflow.customer_phone || '';

            // Populate readonly view
            document.getElementById('ro-name').textContent = workflow.customer_name || '-';
            document.getElementById('ro-company').textContent = workflow.customer_company || '-';
            document.getElementById('ro-email').textContent = workflow.customer_email || '-';
            document.getElementById('ro-phone').textContent = workflow.customer_phone || '-';
            document.getElementById('ro-pesel').textContent = workflow.client_pesel || '-';
            document.getElementById('ro-id').textContent = workflow.client_id_number || '-';
            document.getElementById('ro-nip').textContent = workflow.client_nip || '-';

            const address = [
                workflow.client_street,
                [workflow.client_postal_code, workflow.client_city].filter(Boolean).join(' '),
                workflow.client_country
            ].filter(Boolean).join(', ');
            document.getElementById('ro-address').textContent = address || '-';

            // Set filled date
            if (workflow.contract_data_filled_at) {
                document.getElementById('client-data-filled-date').textContent =
                    'Wypelniono ' + new Date(workflow.contract_data_filled_at).toLocaleDateString('pl-PL', {
                        day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit'
                    });
            }

            updateContractUI();
        }

        function toggleContractEdit() {
            isEditingContract = true;
            document.getElementById('client-data-filled-info').classList.add('hidden');
            document.getElementById('contract-data-form').classList.remove('hidden');
            document.getElementById('cancel-edit-btn').classList.remove('hidden');
        }
        window.toggleContractEdit = toggleContractEdit;

        function cancelContractEdit() {
            isEditingContract = false;
            loadContractData();
        }
        window.cancelContractEdit = cancelContractEdit;

        function updateContractUI() {
            const status = workflow.contract_status || 'pending_data';

            const statusLabels = {
                'pending_data': { text: 'Oczekuje', class: 'bg-amber-500/20 text-amber-400' },
                'data_filled': { text: 'Dane OK', class: 'bg-cyan-500/20 text-cyan-400' },
                'contract_sent': { text: 'Wysłano', class: 'bg-violet-500/20 text-violet-400' },
                'pending_signature': { text: 'Do podpisu', class: 'bg-violet-500/20 text-violet-400' },
                'signed': { text: 'Podpisana', class: 'bg-emerald-500/20 text-emerald-400' },
                'rejected': { text: 'Odrzucona', class: 'bg-red-500/20 text-red-400' }
            };
            const statusInfo = statusLabels[status] || statusLabels['pending_data'];

            // Update status badge in tab
            const badge = document.getElementById('contract-status-badge');
            if (badge) {
                badge.textContent = statusInfo.text;
                badge.className = `ml-2 px-1.5 py-0.5 rounded text-[10px] font-medium ${statusInfo.class}`;
            }

            // Update status indicator
            const indicator = document.getElementById('contract-status-indicator');
            const indicatorColors = {
                'pending_data': 'bg-amber-400',
                'data_filled': 'bg-cyan-400',
                'contract_sent': 'bg-violet-400',
                'pending_signature': 'bg-violet-400',
                'signed': 'bg-emerald-400',
                'rejected': 'bg-red-400'
            };
            indicator.innerHTML = `
                <span class="w-2 h-2 rounded-full ${indicatorColors[status] || 'bg-amber-400'}"></span>
                <span class="${statusInfo.class.split(' ')[1] || 'text-amber-400'}">${statusInfo.text}</span>
            `;

            // Update progress steps
            const steps = ['pending_data', 'data_filled', 'contract_sent', 'pending_signature', 'signed'];
            const currentIndex = steps.indexOf(status);

            updateStepUI('step-data', currentIndex >= 1, currentIndex === 0);
            updateStepUI('step-contract', currentIndex >= 2, currentIndex === 1);
            updateStepUI('step-signature', currentIndex >= 4, currentIndex >= 2 && currentIndex < 4);

            // Show/hide sections based on status
            const hasData = status !== 'pending_data';
            const isSent = ['contract_sent', 'pending_signature'].includes(status);
            const isSigned = status === 'signed';

            // Show readonly info when client filled data (and not editing)
            const showReadonly = hasData && !isEditingContract;
            document.getElementById('client-data-filled-info').classList.toggle('hidden', !showReadonly);
            document.getElementById('contract-data-form').classList.toggle('hidden', showReadonly);
            document.getElementById('cancel-edit-btn').classList.toggle('hidden', !isEditingContract);

            document.getElementById('contract-generation-section').classList.toggle('hidden', !hasData || isSigned);
            document.getElementById('signed-section').classList.toggle('hidden', !isSigned);

            // Update no template warning
            if (hasData && !contractTemplateUrl) {
                document.getElementById('no-template-warning').classList.remove('hidden');
            } else {
                document.getElementById('no-template-warning').classList.add('hidden');
            }

            // Generate contract preview
            if (hasData && contractTemplateUrl) {
                generateContract();
            }

            // Show signed info
            if (isSigned) {
                document.getElementById('signed-date').textContent = workflow.contract_signed_at
                    ? new Date(workflow.contract_signed_at).toLocaleDateString('pl-PL', { day: 'numeric', month: 'long', year: 'numeric' })
                    : '-';
                const sigTypes = { 'zaufany': 'Podpis zaufany (gov.pl)', 'kwalifikowany': 'Podpis kwalifikowany', 'fizyczny': 'Podpis fizyczny' };
                document.getElementById('signed-type').textContent = sigTypes[workflow.contract_signature_type] || workflow.contract_signature_type || '-';
                if (workflow.contract_signed_file_url) {
                    document.getElementById('signed-file-link').href = workflow.contract_signed_file_url;
                }
            }
        }

        function updateStepUI(stepId, completed, active) {
            const step = document.getElementById(stepId);
            if (completed) {
                step.className = 'flex-1 flex items-center gap-2 p-3 rounded-lg bg-emerald-500/10 border border-emerald-500/20';
                step.querySelector('div').className = 'w-6 h-6 rounded-full bg-emerald-500/20 flex items-center justify-center text-emerald-400 text-xs font-bold';
                step.querySelector('span').className = 'text-xs text-emerald-400 font-medium';
            } else if (active) {
                step.className = 'flex-1 flex items-center gap-2 p-3 rounded-lg bg-amber-500/10 border border-amber-500/20';
                step.querySelector('div').className = 'w-6 h-6 rounded-full bg-amber-500/20 flex items-center justify-center text-amber-400 text-xs font-bold';
                step.querySelector('span').className = 'text-xs text-amber-400 font-medium';
            } else {
                step.className = 'flex-1 flex items-center gap-2 p-3 rounded-lg bg-zinc-800/50 border border-white/5';
                step.querySelector('div').className = 'w-6 h-6 rounded-full bg-zinc-700 flex items-center justify-center text-zinc-500 text-xs font-bold';
                step.querySelector('span').className = 'text-xs text-zinc-500 font-medium';
            }
        }

        async function saveContractData() {
            const data = {
                customer_name: document.getElementById('contract-name').value.trim(),
                customer_company: document.getElementById('contract-company').value.trim() || null,
                client_street: document.getElementById('contract-street').value.trim(),
                client_postal_code: document.getElementById('contract-postal').value.trim(),
                client_city: document.getElementById('contract-city').value.trim(),
                client_country: document.getElementById('contract-country').value.trim() || 'Polska',
                client_pesel: document.getElementById('contract-pesel').value.trim(),
                client_id_number: document.getElementById('contract-id-number').value.trim().toUpperCase(),
                client_nip: document.getElementById('contract-nip').value.trim() || null,
                customer_email: document.getElementById('contract-email').value.trim(),
                customer_phone: document.getElementById('contract-phone').value.trim()
            };

            // Validate required fields
            const required = ['customer_name', 'client_street', 'client_postal_code', 'client_city', 'client_pesel', 'client_id_number', 'customer_email', 'customer_phone'];
            const missing = required.filter(f => !data[f]);

            if (missing.length > 0) {
                showToast('Wypelnij wszystkie wymagane pola', 'error');
                return;
            }

            // Validate PESEL (11 digits)
            if (!/^\d{11}$/.test(data.client_pesel)) {
                showToast('PESEL musi miec 11 cyfr', 'error');
                return;
            }

            // Update workflow
            const updates = {
                ...data,
                contract_status: 'data_filled',
                contract_data_filled_at: new Date().toISOString()
            };

            const { error } = await supabaseClient
                .from('workflows')
                .update(updates)
                .eq('id', workflow.id);

            if (error) {
                console.error('Error saving contract data:', error);
                showToast('Blad zapisywania danych', 'error');
                return;
            }

            Object.assign(workflow, updates);
            isEditingContract = false;

            // Log activity
            logActivity('contract_data_saved', `Zapisano dane do umowy: ${data.customer_name}`, { customer_name: data.customer_name, customer_company: data.customer_company });

            showToast('Dane zapisane', 'success');
            loadContractData(); // Reload to update readonly view
        }
        window.saveContractData = saveContractData;

        async function generateContract() {
            if (!contractTemplateUrl || !workflow) return;

            try {
                // Fetch the contract template HTML
                const response = await fetch(contractTemplateUrl);
                if (!response.ok) {
                    throw new Error('Nie mozna pobrac szablonu umowy');
                }
                let html = await response.text();

                const today = new Date().toLocaleDateString('pl-PL', { day: 'numeric', month: 'long', year: 'numeric' });
                const startDate = workflow.started_at
                    ? new Date(workflow.started_at).toLocaleDateString('pl-PL')
                    : today;

                const adresParts = [workflow.client_street, [workflow.client_postal_code, workflow.client_city].filter(Boolean).join(' ')].filter(Boolean).join(', ');
                const firmaLinia = workflow.customer_company ? (' / ' + workflow.customer_company) : '';

                const variables = {
                    '{{imie_nazwisko}}': workflow.customer_name || '',
                    '{{firma}}': workflow.customer_company || '',
                    '{{firma_linia}}': firmaLinia,
                    '{{nip}}': workflow.client_nip || '',
                    '{{adres}}': adresParts,
                    '{{nr_umowy}}': workflow.contract_number || (workflow.id ? workflow.id.substring(0, 8).toUpperCase() : ''),
                    '{{data_zawarcia}}': today,
                    '{{ulica}}': workflow.client_street || '',
                    '{{miasto}}': workflow.client_city || '',
                    '{{kod_pocztowy}}': workflow.client_postal_code || '',
                    '{{kraj}}': workflow.client_country || 'Polska',
                    '{{pesel}}': workflow.client_pesel || '',
                    '{{dowod}}': workflow.client_id_number || '',
                    '{{nr_dowodu}}': workflow.client_id_number || '',
                    '{{email}}': workflow.customer_email || '',
                    '{{telefon}}': workflow.customer_phone || '',
                    '{{nazwa_oferty}}': workflow.offer_name || '',
                    '{{kwota}}': formatPrice(workflow.amount),
                    '{{cena}}': formatPrice(workflow.amount),
                    '{{data}}': today,
                    '{{data_dzis}}': today,
                    '{{data_rozpoczecia}}': startDate
                };

                Object.entries(variables).forEach(([key, value]) => {
                    html = html.replace(new RegExp(key.replace(/[{}]/g, '\\$&'), 'g'), value);
                });

                contractHtml = html;

                // Show preview (extract text content for display)
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                document.getElementById('contract-text').textContent = tempDiv.textContent || tempDiv.innerText || '';
            } catch (err) {
                console.error('Error generating contract:', err);
                document.getElementById('contract-text').textContent = 'Blad ladowania szablonu umowy.';
            }
        }
        window.generateContract = generateContract;

        let isCodeViewMode = false;
        let originalContractHtml = null;

        function toggleContractCodeView() {
            isCodeViewMode = !isCodeViewMode;
            const previewEl = document.getElementById('contract-preview-mode');
            const codeEl = document.getElementById('contract-code-mode');
            const labelEl = document.getElementById('toggle-code-label');

            if (isCodeViewMode) {
                // Switch to code editor
                previewEl.classList.add('hidden');
                codeEl.classList.remove('hidden');
                labelEl.textContent = 'Podglad tekstu';

                // Load HTML into editor
                if (contractHtml) {
                    originalContractHtml = contractHtml;
                    document.getElementById('contract-html-editor').value = contractHtml;
                }
            } else {
                // Switch to preview
                previewEl.classList.remove('hidden');
                codeEl.classList.add('hidden');
                labelEl.textContent = 'Edytuj HTML';

                // Refresh preview with current HTML
                if (contractHtml) {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = contractHtml;
                    document.getElementById('contract-text').textContent = tempDiv.textContent || tempDiv.innerText || '';
                }
            }
        }
        window.toggleContractCodeView = toggleContractCodeView;

        function saveContractHtml() {
            const editor = document.getElementById('contract-html-editor');
            contractHtml = editor.value;

            document.getElementById('contract-save-status').textContent = 'Zapisano (tylko w sesji)';
            setTimeout(() => {
                document.getElementById('contract-save-status').textContent = '';
            }, 3000);

            showToast('Zmiany zapisane', 'success');
        }
        window.saveContractHtml = saveContractHtml;

        function resetContractHtml() {
            if (originalContractHtml) {
                document.getElementById('contract-html-editor').value = originalContractHtml;
                contractHtml = originalContractHtml;
                showToast('Przywrocono oryginał', 'info');
            } else {
                generateContract();
                showToast('Pobrano ponownie z szablonu', 'info');
            }
        }
        window.resetContractHtml = resetContractHtml;

        async function downloadContractPDF() {
            if (!contractHtml) {
                showToast('Najpierw wygeneruj podglad umowy', 'error');
                return;
            }

            // Open contract HTML in a new tab — the template has @media print CSS
            // User saves as PDF via browser print dialog (Ctrl+P → Save as PDF)
            const clientName = workflow.customer_name?.trim() || 'klient';
            const pdfTitle = `Umowa_${clientName.replace(/\s+/g, '_')}`;
            // Set document title so browser uses it as default PDF filename
            let html = contractHtml.replace(/<title>[^<]*<\/title>/, `<title>${pdfTitle}</title>`);
            const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const win = window.open(url, '_blank');
            if (win) {
                win.onload = () => {
                    URL.revokeObjectURL(url);
                    win.print();
                };
            } else {
                URL.revokeObjectURL(url);
                showToast('Odblokuj wyskakujące okna w przeglądarce', 'error');
            }
        }
        window.downloadContractPDF = downloadContractPDF;

        async function sendContractToClient() {
            const fileInput = document.getElementById('seller-signed-contract');
            const file = fileInput?.files[0];

            let sellerSignedUrl = null;

            // Upload seller-signed contract PDF if provided
            if (file) {
                const fileExt = file.name.split('.').pop();
                const fileName = `contracts/${workflow.id}/seller_signed_${Date.now()}.${fileExt}`;

                const { data: uploadData, error: uploadError } = await supabaseClient.storage
                    .from('attachments')
                    .upload(fileName, file);

                if (uploadError) {
                    showToast('Blad przesylania pliku', 'error');
                    return;
                }

                const { data: urlData } = supabaseClient.storage
                    .from('attachments')
                    .getPublicUrl(fileName);

                sellerSignedUrl = urlData.publicUrl;
            }

            const updateData = {
                contract_status: 'signed',
                contract_signed_at: new Date().toISOString()
            };

            if (sellerSignedUrl) {
                updateData.contract_seller_signed_url = sellerSignedUrl;
            }

            const { error } = await supabaseClient
                .from('workflows')
                .update(updateData)
                .eq('id', workflow.id);

            if (error) {
                showToast('Blad wysylania', 'error');
                return;
            }

            // Send email to client
            const clientEmail = workflow.customer_email;
            const clientName = workflow.customer_name || workflow.customer_company || 'Klient';
            const projectUrl = `https://crm.tomekniedzwiecki.pl/projekt/${workflow.unique_token}`;
            const offerName = workflow.offer_name || 'Projekt';

            if (clientEmail) {
                try {
                    await supabaseClient.functions.invoke('automation-trigger', {
                        body: {
                            trigger_type: 'contract_sent',
                            entity_type: 'workflow',
                            entity_id: workflow.id,
                            context: {
                                email: clientEmail,
                                clientName: clientName,
                                offerName: offerName,
                                projectUrl: projectUrl,
                                contractUrl: sellerSignedUrl || projectUrl
                            }
                        }
                    });
                } catch (emailError) {
                    console.warn('Automation trigger error:', emailError);
                }
            }

            workflow.contract_status = 'signed';
            workflow.contract_signed_at = new Date().toISOString();
            if (sellerSignedUrl) {
                workflow.contract_seller_signed_url = sellerSignedUrl;
            }

            // Log activity
            logActivity('contract_sent', `Wysłano umowę do klienta: ${clientName}`, { client_email: clientEmail, has_signed_file: !!sellerSignedUrl });

            showToast('Umowa wyslana do klienta!', 'success');
            updateContractUI();
        }
        window.sendContractToClient = sendContractToClient;

        // =============================================
        // MATERIALS MANAGEMENT
        // =============================================
        let materials = [];

        async function loadMaterials() {
            const { data, error } = await supabaseClient
                .from('workflow_materials')
                .select('*')
                .eq('workflow_id', workflow.id)
                .order('uploaded_at', { ascending: false });

            if (error) {
                console.error('Error loading materials:', error);
                return;
            }

            materials = data || [];
            renderMaterials();
        }

        function renderMaterials() {
            const container = document.getElementById('materials-list');
            const emptyState = document.getElementById('materials-empty');

            if (materials.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            container.innerHTML = materials.map(m => `
                <div class="bg-zinc-900/40 border border-white/5 rounded-lg p-4 hover:border-white/10 transition-colors">
                    <div class="flex items-start gap-3">
                        <div class="w-10 h-10 rounded-lg bg-cyan-500/10 flex items-center justify-center flex-shrink-0">
                            <i class="ph ph-${getFileIcon(m.file_type)} text-cyan-400"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h4 class="text-white font-medium truncate">${m.title}</h4>
                            ${m.description ? `<p class="text-zinc-500 text-xs mt-1 line-clamp-2">${m.description}</p>` : ''}
                            <div class="flex items-center gap-3 mt-2 text-xs text-zinc-500">
                                <span>${m.category || 'other'}</span>
                                <span>•</span>
                                <span>${formatFileSize(m.file_size)}</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-1">
                            <button onclick="toggleMaterialVisibility('${m.id}')" class="p-1.5 ${m.visible_to_client ? 'text-emerald-400' : 'text-zinc-600'} hover:bg-white/5 rounded transition-colors" title="${m.visible_to_client ? 'Widoczny dla klienta' : 'Ukryty przed klientem'}">
                                <i class="ph ph-eye${m.visible_to_client ? '' : '-slash'}"></i>
                            </button>
                            <a href="${m.file_url}" target="_blank" class="p-1.5 text-zinc-400 hover:text-white hover:bg-white/5 rounded transition-colors" title="Pobierz">
                                <i class="ph ph-download-simple"></i>
                            </a>
                            <button onclick="deleteMaterial('${m.id}')" class="p-1.5 text-zinc-500 hover:text-red-400 hover:bg-red-500/10 rounded transition-colors" title="Usun">
                                <i class="ph ph-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function getFileIcon(fileType) {
            const icons = {
                'pdf': 'file-pdf',
                'doc': 'file-doc',
                'docx': 'file-doc',
                'xls': 'file-xls',
                'xlsx': 'file-xls',
                'ppt': 'file-ppt',
                'pptx': 'file-ppt',
                'zip': 'file-zip',
                'rar': 'file-zip',
                'jpg': 'file-image',
                'jpeg': 'file-image',
                'png': 'file-image',
                'gif': 'file-image',
                'svg': 'file-image',
                'mp4': 'file-video',
                'mov': 'file-video',
                'mp3': 'file-audio',
                'wav': 'file-audio'
            };
            return icons[fileType?.toLowerCase()] || 'file';
        }

        function formatFileSize(bytes) {
            if (!bytes) return '-';
            const units = ['B', 'KB', 'MB', 'GB'];
            let i = 0;
            while (bytes >= 1024 && i < units.length - 1) {
                bytes /= 1024;
                i++;
            }
            return bytes.toFixed(1) + ' ' + units[i];
        }

        async function toggleMaterialVisibility(id) {
            const material = materials.find(m => m.id === id);
            if (!material) return;

            const { error } = await supabaseClient
                .from('workflow_materials')
                .update({ visible_to_client: !material.visible_to_client })
                .eq('id', id);

            if (!error) {
                material.visible_to_client = !material.visible_to_client;
                renderMaterials();
            }
        }

        async function deleteMaterial(id) {
            const material = materials.find(m => m.id === id);
            if (!confirm('Usunac ten material?')) return;

            const { error } = await supabaseClient
                .from('workflow_materials')
                .delete()
                .eq('id', id);

            if (!error) {
                // Log activity
                logActivity('material_deleted', `Usunięto materiał: ${material?.title || 'materiał'}`, { material_id: id });

                materials = materials.filter(m => m.id !== id);
                renderMaterials();
                showToast('Material usuniety', 'success');
            }
        }

        function openMaterialModal() {
            // TODO: Implement material upload modal
            showToast('Funkcja w przygotowaniu', 'info');
        }
        window.openMaterialModal = openMaterialModal;

        // =============================================
        // BRANDING MANAGEMENT
        // =============================================
        let brandingItems = [];
        let brandingProduct = null;

        async function loadBranding() {
            const { data, error } = await supabaseClient
                .from('workflow_branding')
                .select('*')
                .eq('workflow_id', workflow.id)
                .order('sort_order');

            if (error) {
                console.error('Error loading branding:', error);
                return;
            }

            brandingItems = data || [];

            // Load product for prompt generation
            if (workflow.selected_product_id) {
                const { data: prod } = await supabaseClient
                    .from('workflow_products')
                    .select('name, description, image_url')
                    .eq('id', workflow.selected_product_id)
                    .single();
                brandingProduct = prod;
            }

            renderBranding();
        }

        const loadedFonts = new Set();
        function loadGoogleFont(fontName, weights) {
            const key = fontName + weights.join(',');
            if (loadedFonts.has(key)) return;
            loadedFonts.add(key);
            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = `https://fonts.googleapis.com/css2?family=${encodeURIComponent(fontName)}:wght@${weights.join(';')}&display=swap`;
            document.head.appendChild(link);
        }

        function parseNotes(notes) {
            if (!notes) return {};
            try { return JSON.parse(notes); } catch(e) { return {}; }
        }

        function hexToRgb(hex) {
            const r = parseInt(hex.slice(1,3), 16);
            const g = parseInt(hex.slice(3,5), 16);
            const b = parseInt(hex.slice(5,7), 16);
            return `${r}, ${g}, ${b}`;
        }

        const roleLabels = { primary: 'Primary', secondary: 'Secondary', accent: 'Accent', neutral: 'Neutral', other: '' };
        const variantLabels = { main: 'Główne', dark: 'Ciemne tło', light: 'Jasne tło', mono: 'Mono', favicon: 'Favicon' };
        const fontRoleLabels = { heading: 'Nagłówki', body: 'Tekst', accent: 'Akcent' };

        function renderBranding() {
            const brandInfo = brandingItems.find(b => b.type === 'brand_info');
            const logos = brandingItems.filter(b => b.type === 'logo');
            const colors = brandingItems.filter(b => b.type === 'color');
            const fonts = brandingItems.filter(b => b.type === 'font');
            const mockups = brandingItems.filter(b => b.type === 'mockup');
            const guidelines = brandingItems.filter(b => b.type === 'guideline');

            // Brand Info
            const infoContainer = document.getElementById('branding-info');
            const infoEmpty = document.getElementById('branding-info-empty');
            if (brandInfo) {
                const info = parseNotes(brandInfo.value);
                infoEmpty.classList.add('hidden');
                infoContainer.classList.remove('hidden');
                document.getElementById('brand-info-name').textContent = info.name || '';
                const domainEl = document.getElementById('brand-info-domain');
                if (info.domain) {
                    domainEl.textContent = info.domain;
                    domainEl.classList.remove('hidden');
                } else {
                    domainEl.classList.add('hidden');
                }
                document.getElementById('brand-info-tagline').textContent = info.tagline || '';
                document.getElementById('brand-info-description').textContent = info.description || '';
            } else {
                infoEmpty.classList.remove('hidden');
                infoContainer.classList.add('hidden');
            }

            // Logos - render items + dropzone in grid
            const logosGrid = document.getElementById('branding-logos-grid');
            if (logosGrid) {
                const logoItems = logos.map(l => {
                    const meta = parseNotes(l.notes);
                    const bgClass = meta.variant === 'light' ? 'bg-white' : 'bg-zinc-900';
                    return `
                    <div class="relative group">
                        <div class="${bgClass} border border-white/5 rounded-lg p-4 aspect-square flex items-center justify-center cursor-pointer" onclick="openImageLightbox('${l.file_url}')">
                            <img src="${l.file_url}" alt="${l.title}" class="max-w-full max-h-full object-contain">
                        </div>
                        <button onclick="deleteBrandingItem('${l.id}')" class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                            <i class="ph ph-x text-xs"></i>
                        </button>
                    </div>`;
                }).join('');
                const dropzone = `
                    <div id="logo-dropzone"
                        class="bg-zinc-900/40 border-2 border-dashed border-zinc-700 rounded-lg p-6 text-center cursor-pointer hover:border-pink-500/50 hover:bg-pink-500/5 transition-all min-h-[120px] flex flex-col items-center justify-center"
                        onclick="document.getElementById('logo-direct-input').click()"
                        ondragover="event.preventDefault(); this.classList.add('border-pink-500', 'bg-pink-500/10')"
                        ondragleave="this.classList.remove('border-pink-500', 'bg-pink-500/10')"
                        ondrop="event.preventDefault(); this.classList.remove('border-pink-500', 'bg-pink-500/10'); handleDirectLogoDrop(event)">
                        <i class="ph ph-plus text-xl text-zinc-600 mb-1"></i>
                        <p class="text-zinc-500 text-xs">Przeciągnij lub kliknij</p>
                        <input type="file" id="logo-direct-input" accept=".png,.jpg,.jpeg,.webp,.svg" class="hidden" onchange="handleDirectLogoUpload(event)">
                    </div>`;
                logosGrid.innerHTML = logoItems + dropzone;

                // Set favicon
                const faviconLogo = logos.find(l => { const m = parseNotes(l.notes); return m.variant === 'favicon'; })
                    || logos.find(l => { const m = parseNotes(l.notes); return m.variant === 'main'; })
                    || logos[0];
                if (faviconLogo) {
                    setFaviconHref(faviconLogo.file_url + '?v=' + Date.now(), 'image/png');
                }
            }

            // Colors
            const colorsContainer = document.getElementById('branding-colors');
            const colorsEmpty = document.getElementById('branding-colors-empty');
            if (colors.length > 0) {
                colorsEmpty.classList.add('hidden');
                colorsContainer.innerHTML = colors.map(c => {
                    const meta = parseNotes(c.notes);
                    const role = roleLabels[meta.role] || '';
                    const rgb = hexToRgb(c.value || '#000000');
                    return `
                    <div class="relative group bg-zinc-900/40 border border-white/5 rounded-lg overflow-hidden">
                        <div class="h-20 w-full" style="background: ${c.value}"></div>
                        <div class="p-3">
                            <div class="flex items-center justify-between">
                                <p class="text-white text-sm font-medium">${c.title}</p>
                                ${role ? `<span class="text-[10px] text-zinc-500 uppercase tracking-wider">${role}</span>` : ''}
                            </div>
                            <p class="text-zinc-500 text-xs font-mono mt-1">${c.value}</p>
                            <p class="text-zinc-600 text-xs font-mono">RGB ${rgb}</p>
                        </div>
                        <button onclick="deleteBrandingItem('${c.id}')" class="absolute top-2 right-2 w-6 h-6 bg-black/60 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                            <i class="ph ph-x text-xs"></i>
                        </button>
                    </div>`;
                }).join('');
            } else {
                colorsEmpty.classList.remove('hidden');
                colorsContainer.innerHTML = '';
            }

            // Fonts
            const fontsContainer = document.getElementById('branding-fonts');
            const fontsEmpty = document.getElementById('branding-fonts-empty');
            if (fonts.length > 0) {
                fontsEmpty.classList.add('hidden');
                fonts.forEach(f => {
                    const meta = parseNotes(f.notes);
                    const weights = meta.weights || ['400'];
                    loadGoogleFont(f.title, weights);
                });
                fontsContainer.innerHTML = fonts.map(f => {
                    const meta = parseNotes(f.notes);
                    const role = fontRoleLabels[meta.role] || '';
                    const weights = meta.weights ? meta.weights.join(', ') : '';
                    return `
                    <div class="bg-zinc-900/40 border border-white/5 rounded-lg p-5 relative group">
                        <div class="flex items-center justify-between mb-3">
                            <div>
                                <p class="text-white font-medium">${f.title}</p>
                                ${role ? `<span class="text-[10px] text-zinc-500 uppercase tracking-wider">${role}</span>` : ''}
                            </div>
                            <button onclick="deleteBrandingItem('${f.id}')" class="text-zinc-600 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity">
                                <i class="ph ph-x"></i>
                            </button>
                        </div>
                        <p class="text-3xl text-white mb-2" style="font-family: '${f.title}', sans-serif">Aa Bb Cc Dd Ee</p>
                        <p class="text-sm text-zinc-500" style="font-family: '${f.title}', sans-serif">The quick brown fox jumps over the lazy dog</p>
                        ${weights ? `<p class="text-zinc-600 text-xs mt-3 font-mono">Wagi: ${weights}</p>` : ''}
                    </div>`;
                }).join('');
            } else {
                fontsEmpty.classList.remove('hidden');
                fontsContainer.innerHTML = '';
            }

            // Mockups - render items + dropzone in grid
            const mockupsGrid = document.getElementById('branding-mockups-grid');
            if (mockupsGrid) {
                const mockupItems = mockups.map(m => `
                    <div class="relative group">
                        <div class="bg-zinc-900 border border-white/5 rounded-lg overflow-hidden aspect-square cursor-pointer" onclick="openImageLightbox('${m.file_url}')">
                            <img src="${m.file_url}" alt="${m.title}" class="w-full h-full object-cover">
                        </div>
                        <button onclick="deleteBrandingItem('${m.id}')" class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                            <i class="ph ph-x text-xs"></i>
                        </button>
                    </div>
                `).join('');
                const dropzone = `
                    <div id="mockup-dropzone"
                        class="bg-zinc-900/40 border-2 border-dashed border-zinc-700 rounded-lg p-6 text-center cursor-pointer hover:border-pink-500/50 hover:bg-pink-500/5 transition-all min-h-[120px] flex flex-col items-center justify-center"
                        onclick="document.getElementById('mockup-direct-input').click()"
                        ondragover="event.preventDefault(); this.classList.add('border-pink-500', 'bg-pink-500/10')"
                        ondragleave="this.classList.remove('border-pink-500', 'bg-pink-500/10')"
                        ondrop="event.preventDefault(); this.classList.remove('border-pink-500', 'bg-pink-500/10'); handleDirectMockupDrop(event)">
                        <i class="ph ph-plus text-xl text-zinc-600 mb-1"></i>
                        <p class="text-zinc-500 text-xs">Przeciągnij lub kliknij</p>
                        <input type="file" id="mockup-direct-input" accept=".png,.jpg,.jpeg,.webp" class="hidden" onchange="handleDirectMockupUpload(event)">
                    </div>`;
                mockupsGrid.innerHTML = mockupItems + dropzone;
            }

            // Render mockup prompts inline
            renderMockupPromptsInline();

            updateBrandingDeliverUI();
        }

        async function deleteBrandingItem(id) {
            // Remove file from storage if exists
            const item = brandingItems.find(b => b.id === id);
            if (item?.file_url) {
                const path = item.file_url.split('/storage/v1/object/public/attachments/')[1];
                if (path) {
                    await supabaseClient.storage.from('attachments').remove([decodeURIComponent(path)]);
                }
            }

            const { error } = await supabaseClient
                .from('workflow_branding')
                .delete()
                .eq('id', id);

            if (!error) {
                // Log activity
                logActivity('branding_item_deleted', `Usunięto element brandingu: ${item?.title || item?.type || 'element'}`, { item_id: id, item_type: item?.type });

                brandingItems = brandingItems.filter(b => b.id !== id);
                renderBranding();
                showToast('Element usunięty', 'success');
            }
        }

        // --- Brand Info Modal ---
        function openBrandInfoModal() {
            const existing = brandingItems.find(b => b.type === 'brand_info');
            if (existing) {
                const info = parseNotes(existing.value);
                document.getElementById('brand-info-name-input').value = info.name || '';
                document.getElementById('brand-info-tagline-input').value = info.tagline || '';
                document.getElementById('brand-info-description-input').value = info.description || '';
            } else {
                document.getElementById('brand-info-name-input').value = '';
                document.getElementById('brand-info-tagline-input').value = '';
                document.getElementById('brand-info-description-input').value = '';
            }
            document.getElementById('brand-info-modal').classList.remove('hidden');
        }
        function closeBrandInfoModal() { document.getElementById('brand-info-modal').classList.add('hidden'); }

        async function saveBrandInfo() {
            const name = document.getElementById('brand-info-name-input').value.trim();
            const tagline = document.getElementById('brand-info-tagline-input').value.trim();
            const description = document.getElementById('brand-info-description-input').value.trim();
            if (!name) { showToast('Podaj nazwę marki', 'error'); return; }

            const value = JSON.stringify({ name, tagline, description });
            const existing = brandingItems.find(b => b.type === 'brand_info');

            if (existing) {
                const { error } = await supabaseClient.from('workflow_branding').update({ value, title: name }).eq('id', existing.id);
                if (error) { showToast('Błąd zapisu', 'error'); return; }
            } else {
                const { error } = await supabaseClient.from('workflow_branding').insert({ workflow_id: workflow.id, type: 'brand_info', title: name, value, sort_order: 0 });
                if (error) { showToast('Błąd zapisu', 'error'); return; }
            }

            // Log activity
            logActivity('brand_info_saved', `Zapisano informacje o marce: ${name}`, { brand_name: name, tagline });

            closeBrandInfoModal();
            showToast('Zapisano informacje o marce', 'success');
            await loadBranding();
        }

        // --- Logo Modal ---
        function openLogoModal() {
            document.getElementById('logo-variant-input').value = 'main';
            document.getElementById('logo-file-input').value = '';
            document.getElementById('logo-dropzone-text').textContent = 'Przeciągnij plik lub kliknij';
            document.getElementById('logo-upload-progress').classList.add('hidden');
            document.getElementById('logo-modal').classList.remove('hidden');
        }
        function closeLogoModal() { document.getElementById('logo-modal').classList.add('hidden'); }

        function handleLogoFileDrop(event) {
            const file = event.dataTransfer.files[0];
            if (file) {
                const input = document.getElementById('logo-file-input');
                const dt = new DataTransfer();
                dt.items.add(file);
                input.files = dt.files;
                document.getElementById('logo-dropzone-text').textContent = file.name;
            }
        }

        document.getElementById('logo-file-input')?.addEventListener('change', function() {
            if (this.files[0]) {
                document.getElementById('logo-dropzone-text').textContent = this.files[0].name;
            }
        });

        async function saveLogo() {
            const variant = document.getElementById('logo-variant-input').value;
            const file = document.getElementById('logo-file-input').files[0];
            if (!file) { showToast('Wybierz plik', 'error'); return; }
            const title = variantLabels[variant] || variant;

            document.getElementById('logo-upload-progress').classList.remove('hidden');
            const ext = file.name.split('.').pop();
            const fileName = `branding/${workflow.id}/logo_${variant}_${Date.now()}.${ext}`;

            const { error: uploadError } = await supabaseClient.storage.from('attachments').upload(fileName, file);
            if (uploadError) { showToast('Błąd przesyłania', 'error'); document.getElementById('logo-upload-progress').classList.add('hidden'); return; }

            const { data: urlData } = supabaseClient.storage.from('attachments').getPublicUrl(fileName);

            const { error } = await supabaseClient.from('workflow_branding').insert({
                workflow_id: workflow.id, type: 'logo', title, file_url: urlData.publicUrl,
                notes: JSON.stringify({ variant }), sort_order: brandingItems.filter(b => b.type === 'logo').length
            });

            document.getElementById('logo-upload-progress').classList.add('hidden');
            if (error) { showToast('Błąd zapisu', 'error'); return; }

            // Log activity
            logActivity('logo_added', `Dodano logo: ${title}`, { variant, file_name: file.name });

            closeLogoModal();
            showToast('Logo dodane', 'success');
            await loadBranding();
        }

        // --- Color Modal ---
        function openColorModal() {
            document.getElementById('color-title-input').value = '';
            document.getElementById('color-role-input').value = 'primary';
            document.getElementById('color-hex-input').value = '#6366f1';
            document.getElementById('color-picker-input').value = '#6366f1';
            document.getElementById('color-modal').classList.remove('hidden');
        }
        function closeColorModal() { document.getElementById('color-modal').classList.add('hidden'); }

        async function saveColor() {
            const title = document.getElementById('color-title-input').value.trim();
            const role = document.getElementById('color-role-input').value;
            const hex = document.getElementById('color-hex-input').value.trim();
            if (!title || !hex) { showToast('Podaj nazwę i kolor', 'error'); return; }

            const { error } = await supabaseClient.from('workflow_branding').insert({
                workflow_id: workflow.id, type: 'color', title, value: hex,
                notes: JSON.stringify({ role }), sort_order: brandingItems.filter(b => b.type === 'color').length
            });

            if (error) { showToast('Błąd zapisu', 'error'); return; }

            // Log activity
            logActivity('color_added', `Dodano kolor: ${title} (${hex})`, { color_name: title, hex, role });

            closeColorModal();
            showToast('Kolor dodany', 'success');
            await loadBranding();
        }

        // --- Font Modal ---
        function openFontModal() {
            document.getElementById('font-title-input').value = '';
            document.getElementById('font-role-input').value = 'heading';
            document.getElementById('font-weights-input').value = '400, 700';
            document.getElementById('font-modal').classList.remove('hidden');
        }
        function closeFontModal() { document.getElementById('font-modal').classList.add('hidden'); }

        async function saveFont() {
            const title = document.getElementById('font-title-input').value.trim();
            const role = document.getElementById('font-role-input').value;
            const weightsStr = document.getElementById('font-weights-input').value.trim();
            if (!title) { showToast('Podaj nazwę czcionki', 'error'); return; }

            const weights = weightsStr ? weightsStr.split(',').map(w => w.trim()).filter(Boolean) : [];

            const { error } = await supabaseClient.from('workflow_branding').insert({
                workflow_id: workflow.id, type: 'font', title, value: role,
                notes: JSON.stringify({ role, weights }), sort_order: brandingItems.filter(b => b.type === 'font').length
            });

            if (error) { showToast('Błąd zapisu', 'error'); return; }

            // Log activity
            logActivity('font_added', `Dodano czcionkę: ${title}`, { font_name: title, role, weights });

            closeFontModal();
            showToast('Czcionka dodana', 'success');
            await loadBranding();
        }

        // --- Mockup Modal ---
        function openMockupModal() {
            document.getElementById('mockup-file-input').value = '';
            document.getElementById('mockup-dropzone-text').textContent = 'Przeciągnij plik lub kliknij';
            document.getElementById('mockup-upload-progress').classList.add('hidden');
            document.getElementById('mockup-modal').classList.remove('hidden');
        }
        function closeMockupModal() { document.getElementById('mockup-modal').classList.add('hidden'); }

        function handleMockupFileDrop(event) {
            const file = event.dataTransfer.files[0];
            if (file) {
                const input = document.getElementById('mockup-file-input');
                const dt = new DataTransfer();
                dt.items.add(file);
                input.files = dt.files;
                document.getElementById('mockup-dropzone-text').textContent = file.name;
            }
        }

        document.getElementById('mockup-file-input')?.addEventListener('change', function() {
            if (this.files[0]) {
                document.getElementById('mockup-dropzone-text').textContent = this.files[0].name;
            }
        });

        async function saveMockup() {
            const file = document.getElementById('mockup-file-input').files[0];
            if (!file) { showToast('Wybierz plik', 'error'); return; }
            const title = file.name.replace(/\.[^.]+$/, '').replace(/[_-]/g, ' ');

            document.getElementById('mockup-upload-progress').classList.remove('hidden');
            const ext = file.name.split('.').pop();
            const fileName = `branding/${workflow.id}/mockup_${Date.now()}.${ext}`;

            const { error: uploadError } = await supabaseClient.storage.from('attachments').upload(fileName, file);
            if (uploadError) { showToast('Błąd przesyłania', 'error'); document.getElementById('mockup-upload-progress').classList.add('hidden'); return; }

            const { data: urlData } = supabaseClient.storage.from('attachments').getPublicUrl(fileName);

            const { error } = await supabaseClient.from('workflow_branding').insert({
                workflow_id: workflow.id, type: 'mockup', title, file_url: urlData.publicUrl,
                sort_order: brandingItems.filter(b => b.type === 'mockup').length
            });

            document.getElementById('mockup-upload-progress').classList.add('hidden');
            if (error) { showToast('Błąd zapisu', 'error'); return; }

            // Log activity
            logActivity('mockup_added', `Dodano mockup: ${title}`, { file_name: file.name });

            closeMockupModal();
            showToast('Mockup dodany', 'success');
            await loadBranding();
        }

        // --- Guideline Modal ---
        function openGuidelineModal() {
            document.getElementById('guideline-title-input').value = '';
            document.getElementById('guideline-notes-input').value = '';
            document.getElementById('guideline-file-input').value = '';
            document.getElementById('guideline-upload-progress').classList.add('hidden');
            document.getElementById('guideline-modal').classList.remove('hidden');
        }
        function closeGuidelineModal() { document.getElementById('guideline-modal').classList.add('hidden'); }

        async function saveGuideline() {
            const title = document.getElementById('guideline-title-input').value.trim();
            const notes = document.getElementById('guideline-notes-input').value.trim();
            const file = document.getElementById('guideline-file-input').files[0];
            if (!title || !file) { showToast('Podaj nazwę i wybierz plik', 'error'); return; }

            document.getElementById('guideline-upload-progress').classList.remove('hidden');
            const ext = file.name.split('.').pop();
            const fileName = `branding/${workflow.id}/guideline_${Date.now()}.${ext}`;

            const { error: uploadError } = await supabaseClient.storage.from('attachments').upload(fileName, file);
            if (uploadError) { showToast('Błąd przesyłania', 'error'); document.getElementById('guideline-upload-progress').classList.add('hidden'); return; }

            const { data: urlData } = supabaseClient.storage.from('attachments').getPublicUrl(fileName);

            const { error } = await supabaseClient.from('workflow_branding').insert({
                workflow_id: workflow.id, type: 'guideline', title, file_url: urlData.publicUrl,
                notes, sort_order: brandingItems.filter(b => b.type === 'guideline').length
            });

            document.getElementById('guideline-upload-progress').classList.add('hidden');
            if (error) { showToast('Błąd zapisu', 'error'); return; }

            // Log activity
            logActivity('guideline_added', `Dodano wytyczne: ${title}`, { file_name: file.name });

            closeGuidelineModal();
            showToast('Plik dodany', 'success');
            await loadBranding();
        }

        // Expose all branding functions
        window.openBrandInfoModal = openBrandInfoModal;
        window.closeBrandInfoModal = closeBrandInfoModal;
        window.saveBrandInfo = saveBrandInfo;
        window.openLogoModal = openLogoModal;
        window.closeLogoModal = closeLogoModal;
        window.saveLogo = saveLogo;
        window.openColorModal = openColorModal;
        window.closeColorModal = closeColorModal;
        window.saveColor = saveColor;
        window.openFontModal = openFontModal;
        window.closeFontModal = closeFontModal;
        window.saveFont = saveFont;
        window.openMockupModal = openMockupModal;
        window.closeMockupModal = closeMockupModal;
        window.saveMockup = saveMockup;
        window.openGuidelineModal = openGuidelineModal;
        window.closeGuidelineModal = closeGuidelineModal;
        window.saveGuideline = saveGuideline;

        // =============================================
        // AI PROMPTS GENERATOR (reusable for any brand)
        // =============================================

        /**
         * Generates branding prompts based on current brand data.
         * Reusable for any product/brand — reads from brandingItems.
         * Returns { logo: [...], mockup: [...] }
         */
        function generateBrandingPrompts() {
            const brandInfo = brandingItems.find(b => b.type === 'brand_info');
            const colors = brandingItems.filter(b => b.type === 'color');
            const fonts = brandingItems.filter(b => b.type === 'font');

            if (!brandInfo) return { logo: [], mockup: [] };

            const info = parseNotes(brandInfo.value);
            const name = info.name || 'Brand';
            const tagline = info.tagline || '';
            const description = info.description || '';

            const primaryColor = colors.find(c => { const m = parseNotes(c.notes); return m.role === 'primary'; });
            const secondaryColor = colors.find(c => { const m = parseNotes(c.notes); return m.role === 'secondary'; });
            const accentColor = colors.find(c => { const m = parseNotes(c.notes); return m.role === 'accent'; });
            const neutralColors = colors.filter(c => { const m = parseNotes(c.notes); return m.role === 'neutral'; });

            const headingFont = fonts.find(f => { const m = parseNotes(f.notes); return m.role === 'heading'; });
            const bodyFont = fonts.find(f => { const m = parseNotes(f.notes); return m.role === 'body'; });
            const accentFont = fonts.find(f => { const m = parseNotes(f.notes); return m.role === 'accent'; });

            const primaryHex = primaryColor?.value || '#00D4FF';
            const primaryName = primaryColor?.title || 'primary';
            const secondaryHex = secondaryColor?.value || '#FF2D78';
            const secondaryName = secondaryColor?.title || 'secondary';
            const accentHex = accentColor?.value || '#C8FF00';
            const accentName = accentColor?.title || 'accent';
            const darkNeutral = neutralColors[0]?.value || '#111827';
            const darkNeutralName = neutralColors[0]?.title || 'dark';
            const midNeutral = neutralColors[1]?.value || '#475569';
            const lightNeutral = neutralColors[2]?.value || '#F8FAFC';
            const lightNeutralName = neutralColors[2]?.title || 'light';
            const headingFontName = headingFont?.title || 'Bebas Neue';
            const bodyFontName = bodyFont?.title || 'Inter';
            const accentFontName = accentFont?.title || 'Space Mono';

            const colorPalette = colors.map(c => `${c.title} (${c.value})`).join(', ');

            // Product context
            const productName = brandingProduct?.name || '';
            const productDesc = brandingProduct?.description || '';
            const productContext = productName ? `The brand's flagship product is: ${productName}${productDesc ? ' — ' + productDesc : ''}.` : '';

            // Full brand brief for AI — used inside every prompt
            const brandBrief = [
                `Brand "${name}"`,
                tagline ? `Tagline: "${tagline}"` : '',
                description ? `About: ${description}` : '',
                productContext,
                `Color palette: ${colorPalette}`,
                `Typography: ${headingFontName} (headings), ${bodyFontName} (body), ${accentFontName} (accent)`
            ].filter(Boolean).join('. ') + '.';

            const brandContext = brandBrief;

            // --- LOGO PROMPTS ---
            const logoPrompts = [
                {
                    label: 'Logo główne (ciemne tło)',
                    prompt: `Design a minimalist, modern logo for the brand "${name}". The logo should be typography-based using a ${headingFontName}-style font — the letterforms should reflect the brand's personality and product category. Create a distinctive visual element within the letters that subtly references the product (${productName || 'the brand\'s core offering'}). Use ${primaryHex} (${primaryName}) as the primary color with subtle ${secondaryHex} (${secondaryName}) accents. The logo must work on a ${darkNeutral} (${darkNeutralName}) background. ${description} ${productContext} Output on transparent background, PNG, high resolution.`
                },
                {
                    label: 'Logo na jasnym tle',
                    prompt: `Design a minimalist logo for "${name}" brand, optimized for white/light backgrounds. Use ${darkNeutral} (${darkNeutralName}) as the main text color with ${primaryHex} (${primaryName}) accent on the distinctive brand element. Same ${headingFontName}-style typography and visual motif as the dark version. Clean, professional, suitable for packaging and retail contexts. The logo should feel trustworthy and aligned with the ${productName ? productName + ' category' : 'brand identity'}. Output on transparent background, PNG, high resolution.`
                },
                {
                    label: 'Logo monochromatyczne',
                    prompt: `Create a monochrome version of the "${name}" logo. Pure white version on transparent background (for dark contexts) and pure black version on transparent background (for light contexts). Same typography and distinctive brand element as the main logo. No colors — single tone only. Suitable for embossing on product packaging, watermarks, engraving on the physical ${productName || 'product'}. Output both versions, PNG, high resolution.`
                },
                {
                    label: 'Favicon / ikona',
                    prompt: `Design a compact app icon / favicon for the brand "${name}". Extract the most recognizable visual element from the logo — the distinctive letterform or symbol — and use it as a standalone icon. ${primaryHex} (${primaryName}) on ${darkNeutral} (${darkNeutralName}) background. The icon should instantly evoke "${name}" and its connection to ${productName || 'the product'}. Must be recognizable at 32x32px and 512x512px. Rounded square shape. Minimalist, bold, no text. Output as PNG, square format, high resolution.`
                },
                {
                    label: 'Logo z ikoną (combo)',
                    prompt: `Create a combination mark logo for "${name}" — an abstract icon paired with the wordmark. The icon should visually represent the brand's core concept: ${description ? description.split('.')[0] + '.' : productName || name}. Colors: ${primaryHex} (${primaryName}) for the icon with ${secondaryHex} (${secondaryName}) details, ${lightNeutral} text for the wordmark, on ${darkNeutral} (${darkNeutralName}) background. Typography: ${headingFontName}-style. The icon should be usable separately as a standalone mark. ${productContext} Output on transparent background, PNG, high resolution.`
                },
                {
                    label: 'Logo animowane (concept)',
                    prompt: `Design a logo animation concept sheet for "${name}". Show 4-6 keyframes: 1) Dark ${darkNeutral} screen, a ${primaryHex} (${primaryName}) element appears — inspired by the brand's product (${productName || 'core offering'}). 2) The element transforms/moves with fluid motion. 3) It resolves into the distinctive brand symbol. 4) The full wordmark "${name}" assembles around or alongside the symbol. 5) ${accentHex} (${accentName}) highlight flashes, logo settles with a subtle glow. Dark ${darkNeutral} background throughout. The animation should feel like: ${tagline || description.split('.')[0] || name}. Show as storyboard on one image.`
                }
            ];

            // --- MOCKUP PROMPTS ---
            const mockupPrompts = [
                {
                    label: 'Koszulka z logo',
                    prompt: `Professional product mockup: premium cotton t-shirt with the "${name}" logo printed on the chest. Logo in ${primaryHex} (${primaryName}) with subtle ${secondaryHex} (${secondaryName}) accent. The t-shirt color and setting should match the brand's aesthetic — ${description ? description.split('.').slice(0, 2).join('.') + '.' : ''}. Model or flat-lay in a lifestyle environment appropriate for the ${productName || 'brand'} category. Photography style: modern DTC brand campaign like Quip, Hims, or Glossier. 4K, photorealistic.`
                },
                {
                    label: 'Czapka z logo',
                    prompt: `Professional product mockup: structured cap with the "${name}" logo embroidered on the front in ${primaryHex} (${primaryName}). The distinctive brand icon on the side in ${secondaryHex} (${secondaryName}). Small ${accentHex} (${accentName}) accent stitching on the back strap. Clean, minimal design. Photographed on a styled surface with props that reference the ${productName || 'brand'} world — subtle, tasteful. Bright, premium feel. Photorealistic, studio quality, 4K.`
                },
                {
                    label: 'Kubek / termos z logo',
                    prompt: `Professional product mockup: premium drinkware (mug or travel thermos) with the "${name}" logo and tagline "${tagline}" printed in ${primaryHex} (${primaryName}) and ${darkNeutral}. Photographed on a clean, styled surface next to the ${productName || 'main product'} or in a lifestyle setting that matches the brand's world. Soft natural lighting, warm tones. The drinkware style (matte/glossy, color) should match the brand's palette — base color ${lightNeutral} or ${darkNeutral}. Photorealistic, 4K, product photography.`
                },
                {
                    label: 'Opakowanie produktu',
                    prompt: `Design a premium product packaging box for "${name}" brand's ${productName || 'flagship product'}. The box is predominantly ${lightNeutral} (${lightNeutralName}) with ${primaryHex} (${primaryName}) accent lines and patterns that reflect the product's function. "${name}" logo prominently displayed on front. Side panel shows product silhouette or photo with ${accentHex} (${accentName}) highlight details. Key features listed in ${bodyFontName} font. Subtitle in ${accentFontName}. Soft-touch matte finish with spot UV on the logo. Show 3/4 angle view. Premium unboxing feel — think Apple meets ${productName ? 'the ' + productName + ' category' : 'modern DTC'}. Photorealistic mockup, 4K.`
                },
                {
                    label: `${productName || 'Produkt'} z brandingiem`,
                    prompt: `Professional product mockup: ${productName ? 'a ' + productName : 'the main product'} branded with the "${name}" logo in ${primaryHex} (${primaryName}), subtly applied on the product body. Premium finish — ${secondaryHex} (${secondaryName}) accent details on functional elements. Photographed in a lifestyle setting natural for this product — ${productName ? 'where someone would actually use a ' + productName : 'appropriate for the brand'}. Soft, professional lighting with subtle ${primaryHex} color cast. ${description ? description.split('.')[0] + '.' : ''} Photorealistic, 4K, commercial product photography.`
                },
                {
                    label: 'Social media avatar',
                    prompt: `Design a social media profile picture for the "${name}" brand. Square format (1:1). The favicon/icon version of the logo (the distinctive brand symbol) centered on a ${lightNeutral} (${lightNeutralName}) background with a subtle radial ${primaryHex} (${primaryName}) glow behind it. Clean, bold, instantly recognizable at small sizes. The icon style should reflect the brand's personality — ${tagline || name}. Output 1080x1080px, PNG.`
                },
                {
                    label: 'Banner social media',
                    prompt: `Design a social media cover/banner for "${name}". Wide format (16:9). Left side: the ${productName || 'product'} shown in use or a close-up detail shot with ${primaryHex} (${primaryName}) color tint. Right side: clean space with the "${name}" logo and tagline "${tagline}" in ${headingFontName} font. A flowing design element in ${primaryHex} and ${secondaryHex} connects both halves. Bottom accent in ${accentHex} (${accentName}). ${darkNeutral} or ${lightNeutral} base depending on brand mood. ${description ? description.split('.')[0] + '.' : ''} Output 1920x1080px.`
                },
                {
                    label: 'Naklejki / stickery',
                    prompt: `Design a set of 4 brand stickers for "${name}": 1) Logo die-cut sticker (${primaryHex} ${primaryName} on ${lightNeutral}). 2) Round sticker with the brand icon + "${name}" text. 3) Rectangular sticker with tagline "${tagline}" in ${secondaryHex} (${secondaryName}). 4) Holographic-style sticker with abstract pattern inspired by the ${productName || 'product'} and brand colors (${primaryHex}, ${secondaryHex}, ${accentHex}). All on one sheet, mockup style on a surface appropriate for the brand. Premium sticker aesthetic. High resolution.`
                }
            ];

            return { logo: logoPrompts, mockup: mockupPrompts, brandContext };
        }

        function togglePromptPanel(type) {
            const panel = document.getElementById(`prompts-panel-${type}`);
            if (panel.classList.contains('hidden')) {
                panel.classList.remove('hidden');
                renderPrompts(type);
            } else {
                panel.classList.add('hidden');
            }
        }

        function renderPrompts(type) {
            // First check if we have custom AI prompts in database
            const dbPrompts = brandingItems.filter(b => b.type === 'ai_prompt');
            let list = [];

            if (dbPrompts.length > 0) {
                // Use prompts from database - filter by category
                const categoryMatch = type === 'logo' ? 'logo' : 'mockup';
                list = dbPrompts
                    .filter(p => {
                        const notes = parseNotes(p.notes);
                        return notes.category === categoryMatch;
                    })
                    .sort((a, b) => (a.sort_order || 0) - (b.sort_order || 0))
                    .map(p => ({
                        label: p.title,
                        prompt: p.value
                    }));
            }

            // Fallback to generated prompts if no custom prompts
            if (list.length === 0) {
                const prompts = generateBrandingPrompts();
                list = prompts[type] || [];
            }

            const container = document.getElementById(`prompts-list-${type}`);

            if (list.length === 0) {
                container.innerHTML = '<p class="text-zinc-500 text-xs">Najpierw dodaj informacje o marce, kolory i czcionki.</p>';
                return;
            }

            container.innerHTML = list.map((item, i) => `
                <div class="group">
                    <div class="flex items-start gap-2 bg-black/30 rounded-lg p-3 hover:bg-black/50 transition-colors cursor-pointer" onclick="togglePromptExpand('${type}-${i}')">
                        <i class="ph ph-caret-right text-zinc-600 text-xs mt-0.5 transition-transform" id="prompt-caret-${type}-${i}"></i>
                        <div class="flex-1 min-w-0">
                            <p class="text-white text-xs font-medium">${item.label}</p>
                            <p class="text-zinc-600 text-[10px] truncate">${item.prompt.substring(0, 80)}...</p>
                        </div>
                        <button onclick="event.stopPropagation(); copyPrompt('${type}', ${i})" class="shrink-0 text-zinc-600 hover:text-pink-400 transition-colors p-1" title="Kopiuj prompt">
                            <i class="ph ph-copy text-sm"></i>
                        </button>
                    </div>
                    <div id="prompt-expand-${type}-${i}" class="hidden px-3 pb-3">
                        <div class="bg-black/60 rounded-lg p-3 mt-1 border border-white/5">
                            <p class="text-zinc-300 text-xs leading-relaxed whitespace-pre-wrap font-mono">${item.prompt}</p>
                            <button onclick="copyPrompt('${type}', ${i})" class="mt-2 text-pink-400 hover:text-pink-300 text-[10px] flex items-center gap-1 transition-colors">
                                <i class="ph ph-copy"></i> Kopiuj cały prompt
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function togglePromptExpand(id) {
            const expand = document.getElementById(`prompt-expand-${id}`);
            const caret = document.getElementById(`prompt-caret-${id}`);
            expand.classList.toggle('hidden');
            caret.style.transform = expand.classList.contains('hidden') ? '' : 'rotate(90deg)';
        }

        function copyPrompt(type, index) {
            // First check if we have custom AI prompts in database
            const dbPrompts = brandingItems.filter(b => b.type === 'ai_prompt');
            let list = [];

            if (dbPrompts.length > 0) {
                const categoryMatch = type === 'logo' ? 'logo' : 'mockup';
                list = dbPrompts
                    .filter(p => {
                        const notes = parseNotes(p.notes);
                        return notes.category === categoryMatch;
                    })
                    .sort((a, b) => (a.sort_order || 0) - (b.sort_order || 0))
                    .map(p => ({
                        label: p.title,
                        prompt: p.value
                    }));
            }

            // Fallback to generated prompts
            if (list.length === 0) {
                const prompts = generateBrandingPrompts();
                list = prompts[type] || [];
            }

            if (list[index]) {
                navigator.clipboard.writeText(list[index].prompt);
                showToast('Prompt skopiowany', 'success');
            }
        }

        window.togglePromptPanel = togglePromptPanel;
        window.togglePromptExpand = togglePromptExpand;
        window.copyPrompt = copyPrompt;
        window.generateBrandingPrompts = generateBrandingPrompts;

        // === NEW: Simplified branding UI functions ===

        // Copy logo prompt (only white background variant)
        function copyLogoPrompt() {
            const prompts = generateBrandingPrompts();
            const logoPrompt = prompts.logo.find(p => p.label.includes('jasnym tle') || p.label.includes('white'));
            if (logoPrompt) {
                navigator.clipboard.writeText(logoPrompt.prompt);
                // Change button to show copied state
                const btn = document.getElementById('logo-prompt-copy-btn');
                const icon = document.getElementById('logo-prompt-copy-icon');
                const text = document.getElementById('logo-prompt-copy-text');
                icon.className = 'ph ph-check';
                text.textContent = 'Skopiowano';
                btn.classList.add('bg-emerald-500/20', 'text-emerald-400');
                btn.classList.remove('bg-pink-500/10', 'text-pink-400');
                setTimeout(() => {
                    icon.className = 'ph ph-copy';
                    text.textContent = 'Kopiuj';
                    btn.classList.remove('bg-emerald-500/20', 'text-emerald-400');
                    btn.classList.add('bg-pink-500/10', 'text-pink-400');
                }, 2000);
            } else {
                showToast('Najpierw dodaj informacje o marce', 'warning');
            }
        }
        window.copyLogoPrompt = copyLogoPrompt;

        // Direct logo upload (without modal)
        function handleDirectLogoDrop(event) {
            const file = event.dataTransfer.files[0];
            if (file) uploadLogoDirect(file);
        }
        function handleDirectLogoUpload(event) {
            const file = event.target.files[0];
            if (file) uploadLogoDirect(file);
        }
        async function uploadLogoDirect(file) {
            if (!file.type.startsWith('image/') && !file.name.endsWith('.svg')) {
                showToast('Tylko pliki graficzne', 'error');
                return;
            }
            const dropzone = document.getElementById('logo-dropzone');
            dropzone.innerHTML = '<i class="ph ph-spinner ph-spin text-xl text-pink-400"></i><p class="text-zinc-400 text-xs mt-1">Przesyłanie...</p>';

            const fileName = `branding/${workflow.id}/logo_${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.-]/g, '_')}`;
            const { data: uploadData, error: uploadError } = await supabaseClient.storage
                .from('attachments')
                .upload(fileName, file);

            if (uploadError) {
                showToast('Błąd przesyłania', 'error');
                resetLogoDropzone();
                return;
            }

            const { data: urlData } = supabaseClient.storage.from('attachments').getPublicUrl(fileName);
            const imageUrl = urlData.publicUrl;

            const { error } = await supabaseClient
                .from('branding_items')
                .insert({
                    workflow_id: workflow.id,
                    type: 'logo',
                    title: 'Logo',
                    value: imageUrl,
                    notes: JSON.stringify({ variant: 'main' })
                });

            if (error) {
                showToast('Błąd zapisu', 'error');
            } else {
                showToast('Logo dodane', 'success');
                await loadBranding();
            }
            resetLogoDropzone();
        }
        function resetLogoDropzone() {
            const dropzone = document.getElementById('logo-dropzone');
            dropzone.innerHTML = `
                <i class="ph ph-plus text-xl text-zinc-600 mb-1"></i>
                <p class="text-zinc-500 text-xs">Przeciągnij lub kliknij</p>
                <input type="file" id="logo-direct-input" accept=".png,.jpg,.jpeg,.webp,.svg" class="hidden" onchange="handleDirectLogoUpload(event)">
            `;
        }
        window.handleDirectLogoDrop = handleDirectLogoDrop;
        window.handleDirectLogoUpload = handleDirectLogoUpload;

        // Direct mockup upload (without modal)
        function handleDirectMockupDrop(event) {
            const file = event.dataTransfer.files[0];
            if (file) uploadMockupDirect(file);
        }
        function handleDirectMockupUpload(event) {
            const file = event.target.files[0];
            if (file) uploadMockupDirect(file);
        }
        async function uploadMockupDirect(file) {
            if (!file.type.startsWith('image/')) {
                showToast('Tylko pliki graficzne', 'error');
                return;
            }
            const dropzone = document.getElementById('mockup-dropzone');
            dropzone.innerHTML = '<i class="ph ph-spinner ph-spin text-xl text-pink-400"></i><p class="text-zinc-400 text-xs mt-1">Przesyłanie...</p>';

            const fileName = `branding/${workflow.id}/mockup_${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.-]/g, '_')}`;
            const { data: uploadData, error: uploadError } = await supabaseClient.storage
                .from('attachments')
                .upload(fileName, file);

            if (uploadError) {
                showToast('Błąd przesyłania', 'error');
                resetMockupDropzone();
                return;
            }

            const { data: urlData } = supabaseClient.storage.from('attachments').getPublicUrl(fileName);
            const imageUrl = urlData.publicUrl;

            const { error } = await supabaseClient
                .from('branding_items')
                .insert({
                    workflow_id: workflow.id,
                    type: 'mockup',
                    title: 'Mockup',
                    value: imageUrl
                });

            if (error) {
                showToast('Błąd zapisu', 'error');
            } else {
                showToast('Mockup dodany', 'success');
                await loadBranding();
            }
            resetMockupDropzone();
        }
        function resetMockupDropzone() {
            const dropzone = document.getElementById('mockup-dropzone');
            dropzone.innerHTML = `
                <i class="ph ph-plus text-xl text-zinc-600 mb-1"></i>
                <p class="text-zinc-500 text-xs">Przeciągnij lub kliknij</p>
                <input type="file" id="mockup-direct-input" accept=".png,.jpg,.jpeg,.webp" class="hidden" onchange="handleDirectMockupUpload(event)">
            `;
        }
        window.handleDirectMockupDrop = handleDirectMockupDrop;
        window.handleDirectMockupUpload = handleDirectMockupUpload;

        // Mockup prompts inline (compact chips)
        let copiedMockupPrompts = new Set();

        function renderMockupPromptsInline() {
            const container = document.getElementById('mockup-prompts-inline');
            if (!container) return;

            const prompts = generateBrandingPrompts();
            const list = prompts.mockup || [];

            if (list.length === 0) {
                container.innerHTML = '<p class="text-zinc-600 text-xs">Dodaj informacje o marce aby wygenerować prompty</p>';
                return;
            }

            container.innerHTML = list.map((item, i) => {
                const isCopied = copiedMockupPrompts.has(i);
                const shortLabel = item.label.replace('z logo', '').replace('z brandingiem', '').trim();
                return `
                    <button onclick="copyMockupPromptInline(${i})"
                        id="mockup-prompt-chip-${i}"
                        class="inline-flex items-center gap-1.5 px-2.5 py-1.5 rounded-md text-xs transition-all ${isCopied ? 'bg-emerald-500/20 text-emerald-400 border border-emerald-500/30' : 'bg-zinc-800/50 text-zinc-400 hover:text-white hover:bg-zinc-700/50 border border-zinc-700/50'}"
                        title="${item.label}">
                        <i class="ph ${isCopied ? 'ph-check' : 'ph-magic-wand'} text-[10px]"></i>
                        <span class="truncate max-w-[100px]">${shortLabel}</span>
                    </button>
                `;
            }).join('');
        }

        function copyMockupPromptInline(index) {
            const prompts = generateBrandingPrompts();
            const list = prompts.mockup || [];
            if (!list[index]) return;

            navigator.clipboard.writeText(list[index].prompt);
            copiedMockupPrompts.add(index);

            // Update chip appearance
            const chip = document.getElementById(`mockup-prompt-chip-${index}`);
            if (chip) {
                chip.className = 'inline-flex items-center gap-1.5 px-2.5 py-1.5 rounded-md text-xs transition-all bg-emerald-500/20 text-emerald-400 border border-emerald-500/30';
                chip.querySelector('i').className = 'ph ph-check text-[10px]';
            }
            showToast('Prompt skopiowany', 'success');
        }
        window.copyMockupPromptInline = copyMockupPromptInline;
        window.renderMockupPromptsInline = renderMockupPromptsInline;

        // Branding delivery
        let lastBrandingEmailSentAt = 0;
        const BRANDING_EMAIL_COOLDOWN = 60 * 1000; // 1 min (prevent double-click only)

        function updateBrandingDeliverUI() {
            const btn = document.getElementById('branding-deliver-btn');
            const badge = document.getElementById('branding-delivered-badge');
            const hasItems = brandingItems.length > 0;
            const delivered = !!workflow.branding_shared_at;

            if (btn) btn.classList.toggle('hidden', !hasItems || delivered);
            if (badge) badge.classList.toggle('hidden', !delivered);
        }

        async function deliverBranding() {
            if (!confirm('Przekazać branding klientowi i wysłać email?')) return;

            try {
                const now = new Date().toISOString();
                const { error } = await supabaseClient
                    .from('workflows')
                    .update({ branding_shared_at: now })
                    .eq('id', workflow.id);

                if (error) throw error;

                workflow.branding_shared_at = now;
                updateBrandingDeliverUI();
                updateNavChecks();

                // Send email
                const emailNow = Date.now();
                const shouldSend = (emailNow - lastBrandingEmailSentAt) > BRANDING_EMAIL_COOLDOWN;

                // Log activity
                logActivity('branding_shared', 'Przekazano branding klientowi', { items_count: brandingItems.length });

                if (shouldSend && workflow.customer_email) {
                    const clientName = (workflow.customer_name || '').split(' ')[0] || 'Cześć';
                    const projectUrl = `https://crm.tomekniedzwiecki.pl/projekt/${workflow.unique_token}#branding`;

                    try {
                        await supabaseClient.functions.invoke('automation-trigger', {
                            body: {
                                trigger_type: 'branding_delivered',
                                entity_type: 'workflow',
                                entity_id: workflow.id,
                                context: {
                                    email: workflow.customer_email,
                                    clientName,
                                    projectUrl
                                }
                            }
                        });
                        lastBrandingEmailSentAt = emailNow;
                        showToast('Branding przekazany', 'success');
                    } catch (e) {
                        console.error('Automation trigger error:', e);
                        showToast('Branding przekazany', 'success');
                    }
                } else {
                    showToast('Branding przekazany klientowi', 'success');
                }
            } catch (err) {
                console.error('Error delivering branding:', err);
                showToast('Błąd: ' + err.message, 'error');
            }
        }
        window.deliverBranding = deliverBranding;

        // =============================================
        // SALES PAGE MANAGEMENT
        // =============================================
        function loadSalesPage() {
            const urlInput = document.getElementById('sales-page-url');
            const preview = document.getElementById('sales-page-preview');
            const empty = document.getElementById('sales-page-empty');
            const link = document.getElementById('sales-page-link');

            urlInput.value = workflow.sales_page_url || '';

            if (workflow.sales_page_status) {
                document.querySelector(`input[name="sales-page-status"][value="${workflow.sales_page_status}"]`).checked = true;
            }

            if (workflow.sales_page_url) {
                empty.classList.add('hidden');
                preview.classList.remove('hidden');
                link.href = workflow.sales_page_url;
            } else {
                empty.classList.remove('hidden');
                preview.classList.add('hidden');
            }

            updateSalesPageDeliverUI();
        }

        async function saveSalesPageUrl() {
            const url = document.getElementById('sales-page-url').value.trim();
            const status = document.querySelector('input[name="sales-page-status"]:checked')?.value || 'draft';

            const { error } = await supabaseClient
                .from('workflows')
                .update({ sales_page_url: url || null, sales_page_status: status })
                .eq('id', workflow.id);

            if (!error) {
                workflow.sales_page_url = url;
                workflow.sales_page_status = status;
                loadSalesPage();
                showToast('Zapisano', 'success');
                if (url) {
                    logActivity('sales_page_updated', `Zaktualizowano stronę sprzedażową`, { url, status });
                }
            }
        }
        window.saveSalesPageUrl = saveSalesPageUrl;

        let lastSalesPageEmailSentAt = 0;
        const SALES_PAGE_EMAIL_COOLDOWN = 60 * 1000; // 1 min (prevent double-click only)

        function updateSalesPageDeliverUI() {
            const btn = document.getElementById('sales-page-deliver-btn');
            const badge = document.getElementById('sales-page-delivered-badge');
            const banner = document.getElementById('sales-page-sharing-banner');
            const hasUrl = !!workflow.sales_page_url;
            const delivered = !!workflow.sales_page_shared_at;

            if (btn) btn.classList.toggle('hidden', !hasUrl || delivered);
            if (badge) badge.classList.toggle('hidden', !delivered);

            if (banner) {
                if (delivered) {
                    const d = new Date(workflow.sales_page_shared_at).toLocaleDateString('pl-PL', { day: 'numeric', month: 'short', year: 'numeric' });
                    banner.innerHTML = `<div class="flex items-center gap-2 bg-emerald-500/10 border border-emerald-500/20 rounded-lg px-4 py-2.5 text-sm"><i class="ph-fill ph-check-circle text-emerald-400"></i><span class="text-emerald-300 text-xs">Strona udostępniona klientowi ${d}</span></div>`;
                } else if (hasUrl) {
                    banner.innerHTML = `<div class="flex items-center gap-2 bg-amber-500/10 border border-amber-500/20 rounded-lg px-4 py-2.5 text-sm"><i class="ph ph-warning text-amber-400"></i><span class="text-amber-300 text-xs">Strona jeszcze nie udostępniona klientowi</span></div>`;
                } else {
                    banner.innerHTML = '';
                }
            }
        }

        async function deliverSalesPage() {
            if (!confirm('Przekazać stronę klientowi i wysłać email?')) return;

            try {
                const now = new Date().toISOString();
                const { error } = await supabaseClient
                    .from('workflows')
                    .update({ sales_page_shared_at: now })
                    .eq('id', workflow.id);

                if (error) throw error;

                workflow.sales_page_shared_at = now;
                updateSalesPageDeliverUI();
                updateNavChecks();

                // Log activity
                logActivity('sales_page_shared', 'Udostępniono stronę sprzedażową klientowi', { url: workflow.sales_page_url });

                const emailNow = Date.now();
                const shouldSend = (emailNow - lastSalesPageEmailSentAt) > SALES_PAGE_EMAIL_COOLDOWN;

                if (shouldSend && workflow.customer_email) {
                    const clientName = (workflow.customer_name || '').split(' ')[0] || 'Cześć';
                    const projectUrl = `https://crm.tomekniedzwiecki.pl/projekt/${workflow.unique_token}#strona`;
                    const salesPageUrl = workflow.sales_page_url || '';

                    try {
                        await supabaseClient.functions.invoke('automation-trigger', {
                            body: {
                                trigger_type: 'sales_page_shared',
                                entity_type: 'workflow',
                                entity_id: workflow.id,
                                context: {
                                    email: workflow.customer_email,
                                    clientName,
                                    projectUrl,
                                    salesPageUrl
                                }
                            }
                        });
                        lastSalesPageEmailSentAt = emailNow;
                        showToast('Strona przekazana', 'success');
                    } catch (e) {
                        console.error('Automation trigger error:', e);
                        showToast('Strona przekazana', 'success');
                    }
                } else {
                    showToast('Strona przekazana klientowi', 'success');
                }
            } catch (err) {
                console.error('Error delivering sales page:', err);
                showToast('Błąd: ' + err.message, 'error');
            }
        }
        window.deliverSalesPage = deliverSalesPage;

        // =============================================
        // PRODUCTS MANAGEMENT
        // =============================================
        async function loadProducts() {
            // Sharing banner
            const banner = document.getElementById('products-sharing-banner');
            if (banner) {
                if (workflow.products_shared_at) {
                    const d = new Date(workflow.products_shared_at).toLocaleDateString('pl-PL', { day: 'numeric', month: 'short', year: 'numeric' });
                    banner.innerHTML = `<div class="flex items-center gap-2 bg-emerald-500/10 border border-emerald-500/20 rounded-lg px-4 py-2.5 text-sm"><i class="ph-fill ph-check-circle text-emerald-400"></i><span class="text-emerald-300 text-xs">Produkty udostępnione klientowi ${d}</span></div>`;
                } else {
                    banner.innerHTML = `
                        <div class="flex items-center justify-between gap-4 bg-amber-500/10 border border-amber-500/20 rounded-lg px-4 py-3">
                            <div class="flex items-center gap-2">
                                <i class="ph ph-warning text-amber-400"></i>
                                <span class="text-amber-300 text-xs">Produkty jeszcze nie udostępnione klientowi</span>
                            </div>
                            <button onclick="shareProducts()" id="share-products-btn" class="bg-white text-black hover:bg-zinc-200 px-4 py-2 rounded-lg text-xs font-medium transition-colors inline-flex items-center gap-1.5 flex-shrink-0">
                                <i class="ph ph-share-network"></i>
                                Udostępnij produkty
                            </button>
                        </div>`;
                }
            }

            const container = document.getElementById('product-selection-status');
            const selectedId = workflow.selected_product_id;

            if (!selectedId) {
                container.innerHTML = `
                    <div class="text-center py-16">
                        <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-zinc-900 flex items-center justify-center">
                            <i class="ph ph-clock text-2xl text-zinc-600"></i>
                        </div>
                        <p class="text-zinc-400 text-sm mb-1">Klient jeszcze nie wybrał produktu</p>
                        <p class="text-zinc-600 text-xs">Klient zobaczy globalną bazę produktów i wybierze swój produkt z panelu klienta.</p>
                    </div>
                `;
                return;
            }

            // Load selected product details
            const { data: product, error } = await supabaseClient
                .from('workflow_products')
                .select('*')
                .eq('id', selectedId)
                .single();

            if (error || !product) {
                container.innerHTML = `<p class="text-zinc-500 text-sm">Nie znaleziono wybranego produktu.</p>`;
                return;
            }

            container.innerHTML = `
                <div class="bg-zinc-900/60 border border-emerald-500/30 rounded-xl overflow-hidden">
                    <div class="flex flex-col md:flex-row">
                        ${product.image_url
                            ? `<div class="md:w-64 h-64 md:h-auto bg-zinc-800 flex-shrink-0"><img src="${product.image_url}" alt="" class="w-full h-full object-cover"></div>`
                            : `<div class="md:w-64 h-64 md:h-auto bg-zinc-800 flex-shrink-0 flex items-center justify-center"><i class="ph ph-package text-5xl text-zinc-700"></i></div>`
                        }
                        <div class="p-6 flex-1">
                            <div class="flex items-center gap-2 mb-3">
                                <span class="inline-flex items-center gap-1 bg-emerald-500/20 text-emerald-400 text-xs font-medium px-2.5 py-1 rounded-md">
                                    <i class="ph-fill ph-check-circle"></i> Wybrany przez klienta
                                </span>
                            </div>
                            <h3 class="text-white font-semibold text-xl mb-2">${product.name}</h3>
                            ${product.description ? `<p class="text-zinc-400 text-sm mb-3">${product.description}</p>` : ''}
                            ${product.price ? `<p class="text-white font-bold text-2xl mb-3">${parseFloat(product.price).toFixed(2)} <span class="text-zinc-500 text-sm font-normal">${product.currency || 'USD'}</span></p>` : ''}
                            <div class="flex flex-wrap items-center gap-3">
                                ${product.report_screenshot_url ? `<a href="${product.report_screenshot_url}" target="_blank" class="inline-flex items-center gap-1.5 bg-amber-500/20 hover:bg-amber-500/30 text-amber-400 text-sm font-medium px-3 py-1.5 rounded-lg transition-colors"><i class="ph ph-file-pdf"></i> Pobierz PDF</a>` : ''}
                                ${product.source_url ? `<a href="${product.source_url}" target="_blank" class="inline-flex items-center gap-1 text-orange-400 hover:text-orange-300 text-sm"><i class="ph ph-arrow-square-out"></i> AliExpress</a>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // =============================================
        // PRODUCT SHARING (Overview tab)
        // =============================================
        function renderProductSharingCard() {
            const container = document.getElementById('products-sharing-content');
            if (!container) return;

            if (!workflow.products_shared_at) {
                // Not shared yet
                container.innerHTML = `
                    <div class="flex items-start gap-4">
                        <div class="w-10 h-10 rounded-lg bg-orange-500/10 border border-orange-500/20 flex items-center justify-center flex-shrink-0">
                            <i class="ph ph-package text-lg text-orange-400"></i>
                        </div>
                        <div class="flex-1">
                            <h3 class="text-white font-medium text-sm mb-1">Produkty</h3>
                            <p class="text-zinc-500 text-xs mb-3">Klient nie ma jeszcze dostępu do propozycji produktowych. Udostępnij produkty, aby klient mógł je przeglądać i wybrać swój produkt.</p>
                            <button onclick="shareProducts()" id="share-products-btn" class="bg-white text-black hover:bg-zinc-200 px-4 py-2 rounded-lg text-xs font-medium transition-colors inline-flex items-center gap-1.5">
                                <i class="ph ph-share-network"></i>
                                Udostępnij produkty klientowi
                            </button>
                        </div>
                    </div>
                `;
            } else {
                // Already shared
                const sharedDate = new Date(workflow.products_shared_at).toLocaleDateString('pl-PL', { day: 'numeric', month: 'short', year: 'numeric' });
                const selectedId = workflow.selected_product_id;

                let selectedHtml = '';
                if (selectedId) {
                    // Will be populated async
                    selectedHtml = `<div id="overview-selected-product" class="mt-3 pt-3 border-t border-white/5"><p class="text-zinc-600 text-xs">Ładowanie...</p></div>`;
                } else {
                    selectedHtml = `<div class="mt-3 pt-3 border-t border-white/5"><p class="text-zinc-500 text-xs"><i class="ph ph-clock text-zinc-600"></i> Klient jeszcze nie wybrał produktu</p></div>`;
                }

                container.innerHTML = `
                    <div class="flex items-start gap-4">
                        <div class="w-10 h-10 rounded-lg bg-emerald-500/10 border border-emerald-500/20 flex items-center justify-center flex-shrink-0">
                            <i class="ph-fill ph-check-circle text-lg text-emerald-400"></i>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <h3 class="text-white font-medium text-sm">Produkty udostępnione</h3>
                                <span class="text-zinc-600 text-xs">${sharedDate}</span>
                            </div>
                            <p class="text-zinc-500 text-xs">Klient ma dostęp do propozycji produktowych w swoim panelu.</p>
                            ${selectedHtml}
                        </div>
                    </div>
                `;

                // Load selected product details if any
                if (selectedId) {
                    loadOverviewSelectedProduct(selectedId);
                }
            }
        }

        async function loadOverviewSelectedProduct(productId) {
            const container = document.getElementById('overview-selected-product');
            if (!container) return;

            const { data: product } = await supabaseClient
                .from('workflow_products')
                .select('id, name, image_url, source_url')
                .eq('id', productId)
                .single();

            if (!product) {
                container.innerHTML = `<p class="text-zinc-500 text-xs">Produkt nie znaleziony</p>`;
                return;
            }

            container.innerHTML = `
                <div class="flex items-center gap-3">
                    ${product.image_url
                        ? `<img src="${product.image_url}" class="w-10 h-10 rounded-lg object-cover border border-white/10" alt="">`
                        : `<div class="w-10 h-10 rounded-lg bg-zinc-800 flex items-center justify-center"><i class="ph ph-package text-zinc-600"></i></div>`
                    }
                    <div class="flex-1 min-w-0">
                        <p class="text-white text-sm font-medium truncate">${product.name}</p>
                        <span class="inline-flex items-center gap-1 text-emerald-400 text-xs"><i class="ph-fill ph-check-circle"></i> Wybrany przez klienta</span>
                    </div>
                    ${product.source_url ? `<a href="${product.source_url}" target="_blank" class="text-zinc-500 hover:text-orange-400 transition-colors"><i class="ph ph-arrow-square-out"></i></a>` : ''}
                </div>
            `;
        }

        async function shareProducts() {
            const btn = document.getElementById('share-products-btn');
            if (btn) { btn.disabled = true; btn.textContent = 'Wysyłanie...'; }

            try {
                // Update workflow
                const { error } = await supabaseClient
                    .from('workflows')
                    .update({ products_shared_at: new Date().toISOString() })
                    .eq('id', workflow.id);

                if (error) throw error;

                workflow.products_shared_at = new Date().toISOString();

                // Log activity
                logActivity('products_shared', 'Udostępniono katalog produktów klientowi', {});

                // Trigger automation for email
                const clientName = (workflow.customer_name || '').split(' ')[0] || 'Cześć';
                const projectUrl = `https://crm.tomekniedzwiecki.pl/projekt/${workflow.unique_token}#produkty`;

                try {
                    await supabaseClient.functions.invoke('automation-trigger', {
                        body: {
                            trigger_type: 'products_shared',
                            entity_type: 'workflow',
                            entity_id: workflow.id,
                            context: {
                                email: workflow.customer_email,
                                clientName,
                                projectUrl
                            }
                        }
                    });
                } catch (e) {
                    console.error('Automation trigger error:', e);
                }

                showToast('Produkty udostępnione', 'success');
                renderProductSharingCard();
                loadProducts(); // Refresh Products tab banner
            } catch (err) {
                console.error('Error sharing products:', err);
                showToast('Błąd: ' + err.message, 'error');
                if (btn) { btn.disabled = false; btn.innerHTML = '<i class="ph ph-share-network"></i> Udostępnij produkty klientowi'; }
            }
        }
        window.shareProducts = shareProducts;

        // =============================================
        // REPORTS MANAGEMENT
        // =============================================
        let reports = [];

        async function loadReports() {
            const { data, error } = await supabaseClient
                .from('workflow_reports')
                .select('*')
                .eq('workflow_id', workflow.id)
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error loading reports:', error);
                return;
            }

            reports = data || [];
            renderReports();
            renderReportsOverviewCard();
            updateNavChecks();
        }

        function renderReportsOverviewCard() {
            const container = document.getElementById('reports-overview-content');
            if (!container) return;

            const fileReports = reports.filter(r => ['report_pdf', 'report_infographic', 'report_presentation', 'report_video'].includes(r.type));
            const publishedCount = fileReports.filter(r => r.visible_to_client).length;
            const totalCount = fileReports.length;

            if (totalCount === 0) {
                container.innerHTML = `
                    <div class="flex items-start gap-4">
                        <div class="w-10 h-10 rounded-lg bg-zinc-800 border border-white/5 flex items-center justify-center flex-shrink-0">
                            <i class="ph ph-chart-bar text-lg text-zinc-500"></i>
                        </div>
                        <div class="flex-1">
                            <h3 class="text-white font-medium text-sm mb-1">Raporty</h3>
                            <p class="text-zinc-500 text-xs">Brak raportów. Dodaj raporty w zakładce Raporty.</p>
                        </div>
                    </div>
                `;
            } else {
                const allPublished = publishedCount === totalCount;
                const iconBg = allPublished ? 'bg-emerald-500/10 border-emerald-500/20' : 'bg-amber-500/10 border-amber-500/20';
                const iconClass = allPublished ? 'ph-fill ph-check-circle text-emerald-400' : 'ph ph-clock text-amber-400';
                const statusText = allPublished
                    ? `Udostępnione klientowi (${totalCount})`
                    : `${publishedCount} z ${totalCount} udostępnionych`;

                container.innerHTML = `
                    <div class="flex items-start gap-4">
                        <div class="w-10 h-10 rounded-lg ${iconBg} border flex items-center justify-center flex-shrink-0">
                            <i class="${iconClass} text-lg"></i>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <h3 class="text-white font-medium text-sm">Raporty</h3>
                                <span class="text-zinc-600 text-xs">${totalCount} ${totalCount === 1 ? 'plik' : 'pliki'}</span>
                            </div>
                            <p class="text-zinc-500 text-xs">${statusText}</p>
                        </div>
                    </div>
                `;
            }
        }

        // =============================================
        // REPORT SECTION ICONS
        // =============================================
        const REPORT_TYPE_CONFIG = {
            report_pdf: { icon: 'ph-file-pdf', label: 'Raport PDF', color: 'bg-red-500/10 text-red-400' },
            report_infographic: { icon: 'ph-image', label: 'Infografika', color: 'bg-violet-500/10 text-violet-400' },
            report_presentation: { icon: 'ph-presentation-chart', label: 'Prezentacja', color: 'bg-blue-500/10 text-blue-400' },
            report_video: { icon: 'ph-video', label: 'Video analiza', color: 'bg-pink-500/10 text-pink-400' },
            product_analysis: { icon: 'ph-chart-line-up', label: 'Analiza produktu', color: 'bg-green-500/10 text-green-400' }
        };

        // =============================================
        // REPORT RENDERING (Admin)
        // =============================================
        function formatFileSize(bytes) {
            if (!bytes) return '';
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function renderReports() {
            const container = document.getElementById('reports-list');
            const empty = document.getElementById('reports-empty');
            const publishAllBtn = document.getElementById('publish-all-reports-btn');

            // Check for unpublished reports
            const unpublishedCount = reports.filter(r => !r.visible_to_client).length;
            if (publishAllBtn) {
                if (unpublishedCount > 0) {
                    publishAllBtn.classList.remove('hidden');
                    publishAllBtn.innerHTML = `<i class="ph ph-checks"></i> Udostępnij wszystkie (${unpublishedCount})`;
                } else {
                    publishAllBtn.classList.add('hidden');
                }
            }

            if (reports.length === 0) {
                container.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }

            empty.classList.add('hidden');
            container.innerHTML = reports.map(r => {
                const config = REPORT_TYPE_CONFIG[r.type] || { icon: 'ph-file', label: r.type, color: 'bg-zinc-800 text-zinc-400' };

                return `
                    <div class="flex items-center gap-4 p-3 bg-zinc-900/40 border border-white/5 rounded-lg hover:border-white/10 transition-colors group">
                        <div class="w-10 h-10 rounded-lg ${config.color} flex items-center justify-center shrink-0">
                            <i class="ph ${config.icon} text-lg"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2">
                                <span class="text-white font-medium text-sm truncate">${escapeHtml(r.title)}</span>
                                <span class="text-[10px] px-1.5 py-0.5 rounded ${r.visible_to_client ? 'bg-emerald-500/10 text-emerald-400' : 'bg-amber-500/10 text-amber-400'}">${r.visible_to_client ? 'Udostępniony' : 'Szkic'}</span>
                            </div>
                            <div class="flex items-center gap-2 text-[10px] text-zinc-500 mt-0.5">
                                <span>${config.label}</span>
                                ${r.content?.file_name ? `<span>·</span><span class="truncate max-w-[150px]">${escapeHtml(r.content.file_name)}</span>` : ''}
                                <span>·</span>
                                <span>${formatDate(r.created_at)}</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            ${r.file_url ? `<a href="${r.file_url}" target="_blank" class="p-2 text-zinc-500 hover:text-cyan-400 transition-colors" title="Otwórz"><i class="ph ph-arrow-square-out"></i></a>` : ''}
                            <button onclick="toggleReportVisibility('${r.id}')" class="p-2 ${r.visible_to_client ? 'text-emerald-400 hover:text-emerald-300' : 'text-zinc-500 hover:text-white'} transition-colors" title="${r.visible_to_client ? 'Ukryj' : 'Udostępnij'}">
                                <i class="ph ph-eye${r.visible_to_client ? '' : '-slash'}"></i>
                            </button>
                            <button onclick="deleteReport('${r.id}')" class="p-2 text-zinc-500 hover:text-red-400 transition-colors" title="Usuń">
                                <i class="ph ph-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function toggleReportVisibility(id) {
            const report = reports.find(r => r.id === id);
            if (!report) return;

            const newVisibility = !report.visible_to_client;
            const { error } = await supabaseClient
                .from('workflow_reports')
                .update({ visible_to_client: newVisibility })
                .eq('id', id);

            if (!error) {
                report.visible_to_client = newVisibility;
                renderReports();
                const action = newVisibility ? 'report_published' : 'report_hidden';
                const desc = newVisibility ? `Opublikowano raport: ${report.title || report.type}` : `Ukryto raport: ${report.title || report.type}`;
                logActivity(action, desc, { report_id: id, report_type: report.type });
            }
        }

        // Throttle: max 1 email per 30 min per workflow
        let lastReportEmailSentAt = 0;
        const REPORT_EMAIL_COOLDOWN = 60 * 1000; // 1 min (prevent double-click only)

        async function approveAndPublishReport(id) {
            const report = reports.find(r => r.id === id);
            if (!report) return;

            if (!confirm('Zatwierdź raport i udostępnij klientowi?')) return;

            try {
                const { error } = await supabaseClient
                    .from('workflow_reports')
                    .update({
                        visible_to_client: true,
                        content: { ...report.content, approved_at: new Date().toISOString() }
                    })
                    .eq('id', id);

                if (error) throw error;

                report.visible_to_client = true;

                // Log activity
                logActivity('report_approved', `Zatwierdzono i opublikowano raport: ${report.title || report.type}`, { report_id: id, report_type: report.type });

                // Send email only if cooldown passed
                const now = Date.now();
                const shouldSendEmail = (now - lastReportEmailSentAt) > REPORT_EMAIL_COOLDOWN;

                if (shouldSendEmail) {
                    const clientName = (workflow.customer_name || '').split(' ')[0] || 'Cześć';
                    const projectUrl = `https://crm.tomekniedzwiecki.pl/projekt/${workflow.unique_token}#raporty`;

                    try {
                        await supabaseClient.functions.invoke('automation-trigger', {
                            body: {
                                trigger_type: 'report_published',
                                entity_type: 'workflow',
                                entity_id: workflow.id,
                                context: {
                                    email: workflow.customer_email,
                                    clientName,
                                    projectUrl,
                                    reportTitle: report.title || report.type
                                }
                            }
                        });
                    } catch (e) {
                        console.error('Automation trigger error:', e);
                    }

                    lastReportEmailSentAt = now;
                    renderReports();
                    showToast('Raport zatwierdzony', 'success');
                } else {
                    renderReports();
                    showToast('Raport zatwierdzony (email już wysłany wcześniej)', 'success');
                }
            } catch (err) {
                console.error('Error approving report:', err);
                showToast('Błąd: ' + err.message, 'error');
            }
        }
        window.approveAndPublishReport = approveAndPublishReport;

        async function deleteReport(id) {
            if (!confirm('Usunąć ten raport?')) return;

            // Delete file from storage if exists
            const report = reports.find(r => r.id === id);
            if (report?.file_url) {
                const path = report.file_url.split('/storage/v1/object/public/attachments/')[1];
                if (path) {
                    await supabaseClient.storage.from('attachments').remove([decodeURIComponent(path)]);
                }
            }

            const { error } = await supabaseClient
                .from('workflow_reports')
                .delete()
                .eq('id', id);

            if (!error) {
                // Log activity
                logActivity('report_deleted', `Usunięto raport: ${report?.title || report?.type || 'Raport'}`, { report_id: id, report_type: report?.type });

                reports = reports.filter(r => r.id !== id);
                renderReports();
                showToast('Raport usunięty', 'success');
            }
        }

        // =============================================
        // REPORT UPLOAD MODAL
        // =============================================
        function openReportModal() {
            document.getElementById('report-file-type').value = 'report_pdf';
            document.getElementById('report-file-input').value = '';
            document.getElementById('report-upload-progress').classList.add('hidden');
            updateReportFileAccept();
            document.getElementById('report-modal').classList.remove('hidden');
        }
        window.openReportModal = openReportModal;

        function closeReportModal() {
            document.getElementById('report-modal').classList.add('hidden');
        }
        window.closeReportModal = closeReportModal;

        const REPORT_TITLES = {
            report_pdf: 'Raport',
            report_infographic: 'Infografika',
            report_presentation: 'Prezentacja',
            report_video: 'Video analiza'
        };

        function updateReportFileAccept() {
            const type = document.getElementById('report-file-type').value;
            const fileInput = document.getElementById('report-file-input');

            switch (type) {
                case 'report_pdf':
                    fileInput.accept = '.pdf';
                    break;
                case 'report_infographic':
                    fileInput.accept = '.png,.jpg,.jpeg,.webp';
                    break;
                case 'report_presentation':
                    fileInput.accept = '.pdf';
                    break;
                case 'report_video':
                    fileInput.accept = '.mp4,.mov,.webm';
                    break;
            }
            fileInput.value = '';
        }
        window.updateReportFileAccept = updateReportFileAccept;

        async function uploadReport() {
            const type = document.getElementById('report-file-type').value;
            const title = REPORT_TITLES[type] || type;
            const fileInput = document.getElementById('report-file-input');
            const file = fileInput.files[0];
            if (!file) { showToast('Wybierz plik', 'error'); return; }

            document.getElementById('report-upload-progress').classList.remove('hidden');

            try {
                // Upload to Supabase Storage
                const fileExt = file.name.split('.').pop();
                const safeName = file.name.normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/\u0142/g, 'l').replace(/\u0141/g, 'L').replace(/[^a-zA-Z0-9._-]/g, '_');
                const fileName = `reports/${workflow.id}/${Date.now()}_${safeName}`;

                const { error: uploadError } = await supabaseClient.storage
                    .from('attachments')
                    .upload(fileName, file);

                if (uploadError) throw uploadError;

                const { data: urlData } = supabaseClient.storage
                    .from('attachments')
                    .getPublicUrl(fileName);

                // Save report record
                const { error } = await supabaseClient
                    .from('workflow_reports')
                    .insert({
                        workflow_id: workflow.id,
                        title,
                        type,
                        file_url: urlData.publicUrl,
                        content: { file_name: file.name, file_size: file.size, mime_type: file.type },
                        visible_to_client: false
                    });

                if (error) throw error;

                // Log activity
                logActivity('report_uploaded', `Przesłano raport: ${title}`, { report_type: type, file_name: file.name });

                closeReportModal();
                await loadReports();
                showToast('Plik raportu dodany', 'success');
            } catch (err) {
                console.error('Error uploading report:', err);
                showToast('Błąd: ' + err.message, 'error');
            } finally {
                document.getElementById('report-upload-progress').classList.add('hidden');
            }
        }
        window.uploadReport = uploadReport;
        window.toggleReportVisibility = toggleReportVisibility;
        window.deleteReport = deleteReport;

        // =============================================
        // DRAG & DROP REPORTS
        // =============================================
        let pendingPdfFile = null;

        function handleReportDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('reports-dropzone-active').classList.remove('hidden');
        }
        window.handleReportDragOver = handleReportDragOver;

        function handleReportDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            if (!e.currentTarget.contains(e.relatedTarget)) {
                document.getElementById('reports-dropzone-active').classList.add('hidden');
            }
        }
        window.handleReportDragLeave = handleReportDragLeave;

        function handleReportDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('reports-dropzone-active').classList.add('hidden');
            const files = Array.from(e.dataTransfer.files);
            processReportFiles(files);
        }
        window.handleReportDrop = handleReportDrop;

        function handleReportFileSelect(e) {
            const files = Array.from(e.target.files);
            processReportFiles(files);
            e.target.value = '';
        }
        window.handleReportFileSelect = handleReportFileSelect;

        function getReportTypeFromFile(file) {
            const ext = file.name.split('.').pop().toLowerCase();
            if (ext === 'pdf') return 'ask_pdf'; // needs user choice
            if (['png', 'jpg', 'jpeg', 'webp'].includes(ext)) return 'report_infographic';
            if (['mp4', 'mov', 'webm'].includes(ext)) return 'report_video';
            return null;
        }

        async function processReportFiles(files) {
            for (const file of files) {
                const type = getReportTypeFromFile(file);
                if (!type) {
                    showToast(`Nieobsługiwany format: ${file.name}`, 'warning');
                    continue;
                }

                if (type === 'ask_pdf') {
                    // Show modal to ask for PDF type
                    pendingPdfFile = file;
                    document.getElementById('pdf-type-filename').textContent = file.name;
                    document.getElementById('pdf-type-modal').classList.remove('hidden');
                } else {
                    await uploadReportFile(file, type);
                }
            }
        }

        function closePdfTypeModal() {
            document.getElementById('pdf-type-modal').classList.add('hidden');
            pendingPdfFile = null;
        }
        window.closePdfTypeModal = closePdfTypeModal;

        async function confirmPdfType(type) {
            if (!pendingPdfFile) return;
            const file = pendingPdfFile;
            closePdfTypeModal();
            await uploadReportFile(file, type);
        }
        window.confirmPdfType = confirmPdfType;

        async function uploadReportFile(file, type) {
            const title = REPORT_TITLES[type] || type;
            const queueContainer = document.getElementById('reports-upload-queue');

            // Show upload item
            const uploadId = 'upload-' + Date.now();
            queueContainer.classList.remove('hidden');
            queueContainer.insertAdjacentHTML('beforeend', `
                <div id="${uploadId}" class="flex items-center gap-3 p-3 bg-zinc-900/60 border border-white/5 rounded-lg">
                    <i class="ph ph-spinner animate-spin text-green-400"></i>
                    <div class="flex-1 min-w-0">
                        <p class="text-white text-sm truncate">${escapeHtml(file.name)}</p>
                        <p class="text-zinc-500 text-xs">Przesyłanie...</p>
                    </div>
                </div>
            `);

            try {
                const fileExt = file.name.split('.').pop();
                const safeName = file.name.normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/\u0142/g, 'l').replace(/\u0141/g, 'L').replace(/[^a-zA-Z0-9._-]/g, '_');
                const fileName = `reports/${workflow.id}/${Date.now()}_${safeName}`;

                const { error: uploadError } = await supabaseClient.storage
                    .from('attachments')
                    .upload(fileName, file);

                if (uploadError) throw uploadError;

                const { data: urlData } = supabaseClient.storage
                    .from('attachments')
                    .getPublicUrl(fileName);

                const { error } = await supabaseClient
                    .from('workflow_reports')
                    .insert({
                        workflow_id: workflow.id,
                        title,
                        type,
                        file_url: urlData.publicUrl,
                        content: { file_name: file.name, file_size: file.size, mime_type: file.type },
                        visible_to_client: false
                    });

                if (error) throw error;

                logActivity('report_uploaded', `Przesłano raport: ${title}`, { report_type: type, file_name: file.name });

                // Update upload item to success
                const uploadItem = document.getElementById(uploadId);
                if (uploadItem) {
                    uploadItem.innerHTML = `
                        <i class="ph ph-check-circle text-emerald-400"></i>
                        <div class="flex-1 min-w-0">
                            <p class="text-white text-sm truncate">${escapeHtml(file.name)}</p>
                            <p class="text-emerald-400 text-xs">Dodano</p>
                        </div>
                    `;
                    setTimeout(() => uploadItem.remove(), 2000);
                }

                await loadReports();
            } catch (err) {
                console.error('Error uploading report:', err);
                const uploadItem = document.getElementById(uploadId);
                if (uploadItem) {
                    uploadItem.innerHTML = `
                        <i class="ph ph-x-circle text-red-400"></i>
                        <div class="flex-1 min-w-0">
                            <p class="text-white text-sm truncate">${escapeHtml(file.name)}</p>
                            <p class="text-red-400 text-xs">Błąd: ${err.message}</p>
                        </div>
                    `;
                    setTimeout(() => uploadItem.remove(), 5000);
                }
            }

            // Hide queue if empty
            if (queueContainer.children.length === 0) {
                queueContainer.classList.add('hidden');
            }
        }

        // =============================================
        // PUBLISH ALL REPORTS
        // =============================================
        async function publishAllReports() {
            const unpublished = reports.filter(r => !r.visible_to_client);
            if (unpublished.length === 0) return;

            if (!confirm(`Udostępnić ${unpublished.length} raportów klientowi?`)) return;

            try {
                const ids = unpublished.map(r => r.id);
                const { error } = await supabaseClient
                    .from('workflow_reports')
                    .update({ visible_to_client: true })
                    .in('id', ids);

                if (error) throw error;

                // Update local state
                unpublished.forEach(r => r.visible_to_client = true);
                renderReports();

                logActivity('reports_published_bulk', `Udostępniono ${unpublished.length} raportów`, { count: unpublished.length });
                showToast(`Udostępniono ${unpublished.length} raportów`, 'success');

                // Send email notification
                const clientName = (workflow.customer_name || '').split(' ')[0] || 'Cześć';
                const projectUrl = `https://crm.tomekniedzwiecki.pl/projekt/${workflow.unique_token}#raporty`;

                try {
                    await supabaseClient.functions.invoke('automation-trigger', {
                        body: {
                            trigger_type: 'report_published',
                            entity_type: 'workflow',
                            entity_id: workflow.id,
                            context: {
                                email: workflow.customer_email,
                                clientName,
                                reportTitle: `${unpublished.length} raportów`,
                                projectUrl
                            }
                        }
                    });
                } catch (e) {
                    console.error('Automation trigger error:', e);
                }
            } catch (err) {
                console.error('Error publishing all reports:', err);
                showToast('Błąd: ' + err.message, 'error');
            }
        }
        window.publishAllReports = publishAllReports;

        // =============================================
        // COMMENTS MANAGEMENT
        // =============================================
        let comments = [];

        async function loadComments() {
            const { data, error } = await supabaseClient
                .from('workflow_comments')
                .select('*')
                .eq('workflow_id', workflow.id)
                .order('created_at', { ascending: true });

            if (error) {
                console.error('Error loading comments:', error);
                return;
            }

            comments = data || [];
            renderComments();
            renderRecentComments();
            updateCommentsBadge();
        }

        // Comments badge - track unread client comments for admin
        function getLastSeenKey() {
            return `admin_comments_last_seen_${workflow?.id || 'unknown'}`;
        }

        function updateCommentsBadge() {
            const badge = document.getElementById('comments-badge');
            if (!badge || !workflow) return;

            const lastSeen = localStorage.getItem(getLastSeenKey());
            const lastSeenDate = lastSeen ? new Date(lastSeen) : new Date(0);

            // Count client comments newer than last seen
            const unreadCount = comments.filter(c =>
                c.author_type === 'client' && new Date(c.created_at) > lastSeenDate
            ).length;

            if (unreadCount > 0) {
                badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        function markCommentsAsRead() {
            if (!workflow) return;
            localStorage.setItem(getLastSeenKey(), new Date().toISOString());
            const badge = document.getElementById('comments-badge');
            if (badge) badge.classList.add('hidden');
        }

        function renderComments() {
            const container = document.getElementById('comments-list');
            const empty = document.getElementById('comments-empty');
            const countEl = document.getElementById('comments-count');
            const clientCountEl = document.getElementById('client-comments-count');

            countEl.textContent = comments.length;
            clientCountEl.textContent = comments.filter(c => c.author_type === 'client').length;

            if (comments.length === 0) {
                container.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }

            empty.classList.add('hidden');
            container.innerHTML = comments.map(c => {
                const isTeam = c.author_type === 'team';
                return `
                    <div class="flex gap-3 ${isTeam ? '' : 'flex-row-reverse'}">
                        <div class="w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center ${isTeam ? 'bg-violet-500/20' : 'bg-cyan-500/20'}">
                            <i class="ph ph-${isTeam ? 'user' : 'user-circle'} text-sm ${isTeam ? 'text-violet-400' : 'text-cyan-400'}"></i>
                        </div>
                        <div class="flex-1 ${isTeam ? '' : 'text-right'}">
                            <div class="inline-block ${isTeam ? 'bg-zinc-900' : 'bg-violet-900/30'} border ${isTeam ? 'border-white/5' : 'border-violet-500/20'} rounded-lg px-4 py-3 max-w-[80%] ${isTeam ? '' : 'text-left'}">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-white text-sm font-medium">${escapeHtml(c.author_name)}</span>
                                    <span class="text-zinc-600 text-xs">${formatDateTime(c.created_at)}</span>
                                </div>
                                <p class="text-zinc-300 text-sm whitespace-pre-wrap">${escapeHtml(c.content)}</p>
                                ${c.attachments?.length ? `
                                    <div class="mt-2 pt-2 border-t border-white/5 flex flex-wrap gap-2">
                                        ${c.attachments.map(a => `
                                            <a href="${a.url}" target="_blank" class="text-cyan-400 hover:text-cyan-300 text-xs flex items-center gap-1">
                                                <i class="ph ph-paperclip"></i> ${a.title}
                                            </a>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }

        function formatDateTime(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleDateString('pl-PL', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
        }

        async function postComment() {
            const content = document.getElementById('new-comment').value.trim();
            if (!content) return;

            const { data, error } = await supabaseClient
                .from('workflow_comments')
                .insert({
                    workflow_id: workflow.id,
                    author_type: 'team',
                    author_name: 'Tomasz Niedzwiecki',
                    content: content
                })
                .select()
                .single();

            if (!error && data) {
                // Log activity
                logActivity('comment_posted', `Dodano komentarz`, { comment_id: data.id, content_preview: content.substring(0, 50) });

                comments.push(data);
                renderComments();
                renderRecentComments();
                document.getElementById('new-comment').value = '';
                showToast('Komentarz dodany', 'success');
            }
        }
        window.postComment = postComment;

        async function postQuickComment() {
            const input = document.getElementById('quick-comment');
            const content = input.value.trim();
            if (!content) return;

            const { data, error } = await supabaseClient
                .from('workflow_comments')
                .insert({
                    workflow_id: workflow.id,
                    author_type: 'team',
                    author_name: 'Tomasz Niedzwiecki',
                    content: content
                })
                .select()
                .single();

            if (!error && data) {
                logActivity('comment_posted', `Dodano komentarz`, { comment_id: data.id, content_preview: content.substring(0, 50) });
                comments.push(data);
                renderComments();
                renderRecentComments();
                input.value = '';
                showToast('Komentarz dodany', 'success');
            }
        }
        window.postQuickComment = postQuickComment;

        function attachToComment() {
            // TODO: Implement attachment upload
            showToast('Funkcja w przygotowaniu', 'info');
        }
        window.attachToComment = attachToComment;

        function setFaviconHref(href, type) {
            document.querySelectorAll('link[rel="icon"], link[rel="shortcut icon"]').forEach(l => l.remove());
            const link = document.createElement('link');
            link.rel = 'icon';
            link.href = href;
            link.type = type || 'image/png';
            document.head.appendChild(link);
        }

        async function setFaviconFromBranding() {
            const wId = getWorkflowId();
            if (!wId) { setDefaultWorkflowFavicon(); return; }
            const { data: logos } = await supabaseClient
                .from('workflow_branding')
                .select('file_url, notes')
                .eq('workflow_id', wId)
                .eq('type', 'logo');
            if (!logos || !logos.length) { setDefaultWorkflowFavicon(); return; }
            const logo = logos.find(l => { const m = parseNotes(l.notes); return m.variant === 'favicon'; })
                || logos.find(l => { const m = parseNotes(l.notes); return m.variant === 'main'; })
                || logos[0];
            if (logo) {
                setFaviconHref(logo.file_url + '?v=' + Date.now(), 'image/png');
            } else {
                setDefaultWorkflowFavicon();
            }
        }

        function setDefaultWorkflowFavicon() {
            const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><rect width="32" height="32" rx="6" fill="#10b981"/><path d="M8 11h6v2H8zm0 4h10v2H8zm0 4h16v2H8zm18-8l-4 4-2-2-1.4 1.4L22 18l5.4-5.4z" fill="white"/></svg>`;
            setFaviconHref('data:image/svg+xml,' + encodeURIComponent(svg), 'image/svg+xml');
        }

        async function init() {
            const session = await checkAuth();
            if (session) {
                await loadWorkflow();
                // Load comments for badge (without rendering)
                await loadCommentsForBadge();
                // Set favicon from branding logo
                setFaviconFromBranding();
            }
        }

        async function loadCommentsForBadge() {
            const workflowId = getWorkflowId();
            if (!workflowId) return;

            const { data } = await supabaseClient
                .from('workflow_comments')
                .select('id, author_type, created_at')
                .eq('workflow_id', workflowId);

            comments = data || [];
            updateCommentsBadge();
        }

        init();

        // Register service worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').catch(() => {});
        }
    </script>
</body>
</html>
