<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TN Workflow - Automatyzacje</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <meta name="theme-color" content="#000000">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="../components/shared-sidebar.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    }
                }
            }
        }
    </script>
    <style>
        * { box-sizing: border-box; }
        body {
            background: #000;
            color: #ededed;
            font-feature-settings: 'ss01' on, 'ss02' on, 'cv01' on, 'cv03' on;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #444; }

        /* Selection */
        ::selection { background: #fff; color: #000; }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }

        /* Flow card */
        .flow-card {
            background: #0a0a0a;
            border: 1px solid #1a1a1a;
            border-radius: 12px;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .flow-card:hover {
            border-color: #333;
            transform: translateY(-2px);
            box-shadow: 0 4px 24px rgba(0,0,0,0.3);
        }

        /* Toggle switch */
        .toggle-switch {
            position: relative;
            width: 40px;
            height: 22px;
            background: #1a1a1a;
            border-radius: 11px;
            cursor: pointer;
            transition: background 0.2s;
            flex-shrink: 0;
        }
        .toggle-switch.active {
            background: #10b981;
        }
        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            transition: transform 0.2s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        .toggle-switch.active::after {
            transform: translateX(18px);
        }

        /* Step badges */
        .step-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 500;
        }
        .step-action { background: rgba(139, 92, 246, 0.15); color: #a78bfa; }
        .step-condition { background: rgba(245, 158, 11, 0.15); color: #fbbf24; }
        .step-delay { background: rgba(14, 165, 233, 0.15); color: #38bdf8; }

        /* Filter buttons */
        .filter-btn {
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            color: #666;
            transition: all 0.15s;
            border: 1px solid transparent;
        }
        .filter-btn:hover {
            color: #999;
        }
        .filter-btn.active {
            background: #111;
            color: #fff;
            border-color: #333;
        }

        /* Badge */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 500;
        }
        .badge-blue { background: rgba(37, 99, 235, 0.15); color: #60a5fa; }
        .badge-green { background: rgba(34, 197, 94, 0.15); color: #4ade80; }
        .badge-amber { background: rgba(245, 158, 11, 0.15); color: #fbbf24; }

        /* Button */
        .btn-primary {
            background: #fff;
            color: #000;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 500;
            font-size: 13px;
            border: none;
            cursor: pointer;
            transition: all 0.15s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .btn-primary:hover {
            background: #e5e5e5;
        }
    </style>
</head>
<body class="h-screen flex overflow-hidden font-sans antialiased">

    <!-- Sidebar -->
    <aside id="sidebar" class="w-[280px] bg-[#050505] border-r border-[#1a1a1a] flex flex-col flex-shrink-0"></aside>

    <!-- Main -->
    <main class="flex-1 flex flex-col bg-black relative min-w-0">
        <!-- Header -->
        <header class="h-14 border-b border-[#1a1a1a] bg-black/80 backdrop-blur-xl flex items-center justify-between px-6 sticky top-0 z-30">
            <div class="flex items-center gap-3">
                <button onclick="Sidebar.toggle()" class="mobile-menu-btn hidden items-center justify-center w-9 h-9 rounded-lg hover:bg-[#111] text-[#666] hover:text-white transition-colors">
                    <i class="ph ph-list text-xl"></i>
                </button>
                <div class="flex items-center gap-2 text-[#666]">
                    <span class="hidden sm:inline">tn-workflow</span>
                    <span class="text-[#333] hidden sm:inline">/</span>
                    <span class="text-white font-medium">automatyzacje</span>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <!-- Master toggle -->
                <div class="flex items-center gap-3">
                    <span class="text-xs text-[#666] hidden md:inline">Master switch</span>
                    <div id="master-toggle" class="toggle-switch" onclick="event.stopPropagation(); toggleMaster()"></div>
                </div>
                <a href="/tn-workflow/automation-builder" class="btn-primary">
                    <i class="ph ph-plus"></i>
                    <span class="hidden md:inline">Nowa automatyzacja</span>
                </a>
            </div>
        </header>

        <!-- Content -->
        <div class="flex-1 overflow-y-auto">
            <div class="max-w-4xl mx-auto px-6 py-10">
                <!-- Title & Stats -->
                <div class="flex items-start justify-between mb-8 animate-fade-in">
                    <div>
                        <h1 class="text-2xl font-semibold text-white tracking-tight mb-1">Automatyzacje</h1>
                        <p class="text-[#666] text-sm">Zarządzaj sekwencjami email i powiadomieniami</p>
                    </div>
                    <div class="flex items-center gap-6 text-sm">
                        <div class="text-right">
                            <div id="stat-active" class="text-xl font-semibold text-emerald-400">0</div>
                            <div class="text-[#666] text-xs">Aktywne</div>
                        </div>
                        <div class="text-right">
                            <div id="stat-total" class="text-xl font-semibold text-white">0</div>
                            <div class="text-[#666] text-xs">Wszystkie</div>
                        </div>
                    </div>
                </div>

                <!-- Filters -->
                <div class="flex items-center gap-2 mb-6 animate-fade-in" style="animation-delay: 50ms">
                    <button onclick="filterByTrigger(null)" class="filter-btn active" data-trigger="">
                        Wszystkie
                    </button>
                    <button onclick="filterByTrigger('offer')" class="filter-btn" data-trigger="offer">
                        Oferty
                    </button>
                    <button onclick="filterByTrigger('workflow')" class="filter-btn" data-trigger="workflow">
                        Workflow
                    </button>
                    <button onclick="filterByTrigger('payment')" class="filter-btn" data-trigger="payment">
                        Płatności
                    </button>
                </div>

                <!-- Flows list -->
                <div id="flows-container" class="space-y-3">
                    <!-- Loading -->
                    <div class="text-center py-20 text-[#666]">
                        <i class="ph ph-spinner animate-spin text-2xl"></i>
                    </div>
                </div>

                <!-- Empty state -->
                <div id="empty-state" class="hidden animate-fade-in">
                    <div class="text-center py-20 border border-dashed border-[#333] rounded-xl">
                        <div class="w-14 h-14 mx-auto mb-4 rounded-full bg-[#111] flex items-center justify-center">
                            <i class="ph ph-lightning text-2xl text-[#444]"></i>
                        </div>
                        <h3 class="text-base font-medium text-white mb-2">Brak automatyzacji</h3>
                        <p class="text-[#666] text-sm mb-6">Utwórz pierwszą automatyzację, aby rozpocząć</p>
                        <a href="/tn-workflow/automation-builder" class="btn-primary">
                            <i class="ph ph-plus"></i>
                            Nowa automatyzacja
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Toast container -->
    <div id="toast-container" class="fixed bottom-6 right-6 z-50 space-y-2"></div>

    <script>
        // ============================================
        // SUPABASE INIT
        // ============================================
        const SUPABASE_URL = 'https://yxmavwkwnfuphjqbelws.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl4bWF2d2t3bmZ1cGhqcWJlbHdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NjQyNTUsImV4cCI6MjA4NDM0MDI1NX0.XeR0Fc7OFn6YbNJrOKTBEj36JtmLISZTM87y4ai9340';
        const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // ============================================
        // STATE
        // ============================================
        let flows = [];
        let masterEnabled = true;
        let currentFilter = null;

        // ============================================
        // INIT
        // ============================================
        document.addEventListener('DOMContentLoaded', async () => {
            const { data: { user } } = await sb.auth.getUser();
            if (!user) {
                window.location.href = '/login';
                return;
            }

            Sidebar.render({ appId: 'workflow' });
            Sidebar.setUserEmail(user.email);
            Sidebar.setupLogout(sb);

            const { data: member } = await sb
                .from('team_members')
                .select('name, avatar_color, is_admin')
                .eq('email', user.email)
                .single();

            if (member) {
                Sidebar.setUserName(member.name);
                if (member.avatar_color) Sidebar.setUserColor(member.avatar_color);
            }

            await loadMasterSetting();
            await loadFlows();
        });

        // ============================================
        // DATA LOADING
        // ============================================
        async function loadMasterSetting() {
            const { data } = await sb
                .from('settings')
                .select('value')
                .eq('key', 'automations_master_enabled')
                .single();

            masterEnabled = data?.value === 'true';
            updateMasterToggle();
        }

        async function loadFlows() {
            const { data, error } = await sb
                .from('automation_flows')
                .select(`
                    *,
                    steps:automation_steps(id, step_order, step_type, config)
                `)
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error loading flows:', error);
                showToast('Błąd wczytywania automatyzacji', 'error');
                return;
            }

            flows = data || [];
            renderFlows();
            updateStats();
        }

        // ============================================
        // RENDERING
        // ============================================
        function renderFlows() {
            const container = document.getElementById('flows-container');
            const emptyState = document.getElementById('empty-state');

            let filtered = flows;
            if (currentFilter) {
                // Filter by category field, fallback to inferring from trigger_type for old records
                filtered = flows.filter(f => {
                    const category = f.category || inferCategoryFromTrigger(f.trigger_type);
                    return category === currentFilter;
                });
            }

            if (filtered.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            container.innerHTML = filtered.map((flow, i) => renderFlowCard(flow, i)).join('');
        }

        function renderFlowCard(flow, index) {
            const steps = flow.steps || [];
            const stepsCount = steps.length;
            const triggerLabel = getTriggerLabel(flow.trigger_type);
            const triggerIcon = getTriggerIcon(flow.trigger_type);
            const filterLabel = getFilterLabel(flow.trigger_filters);
            const category = flow.category || inferCategoryFromTrigger(flow.trigger_type);
            const categoryLabel = getCategoryLabel(category);
            const categoryColor = getCategoryColor(category);
            const delay = index * 50 + 100;

            return `
                <div class="flow-card p-5 animate-fade-in" style="animation-delay: ${delay}ms" onclick="openFlow('${flow.id}')">
                    <div class="flex items-start justify-between gap-4">
                        <div class="flex items-start gap-4 flex-1 min-w-0">
                            <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-violet-500/20 to-purple-600/20 flex items-center justify-center flex-shrink-0 border border-violet-500/20">
                                <i class="ph ${triggerIcon} text-violet-400"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2 mb-1">
                                    <h3 class="text-base font-medium text-white truncate">${flow.name}</h3>
                                    <span class="badge ${categoryColor}">${categoryLabel}</span>
                                    ${filterLabel ? `<span class="badge badge-amber">${filterLabel}</span>` : ''}
                                    ${flow.is_active ? '<span class="badge badge-green">Aktywna</span>' : ''}
                                </div>
                                ${flow.description ? `<p class="text-sm text-[#666] mb-3 line-clamp-1">${flow.description}</p>` : ''}
                                <div class="flex items-center gap-4 text-xs text-[#666]">
                                    <span class="flex items-center gap-1.5">
                                        <i class="ph ph-lightning text-amber-400"></i>
                                        ${triggerLabel}
                                    </span>
                                    <span class="flex items-center gap-1.5">
                                        <i class="ph ph-list-numbers"></i>
                                        ${stepsCount} ${stepsCount === 1 ? 'krok' : 'kroków'}
                                    </span>
                                </div>
                                <!-- Steps preview -->
                                <div class="flex items-center gap-2 mt-3 flex-wrap">
                                    ${steps.sort((a,b) => a.step_order - b.step_order).slice(0, 4).map(s => renderStepBadge(s)).join('')}
                                    ${stepsCount > 4 ? `<span class="text-xs text-[#666]">+${stepsCount - 4}</span>` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="toggle-switch ${flow.is_active ? 'active' : ''}" onclick="event.stopPropagation(); toggleFlow('${flow.id}', ${!flow.is_active})"></div>
                            <button onclick="event.stopPropagation(); deleteFlow('${flow.id}')"
                                class="w-8 h-8 rounded-lg hover:bg-red-500/10 flex items-center justify-center text-[#666] hover:text-red-400 transition-colors">
                                <i class="ph ph-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function getCategoryLabel(category) {
            const labels = {
                offer: 'Oferty',
                workflow: 'Workflow',
                payment: 'Płatności'
            };
            return labels[category] || 'Workflow';
        }

        function getCategoryColor(category) {
            const colors = {
                offer: 'badge-blue',
                workflow: 'badge-amber',
                payment: 'badge-green'
            };
            return colors[category] || 'badge-amber';
        }

        function renderStepBadge(step) {
            const icons = {
                action: 'ph-paper-plane-tilt',
                condition: 'ph-git-branch',
                delay: 'ph-clock'
            };
            const classes = {
                action: 'step-action',
                condition: 'step-condition',
                delay: 'step-delay'
            };
            const labels = {
                action: getActionLabel(step.config),
                condition: getConditionLabel(step.config),
                delay: getDelayLabel(step.config)
            };

            return `<span class="step-badge ${classes[step.step_type]}"><i class="ph ${icons[step.step_type]}"></i>${labels[step.step_type]}</span>`;
        }

        function getActionLabel(config) {
            if (config?.action_type === 'send_email') {
                const emailLabels = {
                    offer_created: 'Email: Oferta',
                    offer_reminder_halfway: 'Email: Reminder',
                    workflow_created: 'Email: Powitanie',
                    workflow_stage_completed: 'Email: Etap'
                };
                return emailLabels[config.email_type] || 'Email';
            }
            return 'Akcja';
        }

        function getConditionLabel(config) {
            if (config?.field === 'has_purchased') return 'Nie kupił?';
            if (config?.field === 'email_opened') return 'Otworzył?';
            return 'Warunek';
        }

        function getDelayLabel(config) {
            const units = { hours: 'h', days: 'd', weeks: 'tyg' };
            return `${config?.delay_value || 1}${units[config?.delay_unit] || 'd'}`;
        }

        function getTriggerLabel(type) {
            const labels = {
                offer_created: 'Oferta utworzona',
                offer_viewed: 'Oferta obejrzana',
                offer_expired: 'Oferta wygasła',
                payment_received: 'Płatność otrzymana',
                workflow_created: 'Workflow utworzony',
                stage_completed: 'Etap ukończony',
                products_shared: 'Produkty udostępnione',
                report_published: 'Raport opublikowany',
                branding_delivered: 'Branding dostarczony',
                sales_page_shared: 'Sales page udostępniony',
                contract_signed: 'Umowa podpisana',
                takedrop_activated: 'TakeDrop aktywowany'
            };
            return labels[type] || type;
        }

        function getTriggerIcon(type) {
            const icons = {
                offer_created: 'ph-file-text',
                offer_viewed: 'ph-eye',
                offer_expired: 'ph-clock-countdown',
                payment_received: 'ph-credit-card',
                workflow_created: 'ph-play',
                stage_completed: 'ph-check-circle',
                products_shared: 'ph-package',
                report_published: 'ph-file-doc',
                branding_delivered: 'ph-paint-brush',
                sales_page_shared: 'ph-globe',
                contract_signed: 'ph-signature',
                takedrop_activated: 'ph-storefront'
            };
            return icons[type] || 'ph-lightning';
        }

        function inferCategoryFromTrigger(triggerType) {
            if (triggerType.startsWith('offer')) return 'offer';
            if (triggerType.startsWith('payment') || triggerType === 'contract_signed') return 'payment';
            return 'workflow';
        }

        function getFilterLabel(filters) {
            if (!filters || Object.keys(filters).length === 0) return null;
            if (filters.offer_type === 'full') return 'pełen pakiet';
            if (filters.offer_type === 'starter') return 'starter';
            return null;
        }

        function updateStats() {
            const active = flows.filter(f => f.is_active).length;
            document.getElementById('stat-active').textContent = active;
            document.getElementById('stat-total').textContent = flows.length;
        }

        function updateMasterToggle() {
            const toggle = document.getElementById('master-toggle');
            toggle.classList.toggle('active', masterEnabled);
        }

        // ============================================
        // FILTERS
        // ============================================
        function filterByTrigger(filter) {
            currentFilter = filter;

            document.querySelectorAll('.filter-btn').forEach(btn => {
                const btnTrigger = btn.dataset.trigger;
                btn.classList.toggle('active', (filter === null && btnTrigger === '') || btnTrigger === filter);
            });

            renderFlows();
        }

        // ============================================
        // ACTIONS
        // ============================================
        function openFlow(flowId) {
            window.location.href = `/tn-workflow/automation-builder?id=${flowId}`;
        }

        async function toggleMaster() {
            masterEnabled = !masterEnabled;
            updateMasterToggle();

            const { error } = await sb
                .from('settings')
                .update({ value: masterEnabled ? 'true' : 'false' })
                .eq('key', 'automations_master_enabled');

            if (error) {
                showToast('Błąd zapisywania', 'error');
                masterEnabled = !masterEnabled;
                updateMasterToggle();
                return;
            }

            showToast(masterEnabled ? 'Automatyzacje włączone' : 'Automatyzacje wyłączone', 'success');
        }

        async function toggleFlow(flowId, newState) {
            const { error } = await sb
                .from('automation_flows')
                .update({ is_active: newState })
                .eq('id', flowId);

            if (error) {
                showToast('Błąd zapisywania', 'error');
                return;
            }

            const flow = flows.find(f => f.id === flowId);
            if (flow) flow.is_active = newState;

            renderFlows();
            updateStats();
            showToast(newState ? 'Automatyzacja włączona' : 'Automatyzacja wyłączona', 'success');
        }

        async function deleteFlow(flowId) {
            if (!confirm('Czy na pewno chcesz usunąć tę automatyzację?')) return;

            const { error } = await sb
                .from('automation_flows')
                .delete()
                .eq('id', flowId);

            if (error) {
                showToast('Błąd usuwania', 'error');
                return;
            }

            flows = flows.filter(f => f.id !== flowId);
            renderFlows();
            updateStats();
            showToast('Automatyzacja usunięta', 'success');
        }

        // ============================================
        // TOAST
        // ============================================
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const colors = {
                success: 'bg-green-500/10 border-green-500/20 text-green-400',
                error: 'bg-red-500/10 border-red-500/20 text-red-400',
                info: 'bg-blue-500/10 border-blue-500/20 text-blue-400'
            };

            const toast = document.createElement('div');
            toast.className = `px-4 py-3 rounded-lg border ${colors[type]} backdrop-blur-sm animate-fade-in flex items-center gap-2 text-sm`;
            toast.innerHTML = `<i class="ph ${type === 'success' ? 'ph-check' : type === 'error' ? 'ph-x' : 'ph-info'}"></i><span>${message}</span>`;
            container.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(16px)';
                toast.style.transition = 'all 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>
