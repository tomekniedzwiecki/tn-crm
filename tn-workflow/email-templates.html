<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Szablony emaili | TN Workflow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/@phosphor-icons/web@2.0.3/src/regular/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        body { background: #000; }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #444; }

        .template-card { transition: all 0.2s ease; }
        .template-card:hover { border-color: rgba(255,255,255,0.2); }
        .template-card.active { border-color: #3b82f6; background: rgba(59, 130, 246, 0.05); }

        .var-tag {
            background: rgba(59, 130, 246, 0.15);
            color: #60a5fa;
            padding: 2px 8px;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .var-tag:hover { background: rgba(59, 130, 246, 0.25); }

        .editor-textarea {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            line-height: 1.5;
        }

        .preview-frame { background: white; border-radius: 8px; transition: all 0.3s ease; overflow: hidden; }
        .preview-desktop { width: 100%; }
        .preview-mobile {
            width: 375px;
            margin: 0 auto;
            box-shadow: 0 0 0 8px #222, 0 0 0 10px #333;
            border-radius: 32px;
            padding: 12px 0;
        }
        .preview-mobile iframe { border-radius: 0; }

        .device-btn { transition: all 0.15s; }
        .device-btn.active { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out; }
    </style>
</head>
<body class="h-screen flex overflow-hidden font-sans antialiased">
    <aside id="sidebar" class="w-56 lg:w-[224px] bg-[#050505] border-r border-[#1a1a1a] flex flex-col flex-shrink-0"></aside>

    <main id="main-content" class="flex-1 flex flex-col bg-black relative min-w-0 overflow-hidden">
        <header class="h-14 border-b border-[#1a1a1a] bg-black/80 backdrop-blur-xl flex items-center justify-between px-6 sticky top-0 z-30">
            <div class="flex items-center">
                <button onclick="Sidebar.toggle()" class="mobile-menu-btn hidden items-center justify-center w-9 h-9 rounded-lg hover:bg-[#111] text-[#666] hover:text-white transition-colors mr-3">
                    <i class="ph ph-list text-xl"></i>
                </button>
                <h1 class="text-lg font-semibold text-white">Szablony emaili</h1>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="saveTemplate()" id="save-btn" disabled class="px-4 py-1.5 bg-blue-600 hover:bg-blue-500 disabled:bg-zinc-800 disabled:text-zinc-600 text-white text-sm font-medium rounded-lg transition-colors flex items-center gap-2">
                    <i class="ph ph-floppy-disk"></i>
                    Zapisz
                </button>
            </div>
        </header>

        <div class="flex-1 flex overflow-hidden">
            <!-- Templates List -->
            <div class="w-64 border-r border-[#1a1a1a] flex flex-col flex-shrink-0">
                <div class="p-3 border-b border-[#1a1a1a]">
                    <div class="relative">
                        <input type="text" id="search-templates" placeholder="Szukaj..."
                               class="w-full bg-zinc-900/50 border border-white/10 rounded-lg pl-8 pr-3 py-1.5 text-sm text-white placeholder-zinc-600 focus:outline-none focus:border-white/20">
                        <i class="ph ph-magnifying-glass absolute left-2.5 top-1/2 -translate-y-1/2 text-zinc-500 text-sm"></i>
                    </div>
                </div>
                <div id="templates-list" class="flex-1 overflow-y-auto p-2">
                    <!-- Templates will be loaded here -->
                </div>
            </div>

            <!-- Main Content -->
            <div class="flex-1 flex overflow-hidden">
                <!-- No template selected -->
                <div id="no-template" class="flex-1 flex items-center justify-center">
                    <div class="text-center">
                        <i class="ph ph-envelope-simple text-5xl text-zinc-700 mb-4"></i>
                        <p class="text-zinc-500">Wybierz szablon z listy</p>
                    </div>
                </div>

                <!-- Editor Panel -->
                <div id="editor-panel" class="flex-1 flex overflow-hidden hidden">
                    <!-- Editor (narrower) -->
                    <div class="w-[380px] flex flex-col border-r border-[#1a1a1a] flex-shrink-0">
                        <!-- Template info -->
                        <div class="p-3 border-b border-[#1a1a1a]">
                            <h2 id="template-name" class="text-base font-medium text-white"></h2>
                            <p id="template-description" class="text-xs text-zinc-500 mt-1"></p>
                        </div>

                        <!-- Variables bar -->
                        <div class="px-3 py-2 border-b border-[#1a1a1a] bg-zinc-900/30">
                            <div class="flex items-center gap-1.5 flex-wrap">
                                <span class="text-[10px] text-zinc-500 mr-1">Zmienne:</span>
                                <button onclick="insertVariable('clientName')" class="var-tag">{{clientName}}</button>
                                <button onclick="insertVariable('offerName')" class="var-tag">{{offerName}}</button>
                                <button onclick="insertVariable('offerPrice')" class="var-tag">{{offerPrice}}</button>
                                <button onclick="insertVariable('validUntil')" class="var-tag">{{validUntil}}</button>
                                <button onclick="insertVariable('offerUrl')" class="var-tag">{{offerUrl}}</button>
                                <button onclick="insertVariable('email')" class="var-tag">{{email}}</button>
                            </div>
                        </div>

                        <!-- Subject -->
                        <div class="p-3 border-b border-[#1a1a1a]">
                            <label class="block text-[10px] text-zinc-500 uppercase tracking-wider mb-1.5">Temat</label>
                            <input type="text" id="subject-input"
                                   class="w-full bg-zinc-900/50 border border-white/10 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-white/20 editor-textarea"
                                   oninput="onEditorChange()">
                        </div>

                        <!-- Body -->
                        <div class="flex-1 flex flex-col p-3 overflow-hidden">
                            <div class="flex items-center justify-between mb-1.5">
                                <label class="block text-[10px] text-zinc-500 uppercase tracking-wider">Treść (HTML)</label>
                                <button onclick="toggleHtmlEditor()" id="toggle-html-btn" class="text-[10px] text-blue-400 hover:text-blue-300 flex items-center gap-1 transition-colors">
                                    <i class="ph ph-code text-xs"></i>
                                    <span id="toggle-html-text">Pokaż HTML</span>
                                </button>
                            </div>
                            <!-- Placeholder when HTML hidden -->
                            <div id="html-placeholder" class="flex-1 flex flex-col items-center justify-center bg-zinc-900/30 border border-white/5 rounded-lg">
                                <i class="ph ph-code text-3xl text-zinc-600 mb-2"></i>
                                <p class="text-zinc-500 text-xs mb-3">Kod HTML jest ukryty</p>
                                <button onclick="toggleHtmlEditor()" class="px-3 py-1.5 bg-zinc-800 hover:bg-zinc-700 text-white text-xs rounded-lg transition-colors flex items-center gap-1.5">
                                    <i class="ph ph-eye"></i>
                                    Pokaż kod
                                </button>
                            </div>
                            <!-- HTML Editor -->
                            <textarea id="body-input"
                                      class="hidden flex-1 w-full bg-zinc-900/50 border border-white/10 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-white/20 editor-textarea resize-none"
                                      oninput="onEditorChange()"></textarea>
                        </div>
                    </div>

                    <!-- Preview (wider) -->
                    <div class="flex-1 flex flex-col overflow-hidden bg-zinc-900/20">
                        <div class="p-3 border-b border-[#1a1a1a] flex items-center justify-between">
                            <label class="text-xs text-zinc-500 uppercase tracking-wider">Podgląd</label>
                            <div class="flex items-center gap-1">
                                <button onclick="setPreviewMode('desktop')" id="btn-desktop" class="device-btn active p-1.5 rounded text-zinc-400 hover:text-white">
                                    <i class="ph ph-desktop text-lg"></i>
                                </button>
                                <button onclick="setPreviewMode('mobile')" id="btn-mobile" class="device-btn p-1.5 rounded text-zinc-400 hover:text-white">
                                    <i class="ph ph-device-mobile text-lg"></i>
                                </button>
                                <div class="w-px h-4 bg-zinc-700 mx-1"></div>
                                <button onclick="refreshPreview()" class="p-1.5 text-zinc-400 hover:text-white transition-colors">
                                    <i class="ph ph-arrow-clockwise text-lg"></i>
                                </button>
                            </div>
                        </div>
                        <div class="flex-1 p-4 overflow-auto">
                            <div class="bg-zinc-800 rounded-lg p-3 mb-4">
                                <div class="text-[10px] text-zinc-500 mb-1">Temat:</div>
                                <div id="preview-subject" class="text-white text-sm"></div>
                            </div>
                            <div id="preview-container" class="preview-frame preview-desktop">
                                <iframe id="preview-iframe" class="w-full border-0 block" style="height: calc(100vh - 280px); min-height: 400px;"></iframe>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="../components/shared-sidebar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        const SUPABASE_URL = 'https://yxmavwkwnfuphjqbelws.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl4bWF2d2t3bmZ1cGhqcWJlbHdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NjQyNTUsImV4cCI6MjA4NDM0MDI1NX0.XeR0Fc7OFn6YbNJrOKTBEj36JtmLISZTM87y4ai9340';
        const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Template categories
        const TEMPLATE_CATEGORIES = {
            transakcyjne: {
                label: 'Transakcyjne',
                description: 'Maile związane z ofertami i sprzedażą',
                templates: ['offer_created', 'offer_reminder_halfway', 'offer_expired', 'contract_sent', 'invoice_sent']
            },
            projektowe: {
                label: 'Etap 1 - Budowa sklepu',
                description: 'Maile związane z realizacją projektów',
                templates: ['workflow_created', 'workflow_stage_completed', 'products_shared', 'report_published', 'branding_delivered', 'sales_page_shared']
            },
            takedrop: {
                label: 'Etap 3 - TakeDrop',
                description: 'Maile związane z konfiguracją TakeDrop',
                templates: ['takedrop_activated']
            }
        };

        // Template definitions
        const TEMPLATE_DEFINITIONS = {
            'offer_created': {
                name: 'Oferta utworzona',
                description: 'Wysyłany gdy tworzona jest nowa oferta',
                icon: 'ph-paper-plane-tilt',
                color: 'emerald'
            },
            'offer_reminder_halfway': {
                name: 'Przypomnienie o ofercie',
                description: 'Wysyłany w połowie ważności oferty',
                icon: 'ph-bell',
                color: 'amber'
            },
            'offer_expired': {
                name: 'Oferta wygasła',
                description: 'Wysyłany gdy oferta traci ważność',
                icon: 'ph-clock-countdown',
                color: 'red'
            },
            'contract_sent': {
                name: 'Umowa wysłana',
                description: 'Wysyłany wraz z umową do podpisu',
                icon: 'ph-file-text',
                color: 'orange'
            },
            'invoice_sent': {
                name: 'Faktura wysłana',
                description: 'Wysyłany wraz z fakturą',
                icon: 'ph-receipt',
                color: 'pink'
            },
            'workflow_created': {
                name: 'Projekt utworzony',
                description: 'Wysyłany gdy tworzony jest nowy projekt',
                icon: 'ph-path',
                color: 'blue'
            },
            'workflow_stage_completed': {
                name: 'Etap ukończony',
                description: 'Wysyłany gdy ukończony zostaje etap',
                icon: 'ph-check-circle',
                color: 'green'
            },
            'products_shared': {
                name: 'Produkty udostępnione',
                description: 'Wysyłany gdy udostępniane są produkty',
                icon: 'ph-package',
                color: 'amber'
            },
            'report_published': {
                name: 'Raport opublikowany',
                description: 'Wysyłany gdy publikowany jest raport',
                icon: 'ph-chart-bar',
                color: 'pink'
            },
            'branding_delivered': {
                name: 'Branding dostarczony',
                description: 'Wysyłany gdy branding jest gotowy',
                icon: 'ph-palette',
                color: 'violet'
            },
            'sales_page_shared': {
                name: 'Strona sprzedażowa',
                description: 'Wysyłany gdy udostępniana jest strona',
                icon: 'ph-globe',
                color: 'cyan'
            },
            'takedrop_activated': {
                name: 'Aktywuj TakeDrop',
                description: 'Wysyłany gdy admin aktywuje zakładkę TakeDrop',
                icon: 'ph-storefront',
                color: 'cyan'
            }
        };

        const PREVIEW_DATA = {
            clientName: 'Jan Kowalski',
            offerName: 'Budowa sklepu pełen pakiet',
            offerPrice: '15 000',
            validUntil: '15 marca 2026',
            offerUrl: 'https://crm.tomekniedzwiecki.pl/p/abc123',
            email: 'jan@example.com'
        };

        // State
        let templates = {};
        let selectedTemplate = null;
        let hasChanges = false;
        let originalSubject = '';
        let originalBody = '';
        let previewMode = 'desktop';
        let htmlVisible = false;

        // Color map
        const colorMap = {
            'emerald': 'bg-emerald-500/20 text-emerald-400',
            'amber': 'bg-amber-500/20 text-amber-400',
            'red': 'bg-red-500/20 text-red-400',
            'blue': 'bg-blue-500/20 text-blue-400',
            'green': 'bg-green-500/20 text-green-400',
            'violet': 'bg-violet-500/20 text-violet-400',
            'cyan': 'bg-cyan-500/20 text-cyan-400',
            'orange': 'bg-orange-500/20 text-orange-400',
            'pink': 'bg-pink-500/20 text-pink-400'
        };

        async function loadTemplates() {
            const { data, error } = await sb
                .from('settings')
                .select('key, value')
                .like('key', 'email_template_%');

            if (error) {
                console.error('Error loading templates:', error);
                return;
            }

            templates = {};
            (data || []).forEach(item => {
                const match = item.key.match(/^email_template_(.+?)_(subject|body)$/);
                if (match) {
                    const [, type, field] = match;
                    if (!templates[type]) templates[type] = {};
                    templates[type][field] = item.value;
                }
            });

            renderTemplatesList();
        }

        function renderTemplatesList() {
            const container = document.getElementById('templates-list');
            const searchQuery = document.getElementById('search-templates').value.toLowerCase();

            let html = '';

            Object.entries(TEMPLATE_CATEGORIES).forEach(([categoryKey, category]) => {
                const filteredTemplates = category.templates.filter(type => {
                    const def = TEMPLATE_DEFINITIONS[type];
                    if (!def) return false;
                    return def.name.toLowerCase().includes(searchQuery) ||
                           def.description.toLowerCase().includes(searchQuery);
                });

                if (filteredTemplates.length === 0) return;

                html += `
                    <div class="mb-4">
                        <div class="text-[10px] text-zinc-500 uppercase tracking-wider font-medium px-2 py-1.5">${category.label}</div>
                        <div class="space-y-1">
                `;

                filteredTemplates.forEach(type => {
                    const def = TEMPLATE_DEFINITIONS[type];
                    const hasTemplate = templates[type]?.subject || templates[type]?.body;
                    const isActive = selectedTemplate === type;

                    html += `
                        <div onclick="selectTemplate('${type}')"
                             class="template-card p-2.5 rounded-lg border border-white/5 cursor-pointer ${isActive ? 'active' : ''}">
                            <div class="flex items-center gap-2.5">
                                <div class="w-7 h-7 rounded-lg ${colorMap[def.color] || 'bg-zinc-500/20 text-zinc-400'} flex items-center justify-center flex-shrink-0">
                                    <i class="ph ${def.icon} text-sm"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-1.5">
                                        <span class="text-xs font-medium text-white truncate">${def.name}</span>
                                        ${hasTemplate ? '<span class="w-1.5 h-1.5 rounded-full bg-emerald-400 flex-shrink-0"></span>' : '<span class="w-1.5 h-1.5 rounded-full bg-zinc-600 flex-shrink-0"></span>'}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += '</div></div>';
            });

            container.innerHTML = html || '<div class="p-4 text-center text-zinc-600 text-sm">Brak szablonów</div>';
        }

        function selectTemplate(type) {
            if (hasChanges && !confirm('Masz niezapisane zmiany. Czy na pewno chcesz zmienić szablon?')) {
                return;
            }

            selectedTemplate = type;
            hasChanges = false;

            const def = TEMPLATE_DEFINITIONS[type];
            const template = templates[type] || {};

            document.getElementById('no-template').classList.add('hidden');
            document.getElementById('editor-panel').classList.remove('hidden');

            document.getElementById('template-name').textContent = def.name;
            document.getElementById('template-description').textContent = def.description;

            document.getElementById('subject-input').value = template.subject || '';
            document.getElementById('body-input').value = template.body || '';

            originalSubject = template.subject || '';
            originalBody = template.body || '';

            renderTemplatesList();
            updateSaveButton();
            hideHtmlEditor();
            refreshPreview();
        }

        function insertVariable(varName) {
            const bodyInput = document.getElementById('body-input');
            const subjectInput = document.getElementById('subject-input');

            const activeElement = document.activeElement;
            let input = bodyInput;
            if (activeElement === subjectInput) {
                input = subjectInput;
            }

            const start = input.selectionStart;
            const end = input.selectionEnd;
            const text = input.value;
            const variable = `{{${varName}}}`;

            input.value = text.substring(0, start) + variable + text.substring(end);
            input.focus();
            input.setSelectionRange(start + variable.length, start + variable.length);

            onEditorChange();
        }

        function onEditorChange() {
            const subject = document.getElementById('subject-input').value;
            const body = document.getElementById('body-input').value;

            hasChanges = subject !== originalSubject || body !== originalBody;
            updateSaveButton();
            refreshPreview();
        }

        function updateSaveButton() {
            const btn = document.getElementById('save-btn');
            btn.disabled = !hasChanges;
        }

        function toggleHtmlEditor() {
            if (htmlVisible) {
                hideHtmlEditor();
            } else {
                showHtmlEditor();
            }
        }

        function showHtmlEditor() {
            htmlVisible = true;
            document.getElementById('html-placeholder').classList.add('hidden');
            document.getElementById('body-input').classList.remove('hidden');
            document.getElementById('toggle-html-text').textContent = 'Ukryj HTML';
        }

        function hideHtmlEditor() {
            htmlVisible = false;
            document.getElementById('html-placeholder').classList.remove('hidden');
            document.getElementById('body-input').classList.add('hidden');
            document.getElementById('toggle-html-text').textContent = 'Pokaż HTML';
        }

        function setPreviewMode(mode) {
            previewMode = mode;
            const container = document.getElementById('preview-container');

            document.getElementById('btn-desktop').classList.toggle('active', mode === 'desktop');
            document.getElementById('btn-mobile').classList.toggle('active', mode === 'mobile');

            if (mode === 'mobile') {
                container.classList.remove('preview-desktop');
                container.classList.add('preview-mobile');
            } else {
                container.classList.remove('preview-mobile');
                container.classList.add('preview-desktop');
            }
        }

        function refreshPreview() {
            const subject = document.getElementById('subject-input').value;
            const body = document.getElementById('body-input').value;

            const replaceVars = (text) => {
                return text
                    .replace(/\{\{clientName\}\}/g, PREVIEW_DATA.clientName)
                    .replace(/\{\{offerName\}\}/g, PREVIEW_DATA.offerName)
                    .replace(/\{\{offerPrice\}\}/g, PREVIEW_DATA.offerPrice)
                    .replace(/\{\{validUntil\}\}/g, PREVIEW_DATA.validUntil)
                    .replace(/\{\{offerUrl\}\}/g, PREVIEW_DATA.offerUrl)
                    .replace(/\{\{email\}\}/g, PREVIEW_DATA.email);
            };

            document.getElementById('preview-subject').textContent = replaceVars(subject) || '(brak tematu)';

            const iframe = document.getElementById('preview-iframe');
            const previewBody = replaceVars(body) || '<p style="padding: 20px; color: #666;">Brak treści - wpisz HTML w edytorze</p>';
            iframe.srcdoc = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
                    <style>
                        * {
                            box-sizing: border-box !important;
                            max-width: 100% !important;
                        }
                        html, body {
                            width: 100% !important;
                            overflow-x: hidden !important;
                        }
                        body {
                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                            font-size: 14px;
                            line-height: 1.6;
                            color: #333;
                            margin: 0;
                            padding: 16px;
                            word-wrap: break-word;
                            overflow-wrap: anywhere;
                            word-break: break-word;
                        }
                        a { color: #2563eb; word-break: break-all; }
                        img { max-width: 100% !important; height: auto !important; display: block; }
                        table { width: 100% !important; max-width: 100% !important; table-layout: fixed !important; }
                        td, th { word-wrap: break-word; overflow-wrap: anywhere; word-break: break-word; }
                        h1, h2, h3, h4, h5, h6 { word-wrap: break-word; overflow-wrap: anywhere; word-break: break-word; }
                        p, div, span { max-width: 100% !important; word-wrap: break-word; overflow-wrap: anywhere; }
                        pre, code { white-space: pre-wrap !important; word-break: break-all; }
                    </style>
                </head>
                <body>${previewBody}</body>
                </html>
            `;
        }

        async function saveTemplate() {
            if (!selectedTemplate || !hasChanges) return;

            const subject = document.getElementById('subject-input').value;
            const body = document.getElementById('body-input').value;

            const btn = document.getElementById('save-btn');
            btn.disabled = true;
            btn.innerHTML = '<i class="ph ph-circle-notch animate-spin"></i> Zapisuję...';

            try {
                const { error: subjectError } = await sb
                    .from('settings')
                    .upsert({
                        key: `email_template_${selectedTemplate}_subject`,
                        value: subject
                    }, { onConflict: 'key' });

                if (subjectError) throw subjectError;

                const { error: bodyError } = await sb
                    .from('settings')
                    .upsert({
                        key: `email_template_${selectedTemplate}_body`,
                        value: body
                    }, { onConflict: 'key' });

                if (bodyError) throw bodyError;

                if (!templates[selectedTemplate]) templates[selectedTemplate] = {};
                templates[selectedTemplate].subject = subject;
                templates[selectedTemplate].body = body;

                originalSubject = subject;
                originalBody = body;
                hasChanges = false;

                renderTemplatesList();
                updateSaveButton();

                btn.innerHTML = '<i class="ph ph-check"></i> Zapisano';
                setTimeout(() => {
                    btn.innerHTML = '<i class="ph ph-floppy-disk"></i> Zapisz';
                }, 2000);

            } catch (error) {
                console.error('Error saving template:', error);
                alert('Błąd zapisywania szablonu');
                btn.disabled = false;
                btn.innerHTML = '<i class="ph ph-floppy-disk"></i> Zapisz';
            }
        }

        document.getElementById('search-templates').addEventListener('input', renderTemplatesList);

        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                if (hasChanges) saveTemplate();
            }
        });

        window.addEventListener('beforeunload', (e) => {
            if (hasChanges) {
                e.preventDefault();
                e.returnValue = '';
            }
        });

        async function init() {
            Sidebar.render({ appId: 'workflow' });

            const { data: { session } } = await sb.auth.getSession();
            if (!session) {
                window.location.href = Sidebar.getLoginPath();
                return;
            }

            Sidebar.setUserEmail(session.user.email);
            Sidebar.setupLogout(sb);

            await loadTemplates();
        }

        init();
    </script>
</body>
</html>
