<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TN CRM - Produkty</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#050505">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="../components/shared-sidebar.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    }
                }
            }
        }
    </script>
    <style>
        body { background: #000; color: #e5e5e5; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        ::selection { background: white; color: black; }

        .glass-header {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-enter { animation: fadeIn 0.4s ease-out forwards; }

        .product-card:hover {
            border-color: rgba(255,255,255,0.15);
            transform: translateY(-1px);
        }
    </style>
</head>
<body class="h-screen flex overflow-hidden font-sans text-sm tracking-tight antialiased">

    <!-- Sidebar -->
    <aside id="sidebar" class="w-[280px] bg-zinc-950 border-r border-white/5 flex flex-col flex-shrink-0"></aside>

    <!-- Main -->
    <main class="flex-1 flex flex-col bg-black relative min-w-0">
        <!-- Header -->
        <header class="glass-header flex items-center justify-between px-6 h-14 flex-shrink-0 z-10">
            <div class="flex items-center gap-3">
                <button onclick="Sidebar.toggle()" class="mobile-menu-btn hidden p-2 -ml-2 text-zinc-400 hover:text-white">
                    <i class="ph ph-list text-xl"></i>
                </button>
                <span class="text-zinc-500 text-xs font-mono">tn-crm / <span class="text-zinc-300">produkty</span></span>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="openAddProductModal()" class="bg-white text-black hover:bg-zinc-200 px-3 py-1.5 rounded-lg text-xs font-medium transition-colors flex items-center gap-1.5">
                    <i class="ph ph-plus"></i>
                    Dodaj produkt
                </button>
            </div>
        </header>

        <!-- Content -->
        <div class="flex-1 overflow-y-auto p-6 lg:p-10">
            <div class="max-w-7xl mx-auto animate-enter">
                <!-- Title & Stats -->
                <div class="flex items-start justify-between mb-6">
                    <div>
                        <h1 class="text-3xl font-semibold text-white tracking-tight mb-1">Produkty</h1>
                        <p class="text-zinc-500">Globalna baza produktów. Klienci wybierają z tej listy.</p>
                    </div>
                    <div class="text-right">
                        <div class="text-3xl font-semibold text-white" id="total-products">-</div>
                        <div class="text-xs text-zinc-500">produktów</div>
                    </div>
                </div>

                <!-- Active/Inactive Tabs -->
                <div class="flex items-center gap-1 mb-6 border-b border-white/5">
                    <button onclick="setActiveTab('active')" id="tab-active" class="active-tab px-4 py-2.5 text-sm font-medium transition-colors border-b-2 border-emerald-500 text-white">
                        <i class="ph ph-check-circle mr-1.5"></i>Aktywne <span id="count-active" class="text-zinc-500 ml-1">0</span>
                    </button>
                    <button onclick="setActiveTab('inactive')" id="tab-inactive" class="inactive-tab px-4 py-2.5 text-sm font-medium transition-colors border-b-2 border-transparent text-zinc-500 hover:text-zinc-300">
                        <i class="ph ph-eye-slash mr-1.5"></i>Wyłączone <span id="count-inactive" class="text-zinc-600 ml-1">0</span>
                    </button>
                </div>

                <!-- Filters -->
                <div class="flex items-center gap-3 mb-6">
                    <div class="relative flex-1 max-w-md">
                        <i class="ph ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-zinc-500"></i>
                        <input id="search-input" type="text" placeholder="Szukaj produktów..." class="w-full bg-zinc-900 border border-zinc-800 rounded-lg pl-10 pr-3 py-2.5 text-sm text-white outline-none focus:border-zinc-600 placeholder-zinc-600" oninput="applyFilters()">
                    </div>
                    <select id="status-filter" class="bg-zinc-900 border border-zinc-800 rounded-lg px-3 py-2.5 text-sm text-white outline-none focus:border-zinc-600" onchange="applyFilters()">
                        <option value="">Wszystkie statusy</option>
                        <option value="proposal">Propozycje</option>
                        <option value="approved">Zatwierdzone</option>
                        <option value="pending">Oczekujące</option>
                        <option value="in_production">W produkcji</option>
                        <option value="shipped">Wysłane</option>
                        <option value="delivered">Dostarczone</option>
                    </select>
                </div>

                <!-- Products Grid -->
                <div id="products-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-4">
                </div>

                <div id="empty-state" class="hidden py-16 text-center">
                    <i class="ph ph-package text-4xl text-zinc-700 mb-3"></i>
                    <p class="text-zinc-400 text-sm mb-1">Brak produktów</p>
                    <p class="text-zinc-600 text-xs font-mono">Dodaj produkty przyciskiem powyżej</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Product Modal -->
    <div id="product-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-zinc-950 border border-white/10 rounded-lg w-full max-w-xl shadow-2xl max-h-[90vh] flex flex-col">
            <div class="flex items-center justify-between px-5 py-4 border-b border-white/5 flex-shrink-0">
                <h2 id="product-modal-title" class="text-sm font-medium text-white flex items-center gap-2">
                    <i class="ph ph-package text-orange-400"></i>
                    Dodaj produkt
                </h2>
                <button onclick="closeProductModal()" class="text-zinc-500 hover:text-white transition-colors">
                    <i class="ph ph-x text-lg"></i>
                </button>
            </div>

            <div class="p-5 space-y-4 overflow-y-auto flex-1">
                <input type="hidden" id="product-edit-id">

                <div>
                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Nazwa produktu</label>
                    <input type="text" id="product-name" class="w-full text-sm text-white px-3 py-3 rounded-lg bg-zinc-900 border border-zinc-800 outline-none focus:border-zinc-600" placeholder="Nazwa produktu...">
                </div>
                <div>
                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Link źródłowy</label>
                    <input type="url" id="product-source-url" class="w-full text-sm text-white px-3 py-3 rounded-lg bg-zinc-900 border border-zinc-800 outline-none focus:border-zinc-600" placeholder="https://aliexpress.com/...">
                </div>
                <div>
                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Link do zdjęcia głównego</label>
                    <input type="url" id="product-image-url" class="w-full text-sm text-white px-3 py-3 rounded-lg bg-zinc-900 border border-zinc-800 outline-none focus:border-zinc-600" placeholder="https://...">
                    <div id="product-image-preview" class="mt-2 hidden">
                        <img id="product-image-preview-img" class="w-24 h-24 object-cover rounded-lg border border-zinc-800" src="">
                    </div>
                </div>
            </div>

            <div class="flex gap-3 px-5 py-4 border-t border-white/5 bg-zinc-900/50 flex-shrink-0">
                <div class="flex-1"></div>
                <button onclick="closeProductModal()" class="text-zinc-400 hover:text-white border border-zinc-700 hover:border-zinc-600 px-4 py-2 rounded-lg text-sm transition-colors">
                    Anuluj
                </button>
                <button onclick="saveProduct()" class="bg-white text-black hover:bg-zinc-200 px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                    Zapisz
                </button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://yxmavwkwnfuphjqbelws.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl4bWF2d2t3bmZ1cGhqcWJlbHdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NjQyNTUsImV4cCI6MjA4NDM0MDI1NX0.XeR0Fc7OFn6YbNJrOKTBEj36JtmLISZTM87y4ai9340';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        Sidebar.render();
        Sidebar.setupLogout(supabaseClient);

        let products = [];
        let filteredProducts = [];
        let currentMember = null;
        let isAdmin = false;
        let activeTab = 'active'; // 'active' or 'inactive'

        async function checkAuth() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
                window.location.href = Sidebar.getLoginPath();
                return null;
            }
            Sidebar.setUserEmail(session.user.email.split('@')[0]);
            await loadTeamMember(session.user.id);
            return session;
        }

        async function loadTeamMember(userId) {
            const { data } = await supabaseClient.from('team_members').select('*');
            const members = data || [];
            currentMember = members.find(m => m.user_id === userId);
            isAdmin = currentMember?.role === 'admin';
            if (currentMember) {
                Sidebar.setUserName(currentMember.name);
                Sidebar.setUserColor(currentMember.color);
                Sidebar.setupProfileClick();
            }
            Sidebar.showAdminNav(isAdmin);
        }

        async function loadProducts() {
            const { data, error } = await supabaseClient.from('workflow_products').select('*').is('workflow_id', null).order('created_at', { ascending: false });

            if (error) {
                console.error('Error loading products:', error);
                return;
            }

            products = data || [];

            applyFilters();
            renderProducts();
        }

        function applyFilters() {
            const search = document.getElementById('search-input').value.toLowerCase();
            const statusFilter = document.getElementById('status-filter').value;

            // Count active/inactive for tabs
            const activeCount = products.filter(p => p.is_active !== false).length;
            const inactiveCount = products.filter(p => p.is_active === false).length;
            document.getElementById('count-active').textContent = activeCount;
            document.getElementById('count-inactive').textContent = inactiveCount;

            filteredProducts = products.filter(p => {
                // Filter by active tab
                const isActive = p.is_active !== false;
                if (activeTab === 'active' && !isActive) return false;
                if (activeTab === 'inactive' && isActive) return false;

                if (search) {
                    const searchText = [p.name, p.description].filter(Boolean).join(' ').toLowerCase();
                    if (!searchText.includes(search)) return false;
                }
                if (statusFilter && p.status !== statusFilter) return false;
                return true;
            });

            document.getElementById('total-products').textContent = filteredProducts.length;
        }

        function setActiveTab(tab) {
            activeTab = tab;

            // Update tab styles
            const tabActive = document.getElementById('tab-active');
            const tabInactive = document.getElementById('tab-inactive');

            if (tab === 'active') {
                tabActive.classList.add('border-emerald-500', 'text-white');
                tabActive.classList.remove('border-transparent', 'text-zinc-500');
                tabInactive.classList.remove('border-amber-500', 'text-white');
                tabInactive.classList.add('border-transparent', 'text-zinc-500');
            } else {
                tabInactive.classList.add('border-amber-500', 'text-white');
                tabInactive.classList.remove('border-transparent', 'text-zinc-500');
                tabActive.classList.remove('border-emerald-500', 'text-white');
                tabActive.classList.add('border-transparent', 'text-zinc-500');
            }

            applyFilters();
            renderProducts();
        }

        async function toggleProductActive(id) {
            const product = products.find(p => p.id === id);
            if (!product) return;

            const newActiveState = product.is_active === false ? true : false;

            const { error } = await supabaseClient
                .from('workflow_products')
                .update({ is_active: newActiveState })
                .eq('id', id);

            if (error) {
                console.error('Error toggling product:', error);
                showToast('Błąd: ' + error.message, 'error');
                return;
            }

            product.is_active = newActiveState;
            applyFilters();
            renderProducts();
            showToast(newActiveState ? 'Produkt włączony' : 'Produkt wyłączony', 'success');
        }

        const statusLabels = {
            'proposal': { text: 'Propozycja', class: 'bg-cyan-500/20 text-cyan-400' },
            'approved': { text: 'Zatwierdzony', class: 'bg-emerald-500/20 text-emerald-400' },
            'pending': { text: 'Oczekuje', class: 'bg-amber-500/20 text-amber-400' },
            'in_production': { text: 'W produkcji', class: 'bg-blue-500/20 text-blue-400' },
            'shipped': { text: 'Wysłany', class: 'bg-violet-500/20 text-violet-400' },
            'delivered': { text: 'Dostarczony', class: 'bg-emerald-500/20 text-emerald-400' }
        };

        function renderProducts() {
            const grid = document.getElementById('products-grid');
            const emptyState = document.getElementById('empty-state');

            if (filteredProducts.length === 0) {
                grid.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');

            grid.innerHTML = filteredProducts.map(p => {
                const status = statusLabels[p.status] || statusLabels.proposal;
                const isActive = p.is_active !== false;

                return `
                    <div class="product-card bg-zinc-900/60 border border-white/5 rounded-xl overflow-hidden group transition-all ${!isActive ? 'opacity-60' : ''}">
                        <div class="relative aspect-square bg-zinc-800 overflow-hidden">
                            ${p.image_url
                                ? `<img src="${p.image_url}" alt="${p.name}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300 ${!isActive ? 'grayscale' : ''}" loading="lazy">`
                                : `<div class="w-full h-full flex items-center justify-center"><i class="ph ph-package text-4xl text-zinc-700"></i></div>`
                            }
                            <span class="absolute top-3 right-3 px-2 py-1 rounded-md text-[10px] font-medium ${status.class} backdrop-blur-sm">${status.text}</span>
                            ${!isActive ? `<span class="absolute top-3 left-3 px-2 py-1 rounded-md text-[10px] font-medium bg-zinc-800/90 text-zinc-400 backdrop-blur-sm"><i class="ph ph-eye-slash mr-1"></i>Wyłączony</span>` : ''}
                        </div>
                        <div class="p-4">
                            <h4 class="text-white font-medium text-sm leading-tight mb-2" style="display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;">${p.name}</h4>
                            <div class="flex items-center justify-between pt-2 border-t border-white/5">
                                <button onclick="toggleProductActive('${p.id}')" class="${isActive ? 'text-emerald-500 hover:text-emerald-400' : 'text-zinc-500 hover:text-emerald-400'} text-xs transition-colors" title="${isActive ? 'Wyłącz produkt' : 'Włącz produkt'}">
                                    <i class="ph ${isActive ? 'ph-toggle-right' : 'ph-toggle-left'} text-lg"></i>
                                </button>
                                <div class="flex items-center gap-2">
                                    ${p.source_url ? `<a href="${p.source_url}" target="_blank" class="text-orange-400 hover:text-orange-300 text-xs"><i class="ph ph-arrow-square-out"></i></a>` : ''}
                                    <button onclick="openAddProductModal('${p.id}')" class="text-zinc-500 hover:text-white text-xs transition-colors"><i class="ph ph-pencil-simple"></i></button>
                                    <button onclick="deleteProduct('${p.id}')" class="text-zinc-500 hover:text-red-400 text-xs transition-colors"><i class="ph ph-trash"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function openAddProductModal(editId) {
            const modal = document.getElementById('product-modal');
            const title = document.getElementById('product-modal-title');

            // Reset
            document.getElementById('product-edit-id').value = '';
            document.getElementById('product-name').value = '';
            document.getElementById('product-source-url').value = '';
            document.getElementById('product-image-url').value = '';
            updateImagePreview();

            if (editId) {
                const p = products.find(x => x.id === editId);
                if (p) {
                    title.innerHTML = '<i class="ph ph-pencil-simple text-orange-400"></i> Edytuj produkt';
                    document.getElementById('product-edit-id').value = p.id;
                    document.getElementById('product-name').value = p.name || '';
                    document.getElementById('product-source-url').value = p.source_url || '';
                    document.getElementById('product-image-url').value = p.image_url || '';
                    updateImagePreview();
                }
            } else {
                title.innerHTML = '<i class="ph ph-package text-orange-400"></i> Dodaj produkt';
            }

            modal.classList.remove('hidden');
        }

        function closeProductModal() {
            document.getElementById('product-modal').classList.add('hidden');
        }

        function updateImagePreview() {
            const url = document.getElementById('product-image-url').value.trim();
            const preview = document.getElementById('product-image-preview');
            const img = document.getElementById('product-image-preview-img');
            if (url) {
                img.src = url;
                preview.classList.remove('hidden');
            } else {
                preview.classList.add('hidden');
                img.src = '';
            }
        }

        // Live preview on image URL change
        document.addEventListener('DOMContentLoaded', () => {
            const imgInput = document.getElementById('product-image-url');
            if (imgInput) imgInput.addEventListener('input', updateImagePreview);
        });

        async function saveProduct() {
            const id = document.getElementById('product-edit-id').value;
            const name = document.getElementById('product-name').value.trim();

            if (!name) { showToast('Podaj nazwę produktu', 'error'); return; }

            const payload = {
                workflow_id: null,
                name,
                image_url: document.getElementById('product-image-url').value.trim() || null,
                source_url: document.getElementById('product-source-url').value.trim() || null,
                visible_to_client: true,
            };

            if (!id) payload.status = 'proposal';

            let error;
            if (id) {
                ({ error } = await supabaseClient.from('workflow_products').update(payload).eq('id', id));
            } else {
                const res = await supabaseClient.from('workflow_products').insert(payload).select('id').single();
                error = res.error;
            }

            if (error) {
                console.error('Error saving product:', error);
                showToast('Błąd zapisu: ' + error.message, 'error');
                return;
            }

            closeProductModal();
            showToast(id ? 'Produkt zaktualizowany' : 'Produkt dodany', 'success');
            await loadProducts();
        }

        async function deleteProduct(id) {
            if (!confirm('Usunąć ten produkt?')) return;

            const { error } = await supabaseClient.from('workflow_products').delete().eq('id', id);
            if (!error) {
                products = products.filter(p => p.id !== id);
                applyFilters();
                renderProducts();
                showToast('Produkt usunięty', 'success');
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            const bg = type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6';
            toast.style.cssText = `position:fixed;top:20px;right:20px;z-index:9999;background:${bg};color:#fff;padding:12px 20px;border-radius:8px;font:14px/1 sans-serif;box-shadow:0 4px 12px rgba(0,0,0,.3);transition:opacity 0.3s`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 2500);
        }

        async function init() {
            const session = await checkAuth();
            if (session) {
                await loadProducts();
            }
        }
        init();

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').catch(() => {});
        }
    </script>
</body>
</html>
