<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TN CRM - Projekty</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#050505">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="../components/shared-sidebar.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    }
                }
            }
        }
    </script>
    <style>
        body { background: #000; color: #e5e5e5; }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        ::selection { background: white; color: black; }

        .glass-header {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-enter { animation: fadeIn 0.4s ease-out forwards; }

        .progress-bar {
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
            transition: width 0.5s ease;
        }

        .workflow-card {
            transition: all 0.2s ease;
        }
        .workflow-card:hover {
            border-color: rgba(255,255,255,0.15);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
        }

        /* Stage timeline connector animation */
        .workflow-card:hover .progress-bar {
            background: linear-gradient(90deg, #10b981 0%, #34d399 100%);
        }

        /* Logo hover zoom */
        .workflow-logo {
            transition: transform 0.2s ease;
            cursor: zoom-in;
        }
        .workflow-logo:hover {
            transform: scale(3);
            z-index: 50;
            position: relative;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body class="h-screen flex overflow-hidden font-sans text-sm tracking-tight antialiased">

    <!-- Sidebar -->
    <aside id="sidebar" class="w-[280px] bg-zinc-950 border-r border-white/5 flex flex-col flex-shrink-0"></aside>

    <!-- Main -->
    <main class="flex-1 flex flex-col bg-black relative min-w-0">
        <!-- Header -->
        <header class="h-16 glass-header flex items-center justify-between px-4 md:px-6 sticky top-0 z-30">
            <div class="flex items-center gap-3">
                <button onclick="Sidebar.toggle()" class="mobile-menu-btn hidden items-center justify-center w-9 h-9 rounded-lg hover:bg-white/5 text-zinc-400 hover:text-white transition-colors">
                    <i class="ph ph-list text-xl"></i>
                </button>
                <div class="flex items-center gap-2 text-zinc-500">
                    <span class="text-zinc-400 hidden sm:inline">tn-crm</span>
                    <span class="text-zinc-700 hidden sm:inline">/</span>
                    <span class="text-white font-medium">projekty</span>
                </div>
            </div>
            <div class="flex items-center gap-2 md:gap-3">
                <a href="https://crm.tomekniedzwiecki.pl/orders" class="text-zinc-400 hover:text-white border border-zinc-700 hover:border-zinc-600 px-3 md:px-4 py-2 rounded-lg text-sm transition-colors flex items-center gap-1.5">
                    <i class="ph ph-shopping-cart"></i>
                    <span class="hidden md:inline">Zamowienia</span>
                </a>
                <button onclick="openAddModal()" class="bg-white text-black hover:bg-zinc-200 px-3 md:px-4 py-2 rounded-lg font-medium text-sm transition-colors shadow-[0_0_15px_rgba(255,255,255,0.1)] flex items-center gap-1.5">
                    <i class="ph ph-plus"></i>
                    <span class="hidden md:inline">Dodaj</span>
                </button>
            </div>
        </header>

        <!-- Content -->
        <div class="flex-1 overflow-y-auto p-6 lg:p-10">
            <div class="max-w-7xl mx-auto animate-enter">
                <!-- Title & Stats -->
                <div class="flex items-start justify-between mb-6">
                    <div>
                        <h1 class="text-3xl font-semibold text-white tracking-tight mb-1">Projekty</h1>
                        <p class="text-zinc-500">Zarzadzaj projektami klientow po oplaceniu zamowienia.</p>
                    </div>
                    <div class="text-right">
                        <div class="text-3xl font-semibold text-white" id="total-active">-</div>
                        <div class="text-zinc-500 text-xs font-mono">aktywnych</div>
                    </div>
                </div>

                <!-- Recent Admin Activity (collapsible) -->
                <div id="activity-section" class="mb-6 hidden">
                    <button onclick="toggleActivityPanel()" class="flex items-center gap-2 text-sm text-zinc-400 hover:text-white transition-colors mb-3">
                        <i id="activity-toggle-icon" class="ph ph-caret-right text-xs transition-transform"></i>
                        <span>Ostatnie działania</span>
                        <span id="activity-count" class="text-xs text-zinc-600 font-mono">(0)</span>
                    </button>
                    <div id="activity-panel" class="hidden pl-4 border-l border-zinc-800">
                        <div id="activity-list" class="space-y-2 max-h-48 overflow-y-auto pr-2">
                            <!-- Activities will be rendered here -->
                        </div>
                    </div>
                </div>

                <!-- Filters -->
                <div class="flex flex-wrap items-center gap-3 mb-6">
                    <div class="relative flex-1 min-w-[200px] max-w-xs">
                        <i class="ph ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-zinc-500"></i>
                        <input type="text" id="search-input" placeholder="Szukaj klienta lub ID projektu..." class="w-full bg-zinc-900 border border-zinc-800 rounded-lg pl-9 pr-3 py-2.5 text-sm text-white outline-none focus:border-zinc-600 transition-colors">
                    </div>
                    <select id="status-filter" class="bg-zinc-900 border border-zinc-800 rounded-lg px-3 py-2.5 text-sm text-white outline-none focus:border-zinc-600">
                        <option value="">Wszystkie statusy</option>
                        <option value="active" selected>Aktywne</option>
                        <option value="completed">Ukonczone</option>
                        <option value="paused">Wstrzymane</option>
                        <option value="cancelled">Anulowane</option>
                    </select>
                    <select id="offer-filter" class="bg-zinc-900 border border-zinc-800 rounded-lg px-3 py-2.5 text-sm text-white outline-none focus:border-zinc-600">
                        <option value="">Wszystkie oferty</option>
                    </select>
                    <select id="sort-filter" class="bg-zinc-900 border border-zinc-800 rounded-lg px-3 py-2.5 text-sm text-white outline-none focus:border-zinc-600">
                        <option value="deadline_asc">Deadline (blisko)</option>
                        <option value="created_desc">Najnowsze</option>
                        <option value="created_asc">Najstarsze</option>
                        <option value="progress_desc">Postep (malejaco)</option>
                        <option value="progress_asc">Postep (rosnaco)</option>
                    </select>
                </div>

                <!-- Stage Filter (milestone numbers) -->
                <div id="stage-filter-wrapper" class="flex items-center gap-3 mb-6 hidden">
                    <span class="text-zinc-500 text-xs font-mono uppercase tracking-wider">Etap</span>
                    <div id="stage-filter" class="flex flex-wrap items-center gap-1.5"></div>
                </div>

                <!-- Status Stage Filter (brak etapu) -->
                <div class="flex flex-wrap items-center gap-3 mb-6">
                    <span class="text-zinc-500 text-xs font-mono uppercase tracking-wider">Brak</span>
                    <div id="status-stage-filter" class="flex flex-wrap items-center gap-1.5">
                        <button onclick="toggleStatusStage('contract')" data-stage="contract"
                            class="status-stage-btn text-xs px-2.5 py-1 rounded-md border font-medium transition-all cursor-pointer text-zinc-600 border-zinc-800 hover:text-zinc-400 hover:border-zinc-600 flex items-center gap-1">
                            <i class="ph ph-file-text"></i> Umowa
                        </button>
                        <button onclick="toggleStatusStage('product')" data-stage="product"
                            class="status-stage-btn text-xs px-2.5 py-1 rounded-md border font-medium transition-all cursor-pointer text-zinc-600 border-zinc-800 hover:text-zinc-400 hover:border-zinc-600 flex items-center gap-1">
                            <i class="ph ph-package"></i> Produkt
                        </button>
                        <button onclick="toggleStatusStage('report')" data-stage="report"
                            class="status-stage-btn text-xs px-2.5 py-1 rounded-md border font-medium transition-all cursor-pointer text-zinc-600 border-zinc-800 hover:text-zinc-400 hover:border-zinc-600 flex items-center gap-1">
                            <i class="ph ph-chart-bar"></i> Raport
                        </button>
                        <button onclick="toggleStatusStage('branding')" data-stage="branding"
                            class="status-stage-btn text-xs px-2.5 py-1 rounded-md border font-medium transition-all cursor-pointer text-zinc-600 border-zinc-800 hover:text-zinc-400 hover:border-zinc-600 flex items-center gap-1">
                            <i class="ph ph-paint-brush"></i> Branding
                        </button>
                        <button onclick="toggleStatusStage('salespage')" data-stage="salespage"
                            class="status-stage-btn text-xs px-2.5 py-1 rounded-md border font-medium transition-all cursor-pointer text-zinc-600 border-zinc-800 hover:text-zinc-400 hover:border-zinc-600 flex items-center gap-1">
                            <i class="ph ph-browser"></i> Strona
                        </button>
                    </div>
                </div>

                <!-- Workflows Grid -->
                <div id="workflows-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-3">
                    <!-- Workflows will be rendered here -->
                </div>

                <div id="empty-state" class="hidden py-16 text-center">
                    <i class="ph ph-kanban text-4xl text-zinc-700 mb-3"></i>
                    <p class="text-zinc-400 text-sm mb-1">Brak projektow</p>
                    <p class="text-zinc-600 text-xs font-mono">Projekty tworza sie automatycznie po oplaceniu zamowienia</p>
                </div>

                <div id="loading-state" class="py-16 text-center">
                    <div class="w-5 h-5 mx-auto mb-3 border-2 border-zinc-700 border-t-white rounded-full animate-spin"></div>
                    <p class="text-zinc-500 text-sm font-mono">Ladowanie...</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Add Workflow Modal -->
    <div id="add-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-zinc-950 border border-white/10 rounded-lg w-full max-w-md shadow-2xl">
            <div class="flex items-center justify-between px-5 py-4 border-b border-white/5">
                <h2 class="text-sm font-medium text-white flex items-center gap-2">
                    <i class="ph ph-plus-circle text-emerald-400"></i>
                    Dodaj projekt recznie
                </h2>
                <button onclick="closeAddModal()" class="text-zinc-500 hover:text-white transition-colors">
                    <i class="ph ph-x text-lg"></i>
                </button>
            </div>

            <div class="p-5 space-y-4">
                <p class="text-zinc-400 text-sm">Wprowadz numer zamowienia, aby utworzyc projekt. Zamowienie musi miec status "paid".</p>

                <div>
                    <label class="block text-zinc-500 text-[10px] font-mono uppercase tracking-wider mb-1.5">Numer zamowienia</label>
                    <input type="text" id="order-number-input" class="w-full text-sm text-white bg-zinc-900 border border-zinc-800 px-3 py-3 rounded-lg outline-none focus:border-zinc-600" placeholder="ORD-202601-0001">
                </div>

                <div id="order-preview" class="hidden bg-zinc-900/50 border border-white/5 rounded-lg p-4">
                    <div class="text-xs text-zinc-500 uppercase tracking-wider mb-2">Podglad zamowienia</div>
                    <div class="space-y-1 text-sm">
                        <div><span class="text-zinc-500">Klient:</span> <span id="preview-customer" class="text-white">-</span></div>
                        <div><span class="text-zinc-500">Oferta:</span> <span id="preview-offer" class="text-zinc-300">-</span></div>
                        <div><span class="text-zinc-500">Kwota:</span> <span id="preview-amount" class="text-white font-mono">-</span></div>
                        <div><span class="text-zinc-500">Status:</span> <span id="preview-status" class="text-emerald-400">-</span></div>
                    </div>
                </div>

                <div id="add-error" class="hidden text-red-400 text-sm"></div>
            </div>

            <div class="flex gap-3 px-5 py-4 border-t border-white/5 bg-zinc-900/50">
                <button onclick="searchOrder()" id="search-btn" class="text-zinc-400 hover:text-white border border-zinc-700 hover:border-zinc-600 px-4 py-2 rounded-lg text-sm transition-colors flex items-center gap-2">
                    <i class="ph ph-magnifying-glass"></i>
                    Szukaj
                </button>
                <div class="flex-1"></div>
                <button onclick="closeAddModal()" class="text-zinc-400 hover:text-white border border-zinc-700 hover:border-zinc-600 px-4 py-2 rounded-lg text-sm transition-colors">
                    Anuluj
                </button>
                <button onclick="createWorkflowFromOrder()" id="create-btn" disabled class="bg-white text-black hover:bg-zinc-200 disabled:bg-zinc-700 disabled:text-zinc-500 px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                    Utworz projekt
                </button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-zinc-950 border border-white/10 rounded-lg w-full max-w-sm shadow-2xl">
            <div class="flex items-center justify-between px-5 py-4 border-b border-white/5">
                <h2 class="text-sm font-medium text-white flex items-center gap-2">
                    <i class="ph ph-warning text-red-400"></i>
                    Usun projekt
                </h2>
                <button onclick="closeDeleteModal()" class="text-zinc-500 hover:text-white transition-colors">
                    <i class="ph ph-x text-lg"></i>
                </button>
            </div>

            <div class="p-5">
                <p class="text-zinc-400 text-sm mb-2">Czy na pewno chcesz usunac projekt?</p>
                <p class="text-white font-medium" id="delete-customer-name">-</p>
                <p class="text-red-400 text-xs mt-3">Ta operacja jest nieodwracalna. Wszystkie dane projektu zostana usuniete.</p>
            </div>

            <div class="flex gap-3 px-5 py-4 border-t border-white/5 bg-zinc-900/50">
                <button onclick="closeDeleteModal()" class="flex-1 text-zinc-400 hover:text-white border border-zinc-700 hover:border-zinc-600 px-4 py-2 rounded-lg text-sm transition-colors">
                    Anuluj
                </button>
                <button onclick="confirmDeleteWorkflow()" id="confirm-delete-btn" class="flex-1 bg-red-500 text-white hover:bg-red-600 px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center justify-center gap-2">
                    <i class="ph ph-trash"></i>
                    Usun
                </button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://yxmavwkwnfuphjqbelws.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl4bWF2d2t3bmZ1cGhqcWJlbHdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NjQyNTUsImV4cCI6MjA4NDM0MDI1NX0.XeR0Fc7OFn6YbNJrOKTBEj36JtmLISZTM87y4ai9340';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        Sidebar.render();
        Sidebar.setupLogout(supabaseClient);

        let workflows = [];
        let filteredWorkflows = [];
        let selectedStages = new Set();
        let stagesInitialized = false;
        let workflowLogos = {};
        let selectedStatusStages = new Set(); // For filtering by missing status stages

        let teamMembers = [];
        let currentMember = null;
        let isAdmin = false;

        async function checkAuth() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
                window.location.href = Sidebar.getLoginPath();
                return null;
            }
            Sidebar.setUserEmail(session.user.email.split('@')[0]);
            await loadTeamMembers(session.user.id);
            return session;
        }

        async function loadTeamMembers(userId) {
            const { data, error } = await supabaseClient
                .from('team_members')
                .select('*');

            if (error) {
                console.error('Error loading team members:', error);
                return;
            }

            teamMembers = data || [];
            currentMember = teamMembers.find(m => m.user_id === userId);
            isAdmin = currentMember?.role === 'admin';

            if (currentMember) {
                Sidebar.setUserName(currentMember.name);
                Sidebar.setUserColor(currentMember.color);
                Sidebar.setupProfileClick();
            }

            Sidebar.showAdminNav(isAdmin);
        }

        async function loadWorkflows() {
            // Load workflows with progress data using the view
            // Order by starred first, then by started_at
            const { data, error } = await supabaseClient
                .from('workflow_progress')
                .select('*')
                .order('starred', { ascending: false, nullsFirst: false })
                .order('started_at', { ascending: false });

            if (error) {
                console.error('Error loading workflows:', error);
                // Fallback: load from workflows table directly
                const { data: fallbackData, error: fallbackError } = await supabaseClient
                    .from('workflows')
                    .select(`
                        *,
                        workflow_milestones (
                            id,
                            milestone_index,
                            title,
                            status,
                            deadline
                        ),
                        workflow_tasks (
                            id,
                            milestone_id,
                            title,
                            completed
                        )
                    `)
                    .order('created_at', { ascending: false });

                if (fallbackError) {
                    console.error('Fallback error:', fallbackError);
                    document.getElementById('loading-state').classList.add('hidden');
                    document.getElementById('empty-state').classList.remove('hidden');
                    return;
                }

                // Calculate progress manually
                workflows = (fallbackData || []).map(w => {
                    const totalTasks = w.workflow_tasks?.length || 0;
                    const completedTasks = w.workflow_tasks?.filter(t => t.completed).length || 0;
                    const currentMilestone = w.workflow_milestones?.find(m => m.status === 'in_progress');
                    const totalMilestones = w.workflow_milestones?.length || 0;
                    const completedMilestones = w.workflow_milestones?.filter(m => m.status === 'completed').length || 0;

                    // Get tasks for current milestone
                    let currentMilestoneTasks = [];
                    if (currentMilestone) {
                        currentMilestoneTasks = (w.workflow_tasks || [])
                            .filter(t => t.milestone_id === currentMilestone.id)
                            .map(t => ({ title: t.title, completed: t.completed }));
                    }

                    return {
                        workflow_id: w.id,
                        customer_email: w.customer_email,
                        customer_name: w.customer_name,
                        customer_company: w.customer_company,
                        offer_name: w.offer_name,
                        amount: w.amount,
                        status: w.status,
                        started_at: w.started_at,
                        unique_token: w.unique_token,
                        contract_status: w.contract_status,
                        products_shared_at: w.products_shared_at,
                        branding_shared_at: w.branding_shared_at,
                        sales_page_shared_at: w.sales_page_shared_at,
                        sales_page_url: w.sales_page_url,
                        selected_product_id: w.selected_product_id,
                        total_tasks: totalTasks,
                        completed_tasks: completedTasks,
                        progress_percent: totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0,
                        current_milestone_title: currentMilestone?.title,
                        current_milestone_deadline: currentMilestone?.deadline,
                        current_milestone_tasks: currentMilestoneTasks,
                        total_milestones: totalMilestones,
                        completed_milestones: completedMilestones
                    };
                });
            } else {
                workflows = data || [];
            }

            await Promise.all([loadUnreadComments(), loadReportCounts(), loadWorkflowLogos(), loadCurrentMilestoneTasks(), loadStageData()]);
            populateOfferFilter();
            renderStageFilter();
            applyFilters();
            renderWorkflows();
        }

        function populateOfferFilter() {
            // Get unique offer names from workflows
            const offerNames = [...new Set(workflows.map(w => w.offer_name))].sort();

            const select = document.getElementById('offer-filter');
            select.innerHTML = '<option value="">Wszystkie oferty</option>';

            offerNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                select.appendChild(option);
            });
        }

        let unreadCounts = {};
        let reportCounts = {};

        async function loadUnreadComments() {
            const { data: comments, error } = await supabaseClient
                .from('workflow_comments')
                .select('workflow_id, created_at')
                .eq('author_type', 'client')
                .order('created_at', { ascending: false });

            if (error || !comments) return;

            unreadCounts = {};
            for (const c of comments) {
                const lastSeen = localStorage.getItem(`admin_comments_last_seen_${c.workflow_id}`);
                const lastSeenDate = lastSeen ? new Date(lastSeen) : new Date(0);
                if (new Date(c.created_at) > lastSeenDate) {
                    unreadCounts[c.workflow_id] = (unreadCounts[c.workflow_id] || 0) + 1;
                }
            }
        }

        async function loadReportCounts() {
            const { data, error } = await supabaseClient
                .from('workflow_reports')
                .select('workflow_id, visible_to_client, type')
                .in('type', ['report_pdf', 'report_infographic', 'report_presentation']);

            if (error || !data) return;

            reportCounts = {};
            for (const r of data) {
                if (!reportCounts[r.workflow_id]) reportCounts[r.workflow_id] = { total: 0, published: 0 };
                reportCounts[r.workflow_id].total++;
                if (r.visible_to_client) reportCounts[r.workflow_id].published++;
            }
        }

        async function loadWorkflowLogos() {
            const { data, error } = await supabaseClient
                .from('workflow_branding')
                .select('workflow_id, file_url, notes')
                .eq('type', 'logo');

            if (error || !data) return;

            workflowLogos = {};
            for (const item of data) {
                if (!workflowLogos[item.workflow_id]) {
                    workflowLogos[item.workflow_id] = item.file_url;
                }
                try {
                    const meta = item.notes ? JSON.parse(item.notes) : {};
                    if (meta.variant === 'main') {
                        workflowLogos[item.workflow_id] = item.file_url;
                    }
                } catch (e) {}
            }
        }

        async function loadCurrentMilestoneTasks() {
            // Skip if tasks already loaded (fallback case)
            if (workflows.length > 0 && workflows[0].current_milestone_tasks) return;

            const workflowIds = workflows.map(w => w.workflow_id);
            if (workflowIds.length === 0) return;

            // Get current milestones (in_progress status)
            const { data: milestones, error: mErr } = await supabaseClient
                .from('workflow_milestones')
                .select('id, workflow_id')
                .in('workflow_id', workflowIds)
                .eq('status', 'in_progress');

            if (mErr || !milestones) return;

            const milestoneMap = {};
            const milestoneIds = [];
            for (const m of milestones) {
                milestoneMap[m.workflow_id] = m.id;
                milestoneIds.push(m.id);
            }

            if (milestoneIds.length === 0) return;

            // Get tasks for those milestones
            const { data: tasks, error: tErr } = await supabaseClient
                .from('workflow_tasks')
                .select('milestone_id, title, completed')
                .in('milestone_id', milestoneIds);

            if (tErr || !tasks) return;

            // Group tasks by milestone
            const tasksByMilestone = {};
            for (const t of tasks) {
                if (!tasksByMilestone[t.milestone_id]) {
                    tasksByMilestone[t.milestone_id] = [];
                }
                tasksByMilestone[t.milestone_id].push({ title: t.title, completed: t.completed });
            }

            // Attach to workflows
            for (const w of workflows) {
                const milestoneId = milestoneMap[w.workflow_id];
                w.current_milestone_tasks = milestoneId ? (tasksByMilestone[milestoneId] || []) : [];
            }
        }

        let videoStages = {};
        let takedropStages = {};

        async function loadStageData() {
            const workflowIds = workflows.map(w => w.workflow_id);
            if (workflowIds.length === 0) return;

            const [videoRes, takedropRes] = await Promise.all([
                supabaseClient.from('workflow_video').select('workflow_id, is_active, stage_accepted, video_shared').in('workflow_id', workflowIds),
                supabaseClient.from('workflow_takedrop').select('workflow_id, is_active, stage_accepted').in('workflow_id', workflowIds)
            ]);

            videoStages = {};
            takedropStages = {};

            (videoRes.data || []).forEach(v => {
                videoStages[v.workflow_id] = v;
            });

            (takedropRes.data || []).forEach(t => {
                takedropStages[t.workflow_id] = t;
            });

            // Attach stage info to workflows
            for (const w of workflows) {
                w.video_stage = videoStages[w.workflow_id] || null;
                w.takedrop_stage = takedropStages[w.workflow_id] || null;
            }
        }

        function getWorkflowStage(w) {
            // Returns: 1 = Stage 1 (milestones), 2 = Video, 3 = TakeDrop
            if (w.takedrop_stage?.is_active) return 3;
            if (w.video_stage?.is_active) return 2;
            return 1;
        }

        function isStage1Completed(w) {
            // Stage 1 is completed if all milestones are done (or video is active)
            return w.video_stage?.is_active || (w.total_milestones > 0 && w.completed_milestones >= w.total_milestones);
        }

        function applyFilters() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const statusFilter = document.getElementById('status-filter').value;
            const offerFilter = document.getElementById('offer-filter').value;
            const sortFilter = document.getElementById('sort-filter').value;

            filteredWorkflows = workflows.filter(w => {
                // Search filter (name, company, email, offer, or workflow ID)
                const searchMatch = !searchTerm ||
                    (w.customer_name || '').toLowerCase().includes(searchTerm) ||
                    (w.customer_company || '').toLowerCase().includes(searchTerm) ||
                    w.customer_email.toLowerCase().includes(searchTerm) ||
                    w.offer_name.toLowerCase().includes(searchTerm) ||
                    w.workflow_id.toLowerCase().includes(searchTerm);

                // Status filter
                const statusMatch = !statusFilter || w.status === statusFilter;

                // Offer filter
                const offerMatch = !offerFilter || w.offer_name === offerFilter;

                // Stage filter
                const currentStage = getCurrentStage(w);
                const stageMatch = currentStage === 0 || selectedStages.size === 0 || selectedStages.has(currentStage);

                // Status stage filter (show only those MISSING selected stages)
                let statusStageMatch = true;
                if (selectedStatusStages.size > 0) {
                    for (const stage of selectedStatusStages) {
                        if (hasStatusStage(w, stage)) {
                            statusStageMatch = false;
                            break;
                        }
                    }
                }

                return searchMatch && statusMatch && offerMatch && stageMatch && statusStageMatch;
            });

            // Sort - starred first, then active projects, then waiting_for_client at end
            filteredWorkflows.sort((a, b) => {
                // Starred items always come first
                if (a.starred && !b.starred) return -1;
                if (!a.starred && b.starred) return 1;

                // Waiting for client goes to the end (unless starred)
                const aWaiting = a.waiting_for_client === true;
                const bWaiting = b.waiting_for_client === true;
                if (aWaiting && !bWaiting) return 1;
                if (!aWaiting && bWaiting) return -1;

                // Then apply secondary sort
                switch (sortFilter) {
                    case 'created_asc':
                        return new Date(a.started_at) - new Date(b.started_at);
                    case 'deadline_asc':
                        if (!a.current_milestone_deadline) return 1;
                        if (!b.current_milestone_deadline) return -1;
                        return new Date(a.current_milestone_deadline) - new Date(b.current_milestone_deadline);
                    case 'progress_desc':
                        return b.progress_percent - a.progress_percent;
                    case 'progress_asc':
                        return a.progress_percent - b.progress_percent;
                    default: // created_desc (newest first)
                        return new Date(b.started_at) - new Date(a.started_at);
                }
            });

            // Update active count
            const activeCount = workflows.filter(w => w.status === 'active').length;
            document.getElementById('total-active').textContent = activeCount;
        }

        function getCurrentStage(w) {
            if (!w.total_milestones || w.total_milestones === 0) return 0;
            if (w.status === 'completed') return w.total_milestones;
            return Math.min((w.completed_milestones || 0) + 1, w.total_milestones);
        }

        function renderStageFilter() {
            let maxStage = 0;
            for (const w of workflows) {
                maxStage = Math.max(maxStage, w.total_milestones || 0);
            }
            if (maxStage === 0) {
                document.getElementById('stage-filter-wrapper').classList.add('hidden');
                return;
            }
            if (!stagesInitialized) {
                for (let i = 1; i <= maxStage; i++) selectedStages.add(i);
                stagesInitialized = true;
            }
            document.getElementById('stage-filter-wrapper').classList.remove('hidden');
            const container = document.getElementById('stage-filter');
            let html = '';
            for (let stage = 1; stage <= maxStage; stage++) {
                const isActive = selectedStages.has(stage);
                html += `<button onclick="toggleStage(${stage})" data-stage="${stage}"
                    class="text-xs px-2.5 py-1 rounded-md border font-medium transition-all cursor-pointer ${
                        isActive
                            ? 'bg-white/10 text-white border-white/20'
                            : 'text-zinc-600 border-zinc-800 hover:text-zinc-400 hover:border-zinc-600'
                    }">${stage}</button>`;
            }
            container.innerHTML = html;
        }

        function toggleStage(stage) {
            if (selectedStages.has(stage)) {
                selectedStages.delete(stage);
            } else {
                selectedStages.add(stage);
            }
            renderStageFilter();
            applyFilters();
            renderWorkflows();
        }

        function toggleStatusStage(stage) {
            if (selectedStatusStages.has(stage)) {
                selectedStatusStages.delete(stage);
            } else {
                selectedStatusStages.add(stage);
            }
            renderStatusStageFilter();
            applyFilters();
            renderWorkflows();
        }

        function renderStatusStageFilter() {
            const buttons = document.querySelectorAll('.status-stage-btn');
            buttons.forEach(btn => {
                const stage = btn.dataset.stage;
                const isActive = selectedStatusStages.has(stage);
                if (isActive) {
                    btn.classList.remove('text-zinc-600', 'border-zinc-800');
                    btn.classList.add('bg-amber-500/20', 'text-amber-400', 'border-amber-500/30');
                } else {
                    btn.classList.remove('bg-amber-500/20', 'text-amber-400', 'border-amber-500/30');
                    btn.classList.add('text-zinc-600', 'border-zinc-800');
                }
            });
        }

        function hasStatusStage(w, stage) {
            switch (stage) {
                case 'contract':
                    return w.contract_status === 'signed';
                case 'product':
                    return !!w.selected_product_id;
                case 'report':
                    const rc = reportCounts[w.workflow_id];
                    return rc && rc.published > 0;
                case 'branding':
                    return !!w.branding_shared_at;
                case 'salespage':
                    return !!w.sales_page_shared_at;
                default:
                    return false;
            }
        }

        function getWorkflowPath(id) {
            const base = Sidebar.getBasePath();
            const basePath = (location.hostname === 'localhost' || location.hostname === '127.0.0.1')
                ? `${base}/tn-workflow/workflow.html` : '/tn-workflow/workflow';
            return `${basePath}?id=${id}`;
        }

        function getClientUrl(token) {
            return `https://crm.tomekniedzwiecki.pl/projekt/${token}`;
        }

        function getStatusBadge(status) {
            const styles = {
                active: 'bg-emerald-500/10 text-emerald-400 border-emerald-500/20',
                completed: 'bg-blue-500/10 text-blue-400 border-blue-500/20',
                paused: 'bg-amber-500/10 text-amber-400 border-amber-500/20',
                cancelled: 'bg-red-500/10 text-red-400 border-red-500/20'
            };
            const labels = {
                active: 'Aktywny',
                completed: 'Ukonczony',
                paused: 'Wstrzymany',
                cancelled: 'Anulowany'
            };
            return `<span class="text-xs px-2 py-0.5 rounded border ${styles[status] || styles.active}">${labels[status] || status}</span>`;
        }

        function getStatusChecklist(w) {
            // Unified checklist for all stages - shows completion status
            const items = [];

            // Contract - skip for Starter offer (no contract required)
            const isStarter = w.offer_name?.toLowerCase().includes('starter');
            if (!isStarter) {
                const contractDone = w.contract_status === 'signed';
                const contractInProgress = w.contract_status && !['pending_data', 'signed'].includes(w.contract_status);
                if (contractDone) {
                    items.push(`<span class="flex items-center gap-1 text-emerald-400"><i class="ph-fill ph-check-circle text-[10px]"></i>Umowa</span>`);
                } else if (contractInProgress) {
                    items.push(`<span class="flex items-center gap-1 text-amber-400"><i class="ph ph-circle-notch text-[10px]"></i>Umowa</span>`);
                }
            }

            // Product selection
            if (w.selected_product_id) {
                items.push(`<span class="flex items-center gap-1 text-emerald-400"><i class="ph-fill ph-check-circle text-[10px]"></i>Produkt</span>`);
            } else if (w.products_shared_at) {
                items.push(`<span class="flex items-center gap-1 text-amber-400"><i class="ph ph-circle-notch text-[10px]"></i>Produkt</span>`);
            }

            // Report
            const rc = reportCounts[w.workflow_id];
            if (rc && rc.published > 0) {
                items.push(`<span class="flex items-center gap-1 text-emerald-400"><i class="ph-fill ph-check-circle text-[10px]"></i>Raport</span>`);
            } else if (rc && rc.total > 0) {
                items.push(`<span class="flex items-center gap-1 text-amber-400"><i class="ph ph-circle-notch text-[10px]"></i>Raport</span>`);
            }

            // Branding
            if (w.branding_shared_at) {
                items.push(`<span class="flex items-center gap-1 text-emerald-400"><i class="ph-fill ph-check-circle text-[10px]"></i>Branding</span>`);
            }

            // Sales page
            if (w.sales_page_shared_at) {
                items.push(`<span class="flex items-center gap-1 text-emerald-400"><i class="ph-fill ph-check-circle text-[10px]"></i>Strona</span>`);
            }

            if (!items.length) return '';
            return `<div class="flex items-center gap-3 text-[10px] py-2 border-t border-white/5">${items.join('')}</div>`;
        }

        function formatDeadline(deadline) {
            if (!deadline) return '';
            const date = new Date(deadline);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const deadlineDate = new Date(deadline);
            deadlineDate.setHours(0, 0, 0, 0);

            const diffDays = Math.ceil((deadlineDate - today) / (1000 * 60 * 60 * 24));

            let color = 'text-zinc-400';
            let label = '';

            if (diffDays < 0) {
                color = 'text-red-400';
                label = `${Math.abs(diffDays)} dni temu`;
            } else if (diffDays === 0) {
                color = 'text-amber-400';
                label = 'dzisiaj';
            } else if (diffDays <= 3) {
                color = 'text-amber-400';
                label = `za ${diffDays} dni`;
            } else {
                label = date.toLocaleDateString('pl-PL', { day: 'numeric', month: 'short' });
            }

            return `<span class="${color}">${label}</span>`;
        }

        function formatLastActivity(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'przed chwilą';
            if (diffMins < 60) return `${diffMins} min`;
            if (diffHours < 24) return `${diffHours}h temu`;
            if (diffDays < 7) return `${diffDays}d temu`;
            return date.toLocaleDateString('pl-PL', { day: 'numeric', month: 'short' });
        }

        function renderStageTimeline(w) {
            const currentStage = getWorkflowStage(w);
            const stage1Complete = isStage1Completed(w);

            // Stage 1 status
            let s1Class = 'bg-zinc-700';
            let s1Label = 'Etap 1';
            if (currentStage === 1) {
                s1Class = 'bg-amber-500';
            } else if (stage1Complete) {
                s1Class = 'bg-emerald-500';
            }

            // Stage 2 status
            let s2Class = 'bg-zinc-700';
            let s2Label = 'Etap 2';
            const hasVideo = w.video_stage?.is_active;
            if (currentStage === 2) {
                s2Class = 'bg-amber-500';
            } else if (currentStage === 3 || (hasVideo && w.video_stage?.video_shared)) {
                s2Class = 'bg-emerald-500';
            }

            // Stage 3 status
            let s3Class = 'bg-zinc-700';
            let s3Label = 'Etap 3';
            const hasTakedrop = w.takedrop_stage?.is_active;
            if (currentStage === 3) {
                s3Class = hasTakedrop && w.takedrop_stage?.stage_accepted ? 'bg-emerald-500' : 'bg-amber-500';
            }

            // Line between stages
            const line1Class = stage1Complete ? 'bg-emerald-500/50' : 'bg-zinc-700';
            const line2Class = currentStage === 3 ? 'bg-emerald-500/50' : 'bg-zinc-700';

            return `
                <div class="flex items-center gap-1 py-2 border-t border-white/5">
                    <div class="flex items-center gap-1.5">
                        <span class="w-2 h-2 rounded-full ${s1Class}"></span>
                        <span class="text-[10px] ${currentStage === 1 ? 'text-amber-400 font-medium' : (stage1Complete ? 'text-emerald-400' : 'text-zinc-500')}">1</span>
                    </div>
                    <div class="flex-1 h-px ${line1Class}"></div>
                    <div class="flex items-center gap-1.5">
                        <span class="w-2 h-2 rounded-full ${s2Class}"></span>
                        <span class="text-[10px] ${currentStage === 2 ? 'text-amber-400 font-medium' : (currentStage > 2 ? 'text-emerald-400' : 'text-zinc-500')}">2</span>
                    </div>
                    <div class="flex-1 h-px ${line2Class}"></div>
                    <div class="flex items-center gap-1.5">
                        <span class="w-2 h-2 rounded-full ${s3Class}"></span>
                        <span class="text-[10px] ${currentStage === 3 ? 'text-amber-400 font-medium' : 'text-zinc-500'}">3</span>
                    </div>
                </div>
            `;
        }

        function renderCurrentWork(w) {
            const stage = getWorkflowStage(w);
            const progressPercent = w.progress_percent || 0;

            if (stage === 3) {
                // TakeDrop
                const td = w.takedrop_stage;
                const status = td?.stage_accepted ? 'Zaakceptowany' : 'Oczekuje na akceptację';
                const icon = td?.stage_accepted ? 'ph-fill ph-check-circle text-emerald-400' : 'ph ph-hourglass text-amber-400';
                return `
                    <div class="py-2">
                        <div class="flex items-center gap-2 text-[11px]">
                            <i class="${icon}"></i>
                            <span class="text-white font-medium">TakeDrop</span>
                            <span class="text-zinc-500">·</span>
                            <span class="text-zinc-400">${status}</span>
                        </div>
                    </div>
                `;
            } else if (stage === 2) {
                // Video
                const v = w.video_stage;
                const isShared = v?.video_shared || false;
                let status = 'W trakcie';
                let icon = 'ph ph-video-camera text-amber-400';
                if (isShared) {
                    status = 'Udostępnione klientowi';
                    icon = 'ph-fill ph-check-circle text-emerald-400';
                } else if (v?.stage_accepted) {
                    status = 'Oczekuje na video';
                    icon = 'ph ph-hourglass text-amber-400';
                }
                return `
                    <div class="py-2">
                        <div class="flex items-center gap-2 text-[11px]">
                            <i class="${icon}"></i>
                            <span class="text-white font-medium">Video</span>
                            <span class="text-zinc-500">·</span>
                            <span class="text-zinc-400">${status}</span>
                        </div>
                    </div>
                `;
            } else {
                // Milestones
                const milestoneTitle = w.current_milestone_title || 'Brak etapów';
                const milestoneNum = w.total_milestones > 0 ? `${w.completed_milestones + 1}/${w.total_milestones}` : '-';

                // Task progress for current milestone - only show if some tasks completed
                const tasks = w.current_milestone_tasks || [];
                const completedTasks = tasks.filter(t => t.completed).length;
                const totalTasks = tasks.length;
                const taskInfo = (totalTasks > 0 && completedTasks > 0) ? `${completedTasks}/${totalTasks} zadań` : '';

                return `
                    <div class="py-2">
                        <div class="flex items-center justify-between text-[11px] mb-1.5">
                            <div class="flex items-center gap-2 min-w-0">
                                <span class="text-amber-400 font-mono flex-shrink-0">[${milestoneNum}]</span>
                                <span class="text-white truncate">${milestoneTitle}</span>
                            </div>
                            <span class="text-zinc-500 font-mono flex-shrink-0 ml-2">${progressPercent}%</span>
                        </div>
                        <div class="h-1.5 bg-zinc-800 rounded-full overflow-hidden">
                            <div class="progress-bar h-full rounded-full" style="width: ${progressPercent}%"></div>
                        </div>
                        ${taskInfo ? `<div class="text-[10px] text-zinc-500 mt-1">${taskInfo}</div>` : ''}
                    </div>
                `;
            }
        }

        function formatPrice(price) {
            return new Intl.NumberFormat('pl-PL', {
                style: 'currency',
                currency: 'PLN',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(price || 0);
        }

        function getDaysSinceUpdate(updatedAt) {
            if (!updatedAt) return null;
            const updated = new Date(updatedAt);
            const now = new Date();
            const diffMs = now - updated;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            return diffDays;
        }

        function formatDaysSince(days) {
            if (days === null || days === undefined) return '';
            if (days === 0) return 'dzisiaj';
            if (days === 1) return '1 dzień';
            if (days < 5) return `${days} dni`;
            if (days < 14) return `${days} dni`;
            if (days < 30) return `${Math.floor(days / 7)} tyg.`;
            return `${Math.floor(days / 30)} mies.`;
        }

        function renderWorkflows() {
            const grid = document.getElementById('workflows-grid');
            const emptyState = document.getElementById('empty-state');
            const loadingState = document.getElementById('loading-state');

            loadingState.classList.add('hidden');

            if (filteredWorkflows.length === 0) {
                grid.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');

            grid.innerHTML = filteredWorkflows.map(w => {
                const unread = unreadCounts[w.workflow_id] || 0;
                const customerDisplay = w.customer_name || w.customer_company || w.customer_email.split('@')[0];
                const logoUrl = workflowLogos[w.workflow_id];
                const currentStage = getWorkflowStage(w);

                // Check if waiting for client (video shared but no client links)
                const isWaitingForClient = w.waiting_for_client === true;

                // Deadline info - don't show warning when waiting for client
                let deadlineHtml = '';
                if (w.current_milestone_deadline && !isWaitingForClient) {
                    deadlineHtml = `<span class="flex items-center gap-1"><i class="ph ph-clock text-zinc-600"></i>${formatDeadline(w.current_milestone_deadline)}</span>`;
                }

                // Days since last admin update - don't show warning when waiting for client
                const daysSince = isWaitingForClient ? null : getDaysSinceUpdate(w.updated_at);
                const daysSinceColor = daysSince > 7 ? 'text-red-400' : (daysSince > 3 ? 'text-amber-400' : 'text-zinc-500');

                // Waiting for client badge with days count
                let waitingBadge = '';
                if (isWaitingForClient) {
                    const waitingDays = w.video_activated_at
                        ? Math.floor((new Date() - new Date(w.video_activated_at)) / (1000 * 60 * 60 * 24))
                        : 0;
                    const daysText = waitingDays === 0 ? 'dziś' : waitingDays === 1 ? '1 dzień' : `${waitingDays} dni`;
                    waitingBadge = `<span class="flex items-center gap-1 text-cyan-400" title="Video udostępnione - czekam na klienta od ${daysText}"><i class="ph ph-hourglass"></i>Czekam ${daysText}</span>`;
                }

                // Start date
                const startDate = new Date(w.started_at).toLocaleDateString('pl-PL', { day: 'numeric', month: 'short' });

                return `
                <a href="${getWorkflowPath(w.workflow_id)}" class="workflow-card group bg-zinc-900/40 border border-white/5 rounded-lg overflow-hidden transition-all cursor-pointer block">
                    <!-- Header: Logo + Customer + Status -->
                    <div class="flex items-start gap-3 p-4 pb-0">
                        ${logoUrl ? `<img src="${logoUrl}" alt="" class="workflow-logo w-10 h-10 object-contain flex-shrink-0 rounded-lg bg-zinc-800/50">` : `<div class="w-10 h-10 rounded-lg bg-zinc-800/50 flex items-center justify-center text-zinc-600"><i class="ph ph-user text-lg"></i></div>`}
                        <div class="min-w-0 flex-1">
                            <div class="flex items-center justify-between mb-0.5">
                                <h3 class="font-medium text-white text-sm truncate">${customerDisplay}</h3>
                                <div class="flex items-center gap-1.5 flex-shrink-0 ml-2">
                                    ${getStatusBadge(w.status)}
                                    ${w.status === 'cancelled' ? `
                                        <button onclick="event.preventDefault(); event.stopPropagation(); openDeleteModal('${w.workflow_id}', '${customerDisplay.replace(/'/g, "\\'")}')"
                                                class="p-1 text-red-400 hover:text-red-300 hover:bg-red-500/10 rounded transition-colors"
                                                title="Usun projekt">
                                            <i class="ph ph-trash text-xs"></i>
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                            <div class="flex items-center gap-1.5 text-xs text-zinc-400">
                                <span class="truncate">${w.offer_name}</span>
                                <span class="text-zinc-700">·</span>
                                <span class="font-mono text-zinc-300 flex-shrink-0">${formatPrice(w.amount)}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Stage Timeline: 1 — 2 — 3 -->
                    <div class="px-4">
                        ${renderStageTimeline(w)}
                    </div>

                    <!-- Current Work Section -->
                    <div class="px-4">
                        ${renderCurrentWork(w)}
                    </div>

                    <!-- Status Checklist (if any) -->
                    <div class="px-4">
                        ${getStatusChecklist(w)}
                    </div>

                    <!-- Footer: Deadline + Comments + Days Since + Actions -->
                    <div class="flex items-center justify-between px-4 py-2.5 bg-zinc-900/50 border-t border-white/5">
                        <div class="flex items-center gap-3 text-[11px]">
                            ${waitingBadge}
                            ${deadlineHtml}
                            ${unread > 0 ? `
                                <span class="flex items-center gap-1 text-amber-400" title="${unread} nieprzeczytanych wiadomości">
                                    <i class="ph-fill ph-chat-circle"></i>
                                    ${unread}
                                </span>
                            ` : ''}
                            ${daysSince !== null ? `
                                <span class="flex items-center gap-1 ${daysSinceColor}" title="Ostatnia zmiana admina">
                                    <i class="ph ph-pencil-simple"></i>
                                    ${formatDaysSince(daysSince)}
                                </span>
                            ` : ''}
                            <span class="text-zinc-600 font-mono" title="Data rozpoczęcia">${startDate}</span>
                        </div>
                        <div class="flex items-center gap-1">
                            <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-all">
                                <button onclick="event.preventDefault(); event.stopPropagation(); copyClientLink('${w.unique_token}', '${customerDisplay}')" class="p-1 text-zinc-500 hover:text-white hover:bg-white/5 rounded transition-colors" title="Kopiuj link klienta">
                                    <i class="ph ph-link text-xs"></i>
                                </button>
                                <button onclick="event.preventDefault(); event.stopPropagation(); window.open(getWorkflowPath('${w.workflow_id}'), '_blank')" class="p-1 text-zinc-500 hover:text-white hover:bg-white/5 rounded transition-colors" title="Otworz w nowej karcie">
                                    <i class="ph ph-arrow-square-out text-xs"></i>
                                </button>
                            </div>
                            <button onclick="toggleStar('${w.workflow_id}', event)"
                                    data-starred="${w.starred ? 'true' : 'false'}"
                                    class="p-1.5 ${w.starred ? 'text-amber-400' : 'text-zinc-600 hover:text-amber-400'} hover:bg-white/5 rounded transition-colors"
                                    title="${w.starred ? 'Usuń z ulubionych' : 'Dodaj do ulubionych'}">
                                <i class="ph${w.starred ? '-fill' : ''} ph-star text-sm"></i>
                            </button>
                        </div>
                    </div>
                </a>
            `}).join('');
        }

        async function copyClientLink(token, customerName) {
            const url = getClientUrl(token);

            try {
                await navigator.clipboard.writeText(url);
                showToast(`Link skopiowany: ${customerName}`);
            } catch (err) {
                const textArea = document.createElement('textarea');
                textArea.value = url;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showToast(`Link skopiowany: ${customerName}`);
            }
        }

        async function toggleStar(workflowId, event) {
            event.preventDefault();
            event.stopPropagation();

            const btn = event.currentTarget;
            const currentlyStarred = btn.dataset.starred === 'true';
            const newStarred = !currentlyStarred;

            // Optimistic UI update
            btn.dataset.starred = newStarred.toString();
            btn.innerHTML = newStarred
                ? '<i class="ph-fill ph-star text-amber-400"></i>'
                : '<i class="ph ph-star"></i>';

            try {
                const { error } = await supabaseClient
                    .from('workflows')
                    .update({ starred: newStarred })
                    .eq('id', workflowId);

                if (error) throw error;

                // Update local data
                const workflow = workflows.find(w => w.workflow_id === workflowId);
                if (workflow) workflow.starred = newStarred;

                // Re-sort and re-render (starred should always be at top)
                applyFilters();
                renderWorkflows();

            } catch (err) {
                console.error('Error toggling star:', err);
                // Revert on error
                btn.dataset.starred = currentlyStarred.toString();
                btn.innerHTML = currentlyStarred
                    ? '<i class="ph-fill ph-star text-amber-400"></i>'
                    : '<i class="ph ph-star"></i>';
                showToast('Błąd zapisu');
            }
        }

        function showToast(message) {
            const existing = document.getElementById('toast-notification');
            if (existing) existing.remove();

            const toast = document.createElement('div');
            toast.id = 'toast-notification';
            toast.className = 'fixed bottom-6 right-6 bg-zinc-800 border border-white/10 text-white px-4 py-3 rounded-lg shadow-xl z-50 flex items-center gap-2 animate-enter';
            toast.innerHTML = `<i class="ph ph-check-circle text-emerald-400"></i> ${message}`;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(10px)';
                toast.style.transition = 'all 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        async function toggleVideoSharedCard(workflowId, newValue) {
            try {
                const updateData = { video_shared: newValue };
                if (newValue) {
                    updateData.video_shared_at = new Date().toISOString();
                } else {
                    updateData.video_shared_at = null;
                }

                const { error } = await supabaseClient
                    .from('workflow_video')
                    .update(updateData)
                    .eq('workflow_id', workflowId);

                if (error) throw error;

                // Update local state
                if (videoStages[workflowId]) {
                    videoStages[workflowId].video_shared = newValue;
                }
                const w = workflows.find(w => w.workflow_id === workflowId);
                if (w && w.video_stage) {
                    w.video_stage.video_shared = newValue;
                }

                renderWorkflows();
                showToast(newValue ? 'Video oznaczone jako udostępnione' : 'Oznaczenie usunięte');
            } catch (err) {
                console.error('Error toggling video shared:', err);
                showToast('Błąd zapisu');
            }
        }

        // =============================================
        // DELETE WORKFLOW
        // =============================================
        let workflowToDelete = null;

        function openDeleteModal(workflowId, customerName) {
            workflowToDelete = workflowId;
            document.getElementById('delete-customer-name').textContent = customerName;
            document.getElementById('delete-modal').classList.remove('hidden');
        }

        function closeDeleteModal() {
            document.getElementById('delete-modal').classList.add('hidden');
            workflowToDelete = null;
        }

        async function confirmDeleteWorkflow() {
            if (!workflowToDelete) return;

            const btn = document.getElementById('confirm-delete-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="w-4 h-4 border-2 border-white/20 border-t-white rounded-full animate-spin"></span>';

            try {
                // Delete workflow tasks first
                await supabaseClient
                    .from('workflow_tasks')
                    .delete()
                    .eq('workflow_id', workflowToDelete);

                // Delete workflow milestones
                await supabaseClient
                    .from('workflow_milestones')
                    .delete()
                    .eq('workflow_id', workflowToDelete);

                // Delete workflow access log
                await supabaseClient
                    .from('workflow_access_log')
                    .delete()
                    .eq('workflow_id', workflowToDelete);

                // Delete workflow
                const { error } = await supabaseClient
                    .from('workflows')
                    .delete()
                    .eq('id', workflowToDelete);

                if (error) throw error;

                closeDeleteModal();
                showToast('Projekt zostal usuniety');
                await loadWorkflows();

            } catch (err) {
                console.error('Error deleting workflow:', err);
                alert('Wystapil blad podczas usuwania projektu');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="ph ph-trash"></i> Usun';
            }
        }

        // Event listeners for filters
        document.getElementById('search-input').addEventListener('input', () => {
            applyFilters();
            renderWorkflows();
        });

        document.getElementById('status-filter').addEventListener('change', () => {
            applyFilters();
            renderWorkflows();
        });

        document.getElementById('offer-filter').addEventListener('change', () => {
            applyFilters();
            renderWorkflows();
        });

        document.getElementById('sort-filter').addEventListener('change', () => {
            applyFilters();
            renderWorkflows();
        });

        // =============================================
        // ADD WORKFLOW MODAL
        // =============================================
        let selectedOrder = null;

        function openAddModal() {
            selectedOrder = null;
            document.getElementById('order-number-input').value = '';
            document.getElementById('order-preview').classList.add('hidden');
            document.getElementById('add-error').classList.add('hidden');
            document.getElementById('create-btn').disabled = true;
            document.getElementById('add-modal').classList.remove('hidden');
            document.getElementById('order-number-input').focus();
        }

        function closeAddModal() {
            document.getElementById('add-modal').classList.add('hidden');
            selectedOrder = null;
        }

        async function searchOrder() {
            const orderNumber = document.getElementById('order-number-input').value.trim();
            if (!orderNumber) return;

            const searchBtn = document.getElementById('search-btn');
            searchBtn.disabled = true;
            searchBtn.innerHTML = '<i class="ph ph-spinner animate-spin"></i> Szukam...';

            document.getElementById('add-error').classList.add('hidden');
            document.getElementById('order-preview').classList.add('hidden');

            try {
                // Search by order_number or id
                let query = supabaseClient
                    .from('orders')
                    .select('*');

                // Try to match by order_number first
                if (orderNumber.startsWith('ORD-')) {
                    query = query.eq('order_number', orderNumber);
                } else {
                    // Try as UUID
                    query = query.eq('id', orderNumber);
                }

                const { data: orders, error } = await query.limit(1);

                if (error) throw error;

                if (!orders || orders.length === 0) {
                    throw new Error('Nie znaleziono zamowienia o podanym numerze');
                }

                const order = orders[0];

                // Check if workflow already exists
                const { data: existingWorkflow } = await supabaseClient
                    .from('workflows')
                    .select('id')
                    .eq('order_id', order.id)
                    .single();

                if (existingWorkflow) {
                    throw new Error('Projekt dla tego zamowienia juz istnieje');
                }

                // Show preview
                selectedOrder = order;
                document.getElementById('preview-customer').textContent = order.customer_name || order.customer_company || order.customer_email;
                document.getElementById('preview-offer').textContent = order.description || '-';
                document.getElementById('preview-amount').textContent = formatPrice(order.amount);
                document.getElementById('preview-status').textContent = order.status;
                document.getElementById('preview-status').className = order.status === 'paid' ? 'text-emerald-400' : 'text-amber-400';

                document.getElementById('order-preview').classList.remove('hidden');
                document.getElementById('create-btn').disabled = false;

            } catch (err) {
                document.getElementById('add-error').textContent = err.message;
                document.getElementById('add-error').classList.remove('hidden');
                selectedOrder = null;
            } finally {
                searchBtn.disabled = false;
                searchBtn.innerHTML = '<i class="ph ph-magnifying-glass"></i> Szukaj';
            }
        }

        async function createWorkflowFromOrder() {
            if (!selectedOrder) return;

            const createBtn = document.getElementById('create-btn');
            createBtn.disabled = true;
            createBtn.textContent = 'Tworzenie...';

            try {
                // Find offer by name
                const { data: offer } = await supabaseClient
                    .from('offers')
                    .select('id, name, milestones')
                    .eq('name', selectedOrder.description)
                    .single();

                const milestones = offer?.milestones || [];

                // Create workflow
                const { data: workflow, error: workflowError } = await supabaseClient
                    .from('workflows')
                    .insert({
                        order_id: selectedOrder.id,
                        customer_email: selectedOrder.customer_email,
                        customer_name: selectedOrder.customer_name,
                        customer_company: selectedOrder.customer_company,
                        customer_phone: selectedOrder.customer_phone,
                        offer_name: selectedOrder.description || 'Zamowienie',
                        offer_id: offer?.id || null,
                        amount: selectedOrder.amount,
                        started_at: selectedOrder.paid_at || new Date().toISOString(),
                        milestones_snapshot: milestones
                    })
                    .select()
                    .single();

                if (workflowError) throw workflowError;

                // Create milestones and tasks
                let startDate = new Date(selectedOrder.paid_at || new Date());
                startDate.setHours(0, 0, 0, 0);

                for (let i = 0; i < milestones.length; i++) {
                    const m = milestones[i];
                    const durationDays = m.duration_days || 0;
                    const hasDuration = durationDays > 0;

                    let milestoneStart = null;
                    let milestoneDeadline = null;
                    if (hasDuration) {
                        milestoneStart = startDate.toISOString().split('T')[0];
                        const deadline = new Date(startDate);
                        deadline.setDate(deadline.getDate() + durationDays - 1);
                        milestoneDeadline = deadline.toISOString().split('T')[0];
                    }

                    const { data: milestone, error: milestoneError } = await supabaseClient
                        .from('workflow_milestones')
                        .insert({
                            workflow_id: workflow.id,
                            milestone_index: i,
                            title: m.title || `Etap ${i + 1}`,
                            description: m.description || null,
                            duration_days: durationDays,
                            start_date: milestoneStart,
                            deadline: milestoneDeadline,
                            deliverables: m.deliverables || [],
                            status: i === 0 ? 'in_progress' : 'pending',
                            started_at: i === 0 ? new Date().toISOString() : null
                        })
                        .select()
                        .single();

                    if (milestoneError) throw milestoneError;

                    // Create tasks
                    const tasks = m.tasks || [];
                    for (let j = 0; j < tasks.length; j++) {
                        const t = tasks[j];
                        await supabaseClient
                            .from('workflow_tasks')
                            .insert({
                                milestone_id: milestone.id,
                                workflow_id: workflow.id,
                                task_index: j,
                                title: t.title || `Zadanie ${j + 1}`,
                                responsible: t.responsible || 'team'
                            });
                    }

                    // Next milestone starts day after deadline (skip stages without deadline)
                    if (milestoneDeadline) {
                        startDate = new Date(milestoneDeadline);
                        startDate.setDate(startDate.getDate() + 1);
                    }
                }

                // Trigger automation for email
                if (workflow.customer_email) {
                    try {
                        const clientName = (workflow.customer_name || '').split(' ')[0] || 'Cześć';
                        const projectUrl = `https://crm.tomekniedzwiecki.pl/projekt/${workflow.unique_token}`;
                        await supabaseClient.functions.invoke('automation-trigger', {
                            body: {
                                trigger_type: 'workflow_created',
                                entity_type: 'workflow',
                                entity_id: workflow.id,
                                context: {
                                    email: workflow.customer_email,
                                    clientName,
                                    offerName: workflow.offer_name || 'Projekt',
                                    projectUrl
                                }
                            }
                        });
                    } catch (emailErr) {
                        console.warn('Automation trigger error:', emailErr);
                    }
                }

                closeAddModal();
                showToast('Projekt utworzony!');
                await loadWorkflows();

            } catch (err) {
                console.error('Error creating workflow:', err);
                document.getElementById('add-error').textContent = 'Blad tworzenia projektu: ' + err.message;
                document.getElementById('add-error').classList.remove('hidden');
            } finally {
                createBtn.disabled = false;
                createBtn.textContent = 'Utworz projekt';
            }
        }

        // Enter key in order number input
        document.getElementById('order-number-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchOrder();
        });

        // Close modal on backdrop click
        document.getElementById('add-modal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeAddModal();
        });

        document.getElementById('delete-modal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeDeleteModal();
        });

        // =============================================
        // ADMIN ACTIVITY HISTORY
        // =============================================
        let recentActivities = [];
        let activityPanelOpen = false;

        async function loadRecentActivities() {
            try {
                const { data, error } = await supabaseClient
                    .from('workflow_activities')
                    .select(`
                        id,
                        workflow_id,
                        action,
                        description,
                        performed_by_name,
                        created_at,
                        workflows!inner(customer_name, customer_company, customer_email)
                    `)
                    .order('created_at', { ascending: false })
                    .limit(15);

                if (error) {
                    console.error('Error loading activities:', error);
                    return;
                }

                recentActivities = data || [];
                renderActivities();
            } catch (err) {
                console.error('Failed to load activities:', err);
            }
        }

        function renderActivities() {
            const section = document.getElementById('activity-section');
            const list = document.getElementById('activity-list');
            const countEl = document.getElementById('activity-count');

            if (recentActivities.length === 0) {
                section.classList.add('hidden');
                return;
            }

            section.classList.remove('hidden');
            countEl.textContent = `(${recentActivities.length})`;

            list.innerHTML = recentActivities.map(a => {
                const customer = a.workflows?.customer_name || a.workflows?.customer_company || a.workflows?.customer_email?.split('@')[0] || 'Nieznany';
                const timeAgo = formatActivityTime(a.created_at);
                const actionIcon = getActivityIcon(a.action);

                return `
                    <a href="${getWorkflowPath(a.workflow_id)}" class="flex items-start gap-3 p-2 rounded-lg hover:bg-white/5 transition-colors group">
                        <div class="w-6 h-6 rounded-full bg-zinc-800 flex items-center justify-center flex-shrink-0 mt-0.5">
                            <i class="ph ${actionIcon} text-xs text-zinc-400"></i>
                        </div>
                        <div class="min-w-0 flex-1">
                            <div class="text-xs text-white truncate">${a.description}</div>
                            <div class="flex items-center gap-2 text-[10px] text-zinc-500 mt-0.5">
                                <span class="truncate">${customer}</span>
                                <span class="text-zinc-700">·</span>
                                <span class="flex-shrink-0">${timeAgo}</span>
                            </div>
                        </div>
                    </a>
                `;
            }).join('');
        }

        function formatActivityTime(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'przed chwilą';
            if (diffMins < 60) return `${diffMins} min temu`;
            if (diffHours < 24) return `${diffHours}h temu`;
            if (diffDays === 1) return 'wczoraj';
            if (diffDays < 7) return `${diffDays} dni temu`;
            return date.toLocaleDateString('pl-PL', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
        }

        function getActivityIcon(action) {
            const icons = {
                'contract_sent': 'ph-file-text',
                'contract_signed': 'ph-check-circle',
                'products_shared': 'ph-package',
                'product_selected': 'ph-check-square',
                'report_uploaded': 'ph-chart-bar',
                'report_published': 'ph-eye',
                'branding_shared': 'ph-paint-brush',
                'branding_uploaded': 'ph-image',
                'sales_page_shared': 'ph-browser',
                'milestone_completed': 'ph-flag',
                'task_completed': 'ph-check',
                'comment_added': 'ph-chat-circle',
                'status_changed': 'ph-arrows-clockwise',
                'video_shared': 'ph-video-camera',
                'video_activated': 'ph-video-camera',
                'video_deactivated': 'ph-video-camera-slash',
                'email_sent': 'ph-envelope'
            };
            return icons[action] || 'ph-activity';
        }

        function toggleActivityPanel() {
            activityPanelOpen = !activityPanelOpen;
            const panel = document.getElementById('activity-panel');
            const icon = document.getElementById('activity-toggle-icon');

            if (activityPanelOpen) {
                panel.classList.remove('hidden');
                icon.style.transform = 'rotate(90deg)';
            } else {
                panel.classList.add('hidden');
                icon.style.transform = 'rotate(0deg)';
            }
        }

        // Make functions available globally
        window.getWorkflowPath = getWorkflowPath;
        window.copyClientLink = copyClientLink;
        window.toggleStage = toggleStage;
        window.toggleStatusStage = toggleStatusStage;
        window.openAddModal = openAddModal;
        window.closeAddModal = closeAddModal;
        window.searchOrder = searchOrder;
        window.createWorkflowFromOrder = createWorkflowFromOrder;
        window.toggleActivityPanel = toggleActivityPanel;

        async function init() {
            const session = await checkAuth();
            if (session) {
                await Promise.all([loadWorkflows(), loadRecentActivities()]);
            }
        }
        init();

        // Register service worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').catch(() => {});
        }
    </script>
</body>
</html>
