<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TN CRM - WhatsApp Logi</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#050505">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="/components/shared-sidebar.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    }
                }
            }
        }
    </script>
    <style>
        body { background: #050505; color: #e5e5e5; }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        ::selection { background: white; color: black; }

        .glass-header {
            background: rgba(5, 5, 5, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-enter { animation: fadeIn 0.4s ease-out forwards; }

        /* Stat cards */
        .stat-card {
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.05);
        }

        /* Log entry */
        .log-entry {
            background: rgba(24, 24, 27, 0.5);
            border: 1px solid rgba(255,255,255,0.05);
            transition: all 0.2s ease;
        }
        .log-entry:hover {
            border-color: rgba(255,255,255,0.1);
            background: rgba(24, 24, 27, 0.8);
        }

        /* Status indicators */
        .status-active { color: #22c55e; }
        .status-inactive { color: #64748b; }

        /* Pulse animation */
        @keyframes pulse-green {
            0%, 100% { box-shadow: 0 0 0 0 rgba(37, 211, 102, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(37, 211, 102, 0); }
        }
        .pulse-active { animation: pulse-green 2s infinite; }

        /* User badge */
        .user-badge-tomek { background: rgba(59, 130, 246, 0.15); border-color: rgba(59, 130, 246, 0.3); color: #3b82f6; }
        .user-badge-maciek { background: rgba(168, 85, 247, 0.15); border-color: rgba(168, 85, 247, 0.3); color: #a855f7; }
    </style>
</head>
<body class="h-screen flex overflow-hidden font-sans text-sm tracking-tight antialiased">

    <!-- Sidebar -->
    <aside id="sidebar" class="w-[280px] bg-zinc-950 border-r border-white/5 flex flex-col flex-shrink-0"></aside>

    <!-- Main -->
    <main class="flex-1 flex flex-col bg-black relative min-w-0">
        <!-- Header -->
        <header class="h-16 glass-header flex items-center justify-between px-4 md:px-6 sticky top-0 z-30">
            <div class="flex items-center gap-3">
                <button onclick="Sidebar.toggle()" class="mobile-menu-btn hidden items-center justify-center w-9 h-9 rounded-lg hover:bg-white/5 text-zinc-400 hover:text-white transition-colors">
                    <i class="ph ph-list text-xl"></i>
                </button>
                <div class="flex items-center gap-2 text-zinc-500">
                    <span class="text-zinc-400 hidden sm:inline">tn-crm</span>
                    <span class="text-zinc-700 hidden sm:inline">/</span>
                    <a href="/whatsapp" class="text-zinc-400 hover:text-white transition-colors flex items-center gap-2">
                        <i class="ph ph-whatsapp-logo text-[#25D366]"></i>
                        whatsapp
                    </a>
                    <span class="text-zinc-700">/</span>
                    <span class="text-white font-medium">logi</span>
                </div>
            </div>
            <div class="flex items-center gap-2 md:gap-3">
                <a href="/whatsapp" class="text-zinc-400 hover:text-white border border-zinc-800 hover:border-zinc-700 px-3 py-1.5 rounded-lg text-xs transition-colors flex items-center gap-1.5">
                    <i class="ph ph-chat-text"></i>
                    <span class="hidden md:inline">Generator</span>
                </a>
                <a href="/whatsapp/settings" class="text-zinc-400 hover:text-white border border-zinc-800 hover:border-zinc-700 px-3 py-1.5 rounded-lg text-xs transition-colors flex items-center gap-1.5">
                    <i class="ph ph-gear"></i>
                    <span class="hidden md:inline">Ustawienia</span>
                </a>
                <button onclick="loadData()" class="text-zinc-400 hover:text-white border border-zinc-800 hover:border-zinc-700 px-3 py-1.5 rounded-lg text-xs transition-colors flex items-center gap-1.5">
                    <i class="ph ph-arrows-clockwise"></i>
                    <span class="hidden md:inline">Odswiez</span>
                </button>
            </div>
        </header>

        <!-- Content -->
        <div class="flex-1 overflow-y-auto p-4 md:p-6">
            <!-- Widget Status Cards -->
            <div class="mb-6">
                <h2 class="text-xs font-medium text-zinc-500 uppercase tracking-wider mb-3 flex items-center gap-2">
                    <i class="ph ph-broadcast text-[#25D366]"></i>
                    Status widgetow
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="widget-status">
                    <!-- Widget cards will be inserted here -->
                    <div class="stat-card rounded-lg p-4 flex items-center gap-4">
                        <div class="w-3 h-3 rounded-full bg-zinc-700"></div>
                        <div class="flex-1">
                            <div class="text-white font-medium">Ladowanie...</div>
                            <div class="text-xs text-zinc-500">Sprawdzam status widgetow</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stats -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                <div class="stat-card rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-white font-mono" id="stat-total-syncs">-</div>
                    <div class="text-[10px] text-zinc-500 uppercase tracking-wider">Synchronizacji</div>
                </div>
                <div class="stat-card rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-[#25D366] font-mono" id="stat-total-messages">-</div>
                    <div class="text-[10px] text-zinc-500 uppercase tracking-wider">Wiadomosci</div>
                </div>
                <div class="stat-card rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-blue-400 font-mono" id="stat-tomek">-</div>
                    <div class="text-[10px] text-zinc-500 uppercase tracking-wider">Tomek</div>
                </div>
                <div class="stat-card rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-violet-400 font-mono" id="stat-maciek">-</div>
                    <div class="text-[10px] text-zinc-500 uppercase tracking-wider">Maciek</div>
                </div>
            </div>

            <!-- Sync History -->
            <div class="mb-6">
                <h2 class="text-xs font-medium text-zinc-500 uppercase tracking-wider mb-3 flex items-center gap-2">
                    <i class="ph ph-clock-counter-clockwise text-amber-400"></i>
                    Historia synchronizacji
                </h2>
                <div id="sync-history" class="space-y-3">
                    <!-- Loading -->
                    <div id="loading-state" class="py-12 text-center">
                        <div class="w-6 h-6 mx-auto mb-3 border-2 border-zinc-700 border-t-[#25D366] rounded-full animate-spin"></div>
                        <p class="text-zinc-500 text-sm">Laduje historie...</p>
                    </div>
                </div>
            </div>

            <!-- Recent Messages by Lead -->
            <div>
                <h2 class="text-xs font-medium text-zinc-500 uppercase tracking-wider mb-3 flex items-center gap-2">
                    <i class="ph ph-users text-cyan-400"></i>
                    Ostatnie wiadomosci wg leadow
                </h2>
                <div id="leads-activity" class="space-y-2">
                    <!-- Will be populated -->
                </div>
            </div>
        </div>
    </main>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-6 right-6 bg-zinc-800 border border-white/10 text-white px-4 py-3 rounded-lg shadow-xl z-50 flex items-center gap-2 opacity-0 invisible transition-all duration-300 transform translate-y-2">
        <i class="ph ph-check-circle text-emerald-400"></i>
        <span id="toast-text"></span>
    </div>

    <script>
        const SUPABASE_URL = 'https://yxmavwkwnfuphjqbelws.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl4bWF2d2t3bmZ1cGhqcWJlbHdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NjQyNTUsImV4cCI6MjA4NDM0MDI1NX0.XeR0Fc7OFn6YbNJrOKTBEj36JtmLISZTM87y4ai9340';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        Sidebar.render();
        Sidebar.setupLogout(supabaseClient);

        // ============================================
        // AUTH & INIT
        // ============================================
        async function checkAuth() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
                window.location.href = Sidebar.getLoginPath();
                return null;
            }
            Sidebar.setUserEmail(session.user.email.split('@')[0]);
            await loadTeamMembers(session.user.id);
            return session;
        }

        async function loadTeamMembers(userId) {
            const { data, error } = await supabaseClient.from('team_members').select('*');
            if (error) return;
            const teamMembers = data || [];
            const currentMember = teamMembers.find(m => m.user_id === userId);

            if (currentMember) {
                Sidebar.setUserName(currentMember.name);
                Sidebar.setUserColor(currentMember.color);
                Sidebar.setupProfileClick();
            }

            Sidebar.showAdminNav(currentMember?.role === 'admin');
        }

        // ============================================
        // LOAD DATA
        // ============================================
        async function loadData() {
            await Promise.all([
                loadWidgetStatus(),
                loadSyncHistory(),
                loadLeadsActivity()
            ]);
        }

        // Widget status
        async function loadWidgetStatus() {
            const container = document.getElementById('widget-status');

            // Pobierz status widgetow
            const { data: widgetStatus, error } = await supabaseClient
                .from('whatsapp_widget_status')
                .select('*');

            if (error) {
                console.error('Error loading widget status:', error);
                // Pokazujemy fallback - zakładamy że tabela nie istnieje
                container.innerHTML = `
                    <div class="stat-card rounded-lg p-4 flex items-center gap-4">
                        <div class="w-3 h-3 rounded-full bg-zinc-700"></div>
                        <div class="flex-1">
                            <div class="text-white font-medium">Tomek</div>
                            <div class="text-xs text-zinc-500">Brak danych - uruchom migracje</div>
                        </div>
                    </div>
                    <div class="stat-card rounded-lg p-4 flex items-center gap-4">
                        <div class="w-3 h-3 rounded-full bg-zinc-700"></div>
                        <div class="flex-1">
                            <div class="text-white font-medium">Maciek</div>
                            <div class="text-xs text-zinc-500">Brak danych - uruchom migracje</div>
                        </div>
                    </div>
                `;
                return;
            }

            // Pobierz ostatni sync per user z whatsapp_messages
            const { data: lastSyncs } = await supabaseClient
                .from('whatsapp_messages')
                .select('synced_by, synced_at')
                .order('synced_at', { ascending: false })
                .limit(100);

            // Grupuj po synced_by
            const lastSyncByUser = {};
            (lastSyncs || []).forEach(msg => {
                if (msg.synced_by && !lastSyncByUser[msg.synced_by]) {
                    lastSyncByUser[msg.synced_by] = msg.synced_at;
                }
            });

            const users = ['Tomek', 'Maciek'];
            container.innerHTML = users.map(userName => {
                const status = (widgetStatus || []).find(w => w.user_name === userName);
                const isActive = status?.is_active || false;
                const scheduledEnabled = status?.scheduled_sync_enabled || false;
                const lastSync = lastSyncByUser[userName.toLowerCase()];
                const lastSyncFormatted = lastSync ? formatTimeAgo(new Date(lastSync)) : 'Nigdy';

                const userClass = userName === 'Tomek' ? 'user-badge-tomek' : 'user-badge-maciek';
                const statusColor = isActive ? 'bg-[#25D366]' : 'bg-zinc-700';
                const pulseClass = isActive && scheduledEnabled ? 'pulse-active' : '';

                return `
                    <div class="stat-card rounded-lg p-4 flex items-center gap-4">
                        <div class="w-3 h-3 rounded-full ${statusColor} ${pulseClass}"></div>
                        <div class="flex-1">
                            <div class="flex items-center gap-2">
                                <span class="text-white font-medium">${userName}</span>
                                ${scheduledEnabled ? '<span class="text-[10px] px-1.5 py-0.5 bg-[#25D366]/20 text-[#25D366] rounded">Auto co 5h</span>' : ''}
                            </div>
                            <div class="text-xs text-zinc-500 mt-0.5">
                                ${isActive ? 'Widget aktywny' : 'Widget nieaktywny'}
                                ${lastSync ? ` • Ostatni sync: ${lastSyncFormatted}` : ''}
                            </div>
                            ${status?.next_scheduled_sync ? `
                                <div class="text-[10px] text-zinc-600 mt-1">
                                    Nastepny: ${new Date(status.next_scheduled_sync).toLocaleString('pl-PL', { hour: '2-digit', minute: '2-digit', day: '2-digit', month: '2-digit' })}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Sync history
        async function loadSyncHistory() {
            const container = document.getElementById('sync-history');

            // Pobierz logi synchronizacji
            const { data: logs, error } = await supabaseClient
                .from('whatsapp_sync_logs')
                .select('*')
                .order('started_at', { ascending: false })
                .limit(20);

            // Update stats
            const { data: statsData } = await supabaseClient
                .from('whatsapp_messages')
                .select('synced_by, id', { count: 'exact' });

            // Count by user
            const countByUser = { tomek: 0, maciek: 0 };
            (statsData || []).forEach(msg => {
                const user = (msg.synced_by || '').toLowerCase();
                if (countByUser[user] !== undefined) {
                    countByUser[user]++;
                }
            });

            document.getElementById('stat-total-syncs').textContent = (logs || []).length;
            document.getElementById('stat-total-messages').textContent = (statsData || []).length;
            document.getElementById('stat-tomek').textContent = countByUser.tomek;
            document.getElementById('stat-maciek').textContent = countByUser.maciek;

            if (error || !logs || logs.length === 0) {
                // Fallback - pokaż ostatnie synchronizacje z whatsapp_messages
                const { data: recentMessages } = await supabaseClient
                    .from('whatsapp_messages')
                    .select('synced_at, synced_by, phone_number, contact_name')
                    .order('synced_at', { ascending: false })
                    .limit(50);

                if (!recentMessages || recentMessages.length === 0) {
                    container.innerHTML = `
                        <div class="py-12 text-center text-zinc-500">
                            <i class="ph ph-empty text-3xl mb-2"></i>
                            <p>Brak historii synchronizacji</p>
                            <p class="text-xs text-zinc-600 mt-1">Uruchom widget Chrome aby zaczac synchronizowac</p>
                        </div>
                    `;
                    return;
                }

                // Grupuj po synced_at (okraglonego do minuty)
                const grouped = {};
                recentMessages.forEach(msg => {
                    const key = new Date(msg.synced_at).toISOString().substring(0, 16);
                    if (!grouped[key]) {
                        grouped[key] = {
                            time: msg.synced_at,
                            synced_by: msg.synced_by,
                            phones: new Set(),
                            count: 0
                        };
                    }
                    grouped[key].phones.add(msg.phone_number);
                    grouped[key].count++;
                });

                const entries = Object.values(grouped).sort((a, b) => new Date(b.time) - new Date(a.time));

                container.innerHTML = entries.slice(0, 15).map(entry => {
                    const userBadge = entry.synced_by
                        ? `<span class="px-2 py-0.5 rounded text-[10px] border ${entry.synced_by.toLowerCase() === 'tomek' ? 'user-badge-tomek' : 'user-badge-maciek'}">${entry.synced_by}</span>`
                        : '';

                    return `
                        <div class="log-entry rounded-lg p-4 animate-enter">
                            <div class="flex items-start justify-between mb-2">
                                <div class="flex items-center gap-2">
                                    <i class="ph ph-check-circle text-[#25D366]"></i>
                                    <span class="text-white font-medium">Synchronizacja</span>
                                    ${userBadge}
                                </div>
                                <span class="text-xs text-zinc-500">${formatTimeAgo(new Date(entry.time))}</span>
                            </div>
                            <div class="text-xs text-zinc-400">
                                ${entry.count} wiadomosci z ${entry.phones.size} czatow
                            </div>
                        </div>
                    `;
                }).join('');
                return;
            }

            // Render logs from table
            container.innerHTML = logs.map(log => {
                const statusIcon = log.status === 'completed' ? 'ph-check-circle text-[#25D366]'
                    : log.status === 'failed' ? 'ph-x-circle text-red-400'
                    : 'ph-circle-notch text-amber-400 animate-spin';

                const typeLabel = {
                    all_chats: 'Wszystkie czaty',
                    single_chat: 'Pojedynczy czat',
                    deep_sync: 'Deep sync',
                    scheduled: 'Zaplanowany'
                }[log.sync_type] || log.sync_type;

                const userBadge = log.synced_by
                    ? `<span class="px-2 py-0.5 rounded text-[10px] border ${log.synced_by.toLowerCase() === 'tomek' ? 'user-badge-tomek' : 'user-badge-maciek'}">${log.synced_by}</span>`
                    : '';

                const phonesAffected = log.phones_affected || [];
                const duration = log.completed_at && log.started_at
                    ? Math.round((new Date(log.completed_at) - new Date(log.started_at)) / 1000)
                    : null;

                return `
                    <div class="log-entry rounded-lg p-4 animate-enter">
                        <div class="flex items-start justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <i class="ph ${statusIcon}"></i>
                                <span class="text-white font-medium">${typeLabel}</span>
                                ${userBadge}
                            </div>
                            <span class="text-xs text-zinc-500">${formatTimeAgo(new Date(log.started_at))}</span>
                        </div>
                        <div class="flex flex-wrap gap-3 text-xs text-zinc-400">
                            ${log.total_inserted ? `<span class="text-[#25D366]">+${log.total_inserted} nowych</span>` : ''}
                            ${log.total_skipped ? `<span>${log.total_skipped} pominiete</span>` : ''}
                            ${log.chats_processed ? `<span>${log.chats_processed} czatow</span>` : ''}
                            ${duration ? `<span>${duration}s</span>` : ''}
                        </div>
                        ${phonesAffected.length > 0 ? `
                            <div class="mt-2 flex flex-wrap gap-1">
                                ${phonesAffected.slice(0, 5).map(p => `
                                    <span class="text-[10px] px-1.5 py-0.5 bg-white/5 text-zinc-400 rounded font-mono">${p}</span>
                                `).join('')}
                                ${phonesAffected.length > 5 ? `<span class="text-[10px] text-zinc-500">+${phonesAffected.length - 5} wiecej</span>` : ''}
                            </div>
                        ` : ''}
                        ${log.error_message ? `
                            <div class="mt-2 text-xs text-red-400">${log.error_message}</div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // Leads activity
        async function loadLeadsActivity() {
            const container = document.getElementById('leads-activity');

            // Pobierz ostatnie wiadomosci pogrupowane po lead
            const { data: conversations } = await supabaseClient
                .from('whatsapp_conversations')
                .select('*')
                .order('last_message_at', { ascending: false })
                .limit(20);

            if (!conversations || conversations.length === 0) {
                container.innerHTML = `
                    <div class="py-8 text-center text-zinc-500 text-xs">
                        Brak danych o konwersacjach
                    </div>
                `;
                return;
            }

            container.innerHTML = conversations.map(conv => {
                const hasLead = !!conv.lead_id;
                const statusBadge = conv.lead_status
                    ? `<span class="text-[10px] px-1.5 py-0.5 rounded ${getStatusColor(conv.lead_status)}">${conv.lead_status}</span>`
                    : '';

                return `
                    <div class="flex items-center gap-3 p-3 rounded-lg hover:bg-white/5 transition-colors">
                        <div class="w-10 h-10 rounded-full bg-[#25D366]/10 flex items-center justify-center text-[#25D366] font-medium">
                            ${(conv.contact_name || conv.phone_number || '?').charAt(0).toUpperCase()}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2">
                                <span class="text-white font-medium truncate">${conv.contact_name || conv.phone_number}</span>
                                ${statusBadge}
                            </div>
                            <div class="text-xs text-zinc-500">
                                ${conv.message_count} wiadomosci
                                (${conv.inbound_count} przychodzacych, ${conv.outbound_count} wychodzacych)
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-zinc-400">${formatTimeAgo(new Date(conv.last_message_at))}</div>
                            ${hasLead ? `
                                <a href="/lead?id=${conv.lead_id}" class="text-[10px] text-[#25D366] hover:underline">Zobacz lead</a>
                            ` : `
                                <span class="text-[10px] text-zinc-600">Brak leada</span>
                            `}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ============================================
        // HELPERS
        // ============================================
        function formatTimeAgo(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / (1000 * 60));
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));

            if (minutes < 1) return 'teraz';
            if (minutes < 60) return `${minutes}m temu`;
            if (hours < 24) return `${hours}h temu`;
            if (days === 1) return 'wczoraj';
            if (days < 7) return `${days} dni temu`;
            return date.toLocaleDateString('pl-PL');
        }

        function getStatusColor(status) {
            const colors = {
                new: 'bg-emerald-500/20 text-emerald-400',
                contacted: 'bg-blue-500/20 text-blue-400',
                qualified: 'bg-amber-500/20 text-amber-400',
                proposal: 'bg-violet-500/20 text-violet-400',
                negotiation: 'bg-pink-500/20 text-pink-400',
                won: 'bg-green-500/20 text-green-400',
                lost: 'bg-red-500/20 text-red-400'
            };
            return colors[status] || 'bg-zinc-500/20 text-zinc-400';
        }

        function showToast(text) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-text').textContent = text;
            toast.classList.remove('opacity-0', 'invisible', 'translate-y-2');
            toast.classList.add('opacity-100', 'visible', 'translate-y-0');

            setTimeout(() => {
                toast.classList.add('opacity-0', 'invisible', 'translate-y-2');
                toast.classList.remove('opacity-100', 'visible', 'translate-y-0');
            }, 3000);
        }

        // ============================================
        // INIT
        // ============================================
        async function init() {
            const session = await checkAuth();
            if (session) {
                await loadData();
            }
        }

        init();

        // Auto-refresh every 30s
        setInterval(loadData, 30000);

        // Register service worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').catch(() => {});
        }
    </script>
</body>
</html>
