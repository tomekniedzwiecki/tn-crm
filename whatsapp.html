<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TN CRM - WhatsApp</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#050505">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="/components/shared-sidebar.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    }
                }
            }
        }
    </script>
    <style>
        body { background: #050505; color: #e5e5e5; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::selection { background: white; color: black; }

        .glass-header {
            background: rgba(5, 5, 5, 0.8);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }

        .conversation-row {
            transition: all 0.15s ease;
        }
        .conversation-row:hover {
            background: rgba(255,255,255,0.03);
        }
        .conversation-row.selected {
            background: rgba(37, 211, 102, 0.08);
            border-color: rgba(37, 211, 102, 0.2);
        }

        .message-bubble {
            max-width: 75%;
        }
        .message-inbound {
            background: #1f2937;
            border-radius: 12px 12px 12px 4px;
        }
        .message-outbound {
            background: #065f46;
            border-radius: 12px 12px 4px 12px;
        }

        .stat-pill {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.06);
        }

        .badge-tomek { background: rgba(59, 130, 246, 0.15); color: #60a5fa; }
        .badge-maciek { background: rgba(168, 85, 247, 0.15); color: #c084fc; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(4px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-in { animation: fadeIn 0.2s ease-out; }

        .empty-state {
            background: linear-gradient(135deg, rgba(37, 211, 102, 0.03) 0%, transparent 50%);
        }
    </style>
</head>
<body class="h-screen flex overflow-hidden font-sans text-sm antialiased">

    <!-- Sidebar -->
    <aside id="sidebar" class="w-[280px] bg-zinc-950 border-r border-white/5 flex flex-col flex-shrink-0"></aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col min-w-0">
        <!-- Header -->
        <header class="h-14 glass-header flex items-center justify-between px-4 md:px-6 flex-shrink-0">
            <div class="flex items-center gap-3">
                <button onclick="Sidebar.toggle()" class="mobile-menu-btn hidden items-center justify-center w-9 h-9 rounded-lg hover:bg-white/5 text-zinc-400">
                    <i class="ph ph-list text-xl"></i>
                </button>
                <div class="flex items-center gap-2">
                    <i class="ph ph-whatsapp-logo text-[#25D366] text-xl"></i>
                    <span class="text-white font-semibold">WhatsApp</span>
                    <span class="text-zinc-600 text-xs font-mono" id="total-count">-</span>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <div class="relative">
                    <i class="ph ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-zinc-500"></i>
                    <input type="text" id="search-input" placeholder="Szukaj..."
                        class="w-48 bg-zinc-900 border border-zinc-800 rounded-lg pl-9 pr-3 py-1.5 text-sm focus:outline-none focus:border-zinc-700 placeholder:text-zinc-600">
                </div>
                <button onclick="loadData()" class="p-2 text-zinc-400 hover:text-white hover:bg-white/5 rounded-lg transition-colors" title="Odswiez">
                    <i class="ph ph-arrows-clockwise"></i>
                </button>
                <a href="/whatsapp-logs" class="p-2 text-zinc-400 hover:text-white hover:bg-white/5 rounded-lg transition-colors" title="Logi synchronizacji">
                    <i class="ph ph-clock-counter-clockwise"></i>
                </a>
            </div>
        </header>

        <!-- Stats Bar -->
        <div class="px-4 md:px-6 py-3 border-b border-white/5 flex items-center gap-3 overflow-x-auto flex-shrink-0">
            <div class="stat-pill px-3 py-1.5 rounded-lg flex items-center gap-2 text-xs whitespace-nowrap">
                <span class="text-zinc-500">Konwersacji:</span>
                <span class="text-white font-semibold font-mono" id="stat-conversations">-</span>
            </div>
            <div class="stat-pill px-3 py-1.5 rounded-lg flex items-center gap-2 text-xs whitespace-nowrap">
                <span class="text-zinc-500">Wiadomosci:</span>
                <span class="text-[#25D366] font-semibold font-mono" id="stat-messages">-</span>
            </div>
            <div class="stat-pill px-3 py-1.5 rounded-lg flex items-center gap-2 text-xs whitespace-nowrap">
                <span class="text-zinc-500">Z leadem:</span>
                <span class="text-emerald-400 font-semibold font-mono" id="stat-with-lead">-</span>
            </div>
            <div class="stat-pill px-3 py-1.5 rounded-lg flex items-center gap-2 text-xs whitespace-nowrap">
                <span class="text-zinc-500">Bez leada:</span>
                <span class="text-amber-400 font-semibold font-mono" id="stat-without-lead">-</span>
            </div>
            <div class="ml-auto flex items-center gap-2">
                <button onclick="filterBy('all')" class="filter-btn px-2 py-1 text-xs rounded transition-colors text-zinc-400 hover:text-white" data-filter="all">Wszystkie</button>
                <button onclick="filterBy('with-lead')" class="filter-btn px-2 py-1 text-xs rounded transition-colors text-zinc-400 hover:text-white" data-filter="with-lead">Z leadem</button>
                <button onclick="filterBy('no-lead')" class="filter-btn px-2 py-1 text-xs rounded transition-colors text-zinc-400 hover:text-white" data-filter="no-lead">Bez leada</button>
            </div>
        </div>

        <!-- Two Column Layout -->
        <div class="flex-1 flex overflow-hidden">
            <!-- Conversations List -->
            <div class="w-[380px] border-r border-white/5 flex flex-col overflow-hidden flex-shrink-0">
                <div id="conversations-list" class="flex-1 overflow-y-auto">
                    <!-- Loading -->
                    <div id="loading-state" class="flex items-center justify-center h-full">
                        <div class="text-center">
                            <div class="w-8 h-8 mx-auto mb-3 border-2 border-zinc-700 border-t-[#25D366] rounded-full animate-spin"></div>
                            <p class="text-zinc-500 text-sm">Laduje konwersacje...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat Detail -->
            <div class="flex-1 flex flex-col overflow-hidden bg-zinc-950/50">
                <div id="chat-detail" class="flex-1 flex items-center justify-center">
                    <div class="text-center empty-state p-12 rounded-2xl">
                        <i class="ph ph-chats-circle text-5xl text-zinc-700 mb-4"></i>
                        <p class="text-zinc-500">Wybierz konwersacje z listy</p>
                        <p class="text-zinc-600 text-xs mt-1">aby zobaczyc historie wiadomosci</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-6 right-6 bg-zinc-800 border border-white/10 text-white px-4 py-3 rounded-lg shadow-xl z-50 flex items-center gap-2 opacity-0 invisible transition-all duration-300 transform translate-y-2">
        <i class="ph ph-check-circle text-emerald-400"></i>
        <span id="toast-text"></span>
    </div>

    <script>
        const SUPABASE_URL = 'https://yxmavwkwnfuphjqbelws.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl4bWF2d2t3bmZ1cGhqcWJlbHdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NjQyNTUsImV4cCI6MjA4NDM0MDI1NX0.XeR0Fc7OFn6YbNJrOKTBEj36JtmLISZTM87y4ai9340';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let conversations = [];
        let allMessages = [];
        let currentFilter = 'all';
        let searchQuery = '';
        let selectedPhone = null;

        Sidebar.render();
        Sidebar.setupLogout(supabaseClient);

        // ============================================
        // AUTH
        // ============================================
        async function checkAuth() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
                window.location.href = Sidebar.getLoginPath();
                return null;
            }
            Sidebar.setUserEmail(session.user.email.split('@')[0]);
            await loadTeamMembers(session.user.id);
            return session;
        }

        async function loadTeamMembers(userId) {
            const { data } = await supabaseClient.from('team_members').select('*');
            const currentMember = (data || []).find(m => m.user_id === userId);
            if (currentMember) {
                Sidebar.setUserName(currentMember.name);
                Sidebar.setUserColor(currentMember.color);
                Sidebar.setupProfileClick();
            }
            Sidebar.showAdminNav(currentMember?.role === 'admin');
        }

        // ============================================
        // DATA LOADING
        // ============================================
        async function loadData() {
            await Promise.all([
                loadConversations(),
                loadAllMessages()
            ]);
            renderConversations();
            updateStats();
        }

        async function loadConversations() {
            const { data, error } = await supabaseClient
                .from('whatsapp_conversations')
                .select('*')
                .order('last_message_at', { ascending: false });

            if (error) {
                console.error('Error loading conversations:', error);
                return;
            }

            conversations = data || [];
        }

        async function loadAllMessages() {
            const { data, error } = await supabaseClient
                .from('whatsapp_messages')
                .select('*')
                .order('message_timestamp', { ascending: false })
                .limit(5000);

            if (error) {
                console.error('Error loading messages:', error);
                return;
            }

            allMessages = data || [];
        }

        // ============================================
        // RENDERING
        // ============================================
        function renderConversations() {
            const container = document.getElementById('conversations-list');
            document.getElementById('loading-state')?.remove();

            let filtered = conversations;

            // Apply filter
            if (currentFilter === 'with-lead') {
                filtered = filtered.filter(c => c.lead_id);
            } else if (currentFilter === 'no-lead') {
                filtered = filtered.filter(c => !c.lead_id);
            }

            // Apply search
            if (searchQuery) {
                const q = searchQuery.toLowerCase();
                filtered = filtered.filter(c =>
                    (c.contact_name || '').toLowerCase().includes(q) ||
                    (c.phone_number || '').includes(q) ||
                    (c.lead_name || '').toLowerCase().includes(q)
                );
            }

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="flex items-center justify-center h-full">
                        <div class="text-center p-8">
                            <i class="ph ph-chats-circle text-4xl text-zinc-700 mb-3"></i>
                            <p class="text-zinc-500">Brak konwersacji</p>
                            <p class="text-zinc-600 text-xs mt-1">Uruchom rozszerzenie Chrome aby synchronizowac</p>
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = filtered.map(conv => {
                const isSelected = selectedPhone === conv.phone_number;
                const hasLead = !!conv.lead_id;
                const lastMsg = getLastMessage(conv.phone_number);
                const lastMsgPreview = lastMsg ? truncate(lastMsg.message_text, 50) : '';
                const lastMsgTime = conv.last_message_at ? formatTimeAgo(new Date(conv.last_message_at)) : '';

                return `
                    <div class="conversation-row p-3 border-b border-white/5 cursor-pointer ${isSelected ? 'selected' : ''}"
                         onclick="selectConversation('${conv.phone_number}')">
                        <div class="flex items-start gap-3">
                            <div class="w-10 h-10 rounded-full bg-[#25D366]/10 flex items-center justify-center text-[#25D366] font-medium flex-shrink-0">
                                ${(conv.contact_name || conv.phone_number || '?').charAt(0).toUpperCase()}
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center justify-between gap-2">
                                    <span class="text-white font-medium truncate">${conv.contact_name || 'Nieznany'}</span>
                                    <span class="text-[10px] text-zinc-500 flex-shrink-0">${lastMsgTime}</span>
                                </div>
                                <div class="text-xs text-zinc-500 font-mono">${conv.phone_number || '-'}</div>
                                <div class="flex items-center gap-2 mt-1">
                                    ${hasLead ? `
                                        <span class="text-[10px] px-1.5 py-0.5 bg-emerald-500/15 text-emerald-400 rounded flex items-center gap-1">
                                            <i class="ph ph-user"></i>
                                            ${conv.lead_name || 'Lead'}
                                        </span>
                                    ` : `
                                        <span class="text-[10px] px-1.5 py-0.5 bg-amber-500/10 text-amber-500/70 rounded">
                                            Brak leada
                                        </span>
                                    `}
                                    <span class="text-[10px] text-zinc-600">${conv.message_count} wiad.</span>
                                </div>
                                ${lastMsgPreview ? `
                                    <div class="text-xs text-zinc-500 mt-1 truncate">${lastMsgPreview}</div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderChatDetail(phoneNumber) {
            const container = document.getElementById('chat-detail');
            const conv = conversations.find(c => c.phone_number === phoneNumber);

            if (!conv) {
                container.innerHTML = `<div class="flex items-center justify-center h-full text-zinc-500">Nie znaleziono konwersacji</div>`;
                return;
            }

            const messages = allMessages
                .filter(m => m.phone_number === phoneNumber)
                .sort((a, b) => new Date(a.message_timestamp) - new Date(b.message_timestamp));

            const hasLead = !!conv.lead_id;
            const whatsappLink = `https://web.whatsapp.com/send?phone=${phoneNumber}`;

            container.innerHTML = `
                <div class="flex flex-col h-full">
                    <!-- Chat Header -->
                    <div class="p-4 border-b border-white/5 flex items-center justify-between flex-shrink-0">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-[#25D366]/10 flex items-center justify-center text-[#25D366] font-medium">
                                ${(conv.contact_name || '?').charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <div class="text-white font-medium">${conv.contact_name || 'Nieznany'}</div>
                                <div class="text-xs text-zinc-500 font-mono">${phoneNumber}</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            ${hasLead ? `
                                <a href="/lead?id=${conv.lead_id}" class="px-3 py-1.5 bg-emerald-500/15 text-emerald-400 text-xs rounded-lg hover:bg-emerald-500/25 transition-colors flex items-center gap-1.5">
                                    <i class="ph ph-user"></i>
                                    Otwórz Lead
                                </a>
                            ` : `
                                <button onclick="createLead('${phoneNumber}', '${(conv.contact_name || '').replace(/'/g, "\\'")}', '${conv.lead_email || ''}')"
                                    class="px-3 py-1.5 bg-amber-500/15 text-amber-400 text-xs rounded-lg hover:bg-amber-500/25 transition-colors flex items-center gap-1.5">
                                    <i class="ph ph-user-plus"></i>
                                    Utwórz Lead
                                </button>
                            `}
                            <a href="${whatsappLink}" target="_blank" class="px-3 py-1.5 bg-[#25D366]/15 text-[#25D366] text-xs rounded-lg hover:bg-[#25D366]/25 transition-colors flex items-center gap-1.5">
                                <i class="ph ph-whatsapp-logo"></i>
                                Otwórz WhatsApp
                            </a>
                        </div>
                    </div>

                    <!-- Messages -->
                    <div class="flex-1 overflow-y-auto p-4 space-y-3" id="messages-container">
                        ${messages.length === 0 ? `
                            <div class="text-center text-zinc-500 py-12">
                                <i class="ph ph-chat-circle-dots text-3xl mb-2"></i>
                                <p>Brak wiadomosci</p>
                            </div>
                        ` : messages.map(msg => {
                            const isOutbound = msg.direction === 'outbound';
                            const time = new Date(msg.message_timestamp).toLocaleString('pl-PL', {
                                day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'
                            });

                            return `
                                <div class="flex ${isOutbound ? 'justify-end' : 'justify-start'} animate-in">
                                    <div class="message-bubble ${isOutbound ? 'message-outbound' : 'message-inbound'} px-3 py-2">
                                        <div class="text-sm text-white whitespace-pre-wrap break-words">${escapeHtml(msg.message_text)}</div>
                                        <div class="text-[10px] ${isOutbound ? 'text-emerald-300/60' : 'text-zinc-500'} mt-1 text-right">${time}</div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>

                    <!-- Footer Info -->
                    <div class="p-3 border-t border-white/5 text-xs text-zinc-500 flex items-center justify-between flex-shrink-0">
                        <div class="flex items-center gap-4">
                            <span><i class="ph ph-arrow-down text-blue-400"></i> ${conv.inbound_count || 0} przychodzacych</span>
                            <span><i class="ph ph-arrow-up text-emerald-400"></i> ${conv.outbound_count || 0} wychodzacych</span>
                        </div>
                        <div>
                            ${conv.lead_status ? `<span class="px-2 py-0.5 rounded ${getStatusColor(conv.lead_status)}">${conv.lead_status}</span>` : ''}
                        </div>
                    </div>
                </div>
            `;

            // Scroll to bottom
            setTimeout(() => {
                const msgContainer = document.getElementById('messages-container');
                if (msgContainer) msgContainer.scrollTop = msgContainer.scrollHeight;
            }, 50);
        }

        function selectConversation(phoneNumber) {
            selectedPhone = phoneNumber;
            renderConversations();
            renderChatDetail(phoneNumber);
        }

        // ============================================
        // ACTIONS
        // ============================================
        async function createLead(phone, name, email) {
            const leadData = {
                phone: phone,
                name: name || 'WhatsApp: ' + phone,
                email: email || null,
                source: 'whatsapp',
                status: 'new'
            };

            const { data, error } = await supabaseClient
                .from('leads')
                .insert([leadData])
                .select()
                .single();

            if (error) {
                showToast('Blad tworzenia leada: ' + error.message);
                return;
            }

            showToast('Lead utworzony!');

            // Update messages to link to this lead
            await supabaseClient
                .from('whatsapp_messages')
                .update({ lead_id: data.id })
                .eq('phone_number', phone);

            // Reload
            await loadData();
            if (selectedPhone === phone) {
                renderChatDetail(phone);
            }
        }

        function filterBy(filter) {
            currentFilter = filter;

            // Update button styles
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('bg-white/10', 'text-white');
                btn.classList.add('text-zinc-400');
            });
            document.querySelector(`[data-filter="${filter}"]`)?.classList.add('bg-white/10', 'text-white');
            document.querySelector(`[data-filter="${filter}"]`)?.classList.remove('text-zinc-400');

            renderConversations();
        }

        // ============================================
        // HELPERS
        // ============================================
        function getLastMessage(phoneNumber) {
            return allMessages.find(m => m.phone_number === phoneNumber);
        }

        function updateStats() {
            const total = conversations.length;
            const withLead = conversations.filter(c => c.lead_id).length;
            const withoutLead = total - withLead;
            const totalMessages = allMessages.length;

            document.getElementById('total-count').textContent = `(${total})`;
            document.getElementById('stat-conversations').textContent = total;
            document.getElementById('stat-messages').textContent = totalMessages;
            document.getElementById('stat-with-lead').textContent = withLead;
            document.getElementById('stat-without-lead').textContent = withoutLead;
        }

        function formatTimeAgo(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / (1000 * 60));
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));

            if (minutes < 1) return 'teraz';
            if (minutes < 60) return `${minutes}m`;
            if (hours < 24) return `${hours}h`;
            if (days === 1) return 'wczoraj';
            if (days < 7) return `${days}d`;
            return date.toLocaleDateString('pl-PL', { day: '2-digit', month: '2-digit' });
        }

        function truncate(str, len) {
            if (!str) return '';
            return str.length > len ? str.substring(0, len) + '...' : str;
        }

        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        function getStatusColor(status) {
            const colors = {
                new: 'bg-emerald-500/20 text-emerald-400',
                contacted: 'bg-blue-500/20 text-blue-400',
                qualified: 'bg-amber-500/20 text-amber-400',
                proposal: 'bg-violet-500/20 text-violet-400',
                won: 'bg-green-500/20 text-green-400',
                lost: 'bg-red-500/20 text-red-400'
            };
            return colors[status] || 'bg-zinc-500/20 text-zinc-400';
        }

        function showToast(text) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-text').textContent = text;
            toast.classList.remove('opacity-0', 'invisible', 'translate-y-2');
            toast.classList.add('opacity-100', 'visible', 'translate-y-0');
            setTimeout(() => {
                toast.classList.add('opacity-0', 'invisible', 'translate-y-2');
                toast.classList.remove('opacity-100', 'visible', 'translate-y-0');
            }, 3000);
        }

        // ============================================
        // SEARCH
        // ============================================
        document.getElementById('search-input').addEventListener('input', (e) => {
            searchQuery = e.target.value;
            renderConversations();
        });

        // ============================================
        // INIT
        // ============================================
        async function init() {
            const session = await checkAuth();
            if (session) {
                filterBy('all'); // Set default filter
                await loadData();
            }
        }

        init();

        // Auto-refresh every 60s
        setInterval(loadData, 60000);
    </script>
</body>
</html>
