<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TN CRM - WhatsApp</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#050505">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="/components/shared-sidebar.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    }
                }
            }
        }
    </script>
    <style>
        body { background: #000; color: #ededed; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #444; }
        ::selection { background: #fff; color: #000; }

        .glass-header {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid #1a1a1a;
        }

        .conversation-row {
            transition: background 0.1s ease;
        }
        .conversation-row:hover {
            background: #111;
        }
        .conversation-row.selected {
            background: #111;
        }

        .stat-pill {
            background: transparent;
            border: 1px solid #222;
        }

        .msg-in {
            background: #1a1a1a;
        }
        .msg-out {
            background: #0c1f17;
            border: 1px solid #14532d;
        }
    </style>
</head>
<body class="h-screen flex overflow-hidden font-sans text-sm antialiased">

    <!-- Sidebar -->
    <aside id="sidebar" class="w-[280px] bg-zinc-950 border-r border-white/5 flex flex-col flex-shrink-0"></aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col min-w-0 h-screen">
        <!-- Header -->
        <header class="h-12 px-4 md:px-6 flex items-center justify-between flex-shrink-0 border-b border-[#1a1a1a] bg-black">
            <div class="flex items-center gap-3">
                <button onclick="Sidebar.toggle()" class="mobile-menu-btn hidden items-center justify-center w-8 h-8 rounded-md hover:bg-[#1a1a1a] text-zinc-500">
                    <i class="ph ph-list text-lg"></i>
                </button>
                <div class="flex items-center gap-2">
                    <span class="text-white text-sm font-medium">WhatsApp</span>
                    <span class="text-zinc-600 text-[11px] font-mono" id="total-count">-</span>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <div class="relative">
                    <i class="ph ph-magnifying-glass absolute left-2.5 top-1/2 -translate-y-1/2 text-zinc-600 text-sm"></i>
                    <input type="text" id="search-input" placeholder="Szukaj..."
                        class="h-8 w-44 bg-[#0a0a0a] border border-[#222] rounded-md pl-8 pr-3 text-[13px] focus:outline-none focus:border-[#333] placeholder:text-zinc-700">
                </div>
                <button onclick="loadData()" class="w-8 h-8 flex items-center justify-center text-zinc-500 hover:text-white hover:bg-[#1a1a1a] rounded-md transition-colors" title="Odswiez">
                    <i class="ph ph-arrows-clockwise text-sm"></i>
                </button>
            </div>
        </header>

        <!-- Stats Bar -->
        <div class="h-10 px-4 md:px-6 border-b border-[#1a1a1a] flex items-center gap-4 flex-shrink-0 bg-black">
            <div class="flex items-center gap-4 text-[11px]">
                <span class="text-zinc-500">Konwersacji: <span class="text-white font-mono" id="stat-conversations">-</span></span>
                <span class="text-zinc-600">|</span>
                <span class="text-zinc-500">Z leadem: <span class="text-zinc-300 font-mono" id="stat-with-lead">-</span></span>
                <span class="text-zinc-500">Bez leada: <span class="text-zinc-500 font-mono" id="stat-without-lead">-</span></span>
            </div>
            <div class="ml-auto flex items-center gap-1">
                <button onclick="filterBy('all')" class="filter-btn h-7 px-2.5 text-[11px] rounded-md transition-colors text-zinc-500 hover:text-white hover:bg-[#1a1a1a]" data-filter="all">Wszystkie</button>
                <button onclick="filterBy('with-lead')" class="filter-btn h-7 px-2.5 text-[11px] rounded-md transition-colors text-zinc-500 hover:text-white hover:bg-[#1a1a1a]" data-filter="with-lead">Z leadem</button>
                <button onclick="filterBy('no-lead')" class="filter-btn h-7 px-2.5 text-[11px] rounded-md transition-colors text-zinc-500 hover:text-white hover:bg-[#1a1a1a]" data-filter="no-lead">Bez leada</button>
            </div>
        </div>

        <!-- Two Column Layout -->
        <div class="flex-1 flex min-h-0">
            <!-- Conversations List -->
            <div class="w-[320px] border-r border-[#1a1a1a] flex flex-col min-h-0 flex-shrink-0 bg-black">
                <div id="conversations-list" class="flex-1 overflow-y-auto">
                    <!-- Loading -->
                    <div id="loading-state" class="flex items-center justify-center h-full">
                        <div class="text-center">
                            <div class="w-5 h-5 mx-auto mb-2 border-2 border-zinc-800 border-t-zinc-400 rounded-full animate-spin"></div>
                            <p class="text-zinc-600 text-[11px]">Ladowanie...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat Detail -->
            <div id="chat-detail" class="flex-1 flex flex-col min-h-0 bg-black">
                <div class="flex-1 flex items-center justify-center">
                    <div class="text-center">
                        <i class="ph ph-chats-circle text-5xl text-zinc-800 mb-3"></i>
                        <p class="text-zinc-500">Wybierz konwersacje</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-6 right-6 bg-zinc-800 border border-white/10 text-white px-4 py-3 rounded-lg shadow-xl z-50 flex items-center gap-2 opacity-0 invisible transition-all duration-300 transform translate-y-2">
        <i class="ph ph-check-circle text-emerald-400"></i>
        <span id="toast-text"></span>
    </div>

    <script>
        const SUPABASE_URL = 'https://yxmavwkwnfuphjqbelws.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl4bWF2d2t3bmZ1cGhqcWJlbHdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NjQyNTUsImV4cCI6MjA4NDM0MDI1NX0.XeR0Fc7OFn6YbNJrOKTBEj36JtmLISZTM87y4ai9340';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let conversations = [];
        let allMessages = [];
        let currentFilter = 'all';
        let searchQuery = '';
        let selectedPhone = null;

        Sidebar.render();
        Sidebar.setupLogout(supabaseClient);

        // ============================================
        // AUTH
        // ============================================
        async function checkAuth() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
                window.location.href = Sidebar.getLoginPath();
                return null;
            }
            Sidebar.setUserEmail(session.user.email.split('@')[0]);
            await loadTeamMembers(session.user.id);
            return session;
        }

        async function loadTeamMembers(userId) {
            const { data } = await supabaseClient.from('team_members').select('*');
            const currentMember = (data || []).find(m => m.user_id === userId);
            if (currentMember) {
                Sidebar.setUserName(currentMember.name);
                Sidebar.setUserColor(currentMember.color);
                Sidebar.setupProfileClick();
            }
            Sidebar.showAdminNav(currentMember?.role === 'admin');
        }

        // ============================================
        // DATA LOADING
        // ============================================
        async function loadData() {
            await Promise.all([
                loadConversations(),
                loadAllMessages()
            ]);
            renderConversations();
            updateStats();

            // Re-render selected chat if any
            if (selectedPhone) {
                await renderChatDetail(selectedPhone);
            }
        }

        async function loadConversations() {
            const { data, error } = await supabaseClient
                .from('whatsapp_conversations')
                .select('*')
                .order('last_message_at', { ascending: false });

            if (error) {
                console.error('Error loading conversations:', error);
                return;
            }

            conversations = data || [];
        }

        async function loadAllMessages() {
            // Ładujemy tylko ostatnie wiadomości do podglądu w liście konwersacji
            const { data, error } = await supabaseClient
                .from('whatsapp_messages')
                .select('*')
                .order('message_timestamp', { ascending: false })
                .limit(5000);

            if (error) {
                console.error('Error loading messages:', error);
                return;
            }

            allMessages = data || [];
        }

        // Ładuj wiadomości dla konkretnej konwersacji (bez limitu)
        async function loadMessagesForPhone(phoneNumber) {
            const { data, error } = await supabaseClient
                .from('whatsapp_messages')
                .select('*')
                .eq('phone_number', phoneNumber)
                .order('message_timestamp', { ascending: true });

            if (error) {
                console.error('Error loading messages for phone:', error);
                return [];
            }

            return data || [];
        }

        // ============================================
        // RENDERING
        // ============================================
        function renderConversations() {
            const container = document.getElementById('conversations-list');
            document.getElementById('loading-state')?.remove();

            let filtered = conversations;

            // Apply filter
            if (currentFilter === 'with-lead') {
                filtered = filtered.filter(c => c.lead_id);
            } else if (currentFilter === 'no-lead') {
                filtered = filtered.filter(c => !c.lead_id);
            }

            // Apply search
            if (searchQuery) {
                const q = searchQuery.toLowerCase();
                filtered = filtered.filter(c =>
                    (c.contact_name || '').toLowerCase().includes(q) ||
                    (c.phone_number || '').includes(q) ||
                    (c.lead_name || '').toLowerCase().includes(q)
                );
            }

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="flex items-center justify-center h-full">
                        <p class="text-zinc-600 text-[11px]">Brak konwersacji</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filtered.map(conv => {
                const isSelected = selectedPhone === conv.phone_number;
                const hasLead = !!conv.lead_id;
                const lastMsg = getLastMessage(conv.phone_number);
                const lastMsgPreview = lastMsg ? truncate(lastMsg.message_text, 35) : '';
                const lastMsgTime = conv.last_message_at ? formatTimeAgo(new Date(conv.last_message_at)) : '';

                return `
                    <div class="conversation-row px-3 py-2.5 cursor-pointer border-b border-[#111] ${isSelected ? 'selected' : ''}"
                         onclick="selectConversation('${conv.phone_number}')">
                        <div class="flex items-center gap-2.5">
                            <div class="w-8 h-8 rounded-full bg-[#1a1a1a] flex items-center justify-center text-zinc-500 text-xs font-medium flex-shrink-0">
                                ${(conv.contact_name || conv.phone_number || '?').charAt(0).toUpperCase()}
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center justify-between gap-2">
                                    <span class="text-[13px] text-zinc-200 truncate">${conv.contact_name || 'Nieznany'}</span>
                                    <span class="text-[10px] text-zinc-600 flex-shrink-0">${lastMsgTime}</span>
                                </div>
                                <div class="flex items-center gap-2 mt-0.5">
                                    ${hasLead ? `
                                        <span class="text-[10px] text-zinc-500">${conv.lead_name || 'Lead'}</span>
                                    ` : `
                                        <span class="text-[10px] text-zinc-700">Brak leada</span>
                                    `}
                                    <span class="text-[10px] text-zinc-700">${conv.message_count}</span>
                                </div>
                                ${lastMsgPreview ? `
                                    <div class="text-[11px] text-zinc-600 mt-1 truncate">${escapeHtml(lastMsgPreview)}</div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function renderChatDetail(phoneNumber) {
            const container = document.getElementById('chat-detail');
            const conv = conversations.find(c => c.phone_number === phoneNumber);

            if (!conv) {
                container.innerHTML = `<div class="flex-1 flex items-center justify-center text-zinc-500">Nie znaleziono konwersacji</div>`;
                return;
            }

            // Pokaż loading
            container.innerHTML = `
                <div class="flex-1 flex items-center justify-center bg-black">
                    <div class="w-5 h-5 border-2 border-zinc-800 border-t-zinc-400 rounded-full animate-spin"></div>
                </div>
            `;

            // Pobierz wiadomości dla tej konwersacji (bez limitu)
            const messages = await loadMessagesForPhone(phoneNumber);

            const hasLead = !!conv.lead_id;
            const whatsappLink = `https://web.whatsapp.com/send?phone=${phoneNumber}`;

            // Group messages by date
            const groupedMessages = {};
            messages.forEach(msg => {
                const date = new Date(msg.message_timestamp).toLocaleDateString('pl-PL', { day: 'numeric', month: 'long', year: 'numeric' });
                if (!groupedMessages[date]) groupedMessages[date] = [];
                groupedMessages[date].push(msg);
            });

            container.innerHTML = `
                <!-- Chat Header -->
                <div class="h-14 px-4 border-b border-[#1a1a1a] flex items-center justify-between flex-shrink-0 bg-black">
                    <div class="flex items-center gap-3">
                        <div class="w-9 h-9 rounded-full bg-[#1a1a1a] flex items-center justify-center text-zinc-400 text-sm font-medium">
                            ${(conv.contact_name || '?').charAt(0).toUpperCase()}
                        </div>
                        <div>
                            <div class="text-white text-sm font-medium">${conv.contact_name || 'Nieznany'}</div>
                            <div class="text-[11px] text-zinc-600 font-mono">${phoneNumber}</div>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        ${hasLead ? `
                            <a href="/lead?id=${conv.lead_id}" class="h-8 px-3 bg-transparent text-zinc-400 text-xs rounded-md hover:bg-[#1a1a1a] hover:text-white transition-colors flex items-center gap-1.5 border border-[#333]">
                                <i class="ph ph-user text-sm"></i>
                                Lead
                            </a>
                        ` : `
                            <button onclick="createLead('${phoneNumber}', '${(conv.contact_name || '').replace(/'/g, "\\'")}', '${conv.lead_email || ''}')"
                                class="h-8 px-3 bg-transparent text-zinc-400 text-xs rounded-md hover:bg-[#1a1a1a] hover:text-white transition-colors flex items-center gap-1.5 border border-[#333]">
                                <i class="ph ph-user-plus text-sm"></i>
                                Utworz Lead
                            </button>
                        `}
                        <a href="${whatsappLink}" target="_blank" class="h-8 px-3 bg-white text-black text-xs rounded-md hover:bg-zinc-200 transition-colors flex items-center gap-1.5 font-medium">
                            <i class="ph ph-arrow-square-out text-sm"></i>
                            WhatsApp
                        </a>
                    </div>
                </div>

                <!-- Messages Container -->
                <div class="flex-1 overflow-y-auto px-4 py-6 min-h-0 bg-black" id="messages-container">
                    ${messages.length === 0 ? `
                        <div class="flex items-center justify-center h-full">
                            <p class="text-zinc-600 text-sm">Brak wiadomosci</p>
                        </div>
                    ` : Object.entries(groupedMessages).map(([date, msgs]) => `
                        <div class="mb-6">
                            <div class="flex justify-center mb-4">
                                <span class="text-[11px] text-zinc-600 font-medium">${date}</span>
                            </div>
                            <div class="space-y-3">
                                ${msgs.map(msg => {
                                    const isOutbound = msg.direction === 'outbound';
                                    const time = new Date(msg.message_timestamp).toLocaleTimeString('pl-PL', {
                                        hour: '2-digit', minute: '2-digit'
                                    });

                                    return `
                                        <div class="flex ${isOutbound ? 'justify-end' : 'justify-start'}">
                                            <div class="max-w-[75%] ${isOutbound ? 'msg-out' : 'msg-in'} rounded-lg px-3 py-2">
                                                <div class="text-[13px] ${isOutbound ? 'text-zinc-100' : 'text-zinc-300'} whitespace-pre-wrap break-words leading-relaxed">${escapeHtml(msg.message_text)}</div>
                                                <div class="text-[10px] ${isOutbound ? 'text-emerald-700' : 'text-zinc-600'} mt-1.5 text-right">${time}</div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>

                <!-- Footer Info -->
                <div class="h-10 px-4 border-t border-[#1a1a1a] text-[11px] text-zinc-600 flex items-center justify-between flex-shrink-0 bg-black">
                    <div class="flex items-center gap-4">
                        <span class="flex items-center gap-1"><i class="ph ph-arrow-down"></i> ${conv.inbound_count || 0}</span>
                        <span class="flex items-center gap-1"><i class="ph ph-arrow-up"></i> ${conv.outbound_count || 0}</span>
                        <span>Razem: ${conv.message_count || 0}</span>
                    </div>
                    <div>
                        ${conv.lead_status ? `<span class="text-zinc-500">${conv.lead_status}</span>` : ''}
                    </div>
                </div>
            `;

            // Scroll to bottom
            requestAnimationFrame(() => {
                const msgContainer = document.getElementById('messages-container');
                if (msgContainer) {
                    msgContainer.scrollTop = msgContainer.scrollHeight;
                }
            });
        }

        async function selectConversation(phoneNumber) {
            selectedPhone = phoneNumber;
            renderConversations();
            await renderChatDetail(phoneNumber);
        }

        // ============================================
        // ACTIONS
        // ============================================
        async function createLead(phone, name, email) {
            const leadData = {
                phone: phone,
                name: name || 'WhatsApp: ' + phone,
                email: email || null,
                source: 'whatsapp',
                status: 'new'
            };

            const { data, error } = await supabaseClient
                .from('leads')
                .insert([leadData])
                .select()
                .single();

            if (error) {
                showToast('Blad tworzenia leada: ' + error.message);
                return;
            }

            showToast('Lead utworzony!');

            // Update messages to link to this lead
            await supabaseClient
                .from('whatsapp_messages')
                .update({ lead_id: data.id })
                .eq('phone_number', phone);

            // Reload
            await loadData();
        }

        function filterBy(filter) {
            currentFilter = filter;

            // Update button styles
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('bg-[#1a1a1a]', 'text-white');
                btn.classList.add('text-zinc-500');
            });
            document.querySelector(`[data-filter="${filter}"]`)?.classList.add('bg-[#1a1a1a]', 'text-white');
            document.querySelector(`[data-filter="${filter}"]`)?.classList.remove('text-zinc-500');

            renderConversations();
        }

        // ============================================
        // HELPERS
        // ============================================
        function getLastMessage(phoneNumber) {
            return allMessages.find(m => m.phone_number === phoneNumber);
        }

        function updateStats() {
            const total = conversations.length;
            const withLead = conversations.filter(c => c.lead_id).length;
            const withoutLead = total - withLead;

            document.getElementById('total-count').textContent = `(${total})`;
            document.getElementById('stat-conversations').textContent = total;
            document.getElementById('stat-with-lead').textContent = withLead;
            document.getElementById('stat-without-lead').textContent = withoutLead;
        }

        function formatTimeAgo(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / (1000 * 60));
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));

            if (minutes < 1) return 'teraz';
            if (minutes < 60) return `${minutes}m`;
            if (hours < 24) return `${hours}h`;
            if (days === 1) return 'wczoraj';
            if (days < 7) return `${days}d`;
            return date.toLocaleDateString('pl-PL', { day: '2-digit', month: '2-digit' });
        }

        function truncate(str, len) {
            if (!str) return '';
            return str.length > len ? str.substring(0, len) + '...' : str;
        }

        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        function getStatusColor(status) {
            const colors = {
                new: 'bg-emerald-500/20 text-emerald-400',
                contacted: 'bg-blue-500/20 text-blue-400',
                qualified: 'bg-amber-500/20 text-amber-400',
                proposal: 'bg-violet-500/20 text-violet-400',
                won: 'bg-green-500/20 text-green-400',
                lost: 'bg-red-500/20 text-red-400'
            };
            return colors[status] || 'bg-zinc-500/20 text-zinc-400';
        }

        function showToast(text) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-text').textContent = text;
            toast.classList.remove('opacity-0', 'invisible', 'translate-y-2');
            toast.classList.add('opacity-100', 'visible', 'translate-y-0');
            setTimeout(() => {
                toast.classList.add('opacity-0', 'invisible', 'translate-y-2');
                toast.classList.remove('opacity-100', 'visible', 'translate-y-0');
            }, 3000);
        }

        // ============================================
        // SEARCH
        // ============================================
        document.getElementById('search-input').addEventListener('input', (e) => {
            searchQuery = e.target.value;
            renderConversations();
        });

        // ============================================
        // INIT
        // ============================================
        async function init() {
            const session = await checkAuth();
            if (session) {
                filterBy('all');
                await loadData();
            }
        }

        init();

        // Auto-refresh every 60s
        setInterval(loadData, 60000);
    </script>
</body>
</html>
