<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TN CRM - WhatsApp</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#050505">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="components/shared-sidebar.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    }
                }
            }
        }
    </script>
    <style>
        body { background: #050505; color: #e5e5e5; }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        ::selection { background: white; color: black; }

        .glass-header {
            background: rgba(5, 5, 5, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-enter { animation: fadeIn 0.4s ease-out forwards; }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .animate-slide { animation: slideIn 0.3s ease-out forwards; }

        /* Priority badges */
        .priority-urgent { background: rgba(239, 68, 68, 0.15); border-color: rgba(239, 68, 68, 0.3); color: #ef4444; }
        .priority-high { background: rgba(249, 115, 22, 0.15); border-color: rgba(249, 115, 22, 0.3); color: #f97316; }
        .priority-normal { background: rgba(34, 197, 94, 0.15); border-color: rgba(34, 197, 94, 0.3); color: #22c55e; }
        .priority-low { background: rgba(100, 116, 139, 0.15); border-color: rgba(100, 116, 139, 0.3); color: #64748b; }

        /* Lead card */
        .lead-card {
            background: rgba(24, 24, 27, 0.5);
            border: 1px solid rgba(255,255,255,0.05);
            transition: all 0.2s ease;
        }
        .lead-card:hover {
            border-color: rgba(255,255,255,0.1);
            background: rgba(24, 24, 27, 0.8);
        }
        .lead-card.selected {
            border-color: rgba(37, 211, 102, 0.5);
            background: rgba(37, 211, 102, 0.05);
        }

        /* Message preview */
        .message-bubble {
            background: rgba(37, 211, 102, 0.1);
            border: 1px solid rgba(37, 211, 102, 0.2);
            border-radius: 12px 12px 4px 12px;
        }

        /* Context panel */
        .context-section {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255,255,255,0.05);
        }

        /* Pulse animation for generating */
        @keyframes pulse-green {
            0%, 100% { box-shadow: 0 0 0 0 rgba(37, 211, 102, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(37, 211, 102, 0); }
        }
        .generating { animation: pulse-green 1.5s infinite; }

        /* Stat cards */
        .stat-card {
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.05);
        }
    </style>
</head>
<body class="h-screen flex overflow-hidden font-sans text-sm tracking-tight antialiased">

    <!-- Sidebar -->
    <aside id="sidebar" class="w-[280px] bg-zinc-950 border-r border-white/5 flex flex-col flex-shrink-0"></aside>

    <!-- Main -->
    <main class="flex-1 flex flex-col bg-black relative min-w-0">
        <!-- Header -->
        <header class="h-16 glass-header flex items-center justify-between px-4 md:px-6 sticky top-0 z-30">
            <div class="flex items-center gap-3">
                <button onclick="Sidebar.toggle()" class="mobile-menu-btn hidden items-center justify-center w-9 h-9 rounded-lg hover:bg-white/5 text-zinc-400 hover:text-white transition-colors">
                    <i class="ph ph-list text-xl"></i>
                </button>
                <div class="flex items-center gap-2 text-zinc-500">
                    <span class="text-zinc-400 hidden sm:inline">tn-crm</span>
                    <span class="text-zinc-700 hidden sm:inline">/</span>
                    <span class="text-white font-medium flex items-center gap-2">
                        <i class="ph ph-whatsapp-logo text-[#25D366]"></i>
                        whatsapp
                    </span>
                </div>
            </div>
            <div class="flex items-center gap-2 md:gap-3">
                <a href="/whatsapp/logs" class="text-zinc-400 hover:text-white border border-zinc-800 hover:border-zinc-700 px-3 py-1.5 rounded-lg text-xs transition-colors flex items-center gap-1.5">
                    <i class="ph ph-clock-counter-clockwise"></i>
                    <span class="hidden md:inline">Logi</span>
                </a>
                <a href="/whatsapp/settings" class="text-zinc-400 hover:text-white border border-zinc-800 hover:border-zinc-700 px-3 py-1.5 rounded-lg text-xs transition-colors flex items-center gap-1.5">
                    <i class="ph ph-gear"></i>
                    <span class="hidden md:inline">Ustawienia</span>
                </a>
                <button id="refresh-btn" onclick="loadLeads()" class="text-zinc-400 hover:text-white border border-zinc-800 hover:border-zinc-700 px-3 py-1.5 rounded-lg text-xs transition-colors flex items-center gap-1.5">
                    <i class="ph ph-arrows-clockwise"></i>
                    <span class="hidden md:inline">Odswiez</span>
                </button>
                <button id="generate-all-btn" onclick="generateAllMessages()" class="bg-[#25D366] text-black hover:bg-[#20bd5a] px-3 md:px-4 py-2 rounded-lg font-medium text-sm transition-colors shadow-[0_0_15px_rgba(37,211,102,0.2)] flex items-center gap-1.5">
                    <i class="ph ph-sparkle"></i>
                    <span class="hidden md:inline">Generuj wiadomosci</span>
                </button>
            </div>
        </header>

        <!-- Content -->
        <div class="flex-1 flex overflow-hidden">
            <!-- Left: Lead List -->
            <div class="w-full lg:w-1/2 xl:w-2/5 border-r border-white/5 flex flex-col overflow-hidden">
                <!-- Stats bar -->
                <div class="p-4 border-b border-white/5 flex gap-3">
                    <div class="stat-card flex-1 rounded-lg p-3 text-center">
                        <div class="text-2xl font-bold text-white font-mono" id="stat-total">-</div>
                        <div class="text-[10px] text-zinc-500 uppercase tracking-wider">Do kontaktu</div>
                    </div>
                    <div class="stat-card flex-1 rounded-lg p-3 text-center">
                        <div class="text-2xl font-bold text-red-400 font-mono" id="stat-urgent">-</div>
                        <div class="text-[10px] text-zinc-500 uppercase tracking-wider">Pilne</div>
                    </div>
                    <div class="stat-card flex-1 rounded-lg p-3 text-center">
                        <div class="text-2xl font-bold text-[#25D366] font-mono" id="stat-new">-</div>
                        <div class="text-[10px] text-zinc-500 uppercase tracking-wider">Nowe</div>
                    </div>
                </div>

                <!-- Filters -->
                <div class="p-4 border-b border-white/5 flex items-center gap-2 flex-wrap">
                    <button onclick="setFilter('all')" data-filter="all" class="filter-btn active px-3 py-1.5 rounded-lg text-xs font-medium transition-colors bg-white/10 text-white">
                        Wszystkie
                    </button>
                    <button onclick="setFilter('urgent')" data-filter="urgent" class="filter-btn px-3 py-1.5 rounded-lg text-xs font-medium transition-colors text-zinc-400 hover:text-white hover:bg-white/5">
                        Pilne
                    </button>
                    <button onclick="setFilter('new')" data-filter="new" class="filter-btn px-3 py-1.5 rounded-lg text-xs font-medium transition-colors text-zinc-400 hover:text-white hover:bg-white/5">
                        Nowe
                    </button>
                    <button onclick="setFilter('followup')" data-filter="followup" class="filter-btn px-3 py-1.5 rounded-lg text-xs font-medium transition-colors text-zinc-400 hover:text-white hover:bg-white/5">
                        Follow-up
                    </button>
                </div>

                <!-- Lead list -->
                <div id="leads-list" class="flex-1 overflow-y-auto p-4 space-y-3">
                    <!-- Loading state -->
                    <div id="loading-state" class="py-16 text-center">
                        <div class="w-6 h-6 mx-auto mb-3 border-2 border-zinc-700 border-t-[#25D366] rounded-full animate-spin"></div>
                        <p class="text-zinc-500 text-sm">Analizuję leady...</p>
                    </div>
                </div>
            </div>

            <!-- Right: Lead Detail & Message Generator -->
            <div id="detail-panel" class="hidden lg:flex flex-1 flex-col overflow-hidden bg-zinc-950/50">
                <!-- Empty state -->
                <div id="empty-detail" class="flex-1 flex items-center justify-center">
                    <div class="text-center">
                        <i class="ph ph-cursor-click text-4xl text-zinc-700 mb-3"></i>
                        <p class="text-zinc-500 text-sm">Wybierz leada z listy</p>
                        <p class="text-zinc-600 text-xs mt-1">aby zobaczyć szczegóły i wygenerować wiadomość</p>
                    </div>
                </div>

                <!-- Lead detail -->
                <div id="lead-detail" class="hidden flex-1 flex flex-col overflow-hidden">
                    <!-- Lead header -->
                    <div class="p-6 border-b border-white/5">
                        <div class="flex items-start justify-between mb-4">
                            <div>
                                <h2 id="detail-name" class="text-xl font-semibold text-white mb-1"></h2>
                                <div class="flex items-center gap-3 text-sm">
                                    <span id="detail-phone" class="text-zinc-400 font-mono flex items-center gap-1">
                                        <i class="ph ph-phone"></i>
                                    </span>
                                    <span id="detail-status" class="text-xs px-2 py-0.5 rounded-full"></span>
                                </div>
                            </div>
                            <div id="detail-priority" class="px-3 py-1.5 rounded-lg text-xs font-medium border"></div>
                        </div>

                        <!-- Quick actions -->
                        <div class="flex items-center gap-2">
                            <a id="wa-link" href="#" target="_blank" class="flex-1 bg-[#25D366] text-black hover:bg-[#20bd5a] px-4 py-2.5 rounded-lg font-medium text-sm transition-colors flex items-center justify-center gap-2">
                                <i class="ph ph-whatsapp-logo text-lg"></i>
                                Otwórz WhatsApp
                            </a>
                            <button onclick="copyPhone()" class="p-2.5 text-zinc-400 hover:text-white border border-zinc-800 hover:border-zinc-700 rounded-lg transition-colors" title="Kopiuj numer">
                                <i class="ph ph-copy"></i>
                            </button>
                            <a id="lead-link" href="#" class="p-2.5 text-zinc-400 hover:text-white border border-zinc-800 hover:border-zinc-700 rounded-lg transition-colors" title="Otwórz profil leada">
                                <i class="ph ph-user"></i>
                            </a>
                        </div>
                    </div>

                    <!-- Scrollable content -->
                    <div class="flex-1 overflow-y-auto p-6 space-y-6">
                        <!-- Context: Why contact -->
                        <div class="context-section rounded-lg p-4">
                            <h3 class="text-xs font-medium text-zinc-400 uppercase tracking-wider mb-3 flex items-center gap-2">
                                <i class="ph ph-lightbulb text-amber-400"></i>
                                Dlaczego teraz?
                            </h3>
                            <p id="detail-reason" class="text-sm text-zinc-300 leading-relaxed"></p>
                        </div>

                        <!-- Context: Lead info -->
                        <div class="context-section rounded-lg p-4">
                            <h3 class="text-xs font-medium text-zinc-400 uppercase tracking-wider mb-3 flex items-center gap-2">
                                <i class="ph ph-info text-cyan-400"></i>
                                Co wiemy
                            </h3>
                            <div class="space-y-3">
                                <div id="detail-income" class="flex items-center gap-2 text-sm">
                                    <i class="ph ph-currency-circle-dollar text-emerald-400"></i>
                                    <span class="text-zinc-400">Cel:</span>
                                    <span class="text-white font-medium"></span>
                                </div>
                                <div id="detail-hours" class="flex items-center gap-2 text-sm">
                                    <i class="ph ph-clock text-violet-400"></i>
                                    <span class="text-zinc-400">Czas:</span>
                                    <span class="text-white font-medium"></span>
                                </div>
                                <div id="detail-source" class="flex items-center gap-2 text-sm">
                                    <i class="ph ph-link text-blue-400"></i>
                                    <span class="text-zinc-400">Źródło:</span>
                                    <span class="text-white font-medium"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Context: Experience -->
                        <div id="detail-experience-section" class="context-section rounded-lg p-4 hidden">
                            <h3 class="text-xs font-medium text-zinc-400 uppercase tracking-wider mb-3 flex items-center gap-2">
                                <i class="ph ph-book-open text-pink-400"></i>
                                Doświadczenie
                            </h3>
                            <p id="detail-experience" class="text-sm text-zinc-300 leading-relaxed"></p>
                        </div>

                        <!-- Context: Notes -->
                        <div id="detail-notes-section" class="context-section rounded-lg p-4 hidden">
                            <h3 class="text-xs font-medium text-zinc-400 uppercase tracking-wider mb-3 flex items-center gap-2">
                                <i class="ph ph-note text-amber-400"></i>
                                Notatki
                            </h3>
                            <div id="detail-notes" class="space-y-2"></div>
                        </div>

                        <!-- Message generator -->
                        <div class="border-t border-white/5 pt-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-xs font-medium text-zinc-400 uppercase tracking-wider flex items-center gap-2">
                                    <i class="ph ph-chat-text text-[#25D366]"></i>
                                    Wiadomość
                                </h3>
                                <button id="generate-single-btn" onclick="generateMessage()" class="text-[#25D366] hover:text-[#20bd5a] text-xs font-medium flex items-center gap-1 transition-colors">
                                    <i class="ph ph-sparkle"></i>
                                    Generuj nową
                                </button>
                            </div>

                            <div id="message-container">
                                <div id="message-empty" class="text-center py-8 text-zinc-600">
                                    <i class="ph ph-chat-dots text-3xl mb-2"></i>
                                    <p class="text-sm">Kliknij "Generuj nową" aby stworzyć wiadomość</p>
                                </div>

                                <div id="message-content" class="hidden">
                                    <div class="message-bubble p-4 mb-4">
                                        <p id="message-text" class="text-sm text-zinc-200 leading-relaxed whitespace-pre-wrap"></p>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <button onclick="copyMessage()" class="flex-1 bg-zinc-800 hover:bg-zinc-700 text-white px-4 py-2.5 rounded-lg text-sm font-medium transition-colors flex items-center justify-center gap-2">
                                            <i class="ph ph-copy"></i>
                                            Kopiuj wiadomość
                                        </button>
                                        <button onclick="copyPrompt()" class="p-2.5 text-zinc-400 hover:text-white border border-zinc-800 hover:border-zinc-700 rounded-lg transition-colors" title="Kopiuj prompt dla Claude">
                                            <i class="ph ph-code"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-6 right-6 bg-zinc-800 border border-white/10 text-white px-4 py-3 rounded-lg shadow-xl z-50 flex items-center gap-2 opacity-0 invisible transition-all duration-300 transform translate-y-2">
        <i class="ph ph-check-circle text-emerald-400"></i>
        <span id="toast-text"></span>
    </div>

    <script>
        const SUPABASE_URL = 'https://yxmavwkwnfuphjqbelws.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl4bWF2d2t3bmZ1cGhqcWJlbHdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NjQyNTUsImV4cCI6MjA4NDM0MDI1NX0.XeR0Fc7OFn6YbNJrOKTBEj36JtmLISZTM87y4ai9340';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        Sidebar.render();
        Sidebar.setupLogout(supabaseClient);

        // ============================================
        // STATE
        // ============================================
        let leads = [];
        let analyzedLeads = [];
        let selectedLead = null;
        let currentFilter = 'all';
        let teamMembers = [];
        let currentMember = null;

        // ============================================
        // AUTH & INIT
        // ============================================
        async function checkAuth() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
                window.location.href = Sidebar.getLoginPath();
                return null;
            }

            // Generator dostępny tylko dla tomekniedzwiecki@gmail.com
            const allowedEmail = 'tomekniedzwiecki@gmail.com';
            if (session.user.email !== allowedEmail) {
                window.location.href = '/whatsapp/logs';
                return null;
            }

            Sidebar.setUserEmail(session.user.email.split('@')[0]);
            await loadTeamMembers(session.user.id);
            return session;
        }

        async function loadTeamMembers(userId) {
            const { data, error } = await supabaseClient.from('team_members').select('*');
            if (error) {
                console.error('Error loading team members:', error);
                return;
            }
            teamMembers = data || [];
            currentMember = teamMembers.find(m => m.user_id === userId);

            if (currentMember) {
                Sidebar.setUserName(currentMember.name);
                Sidebar.setUserColor(currentMember.color);
                Sidebar.setupProfileClick();
            }

            Sidebar.showAdminNav(currentMember?.role === 'admin');
        }

        // ============================================
        // LEAD SCORING & ANALYSIS
        // ============================================
        function analyzeLeads(rawLeads) {
            const now = new Date();

            return rawLeads.map(lead => {
                const analysis = {
                    ...lead,
                    score: 0,
                    priority: 'normal',
                    reasons: [],
                    suggestedAction: 'follow_up'
                };

                const createdAt = new Date(lead.created_at);
                const updatedAt = new Date(lead.updated_at || lead.created_at);
                const lastWaContact = lead.whatsapp_contacted_at ? new Date(lead.whatsapp_contacted_at) : null;

                const hoursSinceCreated = (now - createdAt) / (1000 * 60 * 60);
                const daysSinceUpdate = (now - updatedAt) / (1000 * 60 * 60 * 24);
                const daysSinceWaContact = lastWaContact ? (now - lastWaContact) / (1000 * 60 * 60 * 24) : null;

                // === SCORING RULES ===

                // 1. New lead (< 24h) - URGENT
                if (hoursSinceCreated < 24 && lead.status === 'new') {
                    analysis.score += 100;
                    analysis.reasons.push(`Nowy lead (${Math.round(hoursSinceCreated)}h temu)`);
                    analysis.suggestedAction = 'first_contact';
                }

                // 2. Very new lead (< 4h) - EXTRA URGENT
                if (hoursSinceCreated < 4 && lead.status === 'new') {
                    analysis.score += 50;
                    analysis.reasons.push('Gorący! Zapisał się przed chwilą');
                }

                // 3. Has detailed experience - valuable lead
                if (lead.experience && lead.experience.length > 100) {
                    analysis.score += 30;
                    analysis.reasons.push('Szczegółowo opisał sytuację');
                }

                // 4. High income goal
                if (lead.target_income === '20-50k' || lead.target_income === '50k+') {
                    analysis.score += 25;
                    analysis.reasons.push(`Wysoki cel: ${lead.target_income}/mies`);
                }

                // 5. Full-time availability
                if (lead.weekly_hours === 'fulltime') {
                    analysis.score += 20;
                    analysis.reasons.push('Full-time dostępność');
                }

                // 6. No WA contact but already contacted status
                if (lead.status === 'contacted' && !lastWaContact) {
                    analysis.score += 40;
                    analysis.reasons.push('Kontaktowany, ale brak WA');
                    analysis.suggestedAction = 'first_wa';
                }

                // 7. Qualified but waiting
                if (lead.status === 'qualified') {
                    analysis.score += 60;
                    analysis.reasons.push('Zakwalifikowany - czeka na decyzję');
                    analysis.suggestedAction = 'close';
                }

                // 8. Has notes with context
                if (lead.notes_history && lead.notes_history.length > 0) {
                    const lastNote = lead.notes_history[lead.notes_history.length - 1];
                    const noteDate = new Date(lastNote.created_at);
                    const daysSinceNote = (now - noteDate) / (1000 * 60 * 60 * 24);

                    if (daysSinceNote > 2 && daysSinceNote < 7) {
                        analysis.score += 35;
                        analysis.reasons.push(`Notatka ${Math.round(daysSinceNote)} dni temu - czas na follow-up`);
                    }
                }

                // 9. Expected close date approaching
                if (lead.expected_close) {
                    const closeDate = new Date(lead.expected_close);
                    const daysToClose = (closeDate - now) / (1000 * 60 * 60 * 24);

                    if (daysToClose >= 0 && daysToClose <= 3) {
                        analysis.score += 80;
                        analysis.reasons.push(`Deadline za ${Math.round(daysToClose)} dni!`);
                        analysis.suggestedAction = 'close';
                    }
                }

                // 10. Long time without contact
                if (daysSinceWaContact && daysSinceWaContact > 5 && lead.status !== 'won' && lead.status !== 'lost') {
                    analysis.score += 25;
                    analysis.reasons.push(`${Math.round(daysSinceWaContact)} dni bez kontaktu WA`);
                }

                // === PRIORITY ASSIGNMENT ===
                if (analysis.score >= 100) {
                    analysis.priority = 'urgent';
                } else if (analysis.score >= 60) {
                    analysis.priority = 'high';
                } else if (analysis.score >= 30) {
                    analysis.priority = 'normal';
                } else {
                    analysis.priority = 'low';
                }

                return analysis;
            });
        }

        // ============================================
        // LOAD LEADS
        // ============================================
        async function loadLeads() {
            document.getElementById('loading-state').classList.remove('hidden');
            document.getElementById('leads-list').innerHTML = document.getElementById('loading-state').outerHTML;

            // Fetch leads that are not won/lost
            const { data, error } = await supabaseClient
                .from('leads')
                .select('*')
                .not('status', 'in', '(won,lost,abandoned)')
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error loading leads:', error);
                showToast('Błąd ładowania leadów');
                return;
            }

            leads = data || [];
            analyzedLeads = analyzeLeads(leads);

            // Sort by score (highest first)
            analyzedLeads.sort((a, b) => b.score - a.score);

            updateStats();
            renderLeads();
        }

        // ============================================
        // STATS
        // ============================================
        function updateStats() {
            const total = analyzedLeads.length;
            const urgent = analyzedLeads.filter(l => l.priority === 'urgent').length;
            const newLeads = analyzedLeads.filter(l => l.status === 'new').length;

            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-urgent').textContent = urgent;
            document.getElementById('stat-new').textContent = newLeads;
        }

        // ============================================
        // FILTERS
        // ============================================
        function setFilter(filter) {
            currentFilter = filter;

            document.querySelectorAll('.filter-btn').forEach(btn => {
                if (btn.dataset.filter === filter) {
                    btn.classList.add('active', 'bg-white/10', 'text-white');
                    btn.classList.remove('text-zinc-400');
                } else {
                    btn.classList.remove('active', 'bg-white/10', 'text-white');
                    btn.classList.add('text-zinc-400');
                }
            });

            renderLeads();
        }

        function getFilteredLeads() {
            switch (currentFilter) {
                case 'urgent':
                    return analyzedLeads.filter(l => l.priority === 'urgent');
                case 'new':
                    return analyzedLeads.filter(l => l.status === 'new');
                case 'followup':
                    return analyzedLeads.filter(l => l.status === 'contacted' || l.status === 'qualified');
                default:
                    return analyzedLeads;
            }
        }

        // ============================================
        // RENDER LEADS
        // ============================================
        function renderLeads() {
            const container = document.getElementById('leads-list');
            const filtered = getFilteredLeads();

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="py-16 text-center">
                        <i class="ph ph-check-circle text-4xl text-emerald-400 mb-3"></i>
                        <p class="text-zinc-400 text-sm">Brak leadów do kontaktu</p>
                        <p class="text-zinc-600 text-xs mt-1">Wszystko ogarnięte!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filtered.map((lead, index) => {
                const priorityClass = `priority-${lead.priority}`;
                const priorityLabel = {
                    urgent: 'Pilne',
                    high: 'Wysoki',
                    normal: 'Normalny',
                    low: 'Niski'
                }[lead.priority];

                const statusColors = {
                    new: 'bg-emerald-500/20 text-emerald-400',
                    contacted: 'bg-blue-500/20 text-blue-400',
                    qualified: 'bg-amber-500/20 text-amber-400',
                    proposal: 'bg-violet-500/20 text-violet-400',
                    negotiation: 'bg-pink-500/20 text-pink-400'
                };
                const statusClass = statusColors[lead.status] || 'bg-zinc-500/20 text-zinc-400';

                const timeAgo = getTimeAgo(new Date(lead.created_at));

                return `
                    <div class="lead-card rounded-lg p-4 cursor-pointer animate-slide ${selectedLead?.id === lead.id ? 'selected' : ''}"
                         style="animation-delay: ${index * 50}ms"
                         onclick="selectLead('${lead.id}')">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2 mb-1">
                                    <h3 class="font-medium text-white truncate">${lead.name || lead.email.split('@')[0]}</h3>
                                    <span class="text-xs px-2 py-0.5 rounded-full ${statusClass}">${lead.status}</span>
                                </div>
                                <p class="text-xs text-zinc-500 font-mono">${lead.phone || 'Brak telefonu'}</p>
                            </div>
                            <div class="px-2 py-1 rounded text-[10px] font-medium border ${priorityClass}">
                                ${priorityLabel}
                            </div>
                        </div>

                        ${lead.reasons.length > 0 ? `
                            <div class="flex flex-wrap gap-1.5 mb-3">
                                ${lead.reasons.slice(0, 2).map(r => `
                                    <span class="text-[10px] px-2 py-0.5 bg-white/5 text-zinc-400 rounded">
                                        ${r}
                                    </span>
                                `).join('')}
                            </div>
                        ` : ''}

                        <div class="flex items-center justify-between text-[10px] text-zinc-600">
                            <span>${timeAgo}</span>
                            <span class="font-mono">Score: ${lead.score}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ============================================
        // SELECT LEAD
        // ============================================
        function selectLead(leadId) {
            selectedLead = analyzedLeads.find(l => l.id === leadId);
            if (!selectedLead) return;

            // Update card selection
            document.querySelectorAll('.lead-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');

            // Show detail panel
            document.getElementById('empty-detail').classList.add('hidden');
            document.getElementById('lead-detail').classList.remove('hidden');
            document.getElementById('detail-panel').classList.remove('hidden');

            // Populate detail
            document.getElementById('detail-name').textContent = selectedLead.name || selectedLead.email.split('@')[0];
            document.getElementById('detail-phone').innerHTML = `<i class="ph ph-phone"></i> ${selectedLead.phone || 'Brak'}`;

            const statusColors = {
                new: 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30',
                contacted: 'bg-blue-500/20 text-blue-400 border-blue-500/30',
                qualified: 'bg-amber-500/20 text-amber-400 border-amber-500/30'
            };
            const statusEl = document.getElementById('detail-status');
            statusEl.className = `text-xs px-2 py-0.5 rounded-full border ${statusColors[selectedLead.status] || 'bg-zinc-500/20 text-zinc-400 border-zinc-500/30'}`;
            statusEl.textContent = selectedLead.status;

            const priorityEl = document.getElementById('detail-priority');
            priorityEl.className = `px-3 py-1.5 rounded-lg text-xs font-medium border priority-${selectedLead.priority}`;
            priorityEl.textContent = {
                urgent: 'Pilne',
                high: 'Wysoki priorytet',
                normal: 'Normalny',
                low: 'Niski'
            }[selectedLead.priority];

            // Reason
            document.getElementById('detail-reason').textContent = selectedLead.reasons.join('. ') || 'Standardowy follow-up';

            // Info
            document.getElementById('detail-income').querySelector('span:last-child').textContent = selectedLead.target_income || '-';
            document.getElementById('detail-hours').querySelector('span:last-child').textContent = formatHours(selectedLead.weekly_hours);
            document.getElementById('detail-source').querySelector('span:last-child').textContent = selectedLead.lead_source || 'website';

            // Experience
            const expSection = document.getElementById('detail-experience-section');
            if (selectedLead.experience) {
                expSection.classList.remove('hidden');
                document.getElementById('detail-experience').textContent = selectedLead.experience;
            } else {
                expSection.classList.add('hidden');
            }

            // Notes
            const notesSection = document.getElementById('detail-notes-section');
            if (selectedLead.notes_history && selectedLead.notes_history.length > 0) {
                notesSection.classList.remove('hidden');
                document.getElementById('detail-notes').innerHTML = selectedLead.notes_history.map(note => `
                    <div class="text-sm text-zinc-300 p-2 bg-black/30 rounded">
                        <p>${note.content}</p>
                        <p class="text-[10px] text-zinc-600 mt-1">${new Date(note.created_at).toLocaleDateString('pl-PL')} - ${note.performed_by_name || 'System'}</p>
                    </div>
                `).join('');
            } else {
                notesSection.classList.add('hidden');
            }

            // Links
            const waLink = document.getElementById('wa-link');
            const phone = (selectedLead.phone || '').replace(/\D/g, '');
            waLink.href = `https://wa.me/${phone.startsWith('48') ? phone : '48' + phone}`;

            document.getElementById('lead-link').href = Sidebar.getPagePath('lead') + `?id=${selectedLead.id}`;

            // Reset message
            document.getElementById('message-empty').classList.remove('hidden');
            document.getElementById('message-content').classList.add('hidden');
        }

        // ============================================
        // MESSAGE GENERATION
        // ============================================
        function generateMessage() {
            if (!selectedLead) return;

            const btn = document.getElementById('generate-single-btn');
            btn.innerHTML = '<i class="ph ph-circle-notch animate-spin"></i> Generuję...';
            btn.disabled = true;

            // Generate message based on context
            setTimeout(() => {
                const message = generatePersonalizedMessage(selectedLead);

                document.getElementById('message-text').textContent = message;
                document.getElementById('message-empty').classList.add('hidden');
                document.getElementById('message-content').classList.remove('hidden');

                btn.innerHTML = '<i class="ph ph-sparkle"></i> Generuj nową';
                btn.disabled = false;
            }, 500);
        }

        function generatePersonalizedMessage(lead) {
            const name = lead.name?.split(' ')[0] || 'Hej';
            const hour = new Date().getHours();
            const greeting = hour < 12 ? 'Dzień dobry' : hour < 18 ? 'Hej' : 'Hej';

            // Build context-aware message
            let message = '';

            if (lead.suggestedAction === 'first_contact') {
                // New lead - first contact
                if (lead.experience && lead.experience.length > 50) {
                    // Has detailed experience - reference it
                    const keywords = extractKeywords(lead.experience);
                    message = `${greeting} ${name}! Widziałem Twoje zgłoszenie - czytałem co napisałeś`;
                    if (keywords.length > 0) {
                        message += ` o ${keywords[0]}`;
                    }
                    message += `. Fajnie że się odezwałeś. Masz chwilę pogadać?`;
                } else {
                    message = `${greeting} ${name}! Dzięki za zapis. Widziałem że interesuje Cię temat biznesu online. Masz chwilę na krótką rozmowę?`;
                }
            } else if (lead.suggestedAction === 'close') {
                // Qualified - push to close
                const lastNote = lead.notes_history?.[lead.notes_history.length - 1];
                if (lastNote) {
                    message = `Hej ${name}! Wracam do naszej rozmowy. ${getFollowUpFromNote(lastNote.content)} Co myślisz?`;
                } else {
                    message = `Hej ${name}! Co tam, udało się przemyśleć sprawę? Daj znać jak wygląda sytuacja.`;
                }
            } else {
                // Generic follow-up
                const daysSinceCreated = Math.floor((new Date() - new Date(lead.created_at)) / (1000 * 60 * 60 * 24));

                if (daysSinceCreated < 3) {
                    message = `Hej ${name}! Pisałeś parę dni temu w sprawie biznesu online. Udało Ci się obejrzeć materiały? Jak wrażenia?`;
                } else {
                    message = `Hej ${name}! Dawno nie gadaliśmy. Co tam słychać? Dalej myślisz o tym temacie?`;
                }
            }

            return message;
        }

        function extractKeywords(text) {
            const keywords = [];
            const lowerText = text.toLowerCase();

            if (lowerText.includes('shopify') || lowerText.includes('sklep')) keywords.push('sklepie');
            if (lowerText.includes('dropship') || lowerText.includes('takedrop')) keywords.push('dropshippingu');
            if (lowerText.includes('krypto') || lowerText.includes('crypto')) keywords.push('krypto');
            if (lowerText.includes('etat') || lowerText.includes('praca')) keywords.push('pracy');
            if (lowerText.includes('kurs') || lowerText.includes('szkoleni')) keywords.push('kursach');
            if (lowerText.includes('affiliate') || lowerText.includes('afilia')) keywords.push('affiliate');

            return keywords;
        }

        function getFollowUpFromNote(noteContent) {
            const lower = noteContent.toLowerCase();

            if (lower.includes('budżet') || lower.includes('pieniądz') || lower.includes('cena')) {
                return 'Rozmawialiśmy o finansach.';
            }
            if (lower.includes('czas') || lower.includes('godzin')) {
                return 'Gadaliśmy o czasie który możesz poświęcić.';
            }
            if (lower.includes('szef') || lower.includes('decyzj')) {
                return 'Miałeś porozmawiać z kimś o tym.';
            }

            return 'Chciałem sprawdzić jak sytuacja.';
        }

        function generateAllMessages() {
            showToast('Funkcja w przygotowaniu - użyj generowania pojedynczych wiadomości');
        }

        // ============================================
        // COPY FUNCTIONS
        // ============================================
        function copyMessage() {
            const text = document.getElementById('message-text').textContent;
            navigator.clipboard.writeText(text);
            showToast('Wiadomość skopiowana!');
        }

        function copyPhone() {
            if (!selectedLead?.phone) return;
            navigator.clipboard.writeText(selectedLead.phone);
            showToast('Numer skopiowany!');
        }

        function copyPrompt() {
            if (!selectedLead) return;

            const prompt = buildPromptForClaude(selectedLead);
            navigator.clipboard.writeText(prompt);
            showToast('Prompt skopiowany!');
        }

        function buildPromptForClaude(lead) {
            return `Napisz krótką, luźną wiadomość WhatsApp do leada. Styl: nieformalny, bez "Szanowny Panie", bardziej "hej co tam". Max 2-3 zdania.

## Dane leada
- Imię: ${lead.name || 'nieznane'}
- Status: ${lead.status}
- Cel dochodu: ${lead.target_income || 'nie podał'}
- Czas tygodniowo: ${lead.weekly_hours || 'nie podał'}
- Źródło: ${lead.lead_source || 'website'}

${lead.experience ? `## Co napisał o sobie\n${lead.experience}\n` : ''}

${lead.notes_history?.length ? `## Notatki z rozmów\n${lead.notes_history.map(n => `- ${n.content}`).join('\n')}\n` : ''}

## Kontekst
${lead.reasons.join('. ')}

## Cel wiadomości
${lead.suggestedAction === 'first_contact' ? 'Pierwszy kontakt - nawiąż relację' :
  lead.suggestedAction === 'close' ? 'Domknij - push do decyzji' :
  'Follow-up - sprawdź co słychać'}

Napisz TYLKO wiadomość, bez dodatkowych komentarzy.`;
        }

        // ============================================
        // HELPERS
        // ============================================
        function getTimeAgo(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / (1000 * 60));
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));

            if (minutes < 60) return `${minutes}m temu`;
            if (hours < 24) return `${hours}h temu`;
            if (days === 1) return 'wczoraj';
            if (days < 7) return `${days} dni temu`;
            return date.toLocaleDateString('pl-PL');
        }

        function formatHours(hours) {
            const labels = {
                '1-3h': '1-3h/tydz',
                '3-5h': '3-5h/tydz',
                '6-10h': '6-10h/tydz',
                '10-20h': '10-20h/tydz',
                'fulltime': 'Full-time'
            };
            return labels[hours] || hours || '-';
        }

        function showToast(text) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-text').textContent = text;
            toast.classList.remove('opacity-0', 'invisible', 'translate-y-2');
            toast.classList.add('opacity-100', 'visible', 'translate-y-0');

            setTimeout(() => {
                toast.classList.add('opacity-0', 'invisible', 'translate-y-2');
                toast.classList.remove('opacity-100', 'visible', 'translate-y-0');
            }, 3000);
        }

        // ============================================
        // INIT
        // ============================================
        async function init() {
            const session = await checkAuth();
            if (session) {
                await loadLeads();
            }
        }

        init();

        // Register service worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').catch(() => {});
        }
    </script>
</body>
</html>
