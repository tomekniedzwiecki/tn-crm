<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TN CRM - WhatsApp</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#050505">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="/components/shared-sidebar.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    }
                }
            }
        }
    </script>
    <style>
        body { background: #050505; color: #e5e5e5; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #444; }
        ::selection { background: white; color: black; }

        .glass-header {
            background: rgba(5, 5, 5, 0.85);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }

        .conversation-row {
            transition: all 0.15s ease;
        }
        .conversation-row:hover {
            background: rgba(255,255,255,0.04);
        }
        .conversation-row.selected {
            background: rgba(37, 211, 102, 0.1);
            border-left: 2px solid #25D366;
        }

        .message-bubble {
            max-width: 70%;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .message-inbound {
            background: #202c33;
            border-radius: 8px 8px 8px 0;
        }
        .message-outbound {
            background: #005c4b;
            border-radius: 8px 8px 0 8px;
        }

        .chat-bg {
            background-color: #0b141a;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.02'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        .stat-pill {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.06);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(4px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-in { animation: fadeIn 0.15s ease-out; }

        .empty-state {
            background: radial-gradient(ellipse at center, rgba(37, 211, 102, 0.05) 0%, transparent 70%);
        }

        /* Custom scrollbar for messages */
        #messages-container::-webkit-scrollbar { width: 5px; }
        #messages-container::-webkit-scrollbar-track { background: transparent; }
        #messages-container::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }
    </style>
</head>
<body class="h-screen flex overflow-hidden font-sans text-sm antialiased">

    <!-- Sidebar -->
    <aside id="sidebar" class="w-[280px] bg-zinc-950 border-r border-white/5 flex flex-col flex-shrink-0"></aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col min-w-0 h-screen">
        <!-- Header -->
        <header class="h-14 glass-header flex items-center justify-between px-4 md:px-6 flex-shrink-0 z-10">
            <div class="flex items-center gap-3">
                <button onclick="Sidebar.toggle()" class="mobile-menu-btn hidden items-center justify-center w-9 h-9 rounded-lg hover:bg-white/5 text-zinc-400">
                    <i class="ph ph-list text-xl"></i>
                </button>
                <div class="flex items-center gap-2">
                    <i class="ph ph-whatsapp-logo text-[#25D366] text-xl"></i>
                    <span class="text-white font-semibold">WhatsApp</span>
                    <span class="text-zinc-600 text-xs font-mono" id="total-count">-</span>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <div class="relative">
                    <i class="ph ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-zinc-500"></i>
                    <input type="text" id="search-input" placeholder="Szukaj..."
                        class="w-48 bg-zinc-900 border border-zinc-800 rounded-lg pl-9 pr-3 py-1.5 text-sm focus:outline-none focus:border-zinc-700 placeholder:text-zinc-600">
                </div>
                <button onclick="loadData()" class="p-2 text-zinc-400 hover:text-white hover:bg-white/5 rounded-lg transition-colors" title="Odswiez">
                    <i class="ph ph-arrows-clockwise"></i>
                </button>
            </div>
        </header>

        <!-- Stats Bar -->
        <div class="px-4 md:px-6 py-2 border-b border-white/5 flex items-center gap-3 overflow-x-auto flex-shrink-0 bg-zinc-950/50">
            <div class="stat-pill px-3 py-1 rounded-md flex items-center gap-2 text-xs whitespace-nowrap">
                <span class="text-zinc-500">Konwersacji:</span>
                <span class="text-white font-semibold font-mono" id="stat-conversations">-</span>
            </div>
            <div class="stat-pill px-3 py-1 rounded-md flex items-center gap-2 text-xs whitespace-nowrap">
                <span class="text-zinc-500">Wiadomosci:</span>
                <span class="text-[#25D366] font-semibold font-mono" id="stat-messages">-</span>
            </div>
            <div class="stat-pill px-3 py-1 rounded-md flex items-center gap-2 text-xs whitespace-nowrap">
                <span class="text-zinc-500">Z leadem:</span>
                <span class="text-emerald-400 font-semibold font-mono" id="stat-with-lead">-</span>
            </div>
            <div class="stat-pill px-3 py-1 rounded-md flex items-center gap-2 text-xs whitespace-nowrap">
                <span class="text-zinc-500">Bez leada:</span>
                <span class="text-amber-400 font-semibold font-mono" id="stat-without-lead">-</span>
            </div>
            <div class="ml-auto flex items-center gap-1">
                <button onclick="filterBy('all')" class="filter-btn px-2.5 py-1 text-xs rounded-md transition-colors text-zinc-400 hover:text-white hover:bg-white/5" data-filter="all">Wszystkie</button>
                <button onclick="filterBy('with-lead')" class="filter-btn px-2.5 py-1 text-xs rounded-md transition-colors text-zinc-400 hover:text-white hover:bg-white/5" data-filter="with-lead">Z leadem</button>
                <button onclick="filterBy('no-lead')" class="filter-btn px-2.5 py-1 text-xs rounded-md transition-colors text-zinc-400 hover:text-white hover:bg-white/5" data-filter="no-lead">Bez leada</button>
            </div>
        </div>

        <!-- Two Column Layout -->
        <div class="flex-1 flex min-h-0">
            <!-- Conversations List -->
            <div class="w-[340px] border-r border-white/5 flex flex-col min-h-0 flex-shrink-0 bg-zinc-950">
                <div id="conversations-list" class="flex-1 overflow-y-auto">
                    <!-- Loading -->
                    <div id="loading-state" class="flex items-center justify-center h-full">
                        <div class="text-center">
                            <div class="w-8 h-8 mx-auto mb-3 border-2 border-zinc-700 border-t-[#25D366] rounded-full animate-spin"></div>
                            <p class="text-zinc-500 text-sm">Laduje konwersacje...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat Detail -->
            <div id="chat-detail" class="flex-1 flex flex-col min-h-0 chat-bg">
                <div class="flex-1 flex items-center justify-center">
                    <div class="text-center empty-state p-16 rounded-2xl">
                        <i class="ph ph-chats-circle text-6xl text-zinc-700 mb-4"></i>
                        <p class="text-zinc-400 text-base">Wybierz konwersacje</p>
                        <p class="text-zinc-600 text-xs mt-2">aby zobaczyc historie wiadomosci</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-6 right-6 bg-zinc-800 border border-white/10 text-white px-4 py-3 rounded-lg shadow-xl z-50 flex items-center gap-2 opacity-0 invisible transition-all duration-300 transform translate-y-2">
        <i class="ph ph-check-circle text-emerald-400"></i>
        <span id="toast-text"></span>
    </div>

    <script>
        const SUPABASE_URL = 'https://yxmavwkwnfuphjqbelws.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl4bWF2d2t3bmZ1cGhqcWJlbHdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NjQyNTUsImV4cCI6MjA4NDM0MDI1NX0.XeR0Fc7OFn6YbNJrOKTBEj36JtmLISZTM87y4ai9340';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let conversations = [];
        let allMessages = [];
        let currentFilter = 'all';
        let searchQuery = '';
        let selectedPhone = null;

        Sidebar.render();
        Sidebar.setupLogout(supabaseClient);

        // ============================================
        // AUTH
        // ============================================
        async function checkAuth() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
                window.location.href = Sidebar.getLoginPath();
                return null;
            }
            Sidebar.setUserEmail(session.user.email.split('@')[0]);
            await loadTeamMembers(session.user.id);
            return session;
        }

        async function loadTeamMembers(userId) {
            const { data } = await supabaseClient.from('team_members').select('*');
            const currentMember = (data || []).find(m => m.user_id === userId);
            if (currentMember) {
                Sidebar.setUserName(currentMember.name);
                Sidebar.setUserColor(currentMember.color);
                Sidebar.setupProfileClick();
            }
            Sidebar.showAdminNav(currentMember?.role === 'admin');
        }

        // ============================================
        // DATA LOADING
        // ============================================
        async function loadData() {
            await Promise.all([
                loadConversations(),
                loadAllMessages()
            ]);
            renderConversations();
            updateStats();

            // Re-render selected chat if any
            if (selectedPhone) {
                await renderChatDetail(selectedPhone);
            }
        }

        async function loadConversations() {
            const { data, error } = await supabaseClient
                .from('whatsapp_conversations')
                .select('*')
                .order('last_message_at', { ascending: false });

            if (error) {
                console.error('Error loading conversations:', error);
                return;
            }

            conversations = data || [];
        }

        async function loadAllMessages() {
            // Ładujemy tylko ostatnie wiadomości do podglądu w liście konwersacji
            const { data, error } = await supabaseClient
                .from('whatsapp_messages')
                .select('*')
                .order('message_timestamp', { ascending: false })
                .limit(5000);

            if (error) {
                console.error('Error loading messages:', error);
                return;
            }

            allMessages = data || [];
        }

        // Ładuj wiadomości dla konkretnej konwersacji (bez limitu)
        async function loadMessagesForPhone(phoneNumber) {
            const { data, error } = await supabaseClient
                .from('whatsapp_messages')
                .select('*')
                .eq('phone_number', phoneNumber)
                .order('message_timestamp', { ascending: true });

            if (error) {
                console.error('Error loading messages for phone:', error);
                return [];
            }

            return data || [];
        }

        // ============================================
        // RENDERING
        // ============================================
        function renderConversations() {
            const container = document.getElementById('conversations-list');
            document.getElementById('loading-state')?.remove();

            let filtered = conversations;

            // Apply filter
            if (currentFilter === 'with-lead') {
                filtered = filtered.filter(c => c.lead_id);
            } else if (currentFilter === 'no-lead') {
                filtered = filtered.filter(c => !c.lead_id);
            }

            // Apply search
            if (searchQuery) {
                const q = searchQuery.toLowerCase();
                filtered = filtered.filter(c =>
                    (c.contact_name || '').toLowerCase().includes(q) ||
                    (c.phone_number || '').includes(q) ||
                    (c.lead_name || '').toLowerCase().includes(q)
                );
            }

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="flex items-center justify-center h-full">
                        <div class="text-center p-8">
                            <i class="ph ph-chats-circle text-4xl text-zinc-700 mb-3"></i>
                            <p class="text-zinc-500">Brak konwersacji</p>
                            <p class="text-zinc-600 text-xs mt-1">Uruchom rozszerzenie Chrome aby synchronizowac</p>
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = filtered.map(conv => {
                const isSelected = selectedPhone === conv.phone_number;
                const hasLead = !!conv.lead_id;
                const lastMsg = getLastMessage(conv.phone_number);
                const lastMsgPreview = lastMsg ? truncate(lastMsg.message_text, 40) : '';
                const lastMsgTime = conv.last_message_at ? formatTimeAgo(new Date(conv.last_message_at)) : '';
                const isOutbound = lastMsg?.direction === 'outbound';

                return `
                    <div class="conversation-row p-3 cursor-pointer border-b border-white/[0.03] ${isSelected ? 'selected' : ''}"
                         onclick="selectConversation('${conv.phone_number}')">
                        <div class="flex items-start gap-3">
                            <div class="w-11 h-11 rounded-full bg-gradient-to-br from-[#25D366]/20 to-[#128C7E]/20 flex items-center justify-center text-[#25D366] font-semibold flex-shrink-0 text-base">
                                ${(conv.contact_name || conv.phone_number || '?').charAt(0).toUpperCase()}
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center justify-between gap-2">
                                    <span class="text-white font-medium truncate">${conv.contact_name || 'Nieznany'}</span>
                                    <span class="text-[10px] text-zinc-500 flex-shrink-0">${lastMsgTime}</span>
                                </div>
                                <div class="flex items-center gap-2 mt-0.5">
                                    ${hasLead ? `
                                        <span class="text-[10px] px-1.5 py-0.5 bg-emerald-500/15 text-emerald-400 rounded">
                                            ${conv.lead_name || 'Lead'}
                                        </span>
                                    ` : `
                                        <span class="text-[10px] px-1.5 py-0.5 bg-zinc-800 text-zinc-500 rounded">
                                            Brak leada
                                        </span>
                                    `}
                                    <span class="text-[10px] text-zinc-600">${conv.message_count} wiad.</span>
                                </div>
                                ${lastMsgPreview ? `
                                    <div class="text-xs text-zinc-500 mt-1.5 truncate flex items-center gap-1">
                                        ${isOutbound ? '<i class="ph ph-arrow-bend-up-right text-[10px] text-zinc-600"></i>' : ''}
                                        ${escapeHtml(lastMsgPreview)}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function renderChatDetail(phoneNumber) {
            const container = document.getElementById('chat-detail');
            const conv = conversations.find(c => c.phone_number === phoneNumber);

            if (!conv) {
                container.innerHTML = `<div class="flex-1 flex items-center justify-center text-zinc-500">Nie znaleziono konwersacji</div>`;
                return;
            }

            // Pokaż loading
            container.innerHTML = `
                <div class="flex-1 flex items-center justify-center">
                    <div class="text-center">
                        <div class="w-8 h-8 mx-auto mb-3 border-2 border-zinc-700 border-t-[#25D366] rounded-full animate-spin"></div>
                        <p class="text-zinc-500 text-sm">Laduje wiadomosci...</p>
                    </div>
                </div>
            `;

            // Pobierz wiadomości dla tej konwersacji (bez limitu)
            const messages = await loadMessagesForPhone(phoneNumber);

            const hasLead = !!conv.lead_id;
            const whatsappLink = `https://web.whatsapp.com/send?phone=${phoneNumber}`;

            // Group messages by date
            const groupedMessages = {};
            messages.forEach(msg => {
                const date = new Date(msg.message_timestamp).toLocaleDateString('pl-PL', { day: 'numeric', month: 'long', year: 'numeric' });
                if (!groupedMessages[date]) groupedMessages[date] = [];
                groupedMessages[date].push(msg);
            });

            container.innerHTML = `
                <!-- Chat Header -->
                <div class="p-3 border-b border-white/5 flex items-center justify-between flex-shrink-0 bg-zinc-950/80 backdrop-blur-sm">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-[#25D366]/20 to-[#128C7E]/20 flex items-center justify-center text-[#25D366] font-semibold">
                            ${(conv.contact_name || '?').charAt(0).toUpperCase()}
                        </div>
                        <div>
                            <div class="text-white font-medium">${conv.contact_name || 'Nieznany'}</div>
                            <div class="text-xs text-zinc-500 font-mono">${phoneNumber}</div>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        ${hasLead ? `
                            <a href="/lead?id=${conv.lead_id}" class="px-3 py-1.5 bg-emerald-500/10 text-emerald-400 text-xs rounded-lg hover:bg-emerald-500/20 transition-colors flex items-center gap-1.5 border border-emerald-500/20">
                                <i class="ph ph-user"></i>
                                Otworz Lead
                            </a>
                        ` : `
                            <button onclick="createLead('${phoneNumber}', '${(conv.contact_name || '').replace(/'/g, "\\'")}', '${conv.lead_email || ''}')"
                                class="px-3 py-1.5 bg-amber-500/10 text-amber-400 text-xs rounded-lg hover:bg-amber-500/20 transition-colors flex items-center gap-1.5 border border-amber-500/20">
                                <i class="ph ph-user-plus"></i>
                                Utworz Lead
                            </button>
                        `}
                        <a href="${whatsappLink}" target="_blank" class="px-3 py-1.5 bg-[#25D366]/10 text-[#25D366] text-xs rounded-lg hover:bg-[#25D366]/20 transition-colors flex items-center gap-1.5 border border-[#25D366]/20">
                            <i class="ph ph-whatsapp-logo"></i>
                            Otworz WhatsApp
                        </a>
                    </div>
                </div>

                <!-- Messages Container -->
                <div class="flex-1 overflow-y-auto p-4 min-h-0" id="messages-container">
                    ${messages.length === 0 ? `
                        <div class="flex items-center justify-center h-full">
                            <div class="text-center">
                                <i class="ph ph-chat-circle-dots text-4xl text-zinc-700 mb-2"></i>
                                <p class="text-zinc-500">Brak wiadomosci</p>
                            </div>
                        </div>
                    ` : Object.entries(groupedMessages).map(([date, msgs]) => `
                        <div class="mb-4">
                            <div class="flex justify-center mb-3">
                                <span class="text-[10px] text-zinc-500 bg-zinc-900/80 px-3 py-1 rounded-full">${date}</span>
                            </div>
                            <div class="space-y-2">
                                ${msgs.map(msg => {
                                    const isOutbound = msg.direction === 'outbound';
                                    const time = new Date(msg.message_timestamp).toLocaleTimeString('pl-PL', {
                                        hour: '2-digit', minute: '2-digit'
                                    });

                                    return `
                                        <div class="flex ${isOutbound ? 'justify-end' : 'justify-start'} animate-in">
                                            <div class="message-bubble ${isOutbound ? 'message-outbound' : 'message-inbound'} px-3 py-2">
                                                <div class="text-[13px] text-white whitespace-pre-wrap break-words leading-relaxed">${escapeHtml(msg.message_text)}</div>
                                                <div class="text-[10px] ${isOutbound ? 'text-emerald-400/50' : 'text-zinc-500'} mt-1 text-right flex items-center justify-end gap-1">
                                                    ${time}
                                                    ${isOutbound ? '<i class="ph ph-checks text-[#53bdeb]"></i>' : ''}
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>

                <!-- Footer Info -->
                <div class="p-2.5 border-t border-white/5 text-xs text-zinc-500 flex items-center justify-between flex-shrink-0 bg-zinc-950/80">
                    <div class="flex items-center gap-4">
                        <span class="flex items-center gap-1"><i class="ph ph-arrow-down text-blue-400"></i> ${conv.inbound_count || 0}</span>
                        <span class="flex items-center gap-1"><i class="ph ph-arrow-up text-emerald-400"></i> ${conv.outbound_count || 0}</span>
                        <span class="text-zinc-600">Razem: ${conv.message_count || 0}</span>
                    </div>
                    <div>
                        ${conv.lead_status ? `<span class="px-2 py-0.5 rounded text-[10px] ${getStatusColor(conv.lead_status)}">${conv.lead_status}</span>` : ''}
                    </div>
                </div>
            `;

            // Scroll to bottom
            requestAnimationFrame(() => {
                const msgContainer = document.getElementById('messages-container');
                if (msgContainer) {
                    msgContainer.scrollTop = msgContainer.scrollHeight;
                }
            });
        }

        async function selectConversation(phoneNumber) {
            selectedPhone = phoneNumber;
            renderConversations();
            await renderChatDetail(phoneNumber);
        }

        // ============================================
        // ACTIONS
        // ============================================
        async function createLead(phone, name, email) {
            const leadData = {
                phone: phone,
                name: name || 'WhatsApp: ' + phone,
                email: email || null,
                source: 'whatsapp',
                status: 'new'
            };

            const { data, error } = await supabaseClient
                .from('leads')
                .insert([leadData])
                .select()
                .single();

            if (error) {
                showToast('Blad tworzenia leada: ' + error.message);
                return;
            }

            showToast('Lead utworzony!');

            // Update messages to link to this lead
            await supabaseClient
                .from('whatsapp_messages')
                .update({ lead_id: data.id })
                .eq('phone_number', phone);

            // Reload
            await loadData();
        }

        function filterBy(filter) {
            currentFilter = filter;

            // Update button styles
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('bg-white/10', 'text-white');
                btn.classList.add('text-zinc-400');
            });
            document.querySelector(`[data-filter="${filter}"]`)?.classList.add('bg-white/10', 'text-white');
            document.querySelector(`[data-filter="${filter}"]`)?.classList.remove('text-zinc-400');

            renderConversations();
        }

        // ============================================
        // HELPERS
        // ============================================
        function getLastMessage(phoneNumber) {
            return allMessages.find(m => m.phone_number === phoneNumber);
        }

        function updateStats() {
            const total = conversations.length;
            const withLead = conversations.filter(c => c.lead_id).length;
            const withoutLead = total - withLead;
            const totalMessages = allMessages.length;

            document.getElementById('total-count').textContent = `(${total})`;
            document.getElementById('stat-conversations').textContent = total;
            document.getElementById('stat-messages').textContent = totalMessages;
            document.getElementById('stat-with-lead').textContent = withLead;
            document.getElementById('stat-without-lead').textContent = withoutLead;
        }

        function formatTimeAgo(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / (1000 * 60));
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));

            if (minutes < 1) return 'teraz';
            if (minutes < 60) return `${minutes}m`;
            if (hours < 24) return `${hours}h`;
            if (days === 1) return 'wczoraj';
            if (days < 7) return `${days}d`;
            return date.toLocaleDateString('pl-PL', { day: '2-digit', month: '2-digit' });
        }

        function truncate(str, len) {
            if (!str) return '';
            return str.length > len ? str.substring(0, len) + '...' : str;
        }

        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        function getStatusColor(status) {
            const colors = {
                new: 'bg-emerald-500/20 text-emerald-400',
                contacted: 'bg-blue-500/20 text-blue-400',
                qualified: 'bg-amber-500/20 text-amber-400',
                proposal: 'bg-violet-500/20 text-violet-400',
                won: 'bg-green-500/20 text-green-400',
                lost: 'bg-red-500/20 text-red-400'
            };
            return colors[status] || 'bg-zinc-500/20 text-zinc-400';
        }

        function showToast(text) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-text').textContent = text;
            toast.classList.remove('opacity-0', 'invisible', 'translate-y-2');
            toast.classList.add('opacity-100', 'visible', 'translate-y-0');
            setTimeout(() => {
                toast.classList.add('opacity-0', 'invisible', 'translate-y-2');
                toast.classList.remove('opacity-100', 'visible', 'translate-y-0');
            }, 3000);
        }

        // ============================================
        // SEARCH
        // ============================================
        document.getElementById('search-input').addEventListener('input', (e) => {
            searchQuery = e.target.value;
            renderConversations();
        });

        // ============================================
        // INIT
        // ============================================
        async function init() {
            const session = await checkAuth();
            if (session) {
                filterBy('all');
                await loadData();
            }
        }

        init();

        // Auto-refresh every 60s
        setInterval(loadData, 60000);
    </script>
</body>
</html>
