<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TN Todo | Tablica</title>
    <link rel="icon" type="image/svg+xml" href="/tn-todo/favicon.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="components/sidebar.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body { background: #000; color: #ededed; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #444; }
        ::selection { background: white; color: black; }

        .glass-header {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid #262626;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-enter { animation: fadeIn 0.4s ease-out forwards; }

        /* Kanban - Vercel style */
        .kanban-board {
            display: flex;
            gap: 16px;
            overflow-x: auto;
            padding-bottom: 1rem;
            min-height: calc(100vh - 140px);
        }

        .kanban-list {
            flex: 0 0 320px;
            max-height: calc(100vh - 160px);
            display: flex;
            flex-direction: column;
            background: #0a0a0a;
            border: 1px solid #262626;
            border-radius: 12px;
            transition: all 0.2s ease;
        }
        .kanban-list:hover {
            border-color: #333;
        }

        .kanban-list-content {
            flex: 1;
            overflow-y: auto;
            min-height: 80px;
            padding: 8px;
        }

        /* Task card - Vercel style */
        .task-card {
            background: #171717;
            border: 1px solid #262626;
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 8px;
            cursor: grab;
            transition: all 0.15s ease;
            position: relative;
        }
        .task-card:hover {
            border-color: #404040;
            background: #1a1a1a;
        }
        .task-card:active {
            cursor: grabbing;
        }
        .task-card.dragging {
            opacity: 0.5;
            transform: rotate(2deg) scale(1.02);
        }

        /* Priority indicator */
        .task-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 12px;
            bottom: 12px;
            width: 3px;
            border-radius: 0 2px 2px 0;
        }
        .task-card.priority-low::before { background: #525252; }
        .task-card.priority-medium::before { background: #3b82f6; }
        .task-card.priority-high::before { background: #f59e0b; }
        .task-card.priority-urgent::before { background: #ef4444; }

        /* List drag states */
        .kanban-list.drag-over {
            border-color: #525252;
            background: #0f0f0f;
        }
        .kanban-list.list-dragging {
            opacity: 0.5;
        }
        .kanban-list.list-drag-target {
            border-color: #525252;
            box-shadow: 0 0 20px rgba(255,255,255,0.05);
        }

        .list-drag-handle {
            cursor: grab;
        }
        .list-drag-handle:active {
            cursor: grabbing;
        }

        /* Quick add form */
        .quick-add-form {
            display: none;
        }
        .quick-add-form.active {
            display: block;
        }

        /* Due date badges */
        .due-badge {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 6px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-weight: 500;
        }
        .due-badge.overdue {
            background: rgba(239, 68, 68, 0.15);
            color: #f87171;
        }
        .due-badge.today {
            background: rgba(245, 158, 11, 0.15);
            color: #fbbf24;
        }
        .due-badge.upcoming {
            background: #262626;
            color: #a3a3a3;
        }

        /* Card covers - Vercel */
        .task-cover {
            height: 6px;
            border-radius: 10px 10px 0 0;
            margin: -14px -14px 12px -14px;
        }
        .task-cover.cover-red { background: #ef4444; }
        .task-cover.cover-orange { background: #f97316; }
        .task-cover.cover-yellow { background: #eab308; }
        .task-cover.cover-green { background: #22c55e; }
        .task-cover.cover-teal { background: #14b8a6; }
        .task-cover.cover-blue { background: #3b82f6; }
        .task-cover.cover-purple { background: #a855f7; }
        .task-cover.cover-pink { background: #ec4899; }
        .task-cover.cover-gray { background: #6b7280; }

        /* Cover option selected */
        .cover-option.selected {
            box-shadow: 0 0 0 3px #fff;
            transform: scale(1.1);
        }

        /* Modal styles - Vercel */
        .modal-overlay {
            background: rgba(0, 0, 0, 0.7);
        }
        .modal-content {
            background: #000;
            border: 1px solid #262626;
            border-radius: 12px;
            box-shadow: 0 0 0 1px rgba(255,255,255,0.05), 0 25px 50px -12px rgba(0,0,0,0.8);
        }

        /* Tab styles */
        .task-tab.active {
            color: #fff;
            border-bottom-color: #fff;
        }
        .task-tab-content {
            min-height: 200px;
        }

        /* Activity items - Vercel */
        .activity-item-v2 {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid #262626;
        }
        .activity-item-v2:last-child {
            border-bottom: none;
        }

        /* Comment item - Vercel */
        .comment-item-v2 {
            padding: 16px;
            background: #0a0a0a;
            border: 1px solid #262626;
            border-radius: 12px;
        }

        /* Attachment item - Vercel */
        .attachment-item-v2 {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: #0a0a0a;
            border: 1px solid #262626;
            border-radius: 10px;
            transition: all 0.15s ease;
        }
        .attachment-item-v2:hover {
            border-color: #404040;
            background: #111;
        }

        /* Empty state */
        .empty-illustration {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #171717 0%, #0a0a0a 100%);
            border: 1px solid #262626;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Count badge */
        .count-badge {
            font-size: 11px;
            padding: 2px 6px;
            background: #262626;
            border-radius: 4px;
            color: #a3a3a3;
            font-weight: 500;
        }
    </style>
</head>
<body class="h-screen flex overflow-hidden font-sans text-sm antialiased">

    <!-- Sidebar -->
    <aside id="sidebar" class="w-[280px] bg-zinc-950 border-r border-white/5 flex flex-col flex-shrink-0"></aside>

    <!-- Main -->
    <main class="flex-1 flex flex-col relative min-w-0">
        <!-- Header -->
        <header class="h-14 glass-header flex items-center justify-between px-6 sticky top-0 z-30">
            <div class="flex items-center gap-2">
                <a href="boards.html" class="text-neutral-500 hover:text-white transition-colors text-sm">tn-todo</a>
                <span class="text-neutral-700">/</span>
                <span id="board-name-header" class="text-white font-medium text-sm">Ładowanie...</span>
            </div>
            <button onclick="openAddListModal()" class="bg-white text-black hover:bg-neutral-200 px-4 py-2 rounded-lg font-medium text-sm transition-all">
                Dodaj listę
            </button>
        </header>

        <!-- Kanban Board -->
        <div class="flex-1 overflow-x-auto p-6">
            <div id="kanban-board" class="kanban-board animate-enter">
                <div class="flex items-center justify-center w-full py-20">
                    <div class="flex items-center gap-3 text-neutral-500">
                        <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span>Ładowanie tablicy...</span>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Add List Modal -->
    <div id="modal-list" class="fixed inset-0 modal-overlay z-50 hidden items-center justify-center p-4">
        <div class="modal-content w-full max-w-sm">
            <div class="flex items-center justify-between px-5 py-4 border-b border-neutral-800">
                <h2 id="list-modal-title" class="text-base font-semibold text-white">Nowa lista</h2>
                <button onclick="closeListModal()" class="w-8 h-8 flex items-center justify-center text-neutral-500 hover:text-white hover:bg-neutral-900 rounded-lg transition-all">
                    <i class="ph ph-x text-lg"></i>
                </button>
            </div>
            <div class="p-5">
                <input type="hidden" id="list-id">
                <input type="text" id="list-name" placeholder="np. Do zrobienia, W trakcie..."
                    class="w-full bg-neutral-900 border border-neutral-800 text-white rounded-lg px-4 py-3 text-sm placeholder:text-neutral-600 focus:outline-none focus:border-neutral-700 mb-5" autofocus>
                <div class="flex gap-3">
                    <button onclick="closeListModal()" class="flex-1 px-4 py-2.5 text-sm text-neutral-400 hover:text-white bg-transparent hover:bg-neutral-900 border border-neutral-800 rounded-lg font-medium transition-all">
                        Anuluj
                    </button>
                    <button onclick="saveList()" class="flex-1 px-4 py-2.5 text-sm text-black bg-white hover:bg-neutral-200 rounded-lg font-medium transition-all">
                        Zapisz
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Task Modal - Full Vercel Style -->
    <div id="modal-task" class="fixed inset-0 modal-overlay z-50 hidden items-start justify-center overflow-y-auto p-4">
        <div class="modal-content w-full max-w-3xl my-12">
            <input type="hidden" id="task-id">
            <input type="hidden" id="task-list-id">
            <input type="hidden" id="task-cover-color">

            <!-- Header with Title Input -->
            <div class="p-6 pb-0">
                <div class="flex items-start justify-between gap-4">
                    <div class="flex-1">
                        <input type="text" id="task-title" placeholder="Nazwa zadania"
                            class="w-full bg-transparent text-2xl font-semibold text-white placeholder:text-neutral-600 focus:outline-none border-none p-0">
                    </div>
                    <div class="flex items-center gap-1 shrink-0">
                        <button id="task-delete-btn" onclick="deleteTask()" class="w-9 h-9 flex items-center justify-center text-neutral-500 hover:text-red-400 hover:bg-neutral-900 rounded-lg transition-all hidden">
                            <i class="ph ph-trash text-lg"></i>
                        </button>
                        <button onclick="closeTaskModal()" class="w-9 h-9 flex items-center justify-center text-neutral-500 hover:text-white hover:bg-neutral-900 rounded-lg transition-all">
                            <i class="ph ph-x text-lg"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="px-6 mt-6">
                <div class="flex gap-1 border-b border-neutral-800">
                    <button onclick="switchTaskTab('details')" class="task-tab active px-4 py-3 text-sm font-medium text-neutral-400 hover:text-white border-b-2 border-transparent transition-all" data-tab="details">
                        Szczegóły
                    </button>
                    <button onclick="switchTaskTab('comments')" class="task-tab px-4 py-3 text-sm font-medium text-neutral-400 hover:text-white border-b-2 border-transparent transition-all" data-tab="comments">
                        <span class="flex items-center gap-2">Komentarze <span id="comments-count-badge" class="text-xs bg-neutral-800 px-1.5 py-0.5 rounded hidden">0</span></span>
                    </button>
                    <button onclick="switchTaskTab('attachments')" class="task-tab px-4 py-3 text-sm font-medium text-neutral-400 hover:text-white border-b-2 border-transparent transition-all" data-tab="attachments">
                        Załączniki
                    </button>
                    <button onclick="switchTaskTab('activity')" class="task-tab px-4 py-3 text-sm font-medium text-neutral-400 hover:text-white border-b-2 border-transparent transition-all" data-tab="activity">
                        Historia
                    </button>
                </div>
            </div>

            <!-- Tab Content -->
            <div class="p-6">
                <!-- Details Tab -->
                <div id="tab-details" class="task-tab-content space-y-6">
                    <!-- Description -->
                    <div>
                        <label class="block text-xs font-medium text-neutral-500 uppercase tracking-wider mb-3">Opis</label>
                        <textarea id="task-description" rows="4" placeholder="Dodaj opis zadania..."
                            class="w-full bg-neutral-900 border border-neutral-800 text-white text-sm rounded-lg px-4 py-3 placeholder:text-neutral-600 focus:outline-none focus:border-neutral-700 resize-none transition-all"></textarea>
                    </div>

                    <!-- Options Row -->
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-neutral-500 uppercase tracking-wider mb-3">Priorytet</label>
                            <select id="task-priority" class="w-full bg-neutral-900 border border-neutral-800 text-neutral-300 text-sm rounded-lg px-4 py-3 focus:outline-none focus:border-neutral-700 cursor-pointer">
                                <option value="low">Niski</option>
                                <option value="medium" selected>Średni</option>
                                <option value="high">Wysoki</option>
                                <option value="urgent">Pilny</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-neutral-500 uppercase tracking-wider mb-3">Termin</label>
                            <input type="date" id="task-due-date" class="w-full bg-neutral-900 border border-neutral-800 text-neutral-300 text-sm rounded-lg px-4 py-3 focus:outline-none focus:border-neutral-700 cursor-pointer">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-neutral-500 uppercase tracking-wider mb-3">Osoba</label>
                            <select id="task-assigned" class="w-full bg-neutral-900 border border-neutral-800 text-neutral-300 text-sm rounded-lg px-4 py-3 focus:outline-none focus:border-neutral-700 cursor-pointer">
                                <option value="">Nieprzypisane</option>
                            </select>
                        </div>
                    </div>

                    <!-- Cover Color -->
                    <div>
                        <label class="block text-xs font-medium text-neutral-500 uppercase tracking-wider mb-3">Kolor etykiety</label>
                        <div class="flex gap-2" id="cover-colors">
                            <button type="button" onclick="selectCover(null)" class="w-10 h-10 rounded-lg bg-neutral-900 border border-neutral-800 hover:border-neutral-600 transition-all flex items-center justify-center cover-option" data-color="">
                                <i class="ph ph-prohibit text-neutral-600"></i>
                            </button>
                            <button type="button" onclick="selectCover('red')" class="w-10 h-10 rounded-lg bg-red-500 hover:scale-105 transition-all cover-option" data-color="red"></button>
                            <button type="button" onclick="selectCover('orange')" class="w-10 h-10 rounded-lg bg-orange-500 hover:scale-105 transition-all cover-option" data-color="orange"></button>
                            <button type="button" onclick="selectCover('yellow')" class="w-10 h-10 rounded-lg bg-yellow-500 hover:scale-105 transition-all cover-option" data-color="yellow"></button>
                            <button type="button" onclick="selectCover('green')" class="w-10 h-10 rounded-lg bg-green-500 hover:scale-105 transition-all cover-option" data-color="green"></button>
                            <button type="button" onclick="selectCover('teal')" class="w-10 h-10 rounded-lg bg-teal-500 hover:scale-105 transition-all cover-option" data-color="teal"></button>
                            <button type="button" onclick="selectCover('blue')" class="w-10 h-10 rounded-lg bg-blue-500 hover:scale-105 transition-all cover-option" data-color="blue"></button>
                            <button type="button" onclick="selectCover('purple')" class="w-10 h-10 rounded-lg bg-purple-500 hover:scale-105 transition-all cover-option" data-color="purple"></button>
                            <button type="button" onclick="selectCover('pink')" class="w-10 h-10 rounded-lg bg-pink-500 hover:scale-105 transition-all cover-option" data-color="pink"></button>
                        </div>
                    </div>
                </div>

                <!-- Comments Tab -->
                <div id="tab-comments" class="task-tab-content hidden">
                    <div id="comments-list" class="space-y-4 mb-6 max-h-80 overflow-y-auto"></div>
                    <div class="flex gap-3 pt-4 border-t border-neutral-800">
                        <input type="text" id="comment-input" placeholder="Napisz komentarz..."
                            class="flex-1 bg-neutral-900 border border-neutral-800 text-white text-sm rounded-lg px-4 py-3 placeholder:text-neutral-600 focus:outline-none focus:border-neutral-700 transition-all"
                            onkeydown="if(event.key==='Enter')addComment()">
                        <button onclick="addComment()" class="px-5 py-3 bg-white text-black text-sm font-medium rounded-lg hover:bg-neutral-200 transition-all">
                            Wyślij
                        </button>
                    </div>
                </div>

                <!-- Attachments Tab -->
                <div id="tab-attachments" class="task-tab-content hidden">
                    <div id="attachments-list" class="space-y-3 mb-6"></div>
                    <label class="flex flex-col items-center justify-center gap-3 p-8 bg-neutral-900/50 border-2 border-dashed border-neutral-800 hover:border-neutral-600 rounded-xl cursor-pointer transition-all group">
                        <div class="w-12 h-12 rounded-full bg-neutral-800 group-hover:bg-neutral-700 flex items-center justify-center transition-all">
                            <i class="ph ph-cloud-arrow-up text-2xl text-neutral-400"></i>
                        </div>
                        <div class="text-center">
                            <span class="text-sm font-medium text-white">Kliknij, aby dodać plik</span>
                            <p class="text-xs text-neutral-500 mt-1">lub przeciągnij i upuść</p>
                        </div>
                        <input type="file" id="attachment-input" class="hidden" onchange="uploadAttachment(event)">
                    </label>
                </div>

                <!-- Activity Tab -->
                <div id="tab-activity" class="task-tab-content hidden">
                    <div id="activity-list" class="space-y-1"></div>
                </div>
            </div>

            <!-- Footer -->
            <div class="flex items-center justify-between px-6 py-4 border-t border-neutral-800 bg-neutral-950/50 rounded-b-xl">
                <div id="task-cover-preview" class="flex items-center gap-2">
                    <!-- Cover preview will be shown here -->
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="closeTaskModal()" class="px-5 py-2.5 text-sm text-neutral-400 hover:text-white bg-transparent hover:bg-neutral-900 border border-neutral-800 rounded-lg font-medium transition-all">
                        Anuluj
                    </button>
                    <button onclick="saveTask()" class="px-5 py-2.5 text-sm text-black bg-white hover:bg-neutral-200 rounded-lg font-medium transition-all">
                        Zapisz zmiany
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-6 right-6 bg-neutral-900 border border-neutral-800 text-white px-4 py-3 rounded-lg shadow-xl transform translate-y-20 opacity-0 transition-all duration-300 z-50 flex items-center gap-2">
        <i class="ph ph-check-circle text-emerald-400"></i>
        <span id="toast-message"></span>
    </div>

    <script>
        const SUPABASE_URL = 'https://yxmavwkwnfuphjqbelws.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl4bWF2d2t3bmZ1cGhqcWJlbHdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NjQyNTUsImV4cCI6MjA4NDM0MDI1NX0.XeR0Fc7OFn6YbNJrOKTBEj36JtmLISZTM87y4ai9340';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // State
        let board = null;
        let lists = [];
        let teamMembers = [];
        let currentTeamMember = null;
        let draggedTask = null;
        let draggedListId = null;
        let draggedListIndex = null;
        let canDragList = false;

        // Get board ID from URL
        function getBoardId() {
            const params = new URLSearchParams(window.location.search);
            return params.get('id');
        }

        // Auth check
        async function checkAuth() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
                window.location.href = '/tn-crm/index.html';
                return null;
            }
            Sidebar.setUserEmail(session.user.email.split('@')[0]);

            const { data: teamMember } = await supabaseClient
                .from('team_members')
                .select('id, role, name, color')
                .eq('user_id', session.user.id)
                .single();

            if (teamMember) {
                currentTeamMember = teamMember;
                Sidebar.setUserName(teamMember.name);
                Sidebar.setUserColor(teamMember.color);
            }

            return session;
        }

        // Load team members
        async function loadTeamMembers() {
            const { data } = await supabaseClient
                .from('team_members')
                .select('id, name, color')
                .order('name');

            teamMembers = data || [];

            const select = document.getElementById('task-assigned');
            select.innerHTML = '<option value="">Nieprzypisane</option>' +
                teamMembers.map(m => `<option value="${m.id}">${escapeHtml(m.name)}</option>`).join('');
        }

        // Load board
        async function loadBoard() {
            const boardId = getBoardId();
            if (!boardId) {
                window.location.href = 'boards.html';
                return;
            }

            const { data, error } = await supabaseClient
                .from('todo_boards')
                .select('*')
                .eq('id', boardId)
                .single();

            if (error || !data) {
                window.location.href = 'boards.html';
                return;
            }

            board = data;
            document.getElementById('board-name-header').textContent = board.name;
            document.title = `TN Todo | ${board.name}`;

            await loadLists();
        }

        async function loadLists() {
            const { data, error } = await supabaseClient
                .from('todo_lists')
                .select(`
                    *,
                    tasks:todo_tasks(
                        *,
                        assigned_member:team_members!assigned_to(id, name, color),
                        comments:todo_comments(count),
                        attachments:todo_attachments(count)
                    )
                `)
                .eq('board_id', board.id)
                .order('position')
                .order('position', { foreignTable: 'todo_tasks' });

            if (error) return;

            lists = (data || []).map(list => ({
                ...list,
                tasks: (list.tasks || []).map(task => ({
                    ...task,
                    comments_count: task.comments?.[0]?.count || 0,
                    attachments_count: task.attachments?.[0]?.count || 0
                }))
            }));

            renderKanban();
        }

        function renderKanban() {
            const container = document.getElementById('kanban-board');

            if (lists.length === 0) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center w-full py-20">
                        <div class="empty-illustration mb-6">
                            <i class="ph ph-list-plus text-3xl text-neutral-600"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-white mb-2">Brak list</h3>
                        <p class="text-neutral-500 mb-6 text-center max-w-sm">Dodaj pierwszą listę, np. "Do zrobienia", "W trakcie", "Zrobione".</p>
                        <button onclick="openAddListModal()" class="px-5 py-2.5 bg-white text-black hover:bg-neutral-200 rounded-lg text-sm font-medium transition-all">
                            Dodaj listę
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = lists.map((list, index) => `
                <div class="kanban-list group"
                     data-list-id="${list.id}"
                     data-list-index="${index}"
                     draggable="true"
                     ondragstart="handleListDragStart(event, '${list.id}', ${index})"
                     ondragend="handleListDragEnd(event)"
                     ondragover="handleListDragOver(event, ${index})"
                     ondrop="handleListDrop(event, ${index})">
                    <!-- List Header -->
                    <div class="flex items-center justify-between px-4 py-3 border-b border-neutral-800 list-drag-handle">
                        <div class="flex items-center gap-3">
                            <i class="ph ph-dots-six-vertical text-neutral-600 cursor-grab"></i>
                            <h3 class="font-semibold text-white text-sm">${escapeHtml(list.name)}</h3>
                            <span class="count-badge">${list.tasks?.length || 0}</span>
                        </div>
                        <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="event.stopPropagation(); editList('${list.id}')" class="w-7 h-7 flex items-center justify-center text-neutral-500 hover:text-white hover:bg-neutral-800 rounded-md transition-all">
                                <i class="ph ph-pencil-simple text-sm"></i>
                            </button>
                            <button onclick="event.stopPropagation(); deleteList('${list.id}')" class="w-7 h-7 flex items-center justify-center text-neutral-500 hover:text-red-400 hover:bg-red-500/10 rounded-md transition-all">
                                <i class="ph ph-trash text-sm"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Tasks -->
                    <div class="kanban-list-content" data-list-id="${list.id}" ondragover="handleDragOver(event)" ondrop="handleDrop(event, '${list.id}')" ondragleave="handleDragLeave(event)">
                        ${(list.tasks || []).map(task => renderTaskCard(task)).join('')}
                    </div>

                    <!-- Quick Add -->
                    <div class="p-2 border-t border-neutral-800">
                        <div id="quick-add-${list.id}" class="quick-add-form mb-2">
                            <input type="text"
                                   id="quick-input-${list.id}"
                                   placeholder="Tytuł zadania..."
                                   class="w-full bg-neutral-900 border border-neutral-800 text-white rounded-lg px-3 py-2.5 text-sm focus:outline-none focus:border-neutral-700 mb-2"
                                   onkeydown="handleQuickAddKeydown(event, '${list.id}')">
                            <div class="flex gap-2">
                                <button onclick="submitQuickAdd('${list.id}')" class="flex-1 px-3 py-2 bg-white text-black rounded-lg text-xs font-medium transition-all hover:bg-neutral-200">
                                    Dodaj
                                </button>
                                <button onclick="closeQuickAdd('${list.id}')" class="px-3 py-2 bg-neutral-800 hover:bg-neutral-700 text-neutral-300 rounded-lg text-xs font-medium transition-all">
                                    <i class="ph ph-x"></i>
                                </button>
                            </div>
                        </div>
                        <button onclick="openQuickAdd('${list.id}')" id="quick-btn-${list.id}" class="w-full px-3 py-2.5 text-neutral-500 hover:text-white hover:bg-neutral-800 rounded-lg text-sm transition-all flex items-center gap-2">
                            <i class="ph ph-plus"></i>
                            Dodaj zadanie
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function renderTaskCard(task) {
            const priority = task.priority || 'medium';
            const hasDueDate = task.due_date;
            const dueDate = hasDueDate ? new Date(task.due_date) : null;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const isOverdue = dueDate && dueDate < today && !task.is_completed;
            const isToday = dueDate && dueDate.toDateString() === today.toDateString();

            let assigneeHtml = '';
            if (task.assigned_member) {
                const initials = task.assigned_member.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                const color = task.assigned_member.color || 'violet';
                assigneeHtml = `
                    <div class="w-6 h-6 rounded-full bg-gradient-to-b from-${color}-500 to-${color}-600 flex items-center justify-center text-[10px] font-medium text-white" title="${escapeHtml(task.assigned_member.name)}">
                        ${initials}
                    </div>
                `;
            }

            let dueBadgeClass = 'upcoming';
            if (isOverdue) dueBadgeClass = 'overdue';
            else if (isToday) dueBadgeClass = 'today';

            const coverHtml = task.cover_color
                ? `<div class="task-cover cover-${task.cover_color}"></div>`
                : '';

            const hasComments = task.comments_count > 0;
            const hasAttachments = task.attachments_count > 0;

            return `
                <div class="task-card priority-${priority}"
                     draggable="true"
                     data-task-id="${task.id}"
                     ondragstart="handleDragStart(event, '${task.id}')"
                     ondragend="handleDragEnd(event)"
                     onclick="openEditTaskModal('${task.id}')">
                    ${coverHtml}
                    <p class="text-sm text-white mb-2 leading-relaxed ${task.is_completed ? 'line-through text-neutral-500' : ''}">${escapeHtml(task.title)}</p>
                    ${task.description ? `<p class="text-xs text-neutral-500 mb-3 line-clamp-2">${escapeHtml(task.description)}</p>` : ''}
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            ${hasDueDate ? `
                                <span class="due-badge ${dueBadgeClass}">
                                    <i class="ph ph-calendar-blank"></i>
                                    ${formatDate(task.due_date)}
                                </span>
                            ` : ''}
                            ${hasComments ? `<span class="text-xs text-neutral-500 flex items-center gap-1"><i class="ph ph-chat-circle"></i>${task.comments_count}</span>` : ''}
                            ${hasAttachments ? `<span class="text-xs text-neutral-500 flex items-center gap-1"><i class="ph ph-paperclip"></i>${task.attachments_count}</span>` : ''}
                        </div>
                        ${assigneeHtml}
                    </div>
                </div>
            `;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);

            if (date.toDateString() === today.toDateString()) return 'Dziś';
            if (date.toDateString() === tomorrow.toDateString()) return 'Jutro';

            return date.toLocaleDateString('pl-PL', { day: 'numeric', month: 'short' });
        }

        // Task Drag and Drop
        function handleDragStart(event, taskId) {
            event.stopPropagation();
            draggedTask = taskId;
            event.target.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', 'task:' + taskId);
        }

        function handleDragEnd(event) {
            event.target.classList.remove('dragging');
            document.querySelectorAll('.kanban-list').forEach(list => list.classList.remove('drag-over'));
            draggedTask = null;
        }

        function handleDragOver(event) {
            if (draggedListId !== null) return;
            event.preventDefault();
            event.stopPropagation();
            event.dataTransfer.dropEffect = 'move';
            const listContent = event.currentTarget;
            listContent.closest('.kanban-list').classList.add('drag-over');
        }

        function handleDragLeave(event) {
            const listContent = event.currentTarget;
            listContent.closest('.kanban-list').classList.remove('drag-over');
        }

        async function handleDrop(event, listId) {
            if (draggedListId !== null) return;
            event.preventDefault();
            event.stopPropagation();
            const listContent = event.currentTarget;
            listContent.closest('.kanban-list').classList.remove('drag-over');

            if (!draggedTask) return;

            let task = null;
            let sourceListId = null;
            for (const list of lists) {
                task = list.tasks?.find(t => t.id === draggedTask);
                if (task) {
                    sourceListId = list.id;
                    break;
                }
            }

            if (!task) return;

            const targetList = lists.find(l => l.id === listId);
            const tasksInTarget = targetList?.tasks || [];
            let newPosition = tasksInTarget.length;

            const taskCards = listContent.querySelectorAll('.task-card');
            const dropY = event.clientY;

            for (let i = 0; i < taskCards.length; i++) {
                const card = taskCards[i];
                const rect = card.getBoundingClientRect();
                const cardMiddle = rect.top + rect.height / 2;

                if (dropY < cardMiddle) {
                    newPosition = i;
                    break;
                }
            }

            if (sourceListId === listId) {
                const currentIndex = tasksInTarget.findIndex(t => t.id === draggedTask);
                if (currentIndex === newPosition || currentIndex === newPosition - 1) {
                    return;
                }
                if (currentIndex < newPosition) {
                    newPosition--;
                }
            }

            const { error } = await supabaseClient
                .from('todo_tasks')
                .update({ list_id: listId, position: newPosition })
                .eq('id', draggedTask);

            if (error) {
                showToast('Błąd przenoszenia zadania', 'error');
                return;
            }

            await logActivity(draggedTask, 'moved', { from_list: sourceListId, to_list: listId });
            await loadLists();
        }

        // List Drag and Drop
        function handleListDragStart(event, listId, index) {
            if (!canDragList) {
                event.preventDefault();
                return;
            }
            draggedListId = listId;
            draggedListIndex = index;
            event.target.classList.add('list-dragging');
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', listId);
        }

        function handleListDragEnd(event) {
            event.target.classList.remove('list-dragging');
            document.querySelectorAll('.kanban-list').forEach(el => el.classList.remove('list-drag-target'));
            draggedListId = null;
            draggedListIndex = null;
            canDragList = false;
        }

        function handleListDragOver(event, targetIndex) {
            if (draggedListId === null) return;
            event.preventDefault();
            event.stopPropagation();
            event.dataTransfer.dropEffect = 'move';

            document.querySelectorAll('.kanban-list').forEach((el, idx) => {
                if (idx === targetIndex && targetIndex !== draggedListIndex) {
                    el.classList.add('list-drag-target');
                } else {
                    el.classList.remove('list-drag-target');
                }
            });
        }

        async function handleListDrop(event, targetIndex) {
            if (draggedListId === null || draggedListIndex === null) return;
            event.preventDefault();
            event.stopPropagation();

            document.querySelectorAll('.kanban-list').forEach(el => el.classList.remove('list-drag-target'));

            if (draggedListIndex === targetIndex) return;

            const updates = [];
            const newLists = [...lists];
            const [movedList] = newLists.splice(draggedListIndex, 1);
            newLists.splice(targetIndex, 0, movedList);

            for (let i = 0; i < newLists.length; i++) {
                if (newLists[i].position !== i) {
                    updates.push(
                        supabaseClient
                            .from('todo_lists')
                            .update({ position: i })
                            .eq('id', newLists[i].id)
                    );
                }
            }

            if (updates.length > 0) {
                await Promise.all(updates);
                await loadLists();
            }

            draggedListId = null;
            draggedListIndex = null;
        }

        // List Modal
        function openAddListModal() {
            document.getElementById('list-id').value = '';
            document.getElementById('list-name').value = '';
            document.getElementById('list-modal-title').textContent = 'Nowa lista';
            document.getElementById('modal-list').classList.remove('hidden');
            document.getElementById('modal-list').classList.add('flex');
            setTimeout(() => document.getElementById('list-name').focus(), 100);
        }

        function editList(listId) {
            const list = lists.find(l => l.id === listId);
            if (!list) return;

            document.getElementById('list-id').value = list.id;
            document.getElementById('list-name').value = list.name;
            document.getElementById('list-modal-title').textContent = 'Edytuj listę';
            document.getElementById('modal-list').classList.remove('hidden');
            document.getElementById('modal-list').classList.add('flex');
            setTimeout(() => document.getElementById('list-name').focus(), 100);
        }

        function closeListModal() {
            document.getElementById('modal-list').classList.add('hidden');
            document.getElementById('modal-list').classList.remove('flex');
        }

        async function saveList() {
            const id = document.getElementById('list-id').value;
            const name = document.getElementById('list-name').value.trim();

            if (!name) {
                showToast('Podaj nazwę listy', 'error');
                return;
            }

            let error;
            if (id) {
                const result = await supabaseClient
                    .from('todo_lists')
                    .update({ name })
                    .eq('id', id);
                error = result.error;
            } else {
                const position = lists.length;
                const result = await supabaseClient
                    .from('todo_lists')
                    .insert({ board_id: board.id, name, position });
                error = result.error;
            }

            if (error) {
                showToast('Błąd zapisu listy', 'error');
                return;
            }

            closeListModal();
            await loadLists();
            showToast(id ? 'Lista zaktualizowana' : 'Lista utworzona');
        }

        async function deleteList(listId) {
            if (!confirm('Usunąć listę wraz z wszystkimi zadaniami?')) return;

            const { error } = await supabaseClient
                .from('todo_lists')
                .delete()
                .eq('id', listId);

            if (error) {
                showToast('Błąd usuwania listy', 'error');
                return;
            }

            await loadLists();
            showToast('Lista usunięta');
        }

        // Quick Add
        function openQuickAdd(listId) {
            document.getElementById(`quick-add-${listId}`).classList.add('active');
            document.getElementById(`quick-btn-${listId}`).style.display = 'none';
            document.getElementById(`quick-input-${listId}`).focus();
        }

        function closeQuickAdd(listId) {
            document.getElementById(`quick-add-${listId}`).classList.remove('active');
            document.getElementById(`quick-btn-${listId}`).style.display = 'flex';
            document.getElementById(`quick-input-${listId}`).value = '';
        }

        function handleQuickAddKeydown(event, listId) {
            if (event.key === 'Enter') {
                event.preventDefault();
                submitQuickAdd(listId);
            } else if (event.key === 'Escape') {
                closeQuickAdd(listId);
            }
        }

        async function submitQuickAdd(listId) {
            const input = document.getElementById(`quick-input-${listId}`);
            const title = input.value.trim();

            if (!title) {
                closeQuickAdd(listId);
                return;
            }

            const list = lists.find(l => l.id === listId);
            const position = list?.tasks?.length || 0;

            const { data, error } = await supabaseClient
                .from('todo_tasks')
                .insert({
                    list_id: listId,
                    title: title,
                    position: position,
                    priority: 'medium',
                    created_by: currentTeamMember?.id || null
                })
                .select('id')
                .single();

            if (error) {
                showToast('Błąd dodawania zadania', 'error');
                return;
            }

            if (data?.id) {
                await logActivity(data.id, 'created', {});
            }

            closeQuickAdd(listId);
            await loadLists();
        }

        // Task Modal
        function openAddTaskModal(listId) {
            document.getElementById('task-id').value = '';
            document.getElementById('task-list-id').value = listId;
            document.getElementById('task-title').value = '';
            document.getElementById('task-description').value = '';
            document.getElementById('task-priority').value = 'medium';
            document.getElementById('task-due-date').value = '';
            document.getElementById('task-assigned').value = '';
            document.getElementById('task-cover-color').value = '';

            document.getElementById('task-delete-btn').classList.add('hidden');
            switchTaskTab('details');

            document.getElementById('comments-list').innerHTML = '<p class="text-neutral-500 text-sm text-center py-8">Zapisz zadanie, aby dodać komentarze.</p>';
            document.getElementById('attachments-list').innerHTML = '';
            document.getElementById('activity-list').innerHTML = '<p class="text-neutral-500 text-sm text-center py-8">Brak historii.</p>';

            selectCover(null);

            document.getElementById('modal-task').classList.remove('hidden');
            document.getElementById('modal-task').classList.add('flex');
            setTimeout(() => document.getElementById('task-title').focus(), 100);
        }

        async function openEditTaskModal(taskId) {
            let task = null;
            for (const list of lists) {
                task = list.tasks?.find(t => t.id === taskId);
                if (task) break;
            }
            if (!task) return;

            document.getElementById('task-id').value = task.id;
            document.getElementById('task-list-id').value = task.list_id;
            document.getElementById('task-title').value = task.title;
            document.getElementById('task-description').value = task.description || '';
            document.getElementById('task-priority').value = task.priority || 'medium';
            document.getElementById('task-due-date').value = task.due_date ? task.due_date.split('T')[0] : '';
            document.getElementById('task-assigned').value = task.assigned_to || '';
            document.getElementById('task-cover-color').value = task.cover_color || '';

            document.getElementById('task-delete-btn').classList.remove('hidden');
            switchTaskTab('details');
            selectCover(task.cover_color);

            document.getElementById('modal-task').classList.remove('hidden');
            document.getElementById('modal-task').classList.add('flex');

            await Promise.all([
                loadComments(taskId),
                loadAttachments(taskId),
                loadActivity(taskId)
            ]);
        }

        function closeTaskModal() {
            document.getElementById('modal-task').classList.add('hidden');
            document.getElementById('modal-task').classList.remove('flex');
        }

        async function saveTask() {
            const id = document.getElementById('task-id').value;
            const listId = document.getElementById('task-list-id').value;
            const title = document.getElementById('task-title').value.trim();
            const description = document.getElementById('task-description').value.trim();
            const priority = document.getElementById('task-priority').value;
            const dueDate = document.getElementById('task-due-date').value;
            const assignedTo = document.getElementById('task-assigned').value;
            const coverColor = document.getElementById('task-cover-color').value;

            if (!title) {
                showToast('Podaj tytuł zadania', 'error');
                return;
            }

            const taskData = {
                title,
                description: description || null,
                priority,
                due_date: dueDate || null,
                assigned_to: assignedTo || null,
                cover_color: coverColor || null
            };

            let error;
            let newTaskId = id;
            if (id) {
                const result = await supabaseClient
                    .from('todo_tasks')
                    .update(taskData)
                    .eq('id', id);
                error = result.error;

                if (!error) {
                    await logActivity(id, 'updated', { fields: Object.keys(taskData) });
                }
            } else {
                const list = lists.find(l => l.id === listId);
                const position = list?.tasks?.length || 0;
                taskData.list_id = listId;
                taskData.position = position;
                taskData.created_by = currentTeamMember?.id || null;
                const result = await supabaseClient
                    .from('todo_tasks')
                    .insert(taskData)
                    .select('id')
                    .single();
                error = result.error;
                newTaskId = result.data?.id;

                if (!error && newTaskId) {
                    await logActivity(newTaskId, 'created', {});
                }
            }

            if (error) {
                showToast('Błąd zapisu zadania', 'error');
                return;
            }

            closeTaskModal();
            await loadLists();
            showToast(id ? 'Zadanie zaktualizowane' : 'Zadanie utworzone');
        }

        async function deleteTask() {
            const taskId = document.getElementById('task-id').value;
            if (!taskId) return;

            if (!confirm('Usunąć to zadanie?')) return;

            const { error } = await supabaseClient
                .from('todo_tasks')
                .delete()
                .eq('id', taskId);

            if (error) {
                showToast('Błąd usuwania zadania', 'error');
                return;
            }

            closeTaskModal();
            await loadLists();
            showToast('Zadanie usunięte');
        }

        // Tab switching
        function switchTaskTab(tabName) {
            document.querySelectorAll('.task-tab').forEach(tab => {
                if (tab.dataset.tab === tabName) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });

            document.querySelectorAll('.task-tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
        }

        // Cover
        function selectCover(color) {
            document.getElementById('task-cover-color').value = color || '';

            document.querySelectorAll('.cover-option').forEach(btn => {
                const btnColor = btn.getAttribute('data-color');
                if (btnColor === (color || '')) {
                    btn.classList.add('selected');
                } else {
                    btn.classList.remove('selected');
                }
            });

            updateCoverPreview(color);
        }

        function updateCoverPreview(color) {
            const preview = document.getElementById('task-cover-preview');
            if (color) {
                const colors = {
                    red: '#ef4444', orange: '#f97316', yellow: '#eab308',
                    green: '#22c55e', teal: '#14b8a6', blue: '#3b82f6',
                    purple: '#a855f7', pink: '#ec4899', gray: '#6b7280'
                };
                preview.innerHTML = `
                    <div class="w-4 h-4 rounded" style="background: ${colors[color]}"></div>
                    <span class="text-xs text-neutral-500">Etykieta: ${color}</span>
                `;
            } else {
                preview.innerHTML = '';
            }
        }

        // Comments
        async function loadComments(taskId) {
            const { data, error } = await supabaseClient
                .from('todo_comments')
                .select(`*, author:team_members!created_by(id, name, color)`)
                .eq('task_id', taskId)
                .order('created_at', { ascending: true });

            if (error) return;

            const container = document.getElementById('comments-list');
            const badge = document.getElementById('comments-count-badge');

            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-neutral-500 text-sm text-center py-8">Brak komentarzy. Bądź pierwszy!</p>';
                badge.classList.add('hidden');
                return;
            }

            badge.textContent = data.length;
            badge.classList.remove('hidden');

            container.innerHTML = data.map(comment => {
                const initials = comment.author?.name?.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() || '??';
                const color = comment.author?.color || 'violet';
                const isOwn = comment.created_by === currentTeamMember?.id;
                const timeAgo = formatTimeAgo(comment.created_at);

                return `
                    <div class="comment-item-v2 group">
                        <div class="flex items-start gap-3">
                            <div class="w-8 h-8 rounded-full bg-gradient-to-b from-${color}-500 to-${color}-600 flex items-center justify-center text-xs font-medium text-white shrink-0">
                                ${initials}
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-sm font-medium text-white">${escapeHtml(comment.author?.name || 'Nieznany')}</span>
                                    <span class="text-xs text-neutral-500">${timeAgo}</span>
                                    ${isOwn ? `<button onclick="deleteComment('${comment.id}')" class="ml-auto text-neutral-600 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-all"><i class="ph ph-trash"></i></button>` : ''}
                                </div>
                                <p class="text-sm text-neutral-300 leading-relaxed">${escapeHtml(comment.content)}</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function addComment() {
            const taskId = document.getElementById('task-id').value;
            const input = document.getElementById('comment-input');
            const content = input.value.trim();

            if (!content || !taskId) return;

            const { error } = await supabaseClient
                .from('todo_comments')
                .insert({
                    task_id: taskId,
                    content: content,
                    created_by: currentTeamMember?.id || null
                });

            if (error) {
                showToast('Błąd dodawania komentarza', 'error');
                return;
            }

            input.value = '';
            await loadComments(taskId);
            await logActivity(taskId, 'comment', { content: content.substring(0, 50) });
            await loadLists();
        }

        async function deleteComment(commentId) {
            const taskId = document.getElementById('task-id').value;

            const { error } = await supabaseClient
                .from('todo_comments')
                .delete()
                .eq('id', commentId);

            if (error) return;

            await loadComments(taskId);
            await loadLists();
        }

        // Attachments
        async function loadAttachments(taskId) {
            const { data, error } = await supabaseClient
                .from('todo_attachments')
                .select('*')
                .eq('task_id', taskId)
                .order('created_at', { ascending: false });

            if (error) return;

            const container = document.getElementById('attachments-list');
            if (!data || data.length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = data.map(att => {
                const icon = getFileIcon(att.file_type);
                const size = formatFileSize(att.file_size);
                const timeAgo = formatTimeAgo(att.created_at);
                const isImage = att.file_type?.startsWith('image/');

                return `
                    <div class="attachment-item-v2 group">
                        ${isImage ? `
                            <div class="w-12 h-12 rounded-lg bg-neutral-800 overflow-hidden shrink-0">
                                <img src="${escapeHtml(att.file_url)}" alt="" class="w-full h-full object-cover">
                            </div>
                        ` : `
                            <div class="w-12 h-12 rounded-lg bg-neutral-800 flex items-center justify-center shrink-0">
                                <i class="ph ${icon} text-xl text-neutral-400"></i>
                            </div>
                        `}
                        <div class="flex-1 min-w-0">
                            <a href="${escapeHtml(att.file_url)}" target="_blank" class="text-sm font-medium text-white hover:text-neutral-300 truncate block transition-colors">${escapeHtml(att.file_name)}</a>
                            <div class="flex items-center gap-2 mt-0.5">
                                <span class="text-xs text-neutral-500">${size}</span>
                                <span class="text-neutral-700">•</span>
                                <span class="text-xs text-neutral-500">${timeAgo}</span>
                            </div>
                        </div>
                        <button onclick="deleteAttachment('${att.id}')" class="w-8 h-8 flex items-center justify-center text-neutral-600 hover:text-red-400 hover:bg-red-500/10 rounded-lg opacity-0 group-hover:opacity-100 transition-all">
                            <i class="ph ph-trash text-base"></i>
                        </button>
                    </div>
                `;
            }).join('');
        }

        async function uploadAttachment(event) {
            const taskId = document.getElementById('task-id').value;
            const file = event.target.files[0];
            if (!file || !taskId) return;

            const fileExt = file.name.split('.').pop();
            const fileName = `${taskId}/${Date.now()}.${fileExt}`;

            const { data: uploadData, error: uploadError } = await supabaseClient.storage
                .from('attachments')
                .upload(fileName, file);

            if (uploadError) {
                showToast('Błąd przesyłania pliku', 'error');
                event.target.value = '';
                return;
            }

            const { data: urlData } = supabaseClient.storage
                .from('attachments')
                .getPublicUrl(fileName);

            const { error } = await supabaseClient
                .from('todo_attachments')
                .insert({
                    task_id: taskId,
                    file_name: file.name,
                    file_url: urlData.publicUrl,
                    file_type: file.type,
                    file_size: file.size,
                    created_by: currentTeamMember?.id || null
                });

            if (error) {
                showToast('Błąd zapisu załącznika', 'error');
                return;
            }

            event.target.value = '';
            await loadAttachments(taskId);
            await logActivity(taskId, 'attachment', { file_name: file.name });
            await loadLists();
            showToast('Załącznik dodany');
        }

        async function deleteAttachment(attachmentId) {
            const taskId = document.getElementById('task-id').value;

            const { error } = await supabaseClient
                .from('todo_attachments')
                .delete()
                .eq('id', attachmentId);

            if (error) return;

            await loadAttachments(taskId);
            await loadLists();
        }

        function getFileIcon(mimeType) {
            if (!mimeType) return 'ph-file';
            if (mimeType.startsWith('image/')) return 'ph-image';
            if (mimeType.startsWith('video/')) return 'ph-video';
            if (mimeType.startsWith('audio/')) return 'ph-music-notes';
            if (mimeType.includes('pdf')) return 'ph-file-pdf';
            if (mimeType.includes('word') || mimeType.includes('document')) return 'ph-file-doc';
            if (mimeType.includes('sheet') || mimeType.includes('excel')) return 'ph-file-xls';
            if (mimeType.includes('zip') || mimeType.includes('rar')) return 'ph-file-zip';
            return 'ph-file';
        }

        function formatFileSize(bytes) {
            if (!bytes) return '';
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // Activity
        async function logActivity(taskId, action, details) {
            await supabaseClient
                .from('todo_activity')
                .insert({
                    task_id: taskId,
                    action: action,
                    details: details,
                    created_by: currentTeamMember?.id || null
                });
        }

        async function loadActivity(taskId) {
            const { data, error } = await supabaseClient
                .from('todo_activity')
                .select(`*, author:team_members!created_by(id, name)`)
                .eq('task_id', taskId)
                .order('created_at', { ascending: false })
                .limit(20);

            if (error) return;

            const container = document.getElementById('activity-list');
            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-neutral-500 text-sm text-center py-8">Brak aktywności.</p>';
                return;
            }

            container.innerHTML = data.map(item => {
                const timeAgo = formatTimeAgo(item.created_at);
                const authorName = item.author?.name || 'Ktoś';
                const actionText = getActivityText(item.action, item.details);
                const actionIcon = getActivityIcon(item.action);

                return `
                    <div class="activity-item-v2">
                        <div class="w-8 h-8 rounded-full bg-neutral-800 flex items-center justify-center shrink-0">
                            <i class="ph ${actionIcon} text-sm text-neutral-400"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm text-neutral-300">
                                <span class="font-medium text-white">${escapeHtml(authorName)}</span>
                                ${actionText}
                            </p>
                            <span class="text-xs text-neutral-600">${timeAgo}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getActivityText(action, details) {
            switch (action) {
                case 'created': return 'utworzył/a zadanie';
                case 'updated': return 'zaktualizował/a zadanie';
                case 'moved': return 'przeniósł/a zadanie';
                case 'comment': return 'dodał/a komentarz';
                case 'attachment': return `dodał/a załącznik "${details?.file_name || ''}"`;
                case 'assigned': return 'przypisał/a zadanie';
                case 'completed': return 'oznaczył/a jako ukończone';
                default: return action;
            }
        }

        function getActivityIcon(action) {
            switch (action) {
                case 'created': return 'ph-plus-circle';
                case 'updated': return 'ph-pencil-simple';
                case 'moved': return 'ph-arrows-left-right';
                case 'comment': return 'ph-chat-circle';
                case 'attachment': return 'ph-paperclip';
                case 'assigned': return 'ph-user-plus';
                case 'completed': return 'ph-check-circle';
                default: return 'ph-clock';
            }
        }

        function formatTimeAgo(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diffMs = now - date;
            const diffMin = Math.floor(diffMs / 60000);
            const diffHour = Math.floor(diffMs / 3600000);
            const diffDay = Math.floor(diffMs / 86400000);

            if (diffMin < 1) return 'teraz';
            if (diffMin < 60) return `${diffMin} min temu`;
            if (diffHour < 24) return `${diffHour} godz. temu`;
            if (diffDay < 7) return `${diffDay} dni temu`;

            return date.toLocaleDateString('pl-PL', { day: 'numeric', month: 'short' });
        }

        // Toast
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = toast.querySelector('i');

            if (type === 'error') {
                icon.className = 'ph ph-x-circle text-red-400';
            } else {
                icon.className = 'ph ph-check-circle text-emerald-400';
            }

            document.getElementById('toast-message').textContent = message;
            toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }

        // Init
        async function init() {
            Sidebar.render();
            Sidebar.setupLogout(supabaseClient);

            const session = await checkAuth();
            if (!session) return;

            await loadTeamMembers();
            await loadBoard();

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeListModal();
                    closeTaskModal();
                }
            });

            document.addEventListener('mousedown', (e) => {
                canDragList = e.target.closest('.list-drag-handle') !== null;
            });
            document.addEventListener('mouseup', () => {
                canDragList = false;
            });
        }

        init();
    </script>
</body>
</html>
