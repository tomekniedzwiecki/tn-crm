<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TN Todo | Tablica</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="components/sidebar.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body { background: #050505; color: #e5e5e5; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        ::selection { background: white; color: black; }

        .glass-header {
            background: rgba(5, 5, 5, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-enter { animation: fadeIn 0.4s ease-out forwards; }

        /* Kanban styles */
        .kanban-board {
            display: flex;
            gap: 1rem;
            overflow-x: auto;
            padding-bottom: 1rem;
            min-height: calc(100vh - 180px);
        }

        .kanban-list {
            flex: 0 0 300px;
            max-height: calc(100vh - 200px);
            display: flex;
            flex-direction: column;
        }

        .kanban-list-content {
            flex: 1;
            overflow-y: auto;
            min-height: 100px;
        }

        .task-card {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: grab;
            position: relative;
        }
        .task-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            border-radius: 3px 0 0 3px;
            transition: width 0.2s ease;
        }
        .task-card.priority-low::before { background: #52525b; }
        .task-card.priority-medium::before { background: #3b82f6; }
        .task-card.priority-high::before { background: #f59e0b; }
        .task-card.priority-urgent::before { background: #ef4444; }

        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
            border-color: rgba(255,255,255,0.1);
        }
        .task-card:hover::before {
            width: 4px;
        }
        .task-card:active {
            cursor: grabbing;
            transform: scale(1.02) rotate(1deg);
        }
        .task-card.dragging {
            opacity: 0.6;
            transform: rotate(2deg) scale(1.05);
            box-shadow: 0 15px 40px rgba(0,0,0,0.5);
        }

        .kanban-list {
            transition: all 0.2s ease;
            cursor: default;
        }
        .kanban-list.drag-over {
            transform: scale(1.01);
        }
        .kanban-list.drag-over .kanban-list-content {
            background: rgba(139, 92, 246, 0.08);
            border: 2px dashed rgba(139, 92, 246, 0.3);
            border-radius: 8px;
        }

        /* List dragging */
        .kanban-list .list-drag-handle {
            cursor: grab;
        }
        .kanban-list .list-drag-handle:active {
            cursor: grabbing;
        }
        .kanban-list.list-dragging {
            opacity: 0.5;
            transform: rotate(1deg);
        }
        .list-drop-indicator {
            width: 4px;
            background: #8b5cf6;
            border-radius: 2px;
            margin: 0 -2px;
            min-height: 100px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .list-drop-indicator.active {
            opacity: 1;
        }
        .kanban-list.list-drag-target {
            border-color: rgba(139, 92, 246, 0.5);
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.2);
        }

        .quick-add-form {
            display: none;
        }
        .quick-add-form.active {
            display: block;
        }

        /* Due date badges */
        .due-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .due-badge.overdue {
            background: rgba(239, 68, 68, 0.15);
            color: #f87171;
        }
        .due-badge.today {
            background: rgba(245, 158, 11, 0.15);
            color: #fbbf24;
        }
        .due-badge.upcoming {
            background: rgba(63, 63, 70, 0.5);
            color: #a1a1aa;
        }

        /* Card covers */
        .task-cover {
            height: 32px;
            border-radius: 6px 6px 0 0;
            margin: -12px -12px 8px -16px;
            width: calc(100% + 28px);
        }
        .task-cover.cover-red { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .task-cover.cover-orange { background: linear-gradient(135deg, #f97316, #ea580c); }
        .task-cover.cover-yellow { background: linear-gradient(135deg, #eab308, #ca8a04); }
        .task-cover.cover-green { background: linear-gradient(135deg, #22c55e, #16a34a); }
        .task-cover.cover-teal { background: linear-gradient(135deg, #14b8a6, #0d9488); }
        .task-cover.cover-blue { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .task-cover.cover-purple { background: linear-gradient(135deg, #a855f7, #9333ea); }
        .task-cover.cover-pink { background: linear-gradient(135deg, #ec4899, #db2777); }
        .task-cover.cover-gray { background: linear-gradient(135deg, #6b7280, #4b5563); }

        /* Cover selected state */
        .cover-option.selected {
            ring: 2px solid white;
            box-shadow: 0 0 0 2px rgba(255,255,255,0.5);
        }

        /* Activity item */
        .activity-item {
            font-size: 12px;
            color: #a1a1aa;
            padding: 6px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .activity-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body class="h-screen flex overflow-hidden font-sans text-sm tracking-tight antialiased">

    <!-- Sidebar -->
    <aside id="sidebar" class="w-[280px] bg-zinc-950 border-r border-white/5 flex flex-col flex-shrink-0"></aside>

    <!-- Main -->
    <main class="flex-1 flex flex-col bg-black relative min-w-0">
        <!-- Header -->
        <header class="h-16 glass-header flex items-center justify-between px-6 sticky top-0 z-30">
            <div class="flex items-center gap-2 text-zinc-500">
                <a href="boards.html" class="text-zinc-400 hover:text-white transition-colors">tn-todo</a>
                <span class="text-zinc-700">/</span>
                <span id="board-name-header" class="text-white font-medium">Ładowanie...</span>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="openAddListModal()" class="px-3 py-2 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 hover:text-white rounded-lg text-sm font-medium transition-colors border border-zinc-700">
                    <i class="ph ph-plus mr-1"></i>
                    Dodaj listę
                </button>
            </div>
        </header>

        <!-- Kanban Board -->
        <div class="flex-1 overflow-x-auto p-6">
            <div id="kanban-board" class="kanban-board animate-enter">
                <div class="flex items-center justify-center w-full py-12 text-zinc-500">
                    <i class="ph ph-circle-notch animate-spin text-2xl mr-2"></i>
                    <span>Ładowanie tablicy...</span>
                </div>
            </div>
        </div>
    </main>

    <!-- Add List Modal -->
    <div id="modal-list" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden items-center justify-center">
        <div class="bg-zinc-900 border border-white/10 rounded-xl w-full max-w-sm m-4">
            <div class="flex items-center justify-between p-4 border-b border-white/5">
                <h2 id="list-modal-title" class="text-base font-semibold text-white">Nowa lista</h2>
                <button onclick="closeListModal()" class="text-zinc-500 hover:text-white transition-colors">
                    <i class="ph ph-x text-lg"></i>
                </button>
            </div>
            <div class="p-4">
                <input type="hidden" id="list-id">
                <input type="text" id="list-name" placeholder="Nazwa listy..." class="w-full bg-zinc-800 border border-zinc-700 text-white rounded-lg px-4 py-3 text-sm focus:border-violet-500 focus:outline-none mb-4" autofocus>
                <div class="flex gap-3">
                    <button onclick="closeListModal()" class="flex-1 px-4 py-2.5 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 rounded-lg text-sm font-medium transition-colors">
                        Anuluj
                    </button>
                    <button onclick="saveList()" class="flex-1 px-4 py-2.5 bg-violet-500 hover:bg-violet-600 text-white rounded-lg text-sm font-medium transition-colors">
                        Zapisz
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Task Modal -->
    <div id="modal-task" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden items-center justify-center overflow-y-auto py-4">
        <div class="bg-zinc-900 border border-white/10 rounded-xl w-full max-w-2xl mx-4 my-auto">
            <!-- Cover -->
            <div id="task-cover-display" class="h-24 rounded-t-xl hidden"></div>

            <div class="flex items-center justify-between p-4 border-b border-white/5">
                <h2 id="task-modal-title" class="text-base font-semibold text-white">Nowe zadanie</h2>
                <div class="flex items-center gap-2">
                    <button id="task-delete-btn" onclick="deleteTask()" class="p-2 text-zinc-500 hover:text-red-400 hover:bg-red-500/10 rounded-lg transition-colors hidden" title="Usuń zadanie">
                        <i class="ph ph-trash text-lg"></i>
                    </button>
                    <button onclick="closeTaskModal()" class="p-2 text-zinc-500 hover:text-white hover:bg-zinc-800 rounded-lg transition-colors">
                        <i class="ph ph-x text-lg"></i>
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-0">
                <!-- Main content -->
                <div class="lg:col-span-2 p-4 space-y-4 border-r border-white/5">
                    <input type="hidden" id="task-id">
                    <input type="hidden" id="task-list-id">

                    <div>
                        <label class="block text-[10px] uppercase tracking-wider text-zinc-500 font-semibold mb-1.5">Tytuł</label>
                        <input type="text" id="task-title" placeholder="Co trzeba zrobić?" class="w-full bg-zinc-800 border border-zinc-700 text-white rounded-lg px-4 py-3 text-sm focus:border-violet-500 focus:outline-none">
                    </div>

                    <div>
                        <label class="block text-[10px] uppercase tracking-wider text-zinc-500 font-semibold mb-1.5">Opis</label>
                        <textarea id="task-description" rows="3" placeholder="Szczegóły zadania..." class="w-full bg-zinc-800 border border-zinc-700 text-white rounded-lg px-4 py-3 text-sm focus:border-violet-500 focus:outline-none resize-none"></textarea>
                    </div>

                    <!-- Attachments Section -->
                    <div id="attachments-section" class="hidden">
                        <label class="block text-[10px] uppercase tracking-wider text-zinc-500 font-semibold mb-2">
                            <i class="ph ph-paperclip mr-1"></i>Załączniki
                        </label>
                        <div id="attachments-list" class="space-y-2 mb-2"></div>
                        <label class="flex items-center gap-2 px-3 py-2 bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 border-dashed rounded-lg cursor-pointer transition-colors">
                            <i class="ph ph-upload-simple text-zinc-400"></i>
                            <span class="text-sm text-zinc-400">Dodaj załącznik</span>
                            <input type="file" id="attachment-input" class="hidden" onchange="uploadAttachment(event)">
                        </label>
                    </div>

                    <!-- Comments Section -->
                    <div id="comments-section" class="hidden">
                        <label class="block text-[10px] uppercase tracking-wider text-zinc-500 font-semibold mb-2">
                            <i class="ph ph-chat-circle mr-1"></i>Komentarze
                        </label>
                        <div id="comments-list" class="space-y-3 mb-3 max-h-64 overflow-y-auto"></div>
                        <div class="flex gap-2">
                            <input type="text" id="comment-input" placeholder="Dodaj komentarz..." class="flex-1 bg-zinc-800 border border-zinc-700 text-white rounded-lg px-3 py-2 text-sm focus:border-violet-500 focus:outline-none" onkeydown="if(event.key==='Enter')addComment()">
                            <button onclick="addComment()" class="px-3 py-2 bg-zinc-700 hover:bg-zinc-600 text-white rounded-lg text-sm transition-colors">
                                <i class="ph ph-paper-plane-right"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Activity Section -->
                    <div id="activity-section" class="hidden">
                        <label class="block text-[10px] uppercase tracking-wider text-zinc-500 font-semibold mb-2">
                            <i class="ph ph-clock-counter-clockwise mr-1"></i>Historia
                        </label>
                        <div id="activity-list" class="space-y-2 max-h-48 overflow-y-auto"></div>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="p-4 space-y-4 bg-zinc-900/50">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-[10px] uppercase tracking-wider text-zinc-500 font-semibold mb-1.5">Priorytet</label>
                            <select id="task-priority" class="w-full bg-zinc-800 border border-zinc-700 text-zinc-300 rounded-lg px-3 py-2 text-sm focus:border-violet-500 focus:outline-none cursor-pointer">
                                <option value="low">Niski</option>
                                <option value="medium" selected>Średni</option>
                                <option value="high">Wysoki</option>
                                <option value="urgent">Pilny</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-[10px] uppercase tracking-wider text-zinc-500 font-semibold mb-1.5">Termin</label>
                            <input type="date" id="task-due-date" class="w-full bg-zinc-800 border border-zinc-700 text-zinc-300 rounded-lg px-3 py-2 text-sm focus:border-violet-500 focus:outline-none cursor-pointer">
                        </div>
                    </div>

                    <div>
                        <label class="block text-[10px] uppercase tracking-wider text-zinc-500 font-semibold mb-1.5">Przypisz do</label>
                        <select id="task-assigned" class="w-full bg-zinc-800 border border-zinc-700 text-zinc-300 rounded-lg px-3 py-2 text-sm focus:border-violet-500 focus:outline-none cursor-pointer">
                            <option value="">Nieprzypisane</option>
                        </select>
                    </div>

                    <!-- Cover Color -->
                    <div>
                        <label class="block text-[10px] uppercase tracking-wider text-zinc-500 font-semibold mb-1.5">Okładka</label>
                        <div class="grid grid-cols-5 gap-1.5" id="cover-colors">
                            <button type="button" onclick="selectCover(null)" class="w-full h-7 rounded bg-zinc-700 hover:ring-2 hover:ring-white/30 transition-all flex items-center justify-center cover-option" data-color="">
                                <i class="ph ph-x text-zinc-500 text-xs"></i>
                            </button>
                            <button type="button" onclick="selectCover('red')" class="w-full h-7 rounded bg-red-500 hover:ring-2 hover:ring-white/30 transition-all cover-option" data-color="red"></button>
                            <button type="button" onclick="selectCover('orange')" class="w-full h-7 rounded bg-orange-500 hover:ring-2 hover:ring-white/30 transition-all cover-option" data-color="orange"></button>
                            <button type="button" onclick="selectCover('yellow')" class="w-full h-7 rounded bg-yellow-500 hover:ring-2 hover:ring-white/30 transition-all cover-option" data-color="yellow"></button>
                            <button type="button" onclick="selectCover('green')" class="w-full h-7 rounded bg-green-500 hover:ring-2 hover:ring-white/30 transition-all cover-option" data-color="green"></button>
                            <button type="button" onclick="selectCover('teal')" class="w-full h-7 rounded bg-teal-500 hover:ring-2 hover:ring-white/30 transition-all cover-option" data-color="teal"></button>
                            <button type="button" onclick="selectCover('blue')" class="w-full h-7 rounded bg-blue-500 hover:ring-2 hover:ring-white/30 transition-all cover-option" data-color="blue"></button>
                            <button type="button" onclick="selectCover('purple')" class="w-full h-7 rounded bg-purple-500 hover:ring-2 hover:ring-white/30 transition-all cover-option" data-color="purple"></button>
                            <button type="button" onclick="selectCover('pink')" class="w-full h-7 rounded bg-pink-500 hover:ring-2 hover:ring-white/30 transition-all cover-option" data-color="pink"></button>
                            <button type="button" onclick="selectCover('gray')" class="w-full h-7 rounded bg-gray-500 hover:ring-2 hover:ring-white/30 transition-all cover-option" data-color="gray"></button>
                        </div>
                    </div>

                    <input type="hidden" id="task-cover-color">

                    <div class="flex gap-2 pt-2">
                        <button onclick="closeTaskModal()" class="flex-1 px-3 py-2.5 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 rounded-lg text-sm font-medium transition-colors">
                            Anuluj
                        </button>
                        <button onclick="saveTask()" class="flex-1 px-3 py-2.5 bg-violet-500 hover:bg-violet-600 text-white rounded-lg text-sm font-medium transition-colors">
                            <i class="ph ph-floppy-disk mr-1"></i>
                            Zapisz
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-6 right-6 bg-zinc-800 border border-white/10 text-white px-4 py-3 rounded-lg shadow-xl transform translate-y-20 opacity-0 transition-all duration-300 z-50">
        <span id="toast-message"></span>
    </div>

    <script>
        const SUPABASE_URL = 'https://yxmavwkwnfuphjqbelws.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl4bWF2d2t3bmZ1cGhqcWJlbHdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NjQyNTUsImV4cCI6MjA4NDM0MDI1NX0.XeR0Fc7OFn6YbNJrOKTBEj36JtmLISZTM87y4ai9340';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // State
        let board = null;
        let lists = [];
        let teamMembers = [];
        let currentTeamMember = null;
        let draggedTask = null;
        let draggedListId = null;
        let draggedListIndex = null;
        let canDragList = false; // Track if mousedown was on drag handle

        const PRIORITY_COLORS = {
            'low': 'bg-zinc-600',
            'medium': 'bg-blue-500',
            'high': 'bg-amber-500',
            'urgent': 'bg-red-500'
        };

        const PRIORITY_LABELS = {
            'low': 'Niski',
            'medium': 'Średni',
            'high': 'Wysoki',
            'urgent': 'Pilny'
        };

        // Get board ID from URL
        function getBoardId() {
            const params = new URLSearchParams(window.location.search);
            return params.get('id');
        }

        // Auth check
        async function checkAuth() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
                window.location.href = '/tn-crm/index.html';
                return null;
            }
            Sidebar.setUserEmail(session.user.email.split('@')[0]);

            const { data: teamMember } = await supabaseClient
                .from('team_members')
                .select('id, role, name, color')
                .eq('user_id', session.user.id)
                .single();

            if (teamMember) {
                currentTeamMember = teamMember;
                Sidebar.setUserName(teamMember.name);
                Sidebar.setUserColor(teamMember.color);
            }

            return session;
        }

        // Load team members
        async function loadTeamMembers() {
            const { data } = await supabaseClient
                .from('team_members')
                .select('id, name, color')
                .order('name');

            teamMembers = data || [];

            // Populate assignee dropdown
            const select = document.getElementById('task-assigned');
            select.innerHTML = '<option value="">Nieprzypisane</option>' +
                teamMembers.map(m => `<option value="${m.id}">${escapeHtml(m.name)}</option>`).join('');
        }

        // Load board with lists and tasks
        async function loadBoard() {
            const boardId = getBoardId();
            if (!boardId) {
                window.location.href = 'boards.html';
                return;
            }

            const { data, error } = await supabaseClient
                .from('todo_boards')
                .select('*')
                .eq('id', boardId)
                .single();

            if (error || !data) {
                console.error('Error loading board:', error);
                window.location.href = 'boards.html';
                return;
            }

            board = data;
            document.getElementById('board-name-header').textContent = board.name;
            document.title = `TN Todo | ${board.name}`;

            await loadLists();
        }

        async function loadLists() {
            const { data, error } = await supabaseClient
                .from('todo_lists')
                .select(`
                    *,
                    tasks:todo_tasks(
                        *,
                        assigned_member:team_members!assigned_to(id, name, color),
                        comments:todo_comments(count),
                        attachments:todo_attachments(count)
                    )
                `)
                .eq('board_id', board.id)
                .order('position')
                .order('position', { foreignTable: 'todo_tasks' });

            if (error) {
                console.error('Error loading lists:', error);
                return;
            }

            // Transform data to add counts
            lists = (data || []).map(list => ({
                ...list,
                tasks: (list.tasks || []).map(task => ({
                    ...task,
                    comments_count: task.comments?.[0]?.count || 0,
                    attachments_count: task.attachments?.[0]?.count || 0
                }))
            }));

            renderKanban();
        }

        function renderKanban() {
            const container = document.getElementById('kanban-board');

            if (lists.length === 0) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center w-full py-16 text-center">
                        <div class="w-16 h-16 rounded-full bg-zinc-800 flex items-center justify-center mb-4">
                            <i class="ph ph-list-plus text-3xl text-zinc-600"></i>
                        </div>
                        <h3 class="text-lg font-medium text-white mb-2">Brak list</h3>
                        <p class="text-zinc-500 mb-4">Dodaj pierwszą listę, np. "Do zrobienia", "W trakcie", "Zrobione".</p>
                        <button onclick="openAddListModal()" class="px-4 py-2 bg-violet-500 hover:bg-violet-600 text-white rounded-lg text-sm font-medium transition-colors">
                            <i class="ph ph-plus mr-1"></i>
                            Dodaj listę
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = lists.map((list, index) => `
                <div class="kanban-list bg-zinc-900/50 rounded-xl border border-white/5 backdrop-blur-sm group"
                     data-list-id="${list.id}"
                     data-list-index="${index}"
                     draggable="true"
                     ondragstart="handleListDragStart(event, '${list.id}', ${index})"
                     ondragend="handleListDragEnd(event)"
                     ondragover="handleListDragOver(event, ${index})"
                     ondrop="handleListDrop(event, ${index})">
                    <!-- List Header -->
                    <div class="flex items-center justify-between px-4 py-3 border-b border-white/5 bg-zinc-900/50 rounded-t-xl list-drag-handle">
                        <div class="flex items-center gap-2.5">
                            <i class="ph ph-dots-six-vertical text-zinc-600 cursor-grab"></i>
                            <h3 class="font-semibold text-white text-sm">${escapeHtml(list.name)}</h3>
                            <span class="text-[11px] text-zinc-400 bg-zinc-800/80 px-2 py-0.5 rounded-md font-medium">${list.tasks?.length || 0}</span>
                        </div>
                        <div class="flex items-center gap-0.5 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="event.stopPropagation(); editList('${list.id}')" class="p-1.5 text-zinc-500 hover:text-white hover:bg-zinc-700 rounded-lg transition-colors">
                                <i class="ph ph-pencil-simple text-sm"></i>
                            </button>
                            <button onclick="event.stopPropagation(); deleteList('${list.id}')" class="p-1.5 text-zinc-500 hover:text-red-400 hover:bg-red-500/10 rounded-lg transition-colors">
                                <i class="ph ph-trash text-sm"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Tasks -->
                    <div class="kanban-list-content p-2 space-y-2" data-list-id="${list.id}" ondragover="handleDragOver(event)" ondrop="handleDrop(event, '${list.id}')" ondragleave="handleDragLeave(event)">
                        ${(list.tasks || []).map(task => renderTaskCard(task)).join('')}
                    </div>

                    <!-- Quick Add -->
                    <div class="p-2 border-t border-white/5">
                        <div id="quick-add-${list.id}" class="quick-add-form mb-2">
                            <input type="text"
                                   id="quick-input-${list.id}"
                                   placeholder="Tytuł zadania..."
                                   class="w-full bg-zinc-800 border border-zinc-700 text-white rounded-lg px-3 py-2 text-sm focus:border-violet-500 focus:outline-none mb-2"
                                   onkeydown="handleQuickAddKeydown(event, '${list.id}')">
                            <div class="flex gap-2">
                                <button onclick="submitQuickAdd('${list.id}')" class="flex-1 px-3 py-1.5 bg-violet-500 hover:bg-violet-600 text-white rounded-lg text-xs font-medium transition-colors">
                                    Dodaj
                                </button>
                                <button onclick="closeQuickAdd('${list.id}')" class="px-3 py-1.5 bg-zinc-700 hover:bg-zinc-600 text-zinc-300 rounded-lg text-xs font-medium transition-colors">
                                    <i class="ph ph-x"></i>
                                </button>
                            </div>
                        </div>
                        <button onclick="openQuickAdd('${list.id}')" id="quick-btn-${list.id}" class="w-full px-3 py-2 text-zinc-500 hover:text-white hover:bg-zinc-800/80 rounded-lg text-sm transition-colors flex items-center gap-2">
                            <i class="ph ph-plus"></i>
                            Dodaj zadanie
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function renderTaskCard(task) {
            const priority = task.priority || 'medium';
            const hasDueDate = task.due_date;
            const dueDate = hasDueDate ? new Date(task.due_date) : null;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const isOverdue = dueDate && dueDate < today && !task.is_completed;
            const isToday = dueDate && dueDate.toDateString() === today.toDateString();

            let assigneeHtml = '';
            if (task.assigned_member) {
                const initials = task.assigned_member.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                const color = task.assigned_member.color || 'violet';
                assigneeHtml = `
                    <div class="w-6 h-6 rounded-full bg-gradient-to-b from-${color}-600 to-${color}-700 flex items-center justify-center text-[10px] font-medium text-white ring-2 ring-zinc-800" title="${escapeHtml(task.assigned_member.name)}">
                        ${initials}
                    </div>
                `;
            }

            let dueBadgeClass = 'upcoming';
            if (isOverdue) dueBadgeClass = 'overdue';
            else if (isToday) dueBadgeClass = 'today';

            const coverHtml = task.cover_color
                ? `<div class="task-cover cover-${task.cover_color}"></div>`
                : '';

            // Count indicators
            const hasComments = task.comments_count > 0;
            const hasAttachments = task.attachments_count > 0;

            return `
                <div class="task-card priority-${priority} bg-zinc-800/90 border border-zinc-700/50 rounded-lg p-3 pl-4 group"
                     draggable="true"
                     data-task-id="${task.id}"
                     ondragstart="handleDragStart(event, '${task.id}')"
                     ondragend="handleDragEnd(event)"
                     onclick="openEditTaskModal('${task.id}')">
                    ${coverHtml}
                    <p class="text-sm text-white mb-2 leading-snug ${task.is_completed ? 'line-through text-zinc-500' : ''}">${escapeHtml(task.title)}</p>
                    ${task.description ? `<p class="text-xs text-zinc-500 mb-3 line-clamp-2 leading-relaxed">${escapeHtml(task.description)}</p>` : ''}
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            ${hasDueDate ? `
                                <span class="due-badge ${dueBadgeClass}">
                                    <i class="ph ph-calendar-blank"></i>
                                    ${formatDate(task.due_date)}
                                </span>
                            ` : ''}
                            ${hasComments ? `<span class="text-[10px] text-zinc-500 flex items-center gap-0.5"><i class="ph ph-chat-circle"></i>${task.comments_count}</span>` : ''}
                            ${hasAttachments ? `<span class="text-[10px] text-zinc-500 flex items-center gap-0.5"><i class="ph ph-paperclip"></i>${task.attachments_count}</span>` : ''}
                        </div>
                        ${assigneeHtml}
                    </div>
                </div>
            `;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);

            if (date.toDateString() === today.toDateString()) return 'Dziś';
            if (date.toDateString() === tomorrow.toDateString()) return 'Jutro';

            return date.toLocaleDateString('pl-PL', { day: 'numeric', month: 'short' });
        }

        // Task Drag and Drop
        function handleDragStart(event, taskId) {
            event.stopPropagation(); // Prevent list drag
            draggedTask = taskId;
            event.target.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', 'task:' + taskId);
        }

        function handleDragEnd(event) {
            event.target.classList.remove('dragging');
            document.querySelectorAll('.kanban-list').forEach(list => list.classList.remove('drag-over'));
            draggedTask = null;
        }

        function handleDragOver(event) {
            if (draggedListId !== null) return; // Don't handle if dragging a list
            event.preventDefault();
            event.stopPropagation();
            event.dataTransfer.dropEffect = 'move';
            const listContent = event.currentTarget;
            listContent.closest('.kanban-list').classList.add('drag-over');
        }

        function handleDragLeave(event) {
            const listContent = event.currentTarget;
            listContent.closest('.kanban-list').classList.remove('drag-over');
        }

        async function handleDrop(event, listId) {
            if (draggedListId !== null) return; // Don't handle if dragging a list
            event.preventDefault();
            event.stopPropagation();
            const listContent = event.currentTarget;
            listContent.closest('.kanban-list').classList.remove('drag-over');
            document.querySelectorAll('.task-drop-indicator').forEach(el => el.remove());

            if (!draggedTask) return;

            // Find the task and its source list
            let task = null;
            let sourceListId = null;
            for (const list of lists) {
                task = list.tasks?.find(t => t.id === draggedTask);
                if (task) {
                    sourceListId = list.id;
                    break;
                }
            }

            if (!task) return;

            // Calculate drop position based on mouse position
            const targetList = lists.find(l => l.id === listId);
            const tasksInTarget = targetList?.tasks || [];
            let newPosition = tasksInTarget.length;

            // Find the task we're dropping on/near
            const taskCards = listContent.querySelectorAll('.task-card');
            const dropY = event.clientY;

            for (let i = 0; i < taskCards.length; i++) {
                const card = taskCards[i];
                const rect = card.getBoundingClientRect();
                const cardMiddle = rect.top + rect.height / 2;

                if (dropY < cardMiddle) {
                    newPosition = i;
                    break;
                }
            }

            // If same list and same position, do nothing
            if (sourceListId === listId) {
                const currentIndex = tasksInTarget.findIndex(t => t.id === draggedTask);
                if (currentIndex === newPosition || currentIndex === newPosition - 1) {
                    return;
                }
                // Adjust position if moving down in same list
                if (currentIndex < newPosition) {
                    newPosition--;
                }
            }

            // Update task position and list
            const { error } = await supabaseClient
                .from('todo_tasks')
                .update({ list_id: listId, position: newPosition })
                .eq('id', draggedTask);

            if (error) {
                console.error('Error moving task:', error);
                showToast('Błąd przenoszenia zadania');
                return;
            }

            // Reorder other tasks in target list
            const updates = [];
            const allTasksInTarget = sourceListId === listId
                ? tasksInTarget.filter(t => t.id !== draggedTask)
                : tasksInTarget;

            allTasksInTarget.splice(newPosition, 0, { id: draggedTask });

            for (let i = 0; i < allTasksInTarget.length; i++) {
                if (allTasksInTarget[i].id !== draggedTask) {
                    const currentTask = tasksInTarget.find(t => t.id === allTasksInTarget[i].id);
                    if (currentTask && currentTask.position !== i) {
                        updates.push(
                            supabaseClient
                                .from('todo_tasks')
                                .update({ position: i })
                                .eq('id', allTasksInTarget[i].id)
                        );
                    }
                }
            }

            if (updates.length > 0) {
                await Promise.all(updates);
            }

            // Log activity
            await logActivity(draggedTask, 'moved', {
                from_list: sourceListId,
                to_list: listId,
                position: newPosition
            });

            await loadLists();
        }

        // List Drag and Drop
        function handleListDragStart(event, listId, index) {
            // Only drag if mousedown was on header/handle area
            if (!canDragList) {
                event.preventDefault();
                return;
            }
            draggedListId = listId;
            draggedListIndex = index;
            event.target.classList.add('list-dragging');
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', listId);
        }

        function handleListDragEnd(event) {
            event.target.classList.remove('list-dragging');
            document.querySelectorAll('.list-drop-indicator').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.kanban-list').forEach(el => el.classList.remove('list-drag-target'));
            draggedListId = null;
            draggedListIndex = null;
            canDragList = false;
        }

        function handleListDragOver(event, targetIndex) {
            if (draggedListId === null) return; // Only handle list drags
            event.preventDefault();
            event.stopPropagation();
            event.dataTransfer.dropEffect = 'move';

            // Visual indicator - highlight target list
            document.querySelectorAll('.kanban-list').forEach((el, idx) => {
                if (idx === targetIndex && targetIndex !== draggedListIndex) {
                    el.classList.add('list-drag-target');
                } else {
                    el.classList.remove('list-drag-target');
                }
            });
        }

        async function handleListDrop(event, targetIndex) {
            if (draggedListId === null || draggedListIndex === null) return;
            event.preventDefault();
            event.stopPropagation();

            // Clear visual indicators
            document.querySelectorAll('.kanban-list').forEach(el => el.classList.remove('list-drag-target'));

            if (draggedListIndex === targetIndex) return;

            // Calculate new positions
            const updates = [];
            const newLists = [...lists];
            const [movedList] = newLists.splice(draggedListIndex, 1);
            newLists.splice(targetIndex, 0, movedList);

            // Update all positions
            for (let i = 0; i < newLists.length; i++) {
                if (newLists[i].position !== i) {
                    updates.push(
                        supabaseClient
                            .from('todo_lists')
                            .update({ position: i })
                            .eq('id', newLists[i].id)
                    );
                }
            }

            if (updates.length > 0) {
                await Promise.all(updates);
                await loadLists();
            }

            draggedListId = null;
            draggedListIndex = null;
        }

        // List Modal
        function openAddListModal() {
            document.getElementById('list-id').value = '';
            document.getElementById('list-name').value = '';
            document.getElementById('list-modal-title').textContent = 'Nowa lista';
            document.getElementById('modal-list').classList.remove('hidden');
            document.getElementById('modal-list').classList.add('flex');
            document.getElementById('list-name').focus();
        }

        function editList(listId) {
            const list = lists.find(l => l.id === listId);
            if (!list) return;

            document.getElementById('list-id').value = list.id;
            document.getElementById('list-name').value = list.name;
            document.getElementById('list-modal-title').textContent = 'Edytuj listę';
            document.getElementById('modal-list').classList.remove('hidden');
            document.getElementById('modal-list').classList.add('flex');
            document.getElementById('list-name').focus();
        }

        function closeListModal() {
            document.getElementById('modal-list').classList.add('hidden');
            document.getElementById('modal-list').classList.remove('flex');
        }

        async function saveList() {
            const id = document.getElementById('list-id').value;
            const name = document.getElementById('list-name').value.trim();

            if (!name) {
                showToast('Podaj nazwę listy');
                return;
            }

            let error;
            if (id) {
                const result = await supabaseClient
                    .from('todo_lists')
                    .update({ name })
                    .eq('id', id);
                error = result.error;
            } else {
                const position = lists.length;
                const result = await supabaseClient
                    .from('todo_lists')
                    .insert({ board_id: board.id, name, position });
                error = result.error;
            }

            if (error) {
                console.error('Error saving list:', error);
                showToast('Błąd zapisu listy');
                return;
            }

            closeListModal();
            await loadLists();
            showToast(id ? 'Lista zaktualizowana' : 'Lista utworzona');
        }

        async function deleteList(listId) {
            if (!confirm('Usunąć listę wraz z wszystkimi zadaniami?')) return;

            const { error } = await supabaseClient
                .from('todo_lists')
                .delete()
                .eq('id', listId);

            if (error) {
                console.error('Error deleting list:', error);
                showToast('Błąd usuwania listy');
                return;
            }

            await loadLists();
            showToast('Lista usunięta');
        }

        // Quick Add (inline)
        function openQuickAdd(listId) {
            document.getElementById(`quick-add-${listId}`).classList.add('active');
            document.getElementById(`quick-btn-${listId}`).style.display = 'none';
            document.getElementById(`quick-input-${listId}`).focus();
        }

        function closeQuickAdd(listId) {
            document.getElementById(`quick-add-${listId}`).classList.remove('active');
            document.getElementById(`quick-btn-${listId}`).style.display = 'flex';
            document.getElementById(`quick-input-${listId}`).value = '';
        }

        function handleQuickAddKeydown(event, listId) {
            if (event.key === 'Enter') {
                event.preventDefault();
                submitQuickAdd(listId);
            } else if (event.key === 'Escape') {
                closeQuickAdd(listId);
            }
        }

        async function submitQuickAdd(listId) {
            const input = document.getElementById(`quick-input-${listId}`);
            const title = input.value.trim();

            if (!title) {
                closeQuickAdd(listId);
                return;
            }

            const list = lists.find(l => l.id === listId);
            const position = list?.tasks?.length || 0;

            const { error } = await supabaseClient
                .from('todo_tasks')
                .insert({
                    list_id: listId,
                    title: title,
                    position: position,
                    priority: 'medium',
                    created_by: currentTeamMember?.id || null
                });

            if (error) {
                console.error('Error adding task:', error);
                showToast('Błąd dodawania zadania');
                return;
            }

            closeQuickAdd(listId);
            await loadLists();
        }

        // Task Modal
        function openAddTaskModal(listId) {
            document.getElementById('task-id').value = '';
            document.getElementById('task-list-id').value = listId;
            document.getElementById('task-title').value = '';
            document.getElementById('task-description').value = '';
            document.getElementById('task-priority').value = 'medium';
            document.getElementById('task-due-date').value = '';
            document.getElementById('task-assigned').value = '';
            document.getElementById('task-cover-color').value = '';
            document.getElementById('task-modal-title').textContent = 'Nowe zadanie';

            // Hide edit-only sections
            document.getElementById('task-delete-btn').classList.add('hidden');
            document.getElementById('comments-section').classList.add('hidden');
            document.getElementById('attachments-section').classList.add('hidden');
            document.getElementById('activity-section').classList.add('hidden');
            document.getElementById('task-cover-display').classList.add('hidden');

            // Reset cover selection
            selectCover(null);

            document.getElementById('modal-task').classList.remove('hidden');
            document.getElementById('modal-task').classList.add('flex');
            document.getElementById('task-title').focus();
        }

        async function openEditTaskModal(taskId) {
            let task = null;
            for (const list of lists) {
                task = list.tasks?.find(t => t.id === taskId);
                if (task) break;
            }
            if (!task) return;

            document.getElementById('task-id').value = task.id;
            document.getElementById('task-list-id').value = task.list_id;
            document.getElementById('task-title').value = task.title;
            document.getElementById('task-description').value = task.description || '';
            document.getElementById('task-priority').value = task.priority || 'medium';
            document.getElementById('task-due-date').value = task.due_date ? task.due_date.split('T')[0] : '';
            document.getElementById('task-assigned').value = task.assigned_to || '';
            document.getElementById('task-cover-color').value = task.cover_color || '';
            document.getElementById('task-modal-title').textContent = 'Edytuj zadanie';

            // Show edit-only sections
            document.getElementById('task-delete-btn').classList.remove('hidden');
            document.getElementById('comments-section').classList.remove('hidden');
            document.getElementById('attachments-section').classList.remove('hidden');
            document.getElementById('activity-section').classList.remove('hidden');

            // Set cover display
            selectCover(task.cover_color);
            updateCoverDisplay(task.cover_color);

            document.getElementById('modal-task').classList.remove('hidden');
            document.getElementById('modal-task').classList.add('flex');

            // Load related data
            await Promise.all([
                loadComments(taskId),
                loadAttachments(taskId),
                loadActivity(taskId)
            ]);
        }

        function closeTaskModal() {
            document.getElementById('modal-task').classList.add('hidden');
            document.getElementById('modal-task').classList.remove('flex');
        }

        async function saveTask() {
            const id = document.getElementById('task-id').value;
            const listId = document.getElementById('task-list-id').value;
            const title = document.getElementById('task-title').value.trim();
            const description = document.getElementById('task-description').value.trim();
            const priority = document.getElementById('task-priority').value;
            const dueDate = document.getElementById('task-due-date').value;
            const assignedTo = document.getElementById('task-assigned').value;
            const coverColor = document.getElementById('task-cover-color').value;

            if (!title) {
                showToast('Podaj tytuł zadania');
                return;
            }

            const taskData = {
                title,
                description: description || null,
                priority,
                due_date: dueDate || null,
                assigned_to: assignedTo || null,
                cover_color: coverColor || null
            };

            let error;
            let newTaskId = id;
            if (id) {
                const result = await supabaseClient
                    .from('todo_tasks')
                    .update(taskData)
                    .eq('id', id);
                error = result.error;

                // Log activity
                if (!error) {
                    await logActivity(id, 'updated', { fields: Object.keys(taskData) });
                }
            } else {
                const list = lists.find(l => l.id === listId);
                const position = list?.tasks?.length || 0;
                taskData.list_id = listId;
                taskData.position = position;
                taskData.created_by = currentTeamMember?.id || null;
                const result = await supabaseClient
                    .from('todo_tasks')
                    .insert(taskData)
                    .select('id')
                    .single();
                error = result.error;
                newTaskId = result.data?.id;

                // Log activity
                if (!error && newTaskId) {
                    await logActivity(newTaskId, 'created', {});
                }
            }

            if (error) {
                console.error('Error saving task:', error);
                showToast('Błąd zapisu zadania');
                return;
            }

            closeTaskModal();
            await loadLists();
            showToast(id ? 'Zadanie zaktualizowane' : 'Zadanie utworzone');
        }

        async function deleteTask() {
            const taskId = document.getElementById('task-id').value;
            if (!taskId) return;

            if (!confirm('Usunąć to zadanie?')) return;

            const { error } = await supabaseClient
                .from('todo_tasks')
                .delete()
                .eq('id', taskId);

            if (error) {
                console.error('Error deleting task:', error);
                showToast('Błąd usuwania zadania');
                return;
            }

            closeTaskModal();
            await loadLists();
            showToast('Zadanie usunięte');
        }

        // Cover
        function selectCover(color) {
            document.getElementById('task-cover-color').value = color || '';

            // Update visual selection
            document.querySelectorAll('.cover-option').forEach(btn => {
                const btnColor = btn.getAttribute('data-color');
                if (btnColor === (color || '')) {
                    btn.classList.add('ring-2', 'ring-white');
                } else {
                    btn.classList.remove('ring-2', 'ring-white');
                }
            });

            updateCoverDisplay(color);
        }

        function updateCoverDisplay(color) {
            const coverDisplay = document.getElementById('task-cover-display');
            if (color) {
                coverDisplay.className = `h-24 rounded-t-xl bg-gradient-to-r`;
                const gradients = {
                    red: 'from-red-500 to-red-600',
                    orange: 'from-orange-500 to-orange-600',
                    yellow: 'from-yellow-500 to-yellow-600',
                    green: 'from-green-500 to-green-600',
                    teal: 'from-teal-500 to-teal-600',
                    blue: 'from-blue-500 to-blue-600',
                    purple: 'from-purple-500 to-purple-600',
                    pink: 'from-pink-500 to-pink-600',
                    gray: 'from-gray-500 to-gray-600'
                };
                coverDisplay.classList.add(...(gradients[color] || 'from-zinc-700 to-zinc-800').split(' '));
                coverDisplay.classList.remove('hidden');
            } else {
                coverDisplay.classList.add('hidden');
            }
        }

        // Comments
        async function loadComments(taskId) {
            const { data, error } = await supabaseClient
                .from('todo_comments')
                .select(`
                    *,
                    author:team_members!created_by(id, name, color)
                `)
                .eq('task_id', taskId)
                .order('created_at', { ascending: true });

            if (error) {
                console.error('Error loading comments:', error);
                return;
            }

            const container = document.getElementById('comments-list');
            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-zinc-500 text-xs">Brak komentarzy</p>';
                return;
            }

            container.innerHTML = data.map(comment => {
                const initials = comment.author?.name?.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() || '??';
                const color = comment.author?.color || 'violet';
                const isOwn = comment.created_by === currentTeamMember?.id;
                const timeAgo = formatTimeAgo(comment.created_at);

                return `
                    <div class="flex gap-2 group">
                        <div class="w-7 h-7 rounded-full bg-gradient-to-b from-${color}-600 to-${color}-700 flex items-center justify-center text-[10px] font-medium text-white shrink-0">
                            ${initials}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2">
                                <span class="text-xs font-medium text-white">${escapeHtml(comment.author?.name || 'Nieznany')}</span>
                                <span class="text-[10px] text-zinc-500">${timeAgo}</span>
                                ${isOwn ? `<button onclick="deleteComment('${comment.id}')" class="text-zinc-600 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity ml-auto"><i class="ph ph-trash text-xs"></i></button>` : ''}
                            </div>
                            <p class="text-sm text-zinc-300 mt-0.5">${escapeHtml(comment.content)}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function addComment() {
            const taskId = document.getElementById('task-id').value;
            const input = document.getElementById('comment-input');
            const content = input.value.trim();

            if (!content || !taskId) return;

            const { error } = await supabaseClient
                .from('todo_comments')
                .insert({
                    task_id: taskId,
                    content: content,
                    created_by: currentTeamMember?.id || null
                });

            if (error) {
                console.error('Error adding comment:', error);
                showToast('Błąd dodawania komentarza');
                return;
            }

            input.value = '';
            await loadComments(taskId);
            await logActivity(taskId, 'comment', { content: content.substring(0, 50) });
            await loadLists(); // Refresh counts
        }

        async function deleteComment(commentId) {
            const taskId = document.getElementById('task-id').value;

            const { error } = await supabaseClient
                .from('todo_comments')
                .delete()
                .eq('id', commentId);

            if (error) {
                console.error('Error deleting comment:', error);
                return;
            }

            await loadComments(taskId);
            await loadLists();
        }

        // Attachments
        async function loadAttachments(taskId) {
            const { data, error } = await supabaseClient
                .from('todo_attachments')
                .select('*')
                .eq('task_id', taskId)
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error loading attachments:', error);
                return;
            }

            const container = document.getElementById('attachments-list');
            if (!data || data.length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = data.map(att => {
                const icon = getFileIcon(att.file_type);
                const size = formatFileSize(att.file_size);

                return `
                    <div class="flex items-center gap-2 bg-zinc-800 rounded-lg p-2 group">
                        <i class="ph ${icon} text-zinc-400 text-lg"></i>
                        <div class="flex-1 min-w-0">
                            <a href="${escapeHtml(att.file_url)}" target="_blank" class="text-sm text-white hover:text-violet-400 truncate block">${escapeHtml(att.file_name)}</a>
                            <span class="text-[10px] text-zinc-500">${size}</span>
                        </div>
                        <button onclick="deleteAttachment('${att.id}')" class="p-1 text-zinc-600 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity">
                            <i class="ph ph-trash text-sm"></i>
                        </button>
                    </div>
                `;
            }).join('');
        }

        async function uploadAttachment(event) {
            const taskId = document.getElementById('task-id').value;
            const file = event.target.files[0];
            if (!file || !taskId) return;

            // Upload to Supabase Storage
            const fileExt = file.name.split('.').pop();
            const fileName = `${taskId}/${Date.now()}.${fileExt}`;

            const { data: uploadData, error: uploadError } = await supabaseClient.storage
                .from('attachments')
                .upload(fileName, file);

            if (uploadError) {
                console.error('Error uploading file:', uploadError);
                showToast('Błąd przesyłania pliku');
                event.target.value = '';
                return;
            }

            // Get public URL
            const { data: urlData } = supabaseClient.storage
                .from('attachments')
                .getPublicUrl(fileName);

            // Save attachment record
            const { error } = await supabaseClient
                .from('todo_attachments')
                .insert({
                    task_id: taskId,
                    file_name: file.name,
                    file_url: urlData.publicUrl,
                    file_type: file.type,
                    file_size: file.size,
                    created_by: currentTeamMember?.id || null
                });

            if (error) {
                console.error('Error saving attachment:', error);
                showToast('Błąd zapisu załącznika');
                return;
            }

            event.target.value = '';
            await loadAttachments(taskId);
            await logActivity(taskId, 'attachment', { file_name: file.name });
            await loadLists();
            showToast('Załącznik dodany');
        }

        async function deleteAttachment(attachmentId) {
            const taskId = document.getElementById('task-id').value;

            const { error } = await supabaseClient
                .from('todo_attachments')
                .delete()
                .eq('id', attachmentId);

            if (error) {
                console.error('Error deleting attachment:', error);
                return;
            }

            await loadAttachments(taskId);
            await loadLists();
        }

        function getFileIcon(mimeType) {
            if (!mimeType) return 'ph-file';
            if (mimeType.startsWith('image/')) return 'ph-image';
            if (mimeType.startsWith('video/')) return 'ph-video';
            if (mimeType.startsWith('audio/')) return 'ph-music-notes';
            if (mimeType.includes('pdf')) return 'ph-file-pdf';
            if (mimeType.includes('word') || mimeType.includes('document')) return 'ph-file-doc';
            if (mimeType.includes('sheet') || mimeType.includes('excel')) return 'ph-file-xls';
            if (mimeType.includes('zip') || mimeType.includes('rar')) return 'ph-file-zip';
            return 'ph-file';
        }

        function formatFileSize(bytes) {
            if (!bytes) return '';
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // Activity
        async function logActivity(taskId, action, details) {
            await supabaseClient
                .from('todo_activity')
                .insert({
                    task_id: taskId,
                    action: action,
                    details: details,
                    created_by: currentTeamMember?.id || null
                });
        }

        async function loadActivity(taskId) {
            const { data, error } = await supabaseClient
                .from('todo_activity')
                .select(`
                    *,
                    author:team_members!created_by(id, name)
                `)
                .eq('task_id', taskId)
                .order('created_at', { ascending: false })
                .limit(20);

            if (error) {
                console.error('Error loading activity:', error);
                return;
            }

            const container = document.getElementById('activity-list');
            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-zinc-500 text-xs">Brak historii</p>';
                return;
            }

            container.innerHTML = data.map(item => {
                const timeAgo = formatTimeAgo(item.created_at);
                const authorName = item.author?.name || 'Ktoś';
                const actionText = getActivityText(item.action, item.details);

                return `
                    <div class="activity-item">
                        <span class="text-zinc-400">${escapeHtml(authorName)}</span>
                        <span class="text-zinc-500">${actionText}</span>
                        <span class="text-zinc-600 ml-1">${timeAgo}</span>
                    </div>
                `;
            }).join('');
        }

        function getActivityText(action, details) {
            switch (action) {
                case 'created': return 'utworzył/a zadanie';
                case 'updated': return 'zaktualizował/a zadanie';
                case 'moved': return 'przeniósł/a zadanie';
                case 'comment': return 'dodał/a komentarz';
                case 'attachment': return `dodał/a załącznik "${details?.file_name || ''}"`;
                case 'assigned': return 'przypisał/a zadanie';
                case 'completed': return 'oznaczył/a jako ukończone';
                default: return action;
            }
        }

        function formatTimeAgo(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diffMs = now - date;
            const diffMin = Math.floor(diffMs / 60000);
            const diffHour = Math.floor(diffMs / 3600000);
            const diffDay = Math.floor(diffMs / 86400000);

            if (diffMin < 1) return 'teraz';
            if (diffMin < 60) return `${diffMin} min temu`;
            if (diffHour < 24) return `${diffHour} godz. temu`;
            if (diffDay < 7) return `${diffDay} dni temu`;

            return date.toLocaleDateString('pl-PL', { day: 'numeric', month: 'short' });
        }

        // Toast
        function showToast(message) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-message').textContent = message;
            toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }

        // Init
        async function init() {
            Sidebar.render();
            Sidebar.setupLogout(supabaseClient);

            const session = await checkAuth();
            if (!session) return;

            await loadTeamMembers();
            await loadBoard();

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeListModal();
                    closeTaskModal();
                }
            });

            // Track mousedown on list drag handles for drag detection
            document.addEventListener('mousedown', (e) => {
                canDragList = e.target.closest('.list-drag-handle') !== null;
            });
            document.addEventListener('mouseup', () => {
                canDragList = false;
            });
        }

        init();
    </script>
</body>
</html>
