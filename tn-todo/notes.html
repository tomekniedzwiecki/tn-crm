<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TN Todo | Notatki</title>
    <link rel="icon" type="image/svg+xml" href="/tn-todo/favicon.svg">
    <link rel="manifest" href="/tn-todo/manifest.json">
    <meta name="theme-color" content="#000000">
    <meta name="mobile-web-app-capable" content="yes">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="components/sidebar.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body { background: #000; color: #ededed; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #444; }
        ::selection { background: white; color: black; }

        .glass-header {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid #262626;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-enter { animation: fadeIn 0.5s ease-out forwards; }

        /* Note card - Vercel style */
        .note-card {
            background: #0a0a0a;
            border: 1px solid #262626;
            border-radius: 12px;
            transition: all 0.2s ease;
            cursor: grab;
        }
        .note-card:hover {
            border-color: #404040;
        }
        .note-card:active {
            cursor: grabbing;
        }
        .note-card.selected {
            border-color: #fff;
            box-shadow: 0 0 0 1px #fff;
        }
        .note-card.sortable-ghost {
            opacity: 0.4;
        }
        .note-card.sortable-drag {
            opacity: 1;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
        }

        /* Color indicators */
        .color-bar {
            width: 4px;
            border-radius: 2px;
            position: absolute;
            left: 0;
            top: 12px;
            bottom: 12px;
        }
        .color-bar-zinc { background: #52525b; }
        .color-bar-blue { background: #3b82f6; }
        .color-bar-emerald { background: #10b981; }
        .color-bar-amber { background: #f59e0b; }
        .color-bar-pink { background: #ec4899; }
        .color-bar-violet { background: #8b5cf6; }

        /* Editor panel */
        .editor-panel {
            background: #0a0a0a;
            border-left: 1px solid #262626;
        }

        /* Rich text editor */
        .note-editor {
            min-height: 300px;
            outline: none;
            line-height: 1.7;
        }
        .note-editor:empty:before {
            content: attr(data-placeholder);
            color: #525252;
            pointer-events: none;
        }

        /* Toolbar */
        .toolbar-btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            color: #737373;
            transition: all 0.15s ease;
        }
        .toolbar-btn:hover {
            background: #262626;
            color: #ededed;
        }
        .toolbar-btn.active {
            background: #262626;
            color: #fff;
        }

        /* Color picker */
        .color-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.15s ease;
            border: 2px solid transparent;
        }
        .color-dot:hover {
            transform: scale(1.15);
        }
        .color-dot.selected {
            border-color: #fff;
        }
        .dot-zinc { background: #52525b; }
        .dot-blue { background: #3b82f6; }
        .dot-emerald { background: #10b981; }
        .dot-amber { background: #f59e0b; }
        .dot-pink { background: #ec4899; }
        .dot-violet { background: #8b5cf6; }

        /* Empty state */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #525252;
        }
    </style>
</head>
<body class="h-screen flex overflow-hidden font-sans text-sm antialiased">

    <!-- Sidebar -->
    <aside id="sidebar" class="w-[240px] bg-black border-r border-white/5 flex flex-col flex-shrink-0"></aside>

    <!-- Main content - split view -->
    <div class="flex-1 flex min-w-0">
        <!-- Notes list -->
        <div class="w-[320px] flex flex-col border-r border-[#262626] bg-black">
            <!-- List header -->
            <div class="h-14 px-4 flex items-center justify-between border-b border-[#262626]">
                <h1 class="text-sm font-semibold text-white">Notatki</h1>
                <button onclick="createNote()" class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-white/5 text-zinc-400 hover:text-white transition-colors" title="Nowa notatka (Ctrl+N)">
                    <i class="ph ph-plus text-lg"></i>
                </button>
            </div>

            <!-- Search -->
            <div class="px-3 py-2 border-b border-[#262626]">
                <div class="relative">
                    <i class="ph ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-zinc-600"></i>
                    <input type="text" id="search-input" placeholder="Szukaj..." class="w-full bg-[#0a0a0a] border border-[#262626] text-zinc-300 text-xs rounded-lg pl-9 pr-3 py-2 focus:border-[#404040] focus:outline-none transition-all placeholder:text-zinc-600">
                </div>
            </div>

            <!-- Notes list -->
            <div id="notes-list" class="flex-1 overflow-y-auto p-2 space-y-2">
                <!-- Notes rendered here -->
            </div>

            <!-- Empty state -->
            <div id="empty-list" class="hidden flex-1 empty-state p-4">
                <i class="ph ph-note-pencil text-4xl mb-3 text-zinc-700"></i>
                <p class="text-zinc-500 text-sm">Brak notatek</p>
                <button onclick="createNote()" class="mt-3 text-xs text-zinc-400 hover:text-white">
                    <i class="ph ph-plus mr-1"></i>Utwórz pierwszą
                </button>
            </div>
        </div>

        <!-- Editor panel -->
        <div id="editor-panel" class="flex-1 flex flex-col editor-panel">
            <!-- No selection state -->
            <div id="no-selection" class="flex-1 empty-state">
                <i class="ph ph-cursor-click text-4xl mb-3 text-zinc-700"></i>
                <p class="text-zinc-500 text-sm">Wybierz notatkę</p>
                <p class="text-zinc-600 text-xs mt-1">lub naciśnij Ctrl+N aby utworzyć nową</p>
            </div>

            <!-- Editor -->
            <div id="editor-container" class="hidden flex-1 flex flex-col">
                <!-- Toolbar -->
                <div class="h-12 px-4 flex items-center gap-1 border-b border-[#262626]">
                    <button onclick="formatText('bold')" class="toolbar-btn" title="Pogrubienie (Ctrl+B)">
                        <i class="ph-bold ph-text-b"></i>
                    </button>
                    <button onclick="formatText('italic')" class="toolbar-btn" title="Kursywa (Ctrl+I)">
                        <i class="ph-bold ph-text-italic"></i>
                    </button>
                    <button onclick="formatText('underline')" class="toolbar-btn" title="Podkreślenie (Ctrl+U)">
                        <i class="ph-bold ph-text-underline"></i>
                    </button>
                    <button onclick="formatText('strikeThrough')" class="toolbar-btn" title="Przekreślenie">
                        <i class="ph-bold ph-text-strikethrough"></i>
                    </button>
                    <div class="w-px h-5 bg-[#262626] mx-2"></div>
                    <button onclick="formatText('insertUnorderedList')" class="toolbar-btn" title="Lista">
                        <i class="ph-bold ph-list-bullets"></i>
                    </button>
                    <button onclick="formatText('insertOrderedList')" class="toolbar-btn" title="Lista numerowana">
                        <i class="ph-bold ph-list-numbers"></i>
                    </button>

                    <div class="ml-auto flex items-center gap-2">
                        <!-- Color picker -->
                        <div class="flex items-center gap-1.5">
                            <button data-color="zinc" class="color-dot dot-zinc selected" onclick="selectColor('zinc')"></button>
                            <button data-color="blue" class="color-dot dot-blue" onclick="selectColor('blue')"></button>
                            <button data-color="emerald" class="color-dot dot-emerald" onclick="selectColor('emerald')"></button>
                            <button data-color="amber" class="color-dot dot-amber" onclick="selectColor('amber')"></button>
                            <button data-color="pink" class="color-dot dot-pink" onclick="selectColor('pink')"></button>
                            <button data-color="violet" class="color-dot dot-violet" onclick="selectColor('violet')"></button>
                        </div>
                        <div class="w-px h-5 bg-[#262626] mx-2"></div>
                        <button onclick="deleteCurrentNote()" class="toolbar-btn text-red-400 hover:text-red-300 hover:bg-red-500/10" title="Usuń notatkę">
                            <i class="ph ph-trash"></i>
                        </button>
                    </div>
                </div>

                <!-- Title -->
                <div class="px-6 pt-6">
                    <input type="text" id="note-title" placeholder="Tytuł" class="w-full bg-transparent text-xl font-semibold text-white placeholder:text-zinc-600 focus:outline-none">
                </div>

                <!-- Content editor -->
                <div class="flex-1 overflow-y-auto px-6 py-4">
                    <div id="note-content" contenteditable="true" class="note-editor text-zinc-300" data-placeholder="Zacznij pisać..."></div>
                </div>

                <!-- Footer with meta -->
                <div class="px-6 py-3 border-t border-[#262626] flex items-center justify-between text-xs text-zinc-600">
                    <span id="note-date"></span>
                    <span id="save-status">Zapisano</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-6 right-6 bg-[#171717] border border-[#262626] text-white px-4 py-3 rounded-lg shadow-xl transform translate-y-20 opacity-0 transition-all duration-300 z-50 flex items-center gap-2">
        <i class="ph ph-check-circle text-emerald-400"></i>
        <span id="toast-message"></span>
    </div>

    <script>
        // Supabase config
        const SUPABASE_URL = 'https://yxmavwkwnfuphjqbelws.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl4bWF2d2t3bmZ1cGhqcWJlbHdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NjQyNTUsImV4cCI6MjA4NDM0MDI1NX0.XeR0Fc7OFn6YbNJrOKTBEj36JtmLISZTM87y4ai9340';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let notes = [];
        let currentMember = null;
        let selectedNoteId = null;
        let selectedColor = 'zinc';
        let saveTimeout = null;
        let sortable = null;

        // Auth check
        async function checkAuth() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
                window.location.href = Sidebar.getLoginPath();
                return null;
            }
            Sidebar.setUserEmail(session.user.email.split('@')[0]);

            const { data: teamMember } = await supabaseClient
                .from('team_members')
                .select('id, role, name, color')
                .eq('user_id', session.user.id)
                .single();

            if (teamMember) {
                currentMember = teamMember;
                Sidebar.setUserName(teamMember.name);
                Sidebar.setUserColor(teamMember.color);
            }

            return session;
        }

        // Load notes
        async function loadNotes(search = '') {
            let query = supabaseClient
                .from('notes')
                .select('*')
                .order('is_pinned', { ascending: false })
                .order('position', { ascending: true })
                .order('created_at', { ascending: false });

            if (search) {
                query = query.or(`title.ilike.%${search}%,content.ilike.%${search}%`);
            }

            const { data, error } = await query;

            if (error) {
                console.error('Error loading notes:', error);
                showToast('Błąd ładowania notatek', 'error');
                return;
            }

            notes = data || [];
            renderNotesList();
            setupDragAndDrop();

            // Select first note if none selected
            if (notes.length > 0 && !selectedNoteId) {
                selectNote(notes[0].id);
            } else if (notes.length === 0) {
                showEmptyState();
            }
        }

        // Render notes list
        function renderNotesList() {
            const list = document.getElementById('notes-list');
            const emptyList = document.getElementById('empty-list');

            if (notes.length === 0) {
                list.classList.add('hidden');
                emptyList.classList.remove('hidden');
                return;
            }

            list.classList.remove('hidden');
            emptyList.classList.add('hidden');

            list.innerHTML = notes.map(note => {
                const title = note.title || 'Bez tytułu';
                const preview = stripHtml(note.content || '').substring(0, 60);
                const isSelected = note.id === selectedNoteId;
                const date = new Date(note.updated_at || note.created_at).toLocaleDateString('pl-PL', { day: 'numeric', month: 'short' });

                return `
                    <div class="note-card relative p-3 pl-5 ${isSelected ? 'selected' : ''}" data-id="${note.id}" onclick="selectNote('${note.id}')">
                        <div class="color-bar color-bar-${note.color}"></div>
                        <div class="flex items-start justify-between gap-2">
                            <div class="min-w-0 flex-1">
                                <div class="font-medium text-white truncate text-sm">${escapeHtml(title)}</div>
                                <div class="text-xs text-zinc-500 truncate mt-0.5">${escapeHtml(preview) || 'Pusta notatka'}</div>
                            </div>
                            ${note.is_pinned ? '<i class="ph-fill ph-push-pin text-zinc-500 text-xs flex-shrink-0"></i>' : ''}
                        </div>
                        <div class="text-[10px] text-zinc-600 mt-2">${date}</div>
                    </div>
                `;
            }).join('');
        }

        // Setup drag and drop
        function setupDragAndDrop() {
            const list = document.getElementById('notes-list');
            if (sortable) sortable.destroy();

            sortable = new Sortable(list, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                dragClass: 'sortable-drag',
                handle: '.note-card',
                onEnd: async function(evt) {
                    const noteId = evt.item.dataset.id;
                    const newIndex = evt.newIndex;

                    // Update local array
                    const note = notes.find(n => n.id === noteId);
                    notes.splice(evt.oldIndex, 1);
                    notes.splice(newIndex, 0, note);

                    // Update positions in DB
                    const updates = notes.map((n, i) => ({
                        id: n.id,
                        position: i
                    }));

                    for (const update of updates) {
                        await supabaseClient
                            .from('notes')
                            .update({ position: update.position })
                            .eq('id', update.id);
                    }
                }
            });
        }

        // Select note
        function selectNote(noteId) {
            selectedNoteId = noteId;
            const note = notes.find(n => n.id === noteId);

            if (!note) return;

            // Update list selection
            document.querySelectorAll('.note-card').forEach(card => {
                card.classList.toggle('selected', card.dataset.id === noteId);
            });

            // Show editor
            document.getElementById('no-selection').classList.add('hidden');
            document.getElementById('editor-container').classList.remove('hidden');

            // Populate editor
            document.getElementById('note-title').value = note.title || '';
            document.getElementById('note-content').innerHTML = note.content || '';
            selectColor(note.color || 'zinc', false);

            const date = new Date(note.created_at).toLocaleDateString('pl-PL', {
                day: 'numeric',
                month: 'long',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            document.getElementById('note-date').textContent = `Utworzono: ${date}`;
            document.getElementById('save-status').textContent = 'Zapisano';
        }

        // Create new note
        async function createNote() {
            if (!currentMember?.id) {
                showToast('Błąd: brak użytkownika', 'error');
                console.error('currentMember is null or has no id');
                return;
            }

            const maxPosition = notes.length > 0 ? Math.max(...notes.map(n => n.position || 0)) + 1 : 0;

            const { data, error } = await supabaseClient
                .from('notes')
                .insert({
                    title: '',
                    content: '',
                    color: 'zinc',
                    position: maxPosition,
                    created_by: currentMember.id
                })
                .select()
                .single();

            if (error) {
                console.error('Error creating note:', error);
                showToast('Błąd tworzenia notatki', 'error');
                return;
            }

            notes.unshift(data);
            renderNotesList();
            setupDragAndDrop();
            selectNote(data.id);

            // Focus title
            document.getElementById('note-title').focus();
        }

        // Auto-save on changes
        function scheduleAutoSave() {
            document.getElementById('save-status').textContent = 'Zapisywanie...';
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveCurrentNote, 500);
        }

        async function saveCurrentNote() {
            if (!selectedNoteId) return;

            const title = document.getElementById('note-title').value.trim();
            const content = document.getElementById('note-content').innerHTML;

            const { error } = await supabaseClient
                .from('notes')
                .update({
                    title: title || null,
                    content,
                    color: selectedColor,
                    updated_at: new Date().toISOString()
                })
                .eq('id', selectedNoteId);

            if (error) {
                console.error('Error saving note:', error);
                document.getElementById('save-status').textContent = 'Błąd zapisu!';
                return;
            }

            // Update local
            const note = notes.find(n => n.id === selectedNoteId);
            if (note) {
                note.title = title;
                note.content = content;
                note.color = selectedColor;
            }

            document.getElementById('save-status').textContent = 'Zapisano';
            renderNotesList();
        }

        // Delete note
        async function deleteCurrentNote() {
            if (!selectedNoteId) return;
            if (!confirm('Czy na pewno chcesz usunąć tę notatkę?')) return;

            const { error } = await supabaseClient
                .from('notes')
                .delete()
                .eq('id', selectedNoteId);

            if (error) {
                console.error('Error deleting note:', error);
                showToast('Błąd usuwania', 'error');
                return;
            }

            notes = notes.filter(n => n.id !== selectedNoteId);
            selectedNoteId = null;

            if (notes.length > 0) {
                selectNote(notes[0].id);
            } else {
                showEmptyState();
            }

            renderNotesList();
            setupDragAndDrop();
            showToast('Notatka usunięta');
        }

        // Show empty state
        function showEmptyState() {
            document.getElementById('no-selection').classList.remove('hidden');
            document.getElementById('editor-container').classList.add('hidden');
        }

        // Color selection
        function selectColor(color, save = true) {
            selectedColor = color;
            document.querySelectorAll('.color-dot').forEach(dot => {
                dot.classList.toggle('selected', dot.dataset.color === color);
            });
            if (save && selectedNoteId) {
                scheduleAutoSave();
            }
        }

        // Rich text formatting
        function formatText(command) {
            document.execCommand(command, false, null);
            document.getElementById('note-content').focus();
            scheduleAutoSave();
        }

        // Event listeners
        document.getElementById('note-title').addEventListener('input', scheduleAutoSave);
        document.getElementById('note-content').addEventListener('input', scheduleAutoSave);

        document.getElementById('search-input').addEventListener('input', (e) => {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => loadNotes(e.target.value), 300);
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Ctrl+N - new note
            if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                e.preventDefault();
                createNote();
            }
            // Escape - deselect
            if (e.key === 'Escape') {
                selectedNoteId = null;
                showEmptyState();
                document.querySelectorAll('.note-card').forEach(c => c.classList.remove('selected'));
            }
        });

        // Format shortcuts in editor
        document.getElementById('note-content').addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                if (e.key === 'b') {
                    e.preventDefault();
                    formatText('bold');
                } else if (e.key === 'i') {
                    e.preventDefault();
                    formatText('italic');
                } else if (e.key === 'u') {
                    e.preventDefault();
                    formatText('underline');
                }
            }
        });

        // Helpers
        function stripHtml(html) {
            const div = document.createElement('div');
            div.innerHTML = html;
            return div.textContent || div.innerText || '';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = toast.querySelector('i');
            icon.className = type === 'error' ? 'ph ph-x-circle text-red-400' : 'ph ph-check-circle text-emerald-400';
            document.getElementById('toast-message').textContent = message;
            toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => toast.classList.add('translate-y-20', 'opacity-0'), 3000);
        }

        // Init
        async function init() {
            Sidebar.render();
            Sidebar.setupLogout(supabaseClient);
            Sidebar.setupProfileClick();

            const session = await checkAuth();
            if (!session) return;

            await loadNotes();
        }

        init();
    </script>
</body>
</html>
