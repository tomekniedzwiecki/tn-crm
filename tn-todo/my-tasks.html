<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TN Todo | Moje zadania</title>
    <link rel="icon" type="image/svg+xml" href="/tn-todo/favicon.svg">
    <link rel="manifest" href="/tn-todo/manifest.json">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="components/sidebar.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body { background: #050505; color: #e5e5e5; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::selection { background: white; color: black; }

        .glass-header {
            background: rgba(5, 5, 5, 0.7);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-enter { animation: fadeIn 0.4s ease-out forwards; }
    </style>
</head>
<body class="h-screen flex overflow-hidden font-sans text-sm tracking-tight antialiased">

    <!-- Sidebar -->
    <aside id="sidebar" class="w-[280px] bg-zinc-950 border-r border-white/5 flex flex-col flex-shrink-0"></aside>

    <!-- Main -->
    <main class="flex-1 flex flex-col bg-black relative min-w-0">
        <!-- Header -->
        <header class="h-16 glass-header flex items-center justify-between px-4 md:px-6 sticky top-0 z-30">
            <div class="flex items-center gap-3">
                <button onclick="Sidebar.toggle()" class="mobile-menu-btn hidden items-center justify-center w-9 h-9 rounded-lg hover:bg-white/5 text-zinc-400 hover:text-white transition-colors">
                    <i class="ph ph-list text-xl"></i>
                </button>
                <div class="flex items-center gap-2 text-zinc-500">
                    <span class="text-zinc-400 hidden sm:inline">tn-todo</span>
                    <span class="text-zinc-700 hidden sm:inline">/</span>
                    <span class="text-white font-medium">moje zadania</span>
                </div>
            </div>
        </header>

        <!-- Content -->
        <div class="flex-1 overflow-y-auto p-6 lg:p-10">
            <div class="max-w-4xl mx-auto animate-enter">
                <div class="mb-8">
                    <h1 class="text-3xl font-semibold text-white tracking-tight mb-1">Moje zadania</h1>
                    <p class="text-zinc-500">Wszystkie zadania przypisane do Ciebie.</p>
                </div>

                <!-- Tasks List -->
                <div id="tasks-container">
                    <div class="text-center py-12 text-zinc-500">
                        <i class="ph ph-circle-notch animate-spin text-2xl mb-2"></i>
                        <p>Ładowanie zadań...</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-6 right-6 bg-zinc-800 border border-white/10 text-white px-4 py-3 rounded-lg shadow-xl transform translate-y-20 opacity-0 transition-all duration-300 z-50">
        <span id="toast-message"></span>
    </div>

    <script>
        const SUPABASE_URL = 'https://yxmavwkwnfuphjqbelws.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl4bWF2d2t3bmZ1cGhqcWJlbHdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NjQyNTUsImV4cCI6MjA4NDM0MDI1NX0.XeR0Fc7OFn6YbNJrOKTBEj36JtmLISZTM87y4ai9340';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentTeamMember = null;
        let tasks = [];

        const PRIORITY_COLORS = {
            'low': 'bg-zinc-600',
            'medium': 'bg-blue-500',
            'high': 'bg-amber-500',
            'urgent': 'bg-red-500'
        };

        function getCrmLoginPath() {
            const isLocal = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
            return isLocal ? '/tn-crm/index.html' : '/index.html';
        }

        async function checkAuth() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
                window.location.href = getCrmLoginPath();
                return null;
            }
            Sidebar.setUserEmail(session.user.email.split('@')[0]);

            const { data: teamMember } = await supabaseClient
                .from('team_members')
                .select('id, role, name, color')
                .eq('user_id', session.user.id)
                .single();

            if (teamMember) {
                currentTeamMember = teamMember;
                Sidebar.setUserName(teamMember.name);
                Sidebar.setUserColor(teamMember.color);
            }

            return session;
        }

        async function loadMyTasks() {
            if (!currentTeamMember) return;

            const { data, error } = await supabaseClient
                .from('todo_tasks')
                .select(`
                    *,
                    list:todo_lists(
                        id, name,
                        board:todo_boards(id, name, color)
                    )
                `)
                .eq('assigned_to', currentTeamMember.id)
                .eq('is_completed', false)
                .order('due_date', { ascending: true, nullsFirst: false });

            if (error) {
                console.error('Error loading tasks:', error);
                return;
            }

            tasks = data || [];
            renderTasks();
        }

        function renderTasks() {
            const container = document.getElementById('tasks-container');

            if (tasks.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-16">
                        <div class="w-16 h-16 rounded-full bg-zinc-800 flex items-center justify-center mx-auto mb-4">
                            <i class="ph ph-check-circle text-3xl text-zinc-600"></i>
                        </div>
                        <h3 class="text-lg font-medium text-white mb-2">Brak zadań</h3>
                        <p class="text-zinc-500">Nie masz przypisanych żadnych aktywnych zadań.</p>
                    </div>
                `;
                return;
            }

            // Group by due date
            const overdue = tasks.filter(t => t.due_date && new Date(t.due_date) < new Date());
            const today = tasks.filter(t => t.due_date && isToday(new Date(t.due_date)));
            const upcoming = tasks.filter(t => t.due_date && new Date(t.due_date) > new Date() && !isToday(new Date(t.due_date)));
            const noDue = tasks.filter(t => !t.due_date);

            let html = '';

            if (overdue.length > 0) {
                html += renderTaskGroup('Zaległe', overdue, 'text-red-400');
            }
            if (today.length > 0) {
                html += renderTaskGroup('Dzisiaj', today, 'text-amber-400');
            }
            if (upcoming.length > 0) {
                html += renderTaskGroup('Nadchodzące', upcoming, 'text-zinc-400');
            }
            if (noDue.length > 0) {
                html += renderTaskGroup('Bez terminu', noDue, 'text-zinc-500');
            }

            container.innerHTML = html;
        }

        function renderTaskGroup(title, tasks, titleColor) {
            return `
                <div class="mb-8">
                    <h2 class="text-xs uppercase tracking-wider ${titleColor} font-semibold mb-3">${title}</h2>
                    <div class="space-y-2">
                        ${tasks.map(task => renderTaskItem(task)).join('')}
                    </div>
                </div>
            `;
        }

        function renderTaskItem(task) {
            const priorityColor = PRIORITY_COLORS[task.priority] || PRIORITY_COLORS['medium'];
            const boardColor = task.list?.board?.color || 'violet';

            return `
                <a href="${Sidebar.getPagePath('board')}?id=${task.list?.board?.id}" class="block bg-zinc-900/60 border border-white/5 rounded-lg p-4 hover:border-white/10 transition-colors">
                    <div class="flex items-start gap-3">
                        <div class="w-1.5 h-1.5 rounded-full ${priorityColor} mt-2 shrink-0"></div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm text-white font-medium mb-1">${escapeHtml(task.title)}</p>
                            <div class="flex items-center gap-2 text-xs text-zinc-500">
                                <span class="px-2 py-0.5 rounded bg-${boardColor}-500/20 text-${boardColor}-400">${escapeHtml(task.list?.board?.name || 'Tablica')}</span>
                                <span>→</span>
                                <span>${escapeHtml(task.list?.name || 'Lista')}</span>
                                ${task.due_date ? `<span class="ml-auto"><i class="ph ph-calendar mr-1"></i>${formatDate(task.due_date)}</span>` : ''}
                            </div>
                        </div>
                    </div>
                </a>
            `;
        }

        function isToday(date) {
            const today = new Date();
            return date.toDateString() === today.toDateString();
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);

            if (date.toDateString() === today.toDateString()) return 'Dziś';
            if (date.toDateString() === tomorrow.toDateString()) return 'Jutro';

            return date.toLocaleDateString('pl-PL', { day: 'numeric', month: 'short' });
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function init() {
            Sidebar.render();
            Sidebar.setupLogout(supabaseClient);

            const session = await checkAuth();
            if (!session) return;

            await loadMyTasks();
        }

        init();

        // Register service worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/tn-todo/sw.js').catch(() => {});
        }
    </script>
</body>
</html>
