<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TN Biznes - Koszty</title>
    <link rel="icon" type="image/svg+xml" href="/tn-biznes/favicon.svg">
    <meta name="theme-color" content="#000000">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="../components/shared-sidebar.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    }
                }
            }
        }
    </script>
    <style>
        body { background: #000; color: #e5e5e5; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::selection { background: #14b8a6; color: black; }

        .glass-header {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-enter { animation: fadeIn 0.4s ease-out forwards; }

        .input-field {
            background: #0a0a0a;
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.2s;
        }
        .input-field:focus {
            border-color: rgba(20, 184, 166, 0.5);
            outline: none;
            box-shadow: 0 0 0 2px rgba(20, 184, 166, 0.1);
        }

        .cost-row { transition: all 0.15s ease; }
        .cost-row:hover { background: rgba(255,255,255,0.03); }

        .tab-btn { transition: all 0.2s; }
        .tab-btn.active {
            background: rgba(20, 184, 166, 0.15);
            color: #14b8a6;
            border-color: rgba(20, 184, 166, 0.3);
        }

        .modal-overlay {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
        }
        .modal-content {
            background: #0a0a0a;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .badge {
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 10px;
            font-weight: 500;
        }
        .badge-recurring { background: rgba(139, 92, 246, 0.15); color: #a78bfa; }
        .badge-one-time { background: rgba(245, 158, 11, 0.15); color: #fbbf24; }
        .badge-paid { background: rgba(16, 185, 129, 0.15); color: #34d399; }
        .badge-unpaid { background: rgba(239, 68, 68, 0.15); color: #f87171; }

        .recurring-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.03) 0%, rgba(255,255,255,0.01) 100%);
            border: 1px solid rgba(255,255,255,0.06);
            transition: all 0.2s;
        }
        .recurring-card:hover {
            border-color: rgba(255,255,255,0.12);
        }
    </style>
</head>
<body class="h-screen flex overflow-hidden font-sans text-sm tracking-tight antialiased">

    <!-- Sidebar -->
    <aside id="sidebar" class="w-[280px] bg-zinc-950 border-r border-white/5 flex flex-col flex-shrink-0"></aside>

    <!-- Main -->
    <main class="flex-1 flex flex-col bg-black relative min-w-0">
        <!-- Header -->
        <header class="h-16 glass-header flex items-center justify-between px-4 md:px-6 sticky top-0 z-30">
            <div class="flex items-center gap-3">
                <button onclick="Sidebar.toggle()" class="mobile-menu-btn hidden items-center justify-center w-9 h-9 rounded-lg hover:bg-white/5 text-zinc-400 hover:text-white transition-colors">
                    <i class="ph ph-list text-xl"></i>
                </button>
                <div class="flex items-center gap-2 text-zinc-500">
                    <span class="text-zinc-400 hidden sm:inline">tn-biznes</span>
                    <span class="text-zinc-700 hidden sm:inline">/</span>
                    <span class="text-white font-medium">koszty</span>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button id="add-btn" onclick="openAddModal()" class="bg-teal-500 text-black hover:bg-teal-400 px-3 md:px-4 py-2 rounded-lg font-medium text-xs md:text-sm transition-colors shadow-[0_0_15px_rgba(20,184,166,0.2)]">
                    <i class="ph ph-plus md:mr-1"></i>
                    <span class="hidden md:inline" id="add-btn-text">Dodaj koszt staly</span>
                </button>
            </div>
        </header>

        <!-- Content -->
        <div class="flex-1 overflow-y-auto">
            <div class="p-4 md:p-6 lg:p-10 max-w-7xl mx-auto animate-enter">

                <!-- Tabs -->
                <div class="flex items-center gap-2 mb-6 border-b border-white/5 pb-4 overflow-x-auto">
                    <button onclick="switchTab('recurring')" data-tab="recurring" class="tab-btn active px-4 py-2 rounded-lg text-sm font-medium text-zinc-400 border border-transparent whitespace-nowrap">
                        <i class="ph ph-repeat mr-1.5"></i>Koszty stale
                    </button>
                    <button onclick="switchTab('monthly')" data-tab="monthly" class="tab-btn px-4 py-2 rounded-lg text-sm font-medium text-zinc-400 border border-transparent whitespace-nowrap">
                        <i class="ph ph-calendar mr-1.5"></i>Koszty miesieczne
                    </button>
                    <button onclick="switchTab('ads')" data-tab="ads" class="tab-btn px-4 py-2 rounded-lg text-sm font-medium text-zinc-400 border border-transparent whitespace-nowrap">
                        <i class="ph ph-megaphone mr-1.5"></i>Reklama
                    </button>
                    <button onclick="switchTab('leasing')" data-tab="leasing" class="tab-btn px-4 py-2 rounded-lg text-sm font-medium text-zinc-400 border border-transparent whitespace-nowrap">
                        <i class="ph ph-car mr-1.5"></i>Leasing
                    </button>
                </div>

                <!-- ==================== RECURRING COSTS TAB ==================== -->
                <div id="recurring-tab" class="">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h2 class="text-lg font-semibold text-white">Szablon kosztow stalych</h2>
                            <p class="text-sm text-zinc-500">Te koszty sa generowane dla kazdego miesiaca</p>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-mono text-teal-400" id="recurring-total">0 zl</div>
                            <div class="text-xs text-zinc-500">suma miesieczna</div>
                        </div>
                    </div>

                    <div id="recurring-list" class="grid gap-3 md:grid-cols-2 lg:grid-cols-3">
                        <div class="text-center text-zinc-600 py-12 col-span-full">Ladowanie...</div>
                    </div>
                </div>

                <!-- ==================== MONTHLY COSTS TAB ==================== -->
                <div id="monthly-tab" class="hidden">
                    <!-- Month selector and generate button -->
                    <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4 mb-6">
                        <div class="flex items-center gap-3">
                            <select id="filter-month" class="input-field rounded-lg px-4 py-2.5 text-white text-base font-medium" onchange="loadMonthlyCosts()">
                            </select>
                            <button onclick="generateMonthlyCosts()" class="flex items-center gap-2 px-4 py-2.5 rounded-lg bg-violet-500/10 text-violet-400 hover:bg-violet-500/20 border border-violet-500/20 transition-colors">
                                <i class="ph ph-magic-wand"></i>
                                <span class="hidden md:inline">Generuj z szablonu</span>
                            </button>
                        </div>
                        <button onclick="openOneTimeModal()" class="flex items-center gap-2 px-4 py-2.5 rounded-lg border border-white/10 text-zinc-400 hover:text-white hover:border-white/20 transition-colors">
                            <i class="ph ph-plus"></i>
                            <span>Dodaj jednorazowy</span>
                        </button>
                    </div>

                    <!-- Stats -->
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 md:gap-4 mb-6">
                        <div class="bg-zinc-950/50 border border-white/5 rounded-xl p-4">
                            <div class="text-2xl font-semibold text-white font-mono" id="stat-total">0 zl</div>
                            <div class="text-xs text-zinc-500">Razem</div>
                        </div>
                        <div class="bg-zinc-950/50 border border-white/5 rounded-xl p-4">
                            <div class="text-2xl font-semibold text-violet-400 font-mono" id="stat-recurring">0 zl</div>
                            <div class="text-xs text-zinc-500">Stale</div>
                        </div>
                        <div class="bg-zinc-950/50 border border-white/5 rounded-xl p-4">
                            <div class="text-2xl font-semibold text-amber-400 font-mono" id="stat-onetime">0 zl</div>
                            <div class="text-xs text-zinc-500">Jednorazowe</div>
                        </div>
                        <div class="bg-zinc-950/50 border border-white/5 rounded-xl p-4">
                            <div class="text-2xl font-semibold text-red-400 font-mono" id="stat-unpaid">0 zl</div>
                            <div class="text-xs text-zinc-500">Do zaplaty</div>
                        </div>
                    </div>

                    <!-- Costs table -->
                    <div class="bg-zinc-950/50 rounded-xl border border-white/5 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="border-b border-white/5 text-left">
                                        <th class="px-4 py-3 text-xs font-semibold text-zinc-500 uppercase tracking-wider">Nazwa</th>
                                        <th class="px-4 py-3 text-xs font-semibold text-zinc-500 uppercase tracking-wider hidden md:table-cell">Kategoria</th>
                                        <th class="px-4 py-3 text-xs font-semibold text-zinc-500 uppercase tracking-wider">Typ</th>
                                        <th class="px-4 py-3 text-xs font-semibold text-zinc-500 uppercase tracking-wider">Kwota</th>
                                        <th class="px-4 py-3 text-xs font-semibold text-zinc-500 uppercase tracking-wider">Status</th>
                                        <th class="px-4 py-3 text-xs font-semibold text-zinc-500 uppercase tracking-wider w-10"></th>
                                    </tr>
                                </thead>
                                <tbody id="monthly-costs-list">
                                    <tr><td colspan="6" class="px-4 py-12 text-center text-zinc-600">Wybierz miesiac</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- ==================== ADS TAB ==================== -->
                <div id="ads-tab" class="hidden">
                    <!-- Month selector -->
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-3">
                            <select id="ads-month" class="input-field rounded-lg px-4 py-2.5 text-white text-base font-medium" onchange="loadAdsData()">
                            </select>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-mono text-rose-400" id="ads-total">0 zl</div>
                            <div class="text-xs text-zinc-500">laczne wydatki</div>
                        </div>
                    </div>

                    <!-- Stats by source -->
                    <div class="grid grid-cols-3 gap-4 mb-6">
                        <div class="bg-zinc-950/50 border border-white/5 rounded-xl p-4">
                            <div class="flex items-center gap-2 mb-2">
                                <div class="w-3 h-3 rounded-full bg-blue-500"></div>
                                <span class="text-sm text-zinc-400">Google</span>
                            </div>
                            <div class="text-xl font-semibold text-blue-400 font-mono" id="ads-google">0 zl</div>
                        </div>
                        <div class="bg-zinc-950/50 border border-white/5 rounded-xl p-4">
                            <div class="flex items-center gap-2 mb-2">
                                <div class="w-3 h-3 rounded-full bg-indigo-500"></div>
                                <span class="text-sm text-zinc-400">Meta</span>
                            </div>
                            <div class="text-xl font-semibold text-indigo-400 font-mono" id="ads-meta">0 zl</div>
                        </div>
                        <div class="bg-zinc-950/50 border border-white/5 rounded-xl p-4">
                            <div class="flex items-center gap-2 mb-2">
                                <div class="w-3 h-3 rounded-full bg-pink-500"></div>
                                <span class="text-sm text-zinc-400">TikTok</span>
                            </div>
                            <div class="text-xl font-semibold text-pink-400 font-mono" id="ads-tiktok">0 zl</div>
                        </div>
                    </div>

                    <!-- Chart -->
                    <div class="bg-zinc-950/50 border border-white/5 rounded-xl p-4 mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-base font-semibold text-white">Wydatki dzienne</h3>
                            <div class="flex items-center gap-3">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" id="toggle-google" checked class="accent-blue-500" onchange="updateAdsChart()">
                                    <span class="text-xs text-blue-400">Google</span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" id="toggle-meta" checked class="accent-indigo-500" onchange="updateAdsChart()">
                                    <span class="text-xs text-indigo-400">Meta</span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" id="toggle-tiktok" checked class="accent-pink-500" onchange="updateAdsChart()">
                                    <span class="text-xs text-pink-400">TikTok</span>
                                </label>
                            </div>
                        </div>
                        <div class="h-64">
                            <canvas id="ads-chart"></canvas>
                        </div>
                    </div>

                    <!-- Quick Entry Grid -->
                    <div class="bg-zinc-950/50 border border-white/5 rounded-xl overflow-hidden">
                        <div class="p-4 border-b border-white/5 flex items-center justify-between">
                            <h3 class="text-base font-semibold text-white flex items-center gap-2">
                                <i class="ph ph-table text-emerald-400"></i>
                                Szybkie wpisywanie
                            </h3>
                            <div class="text-xs text-zinc-500">Wpisz kwoty i nacisnij Enter lub Tab</div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-zinc-900/50">
                                    <tr class="text-zinc-500 text-xs border-b border-white/5">
                                        <th class="text-left py-3 px-4 w-28">Data</th>
                                        <th class="text-center py-3 px-4 w-32">
                                            <div class="flex items-center justify-center gap-1">
                                                <div class="w-2 h-2 rounded-full bg-blue-500"></div>
                                                Google
                                            </div>
                                        </th>
                                        <th class="text-center py-3 px-4 w-32">
                                            <div class="flex items-center justify-center gap-1">
                                                <div class="w-2 h-2 rounded-full bg-indigo-500"></div>
                                                Meta
                                            </div>
                                        </th>
                                        <th class="text-center py-3 px-4 w-32">
                                            <div class="flex items-center justify-center gap-1">
                                                <div class="w-2 h-2 rounded-full bg-pink-500"></div>
                                                TikTok
                                            </div>
                                        </th>
                                        <th class="text-right py-3 px-4 w-32">Suma</th>
                                    </tr>
                                </thead>
                                <tbody id="ads-grid">
                                    <tr><td colspan="5" class="text-center py-8 text-zinc-600">Ladowanie...</td></tr>
                                </tbody>
                                <tfoot class="bg-zinc-900/30 border-t border-white/10">
                                    <tr>
                                        <td class="py-3 px-4 font-medium text-white">SUMA</td>
                                        <td class="py-3 px-4 text-center font-mono text-blue-400" id="grid-total-google">0</td>
                                        <td class="py-3 px-4 text-center font-mono text-indigo-400" id="grid-total-meta">0</td>
                                        <td class="py-3 px-4 text-center font-mono text-pink-400" id="grid-total-tiktok">0</td>
                                        <td class="py-3 px-4 text-right font-mono text-white font-semibold" id="grid-total-all">0</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- ==================== LEASING TAB ==================== -->
                <div id="leasing-tab" class="hidden">
                    <div id="leasing-loading" class="text-center py-12 text-zinc-600">
                        <i class="ph ph-circle-notch animate-spin text-2xl"></i>
                    </div>

                    <div id="leasing-content" class="hidden">
                        <!-- Vehicle Info -->
                        <div class="bg-gradient-to-br from-zinc-900/50 to-zinc-950/50 border border-white/5 rounded-2xl p-6 mb-6">
                            <div class="flex items-start justify-between mb-4">
                                <div class="flex items-center gap-4">
                                    <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500/20 to-violet-500/20 flex items-center justify-center">
                                        <i class="ph ph-car text-xl text-blue-400"></i>
                                    </div>
                                    <div>
                                        <h2 class="text-lg font-semibold text-white" id="lease-vehicle-name">-</h2>
                                        <div class="text-zinc-500 text-sm" id="lease-vehicle-details">-</div>
                                    </div>
                                </div>
                                <span class="px-2 py-1 rounded-full text-xs font-medium bg-emerald-500/15 text-emerald-400">Aktywny</span>
                            </div>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                <div>
                                    <div class="text-zinc-500 text-xs mb-1">Nr umowy</div>
                                    <div class="font-mono text-white" id="lease-contract-nr">-</div>
                                </div>
                                <div>
                                    <div class="text-zinc-500 text-xs mb-1">Leasingodawca</div>
                                    <div class="text-white" id="lease-lessor">-</div>
                                </div>
                                <div>
                                    <div class="text-zinc-500 text-xs mb-1">Rejestracja</div>
                                    <div class="font-mono text-white" id="lease-reg">-</div>
                                </div>
                                <div>
                                    <div class="text-zinc-500 text-xs mb-1">Okres</div>
                                    <div class="text-white" id="lease-period">-</div>
                                </div>
                            </div>
                        </div>

                        <!-- Stats Grid -->
                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                            <div class="bg-zinc-950/50 border border-white/5 rounded-xl p-4">
                                <div class="text-xs text-zinc-500 mb-1">Wartosc auta netto</div>
                                <div class="text-xl font-semibold text-white font-mono" id="lease-value">-</div>
                            </div>
                            <div class="bg-zinc-950/50 border border-white/5 rounded-xl p-4">
                                <div class="text-xs text-zinc-500 mb-1">Rata brutto</div>
                                <div class="text-xl font-semibold text-amber-400 font-mono" id="lease-rate">-</div>
                            </div>
                            <div class="bg-zinc-950/50 border border-white/5 rounded-xl p-4">
                                <div class="text-xs text-zinc-500 mb-1">Pozostalo rat</div>
                                <div class="text-xl font-semibold text-blue-400 font-mono" id="lease-remaining">-</div>
                            </div>
                            <div class="bg-zinc-950/50 border border-white/5 rounded-xl p-4">
                                <div class="text-xs text-zinc-500 mb-1">Wykup</div>
                                <div class="text-xl font-semibold text-violet-400 font-mono" id="lease-residual">-</div>
                            </div>
                        </div>

                        <!-- Progress -->
                        <div class="bg-zinc-950/50 border border-white/5 rounded-xl p-4 mb-6">
                            <div class="flex justify-between text-xs mb-2">
                                <span class="text-zinc-500">Postep splaty</span>
                                <span class="text-white font-mono"><span id="lease-progress">0</span>%</span>
                            </div>
                            <div class="h-2 bg-zinc-800 rounded-full overflow-hidden">
                                <div class="h-full rounded-full bg-gradient-to-r from-emerald-500 to-teal-400 transition-all duration-500" id="lease-progress-bar" style="width: 0%"></div>
                            </div>
                        </div>

                        <!-- Two Column: Tax Deductions + Real Cost -->
                        <div class="grid lg:grid-cols-2 gap-6 mb-6">
                            <!-- Tax Deductions -->
                            <div class="bg-zinc-950/50 border border-white/5 rounded-xl p-5">
                                <h3 class="text-base font-semibold text-white mb-4 flex items-center gap-2">
                                    <i class="ph ph-receipt text-emerald-400"></i>
                                    Odliczenia podatkowe (2026)
                                </h3>

                                <div class="bg-amber-500/10 border border-amber-500/20 rounded-lg p-3 mb-4">
                                    <div class="flex items-center gap-2 text-amber-400 text-xs font-medium">
                                        <i class="ph ph-warning"></i>
                                        Limit: 100 000 zl | Proporcja: <span id="lease-proportion" class="font-mono">-</span>
                                    </div>
                                </div>

                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between py-2 border-b border-white/5">
                                        <span class="text-zinc-400">VAT od raty</span>
                                        <span class="font-mono text-white" id="lease-vat">-</span>
                                    </div>
                                    <div class="flex justify-between py-2 border-b border-white/5">
                                        <span class="text-zinc-400">Odliczenie VAT (50%)</span>
                                        <span class="font-mono text-emerald-400" id="lease-vat-deduct">-</span>
                                    </div>
                                    <div class="flex justify-between py-2 border-b border-white/5">
                                        <span class="text-zinc-400">Koszt kapitalowy (po proporcji)</span>
                                        <span class="font-mono text-emerald-400" id="lease-capital-cost">-</span>
                                    </div>
                                    <div class="flex justify-between py-2 border-b border-white/5">
                                        <span class="text-zinc-400">Koszt odsetkowy (100%)</span>
                                        <span class="font-mono text-emerald-400" id="lease-interest-cost">-</span>
                                    </div>
                                    <div class="flex justify-between py-2 pt-2 border-t border-white/10">
                                        <span class="text-white font-medium">Koszt podatkowy lacznie</span>
                                        <span class="font-mono text-emerald-400 font-semibold" id="lease-tax-cost">-</span>
                                    </div>
                                    <div class="flex justify-between py-2">
                                        <span class="text-zinc-400">Oszczednosc PIT (19%)</span>
                                        <span class="font-mono text-emerald-400" id="lease-pit-save">-</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Real Cost -->
                            <div class="bg-zinc-950/50 border border-white/5 rounded-xl p-5">
                                <h3 class="text-base font-semibold text-white mb-4 flex items-center gap-2">
                                    <i class="ph ph-wallet text-blue-400"></i>
                                    Realny koszt miesiecznie
                                </h3>

                                <div class="space-y-3 text-sm">
                                    <div class="flex justify-between items-center py-3 border-b border-white/5">
                                        <span class="text-zinc-400">Placisz (brutto)</span>
                                        <span class="text-lg font-mono text-white" id="lease-pay">-</span>
                                    </div>
                                    <div class="flex justify-between items-center py-2">
                                        <span class="text-zinc-400">- Odliczenie VAT</span>
                                        <span class="font-mono text-emerald-400" id="lease-real-vat">-</span>
                                    </div>
                                    <div class="flex justify-between items-center py-2">
                                        <span class="text-zinc-400">- Oszczednosc PIT</span>
                                        <span class="font-mono text-emerald-400" id="lease-real-pit">-</span>
                                    </div>
                                    <div class="flex justify-between items-center py-3 border-t border-white/10 mt-2">
                                        <span class="text-white font-medium">= Realny koszt</span>
                                        <span class="text-xl font-bold font-mono text-blue-400" id="lease-real-cost">-</span>
                                    </div>
                                </div>

                                <div class="bg-blue-500/10 border border-blue-500/20 rounded-lg p-4 mt-4">
                                    <div class="text-xs text-blue-400 mb-1">Oszczedzasz miesiecznie</div>
                                    <div class="text-xl font-bold text-blue-400 font-mono" id="lease-savings">-</div>
                                </div>

                                <div class="mt-4 pt-4 border-t border-white/5 grid grid-cols-2 gap-4 text-sm">
                                    <div>
                                        <div class="text-xs text-zinc-600">Suma wplat (caly leasing)</div>
                                        <div class="font-mono text-white" id="lease-total-paid">-</div>
                                    </div>
                                    <div>
                                        <div class="text-xs text-zinc-600">Suma oszczednosci</div>
                                        <div class="font-mono text-emerald-400" id="lease-total-savings">-</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Summary: Total Interest & Capital -->
                        <div class="bg-gradient-to-r from-violet-500/10 to-blue-500/10 border border-violet-500/20 rounded-xl p-5 mb-6">
                            <h3 class="text-base font-semibold text-white mb-4 flex items-center gap-2">
                                <i class="ph ph-chart-pie text-violet-400"></i>
                                Podsumowanie calego leasingu
                            </h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                <div>
                                    <div class="text-xs text-zinc-500 mb-1">Suma rat (netto)</div>
                                    <div class="text-lg font-mono text-white" id="lease-sum-total">-</div>
                                </div>
                                <div>
                                    <div class="text-xs text-zinc-500 mb-1">Suma kapital</div>
                                    <div class="text-lg font-mono text-emerald-400" id="lease-sum-capital">-</div>
                                </div>
                                <div>
                                    <div class="text-xs text-zinc-500 mb-1">Suma odsetki</div>
                                    <div class="text-lg font-mono text-amber-400" id="lease-sum-interest">-</div>
                                    <div class="text-xs text-emerald-400 mt-1">100% do kosztow!</div>
                                </div>
                                <div>
                                    <div class="text-xs text-zinc-500 mb-1">Oszczednosc z odsetek (PIT 19%)</div>
                                    <div class="text-lg font-mono text-emerald-400" id="lease-interest-pit-save">-</div>
                                </div>
                            </div>
                        </div>

                        <!-- Payment Schedule -->
                        <div class="bg-zinc-950/50 border border-white/5 rounded-xl overflow-hidden">
                            <div class="p-4 border-b border-white/5">
                                <h3 class="text-base font-semibold text-white flex items-center gap-2">
                                    <i class="ph ph-calendar-check text-violet-400"></i>
                                    Harmonogram splat
                                </h3>
                            </div>
                            <div class="overflow-x-auto max-h-96">
                                <table class="w-full text-sm">
                                    <thead class="sticky top-0 bg-zinc-900">
                                        <tr class="text-zinc-500 text-xs border-b border-white/5">
                                            <th class="text-left py-3 px-4">Nr</th>
                                            <th class="text-left py-3 px-4">Termin</th>
                                            <th class="text-right py-3 px-4">Rata</th>
                                            <th class="text-right py-3 px-4">Kapital</th>
                                            <th class="text-right py-3 px-4">Odsetki</th>
                                            <th class="text-center py-3 px-4">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="lease-schedule"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div id="leasing-empty" class="hidden text-center py-12">
                        <i class="ph ph-car text-4xl text-zinc-700 mb-3"></i>
                        <div class="text-zinc-500">Brak aktywnych umow leasingowych</div>
                        <div class="text-xs text-zinc-600 mt-1">Uruchom migracje SQL aby dodac dane</div>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <!-- Recurring Cost Modal -->
    <div id="recurring-modal" class="fixed inset-0 modal-overlay z-50 hidden items-center justify-center p-4">
        <div class="modal-content rounded-xl w-full max-w-lg">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 id="recurring-modal-title" class="text-lg font-semibold text-white">Dodaj koszt staly</h3>
                    <button onclick="closeRecurringModal()" class="text-zinc-500 hover:text-white transition-colors">
                        <i class="ph ph-x text-xl"></i>
                    </button>
                </div>

                <form id="recurring-form" onsubmit="saveRecurringCost(event)">
                    <input type="hidden" id="recurring-id">

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-zinc-400 mb-2">Nazwa</label>
                        <input type="text" id="recurring-name" required class="input-field w-full rounded-lg px-3 py-2.5 text-white" placeholder="np. ChatGPT Plus, Hosting VPS">
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-zinc-400 mb-2">Kategoria</label>
                        <select id="recurring-category" required class="input-field w-full rounded-lg px-3 py-2.5 text-white">
                            <option value="tools">Narzedzia</option>
                            <option value="infrastructure">Infrastruktura</option>
                            <option value="marketing">Marketing</option>
                            <option value="office">Biuro</option>
                            <option value="services">Uslugi zewnetrzne</option>
                            <option value="pracownik">Pracownik</option>
                            <option value="other">Inne</option>
                        </select>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-zinc-400 mb-2">Kwota miesieczna (zl brutto)</label>
                        <input type="number" id="recurring-amount" required step="0.01" min="0" class="input-field w-full rounded-lg px-3 py-2.5 text-white" placeholder="0.00">
                    </div>

                    <div class="mb-4">
                        <label class="flex items-center gap-3 cursor-pointer">
                            <input type="checkbox" id="recurring-has-vat" checked class="w-4 h-4 rounded border-zinc-600 bg-zinc-900 text-teal-500 focus:ring-teal-500">
                            <span class="text-sm text-zinc-400">Odliczenie VAT 23%</span>
                        </label>
                        <p class="text-xs text-zinc-600 mt-1 ml-7">Odznacz dla kosztow bez VAT (np. wynagrodzenia)</p>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-zinc-400 mb-2">Obowiazuje od</label>
                        <input type="month" id="recurring-effective-from" required class="input-field w-full rounded-lg px-3 py-2.5 text-white">
                        <p class="text-xs text-zinc-600 mt-1">Miesiac od ktorego koszt zaczyna obowiazywac</p>
                    </div>

                    <div class="mb-6">
                        <label class="block text-sm font-medium text-zinc-400 mb-2">Opis (opcjonalnie)</label>
                        <textarea id="recurring-description" rows="2" class="input-field w-full rounded-lg px-3 py-2.5 text-white resize-none" placeholder="Dodatkowe informacje..."></textarea>
                    </div>

                    <div class="flex gap-3">
                        <button type="button" onclick="closeRecurringModal()" class="flex-1 px-4 py-2.5 rounded-lg border border-white/10 text-zinc-400 hover:text-white hover:border-white/20 transition-colors">
                            Anuluj
                        </button>
                        <button type="submit" class="flex-1 px-4 py-2.5 rounded-lg bg-teal-500 text-black font-medium hover:bg-teal-400 transition-colors">
                            Zapisz
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- One-time / Edit Cost Modal -->
    <div id="cost-modal" class="fixed inset-0 modal-overlay z-50 hidden items-center justify-center p-4">
        <div class="modal-content rounded-xl w-full max-w-lg">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 id="cost-modal-title" class="text-lg font-semibold text-white">Dodaj koszt jednorazowy</h3>
                    <button onclick="closeCostModal()" class="text-zinc-500 hover:text-white transition-colors">
                        <i class="ph ph-x text-xl"></i>
                    </button>
                </div>

                <form id="cost-form" onsubmit="saveCost(event)">
                    <input type="hidden" id="cost-id">
                    <input type="hidden" id="cost-type" value="one_time">

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-zinc-400 mb-2">Nazwa</label>
                        <input type="text" id="cost-name" required class="input-field w-full rounded-lg px-3 py-2.5 text-white" placeholder="np. Nowy laptop, Konferencja">
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-zinc-400 mb-2">Kategoria</label>
                        <select id="cost-category" required class="input-field w-full rounded-lg px-3 py-2.5 text-white">
                            <option value="tools">Narzedzia</option>
                            <option value="infrastructure">Infrastruktura</option>
                            <option value="marketing">Marketing</option>
                            <option value="office">Biuro</option>
                            <option value="services">Uslugi zewnetrzne</option>
                            <option value="pracownik">Pracownik</option>
                            <option value="other">Inne</option>
                        </select>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-zinc-400 mb-2">Kwota (zl brutto)</label>
                        <input type="number" id="cost-amount" required step="0.01" min="0" class="input-field w-full rounded-lg px-3 py-2.5 text-white" placeholder="0.00">
                    </div>

                    <div class="mb-4">
                        <label class="flex items-center gap-3 cursor-pointer">
                            <input type="checkbox" id="cost-has-vat" checked class="w-4 h-4 rounded border-zinc-600 bg-zinc-900 text-teal-500 focus:ring-teal-500">
                            <span class="text-sm text-zinc-400">Odliczenie VAT 23%</span>
                        </label>
                        <p class="text-xs text-zinc-600 mt-1 ml-7">Odznacz dla kosztow bez VAT (np. wynagrodzenia)</p>
                    </div>

                    <div class="mb-6">
                        <label class="block text-sm font-medium text-zinc-400 mb-2">Opis (opcjonalnie)</label>
                        <textarea id="cost-description" rows="2" class="input-field w-full rounded-lg px-3 py-2.5 text-white resize-none" placeholder="Dodatkowe informacje..."></textarea>
                    </div>

                    <div class="flex gap-3">
                        <button type="button" onclick="closeCostModal()" class="flex-1 px-4 py-2.5 rounded-lg border border-white/10 text-zinc-400 hover:text-white hover:border-white/20 transition-colors">
                            Anuluj
                        </button>
                        <button type="submit" class="flex-1 px-4 py-2.5 rounded-lg bg-teal-500 text-black font-medium hover:bg-teal-400 transition-colors">
                            Zapisz
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // SUPABASE CONFIG
        // ============================================
        const SUPABASE_URL = 'https://yxmavwkwnfuphjqbelws.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl4bWF2d2t3bmZ1cGhqcWJlbHdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NjQyNTUsImV4cCI6MjA4NDM0MDI1NX0.XeR0Fc7OFn6YbNJrOKTBEj36JtmLISZTM87y4ai9340';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ============================================
        // STATE
        // ============================================
        let recurringCosts = [];
        let monthlyCosts = [];
        let currentTab = 'recurring';

        const CATEGORIES = {
            'infrastructure': { label: 'Infrastruktura', icon: 'ph-hard-drives' },
            'tools': { label: 'Narzedzia', icon: 'ph-wrench' },
            'marketing': { label: 'Marketing', icon: 'ph-megaphone' },
            'office': { label: 'Biuro', icon: 'ph-buildings' },
            'services': { label: 'Uslugi', icon: 'ph-users' },
            'pracownik': { label: 'Pracownik', icon: 'ph-user' },
            'other': { label: 'Inne', icon: 'ph-dots-three' }
        };

        // ============================================
        // AUTH
        // ============================================
        async function checkAuth() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
                window.location.href = Sidebar.getLoginPath();
                return null;
            }
            return session;
        }

        // ============================================
        // HELPERS
        // ============================================
        function formatMoney(amount) {
            return new Intl.NumberFormat('pl-PL', { minimumFractionDigits: 0, maximumFractionDigits: 2 }).format(amount) + ' zl';
        }

        function formatMonth(dateStr) {
            if (!dateStr) return '-';
            const d = new Date(dateStr);
            return d.toLocaleDateString('pl-PL', { month: 'long', year: 'numeric' });
        }

        function getCurrentMonth() {
            const d = new Date();
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
        }

        function populateMonthFilter() {
            const select = document.getElementById('filter-month');
            const months = [];
            const now = new Date();

            for (let i = -6; i <= 6; i++) {
                const d = new Date(now.getFullYear(), now.getMonth() + i, 1);
                const value = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                const label = d.toLocaleDateString('pl-PL', { month: 'long', year: 'numeric' });
                months.push({ value, label });
            }

            select.innerHTML = months.map(m => {
                const selected = m.value === getCurrentMonth() ? 'selected' : '';
                return `<option value="${m.value}" ${selected}>${m.label}</option>`;
            }).join('');
        }

        // ============================================
        // DATA LOADING
        // ============================================
        async function loadRecurringCosts() {
            const { data, error } = await supabaseClient
                .from('biznes_recurring_costs')
                .select('*')
                .eq('is_active', true)
                .order('name');

            if (!error) {
                recurringCosts = data || [];
                renderRecurringCosts();
            }
        }

        async function loadMonthlyCosts() {
            const month = document.getElementById('filter-month').value;
            if (!month) return;

            const monthStart = month + '-01';

            const { data, error } = await supabaseClient
                .from('biznes_costs')
                .select('*')
                .eq('month', monthStart)
                .neq('category', 'pracownik') // Exclude employee costs - we calculate them live
                .order('cost_type')
                .order('name');

            if (!error) {
                monthlyCosts = data || [];

                // Calculate employee costs live and add to monthlyCosts
                await calculateLiveEmployeeCosts(monthStart);

                renderMonthlyCosts();
                updateStats();
            }
        }

        async function calculateLiveEmployeeCosts(monthStart) {
            const monthEnd = new Date(new Date(monthStart).setMonth(new Date(monthStart).getMonth() + 1) - 1)
                .toISOString().split('T')[0] + 'T23:59:59';

            // Get active contracts
            const { data: contracts } = await supabaseClient
                .from('employee_contracts')
                .select('*, team_members!inner(id, name)')
                .lte('effective_from', monthStart)
                .or(`effective_to.is.null,effective_to.gte.${monthStart}`);

            if (!contracts || contracts.length === 0) return;

            // Fetch manual bonuses for this month
            const { data: allBonuses } = await supabaseClient
                .from('employee_bonuses')
                .select('*')
                .eq('month', monthStart);

            const bonusesByMember = {};
            if (allBonuses) {
                for (const b of allBonuses) {
                    if (!bonusesByMember[b.team_member_id]) {
                        bonusesByMember[b.team_member_id] = [];
                    }
                    bonusesByMember[b.team_member_id].push(b);
                }
            }

            for (const contract of contracts) {
                // Calculate sales for this employee
                const { totalSales, orderCount } = await getEmployeeSales(
                    contract.team_member_id,
                    monthStart,
                    monthEnd
                );

                // Calculate costs
                const tiers = contract.commission_tiers || [];
                const commission = calcCommission(totalSales, tiers);
                const monthlyBonus = calcMonthlyBonus(
                    totalSales,
                    contract.monthly_bonus_threshold,
                    contract.monthly_bonus_amount
                );

                // Calculate manual bonuses
                const manualBonuses = bonusesByMember[contract.team_member_id] || [];
                const manualBonusTotal = manualBonuses.reduce((sum, b) => sum + parseFloat(b.amount), 0);

                const baseSalary = parseFloat(contract.base_salary) || 0;
                const totalCost = Math.max(0, baseSalary + commission + monthlyBonus + manualBonusTotal);

                // Build description
                let description = `Podstawa: ${formatMoney(baseSalary)}`;
                if (totalSales > 0) {
                    description += ` | Sprzedaz netto: ${formatMoney(totalSales)} (${orderCount} zam.)`;
                }
                if (commission > 0) {
                    description += ` | Prowizja: ${formatMoney(commission)}`;
                }
                if (monthlyBonus > 0) {
                    description += ` | Bonus: ${formatMoney(monthlyBonus)}`;
                }
                if (manualBonusTotal > 0) {
                    description += ` | Bonusy dodatkowe: ${formatMoney(manualBonusTotal)}`;
                }

                // Add to monthlyCosts as a virtual entry (not saved to DB)
                monthlyCosts.push({
                    id: `emp_${contract.team_member_id}`, // Virtual ID
                    name: `${contract.team_members.name}`,
                    description: description,
                    category: 'pracownik',
                    amount: totalCost,
                    cost_type: 'recurring',
                    month: monthStart,
                    is_paid: false,
                    is_virtual: true // Mark as virtual - not editable
                });
            }
        }

        // ============================================
        // RENDERING
        // ============================================
        function renderRecurringCosts() {
            const container = document.getElementById('recurring-list');
            const total = recurringCosts.reduce((s, c) => s + parseFloat(c.amount || 0), 0);
            document.getElementById('recurring-total').textContent = formatMoney(total);

            if (recurringCosts.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <i class="ph ph-repeat text-4xl text-zinc-700 mb-3"></i>
                        <p class="text-zinc-500">Brak kosztow stalych</p>
                        <p class="text-zinc-600 text-xs mt-1">Dodaj koszty ktore powtarzaja sie co miesiac</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = recurringCosts.map(cost => {
                const cat = CATEGORIES[cost.category] || CATEGORIES.other;
                return `
                    <div class="recurring-card rounded-xl p-4">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-lg bg-white/5 flex items-center justify-center">
                                    <i class="ph ${cat.icon} text-zinc-400 text-lg"></i>
                                </div>
                                <div>
                                    <div class="text-white font-medium">${cost.name}</div>
                                    <div class="text-xs text-zinc-500">${cat.label}</div>
                                </div>
                            </div>
                            <div class="flex items-center gap-1">
                                <button onclick="editRecurringCost('${cost.id}')" class="p-1.5 text-zinc-500 hover:text-white transition-colors">
                                    <i class="ph ph-pencil"></i>
                                </button>
                                <button onclick="deleteRecurringCost('${cost.id}')" class="p-1.5 text-zinc-500 hover:text-red-400 transition-colors">
                                    <i class="ph ph-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="text-2xl font-mono text-teal-400">${formatMoney(cost.amount)}</div>
                        <div class="text-xs text-zinc-500">/ miesiac</div>
                        ${cost.description ? `<div class="text-xs text-zinc-600 mt-2 truncate">${cost.description}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        function renderMonthlyCosts() {
            const container = document.getElementById('monthly-costs-list');

            if (monthlyCosts.length === 0) {
                container.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-4 py-12 text-center">
                            <i class="ph ph-calendar-x text-4xl text-zinc-700 mb-3"></i>
                            <p class="text-zinc-500">Brak kosztow w tym miesiacu</p>
                            <p class="text-zinc-600 text-xs mt-1">Kliknij "Generuj z szablonu" aby dodac koszty stale</p>
                        </td>
                    </tr>
                `;
                return;
            }

            container.innerHTML = monthlyCosts.map(cost => {
                const cat = CATEGORIES[cost.category] || CATEGORIES.other;
                const typeLabel = cost.cost_type === 'recurring' ? 'Staly' : 'Jednorazowy';
                const typeBadge = cost.cost_type === 'recurring' ? 'badge-recurring' : 'badge-one-time';
                const statusBadge = cost.is_paid ? 'badge-paid' : 'badge-unpaid';
                const statusLabel = cost.is_paid ? 'Oplacone' : 'Do zaplaty';
                const isVirtual = cost.is_virtual;

                // For virtual employee costs - show "Live" badge and no edit/delete buttons
                const actionButtons = isVirtual ? `
                    <span class="badge bg-teal-500/20 text-teal-400 text-[10px]">
                        <i class="ph ph-lightning mr-1"></i>Live
                    </span>
                ` : `
                    <div class="flex items-center gap-1">
                        <button onclick="editCost('${cost.id}')" class="p-1.5 text-zinc-500 hover:text-white transition-colors">
                            <i class="ph ph-pencil"></i>
                        </button>
                        <button onclick="deleteCost('${cost.id}')" class="p-1.5 text-zinc-500 hover:text-red-400 transition-colors">
                            <i class="ph ph-trash"></i>
                        </button>
                    </div>
                `;

                const statusButton = isVirtual ? `
                    <span class="text-xs text-zinc-500">auto</span>
                ` : `
                    <button onclick="togglePaid('${cost.id}', ${!cost.is_paid})" class="badge ${statusBadge} cursor-pointer hover:opacity-80 transition-opacity">
                        ${statusLabel}
                    </button>
                `;

                return `
                    <tr class="cost-row border-b border-white/5 ${isVirtual ? 'bg-teal-500/5' : ''}">
                        <td class="px-4 py-3">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-lg ${isVirtual ? 'bg-teal-500/20' : 'bg-white/5'} flex items-center justify-center">
                                    <i class="ph ${cat.icon} ${isVirtual ? 'text-teal-400' : 'text-zinc-400'}"></i>
                                </div>
                                <div>
                                    <div class="text-sm text-white font-medium">${cost.name}</div>
                                    ${cost.description ? `<div class="text-xs text-zinc-500 max-w-[300px]">${cost.description}</div>` : ''}
                                </div>
                            </div>
                        </td>
                        <td class="px-4 py-3 hidden md:table-cell">
                            <span class="text-zinc-400 text-sm">${cat.label}</span>
                        </td>
                        <td class="px-4 py-3">
                            <span class="badge ${typeBadge}">${typeLabel}</span>
                        </td>
                        <td class="px-4 py-3">
                            <span class="text-white font-mono">${formatMoney(cost.amount)}</span>
                        </td>
                        <td class="px-4 py-3">
                            ${statusButton}
                        </td>
                        <td class="px-4 py-3">
                            ${actionButtons}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateStats() {
            const total = monthlyCosts.reduce((s, c) => s + parseFloat(c.amount || 0), 0);
            const recurring = monthlyCosts.filter(c => c.cost_type === 'recurring').reduce((s, c) => s + parseFloat(c.amount || 0), 0);
            const oneTime = monthlyCosts.filter(c => c.cost_type === 'one_time').reduce((s, c) => s + parseFloat(c.amount || 0), 0);
            const unpaid = monthlyCosts.filter(c => !c.is_paid).reduce((s, c) => s + parseFloat(c.amount || 0), 0);

            document.getElementById('stat-total').textContent = formatMoney(total);
            document.getElementById('stat-recurring').textContent = formatMoney(recurring);
            document.getElementById('stat-onetime').textContent = formatMoney(oneTime);
            document.getElementById('stat-unpaid').textContent = formatMoney(unpaid);
        }

        // ============================================
        // TABS
        // ============================================
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('[data-tab]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tab);
            });

            document.getElementById('recurring-tab').classList.toggle('hidden', tab !== 'recurring');
            document.getElementById('monthly-tab').classList.toggle('hidden', tab !== 'monthly');
            document.getElementById('ads-tab').classList.toggle('hidden', tab !== 'ads');
            document.getElementById('leasing-tab').classList.toggle('hidden', tab !== 'leasing');

            // Update add button
            const addBtn = document.getElementById('add-btn');
            const addBtnText = document.getElementById('add-btn-text');
            if (tab === 'recurring') {
                addBtn.classList.remove('hidden');
                addBtn.onclick = () => openRecurringModal();
                addBtnText.textContent = 'Dodaj koszt staly';
            } else if (tab === 'monthly') {
                addBtn.classList.remove('hidden');
                addBtn.onclick = () => openOneTimeModal();
                addBtnText.textContent = 'Dodaj jednorazowy';
            } else if (tab === 'ads' || tab === 'leasing') {
                addBtn.classList.add('hidden');
            }

            if (tab === 'monthly') {
                loadMonthlyCosts();
            } else if (tab === 'ads') {
                loadAdsData();
            } else if (tab === 'leasing') {
                loadLeasingData();
            }
        }

        // ============================================
        // MODALS
        // ============================================
        function openAddModal() {
            if (currentTab === 'recurring') {
                openRecurringModal();
            } else {
                openOneTimeModal();
            }
        }

        function openRecurringModal(id = null) {
            const modal = document.getElementById('recurring-modal');
            document.getElementById('recurring-form').reset();
            document.getElementById('recurring-id').value = '';
            document.getElementById('recurring-modal-title').textContent = 'Dodaj koszt staly';
            document.getElementById('recurring-has-vat').checked = true; // Default: VAT 23%
            // Ustaw domyln warto effective_from na biecy miesic
            document.getElementById('recurring-effective-from').value = getCurrentMonth();
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeRecurringModal() {
            document.getElementById('recurring-modal').classList.add('hidden');
            document.getElementById('recurring-modal').classList.remove('flex');
        }

        function openOneTimeModal() {
            const modal = document.getElementById('cost-modal');
            document.getElementById('cost-form').reset();
            document.getElementById('cost-id').value = '';
            document.getElementById('cost-type').value = 'one_time';
            document.getElementById('cost-has-vat').checked = true; // Default: VAT 23%
            document.getElementById('cost-modal-title').textContent = 'Dodaj koszt jednorazowy';
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeCostModal() {
            document.getElementById('cost-modal').classList.add('hidden');
            document.getElementById('cost-modal').classList.remove('flex');
        }

        // ============================================
        // CRUD - RECURRING COSTS
        // ============================================
        async function saveRecurringCost(e) {
            e.preventDefault();
            const id = document.getElementById('recurring-id').value;
            const effectiveFromMonth = document.getElementById('recurring-effective-from').value;
            const data = {
                name: document.getElementById('recurring-name').value,
                category: document.getElementById('recurring-category').value,
                amount: parseFloat(document.getElementById('recurring-amount').value),
                description: document.getElementById('recurring-description').value || null,
                effective_from: effectiveFromMonth ? effectiveFromMonth + '-01' : null,
                vat_rate: document.getElementById('recurring-has-vat').checked ? 0.23 : 0
            };

            let result;
            if (id) {
                result = await supabaseClient.from('biznes_recurring_costs').update(data).eq('id', id);
            } else {
                result = await supabaseClient.from('biznes_recurring_costs').insert(data);
            }

            if (!result.error) {
                closeRecurringModal();
                await loadRecurringCosts();
            } else {
                alert('Blad: ' + result.error.message);
            }
        }

        async function editRecurringCost(id) {
            const cost = recurringCosts.find(c => c.id === id);
            if (!cost) return;

            document.getElementById('recurring-id').value = cost.id;
            document.getElementById('recurring-name').value = cost.name;
            document.getElementById('recurring-category').value = cost.category;
            document.getElementById('recurring-amount').value = cost.amount;
            document.getElementById('recurring-description').value = cost.description || '';
            document.getElementById('recurring-has-vat').checked = (cost.vat_rate || 0.23) > 0;
            // Ustaw effective_from (format YYYY-MM)
            const effectiveFrom = cost.effective_from || cost.created_at?.split('T')[0];
            document.getElementById('recurring-effective-from').value = effectiveFrom ? effectiveFrom.substring(0, 7) : getCurrentMonth();
            document.getElementById('recurring-modal-title').textContent = 'Edytuj koszt staly';

            document.getElementById('recurring-modal').classList.remove('hidden');
            document.getElementById('recurring-modal').classList.add('flex');
        }

        async function deleteRecurringCost(id) {
            if (!confirm('Czy na pewno chcesz usunac ten koszt staly?')) return;

            const { error } = await supabaseClient
                .from('biznes_recurring_costs')
                .update({ is_active: false })
                .eq('id', id);

            if (!error) {
                await loadRecurringCosts();
            }
        }

        // ============================================
        // CRUD - MONTHLY COSTS
        // ============================================
        async function generateMonthlyCosts() {
            const month = document.getElementById('filter-month').value;
            if (!month) return;

            const monthStart = month + '-01';

            // Check if already generated
            const existingRecurring = monthlyCosts.filter(c => c.cost_type === 'recurring');
            if (existingRecurring.length > 0) {
                if (!confirm(`Ten miesiac ma juz ${existingRecurring.length} kosztow stalych. Czy chcesz dodac nowe z szablonu?`)) {
                    return;
                }
            }

            // Generate from template
            const newCosts = recurringCosts.map(rc => ({
                recurring_cost_id: rc.id,
                name: rc.name,
                description: rc.description,
                category: rc.category,
                amount: rc.amount,
                cost_type: 'recurring',
                month: monthStart,
                is_paid: false,
                vat_rate: rc.vat_rate ?? 0.23
            }));

            if (newCosts.length === 0) {
                alert('Brak kosztow stalych do wygenerowania. Dodaj najpierw koszty stale.');
                return;
            }

            const { error } = await supabaseClient.from('biznes_costs').insert(newCosts);

            if (!error) {
                await loadMonthlyCosts();
            } else {
                alert('Blad: ' + error.message);
            }
        }

        async function saveCost(e) {
            e.preventDefault();
            const id = document.getElementById('cost-id').value;
            const month = document.getElementById('filter-month').value + '-01';

            const amount = parseFloat(document.getElementById('cost-amount').value);
            if (amount < 0) {
                alert('Kwota nie moe by ujemna');
                return;
            }

            const data = {
                name: document.getElementById('cost-name').value,
                category: document.getElementById('cost-category').value,
                amount: amount,
                description: document.getElementById('cost-description').value || null,
                cost_type: document.getElementById('cost-type').value,
                month: month,
                vat_rate: document.getElementById('cost-has-vat').checked ? 0.23 : 0
            };

            let result;
            if (id) {
                result = await supabaseClient.from('biznes_costs').update(data).eq('id', id);
            } else {
                result = await supabaseClient.from('biznes_costs').insert(data);
            }

            if (!result.error) {
                closeCostModal();
                await loadMonthlyCosts();
            } else {
                alert('Blad: ' + result.error.message);
            }
        }

        async function editCost(id) {
            const cost = monthlyCosts.find(c => c.id === id);
            if (!cost) return;

            document.getElementById('cost-id').value = cost.id;
            document.getElementById('cost-name').value = cost.name;
            document.getElementById('cost-category').value = cost.category;
            document.getElementById('cost-amount').value = cost.amount;
            document.getElementById('cost-description').value = cost.description || '';
            document.getElementById('cost-type').value = cost.cost_type;
            document.getElementById('cost-has-vat').checked = (cost.vat_rate || 0) > 0;
            document.getElementById('cost-modal-title').textContent = 'Edytuj koszt';

            document.getElementById('cost-modal').classList.remove('hidden');
            document.getElementById('cost-modal').classList.add('flex');
        }

        async function deleteCost(id) {
            if (!confirm('Czy na pewno chcesz usunac ten koszt?')) return;

            const { error } = await supabaseClient.from('biznes_costs').delete().eq('id', id);
            if (!error) {
                await loadMonthlyCosts();
            }
        }

        async function togglePaid(id, isPaid) {
            const { error } = await supabaseClient
                .from('biznes_costs')
                .update({ is_paid: isPaid, paid_at: isPaid ? new Date().toISOString() : null })
                .eq('id', id);

            if (!error) {
                await loadMonthlyCosts();
            }
        }

        // ============================================
        // EMPLOYEE COSTS
        // ============================================
        function toNetto(brutto) {
            return brutto / 1.23;
        }

        function calcCommission(sales, tiers) {
            let commission = 0;
            const sortedTiers = [...tiers].sort((a, b) => a.min - b.min);

            for (const tier of sortedTiers) {
                if (sales > tier.min) {
                    const amt = Math.min(sales, tier.max) - tier.min;
                    commission += amt * tier.rate;
                }
            }

            // Handle sales above max tier
            if (sortedTiers.length > 0) {
                const maxTier = sortedTiers[sortedTiers.length - 1];
                if (sales > maxTier.max) {
                    commission += (sales - maxTier.max) * maxTier.rate;
                }
            }

            return commission;
        }

        function calcMonthlyBonus(sales, threshold, amount) {
            if (!threshold || !amount) return 0;
            return sales >= threshold ? amount : 0;
        }

        async function getEmployeeSales(teamMemberId, monthStart, monthEnd) {
            // Get paid orders in date range
            const { data: orders } = await supabaseClient
                .from('orders')
                .select('id, amount, lead_id, paid_at, customer_email')
                .eq('status', 'paid')
                .gte('paid_at', monthStart)
                .lte('paid_at', monthEnd);

            if (!orders || orders.length === 0) {
                return { totalSales: 0, orderCount: 0 };
            }

            // Get leads to find assigned_to
            const leadIds = [...new Set(orders.filter(o => o.lead_id).map(o => o.lead_id))];
            let leadsMap = {};

            if (leadIds.length > 0) {
                const { data: leads } = await supabaseClient
                    .from('leads')
                    .select('id, assigned_to')
                    .in('id', leadIds);
                if (leads) leadsMap = Object.fromEntries(leads.map(l => [l.id, l.assigned_to]));
            }

            // For orders without lead_id, try to find lead by email
            const ordersWithoutLead = orders.filter(o => !o.lead_id && o.customer_email);
            if (ordersWithoutLead.length > 0) {
                const emails = [...new Set(ordersWithoutLead.map(o => o.customer_email))];
                const { data: leadsByEmail } = await supabaseClient
                    .from('leads')
                    .select('id, email, assigned_to')
                    .in('email', emails);

                if (leadsByEmail) {
                    const emailToLead = Object.fromEntries(leadsByEmail.map(l => [l.email, l]));
                    for (const order of ordersWithoutLead) {
                        const lead = emailToLead[order.customer_email];
                        if (lead) {
                            leadsMap[order.id] = lead.assigned_to;
                        }
                    }
                }
            }

            // Sum orders for this team member (convert to NETTO)
            let totalSales = 0;
            let orderCount = 0;

            for (const order of orders) {
                const assignedTo = order.lead_id ? leadsMap[order.lead_id] : leadsMap[order.id];
                if (assignedTo === teamMemberId) {
                    totalSales += toNetto(parseFloat(order.amount));
                    orderCount++;
                }
            }

            return { totalSales, orderCount };
        }

        // ============================================
        // ADS / REKLAMA
        // ============================================
        const AD_SOURCES = ['google', 'meta', 'tiktok'];
        const AD_COLORS = {
            google: { bg: 'rgba(59, 130, 246, 0.8)', border: 'rgb(59, 130, 246)' },
            meta: { bg: 'rgba(99, 102, 241, 0.8)', border: 'rgb(99, 102, 241)' },
            tiktok: { bg: 'rgba(236, 72, 153, 0.8)', border: 'rgb(236, 72, 153)' }
        };
        let adsData = [];
        let adsChart = null;

        function initAdsMonthSelector() {
            const select = document.getElementById('ads-month');
            if (!select || select.options.length > 0) return;

            const today = new Date();
            for (let i = 0; i < 12; i++) {
                const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
                const value = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                const label = d.toLocaleDateString('pl-PL', { month: 'long', year: 'numeric' });
                const opt = document.createElement('option');
                opt.value = value;
                opt.textContent = label.charAt(0).toUpperCase() + label.slice(1);
                select.appendChild(opt);
            }
        }

        async function loadAdsData() {
            initAdsMonthSelector();
            const monthStr = document.getElementById('ads-month').value;
            if (!monthStr) return;

            const [year, month] = monthStr.split('-').map(Number);
            const startDate = `${year}-${String(month).padStart(2, '0')}-01`;
            const endDate = new Date(year, month, 0).toISOString().split('T')[0]; // Last day of month

            const { data, error } = await supabaseClient
                .from('ad_expenses')
                .select('*')
                .gte('date', startDate)
                .lte('date', endDate)
                .order('date');

            if (error) {
                console.error('Error loading ads data:', error);
                return;
            }

            adsData = data || [];
            renderAdsStats();
            renderAdsGrid(year, month);
            renderAdsChart(year, month);
        }

        function renderAdsStats() {
            let total = 0, google = 0, meta = 0, tiktok = 0;
            for (const row of adsData) {
                const amt = parseFloat(row.amount) || 0;
                total += amt;
                if (row.source === 'google') google += amt;
                if (row.source === 'meta') meta += amt;
                if (row.source === 'tiktok') tiktok += amt;
            }
            document.getElementById('ads-total').textContent = formatMoney(total);
            document.getElementById('ads-google').textContent = formatMoney(google);
            document.getElementById('ads-meta').textContent = formatMoney(meta);
            document.getElementById('ads-tiktok').textContent = formatMoney(tiktok);
        }

        function renderAdsGrid(year, month) {
            const daysInMonth = new Date(year, month, 0).getDate();
            const grid = document.getElementById('ads-grid');

            // Create lookup map
            const dataMap = {};
            for (const row of adsData) {
                const key = `${row.date}_${row.source}`;
                dataMap[key] = row.amount;
            }

            let html = '';
            let totals = { google: 0, meta: 0, tiktok: 0 };

            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayName = new Date(dateStr).toLocaleDateString('pl-PL', { weekday: 'short' });
                const isWeekend = [0, 6].includes(new Date(dateStr).getDay());

                let rowSum = 0;
                let cells = '';
                for (const src of AD_SOURCES) {
                    const val = parseFloat(dataMap[`${dateStr}_${src}`]) || 0;
                    rowSum += val;
                    totals[src] += val;
                    cells += `
                        <td class="py-1 px-2 text-center">
                            <input type="number" step="0.01" min="0"
                                class="w-full bg-transparent border border-transparent hover:border-white/10 focus:border-teal-500/50 focus:bg-zinc-900 rounded px-2 py-1.5 text-center font-mono text-sm outline-none transition-all"
                                value="${val || ''}"
                                data-date="${dateStr}"
                                data-source="${src}"
                                onchange="saveAdExpense(this)"
                                onkeydown="handleAdInputKey(event, this)"
                                placeholder="0">
                        </td>
                    `;
                }

                html += `
                    <tr class="${isWeekend ? 'bg-zinc-900/30' : ''} border-b border-white/5 hover:bg-white/[0.02]">
                        <td class="py-1.5 px-4">
                            <span class="font-mono text-zinc-400">${String(day).padStart(2, '0')}</span>
                            <span class="text-zinc-600 text-xs ml-1">${dayName}</span>
                        </td>
                        ${cells}
                        <td class="py-1.5 px-4 text-right font-mono text-zinc-400">${rowSum > 0 ? formatMoney(rowSum) : '-'}</td>
                    </tr>
                `;
            }

            grid.innerHTML = html;

            // Update totals
            document.getElementById('grid-total-google').textContent = formatMoney(totals.google);
            document.getElementById('grid-total-meta').textContent = formatMoney(totals.meta);
            document.getElementById('grid-total-tiktok').textContent = formatMoney(totals.tiktok);
            document.getElementById('grid-total-all').textContent = formatMoney(totals.google + totals.meta + totals.tiktok);
        }

        async function saveAdExpense(input) {
            const date = input.dataset.date;
            const source = input.dataset.source;
            const amount = parseFloat(input.value) || 0;

            // Upsert
            const { error } = await supabaseClient
                .from('ad_expenses')
                .upsert({
                    date,
                    source,
                    amount,
                    updated_at: new Date().toISOString()
                }, { onConflict: 'date,source' });

            if (error) {
                console.error('Error saving ad expense:', error);
                input.classList.add('border-red-500');
                setTimeout(() => input.classList.remove('border-red-500'), 1000);
            } else {
                input.classList.add('border-emerald-500');
                setTimeout(() => input.classList.remove('border-emerald-500'), 500);

                // Update local data and stats
                const idx = adsData.findIndex(r => r.date === date && r.source === source);
                if (idx >= 0) {
                    adsData[idx].amount = amount;
                } else {
                    adsData.push({ date, source, amount });
                }
                renderAdsStats();
                updateAdsChart();
                updateGridTotals();
            }
        }

        function handleAdInputKey(e, input) {
            if (e.key === 'Enter' || e.key === 'Tab') {
                // Move to next input
                const inputs = Array.from(document.querySelectorAll('#ads-grid input[type="number"]'));
                const idx = inputs.indexOf(input);
                if (idx >= 0 && idx < inputs.length - 1) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        inputs[idx + 1].focus();
                        inputs[idx + 1].select();
                    }
                }
            }
        }

        function updateGridTotals() {
            const inputs = document.querySelectorAll('#ads-grid input[type="number"]');
            let totals = { google: 0, meta: 0, tiktok: 0 };

            inputs.forEach(input => {
                const val = parseFloat(input.value) || 0;
                totals[input.dataset.source] += val;
            });

            document.getElementById('grid-total-google').textContent = formatMoney(totals.google);
            document.getElementById('grid-total-meta').textContent = formatMoney(totals.meta);
            document.getElementById('grid-total-tiktok').textContent = formatMoney(totals.tiktok);
            document.getElementById('grid-total-all').textContent = formatMoney(totals.google + totals.meta + totals.tiktok);
        }

        function renderAdsChart(year, month) {
            const ctx = document.getElementById('ads-chart');
            if (!ctx) return;

            const daysInMonth = new Date(year, month, 0).getDate();
            const labels = [];
            const datasets = {};

            // Init datasets
            for (const src of AD_SOURCES) {
                datasets[src] = [];
            }

            // Create lookup
            const dataMap = {};
            for (const row of adsData) {
                dataMap[`${row.date}_${row.source}`] = parseFloat(row.amount) || 0;
            }

            // Fill data
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                labels.push(day);
                for (const src of AD_SOURCES) {
                    datasets[src].push(dataMap[`${dateStr}_${src}`] || 0);
                }
            }

            // Destroy existing chart
            if (adsChart) {
                adsChart.destroy();
            }

            adsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'Google',
                            data: datasets.google,
                            backgroundColor: AD_COLORS.google.bg,
                            borderColor: AD_COLORS.google.border,
                            borderWidth: 1,
                            hidden: !document.getElementById('toggle-google').checked
                        },
                        {
                            label: 'Meta',
                            data: datasets.meta,
                            backgroundColor: AD_COLORS.meta.bg,
                            borderColor: AD_COLORS.meta.border,
                            borderWidth: 1,
                            hidden: !document.getElementById('toggle-meta').checked
                        },
                        {
                            label: 'TikTok',
                            data: datasets.tiktok,
                            backgroundColor: AD_COLORS.tiktok.bg,
                            borderColor: AD_COLORS.tiktok.border,
                            borderWidth: 1,
                            hidden: !document.getElementById('toggle-tiktok').checked
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: '#71717a' }
                        },
                        y: {
                            stacked: true,
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: '#71717a' }
                        }
                    }
                }
            });
        }

        function updateAdsChart() {
            if (!adsChart) return;
            adsChart.data.datasets[0].hidden = !document.getElementById('toggle-google').checked;
            adsChart.data.datasets[1].hidden = !document.getElementById('toggle-meta').checked;
            adsChart.data.datasets[2].hidden = !document.getElementById('toggle-tiktok').checked;
            adsChart.update();
        }

        // ============================================
        // LEASING
        // ============================================
        const LEASING_LIMITS = { combustion: 100000, phev: 150000, electric: 225000 };
        let leasingData = null;

        async function loadLeasingData() {
            const loadingEl = document.getElementById('leasing-loading');
            const contentEl = document.getElementById('leasing-content');
            const emptyEl = document.getElementById('leasing-empty');

            loadingEl.classList.remove('hidden');
            contentEl.classList.add('hidden');
            emptyEl.classList.add('hidden');

            const { data: contract, error } = await supabaseClient
                .from('leasing_contracts')
                .select('*')
                .eq('is_active', true)
                .limit(1)
                .maybeSingle();

            loadingEl.classList.add('hidden');

            if (error || !contract) {
                emptyEl.classList.remove('hidden');
                return;
            }

            leasingData = contract;
            renderLeasingData();
            contentEl.classList.remove('hidden');
        }

        function renderLeasingData() {
            const c = leasingData;
            const schedule = c.payment_schedule || [];
            const limit = LEASING_LIMITS[c.vehicle_type] || 100000;
            const proportion = Math.min(1, limit / c.vehicle_value_netto);

            // Calculate averages
            const avgCapital = schedule.reduce((s, p) => s + p.capital, 0) / schedule.length;
            const avgInterest = schedule.reduce((s, p) => s + p.interest, 0) / schedule.length;
            const monthlyNetto = parseFloat(c.monthly_installment_netto);
            const monthlyBrutto = monthlyNetto * 1.23;
            const vatTotal = monthlyNetto * 0.23;
            const vatDeduction = vatTotal * 0.5; // 50% for mixed use

            const capitalDeduction = avgCapital * proportion;
            const interestDeduction = avgInterest;
            const totalTaxCost = capitalDeduction + interestDeduction;
            const pitSavings = totalTaxCost * 0.19;

            const realCost = monthlyBrutto - vatDeduction - pitSavings;
            const monthlySavings = vatDeduction + pitSavings;
            const totalPaid = monthlyBrutto * c.installments_count;
            const totalSavings = monthlySavings * c.installments_count;

            // Remaining installments
            const today = new Date();
            const remaining = schedule.filter(p => new Date(p.date) >= today).length;
            const paid = c.installments_count - remaining;
            const progressPct = Math.round((paid / c.installments_count) * 100);

            // Vehicle info
            document.getElementById('lease-vehicle-name').textContent = c.vehicle_name;
            document.getElementById('lease-vehicle-details').textContent =
                `${c.vehicle_type === 'combustion' ? 'Spalinowy' : c.vehicle_type === 'phev' ? 'Hybryda PHEV' : 'Elektryczny'} | ${c.usage_type === 'mixed' ? 'Uzytek mieszany' : 'Tylko firmowy'}`;
            document.getElementById('lease-contract-nr').textContent = c.contract_number;
            document.getElementById('lease-lessor').textContent = c.lessor_name;
            document.getElementById('lease-reg').textContent = c.registration_number || '-';
            document.getElementById('lease-period').textContent = `${formatDateShort(c.start_date)} - ${formatDateShort(c.end_date)}`;

            // Stats
            document.getElementById('lease-value').textContent = formatMoney(c.vehicle_value_netto);
            document.getElementById('lease-rate').textContent = formatMoney(monthlyBrutto);
            document.getElementById('lease-remaining').textContent = `${remaining} / ${c.installments_count}`;
            document.getElementById('lease-residual').textContent = formatMoney(c.residual_value);

            // Progress
            document.getElementById('lease-progress').textContent = progressPct;
            document.getElementById('lease-progress-bar').style.width = progressPct + '%';

            // Tax deductions
            document.getElementById('lease-proportion').textContent = (proportion * 100).toFixed(1) + '%';
            document.getElementById('lease-vat').textContent = formatMoney(vatTotal);
            document.getElementById('lease-vat-deduct').textContent = '- ' + formatMoney(vatDeduction);
            document.getElementById('lease-capital-cost').textContent = formatMoney(capitalDeduction);
            document.getElementById('lease-interest-cost').textContent = formatMoney(interestDeduction);
            document.getElementById('lease-tax-cost').textContent = formatMoney(totalTaxCost);
            document.getElementById('lease-pit-save').textContent = formatMoney(pitSavings);

            // Real cost
            document.getElementById('lease-pay').textContent = formatMoney(monthlyBrutto);
            document.getElementById('lease-real-vat').textContent = '- ' + formatMoney(vatDeduction);
            document.getElementById('lease-real-pit').textContent = '- ' + formatMoney(pitSavings);
            document.getElementById('lease-real-cost').textContent = formatMoney(realCost);
            document.getElementById('lease-savings').textContent = formatMoney(monthlySavings);
            document.getElementById('lease-total-paid').textContent = formatMoney(totalPaid);
            document.getElementById('lease-total-savings').textContent = formatMoney(totalSavings);

            // Summary totals (caly leasing)
            const sumTotal = schedule.reduce((s, p) => s + p.total, 0);
            const sumCapital = schedule.reduce((s, p) => s + p.capital, 0);
            const sumInterest = schedule.reduce((s, p) => s + p.interest, 0);
            const interestPitSave = sumInterest * 0.19; // 100% odsetek do kosztow, 19% PIT

            document.getElementById('lease-sum-total').textContent = formatMoney(sumTotal);
            document.getElementById('lease-sum-capital').textContent = formatMoney(sumCapital);
            document.getElementById('lease-sum-interest').textContent = formatMoney(sumInterest);
            document.getElementById('lease-interest-pit-save').textContent = formatMoney(interestPitSave);

            // Schedule
            document.getElementById('lease-schedule').innerHTML = schedule.map(p => {
                const isPaid = new Date(p.date) < today;
                const isUpcoming = !isPaid && new Date(p.date) < new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
                return `
                    <tr class="border-b border-white/5 hover:bg-white/[0.02]">
                        <td class="py-2.5 px-4 font-mono text-zinc-500">${p.nr}</td>
                        <td class="py-2.5 px-4">${formatDateShort(p.date)}</td>
                        <td class="py-2.5 px-4 text-right font-mono">${formatMoney(p.total)}</td>
                        <td class="py-2.5 px-4 text-right font-mono text-emerald-400">${formatMoney(p.capital)}</td>
                        <td class="py-2.5 px-4 text-right font-mono text-amber-400">${formatMoney(p.interest)}</td>
                        <td class="py-2.5 px-4 text-center">
                            ${isPaid ? '<span class="px-2 py-0.5 rounded-full text-xs bg-blue-500/15 text-blue-400">Zaplacona</span>' :
                              isUpcoming ? '<span class="px-2 py-0.5 rounded-full text-xs bg-amber-500/15 text-amber-400">Wkrotce</span>' : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function formatDateShort(dateStr) {
            const d = new Date(dateStr);
            return d.toLocaleDateString('pl-PL', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        // ============================================
        // INIT
        // ============================================
        async function init() {
            const session = await checkAuth();
            if (!session) return;

            // Check if user has access to TN Biznes
            if (!Sidebar.canAccessApp('biznes', session.user.email)) {
                window.location.href = '/dashboard';
                return;
            }

            Sidebar.render({ appId: 'biznes' });
            Sidebar.setUserEmail(session.user.email.split('@')[0]);
            Sidebar.setupLogout(supabaseClient);
            Sidebar.setupProfileClick();

            const { data: profile } = await supabaseClient
                .from('team_members')
                .select('full_name, avatar_color')
                .eq('user_id', session.user.id)
                .single();

            if (profile) {
                Sidebar.setUserName(profile.full_name);
                Sidebar.setUserColor(profile.avatar_color);
            }

            populateMonthFilter();
            await loadRecurringCosts();
        }

        init();
    </script>
</body>
</html>
