<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TN Biznes - Pracownicy</title>
    <link rel="icon" type="image/svg+xml" href="/tn-biznes/favicon.svg">
    <meta name="theme-color" content="#000000">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="../components/shared-sidebar.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    }
                }
            }
        }
    </script>
    <style>
        body { background: #000; color: #e5e5e5; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::selection { background: #14b8a6; color: black; }

        .glass-header {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-enter { animation: fadeIn 0.4s ease-out forwards; }

        .input-field {
            background: #0a0a0a;
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.2s;
        }
        .input-field:focus {
            border-color: rgba(20, 184, 166, 0.5);
            outline: none;
            box-shadow: 0 0 0 2px rgba(20, 184, 166, 0.1);
        }

        .modal-overlay {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
        }
        .modal-content {
            background: #0a0a0a;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .badge {
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 10px;
            font-weight: 500;
        }
        .badge-b2b { background: rgba(139, 92, 246, 0.15); color: #a78bfa; }
        .badge-uop { background: rgba(16, 185, 129, 0.15); color: #34d399; }

        .employee-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.03) 0%, rgba(255,255,255,0.01) 100%);
            border: 1px solid rgba(255,255,255,0.06);
            transition: all 0.2s;
        }
        .employee-card:hover {
            border-color: rgba(255,255,255,0.12);
        }

        .tier-row { transition: all 0.15s ease; }
        .tier-row:hover { background: rgba(255,255,255,0.03); }

        .progress-bar {
            background: linear-gradient(90deg, #10b981 0%, #34d399 100%);
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
    </style>
</head>
<body class="h-screen flex overflow-hidden font-sans text-sm tracking-tight antialiased">

    <!-- Sidebar -->
    <aside id="sidebar" class="w-[280px] bg-zinc-950 border-r border-white/5 flex flex-col flex-shrink-0"></aside>

    <!-- Main -->
    <main class="flex-1 flex flex-col bg-black relative min-w-0">
        <!-- Header -->
        <header class="h-16 glass-header flex items-center justify-between px-4 md:px-6 sticky top-0 z-30">
            <div class="flex items-center gap-3">
                <button onclick="Sidebar.toggle()" class="mobile-menu-btn hidden items-center justify-center w-9 h-9 rounded-lg hover:bg-white/5 text-zinc-400 hover:text-white transition-colors">
                    <i class="ph ph-list text-xl"></i>
                </button>
                <div class="flex items-center gap-2 text-zinc-500">
                    <span class="text-zinc-400 hidden sm:inline">tn-biznes</span>
                    <span class="text-zinc-700 hidden sm:inline">/</span>
                    <span class="text-white font-medium">pracownicy</span>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <select id="filter-month" class="input-field rounded-lg px-3 py-2 text-sm text-white" onchange="loadEmployeeData()">
                </select>
            </div>
        </header>

        <!-- Content -->
        <div class="flex-1 overflow-y-auto">
            <div class="p-4 md:p-6 lg:p-10 max-w-5xl mx-auto animate-enter">

                <!-- Stats -->
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 md:gap-4 mb-6">
                    <div class="bg-zinc-950/50 border border-white/5 rounded-xl p-4">
                        <div class="text-2xl font-semibold text-white font-mono" id="stat-employees">0</div>
                        <div class="text-xs text-zinc-500">Pracownikow</div>
                    </div>
                    <div class="bg-zinc-950/50 border border-white/5 rounded-xl p-4">
                        <div class="text-2xl font-semibold text-emerald-400 font-mono" id="stat-sales">0 zl</div>
                        <div class="text-xs text-zinc-500">Sprzedaz netto</div>
                    </div>
                    <div class="bg-zinc-950/50 border border-white/5 rounded-xl p-4">
                        <div class="text-2xl font-semibold text-violet-400 font-mono" id="stat-commission">0 zl</div>
                        <div class="text-xs text-zinc-500">Prowizje</div>
                    </div>
                    <div class="bg-zinc-950/50 border border-white/5 rounded-xl p-4">
                        <div class="text-2xl font-semibold text-amber-400 font-mono" id="stat-total-cost">0 zl</div>
                        <div class="text-xs text-zinc-500">Laczny koszt</div>
                    </div>
                </div>

                <!-- Employees List -->
                <div id="employees-list" class="space-y-4">
                    <div class="text-center py-12 text-zinc-600">
                        <i class="ph ph-circle-notch animate-spin text-2xl"></i>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <!-- Contract Modal -->
    <div id="contract-modal" class="fixed inset-0 modal-overlay z-50 hidden items-center justify-center p-4">
        <div class="modal-content rounded-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 id="modal-title" class="text-lg font-semibold text-white">Edytuj umowe</h3>
                    <button onclick="closeContractModal()" class="text-zinc-500 hover:text-white transition-colors">
                        <i class="ph ph-x text-xl"></i>
                    </button>
                </div>

                <form id="contract-form" onsubmit="saveContract(event)">
                    <input type="hidden" id="contract-id">
                    <input type="hidden" id="contract-team-member-id">

                    <!-- Contract Type -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-zinc-400 mb-2">Typ umowy</label>
                        <div class="flex gap-4">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="contract-type" value="B2B" checked class="text-teal-500 focus:ring-teal-500">
                                <span class="text-white">B2B</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="contract-type" value="UoP" class="text-teal-500 focus:ring-teal-500">
                                <span class="text-white">UoP</span>
                            </label>
                        </div>
                    </div>

                    <!-- Base Salary -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-zinc-400 mb-2">Podstawa miesieczna (zl)</label>
                        <input type="number" id="contract-base-salary" required step="0.01" min="0" class="input-field w-full rounded-lg px-3 py-2.5 text-white" placeholder="10000">
                    </div>

                    <!-- Commission Tiers -->
                    <div class="mb-4">
                        <div class="flex items-center justify-between mb-2">
                            <label class="block text-sm font-medium text-zinc-400">Progi prowizji (kwoty NETTO)</label>
                            <button type="button" onclick="addTier()" class="text-xs text-teal-400 hover:text-teal-300">
                                <i class="ph ph-plus mr-1"></i>Dodaj prog
                            </button>
                        </div>
                        <div id="tiers-container" class="space-y-2">
                            <!-- Tiers will be rendered here -->
                        </div>
                        <p class="text-xs text-zinc-600 mt-2">Min/Max w zl, stawka w % (np. 9 = 9%)</p>
                    </div>

                    <!-- Shop Commission -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-zinc-400 mb-2">Prowizja od sklepow (%)</label>
                        <input type="number" id="contract-shop-rate" step="0.1" min="0" max="100" class="input-field w-full rounded-lg px-3 py-2.5 text-white" placeholder="2">
                    </div>

                    <!-- Monthly Bonus -->
                    <div class="mb-4 grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-zinc-400 mb-2">Bonus miesieczny - prog (zl netto)</label>
                            <input type="number" id="contract-monthly-threshold" step="1" min="0" class="input-field w-full rounded-lg px-3 py-2.5 text-white" placeholder="100000">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-zinc-400 mb-2">Bonus miesieczny - kwota (zl)</label>
                            <input type="number" id="contract-monthly-amount" step="1" min="0" class="input-field w-full rounded-lg px-3 py-2.5 text-white" placeholder="2000">
                        </div>
                    </div>

                    <!-- Quarterly Bonus -->
                    <div class="mb-4 grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-zinc-400 mb-2">Bonus kwartalny - prog (zl netto)</label>
                            <input type="number" id="contract-quarterly-threshold" step="1" min="0" class="input-field w-full rounded-lg px-3 py-2.5 text-white" placeholder="300000">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-zinc-400 mb-2">Bonus kwartalny - kwota (zl)</label>
                            <input type="number" id="contract-quarterly-amount" step="1" min="0" class="input-field w-full rounded-lg px-3 py-2.5 text-white" placeholder="3000">
                        </div>
                    </div>

                    <!-- Effective From -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-zinc-400 mb-2">Obowiazuje od</label>
                        <input type="date" id="contract-effective-from" required class="input-field w-full rounded-lg px-3 py-2.5 text-white">
                    </div>

                    <!-- Notes -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-zinc-400 mb-2">Notatki (opcjonalnie)</label>
                        <textarea id="contract-notes" rows="2" class="input-field w-full rounded-lg px-3 py-2.5 text-white resize-none" placeholder="Dodatkowe informacje..."></textarea>
                    </div>

                    <div class="flex gap-3">
                        <button type="button" onclick="closeContractModal()" class="flex-1 px-4 py-2.5 rounded-lg border border-white/10 text-zinc-400 hover:text-white hover:border-white/20 transition-colors">
                            Anuluj
                        </button>
                        <button type="submit" class="flex-1 px-4 py-2.5 rounded-lg bg-teal-500 text-black font-medium hover:bg-teal-400 transition-colors">
                            Zapisz
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Details Modal -->
    <div id="details-modal" class="fixed inset-0 modal-overlay z-50 hidden items-center justify-center p-4">
        <div class="modal-content rounded-xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-lg font-semibold text-white">Szczegoly rozliczenia</h3>
                    <button onclick="closeDetailsModal()" class="text-zinc-500 hover:text-white transition-colors">
                        <i class="ph ph-x text-xl"></i>
                    </button>
                </div>
                <div id="details-content">
                    <!-- Details will be rendered here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Bonus Modal -->
    <div id="bonus-modal" class="fixed inset-0 modal-overlay z-50 hidden items-center justify-center p-4">
        <div class="modal-content rounded-xl w-full max-w-md">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-lg font-semibold text-white">Dodaj bonus</h3>
                    <button onclick="closeBonusModal()" class="text-zinc-500 hover:text-white transition-colors">
                        <i class="ph ph-x text-xl"></i>
                    </button>
                </div>

                <form id="bonus-form" onsubmit="saveBonus(event)">
                    <input type="hidden" id="bonus-team-member-id">

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-zinc-400 mb-2">Nazwa bonusu</label>
                        <input type="text" id="bonus-name" required class="input-field w-full rounded-lg px-3 py-2.5 text-white" placeholder="np. Premia swiateczna">
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-zinc-400 mb-2">Kwota (zl)</label>
                        <input type="number" id="bonus-amount" required step="0.01" min="0" class="input-field w-full rounded-lg px-3 py-2.5 text-white" placeholder="1000">
                    </div>

                    <div class="mb-6">
                        <label class="block text-sm font-medium text-zinc-400 mb-2">Notatka (opcjonalnie)</label>
                        <textarea id="bonus-notes" rows="2" class="input-field w-full rounded-lg px-3 py-2.5 text-white resize-none" placeholder="Dodatkowe informacje..."></textarea>
                    </div>

                    <div class="flex gap-3">
                        <button type="button" onclick="closeBonusModal()" class="flex-1 px-4 py-2.5 rounded-lg border border-white/10 text-zinc-400 hover:text-white hover:border-white/20 transition-colors">
                            Anuluj
                        </button>
                        <button type="submit" class="flex-1 px-4 py-2.5 rounded-lg bg-teal-500 text-black font-medium hover:bg-teal-400 transition-colors">
                            Dodaj
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // SUPABASE CONFIG
        // ============================================
        const SUPABASE_URL = 'https://yxmavwkwnfuphjqbelws.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl4bWF2d2t3bmZ1cGhqcWJlbHdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NjQyNTUsImV4cCI6MjA4NDM0MDI1NX0.XeR0Fc7OFn6YbNJrOKTBEj36JtmLISZTM87y4ai9340';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ============================================
        // STATE
        // ============================================
        let contracts = [];
        let teamMembers = [];
        let employeeData = []; // Combined contracts + calculated costs
        let editingTiers = [];
        let bonuses = []; // Manual bonuses for current month

        // Default tiers (used when creating new contract)
        const DEFAULT_TIERS = [
            { min: 0, max: 30000, rate: 0 },
            { min: 30000, max: 50000, rate: 0.09 },
            { min: 50000, max: 70000, rate: 0.10 },
            { min: 70000, max: 100000, rate: 0.12 },
            { min: 100000, max: 150000, rate: 0.14 }
        ];

        // ============================================
        // AUTH
        // ============================================
        async function checkAuth() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
                window.location.href = Sidebar.getLoginPath();
                return null;
            }
            return session;
        }

        // ============================================
        // HELPERS
        // ============================================
        function formatMoney(amount) {
            return new Intl.NumberFormat('pl-PL', { minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(Math.round(amount)) + ' zl';
        }

        function toNetto(brutto) {
            return brutto / 1.23;
        }

        function getCurrentMonth() {
            const d = new Date();
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
        }

        function populateMonthFilter() {
            const select = document.getElementById('filter-month');
            const months = [];
            const now = new Date();

            for (let i = -6; i <= 1; i++) {
                const d = new Date(now.getFullYear(), now.getMonth() + i, 1);
                const value = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                const label = d.toLocaleDateString('pl-PL', { month: 'long', year: 'numeric' });
                months.push({ value, label });
            }

            select.innerHTML = months.map(m => {
                const selected = m.value === getCurrentMonth() ? 'selected' : '';
                return `<option value="${m.value}" ${selected}>${m.label}</option>`;
            }).join('');
        }

        function getMonthRange(monthStr) {
            const [year, month] = monthStr.split('-').map(Number);
            const start = new Date(year, month - 1, 1);
            const end = new Date(year, month, 0, 23, 59, 59);
            return { start, end };
        }

        // ============================================
        // COMMISSION CALCULATION
        // ============================================
        function calcCommission(sales, tiers) {
            let commission = 0;
            const sortedTiers = [...tiers].sort((a, b) => a.min - b.min);

            for (const tier of sortedTiers) {
                if (sales > tier.min) {
                    const amt = Math.min(sales, tier.max) - tier.min;
                    commission += amt * tier.rate;
                }
            }

            // Handle sales above max tier
            if (sortedTiers.length > 0) {
                const maxTier = sortedTiers[sortedTiers.length - 1];
                if (sales > maxTier.max) {
                    commission += (sales - maxTier.max) * maxTier.rate;
                }
            }

            return commission;
        }

        function calcMonthlyBonus(sales, threshold, amount) {
            if (!threshold || !amount) return 0;
            return sales >= threshold ? amount : 0;
        }

        // ============================================
        // DATA LOADING
        // ============================================
        async function loadContracts() {
            const { data, error } = await supabaseClient
                .from('employee_contracts')
                .select('*, team_members!inner(id, name, color)')
                .is('effective_to', null) // Only active contracts
                .order('created_at');

            if (!error) {
                contracts = data || [];
            }
        }

        async function loadBonuses(monthStr) {
            const monthDate = monthStr + '-01'; // Convert to first day of month
            const { data, error } = await supabaseClient
                .from('employee_bonuses')
                .select('*')
                .eq('month', monthDate)
                .order('created_at');

            if (!error) {
                bonuses = data || [];
            }
        }

        function getBonusesForMember(teamMemberId) {
            return bonuses.filter(b => b.team_member_id === teamMemberId);
        }

        function getTotalBonuses(teamMemberId) {
            return getBonusesForMember(teamMemberId).reduce((sum, b) => sum + parseFloat(b.amount), 0);
        }

        async function loadTeamMembers() {
            const { data, error } = await supabaseClient
                .from('team_members')
                .select('id, name, color')
                .order('name');

            if (!error) {
                teamMembers = data || [];
            }
        }

        async function getEmployeeSales(teamMemberId, monthStart, monthEnd) {
            // Get paid orders in date range
            const { data: orders } = await supabaseClient
                .from('orders')
                .select('id, amount, lead_id, paid_at, customer_email')
                .eq('status', 'paid')
                .gte('paid_at', monthStart.toISOString())
                .lte('paid_at', monthEnd.toISOString());

            if (!orders || orders.length === 0) {
                return { totalSales: 0, orderCount: 0, orders: [] };
            }

            // Get leads to find assigned_to
            const leadIds = [...new Set(orders.filter(o => o.lead_id).map(o => o.lead_id))];
            let leadsMap = {};

            if (leadIds.length > 0) {
                const { data: leads } = await supabaseClient
                    .from('leads')
                    .select('id, assigned_to')
                    .in('id', leadIds);
                if (leads) leadsMap = Object.fromEntries(leads.map(l => [l.id, l.assigned_to]));
            }

            // For orders without lead_id, try to find lead by email
            const ordersWithoutLead = orders.filter(o => !o.lead_id && o.customer_email);
            if (ordersWithoutLead.length > 0) {
                const emails = [...new Set(ordersWithoutLead.map(o => o.customer_email))];
                const { data: leadsByEmail } = await supabaseClient
                    .from('leads')
                    .select('id, email, assigned_to')
                    .in('email', emails);

                if (leadsByEmail) {
                    const emailToLead = Object.fromEntries(leadsByEmail.map(l => [l.email, l]));
                    for (const order of ordersWithoutLead) {
                        const lead = emailToLead[order.customer_email];
                        if (lead) {
                            leadsMap[order.id] = lead.assigned_to; // Use order.id as key for email-matched leads
                        }
                    }
                }
            }

            // Sum orders for this team member
            let totalSales = 0;
            let orderCount = 0;
            const matchedOrders = [];

            for (const order of orders) {
                const assignedTo = order.lead_id ? leadsMap[order.lead_id] : leadsMap[order.id];
                if (assignedTo === teamMemberId) {
                    const nettoAmount = toNetto(parseFloat(order.amount));
                    totalSales += nettoAmount;
                    orderCount++;
                    matchedOrders.push({ ...order, netto: nettoAmount });
                }
            }

            return { totalSales, orderCount, orders: matchedOrders };
        }

        async function loadEmployeeData() {
            const month = document.getElementById('filter-month').value;
            const { start, end } = getMonthRange(month);

            // Load bonuses for this month
            await loadBonuses(month);

            employeeData = [];

            for (const contract of contracts) {
                const { totalSales, orderCount, orders } = await getEmployeeSales(
                    contract.team_member_id,
                    start,
                    end
                );

                const tiers = contract.commission_tiers || [];
                const commission = calcCommission(totalSales, tiers);
                const monthlyBonus = calcMonthlyBonus(
                    totalSales,
                    contract.monthly_bonus_threshold,
                    contract.monthly_bonus_amount
                );

                // TODO: Quarterly bonus calculation (would need to check Q boundary)
                const quarterlyBonus = 0;

                // Get manual bonuses for this employee
                const manualBonuses = getBonusesForMember(contract.team_member_id);
                const manualBonusTotal = getTotalBonuses(contract.team_member_id);

                const totalCost = parseFloat(contract.base_salary) + commission + monthlyBonus + quarterlyBonus + manualBonusTotal;

                employeeData.push({
                    contract,
                    member: contract.team_members,
                    totalSales,
                    orderCount,
                    orders,
                    commission,
                    monthlyBonus,
                    quarterlyBonus,
                    manualBonuses,
                    manualBonusTotal,
                    totalCost
                });
            }

            renderEmployees();
            updateStats();
        }

        // ============================================
        // RENDERING
        // ============================================
        function renderEmployees() {
            const container = document.getElementById('employees-list');

            if (employeeData.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i class="ph ph-users text-4xl text-zinc-700 mb-3"></i>
                        <p class="text-zinc-500">Brak pracownikow z aktywnymi umowami</p>
                        <p class="text-zinc-600 text-xs mt-1">Dodaj umowe w tabeli employee_contracts</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = employeeData.map(emp => {
                const initials = emp.member.name.split(' ').map(n => n[0]).join('').substring(0, 2);
                const color = emp.member.color || '#52525b';
                const typeBadge = emp.contract.contract_type === 'B2B' ? 'badge-b2b' : 'badge-uop';

                // Progress bar (max 150k for visual)
                const progressPct = Math.min((emp.totalSales / 150000) * 100, 100);

                return `
                    <div class="employee-card rounded-xl overflow-hidden">
                        <!-- Header -->
                        <div class="p-5 flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 rounded-full flex items-center justify-center text-sm font-semibold text-white" style="background:${color}">
                                    ${initials}
                                </div>
                                <div>
                                    <div class="text-white font-medium">${emp.member.name}</div>
                                    <div class="flex items-center gap-2 mt-1">
                                        <span class="badge ${typeBadge}">${emp.contract.contract_type}</span>
                                        <span class="text-xs text-zinc-500">${emp.orderCount} zamowien</span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <button onclick="openBonusModal('${emp.contract.team_member_id}')" class="p-2 text-zinc-500 hover:text-teal-400 transition-colors" title="Dodaj bonus">
                                    <i class="ph ph-gift"></i>
                                </button>
                                <button onclick="showDetails('${emp.contract.id}')" class="p-2 text-zinc-500 hover:text-white transition-colors" title="Szczegoly">
                                    <i class="ph ph-list-magnifying-glass"></i>
                                </button>
                                <button onclick="editContract('${emp.contract.id}')" class="p-2 text-zinc-500 hover:text-white transition-colors" title="Edytuj umowe">
                                    <i class="ph ph-pencil"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Progress -->
                        <div class="px-5 pb-3">
                            <div class="relative h-2 rounded-full bg-zinc-800/80">
                                <div class="progress-bar h-full rounded-full" style="width:${progressPct}%"></div>
                                <div class="absolute top-0 bottom-0 left-[20%] w-px bg-zinc-600/60"></div>
                                <div class="absolute top-0 bottom-0 left-[33.33%] w-px bg-zinc-700/40"></div>
                                <div class="absolute top-0 bottom-0 left-[46.67%] w-px bg-zinc-700/40"></div>
                                <div class="absolute top-0 bottom-0 left-[66.67%] w-px bg-emerald-500/40"></div>
                            </div>
                            <div class="flex justify-between mt-1.5 text-[10px] font-mono relative">
                                <span class="text-zinc-600">0</span>
                                <span class="text-zinc-500 absolute left-[20%] -translate-x-1/2">30k</span>
                                <span class="text-zinc-600 absolute left-[33.33%] -translate-x-1/2">50k</span>
                                <span class="text-zinc-600 absolute left-[46.67%] -translate-x-1/2">70k</span>
                                <span class="text-emerald-500/80 absolute left-[66.67%] -translate-x-1/2">100k</span>
                                <span class="text-zinc-600">150k</span>
                            </div>
                        </div>

                        <!-- Stats -->
                        <div class="px-5 pb-5 grid grid-cols-4 gap-3">
                            <div>
                                <div class="text-xs text-zinc-500 mb-1">Sprzedaz netto</div>
                                <div class="text-lg font-mono text-white">${formatMoney(emp.totalSales)}</div>
                            </div>
                            <div>
                                <div class="text-xs text-zinc-500 mb-1">Podstawa</div>
                                <div class="text-lg font-mono text-zinc-400">${formatMoney(emp.contract.base_salary)}</div>
                            </div>
                            <div>
                                <div class="text-xs text-zinc-500 mb-1">Prowizja</div>
                                <div class="text-lg font-mono text-violet-400">${formatMoney(emp.commission)}</div>
                            </div>
                            <div>
                                <div class="text-xs text-zinc-500 mb-1">Koszt calkowity</div>
                                <div class="text-lg font-mono text-amber-400">${formatMoney(emp.totalCost)}</div>
                            </div>
                        </div>

                        ${emp.monthlyBonus > 0 ? `
                            <div class="px-5 pb-3">
                                <div class="bg-emerald-500/10 border border-emerald-500/20 rounded-lg px-3 py-2 flex items-center gap-2">
                                    <i class="ph ph-trophy text-emerald-400"></i>
                                    <span class="text-emerald-400 text-sm">Bonus miesieczny: +${formatMoney(emp.monthlyBonus)}</span>
                                </div>
                            </div>
                        ` : ''}

                        ${emp.manualBonuses && emp.manualBonuses.length > 0 ? `
                            <div class="px-5 pb-5 space-y-2">
                                ${emp.manualBonuses.map(b => `
                                    <div class="bg-amber-500/10 border border-amber-500/20 rounded-lg px-3 py-2 flex items-center justify-between group">
                                        <div class="flex items-center gap-2">
                                            <i class="ph ph-gift text-amber-400"></i>
                                            <span class="text-amber-400 text-sm">${b.name}: +${formatMoney(b.amount)}</span>
                                        </div>
                                        <button onclick="deleteBonus('${b.id}')" class="p-1 text-zinc-600 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-all" title="Usun bonus">
                                            <i class="ph ph-trash text-sm"></i>
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function updateStats() {
            const totalEmployees = employeeData.length;
            const totalSales = employeeData.reduce((s, e) => s + e.totalSales, 0);
            const totalCommission = employeeData.reduce((s, e) => s + e.commission + e.monthlyBonus + e.quarterlyBonus, 0);
            const totalCost = employeeData.reduce((s, e) => s + e.totalCost, 0);

            document.getElementById('stat-employees').textContent = totalEmployees;
            document.getElementById('stat-sales').textContent = formatMoney(totalSales);
            document.getElementById('stat-commission').textContent = formatMoney(totalCommission);
            document.getElementById('stat-total-cost').textContent = formatMoney(totalCost);
        }

        // ============================================
        // CONTRACT MODAL
        // ============================================
        function editContract(contractId) {
            const emp = employeeData.find(e => e.contract.id === contractId);
            if (!emp) return;

            const contract = emp.contract;

            document.getElementById('contract-id').value = contract.id;
            document.getElementById('contract-team-member-id').value = contract.team_member_id;
            document.querySelector(`input[name="contract-type"][value="${contract.contract_type}"]`).checked = true;
            document.getElementById('contract-base-salary').value = contract.base_salary;
            document.getElementById('contract-shop-rate').value = (contract.shop_commission_rate || 0) * 100;
            document.getElementById('contract-monthly-threshold').value = contract.monthly_bonus_threshold || '';
            document.getElementById('contract-monthly-amount').value = contract.monthly_bonus_amount || '';
            document.getElementById('contract-quarterly-threshold').value = contract.quarterly_bonus_threshold || '';
            document.getElementById('contract-quarterly-amount').value = contract.quarterly_bonus_amount || '';
            document.getElementById('contract-effective-from').value = contract.effective_from;
            document.getElementById('contract-notes').value = contract.notes || '';

            editingTiers = contract.commission_tiers || [...DEFAULT_TIERS];
            renderTiers();

            document.getElementById('modal-title').textContent = `Edytuj umowe: ${emp.member.name}`;
            openContractModal();
        }

        function openContractModal() {
            const modal = document.getElementById('contract-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeContractModal() {
            const modal = document.getElementById('contract-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        // ============================================
        // TIERS MANAGEMENT
        // ============================================
        function renderTiers() {
            const container = document.getElementById('tiers-container');
            container.innerHTML = editingTiers.map((tier, index) => `
                <div class="tier-row flex items-center gap-2 p-2 bg-zinc-900/50 rounded-lg">
                    <input type="number" value="${tier.min}" onchange="updateTier(${index}, 'min', this.value)" class="input-field w-24 rounded px-2 py-1.5 text-white text-sm" placeholder="Min">
                    <span class="text-zinc-500">-</span>
                    <input type="number" value="${tier.max}" onchange="updateTier(${index}, 'max', this.value)" class="input-field w-24 rounded px-2 py-1.5 text-white text-sm" placeholder="Max">
                    <span class="text-zinc-500">=</span>
                    <input type="number" value="${(tier.rate * 100).toFixed(1)}" onchange="updateTier(${index}, 'rate', this.value / 100)" step="0.1" class="input-field w-20 rounded px-2 py-1.5 text-white text-sm" placeholder="%">
                    <span class="text-zinc-500 text-xs">%</span>
                    <button type="button" onclick="removeTier(${index})" class="p-1 text-zinc-500 hover:text-red-400 transition-colors">
                        <i class="ph ph-trash"></i>
                    </button>
                </div>
            `).join('');
        }

        function addTier() {
            const lastTier = editingTiers[editingTiers.length - 1];
            const newMin = lastTier ? lastTier.max : 0;
            editingTiers.push({ min: newMin, max: newMin + 50000, rate: 0.15 });
            renderTiers();
        }

        function updateTier(index, field, value) {
            editingTiers[index][field] = parseFloat(value);
        }

        function removeTier(index) {
            editingTiers.splice(index, 1);
            renderTiers();
        }

        // ============================================
        // SAVE CONTRACT
        // ============================================
        async function saveContract(e) {
            e.preventDefault();

            const id = document.getElementById('contract-id').value;
            const teamMemberId = document.getElementById('contract-team-member-id').value;

            const contractData = {
                team_member_id: teamMemberId,
                contract_type: document.querySelector('input[name="contract-type"]:checked').value,
                base_salary: parseFloat(document.getElementById('contract-base-salary').value),
                commission_tiers: editingTiers,
                shop_commission_rate: parseFloat(document.getElementById('contract-shop-rate').value || 0) / 100,
                monthly_bonus_threshold: parseFloat(document.getElementById('contract-monthly-threshold').value) || null,
                monthly_bonus_amount: parseFloat(document.getElementById('contract-monthly-amount').value) || null,
                quarterly_bonus_threshold: parseFloat(document.getElementById('contract-quarterly-threshold').value) || null,
                quarterly_bonus_amount: parseFloat(document.getElementById('contract-quarterly-amount').value) || null,
                effective_from: document.getElementById('contract-effective-from').value,
                notes: document.getElementById('contract-notes').value || null
            };

            let result;
            if (id) {
                result = await supabaseClient.from('employee_contracts').update(contractData).eq('id', id);
            } else {
                result = await supabaseClient.from('employee_contracts').insert(contractData);
            }

            if (!result.error) {
                closeContractModal();
                await loadContracts();
                await loadEmployeeData();
            } else {
                alert('Blad: ' + result.error.message);
            }
        }

        // ============================================
        // DETAILS MODAL
        // ============================================
        function showDetails(contractId) {
            const emp = employeeData.find(e => e.contract.id === contractId);
            if (!emp) return;

            const content = document.getElementById('details-content');

            // Build breakdown
            let html = `
                <div class="space-y-4">
                    <div class="bg-zinc-900/50 rounded-lg p-4">
                        <div class="text-xs text-zinc-500 uppercase mb-2">Rozklad kosztow</div>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span class="text-zinc-400">Podstawa</span>
                                <span class="text-white font-mono">${formatMoney(emp.contract.base_salary)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-zinc-400">Prowizja od sprzedazy</span>
                                <span class="text-violet-400 font-mono">${formatMoney(emp.commission)}</span>
                            </div>
                            ${emp.monthlyBonus > 0 ? `
                                <div class="flex justify-between">
                                    <span class="text-zinc-400">Bonus miesieczny</span>
                                    <span class="text-emerald-400 font-mono">+${formatMoney(emp.monthlyBonus)}</span>
                                </div>
                            ` : ''}
                            ${emp.manualBonuses && emp.manualBonuses.length > 0 ? emp.manualBonuses.map(b => `
                                <div class="flex justify-between">
                                    <span class="text-zinc-400">${b.name}</span>
                                    <span class="text-amber-400 font-mono">+${formatMoney(b.amount)}</span>
                                </div>
                            `).join('') : ''}
                            <div class="border-t border-white/10 pt-2 flex justify-between">
                                <span class="text-white font-medium">Razem</span>
                                <span class="text-amber-400 font-mono font-medium">${formatMoney(emp.totalCost)}</span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-zinc-900/50 rounded-lg p-4">
                        <div class="text-xs text-zinc-500 uppercase mb-2">Progi prowizji</div>
                        <div class="space-y-1 text-sm">
            `;

            const tiers = emp.contract.commission_tiers || [];
            for (const tier of tiers) {
                const inRange = emp.totalSales > tier.min;
                const earned = inRange ? Math.min(emp.totalSales, tier.max) - tier.min : 0;
                const tierCommission = earned * tier.rate;

                html += `
                    <div class="flex justify-between py-1 ${inRange ? 'text-white' : 'text-zinc-600'}">
                        <span>${formatMoney(tier.min)} - ${formatMoney(tier.max)} @ ${(tier.rate * 100).toFixed(0)}%</span>
                        <span class="font-mono">${inRange ? formatMoney(tierCommission) : '-'}</span>
                    </div>
                `;
            }

            html += `
                        </div>
                    </div>

                    <div class="bg-zinc-900/50 rounded-lg p-4">
                        <div class="text-xs text-zinc-500 uppercase mb-2">Sprzedaz w miesiacu (${emp.orderCount} zamowien)</div>
                        <div class="text-2xl font-mono text-emerald-400">${formatMoney(emp.totalSales)}</div>
                        <div class="text-xs text-zinc-500 mt-1">netto</div>
                    </div>
                </div>
            `;

            content.innerHTML = html;

            const modal = document.getElementById('details-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeDetailsModal() {
            const modal = document.getElementById('details-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        // ============================================
        // BONUS MODAL
        // ============================================
        function openBonusModal(teamMemberId) {
            document.getElementById('bonus-team-member-id').value = teamMemberId;
            document.getElementById('bonus-name').value = '';
            document.getElementById('bonus-amount').value = '';
            document.getElementById('bonus-notes').value = '';

            const modal = document.getElementById('bonus-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.getElementById('bonus-name').focus();
        }

        function closeBonusModal() {
            const modal = document.getElementById('bonus-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        async function saveBonus(e) {
            e.preventDefault();

            const teamMemberId = document.getElementById('bonus-team-member-id').value;
            const month = document.getElementById('filter-month').value + '-01'; // First day of month

            const bonusData = {
                team_member_id: teamMemberId,
                month: month,
                name: document.getElementById('bonus-name').value,
                amount: parseFloat(document.getElementById('bonus-amount').value),
                notes: document.getElementById('bonus-notes').value || null
            };

            const { error } = await supabaseClient
                .from('employee_bonuses')
                .insert(bonusData);

            if (!error) {
                closeBonusModal();
                await loadEmployeeData();
            } else {
                alert('Blad: ' + error.message);
            }
        }

        async function deleteBonus(bonusId) {
            if (!confirm('Na pewno usunac ten bonus?')) return;

            const { error } = await supabaseClient
                .from('employee_bonuses')
                .delete()
                .eq('id', bonusId);

            if (!error) {
                await loadEmployeeData();
            } else {
                alert('Blad: ' + error.message);
            }
        }

        // ============================================
        // INIT
        // ============================================
        async function init() {
            const session = await checkAuth();
            if (!session) return;

            // Check if user has access to TN Biznes
            if (!Sidebar.canAccessApp('biznes', session.user.email)) {
                window.location.href = '/dashboard';
                return;
            }

            Sidebar.render({ appId: 'biznes' });
            Sidebar.setUserEmail(session.user.email.split('@')[0]);
            Sidebar.setupLogout(supabaseClient);
            Sidebar.setupProfileClick();

            const { data: profile } = await supabaseClient
                .from('team_members')
                .select('full_name, avatar_color')
                .eq('user_id', session.user.id)
                .single();

            if (profile) {
                Sidebar.setUserName(profile.full_name);
                Sidebar.setUserColor(profile.avatar_color);
            }

            populateMonthFilter();
            await loadTeamMembers();
            await loadContracts();
            await loadEmployeeData();
        }

        init();
    </script>
</body>
</html>
