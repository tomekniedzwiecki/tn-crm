<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TN CRM | Kampanie</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#050505">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="components/sidebar.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    }
                }
            }
        }
    </script>
    <style>
        body { background: #050505; color: #e5e5e5; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        ::selection { background: white; color: black; }

        .glass-header {
            background: rgba(5, 5, 5, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-enter { animation: fadeIn 0.4s ease-out forwards; }

        .tab-active {
            color: white;
            border-bottom: 2px solid white;
        }

        /* WhatsApp template cards */
        .wa-template-btn {
            transition: all 0.2s ease;
        }
        .wa-template-btn:hover {
            transform: translateY(-2px);
        }

        /* Table row hover effect */
        #wa-contacts-table tr:hover td {
            background: rgba(255,255,255,0.02);
        }

        /* Templates Side Panel */
        .templates-panel {
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        .templates-panel.open {
            transform: translateX(0);
        }
        .templates-panel-backdrop {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .templates-panel-backdrop.open {
            opacity: 1;
            pointer-events: auto;
        }

    </style>
</head>
<body class="h-screen flex overflow-hidden font-sans text-sm tracking-tight antialiased">

    <!-- Sidebar -->
    <aside id="sidebar" class="w-[280px] bg-zinc-950 border-r border-white/5 flex flex-col flex-shrink-0"></aside>

    <!-- Main -->
    <main class="flex-1 flex flex-col bg-black relative min-w-0">
        <!-- Header -->
        <header class="h-16 glass-header flex items-center justify-between px-4 md:px-6 sticky top-0 z-30">
            <div class="flex items-center gap-3">
                <button onclick="Sidebar.toggle()" class="mobile-menu-btn hidden items-center justify-center w-9 h-9 rounded-lg hover:bg-white/5 text-zinc-400 hover:text-white transition-colors">
                    <i class="ph ph-list text-xl"></i>
                </button>
                <div class="flex items-center gap-2 text-zinc-500">
                    <span class="text-zinc-400 hidden sm:inline">tn-crm</span>
                    <span class="text-zinc-700 hidden sm:inline">/</span>
                    <span class="text-white font-medium">kampanie</span>
                </div>
            </div>
            <div class="flex items-center gap-2 md:gap-4">
                <div class="relative hidden md:block" id="header-search-email">
                    <i class="ph ph-magnifying-glass absolute left-2.5 top-1.5 text-zinc-500"></i>
                    <input type="text" id="search-input" placeholder="Szukaj kontaktów..." class="bg-zinc-900 border border-zinc-800 text-zinc-300 text-xs rounded-full pl-8 pr-4 py-1.5 focus:border-zinc-600 focus:outline-none w-56 transition-all placeholder:text-zinc-600">
                </div>
                <div class="w-px h-4 bg-zinc-800 hidden md:block" id="header-divider-email"></div>
                <button onclick="openNewCampaignModal()" id="header-btn-email" class="bg-white text-black hover:bg-zinc-200 px-3 md:px-4 py-2 rounded-lg font-medium text-sm transition-colors shadow-[0_0_15px_rgba(255,255,255,0.1)]">
                    <i class="ph ph-plus md:mr-1"></i>
                    <span class="hidden md:inline">Nowa kampania</span>
                </button>
            </div>
        </header>

        <!-- Content -->
        <div class="flex-1 overflow-y-auto p-6 lg:p-10">
            <div class="max-w-7xl mx-auto animate-enter">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h1 class="text-3xl font-semibold text-white tracking-tight mb-1">Kampanie</h1>
                        <p class="text-zinc-500">Zarządzaj kontaktami i kampaniami outreach.</p>
                    </div>
                </div>

                <!-- Main Tabs -->
                <div class="flex gap-6 border-b border-white/10 mb-6">
                    <button onclick="switchTab('contacts')" id="tab-contacts" class="pb-3 px-1 text-sm font-medium tab-active transition-colors">
                        <i class="ph ph-address-book mr-1.5"></i>
                        Kontakty
                    </button>
                    <button onclick="switchTab('campaigns-email')" id="tab-campaigns-email" class="pb-3 px-1 text-sm font-medium text-zinc-500 hover:text-zinc-300 transition-colors border-b-2 border-transparent">
                        <i class="ph ph-envelope mr-1.5"></i>
                        Kampanie Email
                    </button>
                    <button onclick="switchTab('campaigns-whatsapp')" id="tab-campaigns-whatsapp" class="pb-3 px-1 text-sm font-medium text-zinc-500 hover:text-zinc-300 transition-colors border-b-2 border-transparent">
                        <i class="ph ph-whatsapp-logo mr-1.5"></i>
                        Kampanie WhatsApp
                    </button>
                </div>

                <!-- Tab: Contacts -->
                <div id="panel-contacts">
                    <!-- Filters -->
                    <div class="flex flex-wrap items-center gap-3 mb-4">
                        <select id="filter-source" class="bg-zinc-900 border border-zinc-800 text-zinc-300 text-xs rounded-lg px-3 py-2 focus:border-zinc-600 focus:outline-none">
                            <option value="">Wszystkie źródła</option>
                        </select>
                        <select id="filter-ltv" class="bg-zinc-900 border border-zinc-800 text-zinc-300 text-xs rounded-lg px-3 py-2 focus:border-zinc-600 focus:outline-none">
                            <option value="">Dowolne LTV</option>
                            <option value="1000">LTV > 1 000 PLN</option>
                            <option value="5000">LTV > 5 000 PLN</option>
                            <option value="10000">LTV > 10 000 PLN</option>
                            <option value="50000">LTV > 50 000 PLN</option>
                        </select>
                        <select id="filter-products" class="bg-zinc-900 border border-zinc-800 text-zinc-300 text-xs rounded-lg px-3 py-2 focus:border-zinc-600 focus:outline-none">
                            <option value="">Dowolna liczba produktów</option>
                            <option value="1">1+ produktów</option>
                            <option value="3">3+ produktów</option>
                            <option value="5">5+ produktów</option>
                        </select>
                        <div class="flex-1"></div>
                        <button onclick="openImportModal()" class="px-3 py-1.5 text-xs bg-zinc-900 border border-zinc-800 rounded-lg text-zinc-400 hover:text-white hover:border-zinc-700 transition-colors">
                            <i class="ph ph-upload-simple mr-1"></i> Import CSV
                        </button>
                        <button onclick="deleteSelectedContacts()" id="btn-delete-contacts" class="px-3 py-1.5 text-xs bg-red-500/10 border border-red-500/30 rounded-lg text-red-400 hover:bg-red-500/20 transition-colors hidden">
                            <i class="ph ph-trash mr-1"></i> Usuń zaznaczone
                        </button>
                        <span id="contacts-count" class="text-xs text-zinc-500 font-mono">Ładowanie...</span>
                    </div>

                    <!-- Contacts Table -->
                    <div class="bg-zinc-900/40 rounded-xl border border-white/5 overflow-hidden">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-white/5 text-left">
                                    <th class="px-4 py-3 w-10">
                                        <input type="checkbox" id="select-all-contacts" onchange="toggleAllContacts()" class="w-4 h-4 rounded border-zinc-700 bg-zinc-800 text-white focus:ring-0 focus:ring-offset-0 cursor-pointer">
                                    </th>
                                    <th class="px-4 py-3 text-[10px] uppercase tracking-wider text-zinc-500 font-semibold">Email</th>
                                    <th class="px-4 py-3 text-[10px] uppercase tracking-wider text-zinc-500 font-semibold">Telefon</th>
                                    <th class="px-4 py-3 text-[10px] uppercase tracking-wider text-zinc-500 font-semibold text-right">LTV</th>
                                    <th class="px-4 py-3 text-[10px] uppercase tracking-wider text-zinc-500 font-semibold text-center">Transakcje</th>
                                    <th class="px-4 py-3 text-[10px] uppercase tracking-wider text-zinc-500 font-semibold text-center">Produkty</th>
                                    <th class="px-4 py-3 text-[10px] uppercase tracking-wider text-zinc-500 font-semibold">Ostatni zakup</th>
                                    <th class="px-4 py-3 text-[10px] uppercase tracking-wider text-zinc-500 font-semibold">Źródło</th>
                                </tr>
                            </thead>
                            <tbody id="contacts-table">
                                <tr>
                                    <td colspan="7" class="px-4 py-12 text-center text-zinc-500">
                                        <i class="ph ph-circle-notch animate-spin text-2xl mb-2"></i>
                                        <p>Ładowanie kontaktów...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div class="flex items-center justify-between mt-4">
                        <button onclick="prevPage()" id="btn-prev" class="px-3 py-1.5 text-xs bg-zinc-900 border border-zinc-800 rounded-lg text-zinc-400 hover:text-white hover:border-zinc-700 transition-colors disabled:opacity-50" disabled>
                            <i class="ph ph-caret-left mr-1"></i> Poprzednia
                        </button>
                        <span id="pagination-info" class="text-xs text-zinc-500 font-mono">Strona 1</span>
                        <button onclick="nextPage()" id="btn-next" class="px-3 py-1.5 text-xs bg-zinc-900 border border-zinc-800 rounded-lg text-zinc-400 hover:text-white hover:border-zinc-700 transition-colors disabled:opacity-50">
                            Następna <i class="ph ph-caret-right ml-1"></i>
                        </button>
                    </div>
                </div>

                <!-- Tab: Campaigns Email -->
                <div id="panel-campaigns-email" class="hidden">
                        <!-- Stats -->
                        <div class="grid grid-cols-4 gap-4 mb-6">
                            <div class="bg-zinc-900/40 rounded-lg p-4 border border-white/5">
                                <div class="text-[10px] uppercase tracking-wider text-zinc-500 font-mono mb-1">Aktywne</div>
                                <div id="stat-active" class="text-2xl font-semibold text-emerald-400">0</div>
                            </div>
                            <div class="bg-zinc-900/40 rounded-lg p-4 border border-white/5">
                                <div class="text-[10px] uppercase tracking-wider text-zinc-500 font-mono mb-1">Wysłanych</div>
                                <div id="stat-sent" class="text-2xl font-semibold text-white">0</div>
                            </div>
                            <div class="bg-zinc-900/40 rounded-lg p-4 border border-white/5">
                                <div class="text-[10px] uppercase tracking-wider text-zinc-500 font-mono mb-1">Follow-upy</div>
                                <div id="stat-followups" class="text-2xl font-semibold text-white">0</div>
                            </div>
                            <div class="bg-zinc-900/40 rounded-lg p-4 border border-white/5">
                                <div class="text-[10px] uppercase tracking-wider text-zinc-500 font-mono mb-1">Odpowiedzi</div>
                                <div id="stat-replies" class="text-2xl font-semibold text-violet-400">0</div>
                            </div>
                        </div>

                    <!-- Campaigns List -->
                    <div id="campaigns-list" class="space-y-3">
                        <div class="text-center py-12 text-zinc-500">
                            <i class="ph ph-circle-notch animate-spin text-2xl mb-2"></i>
                            <p>Ładowanie kampanii...</p>
                        </div>
                    </div>
                </div>

                <!-- Tab: Campaigns WhatsApp -->
                <div id="panel-campaigns-whatsapp" class="hidden">
                    <!-- Saved Filters + Main Filters -->
                    <div class="bg-zinc-900/40 rounded-xl border border-white/5 p-4 mb-4">
                        <!-- Row 1: Saved Filters -->
                        <div class="flex flex-wrap items-center gap-3 mb-4 pb-4 border-b border-zinc-800">
                            <div class="flex items-center gap-2 text-zinc-500">
                                <i class="ph ph-bookmark-simple text-sm"></i>
                                <span class="text-[10px] uppercase tracking-wider font-medium">Zapisane:</span>
                            </div>
                            <div id="wa-saved-filters" class="flex flex-wrap gap-2 flex-1">
                                <!-- Saved filters will be rendered here -->
                                <span class="text-xs text-zinc-600 italic">Brak zapisanych filtrów</span>
                            </div>
                            <div class="flex items-center gap-2 ml-auto">
                                <button onclick="openSaveFilterModal()" id="wa-btn-save-filter" class="hidden px-3 py-1.5 text-xs bg-emerald-500/20 hover:bg-emerald-500/30 text-emerald-400 rounded-lg transition-colors border border-emerald-500/20 font-medium">
                                    <i class="ph ph-floppy-disk mr-1.5"></i>
                                    Zapisz filtr
                                </button>
                                <button onclick="resetWaFilters()" id="wa-reset-filters" class="hidden px-3 py-1.5 text-xs bg-zinc-700/80 hover:bg-zinc-600 text-zinc-300 rounded-lg transition-colors border border-zinc-600">
                                    <i class="ph ph-arrow-counter-clockwise mr-1.5"></i>
                                    Reset
                                </button>
                            </div>
                        </div>

                        <!-- Row 2: Search -->
                        <div class="flex items-center gap-3 mb-3">
                            <div class="relative flex-1 max-w-xs">
                                <i class="ph ph-magnifying-glass absolute left-3 top-2.5 text-zinc-500"></i>
                                <input type="text" id="wa-search" placeholder="Szukaj email, telefon..." class="bg-zinc-800 border border-zinc-700 w-full rounded-lg pl-9 pr-4 py-2 text-sm text-white placeholder:text-zinc-600 focus:border-zinc-500 focus:outline-none">
                            </div>
                            <div class="relative flex-1 max-w-xs">
                                <i class="ph ph-package absolute left-3 top-2.5 text-zinc-500"></i>
                                <input type="text" id="wa-filter-product" placeholder="Szukaj produkt..." class="bg-zinc-800 border border-zinc-700 w-full rounded-lg pl-9 pr-4 py-2 text-sm text-white placeholder:text-zinc-600 focus:border-zinc-500 focus:outline-none">
                            </div>
                        </div>

                        <!-- Row 3: Filters -->
                        <div class="flex flex-wrap items-center gap-3">
                            <!-- LTV Filter -->
                            <div class="flex items-center gap-1.5 bg-zinc-800/50 rounded-lg px-3 py-1.5">
                                <span class="text-[10px] text-zinc-500 uppercase tracking-wider">LTV:</span>
                                <input type="number" id="wa-filter-ltv-min" placeholder="od" class="bg-transparent border-none text-zinc-300 text-xs focus:outline-none w-16 text-center" min="0">
                                <span class="text-zinc-600">-</span>
                                <input type="number" id="wa-filter-ltv-max" placeholder="do" class="bg-transparent border-none text-zinc-300 text-xs focus:outline-none w-16 text-center" min="0">
                                <span class="text-[10px] text-zinc-500">zł</span>
                            </div>

                            <!-- Last Purchase Filter -->
                            <select id="wa-filter-recency" class="bg-zinc-800 border border-zinc-700 text-zinc-300 text-xs rounded-lg px-3 py-2 focus:border-zinc-500 focus:outline-none cursor-pointer">
                                <option value="">Zakup: kiedykolwiek</option>
                                <option value="30">Ostatnie 30 dni</option>
                                <option value="60">Ostatnie 60 dni</option>
                                <option value="90">Ostatnie 90 dni</option>
                                <option value="180">Ostatnie 180 dni</option>
                                <option value="old-90">> 90 dni temu</option>
                                <option value="old-180">> 180 dni temu</option>
                            </select>

                            <!-- Products Filter -->
                            <select id="wa-filter-products" class="bg-zinc-800 border border-zinc-700 text-zinc-300 text-xs rounded-lg px-3 py-2 focus:border-zinc-500 focus:outline-none cursor-pointer">
                                <option value="">Produkty: wszystkie</option>
                                <option value="1">1+ produktów</option>
                                <option value="2">2+ produktów</option>
                                <option value="3">3+ produktów</option>
                                <option value="5">5+ produktów</option>
                            </select>

                            <!-- WhatsApp Status -->
                            <select id="wa-filter-whatsapp" class="bg-zinc-800 border border-zinc-700 text-zinc-300 text-xs rounded-lg px-3 py-2 focus:border-zinc-500 focus:outline-none cursor-pointer">
                                <option value="">Status: wszystkie</option>
                                <option value="pending">Do kontaktu</option>
                                <option value="contacted">Skontaktowano</option>
                            </select>

                            <!-- Source Filter -->
                            <select id="wa-filter-source" class="bg-zinc-800 border border-zinc-700 text-zinc-300 text-xs rounded-lg px-3 py-2 focus:border-zinc-500 focus:outline-none cursor-pointer">
                                <option value="">Źródło: wszystkie</option>
                            </select>

                            <div class="flex-1"></div>

                            <!-- Sort -->
                            <select id="wa-sort" class="bg-zinc-800 border border-zinc-700 text-zinc-300 text-xs rounded-lg px-3 py-2 focus:border-zinc-500 focus:outline-none cursor-pointer">
                                <option value="ltv_desc">LTV ↓</option>
                                <option value="ltv_asc">LTV ↑</option>
                                <option value="last_purchase_desc">Zakup ↓</option>
                                <option value="last_purchase_asc">Zakup ↑</option>
                                <option value="products_desc">Produkty ↓</option>
                            </select>
                        </div>
                    </div>

                    <!-- Results Header -->
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-3 text-xs text-zinc-500">
                            <span><span id="wa-stat-pending" class="text-amber-400 font-medium">0</span> do kontaktu</span>
                            <span>•</span>
                            <span><span id="wa-stat-contacted" class="text-green-400 font-medium">0</span> skontaktowano</span>
                        </div>
                        <button onclick="toggleTemplatesPanel()" id="btn-templates-panel" class="px-3 py-1.5 text-xs bg-zinc-800 hover:bg-zinc-700 text-zinc-300 hover:text-white rounded-lg transition-colors border border-zinc-700 flex items-center gap-2">
                            <i class="ph ph-chat-text"></i>
                            <span>Szablony</span>
                            <span id="templates-count" class="text-zinc-500">(0)</span>
                        </button>
                    </div>

                    <!-- Contacts Table -->
                    <div class="bg-zinc-900/40 rounded-xl border border-white/5 overflow-hidden">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-white/5 text-left bg-zinc-900/50">
                                    <th class="px-4 py-3 text-[10px] uppercase tracking-wider text-zinc-500 font-semibold">Kontakt</th>
                                    <th class="px-4 py-3 text-[10px] uppercase tracking-wider text-zinc-500 font-semibold">Telefon</th>
                                    <th class="px-4 py-3 text-[10px] uppercase tracking-wider text-zinc-500 font-semibold text-right">LTV</th>
                                    <th class="px-4 py-3 text-[10px] uppercase tracking-wider text-zinc-500 font-semibold">Pierwszy zakup</th>
                                    <th class="px-4 py-3 text-[10px] uppercase tracking-wider text-zinc-500 font-semibold">Ostatni zakup</th>
                                    <th class="px-4 py-3 text-[10px] uppercase tracking-wider text-zinc-500 font-semibold text-center">Produkty</th>
                                    <th class="px-4 py-3 text-[10px] uppercase tracking-wider text-zinc-500 font-semibold">Status</th>
                                    <th class="px-4 py-3 text-[10px] uppercase tracking-wider text-zinc-500 font-semibold text-center w-28">Akcja</th>
                                </tr>
                            </thead>
                            <tbody id="wa-contacts-table">
                                <tr>
                                    <td colspan="8" class="px-4 py-12 text-center text-zinc-500">
                                        <i class="ph ph-circle-notch animate-spin text-2xl mb-2"></i>
                                        <p>Ładowanie kontaktów...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div class="flex items-center justify-between mt-4">
                        <button onclick="waContactsPrevPage()" id="wa-btn-prev" class="px-4 py-2 text-xs bg-zinc-900 border border-zinc-800 rounded-lg text-zinc-400 hover:text-white hover:border-zinc-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <i class="ph ph-caret-left mr-1"></i> Poprzednia
                        </button>
                        <span id="wa-pagination-info" class="text-xs text-zinc-500 font-mono">Strona 1</span>
                        <button onclick="waContactsNextPage()" id="wa-btn-next" class="px-4 py-2 text-xs bg-zinc-900 border border-zinc-800 rounded-lg text-zinc-400 hover:text-white hover:border-zinc-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                            Następna <i class="ph ph-caret-right ml-1"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- New Campaign Modal -->
    <div id="modal-campaign" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden items-center justify-center">
        <div class="bg-zinc-900 border border-white/10 rounded-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto m-4">
            <div class="flex items-center justify-between p-5 border-b border-white/5">
                <h2 class="text-lg font-semibold text-white">Nowa kampania</h2>
                <button onclick="closeModal()" class="text-zinc-500 hover:text-white transition-colors">
                    <i class="ph ph-x text-xl"></i>
                </button>
            </div>

            <form id="campaign-form" class="p-5 space-y-5">
                <!-- Basic Info -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-[10px] uppercase tracking-wider text-zinc-500 font-semibold mb-1.5">Nazwa kampanii</label>
                        <input type="text" id="campaign-name" required class="w-full bg-zinc-800 border border-zinc-700 text-white rounded-lg px-3 py-2.5 text-sm focus:border-zinc-500 focus:outline-none" placeholder="np. Reaktywacja klientów Q1">
                    </div>

                    <div>
                        <label class="block text-[10px] uppercase tracking-wider text-zinc-500 font-semibold mb-1.5">Opis (opcjonalnie)</label>
                        <textarea id="campaign-description" rows="2" class="w-full bg-zinc-800 border border-zinc-700 text-white rounded-lg px-3 py-2.5 text-sm focus:border-zinc-500 focus:outline-none resize-none" placeholder="Krótki opis celu kampanii..."></textarea>
                    </div>
                </div>

                <!-- Settings -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] uppercase tracking-wider text-zinc-500 font-semibold mb-1.5">Dzienny limit wysyłki</label>
                        <input type="number" id="campaign-daily-limit" value="50" min="1" max="500" class="w-full bg-zinc-800 border border-zinc-700 text-white rounded-lg px-3 py-2.5 text-sm focus:border-zinc-500 focus:outline-none">
                        <p class="text-[10px] text-zinc-600 mt-1">Max 500 emaili dziennie</p>
                    </div>
                    <div>
                        <label class="block text-[10px] uppercase tracking-wider text-zinc-500 font-semibold mb-1.5">Follow-up po (dni)</label>
                        <input type="number" id="campaign-followup-days" value="7" min="1" max="30" class="w-full bg-zinc-800 border border-zinc-700 text-white rounded-lg px-3 py-2.5 text-sm focus:border-zinc-500 focus:outline-none">
                        <p class="text-[10px] text-zinc-600 mt-1">Jeśli brak odpowiedzi</p>
                    </div>
                </div>

                <!-- Contact Filter -->
                <div class="bg-zinc-800/50 rounded-lg p-4 border border-zinc-700/50">
                    <h3 class="text-sm font-medium text-white mb-3">Filtr kontaktów</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-[10px] uppercase tracking-wider text-zinc-500 font-semibold mb-1.5">Źródło</label>
                            <select id="campaign-filter-source" class="w-full bg-zinc-900 border border-zinc-700 text-zinc-300 text-sm rounded-lg px-3 py-2 focus:border-zinc-500 focus:outline-none">
                                <option value="">Wszystkie</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-[10px] uppercase tracking-wider text-zinc-500 font-semibold mb-1.5">Minimalne LTV</label>
                            <input type="number" id="campaign-filter-ltv" placeholder="0" class="w-full bg-zinc-900 border border-zinc-700 text-white rounded-lg px-3 py-2 text-sm focus:border-zinc-500 focus:outline-none">
                        </div>
                    </div>
                    <div class="mt-3 text-xs text-zinc-500">
                        Pasujące kontakty: <span id="matching-contacts" class="text-white font-mono">-</span>
                    </div>
                </div>

                <!-- Email 1 -->
                <div class="border-t border-white/5 pt-5">
                    <h3 class="text-sm font-medium text-white mb-3 flex items-center gap-2">
                        <span class="w-5 h-5 rounded-full bg-emerald-500/20 text-emerald-400 text-xs flex items-center justify-center">1</span>
                        Pierwszy email
                    </h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-[10px] uppercase tracking-wider text-zinc-500 font-semibold mb-1.5">Temat</label>
                            <input type="text" id="email-1-subject" required class="w-full bg-zinc-800 border border-zinc-700 text-white rounded-lg px-3 py-2.5 text-sm focus:border-zinc-500 focus:outline-none" placeholder="Temat pierwszego emaila">
                        </div>
                        <div>
                            <label class="block text-[10px] uppercase tracking-wider text-zinc-500 font-semibold mb-1.5">Treść (HTML)</label>
                            <textarea id="email-1-body" rows="6" required class="w-full bg-zinc-800 border border-zinc-700 text-white rounded-lg px-3 py-2.5 text-sm font-mono focus:border-zinc-500 focus:outline-none resize-y" placeholder="<p>Cześć,</p>&#10;&#10;<p>Treść wiadomości...</p>"></textarea>
                            <div class="text-[10px] text-zinc-600 mt-1">
                                Zmienne: <code class="bg-zinc-800 px-1 rounded">{{email}}</code> <code class="bg-zinc-800 px-1 rounded">{{ltv}}</code> <code class="bg-zinc-800 px-1 rounded">{{products}}</code>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Test Email -->
                <div class="border-t border-white/5 pt-5 bg-zinc-800/30 -mx-5 px-5 pb-5">
                    <h3 class="text-sm font-medium text-white mb-3 flex items-center gap-2">
                        <i class="ph ph-paper-plane-tilt text-amber-400"></i>
                        Wyślij email testowy
                    </h3>
                    <div class="flex gap-3">
                        <input type="email" id="test-email-address" placeholder="twoj@email.com" class="flex-1 bg-zinc-900 border border-zinc-700 text-white rounded-lg px-3 py-2.5 text-sm focus:border-zinc-500 focus:outline-none">
                        <button type="button" onclick="sendTestEmail()" id="btn-send-test" class="bg-amber-500/20 hover:bg-amber-500/30 text-amber-400 px-4 py-2.5 rounded-lg text-sm font-medium transition-colors whitespace-nowrap">
                            <i class="ph ph-paper-plane-tilt mr-1"></i>
                            Wyślij test
                        </button>
                    </div>
                    <p class="text-[10px] text-zinc-600 mt-2">Wyślij email testowy przed uruchomieniem kampanii. Użyje treści z "Pierwszy email".</p>
                </div>

                <!-- Email 2 (Follow-up) -->
                <div class="border-t border-white/5 pt-5">
                    <h3 class="text-sm font-medium text-white mb-3 flex items-center gap-2">
                        <span class="w-5 h-5 rounded-full bg-violet-500/20 text-violet-400 text-xs flex items-center justify-center">2</span>
                        Follow-up (opcjonalnie)
                    </h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-[10px] uppercase tracking-wider text-zinc-500 font-semibold mb-1.5">Temat</label>
                            <input type="text" id="email-2-subject" class="w-full bg-zinc-800 border border-zinc-700 text-white rounded-lg px-3 py-2.5 text-sm focus:border-zinc-500 focus:outline-none" placeholder="Temat follow-up (opcjonalnie)">
                        </div>
                        <div>
                            <label class="block text-[10px] uppercase tracking-wider text-zinc-500 font-semibold mb-1.5">Treść (HTML)</label>
                            <textarea id="email-2-body" rows="4" class="w-full bg-zinc-800 border border-zinc-700 text-white rounded-lg px-3 py-2.5 text-sm font-mono focus:border-zinc-500 focus:outline-none resize-y" placeholder="<p>Hej,</p>&#10;&#10;<p>Chciałem się upewnić że dotarła moja poprzednia wiadomość...</p>"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="flex justify-end gap-3 pt-4 border-t border-white/5">
                    <button type="button" onclick="closeModal()" class="px-4 py-2 text-sm text-zinc-400 hover:text-white transition-colors">
                        Anuluj
                    </button>
                    <button type="submit" class="bg-white text-black hover:bg-zinc-200 px-5 py-2 rounded-lg font-medium text-sm transition-colors">
                        Utwórz kampanię
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Import CSV Modal -->
    <div id="modal-import" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden items-center justify-center">
        <div class="bg-zinc-900 border border-white/10 rounded-xl w-full max-w-xl m-4">
            <div class="flex items-center justify-between p-5 border-b border-white/5">
                <h2 class="text-lg font-semibold text-white">Import kontaktów z CSV</h2>
                <button onclick="closeImportModal()" class="text-zinc-500 hover:text-white transition-colors">
                    <i class="ph ph-x text-xl"></i>
                </button>
            </div>

            <div class="p-5 space-y-5">
                <div>
                    <label class="block text-[10px] uppercase tracking-wider text-zinc-500 font-semibold mb-1.5">Nazwa źródła</label>
                    <input type="text" id="import-source" required class="w-full bg-zinc-800 border border-zinc-700 text-white rounded-lg px-3 py-2.5 text-sm focus:border-zinc-500 focus:outline-none" placeholder="np. klienci_ltv_2024">
                    <p class="text-[10px] text-zinc-600 mt-1">Identyfikator do filtrowania kontaktów</p>
                </div>

                <div>
                    <label class="block text-[10px] uppercase tracking-wider text-zinc-500 font-semibold mb-1.5">Plik CSV</label>
                    <div class="border-2 border-dashed border-zinc-700 rounded-lg p-6 text-center hover:border-zinc-600 transition-colors">
                        <input type="file" id="import-file" accept=".csv" class="hidden" onchange="handleFileSelect(event)">
                        <label for="import-file" class="cursor-pointer">
                            <i class="ph ph-file-csv text-4xl text-zinc-500 mb-2"></i>
                            <p class="text-zinc-400 text-sm">Kliknij aby wybrać plik CSV</p>
                            <p id="file-name" class="text-xs text-zinc-600 mt-1">lub przeciągnij i upuść</p>
                        </label>
                    </div>
                </div>

                <div class="bg-zinc-800/50 rounded-lg p-4 border border-zinc-700/50">
                    <h4 class="text-xs font-medium text-zinc-400 mb-2">Wymagane kolumny CSV:</h4>
                    <code class="text-[10px] text-zinc-500 font-mono block">email,phone,ltv_pln,transaction_count,refunded_total_pln,first_purchase,last_purchase,unique_products,products</code>
                    <p class="text-[10px] text-zinc-600 mt-2">Tylko <code class="bg-zinc-800 px-1 rounded">email</code> jest wymagane. Reszta opcjonalna.</p>
                </div>

                <div id="import-preview" class="hidden">
                    <h4 class="text-xs font-medium text-zinc-400 mb-2">Podgląd (pierwsze 5 wierszy):</h4>
                    <div class="bg-zinc-800/50 rounded-lg p-3 max-h-40 overflow-auto">
                        <table class="w-full text-[10px] font-mono">
                            <thead id="import-preview-head"></thead>
                            <tbody id="import-preview-body"></tbody>
                        </table>
                    </div>
                    <p id="import-total" class="text-xs text-zinc-500 mt-2"></p>
                </div>

                <div class="flex justify-end gap-3 pt-4 border-t border-white/5">
                    <button type="button" onclick="closeImportModal()" class="px-4 py-2 text-sm text-zinc-400 hover:text-white transition-colors">
                        Anuluj
                    </button>
                    <button type="button" onclick="importContacts()" id="btn-import" disabled class="bg-white text-black hover:bg-zinc-200 px-5 py-2 rounded-lg font-medium text-sm transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="ph ph-upload-simple mr-1"></i>
                        Importuj
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Campaign Details Modal -->
    <div id="modal-details" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden items-center justify-center">
        <div class="bg-zinc-900 border border-white/10 rounded-xl w-full max-w-4xl max-h-[90vh] overflow-hidden m-4 flex flex-col">
            <div class="flex items-center justify-between p-5 border-b border-white/5">
                <div>
                    <h2 id="details-title" class="text-lg font-semibold text-white">Szczegóły kampanii</h2>
                    <p id="details-subtitle" class="text-xs text-zinc-500 mt-0.5"></p>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="addMissingContacts(currentCampaignId)" id="btn-add-contacts" class="px-3 py-1.5 text-xs bg-amber-500/20 text-amber-400 hover:bg-amber-500/30 rounded-lg transition-colors">
                        <i class="ph ph-users-plus mr-1"></i> Uzupełnij kontakty
                    </button>
                    <button onclick="triggerSendNow()" id="btn-trigger-send" class="px-3 py-1.5 text-xs bg-emerald-500/20 text-emerald-400 hover:bg-emerald-500/30 rounded-lg transition-colors">
                        <i class="ph ph-paper-plane-tilt mr-1"></i> Wyślij teraz
                    </button>
                    <button onclick="triggerFollowupNow()" id="btn-trigger-followup" class="px-3 py-1.5 text-xs bg-violet-500/20 text-violet-400 hover:bg-violet-500/30 rounded-lg transition-colors">
                        <i class="ph ph-arrow-bend-up-right mr-1"></i> Follow-up teraz
                    </button>
                    <button onclick="closeDetailsModal()" class="text-zinc-500 hover:text-white transition-colors ml-2">
                        <i class="ph ph-x text-xl"></i>
                    </button>
                </div>
            </div>

            <!-- Stats row -->
            <div class="grid grid-cols-6 gap-3 p-5 border-b border-white/5 bg-zinc-900/50">
                <div class="text-center">
                    <div class="text-[10px] uppercase tracking-wider text-zinc-500 mb-0.5">Dzienny limit</div>
                    <div class="flex items-center justify-center gap-1">
                        <input type="number" id="details-daily-limit" min="1" max="500" class="w-16 text-lg font-mono text-amber-400 bg-transparent border-b border-amber-400/30 text-center focus:outline-none focus:border-amber-400" onchange="updateDailyLimit(this.value)">
                        <span class="text-zinc-600 text-xs">/dzień</span>
                    </div>
                </div>
                <div class="text-center">
                    <div class="text-[10px] uppercase tracking-wider text-zinc-500 mb-0.5">Oczekujące</div>
                    <div id="details-pending" class="text-lg font-mono text-white">0</div>
                </div>
                <div class="text-center">
                    <div class="text-[10px] uppercase tracking-wider text-zinc-500 mb-0.5">Wysłane</div>
                    <div id="details-sent" class="text-lg font-mono text-emerald-400">0</div>
                </div>
                <div class="text-center">
                    <div class="text-[10px] uppercase tracking-wider text-zinc-500 mb-0.5">Follow-up</div>
                    <div id="details-followedup" class="text-lg font-mono text-violet-400">0</div>
                </div>
                <div class="text-center">
                    <div class="text-[10px] uppercase tracking-wider text-zinc-500 mb-0.5">Odpowiedzi</div>
                    <div id="details-replied" class="text-lg font-mono text-blue-400">0</div>
                </div>
                <div class="text-center">
                    <div class="text-[10px] uppercase tracking-wider text-zinc-500 mb-0.5">Błędy</div>
                    <div id="details-errors" class="text-lg font-mono text-red-400">0</div>
                </div>
            </div>

            <!-- Email Preview Section -->
            <div class="border-b border-white/5">
                <button onclick="toggleEmailPreview()" class="w-full flex items-center justify-between px-5 py-3 text-sm text-zinc-400 hover:text-white hover:bg-zinc-800/30 transition-colors">
                    <span><i class="ph ph-envelope mr-2"></i>Podgląd wiadomości</span>
                    <i id="email-preview-chevron" class="ph ph-caret-down transition-transform"></i>
                </button>
                <div id="email-preview-content" class="hidden px-5 pb-4">
                    <!-- Tabs -->
                    <div class="flex gap-2 mb-3">
                        <button id="tab-email-1" onclick="showEmailTab(1)" class="px-3 py-1.5 text-xs rounded-lg bg-emerald-500/20 text-emerald-400 transition-colors">
                            Email 1
                        </button>
                        <button id="tab-email-2" onclick="showEmailTab(2)" class="px-3 py-1.5 text-xs rounded-lg bg-zinc-800 text-zinc-500 hover:text-zinc-300 transition-colors">
                            Follow-up
                        </button>
                    </div>

                    <!-- Email 1 content -->
                    <div id="preview-email-1" class="space-y-2">
                        <div class="bg-zinc-800/50 rounded-lg p-3 border border-white/5">
                            <div class="text-[10px] uppercase tracking-wider text-zinc-500 mb-1">Temat</div>
                            <div id="preview-email-1-subject" class="text-sm text-white font-medium"></div>
                        </div>
                        <div class="bg-zinc-800/50 rounded-lg p-3 border border-white/5">
                            <div class="text-[10px] uppercase tracking-wider text-zinc-500 mb-1">Treść</div>
                            <div id="preview-email-1-body" class="text-sm text-zinc-300 prose prose-sm prose-invert max-w-none [&_a]:text-emerald-400 overflow-auto max-h-48"></div>
                        </div>
                    </div>

                    <!-- Email 2 content -->
                    <div id="preview-email-2" class="space-y-2 hidden">
                        <div class="bg-zinc-800/50 rounded-lg p-3 border border-white/5">
                            <div class="text-[10px] uppercase tracking-wider text-zinc-500 mb-1">Temat</div>
                            <div id="preview-email-2-subject" class="text-sm text-white font-medium"></div>
                        </div>
                        <div class="bg-zinc-800/50 rounded-lg p-3 border border-white/5">
                            <div class="text-[10px] uppercase tracking-wider text-zinc-500 mb-1">Treść</div>
                            <div id="preview-email-2-body" class="text-sm text-zinc-300 prose prose-sm prose-invert max-w-none [&_a]:text-emerald-400 overflow-auto max-h-48"></div>
                        </div>
                        <div id="preview-email-2-empty" class="hidden text-center py-4 text-zinc-500 text-sm">
                            <i class="ph ph-info mr-1"></i> Brak skonfigurowanego follow-upu
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sends list -->
            <div class="flex-1 overflow-y-auto p-5">
                <div class="flex items-center gap-3 mb-4">
                    <select id="details-filter-status" onchange="filterDetailsSends()" class="bg-zinc-800 border border-zinc-700 text-zinc-300 text-xs rounded-lg px-3 py-2 focus:border-zinc-600 focus:outline-none">
                        <option value="">Wszystkie statusy</option>
                        <option value="pending">Oczekujące</option>
                        <option value="sent">Wysłane</option>
                        <option value="followed_up">Follow-up</option>
                        <option value="replied">Odpowiedzi</option>
                        <option value="bounced">Bounced</option>
                        <option value="excluded">Wykluczone</option>
                    </select>
                    <input type="text" id="details-search" placeholder="Szukaj po email..." class="bg-zinc-800 border border-zinc-700 text-zinc-300 text-xs rounded-lg px-3 py-2 focus:border-zinc-600 focus:outline-none w-48" oninput="filterDetailsSends()">
                </div>

                <div class="bg-zinc-800/30 rounded-lg border border-white/5 overflow-hidden">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b border-white/5 text-left">
                                <th class="px-4 py-2 text-[10px] uppercase tracking-wider text-zinc-500 font-semibold">Email</th>
                                <th class="px-4 py-2 text-[10px] uppercase tracking-wider text-zinc-500 font-semibold">Status</th>
                                <th class="px-4 py-2 text-[10px] uppercase tracking-wider text-zinc-500 font-semibold">Email 1</th>
                                <th class="px-4 py-2 text-[10px] uppercase tracking-wider text-zinc-500 font-semibold">Email 2</th>
                                <th class="px-4 py-2 text-[10px] uppercase tracking-wider text-zinc-500 font-semibold">Odpowiedź</th>
                            </tr>
                        </thead>
                        <tbody id="details-sends-table">
                            <tr>
                                <td colspan="5" class="px-4 py-8 text-center text-zinc-500">
                                    <i class="ph ph-circle-notch animate-spin text-xl"></i>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Details pagination -->
                <div class="flex items-center justify-between mt-4">
                    <button onclick="detailsPrevPage()" id="details-btn-prev" class="px-3 py-1.5 text-xs bg-zinc-800 border border-zinc-700 rounded-lg text-zinc-400 hover:text-white hover:border-zinc-600 transition-colors disabled:opacity-50" disabled>
                        <i class="ph ph-caret-left mr-1"></i> Poprzednia
                    </button>
                    <span id="details-pagination-info" class="text-xs text-zinc-500 font-mono">Strona 1</span>
                    <button onclick="detailsNextPage()" id="details-btn-next" class="px-3 py-1.5 text-xs bg-zinc-800 border border-zinc-700 rounded-lg text-zinc-400 hover:text-white hover:border-zinc-600 transition-colors disabled:opacity-50">
                        Następna <i class="ph ph-caret-right ml-1"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Save Filter Modal -->
    <div id="modal-save-filter" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden items-center justify-center">
        <div class="bg-zinc-900 border border-white/10 rounded-xl w-full max-w-sm m-4">
            <div class="flex items-center justify-between p-4 border-b border-white/5">
                <h2 class="text-base font-semibold text-white">Zapisz filtr</h2>
                <button onclick="closeSaveFilterModal()" class="text-zinc-500 hover:text-white transition-colors">
                    <i class="ph ph-x text-lg"></i>
                </button>
            </div>
            <div class="p-4">
                <label class="block text-[10px] uppercase tracking-wider text-zinc-500 font-semibold mb-1.5">Nazwa filtra</label>
                <input type="text" id="filter-name-input" placeholder="np. VIP klienci, Reaktywacja..." class="w-full bg-zinc-800 border border-zinc-700 text-white rounded-lg px-3 py-2.5 text-sm focus:border-zinc-500 focus:outline-none mb-4">
                <button onclick="saveCurrentFilter()" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white py-2.5 rounded-lg font-medium text-sm transition-colors">
                    <i class="ph ph-floppy-disk mr-1"></i>
                    Zapisz
                </button>
            </div>
        </div>
    </div>

    <!-- Delete Filter Confirmation Modal -->
    <div id="modal-delete-filter" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden items-center justify-center">
        <div class="bg-zinc-900 border border-white/10 rounded-xl w-full max-w-sm m-4">
            <div class="p-5 text-center">
                <div class="w-12 h-12 rounded-full bg-red-500/20 flex items-center justify-center mx-auto mb-4">
                    <i class="ph ph-trash text-2xl text-red-400"></i>
                </div>
                <h3 class="text-lg font-semibold text-white mb-2">Usuń filtr</h3>
                <p class="text-sm text-zinc-400 mb-5">Czy na pewno chcesz usunąć filtr <span id="delete-filter-name" class="text-white font-medium"></span>?</p>
                <div class="flex gap-3">
                    <button onclick="closeDeleteFilterModal()" class="flex-1 px-4 py-2.5 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 rounded-lg text-sm font-medium transition-colors">
                        Anuluj
                    </button>
                    <button onclick="confirmDeleteFilter()" class="flex-1 px-4 py-2.5 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm font-medium transition-colors">
                        <i class="ph ph-trash mr-1"></i>
                        Usuń
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Message Template Modal -->
    <div id="modal-template" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden items-center justify-center">
        <div class="bg-zinc-900 border border-white/10 rounded-xl w-full max-w-lg m-4">
            <div class="flex items-center justify-between p-4 border-b border-white/5">
                <h2 id="template-modal-title" class="text-base font-semibold text-white">Nowy szablon</h2>
                <button onclick="closeTemplateModal()" class="text-zinc-500 hover:text-white transition-colors">
                    <i class="ph ph-x text-lg"></i>
                </button>
            </div>
            <div class="p-4">
                <input type="hidden" id="template-id">
                <div class="mb-4">
                    <label class="block text-[10px] uppercase tracking-wider text-zinc-500 font-semibold mb-1.5">Nazwa szablonu</label>
                    <input type="text" id="template-name" placeholder="np. Powitanie, Follow-up, Reaktywacja..." class="w-full bg-zinc-800 border border-zinc-700 text-white rounded-lg px-3 py-2.5 text-sm focus:border-zinc-500 focus:outline-none">
                </div>
                <div class="mb-4">
                    <label class="block text-[10px] uppercase tracking-wider text-zinc-500 font-semibold mb-1.5">Kategoria</label>
                    <select id="template-category" class="w-full bg-zinc-800 border border-zinc-700 text-zinc-300 text-sm rounded-lg px-3 py-2.5 focus:border-zinc-500 focus:outline-none cursor-pointer">
                        <option value="general">Ogólne</option>
                        <option value="intro">Pierwsze kontakt</option>
                        <option value="followup">Follow-up</option>
                        <option value="reactivation">Reaktywacja</option>
                        <option value="promo">Promocje</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-[10px] uppercase tracking-wider text-zinc-500 font-semibold mb-1.5">Treść wiadomości</label>
                    <textarea id="template-content" rows="6" placeholder="Cześć! Mam dla Ciebie..." class="w-full bg-zinc-800 border border-zinc-700 text-white rounded-lg px-3 py-2.5 text-sm focus:border-zinc-500 focus:outline-none resize-none"></textarea>
                    <p class="text-[10px] text-zinc-600 mt-1">Możesz użyć zmiennych: {imie}, {produkt}, {ltv}</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="closeTemplateModal()" class="flex-1 px-4 py-2.5 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 rounded-lg text-sm font-medium transition-colors">
                        Anuluj
                    </button>
                    <button onclick="saveTemplate()" class="flex-1 px-4 py-2.5 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg text-sm font-medium transition-colors">
                        <i class="ph ph-floppy-disk mr-1"></i>
                        Zapisz
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Template Confirmation Modal -->
    <div id="modal-delete-template" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden items-center justify-center">
        <div class="bg-zinc-900 border border-white/10 rounded-xl w-full max-w-sm m-4">
            <div class="p-5 text-center">
                <div class="w-12 h-12 rounded-full bg-red-500/20 flex items-center justify-center mx-auto mb-4">
                    <i class="ph ph-trash text-2xl text-red-400"></i>
                </div>
                <h3 class="text-lg font-semibold text-white mb-2">Usuń szablon</h3>
                <p class="text-sm text-zinc-400 mb-5">Czy na pewno chcesz usunąć szablon <span id="delete-template-name" class="text-white font-medium"></span>?</p>
                <div class="flex gap-3">
                    <button onclick="closeDeleteTemplateModal()" class="flex-1 px-4 py-2.5 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 rounded-lg text-sm font-medium transition-colors">
                        Anuluj
                    </button>
                    <button onclick="confirmDeleteTemplate()" class="flex-1 px-4 py-2.5 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm font-medium transition-colors">
                        <i class="ph ph-trash mr-1"></i>
                        Usuń
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-6 right-6 bg-zinc-800 border border-white/10 text-white px-4 py-3 rounded-lg shadow-xl transform translate-y-20 opacity-0 transition-all duration-300 z-50">
        <span id="toast-message"></span>
    </div>

    <!-- Templates Side Panel (Drawer) -->
    <div id="templates-panel-backdrop" class="templates-panel-backdrop fixed inset-0 bg-black/50 z-40" onclick="closeTemplatesPanel()"></div>
    <aside id="templates-panel" class="templates-panel fixed top-0 right-0 h-full w-80 bg-zinc-900 border-l border-white/10 z-50 flex flex-col shadow-2xl">
        <!-- Panel Header -->
        <div class="flex items-center justify-between p-4 border-b border-white/10">
            <div class="flex items-center gap-2">
                <i class="ph ph-chat-text text-zinc-400"></i>
                <h3 class="text-sm font-semibold text-white">Szablony wiadomości</h3>
            </div>
            <button onclick="closeTemplatesPanel()" class="p-1.5 text-zinc-500 hover:text-white hover:bg-zinc-800 rounded-lg transition-colors">
                <i class="ph ph-x text-lg"></i>
            </button>
        </div>

        <!-- Add New Button -->
        <div class="p-4 border-b border-white/10">
            <button onclick="openTemplateModal()" class="w-full px-4 py-2.5 bg-emerald-500/20 hover:bg-emerald-500/30 text-emerald-400 rounded-lg text-sm font-medium transition-colors border border-emerald-500/30 flex items-center justify-center gap-2">
                <i class="ph ph-plus"></i>
                Nowy szablon
            </button>
        </div>

        <!-- Templates List -->
        <div id="templates-list" class="flex-1 overflow-y-auto p-4 space-y-3">
            <div class="text-xs text-zinc-600 italic py-8 text-center">Ładowanie...</div>
        </div>

        <!-- Panel Footer -->
        <div class="p-4 border-t border-white/10 bg-zinc-950/50">
            <p class="text-[10px] text-zinc-600 text-center">Kliknij "Kopiuj" aby skopiować treść do schowka</p>
        </div>
    </aside>

    <script>
        const SUPABASE_URL = 'https://yxmavwkwnfuphjqbelws.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl4bWF2d2t3bmZ1cGhqcWJlbHdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NjQyNTUsImV4cCI6MjA4NDM0MDI1NX0.XeR0Fc7OFn6YbNJrOKTBEj36JtmLISZTM87y4ai9340';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // State
        let contacts = [];
        let campaigns = [];
        let sources = [];
        let currentPage = 1;
        const PAGE_SIZE = 50;
        let totalContacts = 0;
        let selectedContactIds = new Set();
        let csvData = [];
        let currentCampaignId = null;
        let detailsSends = [];
        let detailsPage = 1;
        const DETAILS_PAGE_SIZE = 50;
        let totalDetailsSends = 0;

        // WhatsApp state
        let waContacts = [];
        let waCurrentPage = 1;
        const WA_PAGE_SIZE = 50;
        let waTotalContacts = 0;

        // Current user state
        let currentTeamMember = null;

        // Templates state
        let messageTemplates = [];
        let deleteTemplateId = null;
        let templatesPanelOpen = localStorage.getItem('templatesPanelOpen') === 'true';

        // Auth check
        async function checkAuth() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
                window.location.href = Sidebar.getLoginPath();
                return null;
            }
            Sidebar.setUserEmail(session.user.email.split('@')[0]);

            // Check admin via team_members
            const { data: teamMember } = await supabaseClient
                .from('team_members')
                .select('id, role, name, color')
                .eq('user_id', session.user.id)
                .single();

            // Update sidebar user info and store team member globally
            if (teamMember) {
                currentTeamMember = teamMember;
                Sidebar.setUserName(teamMember.name);
                Sidebar.setUserColor(teamMember.color);
                Sidebar.setupProfileClick();
            }

            const isAdmin = teamMember?.role === 'admin';
            Sidebar.showAdminNav(isAdmin);

            return session;
        }

        // Tab switching
        function switchTab(tab) {
            const tabs = ['contacts', 'campaigns-email', 'campaigns-whatsapp'];

            tabs.forEach(t => {
                const panel = document.getElementById(`panel-${t}`);
                const tabBtn = document.getElementById(`tab-${t}`);

                if (panel) panel.classList.toggle('hidden', tab !== t);
                if (tabBtn) {
                    tabBtn.classList.toggle('tab-active', tab === t);
                    tabBtn.classList.toggle('text-zinc-500', tab !== t);
                    tabBtn.classList.toggle('border-transparent', tab !== t);
                }
            });

            // Load WhatsApp contacts when switching to that tab
            if (tab === 'campaigns-whatsapp') {
                renderSavedFilters();
                updateFilterButtons();
                loadWaContacts();
                loadTemplates();
                // Restore templates panel state
                updateTemplatesPanelState();
            } else {
                // Hide templates panel when leaving WhatsApp tab
                document.getElementById('templates-panel').classList.remove('open');
                document.getElementById('templates-panel-backdrop').classList.remove('open');
            }
        }

        // Load contacts
        async function loadContacts() {
            const search = document.getElementById('search-input').value.trim().toLowerCase();
            const source = document.getElementById('filter-source').value;
            const minLtv = document.getElementById('filter-ltv').value;
            const minProducts = document.getElementById('filter-products').value;

            let query = supabaseClient
                .from('outreach_contacts')
                .select('*', { count: 'exact' })
                .order('ltv_pln', { ascending: false, nullsFirst: false })
                .range((currentPage - 1) * PAGE_SIZE, currentPage * PAGE_SIZE - 1);

            if (search) {
                query = query.or(`email.ilike.%${search}%,phone.ilike.%${search}%`);
            }
            if (source) {
                query = query.eq('source', source);
            }
            if (minLtv) {
                query = query.gte('ltv_pln', parseInt(minLtv));
            }
            if (minProducts) {
                query = query.gte('unique_products', parseInt(minProducts));
            }

            const { data, count, error } = await query;

            if (error) {
                console.error('Error loading contacts:', error);
                return;
            }

            contacts = data || [];
            totalContacts = count || 0;

            renderContacts();
            updatePagination();

            document.getElementById('contacts-count').textContent = `${totalContacts.toLocaleString('pl-PL')} kontaktów`;
        }

        function renderContacts() {
            const tbody = document.getElementById('contacts-table');

            if (contacts.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="px-4 py-12 text-center text-zinc-500">
                            <i class="ph ph-address-book text-3xl mb-2"></i>
                            <p>Brak kontaktów pasujących do filtrów</p>
                            <button onclick="openImportModal()" class="mt-3 px-4 py-2 bg-zinc-800 hover:bg-zinc-700 rounded-lg text-sm text-white transition-colors">
                                <i class="ph ph-upload-simple mr-1"></i> Importuj kontakty
                            </button>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = contacts.map(c => `
                <tr class="border-b border-white/5 hover:bg-white/[0.02] transition-colors">
                    <td class="px-4 py-3">
                        <input type="checkbox" data-id="${c.id}" onchange="toggleContactSelection('${c.id}')" ${selectedContactIds.has(c.id) ? 'checked' : ''} class="w-4 h-4 rounded border-zinc-700 bg-zinc-800 text-white focus:ring-0 focus:ring-offset-0 cursor-pointer">
                    </td>
                    <td class="px-4 py-3">
                        <span class="font-mono text-xs text-white">${c.email}</span>
                    </td>
                    <td class="px-4 py-3 text-zinc-400 text-xs font-mono">
                        ${c.phone || '-'}
                    </td>
                    <td class="px-4 py-3 text-right">
                        <span class="font-mono text-xs ${c.ltv_pln > 10000 ? 'text-emerald-400' : c.ltv_pln > 1000 ? 'text-white' : 'text-zinc-500'}">
                            ${c.ltv_pln ? c.ltv_pln.toLocaleString('pl-PL') + ' PLN' : '-'}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-center">
                        <span class="text-xs text-zinc-400">${c.transaction_count || 0}</span>
                    </td>
                    <td class="px-4 py-3 text-center">
                        <span class="text-xs text-zinc-400">${c.unique_products || 0}</span>
                    </td>
                    <td class="px-4 py-3 text-zinc-500 text-xs">
                        ${c.last_purchase ? new Date(c.last_purchase).toLocaleDateString('pl-PL') : '-'}
                    </td>
                    <td class="px-4 py-3">
                        <span class="text-[10px] px-2 py-0.5 rounded bg-zinc-800 text-zinc-400 font-mono">${c.source}</span>
                    </td>
                </tr>
            `).join('');
        }

        // Contact selection
        function toggleContactSelection(id) {
            if (selectedContactIds.has(id)) {
                selectedContactIds.delete(id);
            } else {
                selectedContactIds.add(id);
            }
            updateDeleteButton();
        }

        function toggleAllContacts() {
            const checkbox = document.getElementById('select-all-contacts');
            if (checkbox.checked) {
                contacts.forEach(c => selectedContactIds.add(c.id));
            } else {
                contacts.forEach(c => selectedContactIds.delete(c.id));
            }
            renderContacts();
            updateDeleteButton();
        }

        function updateDeleteButton() {
            const btn = document.getElementById('btn-delete-contacts');
            if (selectedContactIds.size > 0) {
                btn.classList.remove('hidden');
                btn.textContent = `Usuń zaznaczone (${selectedContactIds.size})`;
            } else {
                btn.classList.add('hidden');
            }
        }

        async function deleteSelectedContacts() {
            if (selectedContactIds.size === 0) return;
            if (!confirm(`Czy na pewno chcesz usunąć ${selectedContactIds.size} kontaktów?`)) return;

            const ids = Array.from(selectedContactIds);
            const { error } = await supabaseClient
                .from('outreach_contacts')
                .delete()
                .in('id', ids);

            if (error) {
                showToast('Błąd usuwania: ' + error.message);
                return;
            }

            showToast(`Usunięto ${ids.length} kontaktów`);
            selectedContactIds.clear();
            updateDeleteButton();
            loadContacts();
            loadSources();
        }

        function updatePagination() {
            const totalPages = Math.ceil(totalContacts / PAGE_SIZE);
            document.getElementById('pagination-info').textContent = `Strona ${currentPage} z ${totalPages}`;
            document.getElementById('btn-prev').disabled = currentPage <= 1;
            document.getElementById('btn-next').disabled = currentPage >= totalPages;
        }

        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                loadContacts();
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(totalContacts / PAGE_SIZE);
            if (currentPage < totalPages) {
                currentPage++;
                loadContacts();
            }
        }

        // Load sources for filters
        async function loadSources() {
            const { data } = await supabaseClient
                .from('outreach_contacts')
                .select('source')
                .limit(1000);

            if (data) {
                sources = [...new Set(data.map(d => d.source))].sort();
                const options = sources.map(s => `<option value="${s}">${s}</option>`).join('');

                document.getElementById('filter-source').innerHTML = '<option value="">Wszystkie źródła</option>' + options;
                document.getElementById('campaign-filter-source').innerHTML = '<option value="">Wszystkie</option>' + options;
                document.getElementById('wa-filter-source').innerHTML = '<option value="">Wszystkie źródła</option>' + options;
            }
        }

        // Load campaigns
        async function loadCampaigns() {
            const { data, error } = await supabaseClient
                .from('outreach_campaigns')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error loading campaigns:', error);
                return;
            }

            campaigns = data || [];
            renderCampaigns();
            updateCampaignStats();
        }

        function renderCampaigns() {
            const container = document.getElementById('campaigns-list');

            if (campaigns.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-16 bg-zinc-900/40 rounded-xl border border-white/5">
                        <i class="ph ph-paper-plane-tilt text-4xl text-zinc-600 mb-3"></i>
                        <p class="text-zinc-500 mb-4">Brak kampanii</p>
                        <button onclick="openNewCampaignModal()" class="bg-white text-black hover:bg-zinc-200 px-4 py-2 rounded-lg font-medium text-sm transition-colors">
                            <i class="ph ph-plus mr-1"></i>
                            Utwórz pierwszą kampanię
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = campaigns.map(c => {
                const statusColors = {
                    draft: 'bg-zinc-500/20 text-zinc-400',
                    active: 'bg-emerald-500/20 text-emerald-400',
                    paused: 'bg-amber-500/20 text-amber-400',
                    completed: 'bg-blue-500/20 text-blue-400'
                };
                const statusLabels = {
                    draft: 'Szkic',
                    active: 'Aktywna',
                    paused: 'Wstrzymana',
                    completed: 'Zakończona'
                };

                return `
                    <div class="bg-zinc-900/40 rounded-xl border border-white/5 p-5 hover:border-zinc-700 transition-colors">
                        <div class="flex items-start justify-between mb-3">
                            <div>
                                <h3 class="text-white font-medium">${c.name}</h3>
                                <p class="text-zinc-500 text-xs mt-0.5">${c.description || 'Brak opisu'}</p>
                            </div>
                            <span class="text-[10px] px-2 py-1 rounded font-medium ${statusColors[c.status]}">${statusLabels[c.status]}</span>
                        </div>

                        <div class="grid grid-cols-4 gap-4 mb-4">
                            <div>
                                <div class="text-[10px] uppercase tracking-wider text-zinc-600 mb-0.5">Kontakty</div>
                                <div class="text-sm font-mono text-white">${c.total_contacts || 0}</div>
                            </div>
                            <div>
                                <div class="text-[10px] uppercase tracking-wider text-zinc-600 mb-0.5">Wysłane</div>
                                <div class="text-sm font-mono text-white">${c.sent_count || 0}</div>
                            </div>
                            <div>
                                <div class="text-[10px] uppercase tracking-wider text-zinc-600 mb-0.5">Follow-upy</div>
                                <div class="text-sm font-mono text-white">${c.followed_up_count || 0}</div>
                            </div>
                            <div>
                                <div class="text-[10px] uppercase tracking-wider text-zinc-600 mb-0.5">Odpowiedzi</div>
                                <div class="text-sm font-mono text-violet-400">${c.replied_count || 0}</div>
                            </div>
                        </div>

                        <div class="flex items-center gap-2 pt-3 border-t border-white/5">
                            ${c.status === 'draft' ? `
                                <button onclick="startCampaign('${c.id}')" class="flex-1 bg-emerald-500/20 hover:bg-emerald-500/30 text-emerald-400 px-3 py-2 rounded-lg text-xs font-medium transition-colors">
                                    <i class="ph ph-play mr-1"></i> Uruchom
                                </button>
                            ` : ''}
                            ${c.status === 'active' ? `
                                <button onclick="pauseCampaign('${c.id}')" class="flex-1 bg-amber-500/20 hover:bg-amber-500/30 text-amber-400 px-3 py-2 rounded-lg text-xs font-medium transition-colors">
                                    <i class="ph ph-pause mr-1"></i> Wstrzymaj
                                </button>
                            ` : ''}
                            ${c.status === 'paused' ? `
                                <button onclick="resumeCampaign('${c.id}')" class="flex-1 bg-emerald-500/20 hover:bg-emerald-500/30 text-emerald-400 px-3 py-2 rounded-lg text-xs font-medium transition-colors">
                                    <i class="ph ph-play mr-1"></i> Wznów
                                </button>
                            ` : ''}
                            <button onclick="viewCampaign('${c.id}')" class="px-3 py-2 text-zinc-400 hover:text-white border border-zinc-700 hover:border-zinc-600 rounded-lg text-xs font-medium transition-colors">
                                <i class="ph ph-eye mr-1"></i> Szczegóły
                            </button>
                            ${c.status !== 'active' ? `
                                <button onclick="deleteCampaign('${c.id}')" class="px-3 py-2 text-red-400 hover:text-red-300 hover:bg-red-500/10 rounded-lg text-xs font-medium transition-colors" title="Usuń kampanię">
                                    <i class="ph ph-trash"></i>
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateCampaignStats() {
            const active = campaigns.filter(c => c.status === 'active').length;
            const sent = campaigns.reduce((sum, c) => sum + (c.sent_count || 0), 0);
            const followups = campaigns.reduce((sum, c) => sum + (c.followed_up_count || 0), 0);
            const replies = campaigns.reduce((sum, c) => sum + (c.replied_count || 0), 0);

            document.getElementById('stat-active').textContent = active;
            document.getElementById('stat-sent').textContent = sent.toLocaleString('pl-PL');
            document.getElementById('stat-followups').textContent = followups.toLocaleString('pl-PL');
            document.getElementById('stat-replies').textContent = replies.toLocaleString('pl-PL');
        }

        // Modal functions
        function openNewCampaignModal() {
            document.getElementById('modal-campaign').classList.remove('hidden');
            document.getElementById('modal-campaign').classList.add('flex');
            updateMatchingContacts();
        }

        function closeModal() {
            document.getElementById('modal-campaign').classList.add('hidden');
            document.getElementById('modal-campaign').classList.remove('flex');
            document.getElementById('campaign-form').reset();
        }

        async function updateMatchingContacts() {
            const source = document.getElementById('campaign-filter-source').value;
            const minLtv = document.getElementById('campaign-filter-ltv').value;

            let query = supabaseClient.from('outreach_contacts').select('*', { count: 'exact', head: true });

            if (source) query = query.eq('source', source);
            if (minLtv) query = query.gte('ltv_pln', parseInt(minLtv));

            const { count } = await query;
            document.getElementById('matching-contacts').textContent = (count || 0).toLocaleString('pl-PL');
        }

        // Campaign form submit
        document.getElementById('campaign-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const filter = {};
            const source = document.getElementById('campaign-filter-source').value;
            const minLtv = document.getElementById('campaign-filter-ltv').value;
            if (source) filter.source = source;
            if (minLtv) filter.min_ltv = parseInt(minLtv);

            const campaignData = {
                name: document.getElementById('campaign-name').value,
                description: document.getElementById('campaign-description').value || null,
                daily_limit: parseInt(document.getElementById('campaign-daily-limit').value),
                follow_up_delay_days: parseInt(document.getElementById('campaign-followup-days').value),
                email_1_subject: document.getElementById('email-1-subject').value,
                email_1_body: document.getElementById('email-1-body').value,
                email_2_subject: document.getElementById('email-2-subject').value || null,
                email_2_body: document.getElementById('email-2-body').value || null,
                contact_filter: filter,
                status: 'draft'
            };

            const { data, error } = await supabaseClient.from('outreach_campaigns').insert(campaignData).select().single();

            if (error) {
                showToast('Błąd tworzenia kampanii: ' + error.message);
                return;
            }

            showToast('Kampania utworzona!');
            closeModal();
            loadCampaigns();
        });

        // Campaign actions
        async function startCampaign(id) {
            // First, populate outreach_sends with matching contacts
            const campaign = campaigns.find(c => c.id === id);
            if (!campaign) return;

            // Clear any existing sends for this campaign (in case of restart)
            await supabaseClient.from('outreach_sends').delete().eq('campaign_id', id);

            // Get matching contacts (paginated to avoid 1000 row limit)
            let allContacts = [];
            let page = 0;
            const PAGE_SIZE = 1000;

            while (true) {
                let query = supabaseClient.from('outreach_contacts').select('id');
                if (campaign.contact_filter?.source) {
                    query = query.eq('source', campaign.contact_filter.source);
                }
                if (campaign.contact_filter?.min_ltv) {
                    query = query.gte('ltv_pln', campaign.contact_filter.min_ltv);
                }
                query = query.range(page * PAGE_SIZE, (page + 1) * PAGE_SIZE - 1);

                const { data: pageContacts } = await query;

                if (!pageContacts || pageContacts.length === 0) break;

                allContacts = allContacts.concat(pageContacts);

                if (pageContacts.length < PAGE_SIZE) break;
                page++;
            }

            const matchingContacts = allContacts;

            if (!matchingContacts || matchingContacts.length === 0) {
                showToast('Brak kontaktów pasujących do filtrów');
                return;
            }

            // Insert sends
            const sends = matchingContacts.map(c => ({
                campaign_id: id,
                contact_id: c.id,
                status: 'pending'
            }));

            // Insert in batches
            const BATCH = 500;
            for (let i = 0; i < sends.length; i += BATCH) {
                await supabaseClient.from('outreach_sends').insert(sends.slice(i, i + BATCH));
                showToast(`Dodawanie kontaktów: ${Math.min(i + BATCH, sends.length)}/${sends.length}...`);
            }

            // Update campaign status
            await supabaseClient.from('outreach_campaigns').update({
                status: 'active',
                total_contacts: matchingContacts.length,
                started_at: new Date().toISOString()
            }).eq('id', id);

            showToast('Kampania uruchomiona!');
            loadCampaigns();
        }

        // Add missing contacts to existing campaign
        async function addMissingContacts(id) {
            const campaign = campaigns.find(c => c.id === id);
            if (!campaign) return;

            showToast('Pobieranie kontaktów...');

            // Get matching contacts (paginated)
            let allContacts = [];
            let page = 0;
            const PAGE_SIZE = 1000;

            while (true) {
                let query = supabaseClient.from('outreach_contacts').select('id');
                if (campaign.contact_filter?.source) {
                    query = query.eq('source', campaign.contact_filter.source);
                }
                if (campaign.contact_filter?.min_ltv) {
                    query = query.gte('ltv_pln', campaign.contact_filter.min_ltv);
                }
                query = query.range(page * PAGE_SIZE, (page + 1) * PAGE_SIZE - 1);

                const { data: pageContacts } = await query;

                if (!pageContacts || pageContacts.length === 0) break;

                allContacts = allContacts.concat(pageContacts);
                showToast(`Pobrano ${allContacts.length} kontaktów...`);

                if (pageContacts.length < PAGE_SIZE) break;
                page++;
            }

            if (allContacts.length === 0) {
                showToast('Brak kontaktów pasujących do filtrów');
                return;
            }

            showToast(`Sprawdzanie istniejących wysyłek...`);

            // Get existing contact_ids for this campaign (paginated)
            let existingContactIds = new Set();
            page = 0;

            while (true) {
                const { data: existingSends } = await supabaseClient
                    .from('outreach_sends')
                    .select('contact_id')
                    .eq('campaign_id', id)
                    .range(page * PAGE_SIZE, (page + 1) * PAGE_SIZE - 1);

                if (!existingSends || existingSends.length === 0) break;

                existingSends.forEach(s => existingContactIds.add(s.contact_id));

                if (existingSends.length < PAGE_SIZE) break;
                page++;
            }

            // Filter out contacts that are already in the campaign
            const newContacts = allContacts.filter(c => !existingContactIds.has(c.id));

            if (newContacts.length === 0) {
                showToast('Wszystkie kontakty są już w kampanii');
                return;
            }

            showToast(`Dodawanie ${newContacts.length} nowych kontaktów...`);

            // Insert only new contacts
            const sends = newContacts.map(c => ({
                campaign_id: id,
                contact_id: c.id,
                status: 'pending'
            }));

            const BATCH = 500;
            for (let i = 0; i < sends.length; i += BATCH) {
                await supabaseClient.from('outreach_sends').insert(sends.slice(i, i + BATCH));
                showToast(`Dodano ${Math.min(i + BATCH, sends.length)}/${sends.length}...`);
            }

            // Update total_contacts
            const newTotal = existingContactIds.size + newContacts.length;
            await supabaseClient.from('outreach_campaigns').update({
                total_contacts: newTotal
            }).eq('id', id);

            showToast(`Dodano ${newContacts.length} kontaktów (łącznie: ${newTotal})`);
            loadCampaigns();
            if (currentCampaignId === id) {
                loadCampaignDetails(id);
            }
        }

        async function pauseCampaign(id) {
            await supabaseClient.from('outreach_campaigns').update({ status: 'paused' }).eq('id', id);
            showToast('Kampania wstrzymana');
            loadCampaigns();
        }

        async function resumeCampaign(id) {
            await supabaseClient.from('outreach_campaigns').update({ status: 'active' }).eq('id', id);
            showToast('Kampania wznowiona');
            loadCampaigns();
        }

        async function deleteCampaign(id) {
            if (!confirm('Czy na pewno chcesz usunąć tę kampanię?')) return;

            await supabaseClient.from('outreach_campaigns').delete().eq('id', id);
            showToast('Kampania usunięta');
            loadCampaigns();
        }

        async function viewCampaign(id) {
            currentCampaignId = id;
            detailsPage = 1;

            const campaign = campaigns.find(c => c.id === id);
            if (!campaign) return;

            document.getElementById('details-title').textContent = campaign.name;
            document.getElementById('details-subtitle').textContent = campaign.description || 'Brak opisu';
            document.getElementById('details-daily-limit').value = campaign.daily_limit || 50;

            // Show/hide trigger buttons based on status
            document.getElementById('btn-add-contacts').classList.toggle('hidden', campaign.status === 'completed');
            document.getElementById('btn-trigger-send').classList.toggle('hidden', campaign.status !== 'active');
            document.getElementById('btn-trigger-followup').classList.toggle('hidden', campaign.status !== 'active' || !campaign.email_2_subject);

            // Populate email preview
            document.getElementById('preview-email-1-subject').textContent = campaign.email_1_subject || 'Brak tematu';
            document.getElementById('preview-email-1-body').innerHTML = campaign.email_1_body || '<span class="text-zinc-500">Brak treści</span>';

            // Email 2 (follow-up)
            const hasEmail2 = campaign.email_2_subject && campaign.email_2_body;
            document.getElementById('preview-email-2-subject').textContent = campaign.email_2_subject || '';
            document.getElementById('preview-email-2-body').innerHTML = campaign.email_2_body || '';
            document.getElementById('preview-email-2-subject').parentElement.classList.toggle('hidden', !hasEmail2);
            document.getElementById('preview-email-2-body').parentElement.classList.toggle('hidden', !hasEmail2);
            document.getElementById('preview-email-2-empty').classList.toggle('hidden', hasEmail2);

            // Reset to email 1 tab
            showEmailTab(1);

            document.getElementById('modal-details').classList.remove('hidden');
            document.getElementById('modal-details').classList.add('flex');

            await loadCampaignDetails(id);
        }

        function closeDetailsModal() {
            document.getElementById('modal-details').classList.add('hidden');
            document.getElementById('modal-details').classList.remove('flex');
            currentCampaignId = null;
            // Reset email preview state
            document.getElementById('email-preview-content').classList.add('hidden');
            document.getElementById('email-preview-chevron').style.transform = '';
        }

        function toggleEmailPreview() {
            const content = document.getElementById('email-preview-content');
            const chevron = document.getElementById('email-preview-chevron');
            content.classList.toggle('hidden');
            chevron.style.transform = content.classList.contains('hidden') ? '' : 'rotate(180deg)';
        }

        function showEmailTab(num) {
            const tab1 = document.getElementById('tab-email-1');
            const tab2 = document.getElementById('tab-email-2');
            const preview1 = document.getElementById('preview-email-1');
            const preview2 = document.getElementById('preview-email-2');

            if (num === 1) {
                tab1.className = 'px-3 py-1.5 text-xs rounded-lg bg-emerald-500/20 text-emerald-400 transition-colors';
                tab2.className = 'px-3 py-1.5 text-xs rounded-lg bg-zinc-800 text-zinc-500 hover:text-zinc-300 transition-colors';
                preview1.classList.remove('hidden');
                preview2.classList.add('hidden');
            } else {
                tab1.className = 'px-3 py-1.5 text-xs rounded-lg bg-zinc-800 text-zinc-500 hover:text-zinc-300 transition-colors';
                tab2.className = 'px-3 py-1.5 text-xs rounded-lg bg-violet-500/20 text-violet-400 transition-colors';
                preview1.classList.add('hidden');
                preview2.classList.remove('hidden');
            }
        }

        async function loadCampaignDetails(campaignId) {
            const statusFilter = document.getElementById('details-filter-status').value;
            const searchFilter = document.getElementById('details-search').value.trim().toLowerCase();

            // Get stats using count queries (to handle >1000 records)
            const [pendingRes, sentRes, followedUpRes, repliedRes, bouncedRes, excludedRes] = await Promise.all([
                supabaseClient.from('outreach_sends').select('*', { count: 'exact', head: true }).eq('campaign_id', campaignId).eq('status', 'pending'),
                supabaseClient.from('outreach_sends').select('*', { count: 'exact', head: true }).eq('campaign_id', campaignId).eq('status', 'sent'),
                supabaseClient.from('outreach_sends').select('*', { count: 'exact', head: true }).eq('campaign_id', campaignId).eq('status', 'followed_up'),
                supabaseClient.from('outreach_sends').select('*', { count: 'exact', head: true }).eq('campaign_id', campaignId).eq('status', 'replied'),
                supabaseClient.from('outreach_sends').select('*', { count: 'exact', head: true }).eq('campaign_id', campaignId).eq('status', 'bounced'),
                supabaseClient.from('outreach_sends').select('*', { count: 'exact', head: true }).eq('campaign_id', campaignId).eq('status', 'excluded')
            ]);

            document.getElementById('details-pending').textContent = pendingRes.count || 0;
            document.getElementById('details-sent').textContent = sentRes.count || 0;
            document.getElementById('details-followedup').textContent = followedUpRes.count || 0;
            document.getElementById('details-replied').textContent = repliedRes.count || 0;
            document.getElementById('details-errors').textContent = (bouncedRes.count || 0) + (excludedRes.count || 0);

            // Get sends with pagination
            let query = supabaseClient
                .from('outreach_sends')
                .select(`
                    *,
                    contact:outreach_contacts (email)
                `, { count: 'exact' })
                .eq('campaign_id', campaignId)
                .order('created_at', { ascending: false })
                .range((detailsPage - 1) * DETAILS_PAGE_SIZE, detailsPage * DETAILS_PAGE_SIZE - 1);

            if (statusFilter) {
                query = query.eq('status', statusFilter);
            }

            const { data, count, error } = await query;

            if (error) {
                console.error('Error loading sends:', error);
                return;
            }

            // Filter by email search client-side (after fetch)
            let filteredData = data || [];
            if (searchFilter) {
                filteredData = filteredData.filter(s => s.contact?.email?.toLowerCase().includes(searchFilter));
            }

            detailsSends = filteredData;
            totalDetailsSends = count || 0;

            renderDetailsSends();
            updateDetailsPagination();
        }

        function renderDetailsSends() {
            const tbody = document.getElementById('details-sends-table');

            if (detailsSends.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-4 py-8 text-center text-zinc-500">
                            Brak wysyłek pasujących do filtrów
                        </td>
                    </tr>
                `;
                return;
            }

            const statusLabels = {
                pending: '<span class="text-[10px] px-2 py-0.5 rounded bg-zinc-500/20 text-zinc-400">Oczekuje</span>',
                sent: '<span class="text-[10px] px-2 py-0.5 rounded bg-emerald-500/20 text-emerald-400">Wysłano</span>',
                followed_up: '<span class="text-[10px] px-2 py-0.5 rounded bg-violet-500/20 text-violet-400">Follow-up</span>',
                replied: '<span class="text-[10px] px-2 py-0.5 rounded bg-blue-500/20 text-blue-400">Odpowiedź</span>',
                bounced: '<span class="text-[10px] px-2 py-0.5 rounded bg-red-500/20 text-red-400">Bounced</span>',
                excluded: '<span class="text-[10px] px-2 py-0.5 rounded bg-amber-500/20 text-amber-400">Wykluczone</span>'
            };

            tbody.innerHTML = detailsSends.map(s => `
                <tr class="border-b border-white/5 hover:bg-white/[0.02]">
                    <td class="px-4 py-2 text-xs font-mono text-white">${s.contact?.email || '-'}</td>
                    <td class="px-4 py-2">${statusLabels[s.status] || s.status}</td>
                    <td class="px-4 py-2 text-xs text-zinc-500">${s.email_1_sent_at ? new Date(s.email_1_sent_at).toLocaleString('pl-PL') : '-'}</td>
                    <td class="px-4 py-2 text-xs text-zinc-500">${s.email_2_sent_at ? new Date(s.email_2_sent_at).toLocaleString('pl-PL') : '-'}</td>
                    <td class="px-4 py-2 text-xs text-zinc-500">${s.replied_at ? new Date(s.replied_at).toLocaleString('pl-PL') : '-'}</td>
                </tr>
            `).join('');
        }

        function updateDetailsPagination() {
            const totalPages = Math.ceil(totalDetailsSends / DETAILS_PAGE_SIZE) || 1;
            document.getElementById('details-pagination-info').textContent = `Strona ${detailsPage} z ${totalPages}`;
            document.getElementById('details-btn-prev').disabled = detailsPage <= 1;
            document.getElementById('details-btn-next').disabled = detailsPage >= totalPages;
        }

        function detailsPrevPage() {
            if (detailsPage > 1) {
                detailsPage--;
                loadCampaignDetails(currentCampaignId);
            }
        }

        function detailsNextPage() {
            const totalPages = Math.ceil(totalDetailsSends / DETAILS_PAGE_SIZE);
            if (detailsPage < totalPages) {
                detailsPage++;
                loadCampaignDetails(currentCampaignId);
            }
        }

        function filterDetailsSends() {
            detailsPage = 1;
            loadCampaignDetails(currentCampaignId);
        }

        // Send test email
        async function sendTestEmail() {
            const testEmail = document.getElementById('test-email-address').value.trim();
            const subject = document.getElementById('email-1-subject').value.trim();
            const body = document.getElementById('email-1-body').value.trim();

            if (!testEmail || !testEmail.includes('@')) {
                showToast('Podaj prawidłowy adres email');
                return;
            }

            if (!subject || !body) {
                showToast('Wypełnij temat i treść pierwszego emaila');
                return;
            }

            const btn = document.getElementById('btn-send-test');
            btn.disabled = true;
            btn.innerHTML = '<i class="ph ph-circle-notch animate-spin mr-1"></i> Wysyłam...';

            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/send-email`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        to: testEmail,
                        subject: subject,
                        html: body,
                        reply_to: 'test@inbound.tomekniedzwiecki.pl',
                        no_signature: true
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showToast(`Email testowy wysłany na ${testEmail}`);
                } else {
                    showToast('Błąd wysyłki: ' + (result.error || 'Nieznany błąd'));
                }
            } catch (err) {
                showToast('Błąd połączenia: ' + err.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="ph ph-paper-plane-tilt mr-1"></i> Wyślij test';
            }
        }

        // Update daily limit
        async function updateDailyLimit(newLimit) {
            if (!currentCampaignId) return;

            const limit = parseInt(newLimit);
            if (isNaN(limit) || limit < 1 || limit > 500) {
                showToast('Limit musi być między 1 a 500');
                return;
            }

            try {
                const { error } = await supabaseClient
                    .from('outreach_campaigns')
                    .update({ daily_limit: limit })
                    .eq('id', currentCampaignId);

                if (error) throw error;

                // Update local data
                const campaign = campaigns.find(c => c.id === currentCampaignId);
                if (campaign) campaign.daily_limit = limit;

                showToast(`Dzienny limit zmieniony na ${limit}`);
            } catch (err) {
                showToast('Błąd zapisu: ' + err.message);
            }
        }

        // Manual trigger functions
        async function triggerSendNow() {
            if (!currentCampaignId) return;
            if (!confirm('Czy uruchomić wysyłkę teraz? Zostanie wysłany dzienny limit emaili.')) return;

            showToast('Uruchamiam wysyłkę...');

            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/outreach-send`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (result.success) {
                    showToast(`Wysłano ${result.sent} emaili`);
                    loadCampaignDetails(currentCampaignId);
                    loadCampaigns();
                } else {
                    showToast('Błąd: ' + (result.error || 'Nieznany błąd'));
                }
            } catch (err) {
                showToast('Błąd połączenia: ' + err.message);
            }
        }

        async function triggerFollowupNow() {
            if (!currentCampaignId) return;
            if (!confirm('Czy uruchomić follow-upy teraz? Zostaną wysłane zaległe follow-upy.')) return;

            showToast('Uruchamiam follow-upy...');

            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/outreach-followup`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (result.success) {
                    showToast(`Wysłano ${result.sent} follow-upów`);
                    loadCampaignDetails(currentCampaignId);
                    loadCampaigns();
                } else {
                    showToast('Błąd: ' + (result.error || 'Nieznany błąd'));
                }
            } catch (err) {
                showToast('Błąd połączenia: ' + err.message);
            }
        }

        // CSV Import functions
        function openImportModal() {
            document.getElementById('modal-import').classList.remove('hidden');
            document.getElementById('modal-import').classList.add('flex');
            csvData = [];
            document.getElementById('import-file').value = '';
            document.getElementById('import-source').value = '';
            document.getElementById('file-name').textContent = 'lub przeciągnij i upuść';
            document.getElementById('import-preview').classList.add('hidden');
            document.getElementById('btn-import').disabled = true;
        }

        function closeImportModal() {
            document.getElementById('modal-import').classList.add('hidden');
            document.getElementById('modal-import').classList.remove('flex');
            csvData = [];
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            document.getElementById('file-name').textContent = file.name;

            const reader = new FileReader();
            reader.onload = (e) => {
                parseCSV(e.target.result);
            };
            reader.readAsText(file);
        }

        function parseCSV(content) {
            const lines = content.trim().split('\n');
            if (lines.length < 2) {
                showToast('Plik CSV jest pusty lub ma tylko nagłówek');
                return;
            }

            const headers = lines[0].split(',').map(h => h.trim().toLowerCase().replace(/"/g, ''));
            const emailIndex = headers.indexOf('email');

            if (emailIndex === -1) {
                showToast('Brak kolumny "email" w pliku CSV');
                return;
            }

            csvData = [];
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length === 0) continue;

                const row = {};
                headers.forEach((h, idx) => {
                    row[h] = values[idx] || null;
                });

                // Validate email
                if (row.email && row.email.includes('@')) {
                    csvData.push(row);
                }
            }

            // Show preview
            if (csvData.length > 0) {
                const previewHead = document.getElementById('import-preview-head');
                const previewBody = document.getElementById('import-preview-body');

                previewHead.innerHTML = `<tr class="text-zinc-500">${headers.slice(0, 5).map(h => `<th class="pr-4 pb-1">${h}</th>`).join('')}</tr>`;
                previewBody.innerHTML = csvData.slice(0, 5).map(row => `
                    <tr class="text-zinc-400">
                        ${headers.slice(0, 5).map(h => `<td class="pr-4 py-1">${row[h] || '-'}</td>`).join('')}
                    </tr>
                `).join('');

                document.getElementById('import-total').textContent = `Znaleziono ${csvData.length} kontaktów z poprawnymi emailami`;
                document.getElementById('import-preview').classList.remove('hidden');
                document.getElementById('btn-import').disabled = false;
            } else {
                showToast('Nie znaleziono poprawnych kontaktów w pliku');
            }
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());

            return result;
        }

        async function importContacts() {
            const source = document.getElementById('import-source').value.trim();
            if (!source) {
                showToast('Podaj nazwę źródła');
                return;
            }

            if (csvData.length === 0) {
                showToast('Brak danych do importu');
                return;
            }

            document.getElementById('btn-import').disabled = true;
            document.getElementById('btn-import').innerHTML = '<i class="ph ph-circle-notch animate-spin mr-1"></i> Importuję...';

            const contacts = csvData.map(row => ({
                email: row.email?.toLowerCase().trim(),
                phone: row.phone || null,
                ltv_pln: row.ltv_pln ? parseFloat(row.ltv_pln) : null,
                transaction_count: row.transaction_count ? parseInt(row.transaction_count) : null,
                refunded_total_pln: row.refunded_total_pln ? parseFloat(row.refunded_total_pln) : null,
                first_purchase: row.first_purchase || null,
                last_purchase: row.last_purchase || null,
                unique_products: row.unique_products ? parseInt(row.unique_products) : null,
                products: row.products ? row.products.split(';').map(p => p.trim()) : null,
                source: source
            }));

            // Upsert in batches
            const BATCH = 500;
            let imported = 0;
            let errors = 0;

            for (let i = 0; i < contacts.length; i += BATCH) {
                const batch = contacts.slice(i, i + BATCH);
                const { data, error } = await supabaseClient
                    .from('outreach_contacts')
                    .upsert(batch, {
                        onConflict: 'email,source',
                        ignoreDuplicates: false
                    });

                if (error) {
                    console.error('Batch error:', error);
                    errors += batch.length;
                } else {
                    imported += batch.length;
                }
            }

            document.getElementById('btn-import').disabled = false;
            document.getElementById('btn-import').innerHTML = '<i class="ph ph-upload-simple mr-1"></i> Importuj';

            if (errors > 0) {
                showToast(`Zaimportowano ${imported} kontaktów (${errors} błędów)`);
            } else {
                showToast(`Zaimportowano ${imported} kontaktów`);
            }

            closeImportModal();
            loadContacts();
            loadSources();
        }

        // Toast
        function showToast(message) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-message').textContent = message;
            toast.classList.remove('translate-y-20', 'opacity-0');
            toast.classList.add('translate-y-0', 'opacity-100');

            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
                toast.classList.remove('translate-y-0', 'opacity-100');
            }, 3000);
        }

        // ===============================================
        // WHATSAPP CAMPAIGNS FUNCTIONS
        // ===============================================

        const WA_FILTERS_STORAGE_KEY = 'wa_saved_filters';

        // Get current filter state
        function getCurrentFilters() {
            return {
                product: document.getElementById('wa-filter-product').value.trim(),
                ltvMin: document.getElementById('wa-filter-ltv-min').value,
                ltvMax: document.getElementById('wa-filter-ltv-max').value,
                recency: document.getElementById('wa-filter-recency').value,
                products: document.getElementById('wa-filter-products').value,
                whatsapp: document.getElementById('wa-filter-whatsapp').value,
                source: document.getElementById('wa-filter-source').value,
                sort: document.getElementById('wa-sort').value
            };
        }

        // Check if any filter is active
        function hasActiveFilters() {
            const f = getCurrentFilters();
            return f.product || f.ltvMin || f.ltvMax || f.recency || f.products || f.whatsapp || f.source;
        }

        // Update visibility of save/reset buttons
        function updateFilterButtons() {
            const hasFilters = hasActiveFilters();
            document.getElementById('wa-btn-save-filter').classList.toggle('hidden', !hasFilters);
            document.getElementById('wa-reset-filters').classList.toggle('hidden', !hasFilters);
        }

        // Reset all filters
        function resetWaFilters() {
            document.getElementById('wa-search').value = '';
            document.getElementById('wa-filter-product').value = '';
            document.getElementById('wa-filter-ltv-min').value = '';
            document.getElementById('wa-filter-ltv-max').value = '';
            document.getElementById('wa-filter-recency').value = '';
            document.getElementById('wa-filter-products').value = '';
            document.getElementById('wa-filter-whatsapp').value = '';
            document.getElementById('wa-filter-source').value = '';
            document.getElementById('wa-sort').value = 'ltv_desc';
            waCurrentPage = 1;
            updateFilterButtons();
            renderSavedFilters();
            loadWaContacts();
        }

        // Load saved filters from localStorage
        function getSavedFilters() {
            try {
                return JSON.parse(localStorage.getItem(WA_FILTERS_STORAGE_KEY)) || [];
            } catch {
                return [];
            }
        }

        // Save filters to localStorage
        function setSavedFilters(filters) {
            localStorage.setItem(WA_FILTERS_STORAGE_KEY, JSON.stringify(filters));
        }

        // Render saved filters as buttons
        function renderSavedFilters() {
            const container = document.getElementById('wa-saved-filters');
            const saved = getSavedFilters();
            const currentFilters = JSON.stringify(getCurrentFilters());

            if (saved.length === 0) {
                container.innerHTML = '<span class="text-xs text-zinc-600 italic">Brak zapisanych filtrów</span>';
                return;
            }

            container.innerHTML = saved.map((f, idx) => {
                const isActive = JSON.stringify(f.filters) === currentFilters;
                const activeClass = isActive
                    ? 'bg-emerald-500/20 text-emerald-400 border-emerald-500/40 shadow-emerald-500/10 shadow-sm'
                    : 'bg-zinc-800/80 text-zinc-300 border-zinc-700 hover:bg-zinc-700 hover:border-zinc-600';
                return `
                    <div class="group flex items-center border rounded-lg overflow-hidden ${activeClass}">
                        <button onclick="applySavedFilter(${idx})" class="flex items-center gap-2 px-3 py-1.5 text-xs font-medium transition-colors">
                            <i class="ph ph-funnel text-[11px] ${isActive ? 'text-emerald-400' : 'text-zinc-500'}"></i>
                            <span>${f.name}</span>
                        </button>
                        <button onclick="deleteSavedFilter(${idx})" class="px-2 py-1.5 border-l ${isActive ? 'border-emerald-500/30 text-emerald-400/60 hover:text-red-400 hover:bg-red-500/10' : 'border-zinc-700 text-zinc-500 hover:text-red-400 hover:bg-red-500/10'} transition-colors" title="Usuń filtr">
                            <i class="ph ph-x text-[10px]"></i>
                        </button>
                    </div>
                `;
            }).join('');
        }

        // Apply a saved filter
        function applySavedFilter(index) {
            const saved = getSavedFilters();
            if (!saved[index]) return;

            const f = saved[index].filters;
            document.getElementById('wa-filter-product').value = f.product || '';
            document.getElementById('wa-filter-ltv-min').value = f.ltvMin || '';
            document.getElementById('wa-filter-ltv-max').value = f.ltvMax || '';
            document.getElementById('wa-filter-recency').value = f.recency || '';
            document.getElementById('wa-filter-products').value = f.products || '';
            document.getElementById('wa-filter-whatsapp').value = f.whatsapp || '';
            document.getElementById('wa-filter-source').value = f.source || '';
            document.getElementById('wa-sort').value = f.sort || 'ltv_desc';

            waCurrentPage = 1;
            updateFilterButtons();
            renderSavedFilters();
            loadWaContacts();
        }

        // Delete filter state
        let deleteFilterIndex = null;

        // Delete a saved filter - show confirmation modal
        function deleteSavedFilter(index) {
            const saved = getSavedFilters();
            if (!saved[index]) return;

            deleteFilterIndex = index;
            document.getElementById('delete-filter-name').textContent = `"${saved[index].name}"`;
            document.getElementById('modal-delete-filter').classList.remove('hidden');
            document.getElementById('modal-delete-filter').classList.add('flex');
        }

        // Close delete confirmation modal
        function closeDeleteFilterModal() {
            document.getElementById('modal-delete-filter').classList.add('hidden');
            document.getElementById('modal-delete-filter').classList.remove('flex');
            deleteFilterIndex = null;
        }

        // Confirm and execute filter deletion
        function confirmDeleteFilter() {
            if (deleteFilterIndex === null) return;

            const saved = getSavedFilters();
            const filterName = saved[deleteFilterIndex]?.name;
            saved.splice(deleteFilterIndex, 1);
            setSavedFilters(saved);

            closeDeleteFilterModal();
            renderSavedFilters();
            showToast(`Filtr "${filterName}" usunięty`);
        }

        // Open save filter modal
        function openSaveFilterModal() {
            document.getElementById('modal-save-filter').classList.remove('hidden');
            document.getElementById('modal-save-filter').classList.add('flex');
            document.getElementById('filter-name-input').value = '';
            document.getElementById('filter-name-input').focus();
        }

        // Close save filter modal
        function closeSaveFilterModal() {
            document.getElementById('modal-save-filter').classList.add('hidden');
            document.getElementById('modal-save-filter').classList.remove('flex');
        }

        // Save current filter with name
        function saveCurrentFilter() {
            const name = document.getElementById('filter-name-input').value.trim();
            if (!name) {
                showToast('Podaj nazwę filtra');
                return;
            }

            const saved = getSavedFilters();
            saved.push({
                name: name,
                filters: getCurrentFilters()
            });
            setSavedFilters(saved);

            closeSaveFilterModal();
            renderSavedFilters();
            showToast(`Filtr "${name}" zapisany`);
        }

        // =============================================
        // MESSAGE TEMPLATES
        // =============================================

        function toggleTemplatesPanel() {
            templatesPanelOpen = !templatesPanelOpen;
            updateTemplatesPanelState();
            localStorage.setItem('templatesPanelOpen', templatesPanelOpen);
        }

        function openTemplatesPanel() {
            templatesPanelOpen = true;
            updateTemplatesPanelState();
            localStorage.setItem('templatesPanelOpen', 'true');
        }

        function closeTemplatesPanel() {
            templatesPanelOpen = false;
            updateTemplatesPanelState();
            localStorage.setItem('templatesPanelOpen', 'false');
        }

        function updateTemplatesPanelState() {
            const panel = document.getElementById('templates-panel');
            const backdrop = document.getElementById('templates-panel-backdrop');
            const btn = document.getElementById('btn-templates-panel');

            panel.classList.toggle('open', templatesPanelOpen);
            backdrop.classList.toggle('open', templatesPanelOpen);

            if (btn) {
                btn.classList.toggle('bg-emerald-500/20', templatesPanelOpen);
                btn.classList.toggle('border-emerald-500/30', templatesPanelOpen);
                btn.classList.toggle('text-emerald-400', templatesPanelOpen);
                btn.classList.toggle('bg-zinc-800', !templatesPanelOpen);
                btn.classList.toggle('border-zinc-700', !templatesPanelOpen);
                btn.classList.toggle('text-zinc-300', !templatesPanelOpen);
            }
        }

        async function loadTemplates() {
            const { data, error } = await supabaseClient
                .from('message_templates')
                .select('*, created_by_member:team_members!created_by(name)')
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error loading templates:', error);
                return;
            }

            messageTemplates = data || [];
            document.getElementById('templates-count').textContent = `(${messageTemplates.length})`;
            renderTemplates();
        }

        const CATEGORY_LABELS = {
            'general': 'Ogólne',
            'intro': 'Pierwszy kontakt',
            'followup': 'Follow-up',
            'reactivation': 'Reaktywacja',
            'promo': 'Promocje'
        };

        const CATEGORY_COLORS = {
            'general': 'bg-zinc-600',
            'intro': 'bg-blue-500',
            'followup': 'bg-amber-500',
            'reactivation': 'bg-purple-500',
            'promo': 'bg-pink-500'
        };

        function renderTemplates() {
            const container = document.getElementById('templates-list');

            if (messageTemplates.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <div class="w-12 h-12 rounded-full bg-zinc-800 flex items-center justify-center mx-auto mb-3">
                            <i class="ph ph-chat-text text-xl text-zinc-600"></i>
                        </div>
                        <p class="text-xs text-zinc-500 mb-1">Brak szablonów</p>
                        <p class="text-[10px] text-zinc-600">Kliknij "Nowy szablon" aby dodać pierwszy</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = messageTemplates.map(t => `
                <div class="bg-zinc-800/50 border border-zinc-700 rounded-lg p-3 group hover:border-zinc-600 transition-colors">
                    <div class="flex items-start justify-between gap-2 mb-2">
                        <div class="flex items-center gap-2 min-w-0 flex-wrap">
                            <span class="px-1.5 py-0.5 text-[9px] uppercase tracking-wider font-medium rounded ${CATEGORY_COLORS[t.category] || 'bg-zinc-600'} text-white shrink-0">${CATEGORY_LABELS[t.category] || t.category}</span>
                            <span class="text-sm font-medium text-white truncate">${escapeHtml(t.name)}</span>
                        </div>
                        <div class="flex items-center gap-0.5 shrink-0">
                            <button onclick="editTemplate('${t.id}')" class="p-1.5 text-zinc-500 hover:text-white hover:bg-zinc-700 rounded transition-colors" title="Edytuj">
                                <i class="ph ph-pencil-simple text-sm"></i>
                            </button>
                            <button onclick="deleteTemplate('${t.id}', '${escapeHtml(t.name).replace(/'/g, "\\'")}'); event.stopPropagation();" class="p-1.5 text-zinc-500 hover:text-red-400 hover:bg-red-500/10 rounded transition-colors" title="Usuń">
                                <i class="ph ph-trash text-sm"></i>
                            </button>
                        </div>
                    </div>
                    <p class="text-xs text-zinc-400 line-clamp-3 mb-3 leading-relaxed">${escapeHtml(t.content)}</p>
                    <button onclick="copyTemplate('${t.id}')" class="w-full px-3 py-2 bg-emerald-500/10 hover:bg-emerald-500/20 text-emerald-400 rounded-lg text-xs font-medium transition-colors flex items-center justify-center gap-1.5 border border-emerald-500/20">
                        <i class="ph ph-copy"></i>
                        Kopiuj do schowka
                    </button>
                </div>
            `).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function copyTemplate(id) {
            const template = messageTemplates.find(t => t.id === id);
            if (!template) return;

            try {
                await navigator.clipboard.writeText(template.content);
                showToast('Skopiowano do schowka');
            } catch (err) {
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = template.content;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showToast('Skopiowano do schowka');
            }
        }

        function openTemplateModal(templateId = null) {
            document.getElementById('template-id').value = templateId || '';
            document.getElementById('template-modal-title').textContent = templateId ? 'Edytuj szablon' : 'Nowy szablon';

            if (templateId) {
                const template = messageTemplates.find(t => t.id === templateId);
                if (template) {
                    document.getElementById('template-name').value = template.name;
                    document.getElementById('template-category').value = template.category;
                    document.getElementById('template-content').value = template.content;
                }
            } else {
                document.getElementById('template-name').value = '';
                document.getElementById('template-category').value = 'general';
                document.getElementById('template-content').value = '';
            }

            document.getElementById('modal-template').classList.remove('hidden');
            document.getElementById('modal-template').classList.add('flex');
            document.getElementById('template-name').focus();
        }

        function closeTemplateModal() {
            document.getElementById('modal-template').classList.add('hidden');
            document.getElementById('modal-template').classList.remove('flex');
        }

        function editTemplate(id) {
            openTemplateModal(id);
        }

        async function saveTemplate() {
            const id = document.getElementById('template-id').value;
            const name = document.getElementById('template-name').value.trim();
            const category = document.getElementById('template-category').value;
            const content = document.getElementById('template-content').value.trim();

            if (!name || !content) {
                showToast('Wypełnij wszystkie pola');
                return;
            }

            const templateData = {
                name,
                category,
                content
            };

            let error;
            if (id) {
                // Update existing
                const result = await supabaseClient
                    .from('message_templates')
                    .update(templateData)
                    .eq('id', id);
                error = result.error;
            } else {
                // Create new
                templateData.created_by = currentTeamMember?.id || null;
                const result = await supabaseClient
                    .from('message_templates')
                    .insert(templateData);
                error = result.error;
            }

            if (error) {
                console.error('Error saving template:', error);
                showToast('Błąd zapisu szablonu');
                return;
            }

            closeTemplateModal();
            await loadTemplates();
            showToast(id ? 'Szablon zaktualizowany' : 'Szablon utworzony');
        }

        function deleteTemplate(id, name) {
            deleteTemplateId = id;
            document.getElementById('delete-template-name').textContent = `"${name}"`;
            document.getElementById('modal-delete-template').classList.remove('hidden');
            document.getElementById('modal-delete-template').classList.add('flex');
        }

        function closeDeleteTemplateModal() {
            document.getElementById('modal-delete-template').classList.add('hidden');
            document.getElementById('modal-delete-template').classList.remove('flex');
            deleteTemplateId = null;
        }

        async function confirmDeleteTemplate() {
            if (!deleteTemplateId) return;

            const { error } = await supabaseClient
                .from('message_templates')
                .delete()
                .eq('id', deleteTemplateId);

            if (error) {
                console.error('Error deleting template:', error);
                showToast('Błąd usuwania szablonu');
                return;
            }

            closeDeleteTemplateModal();
            await loadTemplates();
            showToast('Szablon usunięty');
        }

        // =============================================
        // WHATSAPP CONTACTS
        // =============================================

        async function loadWaContacts() {
            const search = document.getElementById('wa-search').value.trim().toLowerCase();
            const productFilter = document.getElementById('wa-filter-product').value.trim();
            const ltvMin = document.getElementById('wa-filter-ltv-min').value;
            const ltvMax = document.getElementById('wa-filter-ltv-max').value;
            const recencyFilter = document.getElementById('wa-filter-recency').value;
            const productsCountFilter = document.getElementById('wa-filter-products').value;
            const whatsappFilter = document.getElementById('wa-filter-whatsapp').value;
            const sourceFilter = document.getElementById('wa-filter-source').value;
            const sortValue = document.getElementById('wa-sort').value;

            // Parse sort
            let orderColumn = 'ltv_pln';
            let orderAsc = false;
            switch (sortValue) {
                case 'ltv_asc': orderColumn = 'ltv_pln'; orderAsc = true; break;
                case 'ltv_desc': orderColumn = 'ltv_pln'; orderAsc = false; break;
                case 'last_purchase_desc': orderColumn = 'last_purchase'; orderAsc = false; break;
                case 'last_purchase_asc': orderColumn = 'last_purchase'; orderAsc = true; break;
                case 'first_purchase_desc': orderColumn = 'first_purchase'; orderAsc = false; break;
                case 'products_desc': orderColumn = 'unique_products'; orderAsc = false; break;
            }

            // Build query - only contacts with phone, include contacted_by team member name
            let query = supabaseClient
                .from('outreach_contacts')
                .select('*, contacted_by:team_members!whatsapp_contacted_by(id, name)', { count: 'exact' })
                .not('phone', 'is', null)
                .order(orderColumn, { ascending: orderAsc, nullsFirst: false })
                .range((waCurrentPage - 1) * WA_PAGE_SIZE, waCurrentPage * WA_PAGE_SIZE - 1);

            // Search
            if (search) {
                query = query.or(`email.ilike.%${search}%,phone.ilike.%${search}%`);
            }

            // LTV filter (min/max)
            if (ltvMin) {
                query = query.gte('ltv_pln', parseInt(ltvMin));
            }
            if (ltvMax) {
                query = query.lte('ltv_pln', parseInt(ltvMax));
            }

            // Recency filter (last purchase)
            if (recencyFilter) {
                const now = new Date();
                if (recencyFilter.startsWith('old-')) {
                    const days = parseInt(recencyFilter.replace('old-', ''));
                    const cutoff = new Date(now.getTime() - days * 24 * 60 * 60 * 1000);
                    query = query.lt('last_purchase', cutoff.toISOString());
                } else {
                    const days = parseInt(recencyFilter);
                    const cutoff = new Date(now.getTime() - days * 24 * 60 * 60 * 1000);
                    query = query.gte('last_purchase', cutoff.toISOString());
                }
            }

            // Product name filter (search in products array)
            if (productFilter) {
                query = query.cs('products', [productFilter]);
            }

            // Products count filter
            if (productsCountFilter) {
                query = query.gte('unique_products', parseInt(productsCountFilter));
            }

            // WhatsApp filter
            if (whatsappFilter === 'pending') {
                query = query.is('whatsapp_contacted_at', null);
            } else if (whatsappFilter === 'contacted') {
                query = query.not('whatsapp_contacted_at', 'is', null);
            }

            // Source filter
            if (sourceFilter) {
                query = query.eq('source', sourceFilter);
            }

            const { data, count, error } = await query;

            if (error) {
                console.error('Error loading WhatsApp contacts:', error);
                return;
            }

            waContacts = data || [];
            waTotalContacts = count || 0;

            renderWaContacts();
            updateWaPagination();
            await loadWaStats();
        }

        async function loadWaStats() {
            // Get counts based on current filtered results
            const [pendingRes, contactedRes] = await Promise.all([
                supabaseClient.from('outreach_contacts').select('*', { count: 'exact', head: true }).not('phone', 'is', null).is('whatsapp_contacted_at', null),
                supabaseClient.from('outreach_contacts').select('*', { count: 'exact', head: true }).not('phone', 'is', null).not('whatsapp_contacted_at', 'is', null)
            ]);

            document.getElementById('wa-stat-pending').textContent = (pendingRes.count || 0).toLocaleString('pl-PL');
            document.getElementById('wa-stat-contacted').textContent = (contactedRes.count || 0).toLocaleString('pl-PL');
        }

        function renderWaContacts() {
            const tbody = document.getElementById('wa-contacts-table');

            if (waContacts.length === 0) {
                const hasFilters = hasActiveFilters() || document.getElementById('wa-search').value;

                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="px-4 py-16 text-center text-zinc-500">
                            <i class="ph ${hasFilters ? 'ph-funnel-simple' : 'ph-whatsapp-logo'} text-4xl mb-3 block"></i>
                            <p class="text-sm mb-1">${hasFilters ? 'Brak wyników dla wybranych filtrów' : 'Brak kontaktów z numerem telefonu'}</p>
                            ${hasFilters ? '<button onclick="resetWaFilters()" class="mt-3 px-4 py-2 bg-zinc-800 hover:bg-zinc-700 rounded-lg text-xs text-white transition-colors">Wyczyść filtry</button>' : ''}
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = waContacts.map(contact => {
                const hasWhatsApp = !!contact.whatsapp_contacted_at;

                return `
                    <tr class="border-b border-white/5 hover:bg-white/[0.02] transition-colors">
                        <td class="px-4 py-3">
                            <div class="font-mono text-xs text-white">${contact.email}</div>
                        </td>
                        <td class="px-4 py-3">
                            <span class="font-mono text-xs text-zinc-400">${contact.phone || '-'}</span>
                        </td>
                        <td class="px-4 py-3 text-right">
                            <span class="font-mono text-xs ${contact.ltv_pln > 10000 ? 'text-emerald-400' : contact.ltv_pln > 1000 ? 'text-white' : 'text-zinc-500'}">
                                ${contact.ltv_pln ? contact.ltv_pln.toLocaleString('pl-PL') + ' PLN' : '-'}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-zinc-500 text-xs">
                            ${contact.first_purchase ? new Date(contact.first_purchase).toLocaleDateString('pl-PL') : '-'}
                        </td>
                        <td class="px-4 py-3 text-zinc-500 text-xs">
                            ${contact.last_purchase ? new Date(contact.last_purchase).toLocaleDateString('pl-PL') : '-'}
                        </td>
                        <td class="px-4 py-3 text-center">
                            <span class="text-xs text-zinc-400">${contact.unique_products || 0}</span>
                        </td>
                        <td class="px-4 py-3">
                            ${hasWhatsApp
                                ? `<div class="flex flex-col gap-0.5">
                                    <span class="text-[10px] px-2 py-0.5 rounded bg-green-500/20 text-green-400 inline-flex items-center w-fit" title="${new Date(contact.whatsapp_contacted_at).toLocaleString('pl-PL')}">
                                        <i class="ph ph-check mr-1"></i>Skontaktowano
                                    </span>
                                    ${contact.contacted_by?.name ? `<span class="text-[10px] text-zinc-500 pl-2">${contact.contacted_by.name}</span>` : ''}
                                   </div>`
                                : '<span class="text-[10px] px-2 py-0.5 rounded bg-zinc-700 text-zinc-400">Do kontaktu</span>'
                            }
                        </td>
                        <td class="px-4 py-3">
                            <div class="flex items-center justify-center gap-2">
                                <button onclick="openWaContact('${contact.id}', '${contact.phone.replace(/'/g, "\\'")}')" class="px-3 py-1.5 bg-green-500/20 hover:bg-green-500/30 text-green-400 rounded-lg text-xs font-medium transition-colors">
                                    <i class="ph ph-whatsapp-logo mr-1"></i>
                                    Kontakt
                                </button>
                                <button onclick="addToPipeline('${contact.id}')" class="px-3 py-1.5 bg-indigo-500/20 hover:bg-indigo-500/30 text-indigo-400 rounded-lg text-xs font-medium transition-colors" title="Dodaj do pipeline jako lead">
                                    <i class="ph ph-kanban mr-1"></i>
                                    Pipeline
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function openWaContact(contactId, phone) {
            // Format phone for WhatsApp
            let cleaned = phone.replace(/[\s\-\(\)]/g, '').replace(/^\+?48/, '');
            window.open(`https://wa.me/48${cleaned}`, '_blank');

            // Update whatsapp_contacted_at and whatsapp_contacted_by in outreach_contacts
            const updateData = {
                whatsapp_contacted_at: new Date().toISOString(),
                whatsapp_contacted_by: currentTeamMember?.id || null
            };

            const { error } = await supabaseClient
                .from('outreach_contacts')
                .update(updateData)
                .eq('id', contactId);

            if (!error) {
                // Update local data
                const contact = waContacts.find(c => c.id === contactId);
                if (contact) {
                    contact.whatsapp_contacted_at = updateData.whatsapp_contacted_at;
                    contact.whatsapp_contacted_by = updateData.whatsapp_contacted_by;
                    contact.contacted_by_name = currentTeamMember?.name || null;
                }
                renderWaContacts();
                loadWaStats();
                showToast('Oznaczono jako skontaktowany');
            }
        }

        async function addToPipeline(contactId) {
            const contact = waContacts.find(c => c.id === contactId);
            if (!contact) {
                showToast('Nie znaleziono kontaktu');
                return;
            }

            // Check if lead with this email already exists
            const { data: existingLead } = await supabaseClient
                .from('leads')
                .select('id')
                .eq('email', contact.email)
                .maybeSingle();

            if (existingLead) {
                showToast('Lead z tym emailem już istnieje w CRM');
                window.open(Sidebar.getPagePath('lead') + '?id=' + existingLead.id, '_blank');
                return;
            }

            // Create lead with status 'contacted'
            const leadData = {
                email: contact.email,
                phone: contact.phone,
                status: 'contacted',
                assigned_to: currentTeamMember?.id || null,
                notes: `Źródło: Kampania WhatsApp\nLTV: ${contact.ltv_pln ? contact.ltv_pln.toLocaleString('pl-PL') + ' PLN' : '-'}\nProdukty: ${contact.unique_products || 0}`
            };

            const { data, error } = await supabaseClient
                .from('leads')
                .insert([leadData])
                .select();

            if (error) {
                showToast('Błąd: ' + error.message);
                return;
            }

            showToast('Dodano do pipeline jako Skontaktowany');

            // Open new lead in new tab
            if (data && data[0]) {
                window.open(Sidebar.getPagePath('lead') + '?id=' + data[0].id, '_blank');
            }
        }

        function updateWaPagination() {
            const totalPages = Math.ceil(waTotalContacts / WA_PAGE_SIZE) || 1;
            const formattedTotal = waTotalContacts.toLocaleString('pl-PL');
            document.getElementById('wa-pagination-info').textContent = `Strona ${waCurrentPage} z ${totalPages} (${formattedTotal} kontaktów)`;
            document.getElementById('wa-btn-prev').disabled = waCurrentPage <= 1;
            document.getElementById('wa-btn-next').disabled = waCurrentPage >= totalPages;
        }

        function waContactsPrevPage() {
            if (waCurrentPage > 1) {
                waCurrentPage--;
                loadWaContacts();
            }
        }

        function waContactsNextPage() {
            const totalPages = Math.ceil(waTotalContacts / WA_PAGE_SIZE);
            if (waCurrentPage < totalPages) {
                waCurrentPage++;
                loadWaContacts();
            }
        }

        // Event listeners
        document.getElementById('search-input').addEventListener('input', debounce(() => {
            currentPage = 1;
            loadContacts();
        }, 300));

        document.getElementById('filter-source').addEventListener('change', () => {
            currentPage = 1;
            loadContacts();
        });

        document.getElementById('filter-ltv').addEventListener('change', () => {
            currentPage = 1;
            loadContacts();
        });

        document.getElementById('filter-products').addEventListener('change', () => {
            currentPage = 1;
            loadContacts();
        });

        document.getElementById('campaign-filter-source').addEventListener('change', updateMatchingContacts);
        document.getElementById('campaign-filter-ltv').addEventListener('input', debounce(updateMatchingContacts, 300));

        // WhatsApp event listeners
        document.getElementById('wa-search').addEventListener('input', debounce(() => {
            waCurrentPage = 1;
            loadWaContacts();
        }, 300));

        // Filter change handler
        function onWaFilterChange() {
            waCurrentPage = 1;
            updateFilterButtons();
            renderSavedFilters();
            loadWaContacts();
        }

        document.getElementById('wa-filter-product').addEventListener('input', debounce(onWaFilterChange, 500));
        document.getElementById('wa-filter-ltv-min').addEventListener('input', debounce(onWaFilterChange, 500));
        document.getElementById('wa-filter-ltv-max').addEventListener('input', debounce(onWaFilterChange, 500));
        document.getElementById('wa-filter-recency').addEventListener('change', onWaFilterChange);
        document.getElementById('wa-filter-products').addEventListener('change', onWaFilterChange);
        document.getElementById('wa-filter-whatsapp').addEventListener('change', onWaFilterChange);
        document.getElementById('wa-filter-source').addEventListener('change', onWaFilterChange);

        document.getElementById('wa-sort').addEventListener('change', () => {
            waCurrentPage = 1;
            renderSavedFilters();
            loadWaContacts();
        });

        function debounce(fn, delay) {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => fn(...args), delay);
            };
        }

        // Init
        async function init() {
            Sidebar.render();
            Sidebar.setupLogout(supabaseClient);

            const session = await checkAuth();
            if (!session) return;

            await loadSources();
            await loadContacts();
            await loadCampaigns();

            // Setup keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                // Close templates panel with Escape
                if (e.key === 'Escape' && templatesPanelOpen) {
                    closeTemplatesPanel();
                }
            });
        }

        init();

        // Register service worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').catch(() => {});
        }
    </script>
</body>
</html>
