<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oferta startowa</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    }
                }
            }
        }
    </script>
    <style>
        body { background: #000; color: #ededed; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::selection { background: white; color: black; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-enter { animation: fadeIn 0.5s ease-out forwards; }

        .input-field {
            background: #0a0a0a;
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.2s;
        }
        .input-field:focus {
            border-color: rgba(16, 185, 129, 0.5);
            outline: none;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.15);
        }

        .glass-card {
            background: rgba(24, 24, 27, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        /* Hero gradient */
        .hero-gradient {
            background: radial-gradient(ellipse 80% 50% at 50% -20%, rgba(16, 185, 129, 0.15), transparent);
        }

        /* Timeline */
        .timeline-item {
            position: relative;
            padding-left: 3.5rem;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 0.875rem; /* Center of 1.75rem dot */
            top: 2.25rem;
            bottom: -2rem;
            width: 2px;
            background: linear-gradient(to bottom, rgba(255,255,255,0.08), transparent);
        }
        .timeline-item:last-child::before {
            display: none;
        }
        .timeline-dot {
            position: absolute;
            left: 0;
            top: 0.5rem;
            width: 1.75rem;
            height: 1.75rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.75rem;
        }
        @media (max-width: 640px) {
            .timeline-item {
                padding-left: 2.5rem;
            }
            .timeline-item::before {
                left: 0.625rem;
            }
            .timeline-dot {
                width: 1.5rem;
                height: 1.5rem;
                font-size: 0.625rem;
                top: 0.625rem;
            }
        }

        /* Cards */
        .card {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 16px;
            transition: all 0.3s ease;
        }
        .card:hover {
            border-color: rgba(255, 255, 255, 0.12);
            transform: translateY(-2px);
        }


        /* Fade in on scroll */
        .fade-in {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.6s ease, transform 0.6s ease;
        }
        .fade-in.visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* Glow effect */
        .glow {
            box-shadow: 0 0 60px rgba(16, 185, 129, 0.15);
        }

        /* Sticky Header */
        .sticky-header {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            background: rgba(0, 0, 0, 0.95);
            border-top: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 -4px 24px rgba(0, 0, 0, 0.4);
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }
        .sticky-header.visible {
            transform: translateY(0);
        }

        /* WhatsApp Widget */
        .whatsapp-widget {
            position: fixed;
            bottom: 24px;
            left: 24px;
            z-index: 1000;
        }
        .whatsapp-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
            box-shadow: 0 4px 15px rgba(37, 211, 102, 0.4);
            transition: all 0.3s ease;
            text-decoration: none;
        }
        .whatsapp-btn:hover {
            transform: scale(1.1) translateY(-2px);
            box-shadow: 0 8px 25px rgba(37, 211, 102, 0.5);
        }
        .whatsapp-btn svg {
            width: 28px;
            height: 28px;
            fill: #fff;
        }
        @media (max-width: 640px) {
            .whatsapp-widget {
                bottom: 120px; /* Above sticky header */
                left: 16px;
            }
            .whatsapp-btn {
                width: 48px;
                height: 48px;
            }
            .whatsapp-btn svg {
                width: 24px;
                height: 24px;
            }
        }
    </style>
</head>
<body class="min-h-screen font-sans text-sm tracking-tight antialiased">

    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center px-4">
        <div class="w-full max-w-md animate-enter">
            <div class="text-center mb-8">
                <div class="w-14 h-14 bg-emerald-500 text-white rounded-xl flex items-center justify-center mx-auto mb-4 shadow-[0_0_30px_rgba(16,185,129,0.2)]">
                    <i class="ph-bold ph-rocket text-2xl"></i>
                </div>
                <h1 class="text-2xl font-bold text-white mb-2">Oferta startowa</h1>
                <p class="text-zinc-400">Wprowadź swój adres e-mail, aby zobaczyć szczegóły</p>
            </div>

            <div class="glass-card rounded-2xl border border-white/10 p-6">
                <div class="mb-4">
                    <label class="block text-zinc-400 text-xs font-medium mb-2">Adres e-mail</label>
                    <input type="email" id="email-input"
                           class="input-field w-full rounded-xl px-4 py-3 text-white text-base"
                           placeholder="jan@firma.pl"
                           autofocus>
                </div>
                <div id="login-error" class="text-red-400 text-sm mb-4 hidden"></div>
                <button id="login-btn"
                        class="w-full bg-emerald-500 hover:bg-emerald-400 text-white px-4 py-3 rounded-xl font-semibold transition-colors flex items-center justify-center gap-2">
                    <span>Zobacz ofertę</span>
                    <i class="ph ph-arrow-right"></i>
                </button>
            </div>

            <p class="text-center text-zinc-600 text-xs mt-6">
                Link jest ważny do: <span id="valid-until-preview" class="text-zinc-400">-</span>
            </p>
        </div>
    </div>

    <!-- Expired Screen -->
    <div id="expired-screen" class="hidden min-h-screen flex items-center justify-center px-4">
        <div class="text-center animate-enter">
            <div class="w-16 h-16 bg-zinc-800 rounded-2xl flex items-center justify-center mx-auto mb-6">
                <i class="ph ph-clock-countdown text-3xl text-zinc-500"></i>
            </div>
            <h1 class="text-2xl font-bold text-white mb-3">Oferta wygasła</h1>
            <p class="text-zinc-400 mb-6">Ta oferta nie jest już dostępna.</p>
            <p class="text-zinc-500 text-sm">Skontaktuj się z nami, aby otrzymać nową ofertę.</p>
        </div>
    </div>

    <!-- Not Found Screen -->
    <div id="not-found-screen" class="hidden min-h-screen flex items-center justify-center px-4">
        <div class="text-center animate-enter">
            <div class="w-16 h-16 bg-zinc-800 rounded-2xl flex items-center justify-center mx-auto mb-6">
                <i class="ph ph-question text-3xl text-zinc-500"></i>
            </div>
            <h1 class="text-2xl font-bold text-white mb-3">Nie znaleziono oferty</h1>
            <p class="text-zinc-400">Sprawdź poprawność linku lub skontaktuj się z nami.</p>
        </div>
    </div>

    <!-- Offer Screen -->
    <div id="offer-screen" class="hidden min-h-screen pb-20 sm:pb-8">

        <!-- Hero Section -->
        <div class="hero-gradient border-b border-white/5">
            <div class="max-w-6xl mx-auto px-4 sm:px-6 py-10 sm:py-16">
                <div class="grid md:grid-cols-[1.5fr,1fr] gap-8 md:gap-12 items-center">

                    <!-- Left: Content -->
                    <div class="animate-enter">
                        <div class="inline-flex items-center gap-2 bg-emerald-500/10 text-emerald-400 px-3 py-1.5 rounded-full text-xs font-medium mb-6 border border-emerald-500/20">
                            <i class="ph ph-storefront text-sm"></i>
                            <span>Pakiet Start</span>
                        </div>

                        <h1 class="text-2xl sm:text-3xl font-bold text-white mb-3 leading-snug">
                            Nowoczesny sklep internetowy<br>
                            <span class="text-zinc-400 font-normal text-xl sm:text-2xl">od Tomka Niedźwieckiego</span>
                        </h1>

                        <div class="flex flex-wrap items-center gap-3 text-sm sm:text-xs text-zinc-500 mb-6">
                            <span class="flex items-center gap-1">
                                <i class="ph ph-buildings text-emerald-400"></i>
                                3 firmy
                            </span>
                            <span class="text-zinc-700">•</span>
                            <span class="flex items-center gap-1">
                                <i class="ph ph-chart-line text-emerald-400"></i>
                                70 mln obrotu
                            </span>
                            <span class="text-zinc-700">•</span>
                            <span class="flex items-center gap-1">
                                <i class="ph ph-clock text-emerald-400"></i>
                                15 lat
                            </span>
                        </div>

                        <div class="inline-flex items-center gap-2 bg-white/5 border border-white/10 rounded-lg px-3 sm:px-4 py-2.5 sm:py-2">
                            <i class="ph ph-user text-zinc-500 text-xs sm:text-sm"></i>
                            <span class="text-zinc-500 text-xs sm:text-sm">Oferta dla:</span>
                            <span class="text-white font-medium text-xs sm:text-sm" id="client-name">-</span>
                        </div>
                    </div>

                    <!-- Right: Price Card -->
                    <div class="card p-6 sm:p-8 animate-enter" style="animation-delay: 0.1s">
                        <div class="text-center mb-6">
                            <div class="flex items-baseline justify-center gap-2 mb-1">
                                <span class="text-4xl sm:text-5xl font-bold text-white font-mono" id="offer-price">-</span>
                                <span class="text-zinc-500">PLN</span>
                            </div>
                            <p class="text-xs text-zinc-500 mb-4">
                                lub <span class="text-emerald-400 font-semibold" id="offer-price-monthly">-</span> PLN/msc × 10 rat 0%
                            </p>
                            <div class="h-px bg-gradient-to-r from-transparent via-white/10 to-transparent mb-6"></div>
                        </div>

                        <div class="space-y-3">
                            <button onclick="goToCheckout()"
                                    class="w-full bg-emerald-500 hover:bg-emerald-400 text-white px-6 py-3.5 rounded-lg font-semibold transition-all flex items-center justify-center gap-2 glow">
                                <i class="ph ph-credit-card"></i>
                                Zamawiam teraz
                            </button>
                            <button onclick="downloadProforma()"
                                    class="w-full bg-white/5 hover:bg-white/10 border border-white/10 text-white px-6 py-3 rounded-lg font-medium transition-all flex items-center justify-center gap-2">
                                <i class="ph ph-file-pdf"></i>
                                Pobierz proformę
                            </button>
                        </div>

                        <p class="text-center text-zinc-600 text-xs mt-4">
                            <i class="ph ph-calendar-blank mr-1"></i>
                            Ważna do <span id="valid-until" class="text-zinc-500">-</span>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sticky Header (shows on scroll) -->
        <div class="sticky-header" id="sticky-header">
            <div class="max-w-6xl mx-auto px-4 sm:px-6 py-4">
                <!-- Desktop version -->
                <div class="hidden md:flex items-center justify-between gap-6">
                    <div class="flex items-center gap-4">
                        <div class="text-sm text-zinc-400">Pakiet Start</div>
                        <div class="w-px h-5 bg-white/10"></div>
                        <div class="flex items-baseline gap-2">
                            <span class="text-2xl font-bold text-white font-mono" id="sticky-price">-</span>
                            <span class="text-zinc-500 text-sm">PLN</span>
                        </div>
                        <span class="text-xs text-zinc-500">
                            lub <span class="text-emerald-400 font-semibold" id="sticky-price-monthly">-</span> PLN/msc × 10 rat 0%
                        </span>
                    </div>
                    <div class="flex items-center gap-3">
                        <button onclick="downloadProforma()"
                                class="bg-white/5 hover:bg-white/10 border border-white/10 text-white px-5 py-2.5 rounded-lg font-medium transition-all flex items-center gap-2 text-sm">
                            <i class="ph ph-file-pdf"></i>
                            Pobierz proformę
                        </button>
                        <button onclick="goToCheckout()"
                                class="bg-emerald-500 hover:bg-emerald-400 text-white px-5 py-2.5 rounded-lg font-semibold transition-all flex items-center gap-2 text-sm">
                            <i class="ph ph-credit-card"></i>
                            Zamawiam teraz
                        </button>
                    </div>
                </div>
                <!-- Mobile version -->
                <div class="md:hidden flex items-center justify-between gap-3">
                    <div class="flex flex-col gap-0.5">
                        <div class="flex items-baseline gap-1.5">
                            <span class="text-lg font-bold text-white font-mono" id="sticky-price-mobile">-</span>
                            <span class="text-xs text-zinc-500">PLN</span>
                        </div>
                        <span class="text-xs text-emerald-400" id="sticky-installments-mobile">-</span>
                    </div>
                    <button onclick="goToCheckout()"
                            class="bg-emerald-500 hover:bg-emerald-400 text-white px-5 py-3 rounded-lg font-semibold transition-all flex items-center gap-2 text-sm whitespace-nowrap flex-shrink-0">
                        <i class="ph ph-credit-card"></i>
                        Zamawiam
                    </button>
                </div>
            </div>
        </div>

        <!-- Content -->
        <div class="max-w-4xl mx-auto px-4 sm:px-6">

            <!-- What Tomek will do -->
            <section class="py-12 sm:py-16 fade-in">
                <div class="text-center mb-10">
                    <h2 class="text-2xl sm:text-3xl font-bold text-white mb-3">Co Tomek dla Ciebie zrobi</h2>
                </div>

                <div class="space-y-8">
                    <!-- Step 1 -->
                    <div class="timeline-item">
                        <div class="timeline-dot bg-gradient-to-br from-amber-500 to-orange-500 text-white">1</div>
                        <div class="card p-4 sm:p-6">
                            <div class="flex items-start gap-4">
                                <div class="hidden sm:flex w-12 h-12 rounded-xl bg-amber-500/10 items-center justify-center flex-shrink-0">
                                    <i class="ph ph-magnifying-glass text-2xl text-amber-400"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-white mb-2">Znajdzie dla Ciebie niszę i produkty</h3>
                                    <p class="text-zinc-400 leading-relaxed">
                                        <span class="text-white font-medium">Tomek przeanalizuje rynek</span> i wybierze dla Ciebie <span class="text-white font-medium">5 produktów</span>
                                        z rosnącym trendem i dużym potencjałem sprzedażowym.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2 -->
                    <div class="timeline-item">
                        <div class="timeline-dot bg-gradient-to-br from-violet-500 to-purple-500 text-white">2</div>
                        <div class="card p-4 sm:p-6">
                            <div class="flex items-start gap-4">
                                <div class="hidden sm:flex w-12 h-12 rounded-xl bg-violet-500/10 items-center justify-center flex-shrink-0">
                                    <i class="ph ph-chart-line-up text-2xl text-violet-400"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-white mb-2">Przygotuje strategię i raporty</h3>
                                    <p class="text-zinc-400 leading-relaxed">
                                        <span class="text-white font-medium">Dostaniesz 4 szczegółowe raporty</span> — analiza produktu,
                                        rynku, potencjału i gotowy plan na budowę marki.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3 -->
                    <div class="timeline-item">
                        <div class="timeline-dot bg-gradient-to-br from-cyan-500 to-blue-500 text-white">3</div>
                        <div class="card p-4 sm:p-6">
                            <div class="flex items-start gap-4">
                                <div class="hidden sm:flex w-12 h-12 rounded-xl bg-cyan-500/10 items-center justify-center flex-shrink-0">
                                    <i class="ph ph-palette text-2xl text-cyan-400"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-white mb-2">Zaprojektuje Twoją markę od podstaw</h3>
                                    <p class="text-zinc-400 leading-relaxed">
                                        <span class="text-white font-medium">Tomek stworzy kompletny branding</span> — logo, wizualizacje produktów,
                                        kolory, typografię i styl komunikacji. Wszystko gotowe do użycia.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 4 -->
                    <div class="timeline-item">
                        <div class="timeline-dot bg-gradient-to-br from-emerald-500 to-green-500 text-white">4</div>
                        <div class="card p-4 sm:p-6">
                            <div class="flex items-start gap-4">
                                <div class="hidden sm:flex w-12 h-12 rounded-xl bg-emerald-500/10 items-center justify-center flex-shrink-0">
                                    <i class="ph ph-browser text-2xl text-emerald-400"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-white mb-2">Zbuduje stronę sprzedażową</h3>
                                    <p class="text-zinc-400 leading-relaxed">
                                        <span class="text-white font-medium">Otrzymasz gotową stronę</span> wysokiej jakości,
                                        zoptymalizowaną pod sprzedaż — możesz od razu zacząć zarabiać.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Trust & Partnership Section -->
            <section class="py-12 fade-in">
                <!-- Satisfaction Guarantee Banner -->
                <div class="card p-5 sm:p-6 bg-gradient-to-r from-blue-500/10 via-blue-500/5 to-transparent border-blue-500/20 mb-6">
                    <div class="flex items-start gap-4">
                        <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-xl bg-blue-500/20 flex items-center justify-center flex-shrink-0">
                            <i class="ph-fill ph-shield-check text-xl sm:text-2xl text-blue-400"></i>
                        </div>
                        <div class="flex-1">
                            <h3 class="text-base sm:text-lg font-semibold text-white mb-2">Gwarancja satysfakcji</h3>
                            <p class="text-zinc-300 text-sm leading-relaxed mb-3">
                                Jeśli po przygotowaniu wszystkich materiałów uznasz, że <span class="text-white font-medium">nie jesteś w pełni zadowolony</span>
                                z jakości pracy lub z dowolnego innego powodu zdecydujesz się zrezygnować,
                                <span class="text-white font-medium">Tomek zwróci Ci całą wpłaconą kwotę</span>.
                            </p>
                            <div class="bg-white/5 border border-white/10 rounded-lg p-3">
                                <p class="text-zinc-400 text-xs leading-relaxed">
                                    <i class="ph ph-handshake text-blue-400 mr-1"></i>
                                    Pełne zadowolenie klienta to fundament długofalowej współpracy.
                                    Tomek pracuje wyłącznie z osobami, które są w 100% przekonane do wspólnego projektu.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Two column section -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Who -->
                    <div class="card p-6 sm:p-8 bg-gradient-to-br from-amber-500/5 to-transparent border-amber-500/20">
                        <div class="flex items-center gap-4 mb-5">
                            <img src="https://tomekniedzwiecki.pl/img/tn_kwadrat.png" alt="Tomek Niedzwiecki"
                                 class="w-14 h-14 sm:w-16 sm:h-16 rounded-2xl object-cover ring-2 ring-white/10">
                            <div>
                                <h3 class="text-lg font-semibold text-white">Tomek Niedzwiecki</h3>
                                <p class="text-zinc-500 text-sm">Przedsiębiorca, inwestor, twórca</p>
                            </div>
                        </div>
                        <p class="text-zinc-300 leading-relaxed mb-5">
                            Każdy etap wykonywany jest <span class="text-white font-semibold">bezpośrednio przez Tomka</span>.
                            Pełna transparentność i wgląd w każdy etap realizacji.
                        </p>
                        <div class="space-y-2">
                            <div class="flex items-center gap-2 text-amber-400 text-sm">
                                <i class="ph ph-check-circle"></i>
                                <span>Wgląd do panelu z postępami</span>
                            </div>
                            <div class="flex items-center gap-2 text-amber-400 text-sm">
                                <i class="ph ph-check-circle"></i>
                                <span>Kontakt przez komunikator i e-mail</span>
                            </div>
                            <div class="flex items-center gap-2 text-amber-400 text-sm">
                                <i class="ph ph-check-circle"></i>
                                <span>W razie potrzeby również telefonicznie</span>
                            </div>
                        </div>
                    </div>

                    <!-- Goal -->
                    <div class="card p-6 sm:p-8 bg-gradient-to-br from-emerald-500/5 to-transparent border-emerald-500/20">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="w-12 h-12 rounded-xl bg-emerald-500/10 flex items-center justify-center">
                                <i class="ph ph-target text-2xl text-emerald-400"></i>
                            </div>
                            <h3 class="text-lg font-semibold text-white">Docelowy plan</h3>
                        </div>
                        <p class="text-zinc-300 leading-relaxed mb-6">
                            <span class="text-white font-semibold">Tomek buduje</span> dla Ciebie biznes,
                            <span class="text-white font-semibold">wdraża Cię</span> w jego prowadzenie, a następnie
                            <span class="text-white font-semibold">możesz zostać wspólnikiem</span> — Tomek otrzymuje % udział w zyskach,
                            pozostając aktywnie zaangażowany w rozwój firmy.
                        </p>
                        <div class="space-y-2 mb-4">
                            <div class="flex items-center gap-2 text-emerald-400 text-sm">
                                <i class="ph ph-check-circle"></i>
                                <span>Długoterminowe partnerstwo</span>
                            </div>
                            <div class="flex items-center gap-2 text-emerald-400 text-sm">
                                <i class="ph ph-check-circle"></i>
                                <span>Wspólny rozwój biznesu</span>
                            </div>
                        </div>
                        <div class="bg-white/5 border border-white/10 rounded-lg p-3">
                            <p class="text-zinc-400 text-xs">
                                <i class="ph ph-handshake text-emerald-400 text-sm mr-1"></i>
                                Szczegóły współpracy i modelu partnerskiego ustalane indywidualnie
                            </p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Footer -->
            <footer class="border-t border-white/5 py-6 sm:py-8 text-center">
                <p class="text-zinc-600 text-sm">
                    Powered by <span class="text-zinc-400">TN Digital</span>
                </p>
            </footer>
        </div>

    </div>

    <!-- WhatsApp Widget -->
    <div class="whatsapp-widget" id="whatsapp-widget" style="display: none;">
        <a href="https://wa.me/48533308623?text=Cze%C5%9B%C4%87!%20Mam%20pytanie%20dotycz%C4%85ce%20oferty%20startowej." target="_blank" rel="noopener" class="whatsapp-btn" title="Napisz na WhatsApp">
            <svg viewBox="0 0 24 24">
                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
            </svg>
        </a>
    </div>

    <script>
        const SUPABASE_URL = 'https://yxmavwkwnfuphjqbelws.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl4bWF2d2t3bmZ1cGhqcWJlbHdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NjQyNTUsImV4cCI6MjA4NDM0MDI1NX0.XeR0Fc7OFn6YbNJrOKTBEj36JtmLISZTM87y4ai9340';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let clientOffer = null;
        let offer = null;
        let lead = null;

        function getToken() {
            // Try URL path first (Vercel rewrite: /offer-starter/token or /offer-starter?token=xxx)
            const path = window.location.pathname;
            const pathMatch = path.match(/\/offer-starter\/([a-zA-Z0-9]+)/);
            if (pathMatch) return pathMatch[1];

            // Fallback to query parameter
            const params = new URLSearchParams(window.location.search);
            return params.get('token');
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('pl-PL', { day: 'numeric', month: 'long', year: 'numeric' });
        }

        function formatPrice(price) {
            return new Intl.NumberFormat('pl-PL').format(price);
        }

        // Slack notification helper - fire and forget
        async function sendSlackNotification(type, data) {
            try {
                await fetch(`${SUPABASE_URL}/functions/v1/slack-notify`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify({ type, data })
                });
            } catch (err) {
                console.error('Slack notification error:', err);
            }
        }

        function showScreen(screenId) {
            ['login-screen', 'expired-screen', 'not-found-screen', 'offer-screen'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            // Show WhatsApp widget only on offer screen
            const whatsappWidget = document.getElementById('whatsapp-widget');
            if (whatsappWidget) {
                whatsappWidget.style.display = screenId === 'offer-screen' ? 'block' : 'none';
            }
            document.getElementById(screenId).classList.remove('hidden');
        }

        async function loadOffer() {
            const token = getToken();
            if (!token) {
                showScreen('not-found-screen');
                return;
            }

            // Fetch client offer
            const { data, error } = await supabaseClient
                .from('client_offers')
                .select('*, leads(*), offers(*)')
                .eq('unique_token', token)
                .single();

            if (error || !data) {
                showScreen('not-found-screen');
                return;
            }

            clientOffer = data;
            offer = data.offers;
            lead = data.leads;

            // Check if expired
            const validUntil = new Date(clientOffer.valid_until);
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            if (validUntil < today) {
                showScreen('expired-screen');
                return;
            }

            // Show validity date on login screen
            document.getElementById('valid-until-preview').textContent = formatDate(clientOffer.valid_until);

            // Check for cached email (localhost only, 30 min TTL)
            const isLocal = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
            if (isLocal) {
                const token = getToken();
                const cached = getCachedEmail(token);
                if (cached && cached === lead.email.toLowerCase()) {
                    renderOffer();
                    showScreen('offer-screen');
                    return;
                }
            }

            // Show login screen
            showScreen('login-screen');
        }

        function getCachedEmail(token) {
            try {
                const key = `offer_email_${token}`;
                const data = JSON.parse(localStorage.getItem(key) || 'null');
                if (!data) return null;

                // 30 minute TTL
                const ttl = 30 * 60 * 1000;
                if (Date.now() - data.timestamp > ttl) {
                    localStorage.removeItem(key);
                    return null;
                }
                return data.email;
            } catch {
                return null;
            }
        }

        function cacheEmail(token, email) {
            try {
                const key = `offer_email_${token}`;
                localStorage.setItem(key, JSON.stringify({
                    email: email.toLowerCase(),
                    timestamp: Date.now()
                }));
            } catch {
                // Ignore storage errors
            }
        }

        async function verifyEmail() {
            const emailInput = document.getElementById('email-input');
            const email = emailInput.value.trim().toLowerCase();
            const errorDiv = document.getElementById('login-error');

            if (!email) {
                errorDiv.textContent = 'Wprowadź adres e-mail';
                errorDiv.classList.remove('hidden');
                return;
            }

            if (email !== lead.email.toLowerCase()) {
                errorDiv.textContent = 'Nieprawidłowy adres e-mail';
                errorDiv.classList.remove('hidden');
                emailInput.classList.add('border-red-500');
                return;
            }

            // Cache email for localhost (30 min)
            const isLocal = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
            if (isLocal) {
                cacheEmail(getToken(), email);
            }

            // Fetch fresh view_count from database to check if first view
            const { data: freshData } = await supabaseClient
                .from('client_offers')
                .select('view_count, view_history')
                .eq('id', clientOffer.id)
                .single();

            const currentViewCount = freshData?.view_count || 0;
            const isFirstView = currentViewCount === 0;

            // Update view count and history
            const viewHistory = freshData?.view_history || [];
            viewHistory.push(new Date().toISOString());

            const { error: updateError } = await supabaseClient
                .from('client_offers')
                .update({
                    view_count: currentViewCount + 1,
                    viewed_at: new Date().toISOString(),
                    view_history: viewHistory
                })
                .eq('id', clientOffer.id);

            if (updateError) {
                console.warn('view_history update failed, trying without it:', updateError);
                await supabaseClient
                    .from('client_offers')
                    .update({
                        view_count: currentViewCount + 1,
                        viewed_at: new Date().toISOString()
                    })
                    .eq('id', clientOffer.id);
            }

            // Send Slack notification about offer view
            sendSlackNotification('offer_viewed', {
                lead_name: lead.name,
                lead_email: lead.email,
                lead_company: lead.company,
                lead_id: lead.id,
                offer_name: offer.name,
                offer_price: offer.price,
                offer_type: 'starter',
                first_view: isFirstView
            });

            renderOffer();
            showScreen('offer-screen');
        }

        function renderOffer() {
            // Client name
            let displayName = lead.company || lead.name || lead.email;
            document.getElementById('client-name').textContent = displayName;

            // Price and validity
            const priceFormatted = formatPrice(offer.price);
            const monthlyPrice = Math.ceil(offer.price / 10);
            const monthlyFormatted = formatPrice(monthlyPrice);

            document.getElementById('offer-price').textContent = priceFormatted;
            document.getElementById('offer-price-monthly').textContent = monthlyFormatted;
            document.getElementById('valid-until').textContent = formatDate(clientOffer.valid_until);

            // Sticky header prices
            document.getElementById('sticky-price').textContent = priceFormatted;
            document.getElementById('sticky-price-monthly').textContent = monthlyFormatted;
            document.getElementById('sticky-price-mobile').textContent = priceFormatted;
            document.getElementById('sticky-installments-mobile').textContent = `${monthlyFormatted} PLN × 10 rat 0%`;

            // Initialize fade-in animations
            initFadeInAnimations();
            // Initialize sticky header scroll detection
            initStickyHeader();
        }

        function initFadeInAnimations() {
            const fadeElements = document.querySelectorAll('.fade-in');

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('visible');
                        observer.unobserve(entry.target);
                    }
                });
            }, {
                threshold: 0.1,
                rootMargin: '0px 0px -50px 0px'
            });

            fadeElements.forEach(el => observer.observe(el));
        }

        function initStickyHeader() {
            const stickyHeader = document.getElementById('sticky-header');
            const heroSection = document.querySelector('.hero-gradient');

            if (!stickyHeader || !heroSection) return;

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    // Show sticky header when hero is out of view
                    if (entry.isIntersecting) {
                        stickyHeader.classList.remove('visible');
                    } else {
                        stickyHeader.classList.add('visible');
                    }
                });
            }, {
                threshold: 0,
                rootMargin: '0px'
            });

            observer.observe(heroSection);
        }

        function parseAddress(address) {
            if (!address) return { street: '', postCode: '', city: '' };
            const match = address.match(/^(.+?),?\s*(\d{2}-\d{3})\s+(.+)$/);
            if (match) return { street: match[1].trim(), postCode: match[2], city: match[3].trim() };
            return { street: address, postCode: '', city: '' };
        }

        async function downloadProforma() {
            const btn = event.target.closest('button');
            const originalHtml = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="ph ph-circle-notch animate-spin"></i> Generowanie...';

            try {
                // Przygotuj dane dla Edge Function
                const addressParts = parseAddress(lead.address);

                const requestData = {
                    buyer: {
                        name: lead.name,
                        company: lead.company,
                        email: lead.email,
                        nip: lead.nip || '',
                        street: addressParts.street,
                        postCode: addressParts.postCode,
                        city: addressParts.city
                    },
                    offer: {
                        name: offer.name,
                        description: offer.description,
                        price: offer.price
                    },
                    validUntil: clientOffer.valid_until
                };

                // Wywołaj Edge Function
                const response = await fetch(`${SUPABASE_URL}/functions/v1/fakturownia-proforma`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify(requestData)
                });

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'Błąd generowania proformy');
                }

                // Otwórz PDF
                window.open(result.pdfUrl, '_blank');

                // Loguj aktywność
                try {
                    await supabaseClient.from('lead_activities').insert([{
                        lead_id: lead.id,
                        type: 'proforma',
                        description: `Wygenerowano proformę przez klienta`,
                        metadata: {
                            offer_name: offer.name,
                            offer_price: offer.price,
                            invoice_id: result.invoiceId,
                            generated_by: 'client',
                            client_email: lead.email,
                            offer_type: 'starter'
                        }
                    }]);
                } catch (logError) {
                    console.error('Activity log error:', logError);
                }

                // Send Slack notification
                sendSlackNotification('proforma_generated', {
                    lead_name: lead.name,
                    lead_email: lead.email,
                    lead_company: lead.company,
                    lead_id: lead.id,
                    offer_name: offer.name,
                    offer_price: offer.price,
                    offer_type: 'starter',
                    generated_by: 'client'
                });

            } catch (error) {
                console.error('Proforma error:', error);
                alert('Błąd: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        }

        function goToCheckout() {
            // Redirect to checkout with offer ID
            const baseUrl = window.location.origin;
            const isLocal = location.hostname === 'localhost' || location.hostname === '127.0.0.1';

            let checkoutUrl;
            if (isLocal) {
                checkoutUrl = `${baseUrl}/checkout/index.html?offer=${offer.id}`;
            } else {
                checkoutUrl = `${baseUrl}/checkout?offer=${offer.id}`;
            }

            // Pre-fill email if possible
            checkoutUrl += `&email=${encodeURIComponent(lead.email)}`;
            if (lead.name) checkoutUrl += `&name=${encodeURIComponent(lead.name)}`;
            if (lead.company) checkoutUrl += `&company=${encodeURIComponent(lead.company)}`;

            window.location.href = checkoutUrl;
        }

        // Event listeners
        document.getElementById('login-btn').addEventListener('click', verifyEmail);
        document.getElementById('email-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') verifyEmail();
        });

        // Load offer on page load
        loadOffer();
    </script>
</body>
</html>
