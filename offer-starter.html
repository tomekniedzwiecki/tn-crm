<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oferta startowa</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    }
                }
            }
        }
    </script>
    <style>
        body { background: #050505; color: #e5e5e5; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::selection { background: white; color: black; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-enter { animation: fadeIn 0.5s ease-out forwards; }

        .input-field {
            background: #0a0a0a;
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.2s;
        }
        .input-field:focus {
            border-color: rgba(255,255,255,0.25);
            outline: none;
        }

        .glass-card {
            background: rgba(24, 24, 27, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        /* Hero gradient */
        .hero-gradient {
            background: radial-gradient(ellipse 80% 50% at 50% -20%, rgba(16, 185, 129, 0.15), transparent);
        }

        /* Timeline */
        .timeline-item {
            position: relative;
            padding-left: 3rem;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 0.9rem;
            top: 2.5rem;
            bottom: -1.5rem;
            width: 2px;
            background: linear-gradient(to bottom, rgba(255,255,255,0.1), transparent);
        }
        .timeline-item:last-child::before {
            display: none;
        }
        .timeline-dot {
            position: absolute;
            left: 0;
            top: 0;
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.75rem;
        }

        /* Cards */
        .card {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 16px;
            transition: all 0.3s ease;
        }
        .card:hover {
            border-color: rgba(255, 255, 255, 0.12);
            transform: translateY(-2px);
        }

        /* Sticky CTA */
        .sticky-cta {
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            background: rgba(5, 5, 5, 0.8);
            border-top: 1px solid rgba(255, 255, 255, 0.06);
        }

        /* Fade in on scroll */
        .fade-in {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.6s ease, transform 0.6s ease;
        }
        .fade-in.visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* Glow effect */
        .glow {
            box-shadow: 0 0 60px rgba(16, 185, 129, 0.15);
        }
    </style>
</head>
<body class="min-h-screen font-sans text-sm tracking-tight antialiased">

    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center px-4">
        <div class="w-full max-w-md animate-enter">
            <div class="text-center mb-8">
                <div class="w-14 h-14 bg-emerald-500 text-white rounded-xl flex items-center justify-center mx-auto mb-4 shadow-[0_0_30px_rgba(16,185,129,0.2)]">
                    <i class="ph-bold ph-rocket text-2xl"></i>
                </div>
                <h1 class="text-2xl font-bold text-white mb-2">Oferta startowa</h1>
                <p class="text-zinc-400">Wprowadź swój adres e-mail, aby zobaczyć szczegóły</p>
            </div>

            <div class="glass-card rounded-2xl border border-white/10 p-6">
                <div class="mb-4">
                    <label class="block text-zinc-400 text-xs font-medium mb-2">Adres e-mail</label>
                    <input type="email" id="email-input"
                           class="input-field w-full rounded-xl px-4 py-3 text-white text-base"
                           placeholder="jan@firma.pl"
                           autofocus>
                </div>
                <div id="login-error" class="text-red-400 text-sm mb-4 hidden"></div>
                <button id="login-btn"
                        class="w-full bg-emerald-500 hover:bg-emerald-400 text-white px-4 py-3 rounded-xl font-semibold transition-colors flex items-center justify-center gap-2">
                    <span>Zobacz ofertę</span>
                    <i class="ph ph-arrow-right"></i>
                </button>
            </div>

            <p class="text-center text-zinc-600 text-xs mt-6">
                Link jest ważny do: <span id="valid-until-preview" class="text-zinc-400">-</span>
            </p>
        </div>
    </div>

    <!-- Expired Screen -->
    <div id="expired-screen" class="hidden min-h-screen flex items-center justify-center px-4">
        <div class="text-center animate-enter">
            <div class="w-16 h-16 bg-zinc-800 rounded-2xl flex items-center justify-center mx-auto mb-6">
                <i class="ph ph-clock-countdown text-3xl text-zinc-500"></i>
            </div>
            <h1 class="text-2xl font-bold text-white mb-3">Oferta wygasła</h1>
            <p class="text-zinc-400 mb-6">Ta oferta nie jest już dostępna.</p>
            <p class="text-zinc-500 text-sm">Skontaktuj się z nami, aby otrzymać nową ofertę.</p>
        </div>
    </div>

    <!-- Not Found Screen -->
    <div id="not-found-screen" class="hidden min-h-screen flex items-center justify-center px-4">
        <div class="text-center animate-enter">
            <div class="w-16 h-16 bg-zinc-800 rounded-2xl flex items-center justify-center mx-auto mb-6">
                <i class="ph ph-question text-3xl text-zinc-500"></i>
            </div>
            <h1 class="text-2xl font-bold text-white mb-3">Nie znaleziono oferty</h1>
            <p class="text-zinc-400">Sprawdź poprawność linku lub skontaktuj się z nami.</p>
        </div>
    </div>

    <!-- Offer Screen -->
    <div id="offer-screen" class="hidden min-h-screen pb-24 sm:pb-8">

        <!-- Hero Section -->
        <div class="hero-gradient">
            <div class="max-w-4xl mx-auto px-4 sm:px-6 pt-8 sm:pt-16 pb-12 sm:pb-20">
                <div class="text-center animate-enter">
                    <!-- Badge -->
                    <div class="inline-flex items-center gap-2 bg-emerald-500/10 text-emerald-400 px-4 py-2 rounded-full text-sm font-medium mb-6 border border-emerald-500/20">
                        <i class="ph ph-rocket"></i>
                        Oferta startowa
                    </div>

                    <!-- Title -->
                    <h1 class="text-4xl sm:text-5xl lg:text-6xl font-bold text-white mb-4 tracking-tight">
                        Pakiet Start
                    </h1>

                    <!-- Subtitle -->
                    <p class="text-xl text-zinc-400 mb-8 max-w-2xl mx-auto">
                        Przygotowana dla: <span id="client-name" class="text-white font-medium">-</span>
                    </p>

                    <!-- Price highlight -->
                    <div class="inline-flex items-baseline gap-3 mb-8">
                        <span class="text-5xl sm:text-6xl font-bold text-white font-mono" id="offer-price">-</span>
                        <span class="text-xl text-zinc-500">PLN netto</span>
                    </div>

                    <!-- CTA -->
                    <div class="flex flex-col sm:flex-row items-center justify-center gap-4">
                        <button onclick="goToCheckout()"
                                class="w-full sm:w-auto bg-emerald-500 hover:bg-emerald-400 text-white px-8 py-4 rounded-xl font-semibold transition-all hover:scale-[1.02] flex items-center justify-center gap-2 text-lg glow">
                            <i class="ph ph-credit-card"></i>
                            Zamawiam teraz
                        </button>
                        <p class="text-zinc-500 text-sm">
                            Oferta ważna do: <span id="valid-until" class="text-white">-</span>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Content -->
        <div class="max-w-4xl mx-auto px-4 sm:px-6">

            <!-- What's included - Timeline -->
            <section class="py-12 sm:py-16 fade-in">
                <div class="text-center mb-10">
                    <h2 class="text-2xl sm:text-3xl font-bold text-white mb-3">Co otrzymujesz</h2>
                    <p class="text-zinc-500">Kompleksowy pakiet na start Twojego biznesu</p>
                </div>

                <div class="space-y-8">
                    <!-- Step 1 -->
                    <div class="timeline-item">
                        <div class="timeline-dot bg-gradient-to-br from-amber-500 to-orange-500 text-white">1</div>
                        <div class="card p-6">
                            <div class="flex items-start gap-4">
                                <div class="hidden sm:flex w-12 h-12 rounded-xl bg-amber-500/10 items-center justify-center flex-shrink-0">
                                    <i class="ph ph-magnifying-glass text-2xl text-amber-400"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-white mb-2">Analiza rynku i wybór produktów</h3>
                                    <p class="text-zinc-400 leading-relaxed">
                                        Analiza rynku, trendów i wybranie propozycji <span class="text-white font-medium">5 produktów</span>,
                                        które mają potencjał na bardzo dużą sprzedaż a trend na zainteresowanie nimi rośnie.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2 -->
                    <div class="timeline-item">
                        <div class="timeline-dot bg-gradient-to-br from-violet-500 to-purple-500 text-white">2</div>
                        <div class="card p-6">
                            <div class="flex items-start gap-4">
                                <div class="hidden sm:flex w-12 h-12 rounded-xl bg-violet-500/10 items-center justify-center flex-shrink-0">
                                    <i class="ph ph-chart-line-up text-2xl text-violet-400"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-white mb-2">Raporty i analiza potencjału</h3>
                                    <p class="text-zinc-400 leading-relaxed">
                                        Przygotowanie <span class="text-white font-medium">4 szczegółowych raportów</span> na temat
                                        produktu, rynku, potencjału oraz planu na budowę marki.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3 -->
                    <div class="timeline-item">
                        <div class="timeline-dot bg-gradient-to-br from-cyan-500 to-blue-500 text-white">3</div>
                        <div class="card p-6">
                            <div class="flex items-start gap-4">
                                <div class="hidden sm:flex w-12 h-12 rounded-xl bg-cyan-500/10 items-center justify-center flex-shrink-0">
                                    <i class="ph ph-palette text-2xl text-cyan-400"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-white mb-2">Branding marki</h3>
                                    <p class="text-zinc-400 leading-relaxed">
                                        Przygotowanie brandingu: <span class="text-white font-medium">logo, wizualizacje</span> na kubku i koszulce.
                                        Ustalenie kolorów, typografii, stylu i tonu komunikacji dla spójnego przekazu.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 4 -->
                    <div class="timeline-item">
                        <div class="timeline-dot bg-gradient-to-br from-emerald-500 to-green-500 text-white">4</div>
                        <div class="card p-6">
                            <div class="flex items-start gap-4">
                                <div class="hidden sm:flex w-12 h-12 rounded-xl bg-emerald-500/10 items-center justify-center flex-shrink-0">
                                    <i class="ph ph-browser text-2xl text-emerald-400"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-white mb-2">Strona sprzedażowa</h3>
                                    <p class="text-zinc-400 leading-relaxed">
                                        Przygotowanie <span class="text-white font-medium">wysokiej jakości, dedykowanej strony sprzedażowej</span>
                                        dla Twojej marki — gotowej do generowania sprzedaży.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Two column section -->
            <section class="grid grid-cols-1 md:grid-cols-2 gap-6 py-12 fade-in">
                <!-- Who -->
                <div class="card p-6 sm:p-8">
                    <div class="flex items-center gap-4 mb-6">
                        <img src="https://tomekniedzwiecki.pl/img/tn_kwadrat.png" alt="Tomek Niedzwiecki"
                             class="w-16 h-16 rounded-2xl object-cover ring-2 ring-white/10">
                        <div>
                            <h3 class="text-lg font-semibold text-white">Tomek Niedzwiecki</h3>
                            <p class="text-emerald-400 text-sm">Bezpośredni kontakt</p>
                        </div>
                    </div>
                    <p class="text-zinc-400 leading-relaxed mb-4">
                        Każdy etap wykonywany jest bezpośrednio przeze mnie. Masz ze mną
                        <span class="text-white">bezpośredni kontakt na komunikatorze</span> — bez pośredników.
                    </p>
                    <div class="flex items-center gap-2 text-zinc-500 text-sm">
                        <i class="ph ph-chat-circle-dots text-emerald-400"></i>
                        <span>Odpowiadam w ciągu 24h</span>
                    </div>
                </div>

                <!-- Goal -->
                <div class="card p-6 sm:p-8 bg-gradient-to-br from-emerald-500/5 to-transparent border-emerald-500/20">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-12 h-12 rounded-xl bg-emerald-500/10 flex items-center justify-center">
                            <i class="ph ph-target text-2xl text-emerald-400"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-white">Docelowy plan</h3>
                    </div>
                    <p class="text-zinc-300 leading-relaxed text-lg mb-4">
                        <span class="text-white font-semibold">Tomek buduje</span> dla Ciebie biznes,
                        <span class="text-white font-semibold">wdraża Cię</span> w jego prowadzenie i następnie
                        <span class="text-white font-semibold">przekazuje Ci</span> pełną kontrolę.
                    </p>
                    <div class="space-y-2">
                        <div class="flex items-center gap-2 text-emerald-400 text-sm">
                            <i class="ph ph-check-circle"></i>
                            <span>Pełne wsparcie na każdym etapie</span>
                        </div>
                        <div class="flex items-center gap-2 text-emerald-400 text-sm">
                            <i class="ph ph-check-circle"></i>
                            <span>Bez ukrytych kosztów</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Footer -->
            <footer class="border-t border-white/5 py-8 text-center">
                <p class="text-zinc-600 text-sm">
                    Powered by <span class="text-zinc-400">TN Digital</span>
                </p>
            </footer>
        </div>

        <!-- Sticky CTA (mobile) -->
        <div class="fixed bottom-0 left-0 right-0 sticky-cta p-4 sm:hidden z-50">
            <button onclick="goToCheckout()"
                    class="w-full bg-emerald-500 hover:bg-emerald-400 text-white px-6 py-4 rounded-xl font-semibold transition-colors flex items-center justify-center gap-2">
                <i class="ph ph-credit-card"></i>
                Zamawiam — <span id="offer-price-mobile">-</span> PLN
            </button>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://yxmavwkwnfuphjqbelws.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl4bWF2d2t3bmZ1cGhqcWJlbHdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NjQyNTUsImV4cCI6MjA4NDM0MDI1NX0.XeR0Fc7OFn6YbNJrOKTBEj36JtmLISZTM87y4ai9340';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let clientOffer = null;
        let offer = null;
        let lead = null;

        function getToken() {
            // Try URL path first (Vercel rewrite: /offer-starter/token or /offer-starter?token=xxx)
            const path = window.location.pathname;
            const pathMatch = path.match(/\/offer-starter\/([a-zA-Z0-9]+)/);
            if (pathMatch) return pathMatch[1];

            // Fallback to query parameter
            const params = new URLSearchParams(window.location.search);
            return params.get('token');
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('pl-PL', { day: 'numeric', month: 'long', year: 'numeric' });
        }

        function formatPrice(price) {
            return new Intl.NumberFormat('pl-PL').format(price);
        }

        // Slack notification helper - fire and forget
        async function sendSlackNotification(type, data) {
            try {
                await fetch(`${SUPABASE_URL}/functions/v1/slack-notify`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify({ type, data })
                });
            } catch (err) {
                console.error('Slack notification error:', err);
            }
        }

        function showScreen(screenId) {
            ['login-screen', 'expired-screen', 'not-found-screen', 'offer-screen'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');
        }

        async function loadOffer() {
            const token = getToken();
            if (!token) {
                showScreen('not-found-screen');
                return;
            }

            // Fetch client offer
            const { data, error } = await supabaseClient
                .from('client_offers')
                .select('*, leads(*), offers(*)')
                .eq('unique_token', token)
                .single();

            if (error || !data) {
                showScreen('not-found-screen');
                return;
            }

            clientOffer = data;
            offer = data.offers;
            lead = data.leads;

            // Check if expired
            const validUntil = new Date(clientOffer.valid_until);
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            if (validUntil < today) {
                showScreen('expired-screen');
                return;
            }

            // Show validity date on login screen
            document.getElementById('valid-until-preview').textContent = formatDate(clientOffer.valid_until);

            // Show login screen
            showScreen('login-screen');
        }

        async function verifyEmail() {
            const emailInput = document.getElementById('email-input');
            const email = emailInput.value.trim().toLowerCase();
            const errorDiv = document.getElementById('login-error');

            if (!email) {
                errorDiv.textContent = 'Wprowadź adres e-mail';
                errorDiv.classList.remove('hidden');
                return;
            }

            if (email !== lead.email.toLowerCase()) {
                errorDiv.textContent = 'Nieprawidłowy adres e-mail';
                errorDiv.classList.remove('hidden');
                emailInput.classList.add('border-red-500');
                return;
            }

            // Fetch fresh view_count from database to check if first view
            const { data: freshData } = await supabaseClient
                .from('client_offers')
                .select('view_count, view_history')
                .eq('id', clientOffer.id)
                .single();

            const currentViewCount = freshData?.view_count || 0;
            const isFirstView = currentViewCount === 0;

            // Update view count and history
            const viewHistory = freshData?.view_history || [];
            viewHistory.push(new Date().toISOString());

            const { error: updateError } = await supabaseClient
                .from('client_offers')
                .update({
                    view_count: currentViewCount + 1,
                    viewed_at: new Date().toISOString(),
                    view_history: viewHistory
                })
                .eq('id', clientOffer.id);

            if (updateError) {
                console.warn('view_history update failed, trying without it:', updateError);
                await supabaseClient
                    .from('client_offers')
                    .update({
                        view_count: currentViewCount + 1,
                        viewed_at: new Date().toISOString()
                    })
                    .eq('id', clientOffer.id);
            }

            // Send Slack notification about offer view
            sendSlackNotification('offer_viewed', {
                lead_name: lead.name,
                lead_email: lead.email,
                lead_company: lead.company,
                lead_id: lead.id,
                offer_name: offer.name,
                offer_price: offer.price,
                offer_type: 'starter',
                first_view: isFirstView
            });

            renderOffer();
            showScreen('offer-screen');
        }

        function renderOffer() {
            // Client name
            let displayName = lead.company || lead.name || lead.email;
            document.getElementById('client-name').textContent = displayName;

            // Price and validity
            const priceFormatted = formatPrice(offer.price);
            document.getElementById('offer-price').textContent = priceFormatted;
            document.getElementById('offer-price-mobile').textContent = priceFormatted;
            document.getElementById('valid-until').textContent = formatDate(clientOffer.valid_until);

            // Initialize fade-in animations
            initFadeInAnimations();
        }

        function initFadeInAnimations() {
            const fadeElements = document.querySelectorAll('.fade-in');

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('visible');
                        observer.unobserve(entry.target);
                    }
                });
            }, {
                threshold: 0.1,
                rootMargin: '0px 0px -50px 0px'
            });

            fadeElements.forEach(el => observer.observe(el));
        }

        function goToCheckout() {
            // Redirect to checkout with offer ID
            const baseUrl = window.location.origin;
            const isLocal = location.hostname === 'localhost' || location.hostname === '127.0.0.1';

            let checkoutUrl;
            if (isLocal) {
                checkoutUrl = `${baseUrl}/checkout/index.html?offer=${offer.id}`;
            } else {
                checkoutUrl = `${baseUrl}/checkout?offer=${offer.id}`;
            }

            // Pre-fill email if possible
            checkoutUrl += `&email=${encodeURIComponent(lead.email)}`;
            if (lead.name) checkoutUrl += `&name=${encodeURIComponent(lead.name)}`;
            if (lead.company) checkoutUrl += `&company=${encodeURIComponent(lead.company)}`;

            window.location.href = checkoutUrl;
        }

        // Event listeners
        document.getElementById('login-btn').addEventListener('click', verifyEmail);
        document.getElementById('email-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') verifyEmail();
        });

        // Load offer on page load
        loadOffer();
    </script>
</body>
</html>
